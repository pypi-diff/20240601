# Comparing `tmp/bitdust-0.1.8.234.tar.gz` & `tmp/bitdust-0.1.9.241.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/bitdust-0.1.8.234.tar", last modified: Sat Apr 22 20:43:16 2023, max compression
+gzip compressed data, was "bitdust-0.1.9.241.tar", last modified: Sat Jun  1 14:53:24 2024, max compression
```

## Comparing `bitdust-0.1.8.234.tar` & `bitdust-0.1.9.241.tar`

### file list

```diff
@@ -1,482 +1,484 @@
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.209024 bitdust-0.1.8.234/
--rw-r--r--   0 veselin   (1000) veselin   (1001)    34520 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/LICENSE.txt
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7712 2023-04-22 20:43:16.209024 bitdust-0.1.8.234/PKG-INFO
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6011 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/README.txt
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.125022 bitdust-0.1.8.234/bitdust/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1803 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/__init__.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.129022 bitdust-0.1.8.234/bitdust/access/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8145 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/group_access_donor.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    69936 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/group_member.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    27158 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/groups.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    35302 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/key_ring.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    46155 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/shared_access_coordinator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    16003 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/access/shared_access_donor.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.129022 bitdust-0.1.8.234/bitdust/automats/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/automats/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    28621 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/automats/automat.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4035 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/automats/global_state.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.129022 bitdust-0.1.8.234/bitdust/blockchain/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/blockchain/__init__.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.129022 bitdust-0.1.8.234/bitdust/broadcast/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/broadcast/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7494 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/broadcast/broadcast_listener.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4803 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/broadcast/broadcast_service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14662 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/broadcast/broadcaster_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10000 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/broadcast/broadcasters_finder.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.129022 bitdust-0.1.8.234/bitdust/chat/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      876 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3306 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/kbhit.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    29560 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/message_database.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5675 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/message_keeper.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11276 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/nickname_holder.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11315 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/nickname_observer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10358 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/chat/terminal_chat.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.133022 bitdust-0.1.8.234/bitdust/coins/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    16133 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/accountant_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10172 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/accountants_finder.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13995 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/coins_db.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7339 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/coins_index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6480 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/coins_io.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17260 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/coins_miner.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10287 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/contract_chain_consumer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7023 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/contract_chain_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10444 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/customer_contract_executor.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6104 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/mine_old.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5311 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/miner_old.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11275 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/coins/supplier_contract_executor.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.133022 bitdust-0.1.8.234/bitdust/contacts/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      884 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/contacts/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    38445 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/contacts/contactsdb.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3829 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/contacts/friends.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    21012 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/contacts/identitycache.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14809 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/contacts/identitydb.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.133022 bitdust-0.1.8.234/bitdust/crypt/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5835 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/certificate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4029 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/cipher.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11851 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/encrypted.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3253 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/hashes.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13081 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/key.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    39464 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/my_keys.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2799 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/number.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8811 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/rsa_key.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17628 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/crypt/signed.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.133022 bitdust-0.1.8.234/bitdust/currency/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/currency/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7434 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/currency/geth_service.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.137022 bitdust-0.1.8.234/bitdust/customer/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/customer/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    41073 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/customer/fire_hire.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13849 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/customer/list_files_orator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    26487 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/customer/supplier_connector.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13424 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/customer/supplier_finder.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.137022 bitdust-0.1.8.234/bitdust/dht/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      954 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/dht/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10289 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/dht/dht_records.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14437 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/dht/dht_relations.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    62442 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/dht/dht_service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4098 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/dht/known_nodes.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.137022 bitdust-0.1.8.234/bitdust/interface/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)   238439 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/api.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    53720 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/api_rest_http_server.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11461 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/api_web_socket.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    57996 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/cmd_line_json.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7069 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/cmd_line_json_templates.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22207 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/interface/ftp_server.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.141022 bitdust-0.1.8.234/bitdust/lib/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      969 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7701 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/diskspace.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2799 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/getsizeof.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10243 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/jsn.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    40342 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/jsontemplate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11193 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/maths.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    31961 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/misc.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8488 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/nameurl.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    31041 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/net_misc.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    16067 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/packetid.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    15989 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/schedule.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3508 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/serialization.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2760 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/strng.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    23049 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/txws.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10343 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/udp.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2382 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/utime.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13150 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/lib/websock.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.141022 bitdust-0.1.8.234/bitdust/logs/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25640 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/lg.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3211 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/measure_it.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1890 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/memdebug.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8227 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/weblog.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10403 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/logs/webtraffic.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.145022 bitdust-0.1.8.234/bitdust/main/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      949 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    34709 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/bpmain.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14262 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/bptester.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    20957 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/config.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12982 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/config_defaults.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    24970 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/config_details.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10719 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/config_types.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1428 2023-04-22 20:43:15.000000 bitdust-0.1.8.234/bitdust/main/default_network.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9443 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/events.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9615 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/help.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    20827 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/initializer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5089 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/install_wizard.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    15084 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/installer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6602 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/listeners.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2368 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/network_config.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    60704 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/settings.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11845 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/main/shutdowner.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.145022 bitdust-0.1.8.234/bitdust/p2p/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      925 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8983 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/commands.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17986 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/handshaker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    28300 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/id_rotator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22021 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/lookup.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    23837 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/network_connector.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11849 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/network_service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    29615 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/online_status.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    27694 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/p2p_connector.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    37669 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/p2p_service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17410 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/p2p_service_seeker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4556 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/p2p_stats.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    19004 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/propagate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8730 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/p2p/ratings.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.149022 bitdust-0.1.8.234/bitdust/raid/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      933 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    24733 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/eccmap.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5943 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/make.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    20051 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/raid_worker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2059 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/raidutils.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8614 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/read.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9178 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/rebuild.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5395 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/raid/worker.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.157023 bitdust-0.1.8.234/bitdust/services/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      884 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    26507 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/driver.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17419 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/local_service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4424 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_accountant.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1974 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_backup_db.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6595 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_backups.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1486 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_blockchain.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9792 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_broadcasting.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2897 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_contract_chain.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5591 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_customer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2618 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_customer_contracts.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11976 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_customer_family.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2318 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_customer_patrol.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4913 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_customer_support.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1618 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_data_disintegration.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5001 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_data_motion.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9743 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_employer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8193 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_entangled_dht.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2511 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_gateway.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2009 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_http_connections.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4091 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_http_transport.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5346 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_identity_propagate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1991 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_identity_server.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2390 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_ip_port_responder.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3298 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_keys_registry.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11261 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_keys_storage.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3253 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_list_files.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8420 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_message_broker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4322 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_message_history.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2127 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_miner.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4100 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_my_data.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2935 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_my_ip_port.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4938 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_network.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2033 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_nodes_lookup.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10155 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_p2p_hookups.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7449 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_p2p_notifications.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3981 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_personal_messages.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4318 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_private_groups.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4827 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_private_messages.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4590 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_proxy_server.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11284 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_proxy_transport.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1577 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_rebuilding.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1565 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_restores.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3397 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_shared_data.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17790 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_supplier.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2452 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_supplier_contracts.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1994 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_tcp_connections.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4431 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_tcp_transport.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2962 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_udp_datagrams.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5040 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/services/service_udp_transport.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.161023 bitdust-0.1.8.234/bitdust/storage/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      958 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12346 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/accounting.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    21358 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/archive_reader.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14921 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/archive_writer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22859 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    39695 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_control.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    77837 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_fs.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    75581 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_matrix.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    16663 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_monitor.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    32245 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_rebuilder.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12919 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_schedule.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8285 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/backup_tar.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    20832 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/index_synchronizer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    16189 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/keys_synchronizer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9662 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/restore_monitor.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    33963 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/restore_worker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11658 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/storage/tar_file.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.165023 bitdust-0.1.8.234/bitdust/stream/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    34695 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/broker_negotiator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4688 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/data_receiver.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    20254 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/data_sender.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11841 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/file_down.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12865 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/file_up.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    38717 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/io_throttle.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    29553 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/message.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    91952 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/message_peddler.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    19432 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/message_producer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    43379 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/p2p_queue.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    35334 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stream/queue_keeper.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.165023 bitdust-0.1.8.234/bitdust/stun/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1223 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stun/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    23168 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stun/stun_client.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6390 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/stun/stun_server.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.165023 bitdust-0.1.8.234/bitdust/supplier/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8236 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/customer_assistant.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    35366 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/customer_space.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8938 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/customers_rejector.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    51966 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/family_member.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10878 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/list_files.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6955 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/supplier/local_tester.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.169023 bitdust-0.1.8.234/bitdust/system/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      961 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    37906 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/bpio.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6797 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/child_process.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14220 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/deploy.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4405 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/dirsize.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6550 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/diskusage.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6110 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/local_fs.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8609 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/nonblocking.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11747 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/run_upnpc.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11571 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/tmpfile.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8526 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/system/tray_icon.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.173023 bitdust-0.1.8.234/bitdust/transport/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1161 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9653 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/bandwidth.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13659 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/callback.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    45667 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/gateway.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.173023 bitdust-0.1.8.234/bitdust/transport/http/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8974 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/http_interface.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14059 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/http_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      842 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/sum_client.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      633 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/sum_server.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)    12360 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/transport_http_old.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2216 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/http/twisted-web-ssl.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10153 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/network_transport.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    21546 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/packet_in.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    55997 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/packet_out.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.173023 bitdust-0.1.8.234/bitdust/transport/proxy/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/proxy/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13162 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/proxy/proxy_interface.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    40557 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/proxy/proxy_receiver.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    68687 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/proxy/proxy_router.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    24428 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/proxy/proxy_sender.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.177023 bitdust-0.1.8.234/bitdust/transport/tcp/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/tcp/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    18570 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/tcp/tcp_connection.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13313 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/tcp/tcp_interface.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    15160 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/tcp/tcp_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22333 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/tcp/tcp_stream.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.177023 bitdust-0.1.8.234/bitdust/transport/udp/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11284 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_connector.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    24562 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_file_queue.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13917 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_interface.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    19322 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    26324 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_session.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    57234 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/transport/udp/udp_stream.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.177023 bitdust-0.1.8.234/bitdust/updates/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/updates/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12033 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/updates/git_proc.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.181023 bitdust-0.1.8.234/bitdust/userid/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    15285 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/global_id.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25972 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/id_registrator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    15375 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/id_restorer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17980 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/id_server.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    39959 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/id_url.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    39644 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/identity.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4119 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/known_servers.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22377 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust/userid/my_id.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.125022 bitdust-0.1.8.234/bitdust.egg-info/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7712 2023-04-22 20:43:16.000000 bitdust-0.1.8.234/bitdust.egg-info/PKG-INFO
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14699 2023-04-22 20:43:16.000000 bitdust-0.1.8.234/bitdust.egg-info/SOURCES.txt
--rw-r--r--   0 veselin   (1000) veselin   (1001)        1 2023-04-22 20:43:16.000000 bitdust-0.1.8.234/bitdust.egg-info/dependency_links.txt
--rw-r--r--   0 veselin   (1000) veselin   (1001)      120 2023-04-22 20:43:16.000000 bitdust-0.1.8.234/bitdust.egg-info/requires.txt
--rw-r--r--   0 veselin   (1000) veselin   (1001)       22 2023-04-22 20:43:16.000000 bitdust-0.1.8.234/bitdust.egg-info/top_level.txt
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.181023 bitdust-0.1.8.234/bitdust_forks/
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.193024 bitdust-0.1.8.234/bitdust_forks/Bismuth/
--rw-r--r--   0 veselin   (1000) veselin   (1001)        0 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1699 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/aliases.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1567 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/aliasesv2.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    37606 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/apihandler.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      116 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/application_directories.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      846 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/balance_nogui.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2403 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/check_tx.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1034 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_addpeers.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      906 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_hn_last_block_ts.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1086 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_hn_reg_round.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14518 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/commands.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3421 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/connectionmanager.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4748 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/connections.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    18284 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/dbhandler.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1310 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/demo_getaddresssince.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1426 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/demo_getstatus.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4399 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/difficulty.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    26736 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/digest.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11146 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/essentials.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2255 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/fork.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9427 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/genesis.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      790 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/hmac_drbg.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      715 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/hyperlane.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1114 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/hyperlane_asyncio.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9049 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/ledger_explorer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1764 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/log.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    32179 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/mempool.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2362 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/mining.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7396 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/mining_heavy3.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)   116112 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      561 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/node_stop.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6116 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/optiexplorer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8203 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/optihash.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6014 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/options.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25033 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/optipoolware.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    24519 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/peershandler.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6820 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/plugins.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      537 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/process_search.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      700 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/quantizer.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8159 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/regnet.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      636 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/rewards_reindex.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      446 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/rewards_test.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5812 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/rpcconnections.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2014 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/send_csv.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4611 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/send_nogui_noconf.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5625 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/simplecrypt.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9408 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/staking.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9526 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/tokensv2.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1164 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_keys.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11108 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_server.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6998 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_websocket.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    14984 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/Bismuth/worker.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.197024 bitdust-0.1.8.234/bitdust_forks/CodernityDB/
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)      700 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/__init__.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)    42787 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/database.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1037 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_gevent.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     8184 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_safe_shared.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3992 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_super_thread_safe.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1170 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_thread_safe.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7835 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/debug_stuff.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      764 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/env.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)    33960 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/hash_index.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     4814 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25578 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/indexcreator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4860 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/lfu_cache.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5547 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/lfu_cache_with_lock.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1370 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/migrate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1011 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/misc.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     2851 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/patch.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3756 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/rr_cache.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4115 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/rr_cache_with_lock.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     5125 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/sharded_hash.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3863 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/sharded_index.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3806 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/storage.py
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)   107565 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB/tree_index.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.197024 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      700 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    43644 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1040 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_gevent.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8236 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_safe_shared.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3973 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_super_thread_safe.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1170 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_thread_safe.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7915 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/debug_stuff.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      764 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/env.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    40383 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/hash_index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4958 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25451 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/indexcreator.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5435 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/lfu_cache.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6221 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/lfu_cache_with_lock.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1371 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/migrate.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1010 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/misc.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2852 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/patch.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4376 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/rr_cache.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4639 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/rr_cache_with_lock.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6030 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/sharded_hash.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3714 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/sharded_index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4261 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/storage.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)   111785 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/CodernityDB3/tree_index.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1803 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/__init__.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/entangled/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1474 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    25438 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/dtuple.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2008 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2181 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/constants.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3401 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/contact.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    12393 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/datastore.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8793 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/encoding.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5867 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/kbucket.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6548 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/msgformat.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3471 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/msgtypes.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    89776 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/node.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    33799 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/protocol.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    22400 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/routingtable.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13052 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/entangled/node.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/parallelp/
--rw-r--r--   0 veselin   (1000) veselin   (1001)      885 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/__init__.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/
--rw-r--r--   0 veselin   (1000) veselin   (1001)    36502 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4764 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppauto.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    11913 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppserver.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6981 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/pptransport.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5046 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppworker.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/txrestapi/
--rw-r--r--   0 veselin   (1000) veselin   (1001)        2 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/__init__.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.201024 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/
--rw-r--r--   0 veselin   (1000) veselin   (1001)        2 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7447 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/json_resource.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1472 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/methods.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2941 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/resource.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)      169 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/service.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     9470 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/tests.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.205024 bitdust-0.1.8.234/bitdust_forks/websocket/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1022 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/__init__.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13641 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_abnf.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13508 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_app.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1758 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_cookiejar.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    17675 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_core.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2404 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_exceptions.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6436 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_handshake.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    10842 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_http.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2156 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_logging.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4757 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_socket.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     1797 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_ssl_compat.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4707 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_url.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6951 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/bitdust_forks/websocket/_utils.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.205024 bitdust-0.1.8.234/scripts/
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1918 2023-04-22 20:43:15.000000 bitdust-0.1.8.234/scripts/bitdust
--rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1833 2023-04-22 20:43:15.000000 bitdust-0.1.8.234/scripts/bitdust_worker
--rw-r--r--   0 veselin   (1000) veselin   (1001)       38 2023-04-22 20:43:16.209024 bitdust-0.1.8.234/setup.cfg
--rw-r--r--   0 veselin   (1000) veselin   (1001)     5284 2023-04-22 20:43:15.000000 bitdust-0.1.8.234/setup.py
-drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2023-04-22 20:43:16.209024 bitdust-0.1.8.234/tests/
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7089 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_backup_fs.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7938 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_backup_restore.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4064 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_codernity_db.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     8271 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_crypt_signed.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    35543 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_id_url.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     4942 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_identity.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     7730 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_my_keys.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3024 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_raid_make_read.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     3560 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_raid_manager.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)    13735 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_raid_worker.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     2299 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_rsa_key.py
--rw-r--r--   0 veselin   (1000) veselin   (1001)     6347 2023-04-22 19:32:08.000000 bitdust-0.1.8.234/tests/test_serialize.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.289563 bitdust-0.1.9.241/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    34520 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/LICENSE.txt
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7712 2024-06-01 14:53:24.289563 bitdust-0.1.9.241/PKG-INFO
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6011 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/README.txt
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.233556 bitdust-0.1.9.241/bitdust/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1803 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/__init__.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.233556 bitdust-0.1.9.241/bitdust/access/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8145 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/group_access_donor.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    56731 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/group_participant.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14408 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/groups.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    35302 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/key_ring.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    46211 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/shared_access_coordinator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16003 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/access/shared_access_donor.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.237557 bitdust-0.1.9.241/bitdust/automats/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/automats/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    28666 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/automats/automat.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4035 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/automats/global_state.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.237557 bitdust-0.1.9.241/bitdust/blockchain/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11160 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/authority_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11573 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/bismuth_miner.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    25469 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/bismuth_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    30480 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/bismuth_pool.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7018 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/bismuth_wallet.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16077 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/blockchain_explorer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10143 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/blockchain_registrator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2661 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/blockchain/known_bismuth_nodes.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.237557 bitdust-0.1.9.241/bitdust/broadcast/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7494 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/broadcast_listener.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4803 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/broadcast_service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14662 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/broadcaster_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10000 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/broadcasters_finder.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9792 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/broadcast/service_broadcasting.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.237557 bitdust-0.1.9.241/bitdust/chat/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      876 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3306 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/kbhit.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    29913 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/message_database.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5675 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/message_keeper.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11276 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/nickname_holder.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11315 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/nickname_observer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10358 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/chat/terminal_chat.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.241557 bitdust-0.1.9.241/bitdust/coins/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16133 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/accountant_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10172 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/accountants_finder.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13995 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/coins_db.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7339 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/coins_index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6480 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/coins_io.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17272 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/coins_miner.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10287 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/contract_chain_consumer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7023 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/contract_chain_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10444 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/customer_contract_executor.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6104 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/mine_old.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5311 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/miner_old.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4428 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/service_accountant.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2897 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/service_contract_chain.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2129 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/service_miner.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11275 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/coins/supplier_contract_executor.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.241557 bitdust-0.1.9.241/bitdust/contacts/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      884 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/contacts/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    38463 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/contacts/contactsdb.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3829 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/contacts/friends.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    21012 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/contacts/identitycache.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14875 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/contacts/identitydb.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.241557 bitdust-0.1.9.241/bitdust/crypt/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5835 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/certificate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4029 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/cipher.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11851 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/encrypted.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3253 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/hashes.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13081 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/key.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    39464 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/my_keys.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2799 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/number.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8811 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/rsa_key.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17628 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/crypt/signed.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.241557 bitdust-0.1.9.241/bitdust/currency/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/currency/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7434 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/currency/geth_service.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.241557 bitdust-0.1.9.241/bitdust/customer/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    42945 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/fire_hire.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13851 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/list_files_orator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7152 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/payment.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    27895 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/supplier_connector.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13389 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/customer/supplier_finder.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.245558 bitdust-0.1.9.241/bitdust/dht/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      954 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/dht/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12699 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/dht/dht_records.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14406 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/dht/dht_relations.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    62460 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/dht/dht_service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4100 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/dht/known_nodes.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.245558 bitdust-0.1.9.241/bitdust/interface/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)   245652 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/api.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    55109 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/api_rest_http_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11461 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/api_web_socket.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    58680 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/cmd_line_json.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7219 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/cmd_line_json_templates.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22207 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/ftp_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7904 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/interface/web_html_template.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.245558 bitdust-0.1.9.241/bitdust/lib/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      969 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7754 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/diskspace.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2799 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/getsizeof.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10243 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/jsn.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    40342 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/jsontemplate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11193 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/maths.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    31961 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/misc.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8488 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/nameurl.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    31041 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/net_misc.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16067 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/packetid.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15989 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/schedule.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3508 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/serialization.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2760 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/strng.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    23049 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/txws.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10343 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/udp.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4018 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/utime.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13150 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/lib/websock.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.249558 bitdust-0.1.9.241/bitdust/logs/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    26267 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/lg.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3211 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/measure_it.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1890 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/memdebug.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8227 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/weblog.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10403 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/logs/webtraffic.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.249558 bitdust-0.1.9.241/bitdust/main/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      949 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    35078 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/bpmain.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14262 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/bptester.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22416 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/config.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13980 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/config_defaults.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    24626 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/config_details.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12028 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/config_types.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2082 2024-06-01 14:53:23.000000 bitdust-0.1.9.241/bitdust/main/default_network.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9449 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/events.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9615 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/help.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    20968 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/initializer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5089 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/install_wizard.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15084 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/installer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6615 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/listeners.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2368 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/network_config.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    61058 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/settings.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11845 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/main/shutdowner.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.253559 bitdust-0.1.9.241/bitdust/p2p/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      925 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8958 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/commands.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17986 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/handshaker.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    28302 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/id_rotator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22021 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/lookup.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    23837 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/network_connector.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11849 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/network_service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    29651 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/online_status.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    27694 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/p2p_connector.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    37588 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/p2p_service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17450 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/p2p_service_seeker.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4556 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/p2p_stats.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    19004 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/propagate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8730 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/p2p/ratings.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.253559 bitdust-0.1.9.241/bitdust/raid/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      933 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    24805 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/eccmap.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5943 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/make.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    20051 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/raid_worker.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2059 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/raidutils.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8614 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/read.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9178 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/rebuild.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5455 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/raid/worker.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.261560 bitdust-0.1.9.241/bitdust/services/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      884 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    27383 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/driver.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17419 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/local_service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1974 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_backup_db.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6595 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_backups.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1887 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_blockchain.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1569 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_identity.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1637 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_miner.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1604 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1598 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_pool.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1639 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_bismuth_wallet.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1663 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_blockchain_authority.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1675 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_blockchain_explorer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2898 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_blockchain_id.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5591 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_customer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1887 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_customer_contracts.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11976 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_customer_family.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2316 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_customer_patrol.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4913 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_customer_support.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1618 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_data_disintegration.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5001 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_data_motion.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9743 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_employer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8197 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_entangled_dht.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2511 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_gateway.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2009 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_http_connections.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4091 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_http_transport.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5348 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_identity_propagate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1991 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_identity_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2390 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_ip_port_responder.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4016 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_joint_postman.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3298 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_keys_registry.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11226 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_keys_storage.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3253 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_list_files.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8475 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_message_broker.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4322 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_message_history.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4100 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_my_data.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2956 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_my_ip_port.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4938 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_network.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2033 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_nodes_lookup.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10155 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_p2p_hookups.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7449 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_p2p_notifications.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4004 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_personal_messages.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3344 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_private_groups.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4827 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_private_messages.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4590 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_proxy_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11284 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_proxy_transport.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1577 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_rebuilding.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1565 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_restores.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3397 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_shared_data.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2252 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_supplier.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2018 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_supplier_contracts.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1994 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_tcp_connections.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4431 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_tcp_transport.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2962 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_udp_datagrams.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5040 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/services/service_udp_transport.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.261560 bitdust-0.1.9.241/bitdust/storage/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      958 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13330 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/accounting.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22859 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    39695 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_control.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    77840 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_fs.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    75581 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_matrix.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16664 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_monitor.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    32245 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_rebuilder.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12919 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_schedule.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8285 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/backup_tar.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    20833 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/index_synchronizer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16484 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/keys_synchronizer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9662 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/restore_monitor.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    33964 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/restore_worker.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11658 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/storage/tar_file.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.261560 bitdust-0.1.9.241/bitdust/stream/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      882 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4688 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/data_receiver.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    20254 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/data_sender.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11847 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/file_down.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12871 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/file_up.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    38717 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/io_throttle.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    29420 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/message.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    19438 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/message_producer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    43007 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/p2p_queue.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    51017 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stream/postman.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.265560 bitdust-0.1.9.241/bitdust/stun/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1223 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stun/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    23168 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stun/stun_client.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6390 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/stun/stun_server.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.265560 bitdust-0.1.9.241/bitdust/supplier/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      880 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8236 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/customer_assistant.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    50451 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/customer_space.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10878 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/customers_rejector.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    52051 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/family_member.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10878 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/list_files.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6955 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/local_tester.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    27136 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/supplier/storage_contract.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.265560 bitdust-0.1.9.241/bitdust/system/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      961 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    37928 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/bpio.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6797 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/child_process.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14373 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/deploy.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4405 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/dirsize.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6550 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/diskusage.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6110 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/local_fs.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8609 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/nonblocking.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11747 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/run_upnpc.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11571 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/tmpfile.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8526 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/system/tray_icon.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.265560 bitdust-0.1.9.241/bitdust/transport/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1161 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9653 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/bandwidth.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13659 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/callback.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    45667 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/gateway.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.269561 bitdust-0.1.9.241/bitdust/transport/http/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8974 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/http_interface.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14059 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/http_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      842 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/sum_client.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      633 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/sum_server.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)    12360 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/transport_http_old.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2216 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/http/twisted-web-ssl.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10153 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/network_transport.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    21546 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/packet_in.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    55997 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/packet_out.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.269561 bitdust-0.1.9.241/bitdust/transport/proxy/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      881 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/proxy/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13162 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/proxy/proxy_interface.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    40559 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/proxy/proxy_receiver.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    68699 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/proxy/proxy_router.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    24428 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/proxy/proxy_sender.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.269561 bitdust-0.1.9.241/bitdust/transport/tcp/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/tcp/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    18570 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/tcp/tcp_connection.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13313 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/tcp/tcp_interface.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15160 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/tcp/tcp_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22333 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/tcp/tcp_stream.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.269561 bitdust-0.1.9.241/bitdust/transport/udp/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11284 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_connector.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    24562 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_file_queue.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13917 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_interface.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    19322 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    26324 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_session.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    57234 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/transport/udp/udp_stream.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.269561 bitdust-0.1.9.241/bitdust/updates/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      879 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/updates/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12033 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/updates/git_proc.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.273561 bitdust-0.1.9.241/bitdust/userid/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      877 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15203 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/global_id.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    26726 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/id_registrator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15947 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/id_restorer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22413 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/id_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    43137 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/id_url.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    39322 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/identity.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4121 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/known_servers.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22377 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust/userid/my_id.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.233556 bitdust-0.1.9.241/bitdust.egg-info/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7712 2024-06-01 14:53:24.000000 bitdust-0.1.9.241/bitdust.egg-info/PKG-INFO
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    15026 2024-06-01 14:53:24.000000 bitdust-0.1.9.241/bitdust.egg-info/SOURCES.txt
+-rw-r--r--   0 veselin   (1000) veselin   (1001)        1 2024-06-01 14:53:24.000000 bitdust-0.1.9.241/bitdust.egg-info/dependency_links.txt
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      120 2024-06-01 14:53:24.000000 bitdust-0.1.9.241/bitdust.egg-info/requires.txt
+-rw-r--r--   0 veselin   (1000) veselin   (1001)       22 2024-06-01 14:53:24.000000 bitdust-0.1.9.241/bitdust.egg-info/top_level.txt
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.273561 bitdust-0.1.9.241/bitdust_forks/
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.277562 bitdust-0.1.9.241/bitdust_forks/Bismuth/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1699 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/aliases.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1567 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/aliasesv2.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    37605 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/apihandler.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      116 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/application_directories.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      846 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/balance_nogui.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2414 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/check_tx.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1034 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_addpeers.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      906 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_hn_last_block_ts.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1086 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_hn_reg_round.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    14518 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/commands.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3493 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/connectionmanager.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4852 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/connections.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22288 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/dbhandler.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1310 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/demo_getaddresssince.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1426 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/demo_getstatus.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4781 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/difficulty.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    28041 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/digest.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11457 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/essentials.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2257 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/fork.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9427 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/genesis.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      790 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/hmac_drbg.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      715 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/hyperlane.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1114 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/hyperlane_asyncio.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9049 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/ledger_explorer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1766 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/log.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    32181 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/mempool.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2362 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/mining.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7951 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/mining_heavy3.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)   129591 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      561 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/node_stop.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6116 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/optiexplorer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8203 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/optihash.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6049 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/options.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    25035 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/optipoolware.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    24780 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/peershandler.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6820 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/plugins.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      537 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/process_search.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      700 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/quantizer.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8161 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/regnet.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      636 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/rewards_reindex.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      446 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/rewards_test.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2014 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/send_csv.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4611 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/send_nogui_noconf.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5625 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/simplecrypt.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9408 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/staking.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9526 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/tokensv2.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1164 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_keys.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11108 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_server.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6998 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_websocket.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    16497 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/Bismuth/worker.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.281562 bitdust-0.1.9.241/bitdust_forks/CodernityDB/
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)      700 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/__init__.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)    42787 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/database.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1037 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_gevent.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     8184 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_safe_shared.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3992 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_super_thread_safe.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1170 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_thread_safe.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7835 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/debug_stuff.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      764 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/env.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)    33960 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/hash_index.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     4814 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    25578 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/indexcreator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4860 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/lfu_cache.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5547 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/lfu_cache_with_lock.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1370 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/migrate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1011 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/misc.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     2851 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/patch.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3756 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/rr_cache.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4115 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/rr_cache_with_lock.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     5125 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/sharded_hash.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3863 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/sharded_index.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     3806 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/storage.py
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)   107565 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB/tree_index.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.281562 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      700 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    43644 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1040 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_gevent.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8236 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_safe_shared.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3973 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_super_thread_safe.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1170 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_thread_safe.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7915 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/debug_stuff.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      764 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/env.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    40383 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/hash_index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4958 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    25451 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/indexcreator.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5435 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/lfu_cache.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6221 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/lfu_cache_with_lock.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1371 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/migrate.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1010 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/misc.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2852 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/patch.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4376 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/rr_cache.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4639 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/rr_cache_with_lock.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6030 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/sharded_hash.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3714 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/sharded_index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4261 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/storage.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)   111785 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/CodernityDB3/tree_index.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1803 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/__init__.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/entangled/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1474 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    25438 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/dtuple.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2008 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2181 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/constants.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3401 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/contact.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    12482 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/datastore.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     8793 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/encoding.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5867 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/kbucket.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6548 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/msgformat.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     3471 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/msgtypes.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    89776 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/node.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    33799 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/protocol.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    22400 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/routingtable.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13052 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/entangled/node.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/parallelp/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      885 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/__init__.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    36502 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4764 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppauto.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    11913 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppserver.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6981 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/pptransport.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5046 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppworker.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/txrestapi/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)        2 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/__init__.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.285563 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)        2 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     7447 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/json_resource.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1472 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/methods.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2941 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/resource.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)      169 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/service.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     9470 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/tests.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.289563 bitdust-0.1.9.241/bitdust_forks/websocket/
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1022 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/__init__.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13641 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_abnf.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    13508 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_app.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1758 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_cookiejar.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    17675 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_core.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2404 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_exceptions.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6436 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_handshake.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)    10842 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_http.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     2156 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_logging.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4757 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_socket.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     1797 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_ssl_compat.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     4707 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_url.py
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     6951 2024-06-01 14:42:25.000000 bitdust-0.1.9.241/bitdust_forks/websocket/_utils.py
+drwxr-xr-x   0 veselin   (1000) veselin   (1001)        0 2024-06-01 14:53:24.289563 bitdust-0.1.9.241/scripts/
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1918 2024-06-01 14:53:23.000000 bitdust-0.1.9.241/scripts/bitdust
+-rwxr-xr-x   0 veselin   (1000) veselin   (1001)     1833 2024-06-01 14:53:23.000000 bitdust-0.1.9.241/scripts/bitdust_worker
+-rw-r--r--   0 veselin   (1000) veselin   (1001)       38 2024-06-01 14:53:24.289563 bitdust-0.1.9.241/setup.cfg
+-rw-r--r--   0 veselin   (1000) veselin   (1001)     5284 2024-06-01 14:53:23.000000 bitdust-0.1.9.241/setup.py
```

### Comparing `bitdust-0.1.8.234/LICENSE.txt` & `bitdust-0.1.9.241/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/PKG-INFO` & `bitdust-0.1.9.241/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bitdust
-Version: 0.1.8.234
+Version: 0.1.9.241
 Summary: p2p secure distributed storage and communication engine
 Home-page: https://bitdust.io
 Download-URL: https://bitdust.io
 Author: Veselin Penev, BitDust
 Author-email: bitdust.io@gmail.com
 Maintainer: Veselin Penev, BitDust
 Maintainer-email: veselin@bitdust.io
```

### Comparing `bitdust-0.1.8.234/README.txt` & `bitdust-0.1.9.241/README.txt`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/__init__.py` & `bitdust-0.1.9.241/bitdust/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/access/__init__.py` & `bitdust-0.1.9.241/bitdust/access/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/access/group_access_donor.py` & `bitdust-0.1.9.241/bitdust/access/group_access_donor.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/access/key_ring.py` & `bitdust-0.1.9.241/bitdust/access/key_ring.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/access/shared_access_coordinator.py` & `bitdust-0.1.9.241/bitdust/access/shared_access_coordinator.py`

 * *Files 0% similar despite different names*

```diff
@@ -206,23 +206,23 @@
             if not my_keys.is_key_private(key_id):
                 continue
             if not my_keys.is_active(key_id):
                 continue
             to_be_opened.append(key_id)
     if _Debug:
         lg.args(_DebugLevel, known_offline_shares=known_offline_shares, to_be_opened=to_be_opened)
-    populate_shared_files = listeners.is_populate_requered('shared_file')
+    populate_shared_files = listeners.is_populate_required('shared_file')
     for key_id in to_be_opened:
         active_share = SharedAccessCoordinator(key_id, log_events=True, publish_events=False)
         active_share.automat('restart')
         if populate_shared_files:
             backup_fs.populate_shared_files(key_id=key_id)
     # if populate_shared_files:
     # listeners.populate_later().remove('shared_file')
-    if listeners.is_populate_requered('shared_location'):
+    if listeners.is_populate_required('shared_location'):
         # listeners.populate_later().remove('shared_location')
         populate_shares()
 
 
 #------------------------------------------------------------------------------
 
 
@@ -459,14 +459,15 @@
     return True
 
 
 #------------------------------------------------------------------------------
 
 
 class SharedAccessCoordinator(automat.Automat):
+
     """
     This class implements all the functionality of the ``shared_access_coordinator()`` state machine.
     """
     fast = False
 
     timers = {
         'timer-1min': (60, ['DHT_LOOKUP']),
@@ -656,14 +657,15 @@
         """
         Action method.
         """
         try:
             self.known_suppliers_list = [s for s in args[0]['suppliers'] if s]
         except:
             lg.exc()
+            self.automat('all-suppliers-disconnected')
             return
         self.known_ecc_map = args[0].get('ecc_map')
         self.suppliers_in_progress.clear()
         self.suppliers_succeed.clear()
         for supplier_idurl in self.known_suppliers_list:
             self.suppliers_in_progress.append(supplier_idurl)
             if id_url.is_cached(supplier_idurl):
```

### Comparing `bitdust-0.1.8.234/bitdust/access/shared_access_donor.py` & `bitdust-0.1.9.241/bitdust/access/shared_access_donor.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/automats/__init__.py` & `bitdust-0.1.9.241/bitdust/automats/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/automats/automat.py` & `bitdust-0.1.9.241/bitdust/automats/automat.py`

 * *Files 1% similar despite different names*

```diff
@@ -532,18 +532,20 @@
 
             machineA.automat('init', arguments)
 
         to send some ``event`` to the State Machine Object.
         You can attach parameters to that event with ``arguments`` tuple.
         If ``self.fast=False`` - the ``self.A()`` method will be executed in delayed call.
         """
-        if self.fast:
+        _fast = kwargs.pop('fast', False)
+        if self.fast or _fast:
             self.event(event, *args, **kwargs)
         else:
-            reactor.callLater(0, self.event, event, *args, **kwargs)  # @UndefinedVariable
+            delay = kwargs.pop('delay', 0)
+            reactor.callLater(delay, self.event, event, *args, **kwargs)  # @UndefinedVariable
         return self
 
     def event(self, event, *args, **kwargs):
         """
         You can call ``event()`` directly to execute ``self.A()`` immediately,
         but preferred way is too call ``automat()`` method.
 
@@ -676,15 +678,15 @@
         if exc_type is None or exc_value is None or exc_traceback is None:
             _t, _v, _tb = sys.exc_info()
         exc_type = _t if exc_type is None else exc_type
         exc_value = _v if exc_value is None else exc_value
         exc_traceback = _tb if exc_traceback is None else exc_traceback
         e = ''
         if exc_value is not None or exc_traceback is not None:
-            e = traceback.format_exception(etype=exc_type, value=exc_value, tb=exc_traceback)
+            e = traceback.format_exception(exc_type, value=exc_value, tb=exc_traceback)
         else:
             e = traceback.format_exc()
         if to_logfile and _LogFile is not None:
             if msg:
                 self.log(0, msg)
             self.log(0, e)
         if _LogExceptionsHandler is not None:
@@ -760,18 +762,15 @@
         key = (
             oldstate,
             newstate,
         )
         if key not in self._state_callbacks:
             self._state_callbacks[key] = []
         if cb not in self._state_callbacks[key]:
-            self._state_callbacks[key].append((
-                callback_id,
-                cb,
-            ))
+            self._state_callbacks[key].append((callback_id, cb))
         return True
 
     def removeStateChangedCallback(self, cb=None, callback_id=None):
         """
         Remove given callback from the state machine.
         """
         removed_count = 0
```

### Comparing `bitdust-0.1.8.234/bitdust/automats/global_state.py` & `bitdust-0.1.9.241/bitdust/automats/global_state.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/blockchain/__init__.py` & `bitdust-0.1.9.241/bitdust/blockchain/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/broadcast/__init__.py` & `bitdust-0.1.9.241/bitdust/broadcast/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/broadcast/broadcast_listener.py` & `bitdust-0.1.9.241/bitdust/broadcast/broadcast_listener.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/broadcast/broadcast_service.py` & `bitdust-0.1.9.241/bitdust/broadcast/broadcast_service.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/broadcast/broadcaster_node.py` & `bitdust-0.1.9.241/bitdust/broadcast/broadcaster_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/broadcast/broadcasters_finder.py` & `bitdust-0.1.9.241/bitdust/broadcast/broadcasters_finder.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/__init__.py` & `bitdust-0.1.9.241/bitdust/chat/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/kbhit.py` & `bitdust-0.1.9.241/bitdust/chat/kbhit.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/message_database.py` & `bitdust-0.1.9.241/bitdust/chat/message_database.py`

 * *Files 2% similar despite different names*

```diff
@@ -60,15 +60,15 @@
 from bitdust.lib import strng
 
 from bitdust.main import settings
 from bitdust.main import listeners
 
 from bitdust.crypt import my_keys
 
-from bitdust.access import group_member
+from bitdust.access import group_participant
 
 from bitdust.p2p import online_status
 
 from bitdust.userid import global_id
 from bitdust.userid import id_url
 from bitdust.userid import my_id
 
@@ -251,19 +251,18 @@
     return new_json
 
 
 def build_json_conversation(**record):
     conv = {
         'key_id': '',
         'label': '',
-        'state': 'OFFLINE',
+        'state': 'DISCONNECTED',
         'index': None,
         'id': None,
         'name': None,
-        'repr': None,
         'events': None,
     }
     conv.update(record)
     if conv['type'] == 'private_message':
         local_key_id1, _, local_key_id2 = conv['conversation_id'].partition('&')
         try:
             local_key_id1 = int(local_key_id1)
@@ -310,17 +309,17 @@
             return None
         key_id = my_keys.get_local_key(local_key_id)
         if not key_id:
             # lg.warn('key_id was not found for %r' % conv)
             return None
         conv['key_id'] = key_id
         conv['label'] = my_keys.get_label(key_id) or key_id
-        gm = group_member.get_active_group_member(key_id)
-        if gm:
-            conv.update(gm.to_json())
+        g_part = group_participant.get_active_group_participant(key_id)
+        if g_part:
+            conv.update(g_part.to_json())
     return conv
 
 
 #------------------------------------------------------------------------------
 
 
 def insert_message(data, message_id, message_time=None, sender=None, recipient=None, message_type=None, direction=None):
@@ -331,30 +330,24 @@
     payload_message_id = strng.to_text(message_id)
     payload_type = MESSAGE_TYPES.get(message_type, 1)
     if not sender:
         sender = my_id.getGlobalID(key_alias='master')
     if not recipient:
         recipient = my_id.getGlobalID(key_alias='master')
     if direction is None:
-        if message_type in [
-            'private_message',
-            None,
-        ]:
+        if message_type in ['private_message', None]:
             direction = 'out' if sender == my_id.getGlobalID(key_alias='master') else 'in'
         else:
             direction = 'in'
     else:
         direction = direction.replace('incoming', 'in').replace('outgoing', 'out')
     if _Debug:
         lg.args(_DebugLevel, sender=sender, recipient=recipient, typ=payload_type, dir=direction, message_id=payload_message_id)
     recipient_local_key_id = my_keys.get_local_key_id(recipient)
-    if payload_type in [
-        3,
-        4,
-    ]:
+    if payload_type in [3, 4]:
         sender_local_key_id = recipient_local_key_id
     else:
         sender_local_key_id = my_keys.get_local_key_id(sender)
     if sender_local_key_id is None or recipient_local_key_id is None:
         lg.err('failed to store message because local_key_id is not found, sender=%r recipient=%r' % (sender_local_key_id, recipient_local_key_id))
         return None
     cur().execute(
@@ -436,15 +429,15 @@
                 last_updated=payload_time,
                 last_message_id=payload_message_id,
             )
         )
     return conversation_id
 
 
-def query_messages(sender_id=None, recipient_id=None, bidirectional=True, order_by_time=True, message_types=[], offset=None, limit=None, raw_results=False):
+def query_messages(sender_id=None, recipient_id=None, bidirectional=True, order_by_id=True, order_by_time=False, message_types=[], sequence_head=None, sequence_tail=None, offset=None, limit=None, raw_results=False):
     sql = 'SELECT * FROM history'
     q = ''
     params = []
     if bidirectional and sender_id and recipient_id:
         recipient_local_key_id = my_keys.get_local_key_id(recipient_id)
         sender_local_key_id = my_keys.get_local_key_id(sender_id)
         if recipient_local_key_id is None or sender_local_key_id is None:
@@ -460,50 +453,57 @@
     else:
         if sender_id:
             sender_local_key_id = my_keys.get_local_key_id(sender_id)
             if sender_local_key_id is None:
                 lg.warn('local_key_id was not found for sender %r' % sender_id)
                 return []
             q += ' sender_local_key_id=?'
-            params += [
-                sender_local_key_id,
-            ]
+            params.append(sender_local_key_id)
         if recipient_id:
             recipient_local_key_id = my_keys.get_local_key_id(recipient_id)
             if recipient_local_key_id is None:
                 lg.warn('local_key_id was not found for recipient %r' % recipient_id)
                 return []
             q += ' recipient_local_key_id=?'
-            params += [
-                recipient_local_key_id,
-            ]
+            params.append(recipient_local_key_id)
     if message_types:
         if params:
             q += ' AND payload_type IN (%s)' % (','.join([
                 '?',
             ]*len(message_types)))
         else:
             q += ' payload_type IN (%s)' % (','.join([
                 '?',
             ]*len(message_types)))
         params.extend([MESSAGE_TYPES.get(mt, 1) for mt in message_types])
+    if sequence_head is not None:
+        if params:
+            q += ' AND payload_message_id>=?'
+        else:
+            q += ' payload_message_id>=?'
+        params.append(sequence_head)
+    if sequence_tail is not None:
+        if params:
+            q += ' AND payload_message_id<=?'
+        else:
+            q += ' payload_message_id<=?'
+        params.append(sequence_tail)
     if q:
         sql += ' WHERE %s' % q
-    if order_by_time:
-        sql += ' ORDER BY payload_time DESC'
+    if order_by_id:
+        sql += ' ORDER BY payload_message_id DESC'
+    else:
+        if order_by_time:
+            sql += ' ORDER BY payload_time DESC'
     if limit is not None:
         sql += ' LIMIT ?'
-        params += [
-            limit,
-        ]
+        params.append(limit)
     if offset is not None:
         sql += ' OFFSET ?'
-        params += [
-            offset,
-        ]
+        params.append(offset)
     if _Debug:
         lg.args(_DebugLevel, sql=sql, params=params)
     results = []
     local_key_ids = {}
     for row in cur().execute(sql, params):
         sender_local_key_id = row[0]
         sender_id_recorded = row[1]
@@ -646,18 +646,15 @@
         "last_message_id" TEXT)''')
     cur().execute('CREATE INDEX "conversation id" on conversations(conversation_id)')
     db().commit()
     for message_json in list(query_messages()):
         msg_typ = message_json['payload'].get('msg_type') or message_json['payload'].get('type')
         payload_type = MESSAGE_TYPES.get(msg_typ, 1)
         recipient_local_key_id = my_keys.get_local_key_id(message_json['recipient']['glob_id'])
-        if payload_type in [
-            3,
-            4,
-        ]:
+        if payload_type in [3, 4]:
             sender_local_key_id = recipient_local_key_id
         else:
             sender_local_key_id = my_keys.get_local_key_id(message_json['sender']['glob_id'])
         update_conversation(
             sender_local_key_id=sender_local_key_id,
             recipient_local_key_id=recipient_local_key_id,
             payload_type=payload_type,
```

### Comparing `bitdust-0.1.8.234/bitdust/chat/message_keeper.py` & `bitdust-0.1.9.241/bitdust/chat/message_keeper.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/nickname_holder.py` & `bitdust-0.1.9.241/bitdust/chat/nickname_holder.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/nickname_observer.py` & `bitdust-0.1.9.241/bitdust/chat/nickname_observer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/chat/terminal_chat.py` & `bitdust-0.1.9.241/bitdust/chat/terminal_chat.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/__init__.py` & `bitdust-0.1.9.241/bitdust/coins/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/accountant_node.py` & `bitdust-0.1.9.241/bitdust/coins/accountant_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/accountants_finder.py` & `bitdust-0.1.9.241/bitdust/coins/accountants_finder.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/coins_db.py` & `bitdust-0.1.9.241/bitdust/coins/coins_db.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/coins_index.py` & `bitdust-0.1.9.241/bitdust/coins/coins_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/coins_io.py` & `bitdust-0.1.9.241/bitdust/coins/coins_io.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/coins_miner.py` & `bitdust-0.1.9.241/bitdust/coins/coins_miner.py`

 * *Files 0% similar despite different names*

```diff
@@ -304,15 +304,15 @@
         if len(self.input_data) > 0:
             self.automat('new-data-received', self.input_data.pop(0))
 
     def doStartMining(self, *args, **kwargs):
         """
         Action method.
         """
-        self.mining_started = utime.get_sec1970()
+        self.mining_started = utime.utcnow_to_sec1970()
         d = self._start(args[0])
         d.addCallback(self._on_coin_mined)
         d.addErrback(lambda err: self.automat('stop'))
         d.addErrback(lambda err: lg.exc(exc_value=err))
 
     def doStopMining(self, *args, **kwargs):
         """
@@ -400,15 +400,15 @@
         self.automat('coin-mined', coin)
 
     def _stop_marker(self):
         if self.mining_started < 0:
             return True
         if self.mining_counts >= self.max_mining_counts:
             return True
-        if utime.get_sec1970() - self.mining_started > self.max_mining_seconds:
+        if utime.utcnow_to_sec1970() - self.mining_started > self.max_mining_seconds:
             return True
         self.mining_counts += 1
         return False
 
     def _build_starter(self, length):
         return (''.join([
             random.choice(string.uppercase + string.lowercase + string.digits)  # @UndefinedVariable
```

### Comparing `bitdust-0.1.8.234/bitdust/coins/contract_chain_consumer.py` & `bitdust-0.1.9.241/bitdust/coins/contract_chain_consumer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/contract_chain_node.py` & `bitdust-0.1.9.241/bitdust/coins/contract_chain_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/customer_contract_executor.py` & `bitdust-0.1.9.241/bitdust/coins/customer_contract_executor.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/mine_old.py` & `bitdust-0.1.9.241/bitdust/coins/mine_old.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/miner_old.py` & `bitdust-0.1.9.241/bitdust/coins/miner_old.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/coins/supplier_contract_executor.py` & `bitdust-0.1.9.241/bitdust/coins/supplier_contract_executor.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/contacts/__init__.py` & `bitdust-0.1.9.241/bitdust/contacts/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/contacts/contactsdb.py` & `bitdust-0.1.9.241/bitdust/contacts/contactsdb.py`

 * *Files 1% similar despite different names*

```diff
@@ -149,15 +149,15 @@
 def all_suppliers(as_dict=False):
     global _SuppliersList
     if as_dict:
         return _SuppliersList
     result = []
     for suppliers_list in _SuppliersList.values():
         for supplier_idurl in suppliers_list:
-            if supplier_idurl not in result:
+            if id_url.is_cached(supplier_idurl) and supplier_idurl not in result:
                 result.append(supplier_idurl)
     return result
 
 
 def set_suppliers(idlist, customer_idurl=None):
     """
     Set suppliers ID's list.
@@ -165,15 +165,18 @@
     global _SuppliersList
     if not customer_idurl:
         customer_idurl = my_id.getIDURL()
     customer_idurl = id_url.field(customer_idurl)
     if customer_idurl not in _SuppliersList:
         _SuppliersList[customer_idurl] = []
         lg.info('created new suppliers list in memory for customer %r' % customer_idurl)
-    _SuppliersList[customer_idurl] = id_url.fields_list(idlist)
+    try:
+        _SuppliersList[customer_idurl] = id_url.fields_list(idlist)
+    except:
+        pass
     if _Debug:
         lg.args(_DebugLevel, suppliers=_SuppliersList[customer_idurl], customer_idurl=customer_idurl)
 
 
 def update_suppliers(idlist, customer_idurl=None):
     """
     High-level method to set suppliers ID's list.
@@ -304,15 +307,18 @@
 
 
 def set_customers(idlist):
     """
     Set customers list.
     """
     global _CustomersList
-    _CustomersList = id_url.fields_list(idlist)
+    try:
+        _CustomersList = id_url.fields_list(idlist)
+    except:
+        pass
 
 
 def update_customers(idslist):
     """
     High-level method to set customers ID's list.
     Executes required callbacks.
     """
@@ -349,19 +355,18 @@
     if include_all or (include_enabled and driver.is_enabled('service_customer')) or driver.is_on('service_customer'):
         result.update(set(all_suppliers()))
     if include_all or (include_enabled and driver.is_enabled('service_supplier')) or driver.is_on('service_supplier'):
         result.update(set(customers() + known_customers()))
     if include_all or (include_enabled and driver.is_enabled('service_private_messages')) or driver.is_on('service_private_messages'):
         result.update(set(correspondents_ids()))
     if include_all or include_enabled:
-        if driver.is_enabled('service_message_broker') or driver.is_on('service_message_broker'):
-            from bitdust.stream import message_peddler
-            result.update(set(message_peddler.list_customers()))
-            result.update(set(message_peddler.list_consumers_producers(include_consumers=True, include_producers=True)))
-            result.update(set(message_peddler.list_known_brokers()))
+        if driver.is_enabled('service_joint_postman') or driver.is_on('service_joint_postman'):
+            from bitdust.stream import postman
+            result.update(set(postman.list_customers()))
+            result.update(set(postman.list_consumers_producers(include_consumers=True, include_producers=True)))
     return list(result)
 
 
 def contacts_list():
     """
     Return a list of suppliers and customers ID's.
     """
@@ -837,15 +842,15 @@
     load_customers()
     if _CustomersChangedCallback is not None:
         _CustomersChangedCallback([], customers())
     load_correspondents()
     if _CorrespondentsChangedCallback is not None:
         _CorrespondentsChangedCallback([], correspondents())
     AddContactsChangedCallback(on_contacts_changed)
-    if listeners.is_populate_requered('correspondent'):
+    if listeners.is_populate_required('correspondent'):
         # listeners.populate_later().remove('correspondent')
         populate_correspondents()
 
 
 #------------------------------------------------------------------------------
```

### Comparing `bitdust-0.1.8.234/bitdust/contacts/friends.py` & `bitdust-0.1.9.241/bitdust/contacts/friends.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/contacts/identitycache.py` & `bitdust-0.1.9.241/bitdust/contacts/identitycache.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/contacts/identitydb.py` & `bitdust-0.1.9.241/bitdust/contacts/identitydb.py`

 * *Files 1% similar despite different names*

```diff
@@ -303,16 +303,20 @@
             lg.out(_DebugLevel, 'identitydb.get_ident file %r not exist' % os.path.basename(filename))
         return None
     idxml = bpio.ReadTextFile(filename)
     if not idxml:
         if _Debug:
             lg.out(_DebugLevel, 'identitydb.get_ident %s not found' % nameurl.GetName(idurl))
         return None
-    idobj = identity.identity(xmlsrc=idxml)
-    idurl_orig = idobj.getIDURL()
+    try:
+        idobj = identity.identity(xmlsrc=idxml)
+        idurl_orig = idobj.getIDURL()
+    except:
+        lg.exc()
+        return None
     if idurl == idurl_orig.original():
         idset(idurl, idobj)
         return idobj
     lg.err('not found identity object idurl=%r idurl_orig=%r' % (idurl, idurl_orig))
     return None
```

### Comparing `bitdust-0.1.8.234/bitdust/crypt/__init__.py` & `bitdust-0.1.9.241/bitdust/crypt/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/certificate.py` & `bitdust-0.1.9.241/bitdust/crypt/certificate.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/cipher.py` & `bitdust-0.1.9.241/bitdust/crypt/cipher.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/encrypted.py` & `bitdust-0.1.9.241/bitdust/crypt/encrypted.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/hashes.py` & `bitdust-0.1.9.241/bitdust/crypt/hashes.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/key.py` & `bitdust-0.1.9.241/bitdust/crypt/key.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/my_keys.py` & `bitdust-0.1.9.241/bitdust/crypt/my_keys.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/number.py` & `bitdust-0.1.9.241/bitdust/crypt/number.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/rsa_key.py` & `bitdust-0.1.9.241/bitdust/crypt/rsa_key.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/crypt/signed.py` & `bitdust-0.1.9.241/bitdust/crypt/signed.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/currency/__init__.py` & `bitdust-0.1.9.241/bitdust/currency/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/currency/geth_service.py` & `bitdust-0.1.9.241/bitdust/currency/geth_service.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/customer/__init__.py` & `bitdust-0.1.9.241/bitdust/customer/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/customer/fire_hire.py` & `bitdust-0.1.9.241/bitdust/customer/fire_hire.py`

 * *Files 4% similar despite different names*

```diff
@@ -89,26 +89,26 @@
     * :red:`init`
     * :red:`instant`
     * :red:`made-decision`
     * :red:`restart`
     * :red:`search-failed`
     * :red:`supplier-connected`
     * :red:`supplier-state-changed`
-    * :red:`timer-15sec`
+    * :red:`timer-25sec`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 from six.moves import range
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 8
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import sys
 import time
 
 try:
@@ -122,14 +122,15 @@
 
 from bitdust.automats import global_state
 from bitdust.automats import automat
 
 from bitdust.lib import misc
 from bitdust.lib import diskspace
 from bitdust.lib import strng
+from bitdust.lib import utime
 
 from bitdust.main import config
 from bitdust.main import settings
 from bitdust.main import events
 
 from bitdust.contacts import contactsdb
 
@@ -141,14 +142,15 @@
 from bitdust.userid import id_url
 
 #-------------------------------------------------------------------------
 
 _FireHire = None
 _LastFireTime = 0
 _SuppliersToFire = []
+_ForceRestartState = False
 
 #-------------------------------------------------------------------------
 
 
 def GetLastFireTime():
     """
     This method returns a time moment when last time some supplier was
@@ -163,14 +165,19 @@
 
 
 def AddSupplierToFire(idurl):
     global _SuppliersToFire
     _SuppliersToFire.append(idurl)
 
 
+def ForceRestart():
+    global _ForceRestartState
+    _ForceRestartState = True
+
+
 def IsAllHired():
     if settings.getSuppliersNumberDesired() < 0:
         # I must know how many suppliers I want
         lg.warn('my desired number of suppliers not set')
         return False
     if contactsdb.num_suppliers() != settings.getSuppliersNumberDesired():
         # I must have exactly that amount of suppliers already
@@ -218,23 +225,24 @@
     _FireHire = None
 
 
 #------------------------------------------------------------------------------
 
 
 class FireHire(automat.Automat):
+
     """
     This class implements all the functionality of the ``fire_hire()`` state
     machine.
     """
 
     fast = False
 
     timers = {
-        'timer-15sec': (25.0, ['FIRE_MANY', 'SUPPLIERS?']),
+        'timer-25sec': (25.0, ['FIRE_MANY', 'SUPPLIERS?']),
     }
 
     def init(self):
         """
         Method to initialize additional variables and flags at creation of the
         state machine.
         """
@@ -267,20 +275,20 @@
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
             if event == 'init':
                 self.state = 'READY'
                 self.NeedRestart = False
         #---READY---
         elif self.state == 'READY':
-            if (event == 'restart' or (event == 'instant' and self.NeedRestart)) and self.isConfigChanged(*args, **kwargs) and self.isExistSomeSuppliers(*args, **kwargs):
+            if (event == 'restart' or (event == 'instant' and self.NeedRestart)) and (self.isConfigChanged(*args, **kwargs) or self.isContractExpiring(*args, **kwargs)) and self.isExistSomeSuppliers(*args, **kwargs):
                 self.state = 'SUPPLIERS?'
                 self.NeedRestart = False
                 self.doSaveConfig(*args, **kwargs)
                 self.doConnectSuppliers(*args, **kwargs)
-            elif (event == 'restart' or (event == 'instant' and self.NeedRestart)) and not (self.isConfigChanged(*args, **kwargs) and self.isExistSomeSuppliers(*args, **kwargs)):
+            elif (event == 'restart' or (event == 'instant' and self.NeedRestart)) and not ((self.isConfigChanged(*args, **kwargs) or self.isContractExpiring(*args, **kwargs)) and self.isExistSomeSuppliers(*args, **kwargs)):
                 self.state = 'DECISION?'
                 self.NeedRestart = False
                 self.doDecideToDismiss(*args, **kwargs)
         #---DECISION?---
         elif self.state == 'DECISION?':
             if event == 'made-decision' and self.isSomeoneToDismiss(*args, **kwargs) and not self.isMoreNeeded(*args, **kwargs):
                 self.state = 'FIRE_MANY'
@@ -318,33 +326,33 @@
             elif event == 'search-failed' and self.isSomeoneToDismiss(*args, **kwargs):
                 self.state = 'FIRE_MANY'
                 self.doDisconnectSuppliers(*args, **kwargs)
                 self.doRemoveSuppliers(*args, **kwargs)
                 self.doScheduleNextRestart(*args, **kwargs)
         #---FIRE_MANY---
         elif self.state == 'FIRE_MANY':
-            if event == 'timer-15sec':
-                self.state = 'READY'
-                self.doCloseConnectors(*args, **kwargs)
-                self.doClearDismissList(*args, **kwargs)
-                self.doNotifySuppliersChanged(*args, **kwargs)
-            elif event == 'supplier-state-changed' and not self.isAllDismissed(*args, **kwargs):
+            if event == 'supplier-state-changed' and not self.isAllDismissed(*args, **kwargs):
                 self.doCloseConnector(*args, **kwargs)
             elif event == 'restart':
                 self.NeedRestart = True
             elif event == 'supplier-state-changed' and self.isAllDismissed(*args, **kwargs):
                 self.state = 'READY'
                 self.doCloseConnector(*args, **kwargs)
                 self.doClearDismissList(*args, **kwargs)
                 self.doNotifySuppliersChanged(*args, **kwargs)
+            elif event == 'timer-25sec':
+                self.state = 'READY'
+                self.doCloseConnectors(*args, **kwargs)
+                self.doClearDismissList(*args, **kwargs)
+                self.doNotifySuppliersChanged(*args, **kwargs)
         #---SUPPLIERS?---
         elif self.state == 'SUPPLIERS?':
             if event == 'restart':
                 self.NeedRestart = True
-            elif (event == 'supplier-state-changed' and self.isAllReady(*args, **kwargs)) or event == 'timer-15sec':
+            elif (event == 'supplier-state-changed' and self.isAllReady(*args, **kwargs)) or event == 'timer-25sec':
                 self.state = 'DECISION?'
                 self.doDecideToDismiss(*args, **kwargs)
         return None
 
     def isMoreNeeded(self, *args, **kwargs):
         """
         Condition method.
@@ -417,18 +425,26 @@
         #     len(s), settings.getSuppliersNumberDesired(), result))
         return result
 
     def isConfigChanged(self, *args, **kwargs):
         """
         Condition method.
         """
-        if None in self.configs:
+        global _ForceRestartState
+        if _ForceRestartState:
             return True
-        curconfigs = (settings.getSuppliersNumberDesired(), diskspace.GetBytesFromString(settings.getNeededString()))
-        return self.configs[0] != curconfigs[0] or self.configs[1] != curconfigs[1]
+        return self._is_config_changed()
+
+    def isContractExpiring(self, *args, **kwargs):
+        """
+        Condition method.
+        """
+        if not driver.is_on('service_customer_contracts'):
+            return False
+        return len(self._get_suppliers_with_expired_contracts()) > 0
 
     def isExistSomeSuppliers(self, *args, **kwargs):
         """
         Condition method.
         """
         sup_list = contactsdb.suppliers()
         return contactsdb.num_suppliers() > 0 and sup_list.count(id_url.field(b'')) < contactsdb.num_suppliers()
@@ -442,23 +458,34 @@
             diskspace.GetBytesFromString(settings.getNeededString()),
         )
 
     def doConnectSuppliers(self, *args, **kwargs):
         """
         Action method.
         """
+        global _ForceRestartState
+        _ForceRestartState = False
         from bitdust.customer import supplier_connector
         from bitdust.p2p import online_status
         self.connect_list = []
         my_current_family = contactsdb.suppliers()
+        target_suppliers = list(my_current_family)
+        if not self._is_config_changed():
+            if driver.is_on('service_customer_contracts'):
+                # only select suppliers with expired contracts
+                target_suppliers = self._get_suppliers_with_expired_contracts()
+        if _Debug:
+            lg.args(_DebugLevel, my_current_family=my_current_family, target_suppliers=target_suppliers, configs=self.configs)
         for pos, supplier_idurl in enumerate(my_current_family):
             if not supplier_idurl:
                 continue
             if self.configs[0] and pos >= self.configs[0]:
                 continue
+            if not id_url.is_in(supplier_idurl, target_suppliers):
+                continue
             sc = supplier_connector.by_idurl(supplier_idurl)
             if sc is None:
                 sc = supplier_connector.create(
                     supplier_idurl=supplier_idurl,
                     customer_idurl=my_id.getIDURL(),
                 )
             else:
@@ -546,18 +573,15 @@
                 continue
             if sc.state == 'NO_SERVICE':
                 lg.warn('found "NO_SERVICE" supplier: %s' % supplier_idurl)
                 disconnected_suppliers.add(supplier_idurl)
                 potentialy_fired.add(supplier_idurl)
             elif sc.state == 'CONNECTED':
                 connected_suppliers.add(supplier_idurl)
-            elif sc.state in [
-                'DISCONNECTED',
-                'REFUSE',
-            ]:
+            elif sc.state in ['DISCONNECTED', 'REFUSE']:
                 disconnected_suppliers.add(supplier_idurl)
 #             elif sc.state in ['QUEUE?', 'REQUEST', ]:
 #                 requested_suppliers.add(supplier_idurl)
             if online_status.isOffline(supplier_idurl):
                 offline_suppliers.add(supplier_idurl)
             elif online_status.isOnline(supplier_idurl):
                 online_suppliers.add(supplier_idurl)
@@ -598,20 +622,17 @@
             if _Debug:
                 lg.out(_DebugLevel, 'fire_hire.doDecideToDismiss   found no "bad" suppliers, all is good !!!!!')
             self.automat('made-decision', [])
             return
         # only replace suppliers one by one at the moment
         result = list(potentialy_fired)
         lg.info('will replace supplier %s' % result[0])
-        self.automat(
-            'made-decision',
-            [
-                result[0],
-            ],
-        )
+        self.automat('made-decision', [
+            result[0],
+        ])
 
     def doRememberSuppliers(self, *args, **kwargs):
         """
         Action method.
         """
         self.dismiss_list = id_url.to_list(args[0])
 
@@ -641,15 +662,15 @@
                 position_for_new_supplier = pos
                 break
         if position_for_new_supplier is None:
             lg.err('did not found position for new supplier')
             self.automat('search-failed')
             return
         from bitdust.customer import supplier_finder
-        for idurl_txt in strng.to_text(config.conf().getData('services/employer/candidates')).split(','):
+        for idurl_txt in strng.to_text(config.conf().getString('services/employer/candidates')).split(','):
             if idurl_txt.strip():
                 supplier_finder.AddSupplierToHire(idurl_txt)
         self.hire_list.append(position_for_new_supplier)
         supplier_finder.A(
             'start',
             family_position=position_for_new_supplier,
             ecc_map=eccmap.Current().name,
@@ -857,14 +878,35 @@
 
     def doNotifyFinished(self, *args, **kwargs):
         self.hire_list = []
         if driver.is_on('service_backups'):
             from bitdust.storage import backup_monitor
             backup_monitor.A('fire-hire-finished')
 
+    def _is_config_changed(self):
+        if None in self.configs:
+            return True
+        curconfigs = (settings.getSuppliersNumberDesired(), diskspace.GetBytesFromString(settings.getNeededString()))
+        return self.configs[0] != curconfigs[0] or self.configs[1] != curconfigs[1]
+
+    def _get_suppliers_with_expired_contracts(self):
+        from bitdust.customer import supplier_connector
+        now = utime.utcnow_to_sec1970()
+        ret = []
+        for supplier_idurl in contactsdb.suppliers():
+            if supplier_idurl:
+                sc = supplier_connector.by_idurl(supplier_idurl)
+                if sc:
+                    if sc.state == 'CONNECTED':
+                        if sc.storage_contract:
+                            if now > utime.unpack_time(sc.storage_contract['complete_after']):
+                                lg.warn('storage contract with %s is expired' % supplier_idurl)
+                                ret.append(supplier_idurl)
+        return ret
+
     def _scheduled_restart(self):
         self.restart_task = None
         self.automat('restart')
 
     def _on_supplier_connector_state_changed(self, idurl, newstate, **kwargs):
         from bitdust.customer import supplier_connector
         idurl = id_url.field(idurl)
```

### Comparing `bitdust-0.1.8.234/bitdust/customer/list_files_orator.py` & `bitdust-0.1.9.241/bitdust/customer/list_files_orator.py`

 * *Files 1% similar despite different names*

```diff
@@ -51,15 +51,15 @@
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 8
+_DebugLevel = 12
 
 #------------------------------------------------------------------------------
 
 import time
 
 #------------------------------------------------------------------------------
 
@@ -172,14 +172,15 @@
         return
     _ListFilesOrator.destroy()
     del _ListFilesOrator
     _ListFilesOrator = None
 
 
 class ListFilesOrator(automat.Automat):
+
     """
     A class to request list of my files from my suppliers and also scan the
     local files.
     """
 
     timers = {
         'timer-2sec': (2.0, ['REMOTE_FILES']),
```

### Comparing `bitdust-0.1.8.234/bitdust/customer/supplier_connector.py` & `bitdust-0.1.9.241/bitdust/customer/supplier_connector.py`

 * *Files 3% similar despite different names*

```diff
@@ -48,15 +48,15 @@
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 16
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import os
 import math
 
 from twisted.internet import reactor  # @UnresolvedImport
@@ -71,23 +71,28 @@
 
 from bitdust.main import settings
 from bitdust.main import events
 
 from bitdust.lib import strng
 from bitdust.lib import nameurl
 from bitdust.lib import diskspace
+from bitdust.lib import jsn
 
 from bitdust.contacts import contactsdb
 
+from bitdust.services import driver
+
 from bitdust.p2p import commands
 from bitdust.p2p import p2p_service
 from bitdust.p2p import online_status
 
 from bitdust.raid import eccmap
 
+from bitdust.storage import accounting
+
 from bitdust.userid import id_url
 from bitdust.userid import global_id
 from bitdust.userid import my_id
 
 #------------------------------------------------------------------------------
 
 _SuppliersConnectors = {}
@@ -155,14 +160,15 @@
     return count
 
 
 #------------------------------------------------------------------------------
 
 
 class SupplierConnector(automat.Automat):
+
     """
     This class implements all the functionality of the ``supplier_connector()``
     state machine.
     """
 
     timers = {
         'timer-30sec': (30.0, ['REQUEST']),
@@ -181,22 +187,25 @@
         name = 'supplier_%s_%s_%s' % (
             nameurl.GetName(self.supplier_idurl),
             nameurl.GetName(self.customer_idurl),
             diskspace.MakeStringFromBytes(self.needed_bytes).replace(' ', ''),
         )
         self.request_packet_id = None
         self.request_queue_packet_id = None
+        self.latest_supplier_ack = None
         self.callbacks = {}
+        self.storage_contract = None
         try:
             st = bpio.ReadTextFile(settings.SupplierServiceFilename(
-                idurl=self.supplier_idurl,
+                supplier_idurl=self.supplier_idurl,
                 customer_idurl=self.customer_idurl,
             )).strip()
         except:
-            st = 'DISCONNECTED'
+            lg.exc()
+        st = st or 'DISCONNECTED'
         automat.Automat.__init__(
             self,
             name,
             state=st,
             debug_level=_DebugLevel,
             log_events=_Debug,
             log_transitions=_Debug,
@@ -214,58 +223,58 @@
         self._last_known_ecc_map = None
         self._last_known_family_snapshot = None
         self._supplier_connected_event_sent = False
         online_status.add_online_status_listener_callback(
             idurl=self.supplier_idurl,
             callback_method=self._on_online_status_state_changed,
         )
-        # contact_peer = contact_status.getInstance(self.supplier_idurl)
-        # if contact_peer:
-        #     contact_peer.addStateChangedCallback(self._on_contact_status_state_changed)
 
     def state_changed(self, oldstate, newstate, event, *args, **kwargs):
         """
         This method intended to catch the moment when automat's state was changed.
         """
         if newstate in ['CONNECTED', 'DISCONNECTED', 'NO_SERVICE']:
             supplierPath = settings.SupplierPath(self.supplier_idurl, customer_idurl=self.customer_idurl)
             if not os.path.isdir(supplierPath):
                 try:
                     os.makedirs(supplierPath)
                 except:
                     lg.exc()
                     return
             bpio.WriteTextFile(
-                settings.SupplierServiceFilename(self.supplier_idurl, customer_idurl=self.customer_idurl),
+                settings.SupplierServiceFilename(supplier_idurl=self.supplier_idurl, customer_idurl=self.customer_idurl),
                 newstate,
             )
         if newstate == 'CONNECTED':
+            if id_url.is_the_same(self.customer_idurl, my_id.getIDURL()):
+                #TODO: receive and process contract details: "pay_before" field
+                pass
             if not self._supplier_connected_event_sent:
                 self._supplier_connected_event_sent = True
                 events.send('supplier-connected', data=dict(
                     supplier_idurl=self.supplier_idurl,
                     customer_idurl=self.customer_idurl,
                     needed_bytes=self.needed_bytes,
                     key_id=self.key_id,
                 ))
         if newstate in ['DISCONNECTED', 'NO_SERVICE']:
             self._supplier_connected_event_sent = False
 
     def set_callback(self, name, cb):
         if name not in self.callbacks:
             self.callbacks[name] = []
+        if cb in self.callbacks[name]:
+            lg.warn('callback %r is already registered in %r with name %s' % (cb, self, name))
         self.callbacks[name].append(cb)
 
     def remove_callback(self, name, cb=None):
         if name in self.callbacks:
             if cb:
-                if cb in self.callbacks[name]:
+                while cb in self.callbacks[name]:
                     self.callbacks[name].remove(cb)
-                else:
-                    lg.warn('callback %r not registered in %r with name %s' % (cb, self, name))
             else:
                 self.callbacks.pop(name)
         else:
             lg.warn('callback with name %s not registered in %r' % (name, self))
 
     def do_calculate_needed_bytes(self):
         if self.needed_bytes is None:
@@ -307,17 +316,14 @@
             elif event == 'fail' or event == 'connect':
                 self.state = 'REQUEST'
                 self.GoDisconnect = False
                 self.doPingRequestService(*args, **kwargs)
             elif event == 'shutdown':
                 self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-        #---CLOSED---
-        elif self.state == 'CLOSED':
-            pass
         #---DISCONNECTED---
         elif self.state == 'DISCONNECTED':
             if event == 'shutdown':
                 self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
             elif event == 'disconnect':
                 self.state = 'REFUSE'
@@ -372,14 +378,17 @@
             elif self.GoDisconnect and (event == 'queue-ack' or event == 'queue-fail' or event == 'queue-skip' or event == 'timer-10sec'):
                 self.state = 'REFUSE'
                 self.doCancelServiceQueue(*args, **kwargs)
                 self.doCancelService(*args, **kwargs)
             elif not self.GoDisconnect and (event == 'queue-ack' or event == 'queue-fail' or event == 'queue-skip' or event == 'timer-10sec'):
                 self.state = 'CONNECTED'
                 self.doReportConnect(*args, **kwargs)
+        #---CLOSED---
+        elif self.state == 'CLOSED':
+            pass
         return None
 
     def isServiceAccepted(self, *args, **kwargs):
         """
         Condition method.
         """
         newpacket = args[0]
@@ -395,15 +404,15 @@
         """
         Condition method.
         """
         newpacket = args[0]
         if newpacket.Command == commands.Ack():
             if strng.to_text(newpacket.Payload).startswith('accepted'):
                 if _Debug:
-                    lg.out(6, 'supplier_connector.isServiceCancelled !!! supplier %s disconnected' % self.supplier_idurl)
+                    lg.out(_DebugLevel, 'supplier_connector.isServiceCancelled !!! supplier %s disconnected' % self.supplier_idurl)
                 return True
         return False
 
     def doPingRequestService(self, *args, **kwargs):
         """
         Action method.
         """
@@ -515,15 +524,15 @@
                         supplier_id=self.supplier_id,
                     ),
                 },
                 {
                     'scope': 'consumer',
                     'action': 'remove_callback',
                     'consumer_id': self.customer_id,
-                    'method': self.customer_id,
+                    'method': self.customer_idurl,
                 },
                 {
                     'scope': 'consumer',
                     'action': 'stop',
                     'consumer_id': self.customer_id,
                 },
             ],
@@ -586,75 +595,96 @@
         Action method.
         """
         online_status.remove_online_status_listener_callback(
             idurl=self.supplier_idurl,
             callback_method=self._on_online_status_state_changed,
         )
         connectors(self.customer_idurl).pop(self.supplier_idurl)
+        self.latest_supplier_ack = None
         self.request_packet_id = None
         self.request_queue_packet_id = None
         self.supplier_idurl = None
         self.customer_idurl = None
         self.queue_subscribe = None
         self.destroy()
 
     def _supplier_service_acked(self, response, info):
+        if _Debug:
+            lg.args(_DebugLevel, response=response, info=info)
         if not self.request_packet_id:
             lg.warn('received "old" response : %r' % response)
             return
         if response.PacketID != self.request_packet_id:
             lg.warn('received "unexpected" response : %r' % response)
             return
-        if _Debug:
-            lg.args(_DebugLevel, response=response, info=info)
+        self.latest_supplier_ack = response
+        if driver.is_on('service_customer_contracts'):
+            the_contract = None
+            try:
+                if strng.to_text(response.Payload).startswith('accepted:{'):
+                    the_contract = jsn.loads_text(strng.to_text(response.Payload)[9:])
+            except:
+                lg.exc()
+            if _Debug:
+                lg.args(_DebugLevel, response=response, info=info, contract=the_contract)
+            if the_contract:
+                if not accounting.verify_storage_contract(the_contract):
+                    lg.err('received storage contract from %r is not valid' % self.supplier_idurl)
+                    self.latest_supplier_ack = None
+                    self.automat('fail', None)
+                    return
+                from bitdust.customer import payment
+                payment.save_storage_contract(self.supplier_idurl, the_contract)
+                self.storage_contract = the_contract
         self.automat('ack', response)
 
     def _supplier_service_failed(self, response, info):
         if _Debug:
             lg.args(_DebugLevel, response=response, info=info)
         self.automat('fail', response or None)
 
     def _supplier_queue_acked(self, response, info):
         if not self.request_queue_packet_id:
             lg.warn('received "old" queue response : %r' % response)
             return
         if response.PacketID != self.request_queue_packet_id:
             lg.warn('received "unexpected" queue response : %r' % response)
             return
+        if _Debug:
+            lg.args(_DebugLevel, response=response, info=info)
         # start_consumer(self.customer_id, self.supplier_id)
         self.automat('queue-ack', response)
 
     def _supplier_queue_cancelled(self, response, info):
         # stop_consumer(self.customer_id, self.supplier_id)
         self.automat('queue-stopped', response)
 
     def _supplier_queue_failed(self, response, info):
         if _Debug:
             lg.args(_DebugLevel, response=response, info=info)
         self.automat('queue-fail', response or None)
 
     def _on_online_status_state_changed(self, oldstate, newstate, event_string, *args, **kwargs):
-        if oldstate != newstate and newstate in [
-            'CONNECTED',
-            'OFFLINE',
-        ]:
+        if oldstate != newstate and newstate in ['CONNECTED', 'OFFLINE']:
             if not (oldstate == 'PING?' and newstate == 'OFFLINE'):
                 if _Debug:
                     lg.out(_DebugLevel, 'supplier_connector._on_online_status_state_changed %s : %s->%s, reconnecting now' % (self.supplier_idurl, oldstate, newstate))
                 reactor.callLater(0, self.automat, 'connect')  # @UndefinedVariable
 
     def _do_request_supplier_service(self, ecc_map, family_position, family_snapshot):
         if _Debug:
             lg.args(_DebugLevel, supplier_idurl=self.supplier_idurl, ecc_map=ecc_map, family_position=family_position, family_snapshot=family_snapshot)
         if not self.supplier_idurl:
             lg.warn('supplier idurl is empty, SKIP sending supplier_service request')
             return
         service_info = {
-            'needed_bytes': self.needed_bytes,
             'customer_id': self.customer_id,
+            'needed_bytes': self.needed_bytes,
+            # 'minimum_duration_hours': 6,
+            # 'maximum_duration_hours': 24*30,
         }
         # TODO: re-think again about the customer key, do we really need it?
         # my_customer_key_id = my_id.getGlobalID(key_alias='customer')
         # if my_keys.is_key_registered(my_customer_key_id):
         #     service_info['customer_public_key'] = my_keys.get_key_info(
         #         key_id=my_customer_key_id,
         #         include_private=False,
```

### Comparing `bitdust-0.1.8.234/bitdust/customer/supplier_finder.py` & `bitdust-0.1.9.241/bitdust/customer/supplier_finder.py`

 * *Files 0% similar despite different names*

```diff
@@ -355,18 +355,15 @@
         if _Debug:
             lg.out(_DebugLevel, '    selected %r and will request supplier service' % found_idurl)
         self.automat('found-one-user', found_idurl)
 
     def _supplier_connector_state(self, supplier_idurl, newstate, **kwargs):
         if id_url.field(supplier_idurl) != self.target_idurl:
             return
-        if newstate in [
-            'DISCONNECTED',
-            'NO_SERVICE',
-        ]:
+        if newstate in ['DISCONNECTED', 'NO_SERVICE']:
             self.automat('supplier-not-connected')
             return
         if newstate != 'CONNECTED':
             return
         if contactsdb.is_supplier(self.target_idurl):
             return
         family_position = kwargs.get('family_position', None)
```

### Comparing `bitdust-0.1.8.234/bitdust/dht/__init__.py` & `bitdust-0.1.9.241/bitdust/dht/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/dht/dht_records.py` & `bitdust-0.1.9.241/bitdust/dht/dht_records.py`

 * *Files 24% similar despite different names*

```diff
@@ -72,14 +72,15 @@
 #------------------------------------------------------------------------------
 
 RELATION_RECORD_CACHE_TTL = {
     'nickname': 60*60*24,
     'identity': 60*60,
     'suppliers': 60*60*12,
     'message_broker': 60*60*12,
+    'bismuth_identity_request': 60*60,
 }
 
 _Rules = {
     'nickname': {
         'key': [
             {
                 'op': 'exist',
@@ -206,15 +207,44 @@
             },
         ],
         'position': [
             {
                 'op': 'exist',
             },
         ],  # 'archive_folder_path': [{'op': 'exist', }, ],
-    },  # customers relations are not stored, so this is actually not needed, but decided to leave it here just in case:
+    },
+    'bismuth_identity_request': {
+        'type': [
+            {
+                'op': 'equal',
+                'arg': 'bismuth_identity_request',
+            },
+        ],
+        'timestamp': [
+            {
+                'op': 'exist',
+            },
+        ],
+        'idurl': [
+            {
+                'op': 'exist',
+            },
+        ],
+        'public_key': [
+            {
+                'op': 'exist',
+            },
+        ],
+        'position': [
+            {
+                'op': 'exist',
+            },
+        ],
+    },
+    # customers relations are not stored, so this is actually not needed, but decided to leave it here just in case:
     # 'customers': {
     #     'key': [{'op': 'exist', }, ],
     #     'type': [{'op': 'equal', 'arg': 'customers', }, ],
     #     'timestamp': [{'op': 'exist', }, ],
     #     'customer_idurl': [{'op': 'exist', }, ],
     #     'revision': [{'op': 'exist', }, ],
     # },
@@ -256,15 +286,15 @@
 
 def set_nickname(key, idurl):
     if _Debug:
         lg.args(_DebugLevel, key, idurl)
     nickname, _, pos = key.partition(':')
     json_data = {
         'type': 'nickname',
-        'timestamp': utime.get_sec1970(),
+        'timestamp': utime.utcnow_to_sec1970(),
         'idurl': idurl.to_bin(),
         'nickname': nickname,
         'position': pos,
     }
     return dht_service.set_valid_data(
         key=key,
         json_data=json_data,
@@ -289,15 +319,15 @@
 def set_identity(idurl, raw_xml_data):
     if _Debug:
         lg.args(_DebugLevel, idurl)
     return dht_service.set_valid_data(
         key=idurl,
         json_data={
             'type': 'identity',
-            'timestamp': utime.get_sec1970(),
+            'timestamp': utime.utcnow_to_sec1970(),
             'idurl': strng.to_text(idurl),
             'identity': strng.to_text(raw_xml_data),
         },
         rules=get_rules('identity'),
     )
 
 
@@ -335,15 +365,15 @@
     return dht_service.set_valid_data(
         key=dht_service.make_key(
             key=strng.to_text(customer_idurl),
             prefix='suppliers',
         ),
         json_data={
             'type': 'suppliers',
-            'timestamp': utime.get_sec1970(),
+            'timestamp': utime.utcnow_to_sec1970(),
             'revision': 0 if revision is None else revision,
             'publisher_idurl': publisher_idurl.to_text() if publisher_idurl else None,
             'customer_idurl': customer_idurl.to_text(),
             'ecc_map': ecc_map,
             'suppliers': list(map(lambda i: i.to_text(), suppliers_list)),
         },
         rules=get_rules('suppliers'),
@@ -375,17 +405,75 @@
     return dht_service.set_valid_data(
         key=dht_service.make_key(
             key='%s%d' % (strng.to_text(customer_idurl), position),
             prefix='message_broker',
         ),
         json_data={
             'type': 'message_broker',
-            'timestamp': utime.get_sec1970(),
+            'timestamp': utime.utcnow_to_sec1970(),
             'revision': 0 if revision is None else revision,
             'customer_idurl': customer_idurl.to_text(),
             'broker_idurl': broker_idurl.to_text(),  # 'archive_folder_path': archive_folder_path,
             'position': position,
         },
         rules=get_rules('message_broker'),
         expire=expire,
         collect_results=True,
     )
+
+
+#------------------------------------------------------------------------------
+
+
+def get_bismuth_identity_request(position, use_cache=False):
+    time_shift = int(utime.utcnow_to_sec1970()/(60*60))
+    dht_key = dht_service.make_key(
+        key=time_shift,
+        index=position,
+        prefix='blockchain_identity',
+    )
+    ret = dht_service.get_valid_data(
+        key=dht_key,
+        rules=get_rules('bismuth_identity_request'),
+        use_cache_ttl=RELATION_RECORD_CACHE_TTL['bismuth_identity_request'] if use_cache else None,
+    )
+    if _Debug:
+        lg.args(_DebugLevel, dht_key=dht_key, ret=ret)
+    return ret
+
+
+def set_bismuth_identity_request(position, idurl, public_key, wallet_address):
+    json_data = {
+        'type': 'bismuth_identity_request',
+        'timestamp': utime.utcnow_to_sec1970(),
+        'idurl': idurl.to_bin(),
+        'public_key': public_key,
+        'wallet_address': wallet_address,
+        'position': position,
+    }
+    time_shift = int(utime.utcnow_to_sec1970()/(60*60))
+    dht_key = dht_service.make_key(
+        key=time_shift,
+        index=position,
+        prefix='blockchain_identity',
+    )
+    ret = dht_service.set_valid_data(
+        key=dht_key,
+        json_data=json_data,
+        rules=get_rules('bismuth_identity_request'),
+    )
+    if _Debug:
+        lg.args(_DebugLevel, dht_key=dht_key, idurl=idurl, wallet_address=wallet_address, ret=ret)
+    return ret
+
+
+def erase_bismuth_identity_request(position):
+    time_shift = int(utime.utcnow_to_sec1970()/(60*60))
+    dht_key = dht_service.make_key(
+        key=time_shift,
+        index=position,
+        prefix='blockchain_identity',
+    )
+    ret = dht_service.delete_key(key=dht_key)
+    if _Debug:
+        lg.args(_DebugLevel, dht_key=dht_key, ret=ret)
+    return ret
```

### Comparing `bitdust-0.1.8.234/bitdust/dht/dht_relations.py` & `bitdust-0.1.9.241/bitdust/dht/dht_relations.py`

 * *Files 1% similar despite different names*

```diff
@@ -202,23 +202,17 @@
         publisher_idurl=publisher_idurl,
     )
 
 
 #------------------------------------------------------------------------------
 
 
-def read_customer_message_brokers(
-    customer_idurl,
-    positions=[
-        0,
-    ],
-    return_details=True,
-    as_fields=True,
-    use_cache=True,
-):
+def read_customer_message_brokers(customer_idurl, positions=[
+    0,
+], return_details=True, as_fields=True, use_cache=True):
     if _Debug:
         lg.args(_DebugLevel, customer_idurl=customer_idurl, use_cache=use_cache, positions=positions)
     if as_fields:
         customer_idurl = id_url.field(customer_idurl)
     else:
         customer_idurl = id_url.to_bin(customer_idurl)
     result = Deferred()
```

### Comparing `bitdust-0.1.8.234/bitdust/dht/dht_service.py` & `bitdust-0.1.9.241/bitdust/dht/dht_service.py`

 * *Files 0% similar despite different names*

```diff
@@ -1185,15 +1185,15 @@
         lg.args(_DebugLevel, total_records=total_records, records_per_layer=records_per_layer)
     return total_records
 
 
 def store_cached_key(hash_key, json_value, layer_id=0, timestamp=None):
     global _Cache
     if not timestamp:
-        timestamp = utime.get_sec1970()
+        timestamp = utime.utcnow_to_sec1970()
     if layer_id not in _Cache:
         _Cache[layer_id] = {}
     cached_json_record = {
         'v': json_value,
         't': timestamp,
     }
     dht_dir_path = settings.ServiceDir('service_entangled_dht')
@@ -1227,15 +1227,15 @@
 
 
 def get_cached_json_value(key, layer_id=0, cache_ttl=DEFAULT_CACHE_TTL):
     hash_key = key_to_hash(key)
     cached_record = get_cached_value(hash_key)
     if not cached_record:
         return get_json_value(key, layer_id=layer_id, update_cache=True)
-    if utime.get_sec1970() - int(cached_record['t']) > cache_ttl:
+    if utime.utcnow_to_sec1970() - int(cached_record['t']) > cache_ttl:
         return get_json_value(key, layer_id=layer_id, update_cache=True)
     if _Debug:
         lg.out(_DebugLevel, 'dht_service.get_cached_json_value key=[%r] layer_id=%d cache_ttl=%d' % (key, layer_id, cache_ttl))
     ret = Deferred()
     ret.callback(cached_record['v'])
     return ret
 
@@ -1285,15 +1285,15 @@
                 print('[DHT NODE]    found "nodeState" key in local db and added %d contacts to routing table' % len(state['closestNodes']))
         else:
             self.id = self._generateID()
             self._routingTable = TreeRoutingTable(self.id)
         self._counter = None
 
     def expire(self):
-        now = utime.get_sec1970()
+        now = utime.utcnow_to_sec1970()
         for layer_id in self._dataStores.keys():
             expired_keys = []
             for key in self._dataStores[layer_id].keys():
                 if key == self.nodeStateKey:
                     continue
                 item_data = self._dataStores[layer_id].getItem(key)
                 if item_data:
```

### Comparing `bitdust-0.1.8.234/bitdust/dht/known_nodes.py` & `bitdust-0.1.9.241/bitdust/dht/known_nodes.py`

 * *Files 2% similar despite different names*

```diff
@@ -87,15 +87,15 @@
     This way you can create your own DHT network, inside BitDust, under your full control.
     """
 
     from bitdust.main import config
     from bitdust.lib import strng
 
     try:
-        overridden_dht_nodes_str = str(config.conf().getData('services/entangled-dht/known-nodes'))
+        overridden_dht_nodes_str = str(config.conf().getString('services/entangled-dht/known-nodes'))
     except:
         overridden_dht_nodes_str = ''
 
     if overridden_dht_nodes_str in [
         'genesis',
         'root',
         b'genesis',
```

### Comparing `bitdust-0.1.8.234/bitdust/interface/__init__.py` & `bitdust-0.1.9.241/bitdust/interface/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/interface/api.py` & `bitdust-0.1.9.241/bitdust/interface/api.py`

 * *Files 2% similar despite different names*

```diff
@@ -32,15 +32,15 @@
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 12
+_DebugLevel = 10
 
 _APILogFileEnabled = None
 
 #------------------------------------------------------------------------------
 
 import os
 import sys
@@ -522,17 +522,17 @@
         }
     if driver.is_on('service_shared_data'):
         from bitdust.access import shared_access_coordinator
         result['share'] = {
             'active': len(shared_access_coordinator.list_active_shares()),
         }
     if driver.is_on('service_private_groups'):
-        from bitdust.access import group_member
+        from bitdust.access import group_participant
         result['group'] = {
-            'active': len(group_member.list_active_group_members()),
+            'active': len(group_participant.list_active_group_participants()),
         }
     if driver.is_on('service_gateway'):
         from bitdust.transport import gateway
         from bitdust.transport import packet_in
         from bitdust.transport import packet_out
         result['network']['packets_out'] = len(packet_out.queue())
         result['network']['packets_out_total'] = packet_out.get_packets_counter()
@@ -540,19 +540,17 @@
         result['network']['packets_in_total'] = packet_in.get_packets_counter()
         result['network']['protocols'] = len(gateway.transports())
     if driver.is_on('service_p2p_notifications'):
         from bitdust.stream import p2p_queue
         result['stream']['queues'] = len(p2p_queue.queue())
         result['stream']['consumers'] = len(p2p_queue.consumer())
         result['stream']['producers'] = len(p2p_queue.producer())
-    if driver.is_on('service_message_broker'):
-        from bitdust.stream import queue_keeper
-        from bitdust.stream import message_peddler
-        result['stream']['peddlers'] = len(message_peddler.streams())
-        result['stream']['keepers'] = len(queue_keeper.queue_keepers())
+    if driver.is_on('service_joint_postman'):
+        from bitdust.stream import postman
+        result['stream']['streams'] = len(postman.streams())
     if driver.is_on('service_data_motion'):
         from bitdust.stream import io_throttle
         result['stream']['supplier_queues'] = len(io_throttle.throttle().ListSupplierQueues())
     return OK(result)
 
 
 def process_debug():
@@ -1045,20 +1043,18 @@
         key = strng.to_text(key).strip('/')
     except:
         return ERROR('wrong key')
     if not key:
         return ERROR('empty key')
     if _Debug:
         lg.out(_DebugLevel, 'api.config_get [%s]' % key)
-    if not config.conf().exist(key):
+    if not config.conf().registered(key):
         return ERROR('option %s does not exist' % key)
     if not config.conf().hasChilds(key):
-        return RESULT([
-            config.conf().toJson(key, include_info=include_info),
-        ])
+        return RESULT([config.conf().toJson(key, include_info=include_info)])
     known_childs = sorted(config.conf().listEntries(key))
     if key.startswith('services/') and key.count('/') == 1:
         svc_enabled_key = key + '/enabled'
         if svc_enabled_key in known_childs:
             known_childs.remove(svc_enabled_key)
             known_childs.insert(0, svc_enabled_key)
     childs = []
@@ -1081,19 +1077,22 @@
         curl -X POST 'localhost:8180/config/set/v1' -d '{"key": "logs/debug-level", "value": 12}'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "config_set", "kwargs": {"key": "logs/debug-level", "value": 12} }');
     """
     key = strng.to_text(key)
     v = {}
+    if not config.conf().registered(key):
+        return ERROR('option %s does not exist' % key)
     if config.conf().exist(key):
         v['old_value'] = config.conf().getValueOfType(key)
     typ_label = config.conf().getTypeLabel(key)
     if _Debug:
         lg.out(_DebugLevel, 'api.config_set [%s]=%s type is %s' % (key, value, typ_label))
+    # TODO: verify value against type of the field
     config.conf().setValueOfType(key, value)
     v.update(config.conf().toJson(key, include_info=False))
     return RESULT([
         v,
     ])
 
 
@@ -1106,15 +1105,15 @@
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "configs_list", "kwargs": {} }');
     """
     if _Debug:
         lg.out(_DebugLevel, 'api.configs_list')
     r = config.conf().cache()
-    r = [config.conf().toJson(key, include_info=include_info) for key in list(r.keys())]
+    r = [config.conf().toJson(key, include_info=include_info) for key in list(r.keys()) if config.conf().getType(key)]
     if sort:
         r = sorted(r, key=lambda i: i['key'])
     return RESULT(r)
 
 
 def configs_tree(include_info=False):
     """
@@ -1684,34 +1683,37 @@
     d.addErrback(lambda err: ret.callback(ERROR(err, api_method='key_audit')))
     return ret
 
 
 #------------------------------------------------------------------------------
 
 
-def files_sync():
+def files_sync(force=False):
     """
     This should re-start "data synchronization" process with your remote suppliers.
 
     Normally all communications and synchronizations are handled automatically, so you do not need to
     call that method.
 
-    This method is provided for testing and development purposes.
+    This method is provided for testing and development purposes only.
 
     ###### HTTP
         curl -X GET 'localhost:8180/file/sync/v1'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "files_sync", "kwargs": {} }');
     """
     if not driver.is_on('service_backups'):
         return ERROR('service_backups() is not started')
     if _Debug:
         lg.out(_DebugLevel, 'api.files_sync')
     from bitdust.storage import backup_monitor
+    if force:
+        from bitdust.customer import fire_hire
+        fire_hire.ForceRestart()
     backup_monitor.A('restart')
     if _Debug:
         lg.out(_DebugLevel, 'api.files_sync')
     return OK('the main files sync loop has been restarted')
 
 
 def files_list(remote_path=None, key_id=None, recursive=True, all_customers=False, include_uploads=False, include_downloads=False):
@@ -3292,31 +3294,31 @@
         curl -X GET 'localhost:8180/group/list/v1'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "groups_list", "kwargs": {} }');
     """
     if not driver.is_on('service_private_groups'):
         return ERROR('service_private_groups() is not started')
-    from bitdust.access import group_member
+    from bitdust.access import group_participant
     from bitdust.access import groups
     from bitdust.crypt import my_keys
     from bitdust.userid import global_id
     from bitdust.userid import my_id
     results = []
     if only_active:
-        for group_key_id in group_member.list_active_group_members():
+        for group_key_id in group_participant.list_active_group_participants():
             _glob_id = global_id.ParseGlobalID(group_key_id)
             to_be_listed = False
             if include_mine and _glob_id['idurl'] == my_id.getIDURL():
                 to_be_listed = True
             if include_granted and _glob_id['idurl'] != my_id.getIDURL():
                 to_be_listed = True
             if not to_be_listed:
                 continue
-            the_group = group_member.get_active_group_member(group_key_id)
+            the_group = group_participant.get_active_group_participant(group_key_id)
             if not the_group:
                 lg.warn('group %s was not found' % group_key_id)
                 continue
             results.append(the_group.to_json())
         return RESULT(results)
     for group_key_id in my_keys.known_keys():
         if not group_key_id.startswith('group_'):
@@ -3335,23 +3337,23 @@
             'alias': group_key_alias,
             'label': my_keys.get_label(group_key_id) or '',
             'active': False,
         }
         result.update({
             'group_key_info': my_keys.get_key_info(group_key_id),
         })
-        this_group_member = group_member.get_active_group_member(group_key_id)
-        if this_group_member:
-            result.update(this_group_member.to_json())
+        this_group_participant = group_participant.get_active_group_participant(group_key_id)
+        if this_group_participant:
+            result.update(this_group_participant.to_json())
             results.append(result)
             continue
         offline_group_info = groups.active_groups().get(group_key_id)
         if offline_group_info:
             result.update(offline_group_info)
-            result['state'] = 'OFFLINE'
+            result['state'] = 'DISCONNECTED'
             results.append(result)
             continue
         stored_group_info = groups.read_group_info(group_key_id)
         if stored_group_info:
             result.update(stored_group_info)
             result['state'] = 'CLOSED'
             results.append(result)
@@ -3411,15 +3413,15 @@
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "group_info", "kwargs": {"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com"} }');
     """
     if not driver.is_on('service_private_groups'):
         return ERROR('service_private_groups() is not started')
     from bitdust.access import groups
-    from bitdust.access import group_member
+    from bitdust.access import group_participant
     from bitdust.crypt import my_keys
     group_key_id = strng.to_text(group_key_id)
     if not group_key_id.startswith('group_'):
         return ERROR('invalid group id')
     group_key_id = my_keys.latest_key_id(group_key_id)
     response = {
         'group_key_id': group_key_id,
@@ -3429,22 +3431,22 @@
         'active': False,
     }
     if not my_keys.is_key_registered(group_key_id):
         return ERROR('group key %s was not found' % group_key_id)
     response.update({
         'group_key_info': my_keys.get_key_info(group_key_id),
     })
-    this_group_member = group_member.get_active_group_member(group_key_id)
-    if this_group_member:
-        response.update(this_group_member.to_json())
+    this_group_participant = group_participant.get_active_group_participant(group_key_id)
+    if this_group_participant:
+        response.update(this_group_participant.to_json())
         return OK(response)
     offline_group_info = groups.active_groups().get(group_key_id)
     if offline_group_info:
         response.update(offline_group_info)
-        response['state'] = 'OFFLINE'
+        response['state'] = 'DISCONNECTED'
         return OK(response)
     stored_group_info = groups.read_group_info(group_key_id)
     if stored_group_info:
         response.update(stored_group_info)
         response['state'] = 'CLOSED'
         return OK(response)
     response['state'] = 'CLEANED'
@@ -3506,77 +3508,71 @@
         return ERROR('invalid group id')
     from bitdust.crypt import my_keys
     from bitdust.userid import id_url
     group_key_id = my_keys.latest_key_id(group_key_id)
     if not my_keys.is_key_registered(group_key_id):
         return ERROR('group key is not registered')
     ret = Deferred()
-    started_group_members = []
-    existing_group_members = []
+    started_group_participants = []
+    existing_group_participants = []
     creator_idurl = my_keys.get_creator_idurl(group_key_id, as_field=False)
 
-    def _on_group_member_state_changed(oldstate, newstate, event_string, *args, **kwargs):
+    def _on_group_participant_state_changed(oldstate, newstate, event_string, *args, **kwargs):
         if _Debug:
             lg.args(_DebugLevel, oldstate=oldstate, newstate=newstate, event_string=event_string)
-        if newstate == 'IN_SYNC!' and oldstate != newstate:
-            if existing_group_members:
-                existing_group_members[0].removeStateChangedCallback(_on_group_member_state_changed)
-                ret.callback(OK(existing_group_members[0].to_json(), message='group is refreshed', api_method='group_join'))
+        if newstate == 'CONNECTED' and oldstate != newstate:
+            if existing_group_participants:
+                existing_group_participants[0].removeStateChangedCallback(_on_group_participant_state_changed)
+                ret.callback(OK(existing_group_participants[0].to_json(), message='group is refreshed', api_method='group_join'))
             else:
-                started_group_members[0].removeStateChangedCallback(_on_group_member_state_changed)
-                ret.callback(OK(started_group_members[0].to_json(), message='group is connected', api_method='group_join'))
+                started_group_participants[0].removeStateChangedCallback(_on_group_participant_state_changed)
+                ret.callback(OK(started_group_participants[0].to_json(), message='group is connected', api_method='group_join'))
         if newstate == 'DISCONNECTED' and oldstate != newstate and oldstate != 'AT_STARTUP':
-            if existing_group_members:
-                existing_group_members[0].removeStateChangedCallback(_on_group_member_state_changed)
-                ret.callback(ERROR('group is disconnected', details=existing_group_members[0].to_json(), api_method='group_join'))
+            if existing_group_participants:
+                existing_group_participants[0].removeStateChangedCallback(_on_group_participant_state_changed)
+                ret.callback(ERROR('group is disconnected', details=existing_group_participants[0].to_json(), api_method='group_join'))
             else:
-                started_group_members[0].removeStateChangedCallback(_on_group_member_state_changed)
-                ret.callback(ERROR('group is disconnected', details=started_group_members[0].to_json(), api_method='group_join'))
+                started_group_participants[0].removeStateChangedCallback(_on_group_participant_state_changed)
+                ret.callback(ERROR('group is disconnected', details=started_group_participants[0].to_json(), api_method='group_join'))
         return None
 
-    def _do_start_group_member():
-        from bitdust.access import group_member
-        existing_group_member = group_member.get_active_group_member(group_key_id)
+    def _do_start_group_participant():
+        from bitdust.access import group_participant
+        existing_group_participant = group_participant.get_active_group_participant(group_key_id)
         if _Debug:
-            lg.args(_DebugLevel, existing_group_member=existing_group_member)
-        if existing_group_member:
-            existing_group_members.append(existing_group_member)
+            lg.args(_DebugLevel, existing_group_participant=existing_group_participant)
+        if existing_group_participant:
+            existing_group_participants.append(existing_group_participant)
         else:
-            existing_group_member = group_member.GroupMember(
+            existing_group_participant = group_participant.GroupParticipant(
                 group_key_id=group_key_id,
                 publish_events=publish_events,
-                use_dht_cache=use_dht_cache,
             )
-            started_group_members.append(existing_group_member)
-        if existing_group_member.state in [
-            'DHT_READ?',
-            'BROKERS?',
-            'QUEUE?',
-            'IN_SYNC!',
-        ]:
-            connecting_word = 'active' if existing_group_member.state == 'IN_SYNC!' else 'connecting'
-            ret.callback(OK(existing_group_member.to_json(), message='group is already %s' % connecting_word, api_method='group_join'))
+            started_group_participants.append(existing_group_participant)
+        if existing_group_participant.state in ['SUPPLIERS?', 'SUBSCRIBE!', 'CONNECTED']:
+            connecting_word = 'active' if existing_group_participant.state == 'CONNECTED' else 'connecting'
+            ret.callback(OK(existing_group_participant.to_json(), message='group is already %s' % connecting_word, api_method='group_join'))
             return None
         if wait_result:
-            existing_group_member.addStateChangedCallback(_on_group_member_state_changed)
-        if started_group_members:
-            started_group_members[0].automat('init')
-        existing_group_member.automat('join')
+            existing_group_participant.addStateChangedCallback(_on_group_participant_state_changed)
+        if started_group_participants:
+            started_group_participants[0].automat('init')
+        existing_group_participant.automat('reconnect')
         if not wait_result:
-            ret.callback(OK(existing_group_member.to_json(), message='group connection started', api_method='group_join'))
+            ret.callback(OK(existing_group_participant.to_json(), message='group connection started', api_method='group_join'))
         return None
 
     def _do_cache_creator_idurl():
         from bitdust.contacts import identitycache
         d = identitycache.immediatelyCaching(creator_idurl)
         d.addErrback(lambda *args: ret.callback(ERROR('failed caching group creator identity')) and None)
-        d.addCallback(lambda *args: _do_start_group_member())
+        d.addCallback(lambda *args: _do_start_group_participant())
 
     if id_url.is_cached(creator_idurl):
-        _do_start_group_member()
+        _do_start_group_participant()
     else:
         _do_cache_creator_idurl()
     return ret
 
 
 def group_leave(group_key_id, erase_key=False):
     """
@@ -3586,63 +3582,63 @@
         curl -X DELETE 'localhost:8180/group/leave/v1' -d '{"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com", "erase_key": 1}'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "group_leave", "kwargs": {"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com", "erase_key": 1} }');
     """
     if not driver.is_on('service_private_groups'):
         return ERROR('service_private_groups() is not started')
-    from bitdust.access import group_member
+    from bitdust.access import group_participant
     from bitdust.access import groups
     from bitdust.crypt import my_keys
     group_key_id = strng.to_text(group_key_id)
     if not group_key_id.startswith('group_'):
         return ERROR('invalid group id')
     group_key_id = my_keys.latest_key_id(group_key_id)
     if not my_keys.is_key_registered(group_key_id):
         return ERROR('unknown group key')
-    this_group_member = group_member.get_active_group_member(group_key_id)
-    if not this_group_member:
+    this_group_participant = group_participant.get_active_group_participant(group_key_id)
+    if not this_group_participant:
         if erase_key:
             groups.erase_group_info(group_key_id)
             my_keys.erase_key(group_key_id)
             return OK(message='group deleted')
         groups.set_group_active(group_key_id, False)
         groups.save_group_info(group_key_id)
         return OK(message='group deactivated')
-    result_json = this_group_member.to_json()
+    result_json = this_group_participant.to_json()
     result_json['state'] = 'CLOSED'
-    this_group_member.event('leave', erase_key=erase_key)
+    this_group_participant.event('disconnect', erase_key=erase_key)
     if erase_key:
         return OK(message='group deactivated and deleted', result=result_json)
     return OK(message='group deactivated', result=result_json)
 
 
 def group_reconnect(group_key_id, use_dht_cache=False):
     """
     Refreshing given messaging group - disconnect from the group first and then join again.
-    Helpful method to reconnect with the message brokers effectively.
+    Helpful method to reconnect with the group suppliers effectively.
 
     ###### HTTP
         curl -X PUT 'localhost:8180/group/reconnect/v1' -d '{"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com"}'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "group_reconnect", "kwargs": {"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com"} }');
     """
     if not driver.is_on('service_private_groups'):
         return ERROR('service_private_groups() is not started')
-    from bitdust.access import group_member
+    from bitdust.access import group_participant
     from bitdust.crypt import my_keys
     group_key_id = strng.to_text(group_key_id)
     if not group_key_id.startswith('group_'):
         return ERROR('invalid group id')
     group_key_id = my_keys.latest_key_id(group_key_id)
     if not my_keys.is_key_registered(group_key_id):
         return ERROR('unknown group key')
     ret = Deferred()
-    d = group_member.restart_active_group_member(group_key_id, use_dht_cache=use_dht_cache)
+    d = group_participant.restart_active_group_participant(group_key_id)
     if not d:
         return ERROR('group is not active at the moment')
     d.addCallback(lambda resp: ret.callback(OK(resp, api_method='group_reconnect')))
     d.addErrback(lambda err: ret.callback(ERROR(err, api_method='group_reconnect')))
     return ret
 
 
@@ -3710,31 +3706,31 @@
         websocket.send('{"command": "api_call", "method": "friends_list", "kwargs": {} }');
     """
     from bitdust.contacts import contactsdb
     from bitdust.userid import global_id
     result = []
     for idurl, alias in contactsdb.correspondents():
         glob_id = global_id.ParseIDURL(idurl)
-        contact_status = 'offline'
+        # contact_status = 'offline'
         contact_state = 'OFFLINE'
         friend = {
             'idurl': idurl,
             'global_id': glob_id['customer'],
             'idhost': glob_id['idhost'],
             'username': glob_id['user'],
             'alias': alias,
-            'contact_status': contact_status,
+            # 'contact_status': contact_status,
             'contact_state': contact_state,
         }
         if driver.is_on('service_identity_propagate'):
             from bitdust.p2p import online_status
             state_machine_inst = online_status.getInstance(idurl, autocreate=False)
             if state_machine_inst:
                 friend.update(state_machine_inst.to_json())
-                friend['contact_status'] = online_status.stateToLabel(state_machine_inst.state)
+                # friend['contact_status'] = online_status.stateToLabel(state_machine_inst.state)
                 friend['contact_state'] = state_machine_inst.state
         result.append(friend)
     return RESULT(result)
 
 
 def friend_add(trusted_user_id, alias='', share_person_key=True):
     """
@@ -3916,15 +3912,15 @@
     idurl = id_url.field(idurl)
     if not online_status.isKnown(idurl):
         return ERROR('unknown user')
     # state_machine_inst = contact_status.getInstance(idurl)
     # if not state_machine_inst:
     #     return ERROR('error fetching user status')
     return OK({
-        'contact_status': online_status.getStatusLabel(idurl),
+        # 'contact_status': online_status.getStatusLabel(idurl),
         'contact_state': online_status.getCurrentState(idurl),
         'idurl': idurl,
         'global_id': global_id.UrlToGlobalID(idurl),
     })
 
 
 def user_status_check(user_id, timeout=None):
@@ -3956,15 +3952,15 @@
     ping_result = Deferred()
     ping_result.addCallback(
         lambda resp: ret.callback(OK(
             dict(
                 idurl=idurl,
                 global_id=global_id.UrlToGlobalID(idurl),
                 contact_state=peer_status.state,
-                contact_status=online_status.stateToLabel(peer_status.state),
+                # contact_status=online_status.stateToLabel(peer_status.state),
             ),
             api_method='user_status_check',
         ))
     )
     ping_result.addErrback(lg.errback, debug=_Debug, debug_level=_DebugLevel, method='api.user_status_check')
     ping_result.addErrback(lambda err: ret.errback(err))
     peer_status.automat('ping-now', ping_result, channel=None, ack_timeout=timeout, ping_retries=0)
@@ -4137,24 +4133,22 @@
         recipient_glob_id = global_id.ParseGlobalID(recipient_id)
         if not recipient_glob_id['idurl']:
             return ERROR('wrong recipient_id')
         recipient_id = global_id.MakeGlobalID(**recipient_glob_id)
         if not my_keys.is_valid_key_id(recipient_id):
             return ERROR('invalid recipient_id: %s' % recipient_id)
     bidirectional = False
-    if message_type in [
-        None,
-        'private_message',
-    ]:
+    if message_type in [None, 'private_message']:
         bidirectional = True
         if sender_id is None:
             sender_id = my_id.getGlobalID(key_alias='master')
     if sender_id:
         sender_local_key_id = my_keys.get_local_key_id(sender_id)
         if sender_local_key_id is None:
+            lg.warn('local key id for sender %s was not registered' % sender_id)
             return RESULT([])
     if recipient_id:
         recipient_local_key_id = my_keys.get_local_key_id(recipient_id)
         if recipient_local_key_id is None:
             lg.warn('local key id for recipient %s was not registered' % recipient_id)
             return RESULT([])
     messages = [{
@@ -4235,14 +4229,16 @@
     glob_id = global_id.ParseGlobalID(recipient_id)
     if not glob_id['idurl']:
         return ERROR('wrong recipient')
     target_glob_id = global_id.MakeGlobalID(**glob_id)
     if not my_keys.is_valid_key_id(target_glob_id):
         return ERROR('invalid key_id: %s' % target_glob_id)
     if recipient_id.startswith('person$'):
+        return ERROR('method is not implemented yet')
+        # TODO: to be implemented
         if not driver.is_on('service_personal_messages'):
             return ERROR('service_personal_messages() is not started')
         if _Debug:
             lg.out(_DebugLevel, 'api.message_send to %r via message_producer' % recipient_id)
         from bitdust.stream import message_producer
         ret = Deferred()
         result = message_producer.push_message(recipient_id, data)
@@ -4284,33 +4280,31 @@
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "message_send_group", "kwargs": {"group_key_id": "group_95d0fedc46308e2254477fcb96364af9$alice@server-a.com", "data": {"message": "Hola Amigos!"}} }');
     """
     if not driver.is_on('service_private_groups'):
         return ERROR('service_private_groups() is not started')
     from bitdust.userid import global_id
     from bitdust.crypt import my_keys
-    from bitdust.access import group_member
+    from bitdust.access import group_participant
     if not group_key_id.startswith('group_'):
         return ERROR('invalid group id')
     group_key_id = my_keys.latest_key_id(group_key_id)
     glob_id = global_id.ParseGlobalID(group_key_id)
     if not glob_id['idurl']:
         return ERROR('wrong group id')
     if not my_keys.is_key_registered(group_key_id):
         return ERROR('unknown group key')
-    this_group_member = group_member.get_active_group_member(group_key_id)
-    if not this_group_member:
+    this_group_participant = group_participant.get_active_group_participant(group_key_id)
+    if not this_group_participant:
         return ERROR('group is not active')
-    if this_group_member.state not in [
-        'IN_SYNC!',
-    ]:
+    if this_group_participant.state != 'CONNECTED':
         return ERROR('group is not synchronized yet')
     if _Debug:
         lg.out(_DebugLevel, 'api.message_send_group to %r' % group_key_id)
-    this_group_member.automat('push-message', json_payload=data)
+    this_group_participant.automat('push-message', json_payload=data, fast=True)
     return OK(message='group message sent')
 
 
 # def message_send_broadcast(payload):
 #     """
 #     Sends broadcast message to all peers in the network.
 #
@@ -4449,63 +4443,65 @@
     from bitdust.contacts import contactsdb
     from bitdust.customer import supplier_connector
     from bitdust.p2p import online_status
     from bitdust.lib import misc
     from bitdust.userid import my_id
     from bitdust.userid import id_url
     from bitdust.userid import global_id
-    from bitdust.storage import backup_matrix
+    # from bitdust.storage import backup_matrix
     customer_idurl = strng.to_bin(customer_id)
     if not customer_idurl:
         customer_idurl = my_id.getIDURL().to_bin()
     else:
         if global_id.IsValidGlobalUser(customer_id):
             customer_idurl = global_id.GlobalUserToIDURL(customer_id, as_field=False)
     customer_idurl = id_url.field(customer_idurl)
     results = []
-    for (
-        pos,
-        supplier_idurl,
-    ) in enumerate(contactsdb.suppliers(customer_idurl)):
+    for pos, supplier_idurl in enumerate(contactsdb.suppliers(customer_idurl)):
         if not supplier_idurl:
             r = {
                 'position': pos,
                 'idurl': '',
                 'global_id': '',
                 'supplier_state': None,
                 'connected': None,
-                'contact_status': 'offline',
+                # 'contact_status': 'offline',
                 'contact_state': 'OFFLINE',
             }
             results.append(r)
             continue
+        sc = None
+        if supplier_connector.is_supplier(supplier_idurl, customer_idurl):
+            sc = supplier_connector.by_idurl(supplier_idurl, customer_idurl)
         r = {
             'position': pos,
             'idurl': supplier_idurl,
             'global_id': global_id.UrlToGlobalID(supplier_idurl),
-            'supplier_state': None if not supplier_connector.is_supplier(supplier_idurl, customer_idurl) else supplier_connector.by_idurl(supplier_idurl, customer_idurl).state,
+            'supplier_state': None if not sc else sc.state,
             'connected': misc.readSupplierData(supplier_idurl, 'connected', customer_idurl),
-            'contact_status': 'offline',
+            # 'contact_status': 'offline',
             'contact_state': 'OFFLINE',
         }
         if online_status.isKnown(supplier_idurl):
-            r['contact_status'] = online_status.getStatusLabel(supplier_idurl)
+            # r['contact_status'] = online_status.getStatusLabel(supplier_idurl)
             r['contact_state'] = online_status.getCurrentState(supplier_idurl)
         # if contact_status.isKnown(supplier_idurl):
         #     cur_state = contact_status.getInstance(supplier_idurl).state
         #     r['contact_status'] = contact_status.stateToLabel(cur_state)
         #     r['contact_state'] = cur_state
         if verbose:
-            _files, _total, _report = backup_matrix.GetSupplierStats(pos, customer_idurl=customer_idurl)
-            r['listfiles'] = misc.readSupplierData(supplier_idurl, 'listfiles', customer_idurl)
-            r['fragments'] = {
-                'items': _files,
-                'files': _total,
-                'details': _report,
-            }
+            # TODO: create separate api method for that: api.supplier_list_files()
+            # _files, _total, _report = backup_matrix.GetSupplierStats(pos, customer_idurl=customer_idurl)
+            # r['listfiles'] = misc.readSupplierData(supplier_idurl, 'listfiles', customer_idurl).split('\n')
+            # r['fragments'] = {
+            #     'items': _files,
+            #     'files': _total,
+            #     'details': _report,
+            # }
+            r['contract'] = None if not sc else sc.storage_contract
         results.append(r)
     return RESULT(results)
 
 
 def supplier_change(position=None, supplier_id=None, new_supplier_id=None):
     """
     The method will execute a fire/hire process for given supplier. You can specify which supplier to be replaced by position or ID.
@@ -4539,30 +4535,29 @@
     if not supplier_idurl or not contactsdb.is_supplier(supplier_idurl, customer_idurl=customer_idurl):
         return ERROR('supplier was not found')
     new_supplier_idurl = new_supplier_id
     if new_supplier_id is not None:
         if global_id.IsValidGlobalUser(new_supplier_id):
             new_supplier_idurl = global_id.GlobalUserToIDURL(new_supplier_id, as_field=False)
         new_supplier_idurl = strng.to_bin(new_supplier_idurl)
-
         if contactsdb.is_supplier(new_supplier_idurl, customer_idurl=customer_idurl):
             return ERROR('user %s is already a known supplier' % new_supplier_idurl)
     ret = Deferred()
 
     def _do_change(x):
         from bitdust.customer import fire_hire
         from bitdust.customer import supplier_finder
         if new_supplier_idurl is not None:
             supplier_finder.InsertSupplierToHire(new_supplier_idurl)
         fire_hire.AddSupplierToFire(supplier_idurl)
         fire_hire.A('restart')
         if new_supplier_idurl is not None:
-            ret.callback(OK(message='supplier %s will be replaced by %s' % (supplier_idurl, new_supplier_idurl), api_method='supplier_change'))
+            ret.callback(OK(message='supplier %s will be replaced by %s' % (strng.to_text(supplier_idurl), strng.to_text(new_supplier_idurl)), api_method='supplier_change'))
         else:
-            ret.callback(OK(message='supplier %s will be replaced by a randomly selected user' % supplier_idurl, api_method='supplier_change'))
+            ret.callback(OK(message='supplier %s will be replaced by a randomly selected user' % strng.to_text(supplier_idurl), api_method='supplier_change'))
         return None
 
     if new_supplier_id is None:
         _do_change(None)
         return ret
     from bitdust.p2p import online_status
     d = online_status.handshake(
@@ -4638,45 +4633,52 @@
     """
     if not driver.is_on('service_supplier'):
         return ERROR('service_supplier() is not started')
     service_customer_support_on = False
     if driver.is_on('service_customer_support'):
         service_customer_support_on = True
         from bitdust.supplier import customer_assistant
+    service_supplier_contracts_on = False
+    if driver.is_on('service_supplier_contracts'):
+        service_supplier_contracts_on = True
+        from bitdust.supplier import storage_contract
     from bitdust.contacts import contactsdb
     from bitdust.p2p import online_status
     from bitdust.userid import global_id
     results = []
     for pos, customer_idurl in enumerate(contactsdb.customers()):
         if not customer_idurl:
             r = {
                 'position': pos,
                 'global_id': '',
                 'idurl': '',
-                'contact_status': 'offline',
+                # 'contact_status': 'offline',
                 'contact_state': 'OFFLINE',
-                'customer_assistant_state': 'OFFLINE',
+                # 'customer_assistant_state': 'OFFLINE',
             }
             results.append(r)
             continue
         r = {
             'position': pos,
             'global_id': global_id.UrlToGlobalID(customer_idurl),
             'idurl': customer_idurl,
-            'contact_status': 'offline',
+            # 'contact_status': 'offline',
             'contact_state': 'OFFLINE',
-            'customer_assistant_state': 'OFFLINE',
+            # 'customer_assistant_state': 'OFFLINE',
         }
         if online_status.isKnown(customer_idurl):
-            r['contact_status'] = online_status.getStatusLabel(customer_idurl)
+            # r['contact_status'] = online_status.getStatusLabel(customer_idurl)
             r['contact_state'] = online_status.getCurrentState(customer_idurl)
-        if service_customer_support_on:
-            assistant = customer_assistant.by_idurl(customer_idurl)
-            if assistant:
-                r['customer_assistant_state'] = assistant.state
+        if verbose:
+            if service_customer_support_on:
+                assistant = customer_assistant.by_idurl(customer_idurl)
+                if assistant:
+                    r['customer_assistant_state'] = assistant.state
+            if service_supplier_contracts_on:
+                r['contract'] = storage_contract.get_current_customer_contract(customer_idurl)
         results.append(r)
     return RESULT(results)
 
 
 def customer_reject(customer_id, erase_customer_key=True):
     """
     Stop supporting given customer, remove all related files from local disc, close connections with that node.
@@ -4813,36 +4815,42 @@
         lg.out(_DebugLevel, 'api.space_local finished')
     return OK(result)
 
 
 #------------------------------------------------------------------------------
 
 
-def services_list(with_configs=False):
+def services_list(with_configs=False, as_tree=False):
     """
     Returns detailed info about all currently running network services.
 
     Pass `with_configs=True` to also see current program settings values related to each service.
 
     This is a very useful method when you need to investigate a problem in the software.
 
     ###### HTTP
         curl -X GET 'localhost:8180/service/list/v1?with_configs=1'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "services_list", "kwargs": {"with_configs": 1} }');
     """
     result = []
-    for _, svc in sorted(list(driver.services().items()), key=lambda i: i[0]):
+    if as_tree:
+        ordered = sorted(list(driver.services().items()), key=lambda i: driver.root_distance(i[0]))
+    else:
+        ordered = sorted(list(driver.services().items()), key=lambda i: i[0])
+    for svc_name, svc in ordered:
         svc_info = svc.to_json()
         if with_configs:
             svc_configs = []
             for child in config.conf().listEntries(svc.config_path.replace('/enabled', '')):
                 svc_configs.append(config.conf().toJson(child, include_info=False))
             svc_info['configs'] = svc_configs
+        if as_tree:
+            svc_info['root_distance'] = driver.root_distance(svc_name)
         result.append(svc_info)
     if _Debug:
         lg.out(_DebugLevel, 'api.services_list responded with %d items' % len(result))
     return RESULT(result)
 
 
 def service_info(service_name):
@@ -5363,43 +5371,53 @@
         curl -X GET 'localhost:8180/queue/keeper/list/v1'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "queue_keepers_list", "kwargs": {} }');
     """
     if not driver.is_on('service_message_broker'):
         return ERROR('service_message_broker() is not started')
-    from bitdust.stream import queue_keeper
-    return RESULT([qk.to_json() for qk in queue_keeper.queue_keepers().values()])
+    return RESULT([])
 
 
 def queue_peddlers_list():
     """
     Returns list of all registered message peddlers.
 
     ###### HTTP
         curl -X GET 'localhost:8180/queue/peddler/list/v1'
 
     ###### WebSocket
         websocket.send('{"command": "api_call", "method": "queue_peddlers_list", "kwargs": {} }');
     """
     if not driver.is_on('service_message_broker'):
         return ERROR('service_message_broker() is not started')
-    from bitdust.stream import message_peddler
+    return RESULT([])
+
+
+def queue_streams_list():
+    """
+    Returns list of all registered message peddlers.
+
+    ###### HTTP
+        curl -X GET 'localhost:8180/queue/stream/list/v1'
+
+    ###### WebSocket
+        websocket.send('{"command": "api_call", "method": "queue_streams_list", "kwargs": {} }');
+    """
+    if not driver.is_on('service_joint_postman'):
+        return ERROR('service_joint_postman() is not started')
+    from bitdust.stream import postman
     return RESULT(
-        [
-            {
-                'queue_id': queue_id,
-                'active': mp['active'],
-                'consumers': list(mp['consumers'].keys()),
-                'producers': list(mp['producers'].keys()),
-                'messages': len(mp['messages']),
-                'archive': len(mp['archive']),
-                'sequence_id': mp['last_sequence_id'],
-            } for queue_id, mp in message_peddler.streams().items()
-        ]
+        [{
+            'queue_id': queue_id,
+            'active': mp['active'],
+            'consumers': list(mp['consumers'].keys()),
+            'producers': list(mp['producers'].keys()),
+            'sequence_id': mp['last_sequence_id'],
+        } for queue_id, mp in postman.streams().items()]
     )
 
 
 #------------------------------------------------------------------------------
 
 
 def events_list():
@@ -5784,14 +5802,162 @@
     from bitdust.dht import dht_service
     return RESULT(dht_service.dump_local_db(value_as_json=True))
 
 
 #------------------------------------------------------------------------------
 
 
+def blockchain_info():
+    """
+    Returns details and brief info about current status of blockchain services.
+
+    ###### HTTP
+        curl -X GET 'localhost:8180/blockchain/info/v1'
+
+    ###### WebSocket
+        websocket.send('{"command": "api_call", "method": "blockchain_info", "kwargs": {} }');
+    """
+    if not driver.is_on('service_bismuth_blockchain'):
+        return ERROR('service_bismuth_blockchain() is not started')
+    ret = {}
+    if driver.is_on('service_bismuth_pool'):
+        from bitdust.blockchain import bismuth_pool
+        ret['mining_pool'] = {
+            'address': bismuth_pool.address,
+            'connected_node': '{}:{}'.format(bismuth_pool.node_ip, bismuth_pool.node_port) if bismuth_pool.node_ip else None,
+            'difficulty': bismuth_pool.new_diff,
+        }
+    if driver.is_on('service_bismuth_node'):
+        from bitdust.blockchain import bismuth_node
+        ret['node'] = {
+            'app_version': bismuth_node.nod().app_version,
+            'protocol_version': bismuth_node.nod().version,
+            'port': bismuth_node.nod().port,
+            'difficulty': bismuth_node.nod().difficulty[0],
+            'blocks': bismuth_node.nod().hdd_block,
+            'last_block': bismuth_node.nod().last_block,
+            'last_block_ago': bismuth_node.nod().last_block_ago,
+            'port': bismuth_node.nod().port,
+            'uptime': int(time.time() - bismuth_node.nod().startup_time),
+            'address': bismuth_node.nod().keys.address,
+            'connections': bismuth_node.nod().peers.consensus_size,
+            'connections_list': bismuth_node.nod().peers.peer_opinion_dict,
+            'consensus': bismuth_node.nod().peers.consensus,
+            'consensus_percent': bismuth_node.nod().peers.consensus_percentage,
+        }
+    if driver.is_on('service_bismuth_wallet'):
+        from bitdust.blockchain import bismuth_wallet
+        cur_balance = bismuth_wallet.my_balance()
+        ret['wallet'] = {
+            'balance': cur_balance,
+            'address': bismuth_wallet.my_wallet_address(),
+        }
+    if driver.is_on('service_bismuth_miner'):
+        from bitdust.blockchain import bismuth_miner
+        ret['miner'] = {
+            'address': bismuth_miner._MinerWalletAddress,
+            'name': bismuth_miner._MinerName,
+            'connected_mining_pool': '{}:{}'.format(bismuth_miner._MiningPoolHost, bismuth_miner._MiningPoolPort) if bismuth_miner._MiningPoolHost else None,
+        }
+    return OK(ret)
+
+
+def blockchain_wallet_balance():
+    """
+    Returns current balance of your blockchain wallet.
+
+    ###### HTTP
+        curl -X GET 'localhost:8180/blockchain/wallet/balance/v1'
+
+    ###### WebSocket
+        websocket.send('{"command": "api_call", "method": "blockchain_wallet_balance", "kwargs": {} }');
+    """
+    if not driver.is_on('service_bismuth_wallet'):
+        return ERROR('service_bismuth_wallet() is not started')
+    from bitdust.blockchain import bismuth_wallet
+    cur_balance = bismuth_wallet.my_balance()
+    return OK({
+        'balance': cur_balance,
+        'address': bismuth_wallet.my_wallet_address(),
+    })
+
+
+def blockchain_transaction_send(recipient, amount, operation='', data=''):
+    """
+    Prepare and sign blockchain transaction and then send it to one of known blockchain nodes.
+
+    ###### HTTP
+        curl -X POST 'localhost:8180/blockchain/transaction/send/v1' -d '{"recipient": "abcd...", "amount": "12.3456"}'
+
+    ###### WebSocket
+        websocket.send('{"command": "api_call", "method": "blockchain_transaction_send", "kwargs": {"recipient": "abcd...", "amount": "12.3456"} }');
+    """
+    if not driver.is_on('service_bismuth_wallet'):
+        return ERROR('service_bismuth_wallet() is not started')
+    try:
+        amount = float(amount)
+    except:
+        return ERROR(errors=['amount must be a number'])
+    from bitdust.blockchain import bismuth_wallet
+    result = bismuth_wallet.send_transaction(recipient, amount, operation, data)
+    if result and not isinstance(result, list):
+        return OK({
+            'transaction_id': result,
+        })
+    return ERROR(errors=result)
+
+
+def blockchain_block_produce():
+    """
+    Will trigger minining one time to produce a single empty block in the blockchain.
+    This way foundation miners can initially generate enough coins to be able to sell those coins to customers.
+
+    This method only make sense to use by foundation miners.
+    If you are not part of the foundation and your wallet address is not on the list, your transaction will be rejected by other nodes.
+
+    ###### HTTP
+        curl -X GET 'localhost:8180/blockchain/block/produce/v1'
+
+    ###### WebSocket
+        websocket.send('{"command": "api_call", "method": "blockchain_block_produce", "kwargs": {} }');
+    """
+    if not driver.is_on('service_bismuth_miner'):
+        return ERROR('service_bismuth_miner() is not started')
+    from bitdust.blockchain import bismuth_miner
+    bismuth_miner._WantMoreCoins = True
+    bismuth_miner._MiningIsOn = False
+    return OK()
+
+
+#------------------------------------------------------------------------------
+
+
+def billing_info():
+    return ERROR('method is not implemented yet')
+
+
+def billing_offers_list():
+    return ERROR('method is not implemented yet')
+
+
+def billing_offer_create():
+    return ERROR('method is not implemented yet')
+
+
+def billing_bid_create():
+    return ERROR('method is not implemented yet')
+
+
+def billing_bid_accept():
+    return ERROR('method is not implemented yet')
+
+
+#------------------------------------------------------------------------------
+
+
 def automats_list():
     """
     Returns a list of all currently running state machines.
 
     This is a very useful method when you need to investigate a problem in the software.
 
     ###### HTTP
```

### Comparing `bitdust-0.1.8.234/bitdust/interface/api_rest_http_server.py` & `bitdust-0.1.9.241/bitdust/interface/api_rest_http_server.py`

 * *Files 4% similar despite different names*

```diff
@@ -270,25 +270,27 @@
     return value
 
 
 #------------------------------------------------------------------------------
 
 
 class BitDustAPISite(Site):
+
     def buildProtocol(self, addr):
         """
         Only accepting connections from local machine!
         """
         if addr.host != '127.0.0.1':
             lg.err('refused connection from remote host: %r' % addr.host)
             return None
         return Site.buildProtocol(self, addr)
 
 
 class BitDustRESTHTTPServer(JsonAPIResource):
+
     """
     A set of API method to interract and control locally running BitDust process.
     """
 
     #------------------------------------------------------------------------------
 
     def getChild(self, name, request):
@@ -654,15 +656,15 @@
 
     #------------------------------------------------------------------------------
 
     @GET('^/f/s$')
     @GET('^/v1/file/sync$')
     @GET('^/file/sync/v1$')
     def file_sync_v1(self, request):
-        return api.files_sync()
+        return api.files_sync(force=bool(_request_arg(request, 'force', '0') in ['1', 'true']), )
 
     @GET('^/f/l$')
     @GET('^/v1/file/list$')
     @GET('^/file/list/v1$')
     def file_list_v1(self, request):
         return api.files_list(
             remote_path=_request_arg(request, 'remote_path', None),
@@ -1019,27 +1021,27 @@
         return api.user_observe(
             nickname=_request_arg(request, 'nickname', mandatory=True),
             attempts=int(_request_arg(request, 'attempts', 3)),
         )
 
     #------------------------------------------------------------------------------
 
-    @GET('^/msg/h?')
+    @GET('^/msg/h$')
     @GET('^/v1/message/history$')
     @GET('^/message/history/v1$')
     def message_history_v1(self, request):
         return api.message_history(
             recipient_id=_request_arg(request, 'id', None, True),
             sender_id=_request_arg(request, 'sender_id', None, False),
             message_type=_request_arg(request, 'message_type', 'private_message'),
             offset=int(_request_arg(request, 'offset', '0')),
             limit=int(_request_arg(request, 'limit', '100')),
         )
 
-    @GET('^/msg/c?')
+    @GET('^/msg/c$')
     @GET('^/v1/message/conversation$')
     @GET('^/message/conversation/v1$')
     def message_conversation_v1(self, request):
         return api.message_conversations_list(
             message_types=list(filter(None,
                                       _request_arg(request, 'message_types', '').split(','))),
             offset=int(_request_arg(request, 'offset', '0')),
@@ -1284,14 +1286,20 @@
 
     @GET('^/qu/ped/l$')
     @GET('^/v1/queue/peddler/list$')
     @GET('^/queue/peddler/list/v1$')
     def queue_peddler_list_v1(self, request):
         return api.queue_peddlers_list()
 
+    @GET('^/qu/s/l$')
+    @GET('^/v1/queue/stream/list$')
+    @GET('^/queue/stream/list/v1$')
+    def queue_stream_list_v1(self, request):
+        return api.queue_streams_list()
+
     #------------------------------------------------------------------------------
 
     @GET('^/ev/l$')
     @GET('^/v1/event/list$')
     @GET('^/event/list/v1$')
     def event_list_v1(self, request):
         return api.events_list()
@@ -1355,14 +1363,46 @@
     @GET('^/v1/dht/db/dump$')
     @GET('^/dht/db/dump/v1$')
     def dht_db_dump_v1(self, request):
         return api.dht_local_db_dump()
 
     #------------------------------------------------------------------------------
 
+    @GET('^/b/i$')
+    @GET('^/v1/blockchain/info$')
+    @GET('^/blockchain/info/v1$')
+    def blockchain_info(self, request):
+        return api.blockchain_info()
+
+    @GET('^/b/w/b$')
+    @GET('^/v1/blockchain/wallet/balance$')
+    @GET('^/blockchain/wallet/balance/v1$')
+    def blockchain_wallet_balance(self, request):
+        return api.blockchain_wallet_balance()
+
+    @POST('^/b/t/s$')
+    @POST('^/v1/blockchain/transaction/send$')
+    @POST('^/blockchain/transaction/send/v1$')
+    def blockchain_transaction_send(self, request):
+        data = _request_data(request, mandatory_keys=['recipient', 'amount'])
+        return api.blockchain_transaction_send(
+            recipient=data['recipient'],
+            amount=data['amount'],
+            operation=data.get('operation', '') or '',
+            data=data.get('data', '') or '',
+        )
+
+    @GET('^/b/b/p$')
+    @GET('^/v1/blockchain/block/produce$')
+    @GET('^/blockchain/block/produce/v1$')
+    def blockchain_block_produce(self, request):
+        return api.blockchain_block_produce()
+
+    #------------------------------------------------------------------------------
+
     @GET('^/st/l$')
     @GET('^/v1/state/list$')
     @GET('^/v1/automat/list$')
     @GET('^/state/list/v1$')
     @GET('^/automat/list/v1$')
     def automat_list_v1(self, request):
         return api.automats_list()
```

### Comparing `bitdust-0.1.8.234/bitdust/interface/api_web_socket.py` & `bitdust-0.1.9.241/bitdust/interface/api_web_socket.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/interface/cmd_line_json.py` & `bitdust-0.1.9.241/bitdust/interface/cmd_line_json.py`

 * *Files 0% similar despite different names*

```diff
@@ -764,14 +764,15 @@
                 'succeed',
                 'sys',
                 'strng',
                 'map',
                 'jsn',
                 'json',
                 'gc',
+                'config',
             ]:
                 continue
             method = getattr(api, item, None)
             if not method:
                 continue
             try:
                 params = inspect.getargspec(method)
@@ -1123,14 +1124,28 @@
                 r['num_depends'] = len(r['depends'])
                 result['result'][i] = r
             return result
 
         tpl = jsontemplate.Template(templ.TPL_SERVICES)
         return call_websocket_method_transform_template_and_stop('services_list', tpl, _services_update)
 
+    if len(args) == 2 and args[1] in ['tree', 'tr']:
+
+        def _services_update(result):
+            for i in range(len(result['result'])):
+                r = result['result'][i]
+                r['enabled_label'] = 'ENABLED' if r['enabled'] else 'DISABLED'
+                r['depends'] = ', '.join(r['depends']) if r['depends'] else 'no dependencies'
+                r['offset'] = '| '*r['root_distance']
+                result['result'][i] = r
+            return result
+
+        tpl = jsontemplate.Template(templ.TPL_SERVICES_TREE)
+        return call_websocket_method_transform_template_and_stop('services_list', tpl, _services_update, as_tree=True)
+
     if len(args) >= 3 and args[1] in ['start', 'enable', 'on']:
         tpl = jsontemplate.Template(templ.TPL_RAW)
         return call_websocket_method_template_and_stop('service_start', tpl, service_name=args[2])
 
     if len(args) >= 3 and args[1] in ['stop', 'disable', 'off']:
         tpl = jsontemplate.Template(templ.TPL_RAW)
         return call_websocket_method_template_and_stop('service_stop', tpl, service_name=args[2])
```

### Comparing `bitdust-0.1.8.234/bitdust/interface/cmd_line_json_templates.py` & `bitdust-0.1.9.241/bitdust/interface/cmd_line_json_templates.py`

 * *Files 4% similar despite different names*

```diff
@@ -131,15 +131,17 @@
 
 #------------------------------------------------------------------------------
 
 TPL_AUTOMATS = tpl_4_items.format(tpl_status, tpl_execution, ls('{index}: {id}({state}) {.section timers}   timers: {@}{.end}\n'), tpl_errors)
 
 #------------------------------------------------------------------------------
 
-TPL_SERVICES = tpl_4_items.format(tpl_status, tpl_execution, ls('{index}: {name}({state}) {enabled_label}, {num_depends} depends\n'), tpl_errors)
+TPL_SERVICES = tpl_4_items.format(tpl_status, tpl_execution, ls('{index}: {name}({state}) {enabled_label}, with {num_depends} dependencies\n'), tpl_errors)
+
+TPL_SERVICES_TREE = tpl_4_items.format(tpl_status, tpl_execution, ls('{offset}{name}({state}) {enabled_label} [{depends}]\n'), tpl_errors)
 
 TPL_SERVICE_INFO = tpl_4_items.format(
     tpl_status,
     tpl_execution,
     ls("""ID: {index}
 name: {name}
 state: {state}
```

### Comparing `bitdust-0.1.8.234/bitdust/interface/ftp_server.py` & `bitdust-0.1.9.241/bitdust/interface/ftp_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/__init__.py` & `bitdust-0.1.9.241/bitdust/lib/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/diskspace.py` & `bitdust-0.1.9.241/bitdust/lib/diskspace.py`

 * *Files 4% similar despite different names*

```diff
@@ -176,16 +176,20 @@
     return _SuffixLabels
 
 
 def SameSuffix(suf1, suf2):
     """
     Compare 2 unit labels.
 
-    Return True if both are same unit: from diskspace import *
-    SameSuffix('b','bytes') True
+    Return True if both are same unit:
+
+    from diskspace import SameSuffix
+
+    SameSuffix('b','bytes')
+    True
     """
     global _Suffixes
     if not SuffixIsCorrect(suf1):
         return False
     if not SuffixIsCorrect(suf2):
         return False
     return _Suffixes[suf1] == _Suffixes[suf2]
@@ -202,15 +206,18 @@
     return str(value) + ' ' + suf
 
 
 def SplitString(s):
     """
     Return tuple (<number>, <suffix>) or (None, None).
 
-    from diskspace import * SplitString("342.67Mb") (342.67, 'Mb')
+    from diskspace import SplitString
+
+    SplitString("342.67Mb")
+    (342.67, 'Mb')
     """
     num = s.rstrip('bytesBYTESgmkGMK ')
     suf = s.lstrip('0123456789., ').strip()
     try:
         num = float(num)
     except:
         return (None, None)
@@ -225,17 +232,21 @@
 
 
 def MakeStringFromBytes(value):
     """
     Make a correct string value with best units measure from given number of
     bytes.
 
-    from diskspace import *     MakeStringFromBytes(123456)     '120.56
-    KB'     MakeStringFromBytes(123.456789)     '123 bytes' I think this
-    is most used method here.
+    from diskspace import MakeStringFromBytes
+
+    MakeStringFromBytes(123456)
+    '120.56KB'
+
+    MakeStringFromBytes(123.456789)
+    '123 bytes'
     """
     try:
         v = float(value)
     except:
         return value
     if v > _Suffixes['GB']:
         res = round(v/_Suffixes['GB'], 2)
@@ -253,28 +264,34 @@
 
 
 def GetBytesFromString(s, default=None):
     """
     Convert a string to a value in bytes, this is reverse method for
     MakeStringFromBytes.
 
-    from diskspace import * GetBytesFromString("123.456 Mb") 129452998
+    from diskspace import GetBytesFromString
+
+    GetBytesFromString("123.456 Mb")
+    129452998
     """
     num, suf = SplitString(s)
     if num is None:
         return default
     return int(num*_Suffixes[suf])
 
 
 def MakeStringWithSuffix(s, suffix):
     """
     You can move strings from one unit measure to another.
 
-    Convert input string to a string with given suffix.     from
-    diskspace import *     MakeStringWithSuffix("12.345 Mb", "Kb")
+    Convert input string to a string with given suffix.
+
+    from diskspace import MakeStringWithSuffix
+
+    MakeStringWithSuffix("12.345 Mb", "Kb")
     '12641.28 Kb'
     """
     b = GetBytesFromString(s)
     if b is None:
         return s
     if not SuffixIsCorrect(suffix):
         return s
```

### Comparing `bitdust-0.1.8.234/bitdust/lib/getsizeof.py` & `bitdust-0.1.9.241/bitdust/lib/getsizeof.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/jsn.py` & `bitdust-0.1.9.241/bitdust/lib/jsn.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/jsontemplate.py` & `bitdust-0.1.9.241/bitdust/lib/jsontemplate.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/maths.py` & `bitdust-0.1.9.241/bitdust/lib/maths.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/misc.py` & `bitdust-0.1.9.241/bitdust/lib/misc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/nameurl.py` & `bitdust-0.1.9.241/bitdust/lib/nameurl.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/net_misc.py` & `bitdust-0.1.9.241/bitdust/lib/net_misc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/packetid.py` & `bitdust-0.1.9.241/bitdust/lib/packetid.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/schedule.py` & `bitdust-0.1.9.241/bitdust/lib/schedule.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/serialization.py` & `bitdust-0.1.9.241/bitdust/lib/serialization.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/strng.py` & `bitdust-0.1.9.241/bitdust/lib/strng.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/txws.py` & `bitdust-0.1.9.241/bitdust/lib/txws.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/udp.py` & `bitdust-0.1.9.241/bitdust/lib/udp.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/lib/websock.py` & `bitdust-0.1.9.241/bitdust/lib/websock.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/logs/__init__.py` & `bitdust-0.1.9.241/bitdust/logs/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/logs/lg.py` & `bitdust-0.1.9.241/bitdust/logs/lg.py`

 * *Files 5% similar despite different names*

```diff
@@ -38,14 +38,15 @@
 import six
 import os
 import sys
 import time
 import datetime
 import threading
 import traceback
+import logging
 import platform
 from io import open
 
 #------------------------------------------------------------------------------
 
 _GlobalDebugLevel = 0
 _LogLinesCounter = 0
@@ -106,20 +107,26 @@
     global _LogsEnabled
     global _UseColors
     global _GlobalDebugLevel
     global _AllLogFiles
     s = msg
     s_ = s
     level = _DebugLevel
+    if not level:
+        level = 0
     if level < 0:
         level = 0
     if level % 2:
         level -= 1
     if level:
-        s = ' '*level + s
+        lstr = s.lstrip()
+        if lstr.startswith('INFO') or lstr.startswith('DEBUG') or lstr.startswith('DEBUG') or lstr.startswith('WARNING') or lstr.startswith('ERROR'):
+            s = '  ' + lstr
+        else:
+            s = ' '*level + s
     if _IsAndroid is None:
         _IsAndroid = (sys.executable == 'android_python' or ('ANDROID_ARGUMENT' in os.environ or 'ANDROID_ROOT' in os.environ))
     if (_ShowTime and level > 0) or showtime:
         tm_string = time.strftime('%H:%M:%S')
         if _LifeBeginsTime != 0:
             dt = time.time() - _LifeBeginsTime
             mn = dt // 60
@@ -485,39 +492,52 @@
     """
     Returns currently set debug level.
     """
     global _GlobalDebugLevel
     return _GlobalDebugLevel
 
 
-def get_loging_level(level):
+def get_loging_level(level, return_name=False):
     """
     Find corresponding logging level related to BitDust log level:
 
         0 : CRITICAL
         1-2 : FATAL
         3-4 : ERROR
         5-6 : WARNING
         7-8 : INFO
         9-10 : DEBUG
         11... : NOTSET
     """
-    import logging
     if level == 0:
+        if return_name:
+            return 'CRITICAL'
         return logging.CRITICAL
     if level <= 2:
+        if return_name:
+            return 'FATAL'
         return logging.FATAL
     if level <= 4:
+        if return_name:
+            return 'ERROR'
         return logging.ERROR
     if level <= 6:
+        if return_name:
+            return 'WARNING'
         return logging.WARNING
     if level <= 8:
+        if return_name:
+            return 'INFO'
         return logging.INFO
     if level <= 10:
+        if return_name:
+            return 'DEBUG'
         return logging.DEBUG
+    if return_name:
+        return 'NOTSET'
     return logging.NOTSET
 
 
 def life_begins():
     """
     Start counting time in the logs from that moment.
```

### Comparing `bitdust-0.1.8.234/bitdust/logs/measure_it.py` & `bitdust-0.1.9.241/bitdust/logs/measure_it.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/logs/memdebug.py` & `bitdust-0.1.9.241/bitdust/logs/memdebug.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/logs/weblog.py` & `bitdust-0.1.9.241/bitdust/logs/weblog.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/logs/webtraffic.py` & `bitdust-0.1.9.241/bitdust/logs/webtraffic.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/__init__.py` & `bitdust-0.1.9.241/bitdust/main/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/bpmain.py` & `bitdust-0.1.9.241/bitdust/main/bpmain.py`

 * *Files 2% similar despite different names*

```diff
@@ -695,28 +695,38 @@
         _AppDataDir = appdata
 
     if _Debug:
         print_text('_AppDataDir: %s' % _AppDataDir)
         print_text('default_base_dir_portable(): %s' % deploy.default_base_dir_portable())
 
     #---BitDust Home
-    deploy.init_base_dir(base_dir=_AppDataDir)
+    try:
+        result_app_dir = deploy.init_base_dir(base_dir=_AppDataDir)
+    except Exception as e:
+        print_text('failed to initialize application data folder: %e' % e)
+        return 1
+
+    if _Debug:
+        print_text('app data dir prepared in %s' % result_app_dir)
 
     from bitdust.logs import lg
 
     #---init IO module
     from bitdust.system import bpio
     bpio.init()
 
     appList = bpio.find_main_process(pid_file_path=os.path.join(appdata, 'processid'))
 
     if bpio.Android():
-        lg.close_intercepted_log_file()
         from android.storage import app_storage_path  # @UnresolvedImport
-        lg.open_intercepted_log_file(os.path.join(app_storage_path(), '.bitdust', 'logs', 'android.log'))
+        android_log_file = os.path.join(app_storage_path(), '.bitdust', 'logs', 'android.log')
+        if _Debug:
+            print_text('redirecting log output to %s' % android_log_file)
+        lg.close_intercepted_log_file()
+        lg.open_intercepted_log_file(android_log_file)
 
     # sys.excepthook = lg.exception_hook
 
     #---init logging
     from twisted.internet.defer import setDebugging
     if _Debug:
         if bpio.isFrozen():
```

### Comparing `bitdust-0.1.8.234/bitdust/main/bptester.py` & `bitdust-0.1.9.241/bitdust/main/bptester.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/config.py` & `bitdust-0.1.9.241/bitdust/main/config.py`

 * *Files 3% similar despite different names*

```diff
@@ -100,14 +100,17 @@
 
     def getConfigDir(self):
         return self.configDir
 
     def exist(self, entryPath):
         return self._get(entryPath) is not None
 
+    def registered(self, entryPath):
+        return self._exists(entryPath)
+
     def remove(self, entryPath):
         elemList = self._parseEntryPath(entryPath)
         fpath = os.path.join(self.configDir, *elemList)
         return self._rmrf(fpath)
 
     def listEntries(self, entryPath):
         entries = self._get(entryPath)
@@ -159,40 +162,52 @@
         try:
             s = str(s).strip().strip('"')
             return int(s)
         except ValueError:
             return default
 
     def setInt(self, entryPath, value):
-        return self._set(entryPath, str(value))
+        return self._set(entryPath, str(int(value)))
+
+    def getFloat(self, entryPath, default=None):
+        s = self.getData(entryPath)
+        if s is None:
+            return default
+        try:
+            s = str(s).strip().strip('"')
+            return float(s)
+        except ValueError:
+            return default
+
+    def setFloat(self, entryPath, value):
+        return self._set(entryPath, str(float(value)))
 
     def getBool(self, entryPath, default=None):
         data = self.getData(entryPath)
         if data is None:
             return default
         return True if str(data).strip() in [
             'True',
             'true',
             '1',
             'on',
         ] else False
 
     def setBool(self, entryPath, value):
-        return self._set(entryPath, 'true' if value else 'false')
+        return self._set(entryPath, 'true' if bool(value) else 'false')
 
-    def getString(self, entryPath, default=None):
+    def getString(self, entryPath, default=''):
         data = self.getData(entryPath)
         if data is None:
             return default
         data = str(data).strip()
         if len(data) < 2:
             return default
-        if not (data[0] == data[-1] == '"'):
-            return default
-        data = data[1:-1]
+        if data[0] == data[-1] == '"':
+            data = data[1:-1]
         try:
             out = []
             i = 0
             while i < len(data):
                 c = data[i]
                 if c == '\\':
                     out.append(data[i + 1])
@@ -202,15 +217,15 @@
                     i += 1
             return ''.join(out)
         except IndexError:
             return default
 
     def setString(self, entryPath, value):
         out = ['"']
-        for x in value:
+        for x in str(value):
             if x in '\\"':
                 out.append('\\')
             out.append(x)
         out.append('"')
         return self._set(entryPath, ''.join(out))
 
     def _mkdir(self, dpath):
@@ -269,14 +284,23 @@
         if elemList and (not elemList[0]):
             del elemList[0]
         if elemList:
             assert elemList[-1]
         self._validateElemList(elemList)
         return elemList
 
+    def _exists(self, entryPath):
+        elemList = self._parseEntryPath(entryPath)
+        fpath = os.path.join(self.configDir, *elemList)
+        if os.path.isdir(fpath):
+            return True
+        elif os.path.isfile(fpath):
+            return True
+        return False
+
     def _get(self, entryPath):
         elemList = self._parseEntryPath(entryPath)
         fpath = os.path.join(self.configDir, *elemList)
         if os.path.isdir(fpath):
             out = []
             for x in self._listdir(fpath):
                 childPath = '/'.join(elemList + [x])
@@ -378,27 +402,26 @@
         return result
 
 
 #------------------------------------------------------------------------------
 
 
 class FixedTypesConfig(NotifiableConfig):
+    # TODO: verify value against type of the field when populating every option
+
     def __init__(self, configDir):
         super(FixedTypesConfig, self).__init__(configDir)
         try:
             from bitdust.main import config_types
             self._types = config_types.defaults()
             self._labels = config_types.labels()
         except:
             self._types = {}
             self._labels = {}
 
-    def types(self):
-        return
-
     def listKnownTypes(self):
         return list(self._types.keys())
 
     def setType(self, key, typ):
         self._types[key] = typ
 
     def getType(self, entryPath):
@@ -415,14 +438,17 @@
         if typ in [
             config_types.TYPE_STRING,
             config_types.TYPE_TEXT,
             config_types.TYPE_UNDEFINED,
             config_types.TYPE_PASSWORD,
             config_types.TYPE_INTEGER,
             config_types.TYPE_BOOLEAN,
+            config_types.TYPE_FLOATING_POINT,
+            config_types.TYPE_POSITIVE_FLOATING_POINT,
+            config_types.TYPE_NON_ZERO_POSITIVE_FLOATING_POINT,
         ]:
             return {}
         if typ == config_types.TYPE_POSITIVE_INTEGER:
             return {
                 'min': 0,
             }
         if typ == config_types.TYPE_PORT_NUMBER:
@@ -446,99 +472,107 @@
                 return {
                     'possible_values': eccmap.SuppliersNumbers(),
                 }
             else:
                 raise TypeError('unexpected option type for %r' % entryPath)
         return {}
 
-    def getValueOfType(self, entryPath):
+    def getValueOfType(self, entryPath, default=None):
         from bitdust.main import config_types
         typ = self.getType(entryPath)
         value = None
         if not typ or typ in [
             config_types.TYPE_STRING,
             config_types.TYPE_TEXT,
             config_types.TYPE_UNDEFINED,
         ]:
-            value = self.getData(entryPath)
+            value = self.getString(entryPath, default=default)
         elif typ in [
             config_types.TYPE_BOOLEAN,
         ]:
-            value = self.getBool(entryPath)
+            value = self.getBool(entryPath, default=default)
         elif typ in [
             config_types.TYPE_INTEGER,
             config_types.TYPE_POSITIVE_INTEGER,
             config_types.TYPE_NON_ZERO_POSITIVE_INTEGER,
             config_types.TYPE_PORT_NUMBER,
         ]:
-            value = self.getInt(entryPath)
+            value = self.getInt(entryPath, default=default)
         elif typ in [
             config_types.TYPE_FOLDER_PATH,
             config_types.TYPE_FILE_PATH,
             config_types.TYPE_PASSWORD,
         ]:
-            value = self.getString(entryPath) or ''
+            value = self.getString(entryPath, default=default) or ''
             if typ in [
                 config_types.TYPE_FOLDER_PATH,
             ]:
                 if value:
                     from bitdust.system import bpio
                     if bpio.Windows():
                         if not value.endswith(u'/') and not value.endswith(u'\\'):
                             value = value + u'\\'
                     elif not value.endswith(u'/'):
                         value = value + u'/'
         elif typ == config_types.TYPE_COMBO_BOX:
             if entryPath == 'services/customer/suppliers-number':
-                value = self.getInt(entryPath)
+                value = self.getInt(entryPath, default=default)
             else:
                 raise TypeError('unexpected option type for %r' % entryPath)
+        elif typ in [
+            config_types.TYPE_FLOATING_POINT,
+            config_types.TYPE_POSITIVE_FLOATING_POINT,
+            config_types.TYPE_NON_ZERO_POSITIVE_FLOATING_POINT,
+        ]:
+            value = self.getFloat(entryPath, default=default)
         else:
-            value = self.getData(entryPath)
+            value = self.getData(entryPath, default=default)
         return value
 
     def setValueOfType(self, entryPath, value):
         from bitdust.main import config_types
         typ = self.getType(entryPath)
         if not typ or typ in [
             config_types.TYPE_STRING,
             config_types.TYPE_TEXT,
             config_types.TYPE_UNDEFINED,
         ]:
-            self.setData(entryPath, strng.text_type(value))
+            self.setString(entryPath, strng.text_type(value))
         elif typ in [
             config_types.TYPE_BOOLEAN,
         ]:
             if strng.is_string(value):
-                vl = strng.to_text(value).strip().lower() in [
-                    'true',
-                    '1',
-                    'on',
-                ]
+                vl = strng.to_text(value).strip().lower() in ['true', '1', 'on']
             else:
                 vl = bool(value)
             self.setBool(entryPath, vl)
         elif typ in [
             config_types.TYPE_INTEGER,
             config_types.TYPE_POSITIVE_INTEGER,
             config_types.TYPE_NON_ZERO_POSITIVE_INTEGER,
             config_types.TYPE_PORT_NUMBER,
         ]:
-            self.setInt(entryPath, int(value))
+            self.setInt(entryPath, value)
         elif typ in [
             config_types.TYPE_FOLDER_PATH,
             config_types.TYPE_FILE_PATH,
             config_types.TYPE_PASSWORD,
         ]:
             self.setString(entryPath, value)
         elif typ == config_types.TYPE_COMBO_BOX:
             if entryPath == 'services/customer/suppliers-number':
                 value = self.setInt(entryPath, int(value))
             else:
                 raise TypeError('unexpected option type for %r' % entryPath)
+        elif typ in [
+            config_types.TYPE_FLOATING_POINT,
+            config_types.TYPE_POSITIVE_FLOATING_POINT,
+            config_types.TYPE_NON_ZERO_POSITIVE_FLOATING_POINT,
+        ]:
+            self.setFloat(entryPath, value)
         else:
             self.setData(entryPath, strng.text_type(value))
         return True
 
 
 #------------------------------------------------------------------------------
```

### Comparing `bitdust-0.1.8.234/bitdust/main/config_defaults.py` & `bitdust-0.1.9.241/bitdust/main/config_defaults.py`

 * *Files 1% similar despite different names*

```diff
@@ -81,23 +81,40 @@
     conf_obj.setDefaultValue('services/backups/enabled', 'true')
     conf_obj.setDefaultValue('services/backups/block-size', diskspace.MakeStringFromBytes(settings.DefaultBackupBlockSize()))
     conf_obj.setDefaultValue('services/backups/max-block-size', diskspace.MakeStringFromBytes(settings.DefaultBackupMaxBlockSize()))
     conf_obj.setDefaultValue('services/backups/max-copies', '2')
     conf_obj.setDefaultValue('services/backups/keep-local-copies-enabled', 'true')
     conf_obj.setDefaultValue('services/backups/wait-suppliers-enabled', 'true')
 
-    conf_obj.setDefaultValue('services/blockchain/enabled', 'false')
-    conf_obj.setDefaultValue('services/blockchain/host', '127.0.0.1')
-    conf_obj.setDefaultValue('services/blockchain/port', 9100)
-    conf_obj.setDefaultValue('services/blockchain/seeds', '')
-    conf_obj.setDefaultValue('services/blockchain/explorer/enabled', 'true')
-    conf_obj.setDefaultValue('services/blockchain/explorer/port', 9180)
-    conf_obj.setDefaultValue('services/blockchain/wallet/enabled', 'true')
-    conf_obj.setDefaultValue('services/blockchain/wallet/port', 9280)
-    conf_obj.setDefaultValue('services/blockchain/miner/enabled', 'false')
+    conf_obj.setDefaultValue('services/blockchain-id/enabled', 'false')
+
+    conf_obj.setDefaultValue('services/blockchain-authority/enabled', 'false')
+    conf_obj.setDefaultValue('services/blockchain-authority/registration-bonus-coins', 100)
+    conf_obj.setDefaultValue('services/blockchain-authority/requests-reading-offset', 0)
+    conf_obj.setDefaultValue('services/blockchain-authority/requests-reading-limit', 50)
+
+    conf_obj.setDefaultValue('services/blockchain-explorer/enabled', 'false')
+    conf_obj.setDefaultValue('services/blockchain-explorer/host', '127.0.0.1')
+    conf_obj.setDefaultValue('services/blockchain-explorer/web-port', 19080)
+
+    conf_obj.setDefaultValue('services/bismuth-blockchain/enabled', 'false')
+
+    conf_obj.setDefaultValue('services/bismuth-node/enabled', 'false')
+    conf_obj.setDefaultValue('services/bismuth-node/host', '127.0.0.1')
+    conf_obj.setDefaultValue('services/bismuth-node/tcp-port', 15658)
+
+    conf_obj.setDefaultValue('services/bismuth-wallet/enabled', 'false')
+
+    conf_obj.setDefaultValue('services/bismuth-pool/enabled', 'false')
+    conf_obj.setDefaultValue('services/bismuth-pool/host', '127.0.0.1')
+    conf_obj.setDefaultValue('services/bismuth-pool/tcp-port', 18525)
+
+    conf_obj.setDefaultValue('services/bismuth-miner/enabled', 'false')
+
+    conf_obj.setDefaultValue('services/bismuth-identity/enabled', 'false')
 
     conf_obj.setDefaultValue('services/broadcasting/enabled', 'false')
     conf_obj.setDefaultValue('services/broadcasting/routing-enabled', 'false')
     conf_obj.setDefaultValue('services/broadcasting/max-broadcast-connections', '3')
 
     conf_obj.setDefaultValue('services/contract-chain/enabled', 'false')
 
@@ -149,14 +166,16 @@
     conf_obj.setDefaultValue('services/identity-propagate/known-servers', '')
     conf_obj.setDefaultValue('services/identity-propagate/preferred-servers', '')
     conf_obj.setDefaultValue('services/identity-propagate/min-servers', 2)
     conf_obj.setDefaultValue('services/identity-propagate/max-servers', 5)
     conf_obj.setDefaultValue('services/identity-propagate/automatic-rotate-enabled', 'true')
     conf_obj.setDefaultValue('services/identity-propagate/health-check-interval-seconds', 60*5)
 
+    conf_obj.setDefaultValue('services/joint-postman/enabled', 'true')
+
     conf_obj.setDefaultValue('services/ip-port-responder/enabled', 'true')
 
     conf_obj.setDefaultValue('services/keys-registry/enabled', 'true')
 
     conf_obj.setDefaultValue('services/keys-storage/enabled', 'true')
     conf_obj.setDefaultValue('services/keys-storage/reset-unreliable-backup-copies', 'true')
 
@@ -225,14 +244,16 @@
 
     conf_obj.setDefaultValue('services/shared-data/enabled', 'true')
 
     conf_obj.setDefaultValue('services/supplier/enabled', 'true')
     conf_obj.setDefaultValue('services/supplier/donated-space', diskspace.MakeStringFromBytes(settings.DefaultDonatedBytes()))
 
     conf_obj.setDefaultValue('services/supplier-contracts/enabled', 'false')
+    conf_obj.setDefaultValue('services/supplier-contracts/initial-duration-hours', 6)
+    conf_obj.setDefaultValue('services/supplier-contracts/duration-raise-factor', 2.0)
 
     conf_obj.setDefaultValue('services/tcp-connections/enabled', 'true')
     conf_obj.setDefaultValue('services/tcp-connections/tcp-port', settings.DefaultTCPPort())
     conf_obj.setDefaultValue('services/tcp-connections/upnp-enabled', 'true')
 
     conf_obj.setDefaultValue('services/tcp-transport/enabled', 'true')
     conf_obj.setDefaultValue('services/tcp-transport/receiving-enabled', 'true')
```

### Comparing `bitdust-0.1.8.234/bitdust/main/config_details.py` & `bitdust-0.1.9.241/bitdust/main/config_details.py`

 * *Files 10% similar despite different names*

```diff
@@ -116,31 +116,14 @@
 The oldest copies are removed automatically. A value of `0` indicates unlimited number of versions.
 
 {services/backups/wait-suppliers-enabled} extra check after 24 hours
 When critical amount of your suppliers become unreliable - your uploaded data is lost completely.
 Enable this option to wait for 24 hours after any file upload and perform an extra check of all suppliers before cleaning up the local copy.
 This is a compromise solution that does not sacrifice reliability but also decrease local storage consumption.
 
-{services/blockchain/enabled} enable blockchain
-The service is under development.
-
-{services/blockchain/host}
-
-{services/blockchain/port}
-
-{services/blockchain/explorer/enabled}
-
-{services/blockchain/explorer/port}
-
-{services/blockchain/wallet/enabled}
-
-{services/blockchain/wallet/port}
-
-{services/blockchain/miner/enabled}
-
 {services/broadcasting/enabled} send & receive encrypted broadcast messages
 The service is under development.
 
 {services/broadcasting/routing-enabled}
 
 {services/broadcasting/max-broadcast-connections}
 
@@ -163,15 +146,15 @@
 The service is under development.
 
 {services/customer-family/enabled} maintain service info for my customers
 When `supplier` service is enabled and started your device will also write additional service information to distributed hash table.
 This way people are able to access encrypted shared files of each other on different suppliers across the network.
 
 {services/customer-patrol/enabled} reject customers who are out of quota
-When you are running `supplier` service other people are able to store files on your device.
+When you are running `supplier` service other users are able to store files on your device.
 The `customer-patrol` service makes sure that your customers do not exceed requested and agreed storage quotas.
 
 {services/customer-patrol/customer-idle-days} customer idle limit
 This option enables few periodic checks and will auto-reject customers who are no longer using your device to store any data.
 Specify number of days of customer inactivity before user will be rejected and data erased automatically.
 A value of `0` disables the feature.
 
@@ -426,20 +409,20 @@
 
 {services/restores/enabled} enable data downloading
 Controls network connections and incoming data streams when downloading encrypted fragments from suppliers nodes.
 
 {services/shared-data/enabled} enable data sharing
 Makes possible decentralized sharing of encrypted files with other users.
 
-{services/supplier/enabled} donate own disk space to people
+{services/supplier/enabled} donate own disk space to other users
 To make it possible to store any files on the network, some other nodes must already be connected and provide storage space.
 The `supplier` service allocates a part of your disk and serves encrypted files uploaded to your device from remote nodes.
 
 {services/supplier/donated-space} donated space
-The amount of storage space you want to donate to other people who also use BitDust.
+The amount of storage space you want to donate to other users.
 
 {services/supplier-contracts/enabled} digitally signed supplier contracts
 The service is under development.
 
 {services/tcp-connections/enabled} TCP enabled
 This will allow BitDust to use the TCP protocol for service data and encrypted traffic
```

### Comparing `bitdust-0.1.8.234/bitdust/main/config_types.py` & `bitdust-0.1.9.241/bitdust/main/config_types.py`

 * *Files 16% similar despite different names*

```diff
@@ -38,14 +38,17 @@
 TYPE_NON_ZERO_POSITIVE_INTEGER = 6
 TYPE_FOLDER_PATH = 7
 TYPE_FILE_PATH = 8
 TYPE_COMBO_BOX = 9
 TYPE_PASSWORD = 10
 TYPE_DISK_SPACE = 11
 TYPE_PORT_NUMBER = 12
+TYPE_FLOATING_POINT = 13
+TYPE_POSITIVE_FLOATING_POINT = 14
+TYPE_NON_ZERO_POSITIVE_FLOATING_POINT = 15
 
 
 def labels():
     return {
         TYPE_UNDEFINED: 'undefined',
         TYPE_BOOLEAN: 'boolean',
         TYPE_STRING: 'string',
@@ -55,14 +58,17 @@
         TYPE_NON_ZERO_POSITIVE_INTEGER: 'non zero positive integer',
         TYPE_FOLDER_PATH: 'folder path',
         TYPE_FILE_PATH: 'file path',
         TYPE_COMBO_BOX: 'selection',
         TYPE_PASSWORD: 'password',
         TYPE_DISK_SPACE: 'disk space',
         TYPE_PORT_NUMBER: 'port number',
+        TYPE_FLOATING_POINT: 'floating point',
+        TYPE_POSITIVE_FLOATING_POINT: 'non negative floating point',
+        TYPE_NON_ZERO_POSITIVE_FLOATING_POINT: 'non zero positive floating point',
     }
 
 
 def defaults():
     return {
         'interface/api/auth-secret-enabled': TYPE_BOOLEAN,
         'interface/api/rest-http-enabled': TYPE_BOOLEAN,
@@ -86,31 +92,43 @@
 
         # 'other/upnp-at-startup': TYPE_BOOLEAN,
         'paths/backups': TYPE_FOLDER_PATH,
         'paths/customers': TYPE_FOLDER_PATH,
         'paths/messages': TYPE_FOLDER_PATH,
         'paths/receipts': TYPE_FOLDER_PATH,
         'paths/restore': TYPE_FOLDER_PATH,
-        'personal/private-key-size': TYPE_STRING,
+        'personal/private-key-size': TYPE_POSITIVE_INTEGER,
         'services/accountant/enabled': TYPE_BOOLEAN,
         'services/backup-db/enabled': TYPE_BOOLEAN,
         'services/backups/block-size': TYPE_DISK_SPACE,
         'services/backups/enabled': TYPE_BOOLEAN,
         'services/backups/keep-local-copies-enabled': TYPE_BOOLEAN,
         'services/backups/max-block-size': TYPE_DISK_SPACE,
         'services/backups/max-copies': TYPE_POSITIVE_INTEGER,
         'services/backups/wait-suppliers-enabled': TYPE_BOOLEAN,
-        'services/blockchain/enabled': TYPE_BOOLEAN,
-        'services/blockchain/host': TYPE_STRING,
-        'services/blockchain/port': TYPE_PORT_NUMBER,
-        'services/blockchain/explorer/enabled': TYPE_BOOLEAN,
-        'services/blockchain/explorer/port': TYPE_PORT_NUMBER,
-        'services/blockchain/wallet/enabled': TYPE_BOOLEAN,
-        'services/blockchain/wallet/port': TYPE_PORT_NUMBER,
-        'services/blockchain/miner/enabled': TYPE_BOOLEAN,
+        'services/blockchain-id/enabled': TYPE_BOOLEAN,
+        'services/blockchain-authority/enabled': TYPE_BOOLEAN,
+        'services/blockchain-authority/registration-bonus-coins': TYPE_POSITIVE_INTEGER,
+        'services/blockchain-authority/requests-reading-offset': TYPE_POSITIVE_INTEGER,
+        'services/blockchain-authority/requests-reading-limit': TYPE_NON_ZERO_POSITIVE_INTEGER,
+        'services/blockchain-explorer/enabled': TYPE_BOOLEAN,
+        'services/blockchain-explorer/host': TYPE_STRING,
+        'services/blockchain-explorer/web-port': TYPE_PORT_NUMBER,
+        'services/bismuth-blockchain/enabled': TYPE_BOOLEAN,
+        'services/bismuth-node/enabled': TYPE_BOOLEAN,
+        'services/bismuth-node/host': TYPE_STRING,
+        'services/bismuth-node/tcp-port': TYPE_PORT_NUMBER,
+        'services/bismuth-wallet/enabled': TYPE_BOOLEAN,
+        'services/bismuth-pool/enabled': TYPE_BOOLEAN,
+        'services/bismuth-pool/host': TYPE_STRING,
+        'services/bismuth-pool/tcp-port': TYPE_PORT_NUMBER,
+        'services/bismuth-miner/enabled': TYPE_BOOLEAN,
+        'services/bismuth-miner/pool-host': TYPE_STRING,
+        'services/bismuth-miner/pool-tcp-port': TYPE_PORT_NUMBER,
+        'services/bismuth-identity/enabled': TYPE_BOOLEAN,
         'services/broadcasting/enabled': TYPE_BOOLEAN,
         'services/broadcasting/routing-enabled': TYPE_BOOLEAN,
         'services/broadcasting/max-broadcast-connections': TYPE_NON_ZERO_POSITIVE_INTEGER,
         'services/contract-chain/enabled': TYPE_BOOLEAN,
         'services/customer/enabled': TYPE_BOOLEAN,
         'services/customer/needed-space': TYPE_DISK_SPACE,
         'services/customer/suppliers-number': TYPE_COMBO_BOX,
@@ -145,16 +163,16 @@
         'services/identity-propagate/enabled': TYPE_BOOLEAN,
         'services/identity-propagate/known-servers': TYPE_STRING,
         'services/identity-propagate/preferred-servers': TYPE_STRING,
         'services/identity-propagate/min-servers': TYPE_NON_ZERO_POSITIVE_INTEGER,
         'services/identity-propagate/max-servers': TYPE_NON_ZERO_POSITIVE_INTEGER,
         'services/identity-propagate/automatic-rotate-enabled': TYPE_BOOLEAN,
         'services/identity-propagate/health-check-interval-seconds': TYPE_POSITIVE_INTEGER,
-        'services/identity-server/enabled': TYPE_BOOLEAN,
         'services/ip-port-responder/enabled': TYPE_BOOLEAN,
+        'services/joint-postman/enabled': TYPE_BOOLEAN,
         'services/keys-registry/enabled': TYPE_BOOLEAN,
         'services/keys-storage/enabled': TYPE_BOOLEAN,
         'services/keys-storage/reset-unreliable-backup-copies': TYPE_BOOLEAN,
         'services/list-files/enabled': TYPE_BOOLEAN,
         'services/message-broker/enabled': TYPE_BOOLEAN,
         'services/message-broker/archive-chunk-size': TYPE_NON_ZERO_POSITIVE_INTEGER,
         'services/message-broker/message-ack-timeout': TYPE_NON_ZERO_POSITIVE_INTEGER,
@@ -195,14 +213,16 @@
         'services/proxy-transport/preferred-routers': TYPE_TEXT,  # 'services/proxy-transport/router-lifetime-seconds': TYPE_POSITIVE_INTEGER,
         'services/rebuilding/enabled': TYPE_BOOLEAN,
         'services/restores/enabled': TYPE_BOOLEAN,
         'services/shared-data/enabled': TYPE_BOOLEAN,
         'services/supplier/donated-space': TYPE_DISK_SPACE,
         'services/supplier/enabled': TYPE_BOOLEAN,
         'services/supplier-contracts/enabled': TYPE_BOOLEAN,
+        'services/supplier-contracts/initial-duration-hours': TYPE_NON_ZERO_POSITIVE_INTEGER,
+        'services/supplier-contracts/duration-raise-factor': TYPE_NON_ZERO_POSITIVE_FLOATING_POINT,
         'services/tcp-connections/enabled': TYPE_BOOLEAN,
         'services/tcp-connections/tcp-port': TYPE_PORT_NUMBER,
         'services/tcp-connections/upnp-enabled': TYPE_BOOLEAN,
         'services/tcp-transport/enabled': TYPE_BOOLEAN,
         'services/tcp-transport/receiving-enabled': TYPE_BOOLEAN,
         'services/tcp-transport/sending-enabled': TYPE_BOOLEAN,
         'services/tcp-transport/priority': TYPE_POSITIVE_INTEGER,
```

### Comparing `bitdust-0.1.8.234/bitdust/main/default_network.py` & `bitdust-0.1.9.241/bitdust/main/default_network.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,8 +1,30 @@
 def default_network_info(): return {
+  "service_bismuth_blockchain": {
+    "initial_difficulty": 10,
+    "genesis_address": "cc846806ba14b8ec5a042d254beeeb637ee91033fa0f84c66063e0a9",
+    "foundation_miners": [
+        "884dbabd8e214cf1ac80c0718d6c66fd9cdb7a28cfdd0d2bc3b053fe",
+        "d6d7e856b50ea783c388e17137eb789dd21a08295bbaa834a4b9b9ea"
+    ],
+    "known_nodes": [
+      {
+        "host": "p2p-id.ru",
+        "node_tcp_port": 15658,
+        "mining_pool_tcp_port": 18525,
+        "explorer_http_port": 19080
+      },
+      {
+        "host": "bahamas.ai",
+        "node_tcp_port": 15658,
+        "mining_pool_tcp_port": 18525,
+        "explorer_http_port": 19080
+      }
+    ]
+  },
   "service_entangled_dht": {
     "bucket_size": 4,
     "default_age": 43200,
     "known_nodes": [
       {
         "host": "p2p-id.ru",
         "udp_port": 14441
```

### Comparing `bitdust-0.1.8.234/bitdust/main/events.py` & `bitdust-0.1.9.241/bitdust/main/events.py`

 * *Files 0% similar despite different names*

```diff
@@ -102,15 +102,15 @@
 #------------------------------------------------------------------------------
 
 
 class Event(object):
     def __init__(self, event_id, data=None, created=None):
         self.event_id = event_id
         self.data = data
-        self.created = created or utime.get_sec1970()
+        self.created = created or utime.utcnow_to_sec1970()
 
     def __repr__(self):
         return '<Event({})>'.format(self.event_id)
 
 
 #------------------------------------------------------------------------------
```

### Comparing `bitdust-0.1.8.234/bitdust/main/help.py` & `bitdust-0.1.9.241/bitdust/main/help.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/initializer.py` & `bitdust-0.1.9.241/bitdust/main/initializer.py`

 * *Files 0% similar despite different names*

```diff
@@ -224,15 +224,21 @@
 
 def A(event=None, *args, **kwargs):
     """
     Access method to interact with the state machine.
     """
     global _Initializer
     if _Initializer is None:
-        _Initializer = Initializer('initializer', 'AT_STARTUP', 2, True)
+        _Initializer = Initializer(
+            name='initializer',
+            state='AT_STARTUP',
+            debug_level=_DebugLevel,
+            log_events=_Debug,
+            log_transitions=_Debug,
+        )
     if event is not None:
         if kwargs.get('use_reactor', True):
             _Initializer.automat(event, *args, **kwargs)
         else:
             _Initializer.event(event, *args, **kwargs)
     return _Initializer
```

### Comparing `bitdust-0.1.8.234/bitdust/main/install_wizard.py` & `bitdust-0.1.9.241/bitdust/main/install_wizard.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/installer.py` & `bitdust-0.1.9.241/bitdust/main/installer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/listeners.py` & `bitdust-0.1.9.241/bitdust/main/listeners.py`

 * *Files 1% similar despite different names*

```diff
@@ -79,33 +79,34 @@
     clear_listeners()
 
 
 #------------------------------------------------------------------------------
 
 
 class Snapshot(object):
+
     def __init__(self, model_name, snap_id=None, data=None, created=None, deleted=False):
         self.model_name = model_name
         self.snap_id = snap_id
         self.data = data
-        self.created = created or utime.get_sec1970()
+        self.created = created or utime.utcnow_to_sec1970()
         self.deleted = deleted
 
     def __repr__(self):
         return '[{}:{}{}>'.format(self.model_name, self.snap_id, ' DELETED' if self.deleted else '')
 
     def to_json(self):
         j = {
             'name': self.model_name,
             'id': self.snap_id,
             'data': self.data,
             'created': self.created,
         }
         if self.deleted:
-            j['deleted'] = utime.get_sec1970()
+            j['deleted'] = utime.utcnow_to_sec1970()
         return j
 
 
 #------------------------------------------------------------------------------
 
 
 def add_listener(listener_callback, model_name='*'):
@@ -215,9 +216,9 @@
             if stop:
                 _ModelsToBePopulated.remove(model_name)
                 if _Debug:
                     lg.args(_DebugLevel, model_name=model_name, stop=True)
     return _ModelsToBePopulated
 
 
-def is_populate_requered(model_name):
+def is_populate_required(model_name):
     return model_name in _ModelsToBePopulated
```

### Comparing `bitdust-0.1.8.234/bitdust/main/network_config.py` & `bitdust-0.1.9.241/bitdust/main/network_config.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/main/settings.py` & `bitdust-0.1.9.241/bitdust/main/settings.py`

 * *Files 0% similar despite different names*

```diff
@@ -445,15 +445,18 @@
 
 def P2PTimeOut():
     """
     A default timeout when sending and receiving packets.
     """
     global _P2PTimeOut
     if _P2PTimeOut is None:
-        _P2PTimeOut = config.conf().getInt('services/gateway/p2p-timeout', 15)
+        if config.conf():
+            _P2PTimeOut = config.conf().getInt('services/gateway/p2p-timeout', 15)
+        else:
+            _P2PTimeOut = 15
     return _P2PTimeOut
 
 
 def DefaultSendTimeOutEmail():
     """
     Timeout for email sending, not used.
     """
@@ -565,14 +568,23 @@
 def BackupDBSynchronizeDelay():
     """
     Save backup index database no more than one time per every 5 min.
     """
     return 60*5
 
 
+def SupplierContractBillingPeriodDays():
+    """
+    To prevent overhead on blockchain transactions, there is a limit.
+    To pay for storage, you can send only one transaction to any user per billing period.
+    So multiple contracts are paid at once.
+    """
+    return 30
+
+
 #------------------------------------------------------------------------------
 #---CONSTANTS ( STRINGS ) -----------------------------------------------------
 #------------------------------------------------------------------------------
 
 
 def ListFilesFormat():
     """
@@ -1379,19 +1391,19 @@
 def enableFTPServer(enable=None):
     if enable is None:
         return config.conf().getBool('interface/ftp/enabled')
     config.conf().setData('interface/ftp/enabled', str(enable))
 
 
 def getIdServerHost():
-    return config.conf().getData('services/identity-server/host').strip()
+    return config.conf().getString('services/identity-server/host').strip()
 
 
 def setIdServerHost(hostname_or_ip):
-    return config.conf().setData('services/identity-server/host', hostname_or_ip)
+    return config.conf().setString('services/identity-server/host', hostname_or_ip)
 
 
 def getIdServerWebPort():
     return config.conf().getInt('services/identity-server/web-port', IdentityWebPort())
 
 
 def setIdServerWebPort(web_port):
```

### Comparing `bitdust-0.1.8.234/bitdust/main/shutdowner.py` & `bitdust-0.1.9.241/bitdust/main/shutdowner.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/__init__.py` & `bitdust-0.1.9.241/bitdust/p2p/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/commands.py` & `bitdust-0.1.9.241/bitdust/p2p/commands.py`

 * *Files 1% similar despite different names*

```diff
@@ -355,15 +355,15 @@
     # TODO: something for the future :)
     return 'Receipt'
 
 
 def Message():
     """
     An encrypted message from one peer to another.
-    Can be on of the types: "private_message", "queue_message", "queue_message_replica", "group_message"
+    Can be on of the types: "private_message", "queue_message", "group_message"
     """
     return 'Message'
 
 
 def Correspondent():
     """
     Remote user should send you this to be included in your correspondents
```

### Comparing `bitdust-0.1.8.234/bitdust/p2p/handshaker.py` & `bitdust-0.1.9.241/bitdust/p2p/handshaker.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/id_rotator.py` & `bitdust-0.1.9.241/bitdust/p2p/id_rotator.py`

 * *Files 1% similar despite different names*

```diff
@@ -242,15 +242,15 @@
         if _Debug:
             lg.args(_DebugLevel, preferred_servers=self.preferred_servers)
         self.force = kwargs.get('force', False)
         self.new_revision = kwargs.get('new_revision')
         self.rotated = False
         if not self.preferred_servers:
             try:
-                for srv in strng.to_text(config.conf().getData('services/identity-propagate/known-servers')).split(','):
+                for srv in strng.to_text(config.conf().getString('services/identity-propagate/known-servers')).split(','):
                     if srv.strip():
                         parts = srv.strip().split(':')
                         if len(parts) == 2:
                             host, web_port = parts
                             tcp_port = settings.IdentityServerPort()
                         else:
                             host, web_port, tcp_port = parts
```

### Comparing `bitdust-0.1.8.234/bitdust/p2p/lookup.py` & `bitdust-0.1.9.241/bitdust/p2p/lookup.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/network_connector.py` & `bitdust-0.1.9.241/bitdust/p2p/network_connector.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/network_service.py` & `bitdust-0.1.9.241/bitdust/p2p/network_service.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/online_status.py` & `bitdust-0.1.9.241/bitdust/p2p/online_status.py`

 * *Files 2% similar despite different names*

```diff
@@ -544,19 +544,19 @@
         if o_status.state != 'OFFLINE':
             # if user is online or checking: do nothing
             continue
         if not o_status.latest_check_time:
             # if no checks done yet but he is offline: ping user
             o_status.automat('offline-check')
             continue
-        if utime.get_sec1970() - o_status.latest_check_time > 10*60:
+        if utime.utcnow_to_sec1970() - o_status.latest_check_time > 10*60:
             # user is offline and latest check was sent a while ago: lets try to ping user again
             o_status.automat('offline-check')
             continue
-        if o_status.latest_inbox_time and utime.get_sec1970() - o_status.latest_inbox_time < 60:
+        if o_status.latest_inbox_time and utime.utcnow_to_sec1970() - o_status.latest_inbox_time < 60:
             # user is offline, but we know that he was online recently: lets try to ping him again
             o_status.automat('offline-check')
             continue
     return True
 
 
 #------------------------------------------------------------------------------
@@ -725,15 +725,15 @@
         """
         Condition method.
         """
         if handshaker.is_running(self.idurl.to_bin()):
             return True
         if not self.latest_inbox_time:
             return False
-        return utime.get_sec1970() - self.latest_inbox_time > 60
+        return utime.utcnow_to_sec1970() - self.latest_inbox_time > 60
 
     def doInit(self, *args, **kwargs):
         """
         Action method.
         """
         self.handshake_callbacks = []
         self.keep_alive = kwargs.get('keep_alive', True)
@@ -797,25 +797,25 @@
 
     def doRememberTime(self, *args, **kwargs):
         """
         Action method.
         """
         to_be_remembered = True
         if self.latest_inbox_time:
-            if utime.get_sec1970() - self.latest_inbox_time < 5*60:
+            if utime.utcnow_to_sec1970() - self.latest_inbox_time < 5*60:
                 to_be_remembered = False
         if to_be_remembered:
             ratings.remember_connected_time(self.idurl.to_bin())
-        self.latest_inbox_time = utime.get_sec1970()
+        self.latest_inbox_time = utime.utcnow_to_sec1970()
 
     def doRememberCheckTime(self, *args, **kwargs):
         """
         Action method.
         """
-        self.latest_check_time = utime.get_sec1970()
+        self.latest_check_time = utime.utcnow_to_sec1970()
 
     def doReportAlreadyConnected(self, *args, **kwargs):
         """
         Action method.
         """
         if _Debug:
             lg.args(_DebugLevel, idurl=self.idurl, keep_alive=self.keep_alive, handshake_callbacks=len(self.handshake_callbacks))
```

### Comparing `bitdust-0.1.8.234/bitdust/p2p/p2p_connector.py` & `bitdust-0.1.9.241/bitdust/p2p/p2p_connector.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/p2p_service.py` & `bitdust-0.1.9.241/bitdust/p2p/p2p_service.py`

 * *Files 0% similar despite different names*

```diff
@@ -47,16 +47,14 @@
 #------------------------------------------------------------------------------
 
 _Debug = False
 _DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
-#------------------------------------------------------------------------------
-
 from bitdust.logs import lg
 
 from bitdust.contacts import contactsdb
 
 from bitdust.main import settings
 
 from bitdust.p2p import commands
```

### Comparing `bitdust-0.1.8.234/bitdust/p2p/p2p_service_seeker.py` & `bitdust-0.1.9.241/bitdust/p2p/p2p_service_seeker.py`

 * *Files 3% similar despite different names*

```diff
@@ -76,14 +76,15 @@
 
 _P2PServiceSeekerInstaceCounter = 0
 
 #------------------------------------------------------------------------------
 
 
 class P2PServiceSeeker(automat.Automat):
+
     """
     This class implements all the functionality of the ``p2p_service_seeker()``
     state machine.
     """
 
     fast = True
 
@@ -103,14 +104,15 @@
         self.target_service = None
         self.request_service_params = None
         self.request_service_timeout = None
         self.ping_retries = None
         self.ack_timeout = None
         self.force_handshake = None
         self.exclude_nodes = []
+        self.verify_accepted = None
         self.lookup_task = None
         self.requested_packet_id = None
 
     def A(self, event, *args, **kwargs):
         """
         The state machine code, generated using `visio2python
         <https://bitdust.io/visio2python/>`_ tool.
@@ -191,14 +193,15 @@
         self.target_service = kwargs['target_service']
         self.request_service_params = kwargs.get('request_service_params', None)
         self.request_service_timeout = kwargs.get('request_service_timeout', 120)
         self.ping_retries = kwargs.get('ping_retries', None)
         self.ack_timeout = kwargs.get('ack_timeout', None)
         self.force_handshake = kwargs.get('force_handshake', False)
         self.result_callback = kwargs.get('result_callback', None)
+        self.verify_accepted = kwargs.get('verify_accepted', True)
         self.exclude_nodes = id_url.to_bin_list(kwargs.get('exclude_nodes', []))
         self.retries = kwargs.get('attempts', 5)
 
     def doLookupRandomNode(self, *args, **kwargs):
         """
         Action method.
         """
@@ -315,53 +318,37 @@
         self.target_service = None
         self.request_service_params = None
         self.request_service_timeout = None
         self.ping_retries = None
         self.ack_timeout = None
         self.force_handshake = None
         self.exclude_nodes = []
+        self.verify_accepted = None
         self.requested_packet_id = None
         self.lookup_task = None
         self.destroy()
 
     #------------------------------------------------------------------------------
 
     def _node_acked(self, response, info):
         if _Debug:
             lg.out(_DebugLevel, 'p2p_service_seeker._node_acked %r %r' % (response, info))
-        if not strng.to_text(response.Payload).startswith('accepted'):
+        if self.verify_accepted and not strng.to_text(response.Payload).startswith('accepted'):
             if _Debug:
                 lg.out(_DebugLevel, 'p2p_service_seeker._node_acked with "service denied" response: %r %r' % (response, info))
-            self.automat(
-                'service-denied',
-                (
-                    response,
-                    info,
-                ),
-                reason='service-denied',
-            )
+            self.automat('service-denied', (response, info), reason='service-denied')
             return
         if _Debug:
             lg.out(_DebugLevel, 'p2p_service_seeker._node_acked %s is connected' % response.CreatorID)
-        self.automat('service-accepted', (
-            response,
-            info,
-        ))
+        self.automat('service-accepted', (response, info))
 
     def _node_failed(self, response, info):
         if _Debug:
             lg.out(_DebugLevel, 'p2p_service_seeker._node_failed %r %r' % (response, info))
-        self.automat(
-            'service-denied',
-            (
-                response,
-                info,
-            ),
-            reason='service-denied',
-        )
+        self.automat('service-denied', (response, info), reason='service-denied')
 
     def _node_timed_out(self, pkt_out):
         if _Debug:
             lg.out(_DebugLevel, 'p2p_service_seeker._node_timed_out for outgoing packet %r' % pkt_out)
         self.automat('fail', pkt_out, reason='service-request-timeout')
 
     def _nodes_lookup_finished(self, idurls):
@@ -395,15 +382,15 @@
     else:
         result_defer.errback(Exception(event, args, kwargs))
 
 
 #------------------------------------------------------------------------------
 
 
-def connect_random_node(lookup_method, service_name, service_params=None, exclude_nodes=[], attempts=5, request_service_timeout=None, ping_retries=None, ack_timeout=None, force_handshake=False):
+def connect_random_node(lookup_method, service_name, service_params=None, verify_accepted=True, exclude_nodes=[], attempts=5, request_service_timeout=None, ping_retries=None, ack_timeout=None, force_handshake=False):
     global _P2PServiceSeekerInstaceCounter
     _P2PServiceSeekerInstaceCounter += 1
     result = Deferred()
     p2p_seeker = P2PServiceSeeker(
         name='p2p_service_seeker%d' % _P2PServiceSeekerInstaceCounter,
         state='AT_STARTUP',
         debug_level=_DebugLevel,
@@ -417,23 +404,24 @@
         target_service=service_name,
         request_service_params=service_params,
         request_service_timeout=request_service_timeout,
         ping_retries=ping_retries,
         attempts=attempts,
         ack_timeout=ack_timeout,
         force_handshake=force_handshake,
+        verify_accepted=verify_accepted,
         result_callback=lambda evt, *a, **kw: on_lookup_result(evt, result, *a, **kw),
         exclude_nodes=exclude_nodes,
     )
     if _Debug:
         lg.args(_DebugLevel, service_name=service_name, exclude_nodes=exclude_nodes, inst=p2p_seeker)
     return result
 
 
-def connect_known_node(remote_idurl, service_name, service_params=None, exclude_nodes=[], attempts=2, request_service_timeout=None, ping_retries=None, ack_timeout=None, force_handshake=False):
+def connect_known_node(remote_idurl, service_name, service_params=None, verify_accepted=True, exclude_nodes=[], attempts=2, request_service_timeout=None, ping_retries=None, ack_timeout=None, force_handshake=False):
     global _P2PServiceSeekerInstaceCounter
     _P2PServiceSeekerInstaceCounter += 1
     result = Deferred()
     p2p_seeker = P2PServiceSeeker(
         name='p2p_service_seeker%d' % _P2PServiceSeekerInstaceCounter,
         state='AT_STARTUP',
         debug_level=_DebugLevel,
@@ -447,13 +435,14 @@
         target_service=service_name,
         request_service_params=service_params,
         request_service_timeout=request_service_timeout,
         ping_retries=ping_retries,
         attempts=attempts,
         ack_timeout=ack_timeout,
         force_handshake=force_handshake,
+        verify_accepted=verify_accepted,
         result_callback=lambda evt, *a, **kw: on_lookup_result(evt, result, *a, **kw),
         exclude_nodes=exclude_nodes,
     )
     if _Debug:
         lg.args(_DebugLevel, service_name=service_name, exclude_nodes=exclude_nodes, inst=p2p_seeker)
     return result
```

### Comparing `bitdust-0.1.8.234/bitdust/p2p/p2p_stats.py` & `bitdust-0.1.9.241/bitdust/p2p/p2p_stats.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/propagate.py` & `bitdust-0.1.9.241/bitdust/p2p/propagate.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/p2p/ratings.py` & `bitdust-0.1.9.241/bitdust/p2p/ratings.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/__init__.py` & `bitdust-0.1.9.241/bitdust/raid/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/eccmap.py` & `bitdust-0.1.9.241/bitdust/raid/eccmap.py`

 * *Files 0% similar despite different names*

```diff
@@ -665,16 +665,19 @@
                 for DataNum in Parity:  # look at all datas that went into this parity
                     if DataSegs[DataNum] == 0:  # if this data is missing
                         missing += 1  # increase count of those missing in this parity
                 if missing == 1:  # if missing exactly 1 of datas in parity
                     if (len(bestParityMap) == 0) or (len(Parity) < len(bestParityMap)):
                         bestParityNum = paritynum
                         bestParityMap = Parity
-        if _Debug:
-            open('/tmp/raid.log', 'a').write(u'GetDataFixPath bestParityNum=%d\n' % bestParityNum)
+        # if _Debug:
+        #     try:
+        #         open('/tmp/raid.log', 'a').write(u'GetDataFixPath bestParityNum=%d\n' % bestParityNum)
+        #     except:
+        #         pass
         return bestParityNum, bestParityMap
 
 
 #------------------------------------------------------------------------------
 
 
 def main():
```

### Comparing `bitdust-0.1.8.234/bitdust/raid/make.py` & `bitdust-0.1.9.241/bitdust/raid/make.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/raid_worker.py` & `bitdust-0.1.9.241/bitdust/raid/raid_worker.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/raidutils.py` & `bitdust-0.1.9.241/bitdust/raid/raidutils.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/read.py` & `bitdust-0.1.9.241/bitdust/raid/read.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/rebuild.py` & `bitdust-0.1.9.241/bitdust/raid/rebuild.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/raid/worker.py` & `bitdust-0.1.9.241/bitdust/raid/worker.py`

 * *Files 4% similar despite different names*

```diff
@@ -50,14 +50,15 @@
 _WorkerQueue = multiprocessing.Queue()
 _WorkerLock = Lock()
 
 #------------------------------------------------------------------------------
 
 
 class my_decorator_class(object):
+
     def __init__(self, target):
         self.target = target
 
     def __call__(self, *args, **kwargs):
         task_id = args[-1]
         args = args[:-1]
         res = None
@@ -92,15 +93,18 @@
                 task = tasks.popitem(last=False)
             except KeyError:
                 task = None
 
         if task:
             func, params, callback, error_callback, task_id = task[1]
             if _Debug:
-                lg.out(_DebugLevel, 'raid.worker.func_thread is going to apply task %s with callback %r' % (task_id, callback, ))
+                lg.out(_DebugLevel, 'raid.worker.func_thread is going to apply task %s with callback %r' % (
+                    task_id,
+                    callback,
+                ))
             if six.PY3:
                 pool.apply_async(func=func, args=params + (task_id, ), callback=callback, error_callback=error_callback)
             else:
                 pool.apply_async(func=func, args=params + (task_id, ), callback=callback)
         else:
             try:
                 _WorkerQueue.put(1)
@@ -110,25 +114,27 @@
 
             time.sleep(0.1)
 
     pool.terminate()
 
 
 class Task(object):
+
     def __init__(self, task_id):
         self.task_id = task_id
         if _Debug:
             lg.out(_DebugLevel, 'raid.worker.Task created  task_id=%s' % task_id)
 
     @property
     def tid(self):
         return self.task_id
 
 
 class Manager(object):
+
     def __init__(self, ncpus):
         self._ncpus = ncpus
 
         if six.PY34:
             try:
                 multiprocessing.set_start_method('spawn')
             except RuntimeError:
```

### Comparing `bitdust-0.1.8.234/bitdust/services/__init__.py` & `bitdust-0.1.9.241/bitdust/services/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/driver.py` & `bitdust-0.1.9.241/bitdust/services/driver.py`

 * *Files 3% similar despite different names*

```diff
@@ -66,14 +66,15 @@
 from bitdust.main import events
 from bitdust.main import listeners
 
 #------------------------------------------------------------------------------
 
 _Services = {}
 _BootUpOrder = []
+_RootDistanceDict = {}
 _EnabledServices = set()
 _DisabledServices = set()
 _StartingDeferred = None
 _StopingDeferred = None
 
 #------------------------------------------------------------------------------
 
@@ -94,14 +95,19 @@
 
 
 def boot_up_order():
     global _BootUpOrder
     return _BootUpOrder
 
 
+def root_distance(service_name):
+    global _RootDistanceDict
+    return _RootDistanceDict.get(service_name, 0)
+
+
 def is_on(name):
     svc = services().get(name, None)
     if svc is None:
         return False
     return svc.state == 'ON'
 
 
@@ -277,14 +283,15 @@
         del svc
         svc = None
         enabled_services().discard(name)
 
 
 def build_order():
     global _BootUpOrder
+    global _RootDistanceDict
     order = list(enabled_services())
     progress = True
     fail = False
     counter = 0
     while progress and not fail:
         progress = False
         counter += 1
@@ -309,17 +316,36 @@
             if position < depend_position_max:
                 # print name, order[depend_position_max]
                 order.insert(depend_position_max + 1, name)
                 del order[position]
                 progress = True
                 break
     _BootUpOrder = order
+    for service_name in services().keys():
+        _RootDistanceDict[service_name] = find_root_distance(service_name)
     return order
 
 
+def find_root_distance(service_name):
+    svc = services().get(service_name)
+    if not svc:
+        return 0
+    if not svc.dependent_on():
+        return 0
+    max_root_distance = 0
+    for depend_name in svc.dependent_on():
+        depend_service = services().get(depend_name, None)
+        if not depend_service:
+            raise ServiceNotFound(depend_name)
+        depend_service_root_distance = find_root_distance(depend_name)
+        if depend_service_root_distance > max_root_distance:
+            max_root_distance = depend_service_root_distance
+    return max_root_distance + 1
+
+
 def start(services_list=[]):
     global _StartingDeferred
     global _StopingDeferred
     if _Debug:
         lg.args(_DebugLevel, services_list=services_list, starting=bool(_StartingDeferred), stoping=bool(_StopingDeferred))
     if _StartingDeferred:
         lg.warn('driver.start already called')
```

### Comparing `bitdust-0.1.8.234/bitdust/services/local_service.py` & `bitdust-0.1.9.241/bitdust/services/local_service.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_accountant.py` & `bitdust-0.1.9.241/bitdust/coins/service_accountant.py`

 * *Files 2% similar despite different names*

```diff
@@ -40,16 +40,16 @@
 class AccountantService(LocalService):
 
     service_name = 'service_accountant'
     config_path = 'services/accountant/enabled'
 
     def dependent_on(self):
         return [
-            'service_broadcasting',
-            'service_blockchain',
+            # 'service_broadcasting',
+            # 'service_blockchain',
         ]
 
     def installed(self):
         # TODO: to be continue...
         return False
 
     def start(self):
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_backup_db.py` & `bitdust-0.1.9.241/bitdust/services/service_backup_db.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_backups.py` & `bitdust-0.1.9.241/bitdust/services/service_backups.py`

 * *Files 0% similar despite different names*

```diff
@@ -68,15 +68,15 @@
         conf().addConfigNotifier('services/backups/keep-local-copies-enabled', self._on_keep_local_copies_modified)
         conf().addConfigNotifier('services/backups/wait-suppliers-enabled', self._on_wait_suppliers_modified)
         p2p_connector.A().addStateChangedCallback(self._on_p2p_connector_state_changed, 'INCOMMING?', 'CONNECTED')
         p2p_connector.A().addStateChangedCallback(self._on_p2p_connector_state_changed, 'MY_IDENTITY', 'CONNECTED')
         callback.append_inbox_callback(self._on_inbox_packet_received)
         events.add_subscriber(self._on_my_identity_rotated, 'my-identity-rotated')
         events.add_subscriber(self._on_key_erased, 'key-erased')
-        if listeners.is_populate_requered('remote_version'):
+        if listeners.is_populate_required('remote_version'):
             # listeners.populate_later().remove('remote_version')
             backup_matrix.populate_remote_versions()
         return True
 
     def stop(self):
         from bitdust.storage import backup_monitor
         from bitdust.storage import backup_control
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_blockchain.py` & `bitdust-0.1.9.241/bitdust/services/service_data_disintegration.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/python
-# service_blockchain.py
+# service_data_disintegration.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (service_blockchain.py) is part of BitDust Software.
+# This file (service_data_disintegration.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -22,37 +22,37 @@
 #
 #
 #
 #
 """
 ..
 
-module:: service_blockchain
+module:: service_data_disintegration
 """
 
 from __future__ import absolute_import
 from bitdust.services.local_service import LocalService
 
 
 def create_service():
-    return BlockchainService()
+    return DataDisintegrationService()
 
 
-class BlockchainService(LocalService):
+class DataDisintegrationService(LocalService):
 
-    service_name = 'service_blockchain'
-    config_path = 'services/blockchain/enabled'
+    service_name = 'service_data_disintegration'
+    config_path = 'services/data-disintegration/enabled'
 
     def dependent_on(self):
         return [
-            'service_tcp_connections',
+            'service_keys_registry',
         ]
 
-    def installed(self):
-        # TODO: to be continue...
-        return False
-
     def start(self):
+        from bitdust.raid import raid_worker
+        raid_worker.A('init')
         return True
 
     def stop(self):
+        from bitdust.raid import raid_worker
+        raid_worker.A('shutdown')
         return True
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_broadcasting.py` & `bitdust-0.1.9.241/bitdust/broadcast/service_broadcasting.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_contract_chain.py` & `bitdust-0.1.9.241/bitdust/coins/service_contract_chain.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_customer.py` & `bitdust-0.1.9.241/bitdust/services/service_customer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_customer_family.py` & `bitdust-0.1.9.241/bitdust/services/service_customer_family.py`

 * *Files 2% similar despite different names*

```diff
@@ -67,19 +67,19 @@
                 lg.warn('skipping my own identity')
                 continue
             fm = family_member.by_customer_idurl(customer_idurl)
             if not fm:
                 fm = family_member.create_family(customer_idurl)
             fm.automat('init')
             local_customer_meta_info = contactsdb.get_customer_meta_info(customer_idurl)
-            reactor.callLater(
+            reactor.callLater(  # @UndefinedVariable
                 0,
                 fm.automat,
                 'family-join',
-                {  # @UndefinedVariable
+                {
                     'supplier_idurl': my_id.getIDURL().to_bin(),
                     'ecc_map': local_customer_meta_info.get('ecc_map'),
                     'position': local_customer_meta_info.get('position', -1),
                     'family_snapshot': id_url.to_bin_list(local_customer_meta_info.get('family_snapshot')),
                 },
             )
         events.add_subscriber(self._on_identity_url_changed, 'identity-url-changed')
@@ -109,19 +109,19 @@
         customer_idurl = evt.data['idurl']
         fm = family_member.by_customer_idurl(customer_idurl)
         if not fm:
             fm = family_member.create_family(customer_idurl)
             fm.automat('init')
         else:
             lg.warn('family_member() instance already exists, but new customer just accepted %s' % customer_idurl)
-        reactor.callLater(
+        reactor.callLater(  # @UndefinedVariable
             0,
             fm.automat,
             'family-join',
-            {  # @UndefinedVariable
+            {
                 'supplier_idurl': my_id.getIDURL().to_bin(),
                 'ecc_map': evt.data.get('ecc_map'),
                 'position': evt.data.get('position', -1),
                 'family_snapshot': id_url.to_bin_list(evt.data.get('family_snapshot')),
             },
         )
 
@@ -138,19 +138,19 @@
         if evt.data.get('position') is None:
             lg.warn('position of supplier in the family is still unclear')
             return
         fm = family_member.by_customer_idurl(customer_idurl)
         if not fm:
             lg.err('family_member() instance was not found for existing customer %s' % customer_idurl)
             return
-        reactor.callLater(
+        reactor.callLater(  # @UndefinedVariable
             0,
             fm.automat,
             'family-join',
-            {  # @UndefinedVariable
+            {
                 'supplier_idurl': my_id.getIDURL().to_bin(),
                 'ecc_map': evt.data.get('ecc_map'),
                 'position': evt.data.get('position'),
                 'family_snapshot': id_url.to_bin_list(evt.data.get('family_snapshot')),
             },
         )
 
@@ -163,19 +163,19 @@
         if customer_idurl == my_id.getIDURL():
             lg.warn('skipping my own identity')
             return
         fm = family_member.by_customer_idurl(customer_idurl)
         if not fm:
             lg.err('family_member() instance not found for existing customer %s' % customer_idurl)
             return
-        reactor.callLater(
+        reactor.callLater(  # @UndefinedVariable
             0,
             fm.automat,
             'family-leave',
-            {  # @UndefinedVariable
+            {
                 'supplier_idurl': my_id.getIDURL().to_bin(),
                 'ecc_map': evt.data.get('ecc_map'),
             },
         )
 
     def _on_incoming_contacts_packet(self, newpacket, info):
         from twisted.internet import reactor  # @UnresolvedImport
@@ -211,19 +211,19 @@
             if not id_url.is_cached(customer_idurl):
                 lg.warn('received contacts from unknown user: %r' % customer_idurl)
                 return False
             fm = family_member.by_customer_idurl(customer_idurl)
             if not fm:
                 lg.warn('family_member() instance not found for incoming %s from %s for customer %r' % (newpacket, info, customer_idurl))
                 return False
-            reactor.callLater(
+            reactor.callLater(  # @UndefinedVariable
                 0,
                 fm.automat,
                 'contacts-received',
-                {  # @UndefinedVariable
+                {
                     'type': contacts_type,
                     'packet': newpacket,
                     'customer_idurl': customer_idurl,
                     'customer_ecc_map': ecc_map,
                     'suppliers_list': suppliers_list,
                     'transaction_revision': transaction_revision,
                 },
@@ -243,19 +243,19 @@
             if customer_idurl.to_bin() == my_id.getIDURL().to_bin():
                 lg.warn('received contacts for my own customer family')
                 return False
             fm = family_member.by_customer_idurl(customer_idurl)
             if not fm:
                 lg.warn('family_member() instance not found for incoming %s from %s for customer %r' % (newpacket, info, customer_idurl))
                 return False
-            reactor.callLater(
+            reactor.callLater(  # @UndefinedVariable
                 0,
                 fm.automat,
                 'contacts-received',
-                {  # @UndefinedVariable
+                {
                     'type': contacts_type,
                     'packet': newpacket,
                     'customer_idurl': customer_idurl,
                     'customer_ecc_map': ecc_map,
                     'supplier_idurl': supplier_idurl,
                     'supplier_position': supplier_position,
                     'family_snapshot': family_snapshot,
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_customer_patrol.py` & `bitdust-0.1.9.241/bitdust/services/service_customer_patrol.py`

 * *Files 1% similar despite different names*

```diff
@@ -47,15 +47,15 @@
             'service_supplier',
         ]
 
     def start(self):
         from bitdust.supplier import customers_rejector
         from bitdust.main.config import conf
         from bitdust.supplier import local_tester
-        customers_rejector.A('restart')
+        customers_rejector.A('start')
         conf().addConfigNotifier('services/supplier/donated-space', self._on_donated_space_modified)
         local_tester.init()
         local_tester.start()
         return True
 
     def stop(self):
         from bitdust.supplier import customers_rejector
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_customer_support.py` & `bitdust-0.1.9.241/bitdust/services/service_customer_support.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_data_disintegration.py` & `bitdust-0.1.9.241/bitdust/services/service_rebuilding.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/python
-# service_data_disintegration.py
+# service_rebuilding.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (service_data_disintegration.py) is part of BitDust Software.
+# This file (service_rebuilding.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -22,37 +22,37 @@
 #
 #
 #
 #
 """
 ..
 
-module:: service_data_disintegration
+module:: service_rebuilding
 """
 
 from __future__ import absolute_import
 from bitdust.services.local_service import LocalService
 
 
 def create_service():
-    return DataDisintegrationService()
+    return RebuildingService()
 
 
-class DataDisintegrationService(LocalService):
+class RebuildingService(LocalService):
 
-    service_name = 'service_data_disintegration'
-    config_path = 'services/data-disintegration/enabled'
+    service_name = 'service_rebuilding'
+    config_path = 'services/rebuilding/enabled'
 
     def dependent_on(self):
         return [
-            'service_keys_registry',
+            'service_data_motion',
         ]
 
     def start(self):
-        from bitdust.raid import raid_worker
-        raid_worker.A('init')
+        from bitdust.storage import backup_rebuilder
+        backup_rebuilder.A('init')
         return True
 
     def stop(self):
-        from bitdust.raid import raid_worker
-        raid_worker.A('shutdown')
+        from bitdust.storage import backup_rebuilder
+        backup_rebuilder.Destroy()
         return True
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_data_motion.py` & `bitdust-0.1.9.241/bitdust/services/service_data_motion.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_employer.py` & `bitdust-0.1.9.241/bitdust/services/service_employer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_entangled_dht.py` & `bitdust-0.1.9.241/bitdust/services/service_entangled_dht.py`

 * *Files 1% similar despite different names*

```diff
@@ -48,15 +48,15 @@
             'service_udp_datagrams',
         ]
 
     def network_configuration(self):
         import re
         from bitdust.main import config
         from bitdust_forks.entangled.kademlia import constants  # @UnresolvedImport
-        known_dht_nodes_str = config.conf().getData('services/entangled-dht/known-nodes').strip()
+        known_dht_nodes_str = config.conf().getString('services/entangled-dht/known-nodes').strip()
         known_dht_nodes = []
         if known_dht_nodes_str:
             for dht_node_str in re.split('\n|;|,| ', known_dht_nodes_str):
                 if dht_node_str.strip():
                     try:
                         dht_node = dht_node_str.strip().split(':')
                         dht_node_host = dht_node[0].strip()
@@ -142,15 +142,15 @@
         from bitdust.main.config import conf
         from bitdust.services import driver
         lg.info('DHT node connected    ID0=[%s] : %r' % (dht_service.node().layers[0], ok))
         dht_service.node().add_rpc_callback('store', self._on_dht_rpc_store)
         dht_service.node().add_rpc_callback('request', self._on_dht_rpc_request)
         known_seeds = known_nodes.nodes()
         dl = []
-        attached_layers = conf().getData('services/entangled-dht/attached-layers', default='')
+        attached_layers = conf().getString('services/entangled-dht/attached-layers', default='')
         if attached_layers:
             attached_layers = list(filter(None, map(lambda v: int(str(v).strip()), attached_layers.split(','))))
         else:
             attached_layers = []
         lg.info('reading attached DHT layers from configuration: %r' % attached_layers)
         all_services_attached_layers = driver.get_attached_dht_layers().values()
         combined_services_attached_layers = set()
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_gateway.py` & `bitdust-0.1.9.241/bitdust/services/service_gateway.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_http_connections.py` & `bitdust-0.1.9.241/bitdust/services/service_http_connections.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_http_transport.py` & `bitdust-0.1.9.241/bitdust/services/service_http_transport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_identity_propagate.py` & `bitdust-0.1.9.241/bitdust/services/service_identity_propagate.py`

 * *Files 0% similar despite different names*

```diff
@@ -53,15 +53,15 @@
         if not my_id.isLocalIdentityReady():
             return False
         return True
 
     def network_configuration(self):
         import re
         from bitdust.main import config
-        known_identity_servers_str = str(config.conf().getData('services/identity-propagate/known-servers'))
+        known_identity_servers_str = str(config.conf().getString('services/identity-propagate/known-servers'))
         known_identity_servers = []
         for id_server_str in re.split('\n|;|,| ', known_identity_servers_str):
             if id_server_str.strip():
                 try:
                     id_server = id_server_str.strip().split(':')
                     id_server_host = id_server[0].strip()
                     id_server_http_port = int(id_server[1].strip())
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_identity_server.py` & `bitdust-0.1.9.241/bitdust/services/service_identity_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_ip_port_responder.py` & `bitdust-0.1.9.241/bitdust/services/service_ip_port_responder.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_keys_registry.py` & `bitdust-0.1.9.241/bitdust/services/service_keys_registry.py`

 * *Files 1% similar despite different names*

```diff
@@ -51,15 +51,15 @@
         from bitdust.transport import callback
         from bitdust.main import listeners
         from bitdust.crypt import my_keys
         from bitdust.access import key_ring
         key_ring.init()
         callback.add_outbox_callback(self._on_outbox_packet_sent)
         callback.append_inbox_callback(self._on_inbox_packet_received)
-        if listeners.is_populate_requered('key'):
+        if listeners.is_populate_required('key'):
             # listeners.populate_later().remove('key')
             my_keys.populate_keys()
         return True
 
     def stop(self):
         from bitdust.transport import callback
         from bitdust.access import key_ring
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_keys_storage.py` & `bitdust-0.1.9.241/bitdust/services/service_keys_storage.py`

 * *Files 2% similar despite different names*

```diff
@@ -225,18 +225,15 @@
         my_keys.check_rename_my_keys()
         self._do_synchronize_keys()
         # backup_control.Save()
         return None
 
     def _on_index_synchronizer_state_changed(self, oldstate, newstate, event_string, *args, **kwargs):
         from twisted.internet.defer import Deferred
-        if oldstate in [
-            'REQUEST?',
-            'SENDING',
-        ] and newstate == 'IN_SYNC!':
+        if oldstate in ['REQUEST?', 'SENDING'] and newstate == 'IN_SYNC!':
             if self.sync_keys_requested:
                 result = Deferred()
                 result.addCallback(self._on_keys_synchronized)
                 result.addErrback(self._on_keys_synchronize_failed)
                 self._do_check_sync_keys(result)
 
     def _on_my_keys_synchronize_failed(self, evt):
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_list_files.py` & `bitdust-0.1.9.241/bitdust/services/service_list_files.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_message_broker.py` & `bitdust-0.1.9.241/bitdust/services/service_message_broker.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,37 +47,40 @@
 
     def dependent_on(self):
         return [
             'service_private_messages',
             'service_data_disintegration',
         ]
 
+    def installed(self):
+        return False
+
     def attached_dht_layers(self):
         from bitdust.dht import dht_records
         return [
             dht_records.LAYER_MESSAGE_BROKERS,
         ]
 
     def start(self):
         from bitdust.main import events
         from bitdust.stream import message_peddler
         message_peddler.A('start')
-        self._do_connect_message_brokers_dht_layer()
-        events.add_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
+        # self._do_connect_message_brokers_dht_layer()
+        # events.add_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
         events.add_subscriber(self._on_my_identity_url_changed, 'my-identity-url-changed')
         return True
 
     def stop(self):
         from bitdust.dht import dht_service
         from bitdust.dht import dht_records
         from bitdust.main import events
         from bitdust.stream import message_peddler
         events.remove_subscriber(self._on_my_identity_url_changed, 'my-identity-url-changed')
-        events.remove_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
-        dht_service.suspend(layer_id=dht_records.LAYER_MESSAGE_BROKERS)
+        # events.remove_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
+        # dht_service.suspend(layer_id=dht_records.LAYER_MESSAGE_BROKERS)
         message_peddler.A('stop')
         return True
 
     def health_check(self):
         return True
 
     def request(self, json_payload, newpacket, info):
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_message_history.py` & `bitdust-0.1.9.241/bitdust/services/service_message_history.py`

 * *Files 1% similar despite different names*

```diff
@@ -55,18 +55,18 @@
         from bitdust.main import listeners
         message_database.init()
         message_keeper.init()
         events.add_subscriber(self.on_key_registered, 'key-registered')
         events.add_subscriber(self.on_key_renamed, 'key-renamed')
         events.add_subscriber(self.on_key_generated, 'key-generated')
         events.add_subscriber(self.on_key_erased, 'key-erased')
-        if listeners.is_populate_requered('conversation'):
+        if listeners.is_populate_required('conversation'):
             # listeners.populate_later().remove('conversation')
             message_database.populate_conversations()
-        if listeners.is_populate_requered('message'):
+        if listeners.is_populate_required('message'):
             # listeners.populate_later().remove('message')
             message_database.populate_messages()
         return True
 
     def stop(self):
         from bitdust.chat import message_database
         from bitdust.chat import message_keeper
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_miner.py` & `bitdust-0.1.9.241/bitdust/coins/service_miner.py`

 * *Files 1% similar despite different names*

```diff
@@ -41,15 +41,15 @@
 
     service_name = 'service_miner'
     config_path = 'services/miner/enabled'
 
     def dependent_on(self):
         return [
             'service_nodes_lookup',
-            'service_blockchain',
+            # 'service_blockchain',
         ]
 
     def installed(self):
         # TODO: to be continue...
         return False
 
     def start(self):
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_my_data.py` & `bitdust-0.1.9.241/bitdust/services/service_my_data.py`

 * *Files 1% similar despite different names*

```diff
@@ -65,15 +65,15 @@
         from bitdust.logs import lg
         from bitdust.main import listeners
         from bitdust.storage import keys_synchronizer
         from bitdust.storage import index_synchronizer
         from bitdust.storage import backup_fs
         if keys_synchronizer.is_synchronized() and index_synchronizer.is_synchronized():
             self.confirm_service_started(result=True)
-            if listeners.is_populate_requered('private_file'):
+            if listeners.is_populate_required('private_file'):
                 # listeners.populate_later().remove('private_file')
                 backup_fs.populate_private_files()
         else:
             lg.warn('can not start service_my_data right now, keys_synchronizer.is_synchronized=%r index_synchronizer.is_synchronized=%r' % (keys_synchronizer.is_synchronized(), index_synchronizer.is_synchronized()))
         return self.starting_deferred
 
     def stop(self):
@@ -85,15 +85,15 @@
     def _on_my_storage_ready(self, evt):
         from bitdust.logs import lg
         from bitdust.main import listeners
         from bitdust.services import driver
         from bitdust.storage import backup_fs
         if self.starting_deferred:
             self.confirm_service_started(result=True)
-            if listeners.is_populate_requered('private_file'):
+            if listeners.is_populate_required('private_file'):
                 # listeners.populate_later().remove('private_file')
                 backup_fs.populate_private_files()
         if driver.is_enabled('service_my_data'):
             if not driver.is_started('service_my_data'):
                 lg.info('my storage is ready, starting service_my_data()')
                 driver.start_single('service_my_data')
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_my_ip_port.py` & `bitdust-0.1.9.241/bitdust/services/service_my_ip_port.py`

 * *Files 2% similar despite different names*

```diff
@@ -82,13 +82,13 @@
     def _do_stun(self):
         from bitdust.stun import stun_client
         stun_client.A().dropMyExternalAddress()
         stun_client.A('start', self._on_stun_result)
 
     def _on_stun_result(self, stun_result, nat_type, my_ip, details):
         from bitdust.logs import lg
-        from twisted.internet import reactor
+        from twisted.internet import reactor  # @UnresolvedImport
         if stun_result != 'stun-success' or not my_ip or my_ip == '127.0.0.1':
             lg.warn('stun my external IP failed, retry after 10 seconds')
             reactor.callLater(10, self._do_stun)  # @UndefinedVariable
         else:
             lg.info('stun success  nat_type=%r, my_ip=%r, details=%r' % (nat_type, my_ip, details))
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_network.py` & `bitdust-0.1.9.241/bitdust/services/service_network.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_nodes_lookup.py` & `bitdust-0.1.9.241/bitdust/services/service_nodes_lookup.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_p2p_hookups.py` & `bitdust-0.1.9.241/bitdust/services/service_p2p_hookups.py`

 * *Files 0% similar despite different names*

```diff
@@ -71,15 +71,15 @@
         p2p_connector.A('init')
         p2p_connector.A().addStateChangedCallback(self._on_p2p_connector_switched)
         network_connector.A().addStateChangedCallback(self._on_network_connector_switched)
         callback.append_inbox_callback(self._on_inbox_packet_received)
         callback.append_inbox_callback(p2p_service.inbox)
         events.add_subscriber(self._on_identity_url_changed, 'identity-url-changed')
         events.add_subscriber(self._on_my_identity_url_changed, 'my-identity-url-changed')
-        if listeners.is_populate_requered('online_status'):
+        if listeners.is_populate_required('online_status'):
             # listeners.populate_later().remove('online_status')
             online_status.populate_online_statuses()
         return True
 
     def stop(self):
         from bitdust.transport import callback
         from bitdust.main import events
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_p2p_notifications.py` & `bitdust-0.1.9.241/bitdust/services/service_p2p_notifications.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_personal_messages.py` & `bitdust-0.1.9.241/bitdust/services/service_personal_messages.py`

 * *Files 2% similar despite different names*

```diff
@@ -51,15 +51,15 @@
 
     def installed(self):
         # TODO: needs more work, service_private_groups() must be reliable first
         return False
 
     def start(self):
         from twisted.internet import reactor  # @UnresolvedImport
-        from twisted.internet.defer import Deferred
+        from twisted.internet.defer import Deferred  # @UnresolvedImport
         from bitdust.logs import lg
         from bitdust.main import settings
         from bitdust.access import groups
         from bitdust.crypt import my_keys
         from bitdust.userid import my_id
         self.starting_deferred = Deferred()
         self.starting_deferred.addErrback(lambda err: lg.warn('service %r was not started: %r' % (self.service_name, err.getErrorMessage() if err else 'unknown reason')))
@@ -85,15 +85,15 @@
         d = groups.send_group_pub_key_to_suppliers(self.personal_group_key_id)
         d.addCallback(lambda results: self._do_join_my_personal_group())
         d.addErrback(self.starting_deferred.errback)
         d.addTimeout(10, clock=reactor)
         return self.starting_deferred
 
     def stop(self):
-        from bitdust.interface import api
+        # from bitdust.interface import api
         # api.group_leave(self.personal_group_key_id, erase_key=False)
         return True
 
     def _do_join_my_personal_group(self):
         from bitdust.logs import lg
         from bitdust.interface import api
         lg.info('about to join my personal message group: %r' % self.personal_group_key_id)
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_private_groups.py` & `bitdust-0.1.9.241/bitdust/services/service_private_groups.py`

 * *Files 22% similar despite different names*

```diff
@@ -46,59 +46,36 @@
         return [
             'service_my_data',
             'service_private_messages',
         ]
 
     def start(self):
         from bitdust.main import events
-        from bitdust.services import driver
         from bitdust.access import groups
-        from bitdust.access import group_member
+        from bitdust.access import group_participant
         groups.init()
         events.add_subscriber(self._on_supplier_modified, 'supplier-modified')
-        events.add_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
-        if driver.is_on('service_entangled_dht'):
-            self._do_join_message_brokers_dht_layer()
-        group_member.start_group_members()
+        group_participant.start_group_participants()
         events.add_subscriber(groups.on_identity_url_changed, 'identity-url-changed')
         return True
 
     def stop(self):
         from bitdust.main import events
         from bitdust.access import groups
-        from bitdust.access import group_member
+        from bitdust.access import group_participant
         events.remove_subscriber(groups.on_identity_url_changed, 'identity-url-changed')
-        group_member.shutdown_group_members()
-        events.remove_subscriber(self._on_dht_layer_connected, 'dht-layer-connected')
+        group_participant.shutdown_group_participants()
         events.remove_subscriber(self._on_supplier_modified, 'supplier-modified')
         groups.shutdown()
         return True
 
     def health_check(self):
         # TODO: probably at least one queue must be connected if service is enabled
         return True
 
-    def _do_join_message_brokers_dht_layer(self):
-        from bitdust.logs import lg
-        from bitdust.dht import dht_service
-        from bitdust.dht import dht_records
-        from bitdust.dht import known_nodes
-        lg.info('going to join message brokers DHT layer: %d' % dht_records.LAYER_MESSAGE_BROKERS)
-        known_seeds = known_nodes.nodes()
-        dht_service.open_layer(
-            seed_nodes=known_seeds,
-            layer_id=dht_records.LAYER_MESSAGE_BROKERS,
-            connect_now=True,
-            attach=False,
-        )
-
-    def _on_dht_layer_connected(self, evt):
-        if evt.data['layer_id'] == 0:
-            self._do_join_message_brokers_dht_layer()
-
     def _on_supplier_modified(self, evt):
         from bitdust.logs import lg
         from bitdust.access import key_ring
         from bitdust.crypt import my_keys
         from bitdust.userid import global_id
         from bitdust.userid import my_id
         if evt.data['new_idurl']:
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_private_messages.py` & `bitdust-0.1.9.241/bitdust/services/service_private_messages.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_proxy_server.py` & `bitdust-0.1.9.241/bitdust/services/service_proxy_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_proxy_transport.py` & `bitdust-0.1.9.241/bitdust/services/service_proxy_transport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_rebuilding.py` & `bitdust-0.1.9.241/bitdust/services/service_customer_contracts.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/python
-# service_rebuilding.py
+# service_customer_contracts.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (service_rebuilding.py) is part of BitDust Software.
+# This file (service_customer_contracts.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -22,37 +22,44 @@
 #
 #
 #
 #
 """
 ..
 
-module:: service_rebuilding
+module:: service_customer_contracts
 """
 
 from __future__ import absolute_import
 from bitdust.services.local_service import LocalService
 
 
 def create_service():
-    return RebuildingService()
+    return CustomerContractsService()
 
 
-class RebuildingService(LocalService):
+class CustomerContractsService(LocalService):
 
-    service_name = 'service_rebuilding'
-    config_path = 'services/rebuilding/enabled'
+    service_name = 'service_customer_contracts'
+    config_path = 'services/customer-contracts/enabled'
 
     def dependent_on(self):
         return [
-            'service_data_motion',
+            'service_customer',
+            'service_blockchain_id',
         ]
 
     def start(self):
-        from bitdust.storage import backup_rebuilder
-        backup_rebuilder.A('init')
+        from twisted.internet import task  # @UnresolvedImport
+        self.payment_loop = task.LoopingCall(self.on_payment_task)
+        self.payment_loop.start(60*60, now=True)
         return True
 
     def stop(self):
-        from bitdust.storage import backup_rebuilder
-        backup_rebuilder.Destroy()
+        if self.payment_loop.running:
+            self.payment_loop.stop()
+        self.payment_loop = None
         return True
+
+    def on_payment_task(self):
+        from bitdust.customer import payment
+        payment.pay_for_storage()
```

### Comparing `bitdust-0.1.8.234/bitdust/services/service_restores.py` & `bitdust-0.1.9.241/bitdust/services/service_restores.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_shared_data.py` & `bitdust-0.1.9.241/bitdust/services/service_shared_data.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_tcp_connections.py` & `bitdust-0.1.9.241/bitdust/services/service_tcp_connections.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_tcp_transport.py` & `bitdust-0.1.9.241/bitdust/services/service_tcp_transport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_udp_datagrams.py` & `bitdust-0.1.9.241/bitdust/services/service_udp_datagrams.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/services/service_udp_transport.py` & `bitdust-0.1.9.241/bitdust/services/service_udp_transport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/__init__.py` & `bitdust-0.1.9.241/bitdust/storage/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/accounting.py` & `bitdust-0.1.9.241/bitdust/storage/accounting.py`

 * *Files 3% similar despite different names*

```diff
@@ -53,14 +53,15 @@
 
 from bitdust.system import bpio
 from bitdust.system import diskusage
 
 from bitdust.lib import misc
 from bitdust.lib import strng
 from bitdust.lib import jsn
+from bitdust.lib import utime
 
 from bitdust.main import settings
 
 from bitdust.contacts import contactsdb
 
 from bitdust.userid import id_url
 
@@ -319,7 +320,36 @@
     except:
         r['total_percent'] = ''
     try:
         r['diskfree_percent'] = misc.value2percent(float(r['diskfree']), float(r['disktotal']), 5)
     except:
         r['diskfree_percent'] = ''
     return r
+
+
+#------------------------------------------------------------------------------
+
+
+def verify_storage_contract(json_data):
+    try:
+        utime.unpack_time(json_data['started'])
+        utime.unpack_time(json_data['complete_after'])
+        utime.unpack_time(json_data['pay_before'])
+        int(json_data['value'])
+        int(json_data['allocated_bytes'])
+        int(json_data['duration_hours'])
+        if json_data.get('ecc_position') is not None:
+            int(json_data['ecc_position'])
+        if json_data.get('ecc_map'):
+            str(json_data['ecc_map'])
+        float(json_data['raise_factor'])
+    except:
+        lg.exc(repr(json_data))
+        return False
+    try:
+        gbh = float(json_data['duration_hours'])*(json_data['allocated_bytes']/(1024.0*1024.0*1024.0))
+        if json_data['value'] != gbh:
+            raise Exception('invalid contract GBH value')
+    except:
+        lg.exc()
+        return False
+    return True
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/archive_reader.py` & `bitdust-0.1.9.241/bitdust/storage/backup.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,13 +1,14 @@
-#!/usr/bin/env python
-# archive_reader.py
+#!/usr/bin/python
+# backup.py
 #
-# Copyright (C) 2008 Veselin Penev, http://bitdust.io
 #
-# This file (archive_reader.py) is part of BitDust Software.
+# Copyright (C) 2008 Veselin Penev, https://bitdust.io
+#
+# This file (backup.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -15,491 +16,609 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
+#
+#
+#
+#
 """
-.. module:: archive_reader
-.. role:: red
+.. module:: backup.
+
+.. raw:: html
+
+    <a href="https://bitdust.io/automats/backup/backup.png" target="_blank">
+    <img src="https://bitdust.io/automats/backup/backup.png" style="max-width:100%;">
+    </a>
+
+The core module.
+The ``backup()`` state machine is doing a bunch of things to create a single backup.
+
+Here is an interfaces between a pipe from something like tar
+and the twisted code for rest of BitDust.
+
+Main idea:
+   1) when a backup is started a backup object is created
+   2) get a file descriptor for the process creating the tar archive
+   3) always use select/poll before reading, so never block the main process
+   4) also poll to see if more data is needed to create a block
+   5) number/name blocks so can be sure what is what when we read back later
+   6) encrypt the block data into ``encrypted_blocks``
+   7) call ``p2p.raidmake`` to split block and make "Parity" packets (pieces of block)
+   8) notify the top level code about new pieces of data to send on suppliers
+
+This state machine controls the data read from the folder,
+partition the data into blocks,
+block encryption using the private key and the transfer of units to the suppliers.
+
+Reading is performed from the opened ".tar" pipe and must be finished
+as soon as empty chunk of data were read from the pipe.
+The encrypted data blocks are stored in a temporary folder on the HDD
+and deleted (user configurable) as soon as the suppliers have them.
+
+For each block must be received delivery report: positive or negative.
 
-BitDust archive_reader() Automat
+Process will be completed as soon as all data will be read from the folder
+and all blocks will receive a delivery report.
 
 EVENTS:
-    * :red:`dht-read-failed`
-    * :red:`dht-read-success`
-    * :red:`extract-all-done`
-    * :red:`extract-failed`
-    * :red:`list-files-collected`
-    * :red:`list-files-failed`
-    * :red:`restore-done`
-    * :red:`restore-failed`
+    * :red:`block-encrypted`
+    * :red:`block-raid-done`
+    * :red:`block-raid-started`
+    * :red:`fail`
+    * :red:`read-success`
     * :red:`start`
+    * :red:`timer-001sec`
+    * :red:`timer-01sec`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
+from io import BytesIO
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 10
+_DebugLevel = 12
 
 #------------------------------------------------------------------------------
 
 import os
+import sys
+import time
+import gc
+
+try:
+    from twisted.internet import reactor  # @UnresolvedImport
+except:
+    sys.exit('Error initializing twisted.internet.reactor in backup.py')
+
+from twisted.internet.defer import maybeDeferred, Deferred, succeed
 
 #------------------------------------------------------------------------------
 
-from twisted.internet import reactor  # @UnresolvedImport
+if __name__ == '__main__':
+    import os.path as _p
+    sys.path.append(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..'))
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
-from bitdust.automats import automat
-
 from bitdust.lib import packetid
-from bitdust.lib import serialization
+from bitdust.lib import strng
 
-from bitdust.system import tmpfile
-from bitdust.system import local_fs
+from bitdust.userid import my_id
+from bitdust.userid import global_id
 
-from bitdust.crypt import my_keys
+from bitdust.system import nonblocking
+from bitdust.system import tmpfile
 
-from bitdust.dht import dht_relations
+from bitdust.main import settings
+from bitdust.main import events
 
-from bitdust.contacts import contactsdb
+from bitdust.automats import automat
 
 from bitdust.raid import eccmap
+from bitdust.raid import raid_worker
 
-from bitdust.p2p import commands
-from bitdust.p2p import p2p_service
-
-from bitdust.access import groups
+from bitdust.crypt import encrypted
+from bitdust.crypt import key
 
-from bitdust.storage import restore_worker
-from bitdust.storage import backup_fs
-from bitdust.storage import backup_matrix
-from bitdust.storage import backup_tar
-
-from bitdust.userid import global_id
-from bitdust.userid import my_id
-
-#------------------------------------------------------------------------------
+#-------------------------------------------------------------------------------
 
 
-class ArchiveReader(automat.Automat):
+class backup(automat.Automat):
     """
-    This class implements all the functionality of ``archive_reader()`` state machine.
+    A class to run the backup process, data is read from pipe.
     """
-    def __init__(self, debug_level=_DebugLevel, log_events=_Debug, log_transitions=_Debug, publish_events=False, **kwargs):
+
+    timers = {
+        'timer-01sec': (0.1, ['RAID']),
+        'timer-001sec': (0.01, ['READ']),
+    }
+
+    def __init__(
+        self,
+        backupID,
+        pipe,
+        finishCallback=None,
+        blockResultCallback=None,
+        notifyNewDataCallback=None,
+        blockSize=None,
+        sourcePath=None,
+        keyID=None,
+        ecc_map=None,
+        creatorIDURL=None,
+    ):
+        self.backupID = backupID
+        self.creatorIDURL = creatorIDURL or my_id.getIDURL()
+        _parts = packetid.SplitBackupID(self.backupID)
+        self.customerGlobalID = _parts[0]
+        self.pathID = _parts[1]
+        self.version = _parts[2]
+        self.customerIDURL = global_id.GlobalUserToIDURL(self.customerGlobalID)
+        self.sourcePath = sourcePath
+        self.keyID = keyID
+        self.eccmap = ecc_map or eccmap.Current()
+        self.pipe = pipe
+        self.blockSize = blockSize
+        if self.blockSize is None:
+            self.blockSize = settings.getBackupBlockSize()
+        self.ask4abort = False
+        self.terminating = False
+        self.stateEOF = False
+        self.stateReading = False
+        self.closed = False
+        self.currentBlockData = BytesIO()
+        self.currentBlockSize = 0
+        self.workBlocks = {}
+        self.blockNumber = 0
+        self.dataSent = 0
+        self.blocksSent = 0
+        self.totalSize = -1
+        self.resultDefer = Deferred()
+        self.finishCallback = finishCallback
+        self.blockResultCallback = blockResultCallback
+        self.notifyNewDataCallback = notifyNewDataCallback
+        automat.Automat.__init__(
+            self,
+            name='backup_%s' % self.version,
+            state='AT_STARTUP',
+            debug_level=_DebugLevel,
+            log_events=_Debug,
+            log_transitions=_Debug,
+        )
+
+    def init(self):
         """
-        Builds `archive_reader()` state machine.
         """
-        super(ArchiveReader, self).__init__(name='archive_reader', state='AT_STARTUP', debug_level=debug_level, log_events=log_events, log_transitions=log_transitions, publish_events=publish_events, **kwargs)
+        self.log_transitions = _Debug
 
     def A(self, event, *args, **kwargs):
-        """
-        The state machine code, generated using `visio2python <http://bitdust.io/visio2python/>`_ tool.
-        """
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
-            if event == 'start' and not self.isMyOwnArchive(*args, **kwargs):
-                self.state = 'DHT_READ?'
-                self.doInit(*args, **kwargs)
-                self.doDHTReadSuppliers(*args, **kwargs)
-            elif event == 'start' and self.isMyOwnArchive(*args, **kwargs):
-                self.state = 'LIST_FILES?'
+            if event == 'start':
+                self.state = 'READ'
                 self.doInit(*args, **kwargs)
-                self.doRequestMyListFiles(*args, **kwargs)
-        #---DHT_READ?---
-        elif self.state == 'DHT_READ?':
-            if event == 'dht-read-success':
-                self.state = 'LIST_FILES?'
-                self.doRequestTheirListFiles(*args, **kwargs)
-            elif event == 'dht-read-failed':
-                self.state = 'FAILED'
-                self.doReportFailed(event, *args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-        #---LIST_FILES?---
-        elif self.state == 'LIST_FILES?':
-            if event == 'list-files-collected':
-                self.state = 'RESTORE'
-                self.doStartRestoreWorker(*args, **kwargs)
-            elif event == 'list-files-failed':
-                self.state = 'FAILED'
-                self.doReportFailed(event, *args, **kwargs)
+                self.doFirstBlock(*args, **kwargs)
+        #---READ---
+        elif self.state == 'READ':
+            if event == 'read-success' and not self.isReadingNow(*args, **kwargs) and (self.isBlockReady(*args, **kwargs) or self.isEOF(*args, **kwargs)):
+                self.state = 'ENCRYPT'
+                self.doEncryptBlock(*args, **kwargs)
+            elif event == 'fail' or ((event == 'read-success' or event == 'timer-001sec') and self.isAborted(*args, **kwargs)):
+                self.state = 'ABORTED'
+                self.doClose(*args, **kwargs)
+                self.doReport(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-        #---RESTORE---
-        elif self.state == 'RESTORE':
-            if event == 'extract-all-done':
+            elif (event == 'read-success' or event
+                  == 'timer-001sec') and not self.isAborted(*args, **kwargs) and self.isPipeReady(*args, **kwargs) and not self.isEOF(*args, **kwargs) and not self.isReadingNow(*args, **kwargs) and not self.isBlockReady(*args, **kwargs):
+                self.doRead(*args, **kwargs)
+            elif event == 'block-raid-done' and not self.isAborted(*args, **kwargs):
+                self.doPopBlock(*args, **kwargs)
+                self.doBlockReport(*args, **kwargs)
+                self.doNotifyNewData(*args, **kwargs)
+        #---RAID---
+        elif self.state == 'RAID':
+            if event == 'block-raid-done' and not self.isMoreBlocks(*args, **kwargs) and not self.isAborted(*args, **kwargs):
                 self.state = 'DONE'
-                self.doReportDone(*args, **kwargs)
+                self.doPopBlock(*args, **kwargs)
+                self.doBlockReport(*args, **kwargs)
+                self.doNotifyNewData(*args, **kwargs)
+                self.doClose(*args, **kwargs)
+                self.doReport(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'restore-failed' or event == 'extract-failed':
-                self.state = 'FAILED'
-                self.doReportFailed(event, *args, **kwargs)
+            elif event == 'block-raid-started' and not self.isEOF(*args, **kwargs) and not self.isAborted(*args, **kwargs):
+                self.state = 'READ'
+                self.doNextBlock(*args, **kwargs)
+                self.doRead(*args, **kwargs)
+            elif event == 'block-raid-done' and self.isMoreBlocks(*args, **kwargs) and not self.isAborted(*args, **kwargs):
+                self.doPopBlock(*args, **kwargs)
+                self.doBlockReport(*args, **kwargs)
+                self.doNotifyNewData(*args, **kwargs)
+            elif event == 'fail' or ((event == 'timer-01sec' or event == 'block-raid-done' or event == 'block-raid-started') and self.isAborted(*args, **kwargs)):
+                self.state = 'ABORTED'
+                self.doClose(*args, **kwargs)
+                self.doReport(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'restore-done':
-                self.doExtractArchive(*args, **kwargs)
+        #---ENCRYPT---
+        elif self.state == 'ENCRYPT':
+            if event == 'block-encrypted':
+                self.state = 'RAID'
+                self.doBlockPushAndRaid(*args, **kwargs)
+            elif event == 'fail':
+                self.state = 'ABORTED'
+                self.doClose(*args, **kwargs)
+                self.doReport(*args, **kwargs)
+                self.doDestroyMe(*args, **kwargs)
+            elif event == 'block-raid-done' and not self.isAborted(*args, **kwargs):
+                self.doPopBlock(*args, **kwargs)
+                self.doBlockReport(*args, **kwargs)
+                self.doNotifyNewData(*args, **kwargs)
         #---DONE---
         elif self.state == 'DONE':
             pass
-        #---FAILED---
-        elif self.state == 'FAILED':
+        #---ABORTED---
+        elif self.state == 'ABORTED':
             pass
         return None
 
-    def isMyOwnArchive(self, *args, **kwargs):
+    def isAborted(self, *args, **kwargs):
+        """
+        Return current value of ``ask4abort`` flag.
+        """
+        # if _Debug:
+        #     lg.args(_DebugLevel, ask4abort=self.ask4abort)
+        return self.ask4abort
+
+    def isPipeReady(self, *args, **kwargs):
+        """
+        Return True if ``pipe`` object exist and is ready for reading a the new
+        chunk of data.
+        """
+        if _Debug:
+            lg.args(_DebugLevel, pipe=bool(self.pipe), pipe_state=(self.pipe.state() if self.pipe else None))
+        if self.pipe is None:
+            lg.warn('pipe is None')
+            return False
+        return self.pipe.state() in [nonblocking.PIPE_CLOSED, nonblocking.PIPE_READY2READ]
+
+    def isBlockReady(self, *args, **kwargs):
+        if _Debug:
+            lg.args(_DebugLevel, currentBlockSize=self.currentBlockSize, blockSize=self.blockSize)
+        return self.currentBlockSize >= self.blockSize
+
+    def isEOF(self, *args, **kwargs):
+        if _Debug:
+            lg.args(_DebugLevel, stateEOF=self.stateEOF)
+        return self.stateEOF
+
+    def isReadingNow(self, *args, **kwargs):
+        if _Debug:
+            lg.args(_DebugLevel, stateReading=self.stateReading)
+        return self.stateReading
+
+    def isMoreBlocks(self, *args, **kwargs):
         """
         Condition method.
         """
-        _, queue_owner_id, _ = global_id.SplitGlobalQueueID(kwargs['queue_id'])
-        return my_id.getID() == queue_owner_id
+        if _Debug:
+            lg.args(_DebugLevel, workBlocks=len(self.workBlocks))
+        return len(self.workBlocks) > 1
 
     def doInit(self, *args, **kwargs):
         """
         Action method.
         """
-        self.queue_id = kwargs['queue_id']
-        self.start_sequence_id = kwargs['start_sequence_id']
-        self.end_sequence_id = kwargs['end_sequence_id']
-        self.archive_folder_path = kwargs['archive_folder_path']
-        self.result_defer = kwargs.get('result_defer')
-        qa, oid, _ = global_id.SplitGlobalQueueID(self.queue_id)
-        self.queue_alias = qa
-        self.queue_owner_id = oid
-        self.queue_owner_idurl = global_id.glob2idurl(self.queue_owner_id)
-        self.group_key_id = my_keys.make_key_id(alias=self.queue_alias, creator_glob_id=self.queue_owner_id)
-        self.suppliers_list = []
-        self.selected_backups = []
-        self.ecc_map = None
-        self.correctable_errors = 0
-        self.requested_list_files = {}
-        self.extracted_messages = []
-        self.request_list_files_timer = None
+        events.send('backup-started', data=dict(backup_id=self.backupID))
 
-    def doDHTReadSuppliers(self, *args, **kwargs):
+    def doRead(self, *args, **kwargs):
         """
         Action method.
         """
-        d = dht_relations.read_customer_suppliers(customer_idurl=self.queue_owner_idurl, use_cache=True)
-        d.addCallback(self._on_read_queue_owner_suppliers_success)
-        d.addErrback(self._on_read_queue_owner_suppliers_failed)
+        def readChunk():
+            size = self.blockSize - self.currentBlockSize
+            if size < 0:
+                if _Debug:
+                    lg.args(_DebugLevel, eccmap_nodes=self.eccmap.nodes(), block_size=self.blockSize, current_block_size=self.currentBlockSize)
+                raise Exception('size < 0, blockSize=%s, currentBlockSize=%s' % (self.blockSize, self.currentBlockSize))
+            elif size == 0:
+                return succeed(b'')
+            if self.pipe is None:
+                raise Exception('backup.pipe is None')
+            if self.pipe.state() == 2:
+                if _Debug:
+                    lg.out(_DebugLevel, 'backup.readChunk the state is PIPE_CLOSED in %r' % self)
+                return succeed(b'')
+            if self.pipe.state() == 0:
+                if _Debug:
+                    lg.out(_DebugLevel, 'backup.readChunk the state is PIPE_EMPTY in %r' % self)
+                return succeed(b'')
+            if _Debug:
+                lg.args(_DebugLevel, size=size)
+            return self.pipe.read_defer(size)
+
+        def readDone(data):
+            try:
+                self.stateReading = False
+                self.currentBlockData.write(data)
+                self.currentBlockSize += len(data)
+            except:
+                lg.exc()
+                self.automat('fail', None)
+                return None
+            if not data:
+                self.stateEOF = True
+            if _Debug:
+                lg.out(_DebugLevel, 'backup.readDone %d bytes' % len(data))
+            reactor.callLater(0, self.automat, 'read-success')  # @UndefinedVariable
+            return data
+
+        def readFailed(err):
+            lg.err(err)
+            self.automat('fail', err)
+            return None
 
-    def doRequestTheirListFiles(self, *args, **kwargs):
+        self.stateReading = True
+        d = readChunk()
+        d.addCallback(readDone)
+        d.addErrback(readFailed)
+
+    def doEncryptBlock(self, *args, **kwargs):
         """
         Action method.
         """
-        groups.create_archive_folder(self.group_key_id, force_path_id=self.archive_folder_path)
-        self._do_request_list_files(self.suppliers_list)
+        def _doBlock():
+            dt = time.time()
+            raw_bytes = self.currentBlockData.getvalue()
+            block = encrypted.Block(
+                CreatorID=self.creatorIDURL,
+                BackupID=self.backupID,
+                BlockNumber=self.blockNumber,
+                SessionKey=key.NewSessionKey(session_key_type=key.SessionKeyType()),
+                SessionKeyType=key.SessionKeyType(),
+                LastBlock=self.stateEOF,
+                Data=raw_bytes,
+                EncryptKey=self.keyID,
+            )
+            del raw_bytes
+            if _Debug:
+                lg.out(_DebugLevel, 'backup.doEncryptBlock blockNumber=%d size=%d atEOF=%s dt=%s EncryptKey=%s' % (self.blockNumber, self.currentBlockSize, self.stateEOF, str(time.time() - dt), self.keyID))
+            return block
+
+        d = maybeDeferred(_doBlock)
+        d.addCallback(lambda block: self.automat('block-encrypted', block))
+        d.addErrback(lambda err: self.automat('fail', err))
 
-    def doRequestMyListFiles(self, *args, **kwargs):
+    def doBlockPushAndRaid(self, *args, **kwargs):
         """
         Action method.
         """
-        self._do_request_list_files(contactsdb.suppliers())
+        newblock = args[0]
+        if newblock is None:
+            self.abort()
+            self.automat('fail')
+            if _Debug:
+                lg.out(_DebugLevel, 'backup.doBlockPushAndRaid ERROR newblock is empty, terminating=%s' % self.terminating)
+            lg.warn('failed to encrypt block, ABORTING')
+            return
+        if self.terminating:
+            self.automat('block-raid-done', (newblock.BlockNumber, None))
+            if _Debug:
+                lg.out(_DebugLevel, 'backup.doBlockPushAndRaid SKIP, terminating=True')
+            return
+        fileno, filename = tmpfile.make('raid', extension='.raid')
+        serializedblock = newblock.Serialize()
+        blocklen = len(serializedblock)
+        os.write(fileno, strng.to_bin(blocklen) + b':' + serializedblock)
+        os.close(fileno)
+        self.workBlocks[newblock.BlockNumber] = filename
+        dt = time.time()
+        outputpath = os.path.join(settings.getLocalBackupsDir(), self.customerGlobalID, self.pathID, self.version)
+        task_params = (filename, self.eccmap.name, self.version, newblock.BlockNumber, outputpath)
+        raid_worker.add_task('make', task_params, lambda cmd, params, result: self._raidmakeCallback(params, result, dt))
+        self.automat('block-raid-started', newblock)
+        del serializedblock
+        if _Debug:
+            lg.out(_DebugLevel, 'backup.doBlockPushAndRaid %s : start process data from %s to %s, %d' % (newblock.BlockNumber, filename, outputpath, id(self.terminating)))
 
-    def doStartRestoreWorker(self, *args, **kwargs):
+    def doPopBlock(self, *args, **kwargs):
         """
         Action method.
         """
-        if self._do_select_archive_snapshots():
-            self._do_restore_next_backup(0)
+        blockNumber, _ = args[0]
+        filename = self.workBlocks.pop(blockNumber)
+        tmpfile.throw_out(filename, 'block raid done')
 
-    def doExtractArchive(self, *args, **kwargs):
+    def doFirstBlock(self, *args, **kwargs):
         """
         Action method.
         """
-        self._do_extract_archive(backup_id=kwargs['backup_id'], tarfilename=kwargs['tarfilename'], backup_index=kwargs['backup_index'])
+        self.dataSent = 0
+        self.blocksSent = 0
+        self.blockNumber = 0
+        self.currentBlockSize = 0
+        self.currentBlockData = BytesIO()
 
-    def doReportDone(self, *args, **kwargs):
+    def doNextBlock(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.result_defer:
-            self.result_defer.callback(args[0])
+        self.dataSent += self.currentBlockSize
+        self.blocksSent += 1
+        self.blockNumber += 1
+        self.currentBlockSize = 0
+        self.currentBlockData.close()
+        self.currentBlockData = BytesIO()
 
-    def doReportFailed(self, event, *args, **kwargs):
+    def doBlockReport(self, *args, **kwargs):
         """
         Action method.
         """
-        err = None
-        if event == 'dht-read-failed':
-            err = Exception('failed reading DHT records for customer family')
-        elif event == 'list-files-failed':
-            err = Exception('list files request failed')
-        elif event == 'restore-failed':
-            err = Exception('archive snapshot restore task failed')
-        elif event == 'extract-failed':
-            err = Exception('archive snapshot extract failed')
-        if self.result_defer:
-            self.result_defer.errback(err)
+        BlockNumber, result = args[0]
+        if self.blockResultCallback:
+            self.blockResultCallback(self.backupID, BlockNumber, result)
+
+    def doNotifyNewData(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        if self.notifyNewDataCallback:
+            self.notifyNewDataCallback()
+
+    def doClose(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        self.closed = True
+        for filename in self.workBlocks.values():
+            tmpfile.throw_out(filename, 'backup aborted')
+
+    def doReport(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        if self.ask4abort:
+            if self.finishCallback:
+                self.finishCallback(self.backupID, 'abort')
+            self.resultDefer.callback('abort')
+            events.send('backup-aborted', data=dict(backup_id=self.backupID, source_path=self.sourcePath))
+        else:
+            if self.finishCallback:
+                self.finishCallback(self.backupID, 'done')
+            self.resultDefer.callback('done')
+            events.send('backup-done', data=dict(backup_id=self.backupID, source_path=self.sourcePath))
 
     def doDestroyMe(self, *args, **kwargs):
         """
-        Remove all references to the state machine object to destroy it.
+        Action method.
         """
-        self.queue_id = None
-        self.start_sequence_id = None
-        self.end_sequence_id = None
-        self.archive_folder_path = None
-        self.result_defer = None
-        self.queue_alias = None
-        self.queue_owner_id = None
-        self.queue_owner_idurl = None
-        self.group_key_id = None
-        self.suppliers_list = None
-        self.selected_backups = None
-        self.ecc_map = None
-        self.correctable_errors = 0
-        self.requested_list_files = None
-        self.extracted_messages = None
-        self.request_list_files_timer = None
+        self._kill_pipe()
+        self.eccmap = None
+        self.pipe = None
+        self.ask4abort = False
+        self.terminating = False
+        self.stateEOF = False
+        self.stateReading = False
+        self.closed = False
+        self.workBlocks = None
+        self.resultDefer = None
+        self.finishCallback = None
+        self.blockResultCallback = None
+        self.currentBlockData.close()
+        del self.currentBlockData
         self.destroy()
-
-    def _do_request_list_files(self, suppliers_list):
-        backup_matrix.add_list_files_query_callback(
-            customer_idurl=self.queue_owner_idurl,
-            query_path=self.queue_alias,
-            callback_method=self._on_list_files_response,
-        )
-        self.correctable_errors = eccmap.GetCorrectableErrors(len(suppliers_list))
-        for supplier_pos, supplier_idurl in enumerate(suppliers_list):
-            if not supplier_idurl:
-                self.requested_list_files[supplier_pos] = False
-                continue
-            outpacket = p2p_service.SendListFiles(
-                target_supplier=supplier_idurl,
-                key_id=self.group_key_id,
-                query_items=[self.queue_alias],
-                callbacks={
-                    commands.Fail(): lambda resp, info: self._on_list_files_failed(supplier_pos),
-                    None: lambda pkt_out: self._on_list_files_failed(supplier_pos),
-                },
-            )
-            self.requested_list_files[supplier_pos] = None if outpacket else False
+        collected = gc.collect()
         if _Debug:
-            lg.args(_DebugLevel, queue_alias=self.queue_alias, requested=self.requested_list_files)
-        self.request_list_files_timer = reactor.callLater(30, self._on_request_list_files_timeout)  # @UndefinedVariable
+            lg.out(_DebugLevel, 'backup.doDestroyMe [%s] collected %d objects' % (self.backupID, collected))
 
-    def _do_select_archive_snapshots(self):
-        iterID_and_path = backup_fs.WalkByID(self.archive_folder_path, iterID=backup_fs.fsID(self.queue_owner_idurl, self.queue_alias))
-        if iterID_and_path is None:
-            lg.err('did not found archive folder in the catalog: %r' % self.archive_folder_path)
-            self.automat('restore-failed')
-            return False
-        iterID, _ = iterID_and_path
-        known_archive_snapshots_list = backup_fs.ListAllBackupIDsFull(iterID=iterID)
-        if not known_archive_snapshots_list:
-            lg.err('failed to restore data from archive, no snapshots found in folder: %r' % self.archive_folder_path)
-            self.automat('restore-failed')
-            return False
-        snapshots_list = []
-        for archive_item in known_archive_snapshots_list:
-            snapshots_list.append(archive_item[1])
+    def abort(self):
+        """
+        This method should stop this backup by killing the pipe process.
+        """
         if _Debug:
-            lg.args(_DebugLevel, snapshots_list=snapshots_list)
-        if not snapshots_list:
-            lg.err('no available snapshots found in archive list: %r' % known_archive_snapshots_list)
-            self.automat('restore-failed')
-            return False
-        snapshot_sequence_ids = []
-        for backup_id in snapshots_list:
-            _, path_id, _ = packetid.SplitBackupID(backup_id)
-            if not path_id:
-                continue
+            lg.out(_DebugLevel, 'backup.abort id %s, %d' % (str(self.backupID), id(self.ask4abort)))
+        self.terminating = True
+        for blockNumber, filename in self.workBlocks.items():
+            lg.warn('aborting raid make worker for block %d in %s' % (blockNumber, filename))
+            raid_worker.cancel_task('make', filename)
+        lg.warn('killing backup pipe')
+        self.ask4abort = True
+        self._kill_pipe()
+
+    def progress(self):
+        """
+        """
+        if self.totalSize <= 0:
+            return 0.0
+        percent = min(100.0, 100.0*self.dataSent/self.totalSize)
+        return percent
+
+    def _raidmakeCallback(self, params, result, dt):
+        _, _, _, blockNumber, _ = params
+        if result is None:
+            if _Debug:
+                lg.out(_DebugLevel, 'backup._raidmakeCallback WARNING - result is None :  %r eof=%s dt=%s' % (blockNumber, str(self.stateEOF), str(time.time() - dt)))
+            events.send('backup-raidmake-failed', data=dict(backup_id=self.backupID))
+            self.ask4abort = True
+            self._kill_pipe()
+        else:
+            if _Debug:
+                lg.out(_DebugLevel, 'backup._raidmakeCallback %r %r eof=%s dt=%s' % (blockNumber, result, str(self.stateEOF), str(time.time() - dt)))
+            self.automat('block-raid-done', (blockNumber, result))
+
+    def _kill_pipe(self):
+        if self.pipe:
+            if _Debug:
+                lg.out(_DebugLevel, 'backup._kill_pipe for %s' % self.backupID)
             try:
-                snapshot_sequence_id = int(path_id.split('/')[-1])
+                self.pipe.kill()
             except:
                 lg.exc()
-                continue
-            if self.start_sequence_id is not None and self.start_sequence_id > snapshot_sequence_id:
-                continue
-            if self.end_sequence_id is not None and self.end_sequence_id < snapshot_sequence_id:
-                continue
-            snapshot_sequence_ids.append((
-                snapshot_sequence_id,
-                backup_id,
-            ))
-        snapshot_sequence_ids.sort(key=lambda item: int(item[0]))
-        if _Debug:
-            lg.args(_DebugLevel, snapshot_sequence_ids=snapshot_sequence_ids)
-        self.selected_backups = [item[1] for item in snapshot_sequence_ids]
-        if not self.selected_backups:
-            lg.err('no backups selected from snapshot list')
-            self.automat('restore-failed')
-            return False
-        if _Debug:
-            lg.args(_DebugLevel, selected_backups=self.selected_backups)
-        return True
-
-    def _do_restore_next_backup(self, backup_index):
-        if _Debug:
-            lg.args(_DebugLevel, backup_index=backup_index, selected_backups=len(self.selected_backups))
-        if backup_index >= len(self.selected_backups):
-            lg.info('all selected backups are processed')
-            self.automat('extract-all-done', self.extracted_messages)
-            return
-        backup_id = self.selected_backups[backup_index]
-        alias = backup_id.split('$')[0]
-        outfd, outfilename = tmpfile.make(
-            'restore',
-            extension='.tar.gz',
-            prefix=alias + '_',
-        )
-        rw = restore_worker.RestoreWorker(backup_id, outfd, KeyID=self.group_key_id)
-        rw.MyDeferred.addCallback(self._on_restore_done, backup_id, outfd, outfilename, backup_index)
-        rw.MyDeferred.addErrback(lg.errback, debug=_Debug, debug_level=_DebugLevel, method='archive_reader.doStartRestoreWorker')
-        rw.MyDeferred.addErrback(self._on_restore_failed, backup_id, outfd, outfilename, backup_index)
-        rw.automat('init')
-
-    def _do_extract_archive(self, backup_id, tarfilename, backup_index):
-        snapshot_dir = tmpfile.make_dir('restore', extension='.msg')
-        d = backup_tar.extracttar_thread(tarfilename, snapshot_dir)
-        d.addCallback(self._on_extract_done, backup_id, tarfilename, snapshot_dir, backup_index)
-        d.addErrback(self._on_extract_failed, backup_id, tarfilename, snapshot_dir)
-        return d
-
-    def _on_read_queue_owner_suppliers_success(self, dht_value):
-        # TODO: add more validations of dht_value
-        if dht_value and isinstance(dht_value, dict) and len(dht_value.get('suppliers', [])) > 0:
-            self.suppliers_list = dht_value['suppliers']
-            self.ecc_map = dht_value['ecc_map']
-            self.correctable_errors = eccmap.GetCorrectableErrors(len(self.suppliers_list))
-        if _Debug:
-            lg.args(_DebugLevel, suppliers_list=self.suppliers_list, ecc_map=self.ecc_map)
-        if not self.suppliers_list or not self.ecc_map:
-            self.automat('dht-read-failed', None)
-            return None
-        self.automat('dht-read-success')
-        return None
-
-    def _on_read_queue_owner_suppliers_failed(self, err):
-        lg.err('failed to read customer suppliers: %r' % err)
-        self.automat('dht-read-failed', err)
-        return None
-
-    def _on_list_files_response(self, supplier_num, new_files_count):
-        if not self.requested_list_files:
-            lg.warn('skip ListFiles() response, requested_list_files object is empty')
-            return
-        if self.requested_list_files.get(supplier_num) is not None:
-            lg.warn('skip ListFiles() response, supplier record at position %d already set to %r' % (supplier_num, self.requested_list_files.get(supplier_num)))
-            return
-        self.requested_list_files[supplier_num] = True
-        lst = list(self.requested_list_files.values())
-        if _Debug:
-            lg.args(_DebugLevel, requested_list_files=lst, supplier_num=supplier_num, new_files_count=new_files_count)
-        if lst.count(None) == 0:
-            if self.request_list_files_timer and self.request_list_files_timer.active():
-                self.request_list_files_timer.cancel()
-                self.request_list_files_timer = None
-            backup_matrix.remove_list_files_query_callback(
-                customer_idurl=self.queue_owner_idurl,
-                query_path=self.queue_alias,
-                callback_method=self._on_list_files_response,
-            )
-            success_list_files = lst.count(True)
-            if success_list_files:
-                self.automat('list-files-collected')
-            else:
-                self.automat('list-files-failed')
-        return None
 
-    def _on_list_files_failed(self, supplier_num):
-        if not self.requested_list_files:
-            lg.warn('skip ListFiles() response, requested_list_files object is empty')
-            return
-        if self.requested_list_files.get(supplier_num) is not None:
-            lg.warn('skip ListFiles() response, supplier record at position %d already set to %r' % (supplier_num, self.requested_list_files.get(supplier_num)))
-            return
-        self.requested_list_files[supplier_num] = False
-        lst = list(self.requested_list_files.values())
-        if _Debug:
-            lg.args(_DebugLevel, requested_list_files=lst, supplier_num=supplier_num)
-        if lst.count(None) == 0:
-            if self.request_list_files_timer and self.request_list_files_timer.active():
-                self.request_list_files_timer.cancel()
-                self.request_list_files_timer = None
-            backup_matrix.remove_list_files_query_callback(
-                customer_idurl=self.queue_owner_idurl,
-                query_path=self.queue_alias,
-                callback_method=self._on_list_files_response,
-            )
-            success_list_files = lst.count(True)
-            if success_list_files:
-                self.automat('list-files-collected')
-            else:
-                self.automat('list-files-failed')
-        return None
 
-    def _on_request_list_files_timeout(self):
-        self.request_list_files_timer = None
-        for supplier_num in self.requested_list_files:
-            if self.requested_list_files[supplier_num] is None:
-                self.requested_list_files[supplier_num] = False
-        lst = list(self.requested_list_files.values())
-        if _Debug:
-            lg.args(_DebugLevel, requested_list_files=lst)
-        backup_matrix.remove_list_files_query_callback(
-            customer_idurl=self.queue_owner_idurl,
-            query_path=self.queue_alias,
-            callback_method=self._on_list_files_response,
-        )
-        success_list_files = lst.count(True)
-        if success_list_files:
-            self.automat('list-files-collected')
-        else:
-            self.automat('list-files-failed')
+#------------------------------------------------------------------------------
 
-    def _on_restore_done(self, result, backup_id, outfd, tarfilename, backup_index):
-        try:
-            os.close(outfd)
-        except:
-            lg.exc()
-        if result == 'done':
-            lg.info('archive %r restore success from %r' % (backup_id, tarfilename))
-        else:
-            lg.err('archive %r restore failed from %r with : %r' % (backup_id, tarfilename, result))
-        if result != 'done':
-            tmpfile.throw_out(tarfilename, 'restore ' + result)
-            self.automat('restore-failed', backup_id=backup_id, tarfilename=tarfilename)
-            return None
-        self.automat('restore-done', backup_id=backup_id, tarfilename=tarfilename, backup_index=backup_index)
-        return
 
-    def _on_restore_failed(self, err, backupID, outfd, tarfilename, backup_index):
-        lg.err('archive %r restore failed with : %r' % (backupID, err))
+def main():
+    from bitdust.system import bpio
+    from bitdust.storage import backup_tar
+
+    bpio.init()
+    settings.init()
+
+    lg.set_debug_level(24)
+    lg.life_begins()
+
+    automat.LifeBegins(lg.when_life_begins())
+    automat.OpenLogFile(settings.AutomatsLog())
+
+    key.InitMyKey()
+    my_id.init()
+
+    sourcePath = sys.argv[1]
+    compress_mode = 'bz2'
+    backupID = sys.argv[2]
+    raid_worker.A('init')
+
+    if bpio.pathIsDir(sourcePath):
+        backupPipe = backup_tar.backuptardir_thread(sourcePath, compress=compress_mode)
+    else:
+        backupPipe = backup_tar.backuptarfile_thread(sourcePath, compress=compress_mode)
+
+    def _bk_done(bid, result):
+        from bitdust.crypt import signed
+        customer, remotePath = packetid.SplitPacketID(bid)
         try:
-            os.close(outfd)
+            os.mkdir(os.path.join(settings.getLocalBackupsDir(), customer, remotePath + '.out'))
         except:
-            lg.exc()
-        self.automat('restore-failed')
-        return None
+            pass
+        for filename in os.listdir(os.path.join(settings.getLocalBackupsDir(), customer, remotePath)):
+            filepath = os.path.join(settings.getLocalBackupsDir(), customer, remotePath, filename)
+            payld = bpio.ReadBinaryFile(filepath)
+            newpacket = signed.Packet('Data', my_id.getIDURL(), my_id.getIDURL(), filename, payld, 'http://megafaq.ru/cvps1010.xml')
+            newfilepath = os.path.join(settings.getLocalBackupsDir(), customer, remotePath + '.out', filename)
+            bpio.WriteBinaryFile(newfilepath, newpacket.Serialize())
+
+    def _bk_closed(*args, **kwargs):
+        # job.automat('fail')
+        # del job
+        reactor.stop()  # @UndefinedVariable
+
+    def _bk_start():
+        job = backup(backupID, backupPipe, blockSize=16*1024*1024)
+        job.finishCallback = _bk_done  # lambda bid, result: _bk_done(bid, result, job)
+        job.addStateChangedCallback(_bk_closed, oldstate=None, newstate='DONE')
+        reactor.callLater(1, job.automat, 'start')  # @UndefinedVariable
+
+    reactor.callLater(0, _bk_start)  # @UndefinedVariable
+    reactor.run()  # @UndefinedVariable
+    settings.shutdown()
 
-    def _on_extract_failed(self, err, backupID, source_filename, output_location):
-        lg.err('archive %r extract failed from %r to %r with: %r' % (backupID, source_filename, output_location, err))
-        tmpfile.throw_out(source_filename, 'file extract failed')
-        self.automat('extract-failed', err)
-        return None
 
-    def _on_extract_done(self, retcode, backupID, source_filename, output_location, backup_index):
-        tmpfile.throw_out(source_filename, 'file extracted')
-        for snapshot_filename in os.listdir(output_location):
-            snapshot_path = os.path.join(output_location, snapshot_filename)
-            snapshot_data = serialization.BytesToDict(local_fs.ReadBinaryFile(snapshot_path), values_to_text=True)
-            for archive_message in snapshot_data.get('items', []):
-                if self.start_sequence_id is not None:
-                    if self.start_sequence_id > archive_message['sequence_id']:
-                        continue
-                if self.end_sequence_id is not None:
-                    if self.end_sequence_id < archive_message['sequence_id']:
-                        continue
-                self.extracted_messages.append(archive_message)
-        if _Debug:
-            lg.dbg(_DebugLevel, 'archive snapshot %r extracted successfully to %r, extracted %d archive messages so far' % (source_filename, output_location, len(self.extracted_messages)))
-        self._do_restore_next_backup(backup_index + 1)
-        return retcode
+if __name__ == '__main__':
+    main()
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/archive_writer.py` & `bitdust-0.1.9.241/bitdust/userid/id_restorer.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/env python
-# archive_writer.py
+# identity_restorer.py
 #
-# Copyright (C) 2008 Veselin Penev, http://bitdust.io
+# Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (archive_writer.py) is part of BitDust Software.
+# This file (id_restorer.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -15,362 +15,418 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
+#
+#
+#
+#
+#
 """
-.. module:: archive_writer
+.. module:: id_restorer.
+
 .. role:: red
 
-BitDust archive_writer() Automat
 
 EVENTS:
-    * :red:`ack`
-    * :red:`backup-done`
-    * :red:`backup-failed`
-    * :red:`block-ready`
-    * :red:`dht-read-failed`
-    * :red:`dht-read-success`
-    * :red:`fail`
-    * :red:`packets-delivered`
-    * :red:`sending-failed`
+    * :red:`my-id-failed`
+    * :red:`my-id-received`
+    * :red:`restore-failed`
+    * :red:`restore-success`
     * :red:`start`
+    * :red:`stun-failed`
+    * :red:`stun-success`
+    * :red:`suppliers-read-failed`
+    * :red:`suppliers-read-ok`
+
+.. raw:: html
+
+    <a href="https://bitdust.io/automats/identity_restorer/identity_restorer.png" target="_blank">
+    <img src="https://bitdust.io/automats/identity_restorer/identity_restorer.png" style="max-width:100%;">
+    </a>
+
+A state machine to restore the user account.
+
+Needed for restoration of the user account information using its Private key and ID url.
+    * at first request user's identity file from Identity server
+    * do verification and restoration of his locally identity to be able to start the software
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
 
 _Debug = False
 _DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import os
+import sys
+import random
+
+try:
+    from twisted.internet import reactor  # @UnresolvedImport
+except:
+    sys.exit('Error initializing twisted.internet.reactor in identity_restorer.py')
 
 #------------------------------------------------------------------------------
 
+from bitdust.automats import automat
+
 from bitdust.logs import lg
 
-from bitdust.automats import automat
+from bitdust.main import settings
 
 from bitdust.system import bpio
 
-from bitdust.lib import packetid
-from bitdust.lib import misc
+from bitdust.lib import net_misc
 
-from bitdust.main import settings
-
-from bitdust.crypt import my_keys
+from bitdust.raid import eccmap
 
-from bitdust.dht import dht_relations
+from bitdust.crypt import key
 
-from bitdust.p2p import commands
-from bitdust.p2p import p2p_service
+from bitdust.contacts import contactsdb
 
-from bitdust.raid import eccmap
+from bitdust.stun import stun_client
 
-from bitdust.storage import backup_fs
-from bitdust.storage import backup_tar
-from bitdust.storage import backup
+from bitdust.dht import dht_relations
 
-from bitdust.userid import global_id
+from bitdust.userid import identity
 from bitdust.userid import my_id
+from bitdust.userid import id_url
 
 #------------------------------------------------------------------------------
 
+_IdRestorer = None
+_WorkingIDURL = ''
+_WorkingKey = ''
 
-class ArchiveWriter(automat.Automat):
+#------------------------------------------------------------------------------
+
+
+def A(event=None, *args, **kwargs):
     """
-    This class implements all the functionality of ``archive_writer()`` state machine.
+    Access method to interact with the state machine.
     """
-    def __init__(self, local_data_callback, debug_level=_DebugLevel, log_events=_Debug, log_transitions=_Debug, publish_events=False, **kwargs):
-        """
-        Builds `archive_writer()` state machine.
-        """
-        self.local_data_callback = local_data_callback
-        super(ArchiveWriter, self).__init__(name='archive_writer', state='AT_STARTUP', debug_level=debug_level, log_events=log_events, log_transitions=log_transitions, publish_events=publish_events, **kwargs)
+    global _IdRestorer
+    if _IdRestorer is None:
+        # set automat name and starting state here
+        _IdRestorer = IdRestorer(
+            name='id_restorer',
+            state='AT_STARTUP',
+            debug_level=2,
+            log_transitions=True,
+            log_events=True,
+            publish_events=True,
+        )
+    if event is not None:
+        _IdRestorer.automat(event, *args, **kwargs)
+    return _IdRestorer
+
+
+class IdRestorer(automat.Automat):
+
+    """
+    BitDust identity_restorer() Automat.
+
+    Class to run the process to restore user account.
+    """
+
+    MESSAGES = {
+        'MSG_01': ['requesting user identity from remote ID server'],
+        'MSG_02': ['key verification failed!', 'red'],
+        'MSG_03': ['downloading user identity from remote ID server'],
+        'MSG_04': ['incorrect or non-existing IDURL provided', 'red'],
+        'MSG_05': ['verifying user identity and private key'],
+        'MSG_06': ['your identity restored successfully!', 'green'],
+        'MSG_07': ['checking network connectivity'],
+        'MSG_08': [
+            'network connection failed',
+            'red',
+        ],
+        'MSG_09': ['reading list of my suppliers from DHT'],
+    }
+
+    def init(self):
+        self.last_message = ''
+
+    def msg(self, msgid, *args, **kwargs):
+        msg = self.MESSAGES.get(msgid, ['', 'black'])
+        text = msg[0]
+        color = 'black'
+        if len(msg) == 2:
+            color = msg[1]
+        return text, color
+
+    def state_changed(self, oldstate, newstate, event, *args, **kwargs):
+        from bitdust.main import installer
+        installer.A('id_restorer.state', newstate)
 
     def A(self, event, *args, **kwargs):
-        """
-        The state machine code, generated using `visio2python <http://bitdust.io/visio2python/>`_ tool.
-        """
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
             if event == 'start':
-                self.state = 'DHT_READ?'
-                self.doInit(*args, **kwargs)
-                self.doDHTReadSuppliers(*args, **kwargs)
-        #---DHT_READ?---
-        elif self.state == 'DHT_READ?':
-            if event == 'dht-read-success':
-                self.state = 'BACKUP'
-                self.doStartArchiveBackup(*args, **kwargs)
-            elif event == 'dht-read-failed':
+                self.state = 'STUN_MY_IP'
+                self.doPrint(self.msg('MSG_07', *args, **kwargs))
+                self.doSetWorkingIDURL(*args, **kwargs)
+                self.doSetWorkingKey(*args, **kwargs)
+                self.doStunExternalIP(*args, **kwargs)
+        #---STUN_MY_IP---
+        elif self.state == 'STUN_MY_IP':
+            if event == 'stun-failed':
                 self.state = 'FAILED'
-                self.doReportFailed(event, *args, **kwargs)
+                self.doPrint(self.msg('MSG_08', *args, **kwargs))
+                self.doClearWorkingIDURL(*args, **kwargs)
+                self.doClearWorkingKey(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-        #---BACKUP---
-        elif self.state == 'BACKUP':
-            if event == 'backup-done':
-                self.state = 'SENDING'
-                self.doCheckFinished(*args, **kwargs)
-            elif event == 'block-ready':
-                self.doPushPackets(*args, **kwargs)
-            elif event == 'ack' or event == 'fail':
-                self.doPullPacket(event, *args, **kwargs)
-            elif event == 'backup-failed':
+            elif event == 'stun-success':
+                self.state = 'MY_ID'
+                self.doPrint(self.msg('MSG_01', *args, **kwargs))
+                self.doRequestMyIdentity(*args, **kwargs)
+        #---MY_ID---
+        elif self.state == 'MY_ID':
+            if event == 'my-id-received':
+                self.state = 'VERIFY'
+                self.doPrint(self.msg('MSG_05', *args, **kwargs))
+                self.doVerifyAndRestore(*args, **kwargs)
+            elif event == 'my-id-failed':
                 self.state = 'FAILED'
-                self.doReportFailed(*args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-        #---SENDING---
-        elif self.state == 'SENDING':
-            if event == 'packets-delivered':
-                self.state = 'DONE'
-                self.doReportDone(*args, **kwargs)
+                self.doPrint(self.msg('MSG_04', *args, **kwargs))
+                self.doClearWorkingIDURL(*args, **kwargs)
+                self.doClearWorkingKey(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'ack' or event == 'fail':
-                self.doPullPacket(event, *args, **kwargs)
-                self.doCheckFinished(*args, **kwargs)
-            elif event == 'sending-failed':
+        #---VERIFY---
+        elif self.state == 'VERIFY':
+            if event == 'restore-failed':
                 self.state = 'FAILED'
-                self.doReportFailed(*args, **kwargs)
+                self.doPrint(*args, **kwargs)
+                self.doClearWorkingIDURL(*args, **kwargs)
+                self.doClearWorkingKey(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-        #---DONE---
-        elif self.state == 'DONE':
+            elif event == 'restore-success':
+                self.state = 'SUPPLIERS?'
+                self.doPrint(self.msg('MSG_09', *args, **kwargs))
+                self.doDHTReadMySuppliers(*args, **kwargs)
+        #---SUPPLIERS?---
+        elif self.state == 'SUPPLIERS?':
+            if event == 'suppliers-read-ok' or event == 'suppliers-read-failed':
+                self.state = 'RESTORED!'
+                self.doPrint(self.msg('MSG_06', *args, **kwargs))
+                self.doRestoreSave(*args, **kwargs)
+                self.doDestroyMe(*args, **kwargs)
+        #---RESTORED!---
+        elif self.state == 'RESTORED!':
             pass
         #---FAILED---
         elif self.state == 'FAILED':
             pass
         return None
 
-    def doInit(self, *args, **kwargs):
+    def doStunExternalIP(self, *args, **kwargs):
         """
         Action method.
         """
-        self.queue_id = kwargs['queue_id']
-        self.archive_info = kwargs['archive_info']
-        self.archive_folder_path = kwargs['archive_folder_path']
-        self.result_defer = kwargs.get('result_defer')
-        qa, oid, _ = global_id.SplitGlobalQueueID(self.queue_id)
-        self.queue_alias = qa
-        self.queue_owner_id = oid
-        self.queue_owner_idurl = global_id.glob2idurl(self.queue_owner_id)
-        self.group_key_id = my_keys.make_key_id(alias=self.queue_alias, creator_glob_id=self.queue_owner_id)
-        self.backup_job = None
-        self.backup_max_block_num = None
-        self.suppliers_list = []
-        self.ecc_map = None
-        self.correctable_errors = 0
-        self.packets_out = {}
+        if _Debug:
+            lg.out(_DebugLevel, 'identity_restorer.doStunExternalIP')
 
-    def doDHTReadSuppliers(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        d = dht_relations.read_customer_suppliers(customer_idurl=self.queue_owner_idurl, use_cache=True)
-        d.addCallback(self._on_read_queue_owner_suppliers_success)
-        d.addErrback(self._on_read_queue_owner_suppliers_failed)
+        def save(result):
+            if _Debug:
+                lg.out(_DebugLevel, '            external IP : %s' % result)
+            if result['result'] != 'stun-success':
+                self.automat('stun-failed')
+                return
+            ip = result['ip']
+            bpio.WriteTextFile(settings.ExternalIPFilename(), ip)
+            self.automat('stun-success', ip)
+
+        rnd_udp_port = random.randint(
+            settings.DefaultUDPPort(),
+            settings.DefaultUDPPort() + 500,
+        )
+        rnd_dht_port = random.randint(
+            settings.DefaultDHTPort(),
+            settings.DefaultDHTPort() + 500,
+        )
+        d = stun_client.safe_stun(udp_port=rnd_udp_port, dht_port=rnd_dht_port)
+        d.addCallback(save)
+        d.addErrback(lambda _: self.automat('stun-failed'))
+
+    def doSetWorkingIDURL(self, *args, **kwargs):
+        global _WorkingIDURL
+        _WorkingIDURL = args[0]['idurl']
+
+    def doSetWorkingKey(self, *args, **kwargs):
+        global _WorkingKey
+        _WorkingKey = args[0]['keysrc']
+
+    def doClearWorkingIDURL(self, *args, **kwargs):
+        global _WorkingIDURL
+        _WorkingIDURL = ''
+
+    def doClearWorkingKey(self, *args, **kwargs):
+        global _WorkingKey
+        _WorkingKey = ''
+
+    def doRequestMyIdentity(self, *args, **kwargs):
+        global _WorkingIDURL
+        idurl = _WorkingIDURL
+        if _Debug:
+            lg.out(_DebugLevel, 'identity_restorer.doRequestMyIdentity %s %s' % (idurl, type(idurl)))
+        net_misc.getPageTwisted(idurl).addCallbacks(lambda src: self.automat('my-id-received', src), lambda err: self.automat('my-id-failed', err))
 
-    def doStartArchiveBackup(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_start_archive_backup()
+    def doVerifyAndRestore(self, *args, **kwargs):
+        global _WorkingKey
+        if _Debug:
+            lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore')
 
-    def doPushPackets(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_send_packets(
-            backup_id=kwargs['backup_id'],
-            block_num=kwargs['block_num'],
-        )
+        remote_identity_src = args[0]
+
+        if os.path.isfile(settings.KeyFileName()):
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore will backup and remove ' + settings.KeyFileName())
+            bpio.backup_and_remove(settings.KeyFileName())
+
+        if os.path.isfile(settings.LocalIdentityFilename()):
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore will backup and remove ' + settings.LocalIdentityFilename())
+            bpio.backup_and_remove(settings.LocalIdentityFilename())
+
+        try:
+            remote_ident = identity.identity(xmlsrc=remote_identity_src)
+            local_ident = identity.identity(xmlsrc=remote_identity_src)
+        except:
+            # lg.exc()
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('remote identity have incorrect format', 'red'))  # @UndefinedVariable
+            return
 
-    def doPullPacket(self, event, *args, **kwargs):
-        """
-        Action method.
-        """
-        newpacket = kwargs['newpacket']
-        _, _, _, block_num, _, _ = packetid.SplitFull(newpacket.PacketID)
-        if block_num not in self.packets_out:
-            raise Exception('unregistered block number received')
-        if newpacket.PacketID not in self.packets_out[block_num]:
-            raise Exception('unregistered packet ID received')
-        if event == 'ack':
-            self.packets_out[block_num][newpacket.PacketID] = True
-        else:
-            self.packets_out[block_num][newpacket.PacketID] = False
         if _Debug:
-            lg.args(_DebugLevel, event=event, block_num=block_num, packet_id=newpacket.PacketID, packets_out=self.packets_out)
+            lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore checking remote identity')
+        try:
+            res = remote_ident.isCorrect()
+        except:
+            lg.exc()
+            res = False
+        if not res:
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore remote identity is not correct FAILED!!!!')
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('remote identity format is not correct', 'red'))  # @UndefinedVariable
+            return
 
-    def doCheckFinished(self, *args, **kwargs):
-        """
-        Action method.
-        """
         if _Debug:
-            lg.args(_DebugLevel, backup_job=self.backup_job, backup_max_block_num=self.backup_max_block_num, packets_out=list(self.packets_out.values()))
-        if self.backup_job:
-            # backup is not finished yet
+            lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore validate remote identity')
+        try:
+            res = remote_ident.Valid()
+        except:
+            lg.exc()
+            res = False
+        if not res:
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore validate remote identity FAILED!!!!')
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('remote identity is not valid', 'red'))  # @UndefinedVariable
             return
-        if self.backup_max_block_num not in self.packets_out:
-            # packets of the last block not sent yet
+
+        my_id.forgetLocalIdentity()
+        my_id.eraseLocalIdentity(do_backup=True)
+        key.ForgetMyKey(erase_file=True, do_backup=True)
+        bpio.WriteTextFile(settings.KeyFileName(), _WorkingKey)
+        try:
+            key.InitMyKey()
+        except:
+            key.ForgetMyKey(erase_file=True, do_backup=False)
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('private key is not valid', 'red'))  # @UndefinedVariable
             return
-        packets_in_progress = 0
-        for block_num in self.packets_out.keys():
-            packets_in_progress += list(self.packets_out[block_num].values()).count(None)
-        if packets_in_progress:
-            # some packets are still in progress
+
+        try:
+            local_ident.sign()
+        except:
+            # lg.exc()
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('error while signing identity', 'red'))  # @UndefinedVariable
             return
-        for block_num in self.packets_out.keys():
-            block_packets_failed = list(self.packets_out[block_num].values()).count(False)
-            if block_packets_failed > self.correctable_errors*2:  # because each packet also have Parity()
-                lg.err('all packets for block %d are sent, but too many errors: %d' % (block_num, block_packets_failed))
-                self.automat('sending-failed')
-                return
-        self.automat('packets-delivered')
 
-    def doReportDone(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        if self.result_defer:
-            self.result_defer.callback(self.archive_info)
+        if remote_ident.signature != local_ident.signature:
+            reactor.callLater(0.1, self.automat, 'restore-failed', ('signature did not match, key verification failed!', 'red'))  # @UndefinedVariable
+            return
+
+        my_id.setLocalIdentity(local_ident)
+        my_id.saveLocalIdentity()
+        # my_id.rebuildLocalIdentity(save_identity=True)
+
+        bpio.WriteTextFile(settings.UserNameFilename(), my_id.getIDName())
+
+        if os.path.isfile(settings.KeyFileName() + '.backup'):
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore will remove backup file for ' + settings.KeyFileName())
+            bpio.remove_backuped_file(settings.KeyFileName())
+
+        if os.path.isfile(settings.LocalIdentityFilename() + '.backup'):
+            if _Debug:
+                lg.out(_DebugLevel, 'identity_restorer.doVerifyAndRestore will remove backup file for ' + settings.LocalIdentityFilename())
+            bpio.remove_backuped_file(settings.LocalIdentityFilename())
+
+        reactor.callLater(0.1, self.automat, 'restore-success')  # @UndefinedVariable
 
-    def doReportFailed(self, event, *args, **kwargs):
+    def doDHTReadMySuppliers(self, *args, **kwargs):
         """
         Action method.
         """
-        ret = 'unknown error'
-        if event == 'dht-read-failed':
-            ret = 'failed reading list of suppliers from DHT'
-        elif event == 'backup-failed':
-            ret = 'local archive backup is failed'
-        elif event == 'sending-failed':
-            ret = 'sending archived packets failed'
-        if self.result_defer:
-            self.result_defer.errback(Exception(ret))
+        known_suppliers = len(contactsdb.suppliers())
+        if known_suppliers > 0:
+            lg.warn('skip reading my suppliers from DHT, currently known %d suppliers already' % known_suppliers)
+            self.automat('suppliers-read-ok')
+            return
+        d = dht_relations.read_customer_suppliers(my_id.getIDURL(), use_cache=False)
+        d.addCallback(self._on_my_dht_relations_discovered)
+        d.addErrback(self._on_my_dht_relations_failed)
+
+    def doRestoreSave(self, *args, **kwargs):
+        """
+        TODO: use lib.config here request settings from DHT my suppliers need
+        to keep that settings in DHT.
+        """
+        # settings.uconfig().set('storage.suppliers', '0')
+        # settings.uconfig().set('storage.needed', '0Mb')
+        # settings.uconfig().set('storage.donated', '0Mb')
+        # settings.uconfig().update()
+
+    def doPrint(self, *args, **kwargs):
+        from bitdust.main import installer
+        installer.A().event('print', args[0])
+        self.last_message = args[0][0]
+        if _Debug:
+            lg.out(_DebugLevel, 'id_restorer.doPrint: %s' % str(args[0]))
 
     def doDestroyMe(self, *args, **kwargs):
         """
-        Remove all references to the state machine object to destroy it.
+        Action method.
         """
-        self.queue_id = None
-        self.archive_info = None
-        self.result_defer = None
-        self.suppliers_list = None
-        self.ecc_map = None
-        self.packets_out = None
-        self.block_failed = None
-        self.backup_job = None
-        self.correctable_errors = None
-        self.destroy()
-
-    def _do_start_archive_backup(self):
-        archive_id, local_path = self.local_data_callback(self.queue_id, self.archive_info)
-        supplier_path_id = os.path.join(self.archive_folder_path, archive_id)
-        dataID = misc.NewBackupID()
-        backup_id = packetid.MakeBackupID(
-            customer=self.queue_owner_id,
-            path_id=supplier_path_id,
-            key_alias=self.queue_alias,
-            version=dataID,
-        )
-        backup_fs.MakeLocalDir(settings.getLocalBackupsDir(), backup_id)
-        compress_mode = 'bz2'
-        arcname = os.path.basename(local_path)
-        backupPipe = backup_tar.backuptarfile_thread(local_path, arcname=arcname, compress=compress_mode)
-        self.backup_job = backup.backup(
-            backupID=backup_id,
-            pipe=backupPipe,
-            blockResultCallback=self._on_archive_backup_block_result,
-            finishCallback=self._on_archive_backup_done,
-            blockSize=1024*1024*10,
-            sourcePath=local_path,
-            keyID=self.group_key_id,
-            ecc_map=eccmap.eccmap(self.ecc_map),
-            creatorIDURL=self.queue_owner_idurl,
-        )
-        self.backup_job.automat('start')
-        if _Debug:
-            lg.args(_DebugLevel, job=self.backup_job, backup_id=backup_id, local_path=local_path, group_key_id=self.group_key_id)
-
-    def _do_send_packets(self, backup_id, block_num):
-        customer_id, path_id, version_name = packetid.SplitBackupID(backup_id)
-        archive_snapshot_dir = os.path.join(settings.getLocalBackupsDir(), customer_id, path_id, version_name)
-        if _Debug:
-            lg.args(_DebugLevel, backup_id=backup_id, block_num=block_num, archive_snapshot_dir=archive_snapshot_dir)
-        if not os.path.isdir(archive_snapshot_dir):
-            self.block_failed = True
-            lg.err('archive snapshot folder was not found in %r' % archive_snapshot_dir)
-            return None
-        failed_supliers = 0
-        for supplier_num in range(len(self.suppliers_list)):
-            supplier_idurl = self.suppliers_list[supplier_num]
-            if not supplier_idurl:
-                failed_supliers += 1
-                lg.warn('unknown supplier supplier_num=%d' % supplier_num)
-                continue
-            for dataORparity in ('Data', 'Parity'):
-                packet_id = packetid.MakePacketID(backup_id, block_num, supplier_num, dataORparity)
-                packet_filename = os.path.join(archive_snapshot_dir, '%d-%d-%s' % (block_num, supplier_num, dataORparity))
-                if not os.path.isfile(packet_filename):
-                    lg.err('%s is not a file' % packet_filename)
-                    continue
-                packet_payload = bpio.ReadBinaryFile(packet_filename)
-                if not packet_payload:
-                    lg.err('file %r reading error' % packet_filename)
-                    continue
-                if block_num not in self.packets_out:
-                    self.packets_out[block_num] = {}
-                self.packets_out[block_num][packet_id] = None
-                p2p_service.SendData(
-                    raw_data=packet_payload,
-                    ownerID=self.queue_owner_idurl,
-                    creatorID=my_id.getIDURL(),
-                    remoteID=supplier_idurl,
-                    packetID=packet_id,
-                    callbacks={
-                        commands.Ack(): lambda newpacket, _: self.automat('ack', newpacket=newpacket),
-                        commands.Fail(): lambda newpacket, _: self.automat('fail', newpacket=newpacket),
-                    },
-                )
-        if failed_supliers > self.correctable_errors:
-            self.block_failed = True
-            lg.err('too many failed suppliers %d in block %d' % (failed_supliers, block_num))
-
-    def _on_read_queue_owner_suppliers_success(self, dht_value):
-        # TODO: add more validations of dht_value
-        if dht_value and isinstance(dht_value, dict) and len(dht_value.get('suppliers', [])) > 0:
-            self.suppliers_list = dht_value['suppliers']
-            self.ecc_map = dht_value['ecc_map']
-            self.correctable_errors = eccmap.GetCorrectableErrors(len(self.suppliers_list))
-        if _Debug:
-            lg.args(_DebugLevel, suppliers_list=self.suppliers_list, ecc_map=self.ecc_map)
-        if not self.suppliers_list or not self.ecc_map:
-            self.automat('dht-read-failed', None)
-            return None
-        self.automat('dht-read-success')
-        return None
-
-    def _on_read_queue_owner_suppliers_failed(self, err):
-        lg.err('failed to read customer suppliers: %r' % err)
-        self.automat('dht-read-failed', err)
-        return None
-
-    def _on_archive_backup_block_result(self, backup_id, block_num, result):
-        if not result:
-            self.block_failed = True
-            return
-        self.automat('block-ready', backup_id=backup_id, block_num=block_num)
-
-    def _on_archive_backup_done(self, backup_id, result):
-        self.backup_max_block_num = self.backup_job.blockNumber
-        self.backup_job = None
-        if result != 'done':
-            self.automat('backup-failed')
+        self.executeStateChangedCallbacks(oldstate=None, newstate=self.state, event_string=None, args=args)
+        self.destroy(dead_state=self.state)
+        global _IdRestorer
+        _IdRestorer = None
+
+    def _on_my_dht_relations_discovered(self, dht_result):
+        if not (dht_result and isinstance(dht_result, dict) and len(dht_result.get('suppliers', [])) > 0):
+            lg.warn('no dht records found for my customer family')
+            self.automat('suppliers-read-failed')
             return
-        self.automat('backup-done')
+        dht_suppliers = id_url.to_bin_list(dht_result['suppliers'])
+        dht_ecc_map = dht_result.get('ecc_map', settings.DefaultEccMapName())
+        try:
+            dht_desired_suppliers_number = eccmap.GetEccMapSuppliersNumber(dht_ecc_map)
+        except:
+            lg.exc()
+            dht_desired_suppliers_number = eccmap.GetEccMapSuppliersNumber(settings.DefaultEccMapName())
+        settings.config.conf().setInt('services/customer/suppliers-number', dht_desired_suppliers_number)
+        contactsdb.set_suppliers(dht_suppliers)
+        contactsdb.save_suppliers()
+        lg.info('found and restored list of %d suppliers from DHT' % dht_desired_suppliers_number)
+        self.automat('suppliers-read-ok')
+
+    def _on_my_dht_relations_failed(self, err):
+        lg.err(err)
+        self.automat('suppliers-read-failed')
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup.py` & `bitdust-0.1.9.241/bitdust/stun/stun_client.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,14 +1,13 @@
-#!/usr/bin/python
-# backup.py
-#
+#!/usr/bin/env python
+# stun_client.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (backup.py) is part of BitDust Software.
+# This file (stun_client.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -16,609 +15,665 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
-#
-#
-#
-#
 """
-.. module:: backup.
+.. module:: stun_client.
 
-.. raw:: html
+.. role:: red
 
-    <a href="https://bitdust.io/automats/backup/backup.png" target="_blank">
-    <img src="https://bitdust.io/automats/backup/backup.png" style="max-width:100%;">
-    </a>
-
-The core module.
-The ``backup()`` state machine is doing a bunch of things to create a single backup.
-
-Here is an interfaces between a pipe from something like tar
-and the twisted code for rest of BitDust.
-
-Main idea:
-   1) when a backup is started a backup object is created
-   2) get a file descriptor for the process creating the tar archive
-   3) always use select/poll before reading, so never block the main process
-   4) also poll to see if more data is needed to create a block
-   5) number/name blocks so can be sure what is what when we read back later
-   6) encrypt the block data into ``encrypted_blocks``
-   7) call ``p2p.raidmake`` to split block and make "Parity" packets (pieces of block)
-   8) notify the top level code about new pieces of data to send on suppliers
-
-This state machine controls the data read from the folder,
-partition the data into blocks,
-block encryption using the private key and the transfer of units to the suppliers.
-
-Reading is performed from the opened ".tar" pipe and must be finished
-as soon as empty chunk of data were read from the pipe.
-The encrypted data blocks are stored in a temporary folder on the HDD
-and deleted (user configurable) as soon as the suppliers have them.
+BitDust ``stun_client()`` Automat
 
-For each block must be received delivery report: positive or negative.
-
-Process will be completed as soon as all data will be read from the folder
-and all blocks will receive a delivery report.
 
 EVENTS:
-    * :red:`block-encrypted`
-    * :red:`block-raid-done`
-    * :red:`block-raid-started`
-    * :red:`fail`
-    * :red:`read-success`
+    * :red:`datagram-received`
+    * :red:`dht-nodes-not-found`
+    * :red:`found-some-nodes`
+    * :red:`init`
+    * :red:`port-number-received`
+    * :red:`shutdown`
     * :red:`start`
-    * :red:`timer-001sec`
-    * :red:`timer-01sec`
+    * :red:`timer-10sec`
+    * :red:`timer-1sec`
+    * :red:`timer-2sec`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
-from io import BytesIO
+from __future__ import print_function
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 12
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
-import os
 import sys
-import time
-import gc
-
-try:
-    from twisted.internet import reactor  # @UnresolvedImport
-except:
-    sys.exit('Error initializing twisted.internet.reactor in backup.py')
-
-from twisted.internet.defer import maybeDeferred, Deferred, succeed
+import random
+import re
 
 #------------------------------------------------------------------------------
 
 if __name__ == '__main__':
     import os.path as _p
-    sys.path.append(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..'))
+    sys.path.insert(0, _p.abspath(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..')))
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
-from bitdust.lib import packetid
-from bitdust.lib import strng
+from bitdust.system import bpio
 
-from bitdust.userid import my_id
-from bitdust.userid import global_id
+from bitdust.automats import automat
 
-from bitdust.system import nonblocking
-from bitdust.system import tmpfile
+from bitdust.lib import strng
+from bitdust.lib import udp
+from bitdust.lib import net_misc
+from bitdust.lib import nameurl
+from bitdust.lib import misc
 
 from bitdust.main import settings
 from bitdust.main import events
 
-from bitdust.automats import automat
+from bitdust.services import driver
 
-from bitdust.raid import eccmap
-from bitdust.raid import raid_worker
+#------------------------------------------------------------------------------
 
-from bitdust.crypt import encrypted
-from bitdust.crypt import key
+_StunClient = None
 
-#-------------------------------------------------------------------------------
+#------------------------------------------------------------------------------
 
 
-class backup(automat.Automat):
+def A(event=None, *args, **kwargs):
     """
-    A class to run the backup process, data is read from pipe.
+    Access method to interact with the state machine.
     """
-
-    timers = {
-        'timer-01sec': (0.1, ['RAID']),
-        'timer-001sec': (0.01, ['READ']),
-    }
-
-    def __init__(
-        self,
-        backupID,
-        pipe,
-        finishCallback=None,
-        blockResultCallback=None,
-        notifyNewDataCallback=None,
-        blockSize=None,
-        sourcePath=None,
-        keyID=None,
-        ecc_map=None,
-        creatorIDURL=None,
-    ):
-        self.backupID = backupID
-        self.creatorIDURL = creatorIDURL or my_id.getIDURL()
-        _parts = packetid.SplitBackupID(self.backupID)
-        self.customerGlobalID = _parts[0]
-        self.pathID = _parts[1]
-        self.version = _parts[2]
-        self.customerIDURL = global_id.GlobalUserToIDURL(self.customerGlobalID)
-        self.sourcePath = sourcePath
-        self.keyID = keyID
-        self.eccmap = ecc_map or eccmap.Current()
-        self.pipe = pipe
-        self.blockSize = blockSize
-        if self.blockSize is None:
-            self.blockSize = settings.getBackupBlockSize()
-        self.ask4abort = False
-        self.terminating = False
-        self.stateEOF = False
-        self.stateReading = False
-        self.closed = False
-        self.currentBlockData = BytesIO()
-        self.currentBlockSize = 0
-        self.workBlocks = {}
-        self.blockNumber = 0
-        self.dataSent = 0
-        self.blocksSent = 0
-        self.totalSize = -1
-        self.resultDefer = Deferred()
-        self.finishCallback = finishCallback
-        self.blockResultCallback = blockResultCallback
-        self.notifyNewDataCallback = notifyNewDataCallback
-        automat.Automat.__init__(
-            self,
-            name='backup_%s' % self.version,
+    global _StunClient
+    if event is None:
+        return _StunClient
+    if _StunClient is None:
+        # set automat name and starting state here
+        _StunClient = StunClient(
+            name='stun_client',
             state='AT_STARTUP',
             debug_level=_DebugLevel,
             log_events=_Debug,
             log_transitions=_Debug,
         )
+    if event is not None:
+        _StunClient.automat(event, *args, **kwargs)
+    return _StunClient
+
+
+class StunClient(automat.Automat):
+    """
+    This class implements all the functionality of the ``stun_client()`` state
+    machine.
+    """
+    # fast = True
+
+    timers = {
+        'timer-1sec': (1.0, ['REQUEST']),
+        'timer-2sec': (2.0, ['REQUEST']),
+        'timer-10sec': (10.0, ['PORT_NUM?', 'REQUEST']),
+    }
+
+    MESSAGES = {
+        'MSG_01': 'not found any DHT nodes',
+        'MSG_02': 'not found any available stun servers',
+        'MSG_03': 'timeout responding from stun servers',
+    }
+
+    def msg(self, msgid, *args, **kwargs):
+        return self.MESSAGES.get(msgid, '')
 
     def init(self):
-        """
-        """
-        self.log_transitions = _Debug
+        self.listen_port = None
+        self.callbacks = []
+        self.find_nodes_attempts = 1
+        self.minimum_needed_servers = 1
+        self.minimum_needed_results = 1
+        self.stun_nodes = []
+        self.stun_servers = []
+        self.stun_results = {}
+        self.my_address = None
+        self.deferreds = {}
+
+    def getMyExternalAddress(self):
+        return self.my_address
+
+    def dropMyExternalAddress(self):
+        self.my_address = None
 
     def A(self, event, *args, **kwargs):
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
-            if event == 'start':
-                self.state = 'READ'
+            if event == 'init':
+                self.state = 'STOPPED'
                 self.doInit(*args, **kwargs)
-                self.doFirstBlock(*args, **kwargs)
-        #---READ---
-        elif self.state == 'READ':
-            if event == 'read-success' and not self.isReadingNow(*args, **kwargs) and (self.isBlockReady(*args, **kwargs) or self.isEOF(*args, **kwargs)):
-                self.state = 'ENCRYPT'
-                self.doEncryptBlock(*args, **kwargs)
-            elif event == 'fail' or ((event == 'read-success' or event == 'timer-001sec') and self.isAborted(*args, **kwargs)):
-                self.state = 'ABORTED'
-                self.doClose(*args, **kwargs)
-                self.doReport(*args, **kwargs)
+        #---STOPPED---
+        elif self.state == 'STOPPED':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif (event == 'read-success' or event
-                  == 'timer-001sec') and not self.isAborted(*args, **kwargs) and self.isPipeReady(*args, **kwargs) and not self.isEOF(*args, **kwargs) and not self.isReadingNow(*args, **kwargs) and not self.isBlockReady(*args, **kwargs):
-                self.doRead(*args, **kwargs)
-            elif event == 'block-raid-done' and not self.isAborted(*args, **kwargs):
-                self.doPopBlock(*args, **kwargs)
-                self.doBlockReport(*args, **kwargs)
-                self.doNotifyNewData(*args, **kwargs)
-        #---RAID---
-        elif self.state == 'RAID':
-            if event == 'block-raid-done' and not self.isMoreBlocks(*args, **kwargs) and not self.isAborted(*args, **kwargs):
-                self.state = 'DONE'
-                self.doPopBlock(*args, **kwargs)
-                self.doBlockReport(*args, **kwargs)
-                self.doNotifyNewData(*args, **kwargs)
-                self.doClose(*args, **kwargs)
-                self.doReport(*args, **kwargs)
+            elif event == 'start':
+                self.state = 'RANDOM_NODES'
+                self.doAddCallback(*args, **kwargs)
+                self.doDHTFindRandomNode(*args, **kwargs)
+        #---REQUEST---
+        elif self.state == 'REQUEST':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'block-raid-started' and not self.isEOF(*args, **kwargs) and not self.isAborted(*args, **kwargs):
-                self.state = 'READ'
-                self.doNextBlock(*args, **kwargs)
-                self.doRead(*args, **kwargs)
-            elif event == 'block-raid-done' and self.isMoreBlocks(*args, **kwargs) and not self.isAborted(*args, **kwargs):
-                self.doPopBlock(*args, **kwargs)
-                self.doBlockReport(*args, **kwargs)
-                self.doNotifyNewData(*args, **kwargs)
-            elif event == 'fail' or ((event == 'timer-01sec' or event == 'block-raid-done' or event == 'block-raid-started') and self.isAborted(*args, **kwargs)):
-                self.state = 'ABORTED'
-                self.doClose(*args, **kwargs)
-                self.doReport(*args, **kwargs)
+            elif event == 'timer-2sec':
+                self.doStun(*args, **kwargs)
+            elif event == 'timer-10sec' and not self.isSomeServersResponded(*args, **kwargs):
+                self.state = 'STOPPED'
+                self.doReportFailed(self.msg('MSG_03', *args, **kwargs))
+                self.doClearResults(*args, **kwargs)
+            elif event == 'start':
+                self.doAddCallback(*args, **kwargs)
+            elif event == 'datagram-received' and self.isMyIPPort(*args, **kwargs) and self.isNeedMoreResults(*args, **kwargs):
+                self.doRecordResult(*args, **kwargs)
+            elif event == 'port-number-received':
+                self.doAddStunServer(*args, **kwargs)
+                self.doStun(*args, **kwargs)
+            elif (event == 'timer-1sec' and self.isSomeServersResponded(*args, **kwargs)) or (event == 'datagram-received' and self.isMyIPPort(*args, **kwargs) and not self.isNeedMoreResults(*args, **kwargs)):
+                self.state = 'KNOW_MY_IP'
+                self.doRecordResult(*args, **kwargs)
+                self.doReportSuccess(*args, **kwargs)
+                self.doClearResults(*args, **kwargs)
+        #---KNOW_MY_IP---
+        elif self.state == 'KNOW_MY_IP':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-        #---ENCRYPT---
-        elif self.state == 'ENCRYPT':
-            if event == 'block-encrypted':
-                self.state = 'RAID'
-                self.doBlockPushAndRaid(*args, **kwargs)
-            elif event == 'fail':
-                self.state = 'ABORTED'
-                self.doClose(*args, **kwargs)
-                self.doReport(*args, **kwargs)
+            elif event == 'start':
+                self.state = 'RANDOM_NODES'
+                self.doAddCallback(*args, **kwargs)
+                self.doDHTFindRandomNode(*args, **kwargs)
+        #---RANDOM_NODES---
+        elif self.state == 'RANDOM_NODES':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'block-raid-done' and not self.isAborted(*args, **kwargs):
-                self.doPopBlock(*args, **kwargs)
-                self.doBlockReport(*args, **kwargs)
-                self.doNotifyNewData(*args, **kwargs)
-        #---DONE---
-        elif self.state == 'DONE':
-            pass
-        #---ABORTED---
-        elif self.state == 'ABORTED':
+            elif event == 'dht-nodes-not-found':
+                self.state = 'STOPPED'
+                self.doReportFailed(self.msg('MSG_01', *args, **kwargs))
+            elif event == 'start':
+                self.doAddCallback(*args, **kwargs)
+            elif event == 'found-some-nodes' and self.isNeedMoreNodes(*args, **kwargs):
+                self.doRememberStunNodes(*args, **kwargs)
+                self.doDHTFindRandomNode(*args, **kwargs)
+            elif event == 'found-some-nodes' and not self.isNeedMoreNodes(*args, **kwargs):
+                self.state = 'PORT_NUM?'
+                self.doRememberStunNodes(*args, **kwargs)
+                self.doRequestStunPortNumbers(*args, **kwargs)
+        #---PORT_NUM?---
+        elif self.state == 'PORT_NUM?':
+            if event == 'start':
+                self.doAddCallback(*args, **kwargs)
+            elif event == 'timer-10sec':
+                self.state = 'STOPPED'
+                self.doReportFailed(self.msg('MSG_02', *args, **kwargs))
+                self.doClearResults(*args, **kwargs)
+            elif event == 'port-number-received':
+                self.state = 'REQUEST'
+                self.doAddStunServer(*args, **kwargs)
+                self.doStun(*args, **kwargs)
+            elif event == 'shutdown':
+                self.state = 'CLOSED'
+                self.doDestroyMe(*args, **kwargs)
+        #---CLOSED---
+        elif self.state == 'CLOSED':
             pass
         return None
 
-    def isAborted(self, *args, **kwargs):
+    def isMyIPPort(self, *args, **kwargs):
         """
-        Return current value of ``ask4abort`` flag.
+        Condition method.
         """
-        # if _Debug:
-        #     lg.args(_DebugLevel, ask4abort=self.ask4abort)
-        return self.ask4abort
+        try:
+            datagram, address = args[0]
+            command, payload = datagram
+        except:
+            return False
+        return command == udp.CMD_MYIPPORT
 
-    def isPipeReady(self, *args, **kwargs):
+    def isSomeServersResponded(self, *args, **kwargs):
         """
-        Return True if ``pipe`` object exist and is ready for reading a the new
-        chunk of data.
+        Condition method.
         """
-        if _Debug:
-            lg.args(_DebugLevel, pipe=bool(self.pipe), pipe_state=(self.pipe.state() if self.pipe else None))
-        if self.pipe is None:
-            lg.warn('pipe is None')
-            return False
-        return self.pipe.state() in [nonblocking.PIPE_CLOSED, nonblocking.PIPE_READY2READ]
-
-    def isBlockReady(self, *args, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, currentBlockSize=self.currentBlockSize, blockSize=self.blockSize)
-        return self.currentBlockSize >= self.blockSize
-
-    def isEOF(self, *args, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, stateEOF=self.stateEOF)
-        return self.stateEOF
+        return len(self.stun_results) > 0
 
-    def isReadingNow(self, *args, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, stateReading=self.stateReading)
-        return self.stateReading
+    def isNeedMoreResults(self, *args, **kwargs):
+        """
+        Condition method.
+        """
+        return len(self.stun_results) <= self.minimum_needed_results
 
-    def isMoreBlocks(self, *args, **kwargs):
+    def isNeedMoreNodes(self, *args, **kwargs):
         """
         Condition method.
         """
-        if _Debug:
-            lg.args(_DebugLevel, workBlocks=len(self.workBlocks))
-        return len(self.workBlocks) > 1
+        return len(self.stun_nodes) + len(*args, **kwargs) < self.minimum_needed_servers
 
     def doInit(self, *args, **kwargs):
         """
         Action method.
         """
-        events.send('backup-started', data=dict(backup_id=self.backupID))
+        self.listen_port = args[0]
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.doInit on port %d' % self.listen_port)
+        if udp.proto(self.listen_port):
+            udp.proto(self.listen_port).add_callback(self._datagram_received)
+        else:
+            lg.warn('udp port %s is not opened' % self.listen_port)
 
-    def doRead(self, *args, **kwargs):
+    def doAddCallback(self, *args, **kwargs):
         """
         Action method.
         """
-        def readChunk():
-            size = self.blockSize - self.currentBlockSize
-            if size < 0:
-                if _Debug:
-                    lg.args(_DebugLevel, eccmap_nodes=self.eccmap.nodes(), block_size=self.blockSize, current_block_size=self.currentBlockSize)
-                raise Exception('size < 0, blockSize=%s, currentBlockSize=%s' % (self.blockSize, self.currentBlockSize))
-            elif size == 0:
-                return succeed(b'')
-            if self.pipe is None:
-                raise Exception('backup.pipe is None')
-            if self.pipe.state() == 2:
-                if _Debug:
-                    lg.out(_DebugLevel, 'backup.readChunk the state is PIPE_CLOSED in %r' % self)
-                return succeed(b'')
-            if self.pipe.state() == 0:
-                if _Debug:
-                    lg.out(_DebugLevel, 'backup.readChunk the state is PIPE_EMPTY in %r' % self)
-                return succeed(b'')
-            if _Debug:
-                lg.args(_DebugLevel, size=size)
-            return self.pipe.read_defer(size)
-
-        def readDone(data):
-            try:
-                self.stateReading = False
-                self.currentBlockData.write(data)
-                self.currentBlockSize += len(data)
-            except:
-                lg.exc()
-                self.automat('fail', None)
-                return None
-            if not data:
-                self.stateEOF = True
-            if _Debug:
-                lg.out(_DebugLevel, 'backup.readDone %d bytes' % len(data))
-            reactor.callLater(0, self.automat, 'read-success')  # @UndefinedVariable
-            return data
-
-        def readFailed(err):
-            lg.err(err)
-            self.automat('fail', err)
-            return None
+        if args and args[0]:
+            self.callbacks.append(args[0])
 
-        self.stateReading = True
-        d = readChunk()
-        d.addCallback(readDone)
-        d.addErrback(readFailed)
-
-    def doEncryptBlock(self, *args, **kwargs):
+    def doDHTFindRandomNode(self, *args, **kwargs):
         """
         Action method.
         """
-        def _doBlock():
-            dt = time.time()
-            raw_bytes = self.currentBlockData.getvalue()
-            block = encrypted.Block(
-                CreatorID=self.creatorIDURL,
-                BackupID=self.backupID,
-                BlockNumber=self.blockNumber,
-                SessionKey=key.NewSessionKey(session_key_type=key.SessionKeyType()),
-                SessionKeyType=key.SessionKeyType(),
-                LastBlock=self.stateEOF,
-                Data=raw_bytes,
-                EncryptKey=self.keyID,
-            )
-            del raw_bytes
-            if _Debug:
-                lg.out(_DebugLevel, 'backup.doEncryptBlock blockNumber=%d size=%d atEOF=%s dt=%s EncryptKey=%s' % (self.blockNumber, self.currentBlockSize, self.stateEOF, str(time.time() - dt), self.keyID))
-            return block
-
-        d = maybeDeferred(_doBlock)
-        d.addCallback(lambda block: self.automat('block-encrypted', block))
-        d.addErrback(lambda err: self.automat('fail', err))
+        self._find_random_node()
 
-    def doBlockPushAndRaid(self, *args, **kwargs):
+    def doRememberStunNodes(self, *args, **kwargs):
         """
         Action method.
         """
-        newblock = args[0]
-        if newblock is None:
-            self.abort()
-            self.automat('fail')
-            if _Debug:
-                lg.out(_DebugLevel, 'backup.doBlockPushAndRaid ERROR newblock is empty, terminating=%s' % self.terminating)
-            lg.warn('failed to encrypt block, ABORTING')
-            return
-        if self.terminating:
-            self.automat('block-raid-done', (newblock.BlockNumber, None))
-            if _Debug:
-                lg.out(_DebugLevel, 'backup.doBlockPushAndRaid SKIP, terminating=True')
-            return
-        fileno, filename = tmpfile.make('raid', extension='.raid')
-        serializedblock = newblock.Serialize()
-        blocklen = len(serializedblock)
-        os.write(fileno, strng.to_bin(blocklen) + b':' + serializedblock)
-        os.close(fileno)
-        self.workBlocks[newblock.BlockNumber] = filename
-        dt = time.time()
-        outputpath = os.path.join(settings.getLocalBackupsDir(), self.customerGlobalID, self.pathID, self.version)
-        task_params = (filename, self.eccmap.name, self.version, newblock.BlockNumber, outputpath)
-        raid_worker.add_task('make', task_params, lambda cmd, params, result: self._raidmakeCallback(params, result, dt))
-        self.automat('block-raid-started', newblock)
-        del serializedblock
-        if _Debug:
-            lg.out(_DebugLevel, 'backup.doBlockPushAndRaid %s : start process data from %s to %s, %d' % (newblock.BlockNumber, filename, outputpath, id(self.terminating)))
+        nodes = args[0]
+        for node in nodes:
+            if node not in self.stun_nodes:
+                self.stun_nodes.append(node)
 
-    def doPopBlock(self, *args, **kwargs):
+    def doRequestStunPortNumbers(self, *args, **kwargs):
         """
         Action method.
         """
-        blockNumber, _ = args[0]
-        filename = self.workBlocks.pop(blockNumber)
-        tmpfile.throw_out(filename, 'block raid done')
+        if _Debug:
+            lg.out(_DebugLevel + 4, 'stun_client.doRequestStunPortNumbers')
+        for node in self.stun_nodes:
+            if node.id in self.deferreds:
+                lg.warn('Already requested stun_port from %r' % node)
+                continue
+            if _Debug:
+                lg.out(_DebugLevel + 4, '    from %s' % node)
+            d = node.request('stun_port')
+            d.addBoth(self._stun_port_received, node)
+            self.deferreds[node.id] = d
 
-    def doFirstBlock(self, *args, **kwargs):
+    def doAddStunServer(self, *args, **kwargs):
         """
         Action method.
         """
-        self.dataSent = 0
-        self.blocksSent = 0
-        self.blockNumber = 0
-        self.currentBlockSize = 0
-        self.currentBlockData = BytesIO()
+        if _Debug:
+            lg.out(_DebugLevel + 4, 'stun_client.doAddStunServer %s' % str(*args, **kwargs))
+        self.stun_servers.append(args[0])
 
-    def doNextBlock(self, *args, **kwargs):
+    def doStun(self, *args, **kwargs):
         """
         Action method.
         """
-        self.dataSent += self.currentBlockSize
-        self.blocksSent += 1
-        self.blockNumber += 1
-        self.currentBlockSize = 0
-        self.currentBlockData.close()
-        self.currentBlockData = BytesIO()
+        if args and args[0] is not None:
+            if _Debug:
+                lg.out(_DebugLevel + 4, 'stun_client.doStun to one stun_server: %s' % str(*args, **kwargs))
+            udp.send_command(self.listen_port, udp.CMD_STUN, b'', *args, **kwargs)
+            return
+        if _Debug:
+            lg.out(_DebugLevel + 4, 'stun_client.doStun to %d stun_servers' % (len(self.stun_servers)))  # , self.stun_servers))
+        for address in self.stun_servers:
+            if address is None:
+                continue
+            if address in list(self.stun_results.keys()):
+                continue
+            udp.send_command(self.listen_port, udp.CMD_STUN, b'', address)
 
-    def doBlockReport(self, *args, **kwargs):
+    def doRecordResult(self, *args, **kwargs):
         """
         Action method.
         """
-        BlockNumber, result = args[0]
-        if self.blockResultCallback:
-            self.blockResultCallback(self.backupID, BlockNumber, result)
+        if not args or args[0] is None:
+            return
+        try:
+            datagram, address = args[0]
+            command, payload = datagram
+            ip, port = payload.split(b':')
+            port = int(port)
+        except:
+            lg.exc()
+        self.stun_results[address] = (ip, port)
+        # if len(self.stun_results) >= len(self.stun_servers):
+        #     self.automat('all-responded')
 
-    def doNotifyNewData(self, *args, **kwargs):
+    def doClearResults(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.notifyNewDataCallback:
-            self.notifyNewDataCallback()
+        self.stun_nodes = []
+        self.stun_servers = []
+        self.stun_results = {}
 
-    def doClose(self, *args, **kwargs):
+    def doReportSuccess(self, *args, **kwargs):
         """
         Action method.
         """
-        self.closed = True
-        for filename in self.workBlocks.values():
-            tmpfile.throw_out(filename, 'backup aborted')
+        try:
+            min_port = min([addr[1] for addr in list(self.stun_results.values())])
+            max_port = max([addr[1] for addr in list(self.stun_results.values())])
+            my_ip = strng.to_text(list(self.stun_results.values())[0][0])
+            if min_port == max_port:
+                result = ('stun-success', 'non-symmetric', my_ip, min_port)
+            else:
+                result = ('stun-success', 'symmetric', my_ip, self.stun_results)
+            self.my_address = (my_ip, min_port)
+        except:
+            lg.exc()
+            result = ('stun-failed', None, None, [])
+            self.my_address = None
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.doReportSuccess based on %d nodes: %r' % (len(self.stun_results), result))
+        if self.my_address:
+            current_external_ip = misc.readExternalIP()
+            if current_external_ip != self.my_address[0]:
+                events.send('my-external-ip-changed', data=dict(
+                    old=current_external_ip,
+                    new=self.my_address[0],
+                ))
+            bpio.WriteTextFile(settings.ExternalIPFilename(), self.my_address[0])
+            bpio.WriteTextFile(settings.ExternalUDPPortFilename(), str(self.my_address[1]))
+        for cb in self.callbacks:
+            cb(result[0], result[1], result[2], result[3])
+        self.callbacks = []
 
-    def doReport(self, *args, **kwargs):
+    def doReportFailed(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.ask4abort:
-            if self.finishCallback:
-                self.finishCallback(self.backupID, 'abort')
-            self.resultDefer.callback('abort')
-            events.send('backup-aborted', data=dict(backup_id=self.backupID, source_path=self.sourcePath))
-        else:
-            if self.finishCallback:
-                self.finishCallback(self.backupID, 'done')
-            self.resultDefer.callback('done')
-            events.send('backup-done', data=dict(backup_id=self.backupID, source_path=self.sourcePath))
+        self.my_address = None
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.doReportFailed : %s' % args[0])
+        for cb in self.callbacks:
+            cb('stun-failed', None, None, [])
+        self.callbacks = []
 
     def doDestroyMe(self, *args, **kwargs):
         """
         Action method.
         """
-        self._kill_pipe()
-        self.eccmap = None
-        self.pipe = None
-        self.ask4abort = False
-        self.terminating = False
-        self.stateEOF = False
-        self.stateReading = False
-        self.closed = False
-        self.workBlocks = None
-        self.resultDefer = None
-        self.finishCallback = None
-        self.blockResultCallback = None
-        self.currentBlockData.close()
-        del self.currentBlockData
+        global _StunClient
+        _StunClient = None
+        for d in list(self.deferreds.values()):
+            if d and not d.called:
+                d.cancel()
+        self.deferreds.clear()
+        if udp.proto(self.listen_port):
+            udp.proto(self.listen_port).remove_callback(self._datagram_received)
         self.destroy()
-        collected = gc.collect()
-        if _Debug:
-            lg.out(_DebugLevel, 'backup.doDestroyMe [%s] collected %d objects' % (self.backupID, collected))
 
-    def abort(self):
-        """
-        This method should stop this backup by killing the pipe process.
-        """
+    def _datagram_received(self, datagram, address):
+        self.automat('datagram-received', (
+            datagram,
+            address,
+        ))
+        return False
+
+    def _find_random_nodes(self, tries, result_list, prev_key=None):
+        if prev_key and prev_key in self.deferreds:
+            self.deferreds.pop(prev_key)
         if _Debug:
-            lg.out(_DebugLevel, 'backup.abort id %s, %d' % (str(self.backupID), id(self.ask4abort)))
-        self.terminating = True
-        for blockNumber, filename in self.workBlocks.items():
-            lg.warn('aborting raid make worker for block %d in %s' % (blockNumber, filename))
-            raid_worker.cancel_task('make', filename)
-        lg.warn('killing backup pipe')
-        self.ask4abort = True
-        self._kill_pipe()
+            lg.out(_DebugLevel + 4, 'stun_client._find_random_nodes tries=%d result_list=%d' % (tries, len(result_list)))
+        if tries <= 0 or len(result_list) >= self.minimum_needed_servers:
+            if len(result_list) > 0:
+                self.automat('found-some-nodes', result_list)
+            else:
+                self.automat('dht-nodes-not-found')
+            return
+        from bitdust.dht import dht_service
+        new_key = dht_service.random_key()
+        d = dht_service.find_node(new_key)
+        d.addCallback(lambda nodes: self._find_random_nodes(tries - 1, list(set(result_list + nodes)), new_key))
+        d.addErrback(lambda x: self._find_random_nodes(tries - 1, result_list, new_key))
+        self.deferreds[new_key] = d
 
-    def progress(self):
-        """
-        """
-        if self.totalSize <= 0:
-            return 0.0
-        percent = min(100.0, 100.0*self.dataSent/self.totalSize)
-        return percent
+    def _find_random_node(self):
+        if _Debug:
+            lg.out(_DebugLevel + 4, 'stun_client._find_random_node')
+        from bitdust.dht import dht_service
+        new_key = dht_service.random_key()
+        d = dht_service.find_node(new_key)
+        d.addCallback(self._some_nodes_found)
+        d.addErrback(self._nodes_not_found)
+        # self.deferreds[new_key] = d
 
-    def _raidmakeCallback(self, params, result, dt):
-        _, _, _, blockNumber, _ = params
-        if result is None:
-            if _Debug:
-                lg.out(_DebugLevel, 'backup._raidmakeCallback WARNING - result is None :  %r eof=%s dt=%s' % (blockNumber, str(self.stateEOF), str(time.time() - dt)))
-            events.send('backup-raidmake-failed', data=dict(backup_id=self.backupID))
-            self.ask4abort = True
-            self._kill_pipe()
+    def _some_nodes_found(self, nodes):
+        if _Debug:
+            lg.out(_DebugLevel + 4, 'stun_client._some_nodes_found : %r' % nodes)
+        if nodes and len(nodes) > 0:
+            self.automat('found-some-nodes', nodes)
         else:
-            if _Debug:
-                lg.out(_DebugLevel, 'backup._raidmakeCallback %r %r eof=%s dt=%s' % (blockNumber, result, str(self.stateEOF), str(time.time() - dt)))
-            self.automat('block-raid-done', (blockNumber, result))
+            self.automat('dht-nodes-not-found')
+
+    def _nodes_not_found(self, err):
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client._nodes_not_found err=%s' % str(err))
+        self.automat('dht-nodes-not-found')
 
-    def _kill_pipe(self):
-        if self.pipe:
+    def _stun_port_received(self, result, node):
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client._stun_port_received  %r from %s node_id=%r' % (result, node, node.id))
+        self.deferreds.pop(node.id, None)
+        if not isinstance(result, dict):
             if _Debug:
-                lg.out(_DebugLevel, 'backup._kill_pipe for %s' % self.backupID)
-            try:
-                self.pipe.kill()
-            except:
-                lg.exc()
+                lg.dbg(_DebugLevel, 'empty result received from node %r : %r' % (node, result))
+            return
+        try:
+            port = int(strng.to_text(result['stun_port']))
+            address = node.address
+        except:
+            lg.exc()
+            return
+        if port == 0:
+            return
+        if _Debug:
+            lg.out(_DebugLevel, '        new stun port server found  %s:%s' % (address, port))
+        self.automat('port-number-received', (address, port))
 
 
 #------------------------------------------------------------------------------
 
 
-def main():
-    from bitdust.system import bpio
-    from bitdust.storage import backup_tar
+def udp_dht_stun(udp_port=None, dht_port=None, result_defer=None):
+    if not driver.is_on('service_my_ip_port'):
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   SKIP because service_my_ip_port() is not started')
+        if result_defer:
+            result_defer.errback(Exception('service_my_ip_port() is not started'))
+        return False
 
-    bpio.init()
-    settings.init()
+    from bitdust.dht import dht_service
+
+    if dht_service.node().connectingTask() and not dht_service.node().connectingTask().called:
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   SKIP and run later because dht_service is still joining the network')
+        dht_service.node().connectingTask().addCallback(lambda ok: udp_dht_stun(udp_port=udp_port, dht_port=dht_port, result_defer=result_defer))
+        if result_defer:
+            dht_service.node().connectingTask().addErrback(result_defer.errback)
+        return True
+
+    dht_port = dht_port or settings.getDHTPort()
+    udp_port = udp_port or settings.getUDPPort()
+    if udp_port:
+        udp.listen(udp_port)
+    if dht_port:
+        dht_service.init(dht_port)
+    d = dht_service.connect()
+
+    def _cb(cod, typ, ip, details):
+        # A('shutdown')
+        ret = {
+            'result': cod,  # 'stun-success' or 'stun-failed'
+            'type': typ,
+            'ip': ip,
+            'details': details,
+        }
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   result : %r' % ret)
+        result_defer.callback(ret)
+        return None
 
-    lg.set_debug_level(24)
-    lg.life_begins()
+    def _go(live_nodes):
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   GO with nodes: %r' % live_nodes)
+        A('init', udp_port)
+        A('start', _cb)
+        return live_nodes
+
+    d.addCallback(_go)
+    if result_defer:
+        d.addErrback(result_defer.errback)
+        # d.addErrback(lambda err: result_defer.callback(dict(ip='127.0.0.1', errors=[str(err), ])))
+    return True
+
+
+def http_stun(result_defer=None):
+    from bitdust.userid import known_servers
+    identity_servers = known_servers.by_host()
+    if not identity_servers:
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.http_stun   SKIP, no known identity servers found')
+        return False
+    one_host = random.choice(list(identity_servers.keys()))
+    one_port = identity_servers[one_host][0]
+    one_url = nameurl.UrlMake('http', one_host, one_port)
+    if _Debug:
+        lg.out(_DebugLevel, 'stun_client.http_stun   GO with one node : %r' % one_url)
+
+    def _check_body(html_response):
+        ret = {
+            'result': 'stun-failed',
+            'type': None,
+            'ip': None,
+            'details': ['unknown client host from response'],
+        }
+        mo = re.search(b'\<\!\-\-CLIENT_HOST\=([\d\.]+):(\d+)\-\-\>', html_response)
+        if not mo:
+            if _Debug:
+                lg.out(_DebugLevel, 'stun_client.http_stun   FAILED : unknown client host from response')
+            if result_defer:
+                result_defer.callback(ret)
+            return None
+        ret = {
+            'result': 'stun-success',
+            'type': 'unknown',
+            'ip': strng.to_text(mo.group(1)),
+            'details': [],
+        }
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.http_stun   SUCCESS : %r' % ret)
+        if result_defer:
+            result_defer.callback(ret)
+        return None
 
-    automat.LifeBegins(lg.when_life_begins())
-    automat.OpenLogFile(settings.AutomatsLog())
+    def _request_failed(err):
+        if _Debug:
+            lg.out(_DebugLevel, 'stun_client.http_stun   FAILED : %r' % err)
+        ret = {
+            'result': 'stun-failed',
+            'type': None,
+            'ip': None,
+            'details': [err.getErrorMessage()],
+        }
+        if result_defer:
+            result_defer.callback(ret)
+        return None
 
-    key.InitMyKey()
-    my_id.init()
+    d = net_misc.getPageTwisted(one_url)
+    d.addCallback(_check_body)
+    d.addErrback(_request_failed)
+    return True
 
-    sourcePath = sys.argv[1]
-    compress_mode = 'bz2'
-    backupID = sys.argv[2]
-    raid_worker.A('init')
-
-    if bpio.pathIsDir(sourcePath):
-        backupPipe = backup_tar.backuptardir_thread(sourcePath, compress=compress_mode)
-    else:
-        backupPipe = backup_tar.backuptarfile_thread(sourcePath, compress=compress_mode)
-
-    def _bk_done(bid, result):
-        from bitdust.crypt import signed
-        customer, remotePath = packetid.SplitPacketID(bid)
-        try:
-            os.mkdir(os.path.join(settings.getLocalBackupsDir(), customer, remotePath + '.out'))
-        except:
-            pass
-        for filename in os.listdir(os.path.join(settings.getLocalBackupsDir(), customer, remotePath)):
-            filepath = os.path.join(settings.getLocalBackupsDir(), customer, remotePath, filename)
-            payld = bpio.ReadBinaryFile(filepath)
-            newpacket = signed.Packet('Data', my_id.getIDURL(), my_id.getIDURL(), filename, payld, 'http://megafaq.ru/cvps1010.xml')
-            newfilepath = os.path.join(settings.getLocalBackupsDir(), customer, remotePath + '.out', filename)
-            bpio.WriteBinaryFile(newfilepath, newpacket.Serialize())
-
-    def _bk_closed(*args, **kwargs):
-        # job.automat('fail')
-        # del job
+
+def safe_stun(udp_port=None, dht_port=None, result_defer=None):
+    from twisted.internet.defer import Deferred
+    result = result_defer or Deferred()
+
+    def _check_response(response):
+        if response.get('result') == 'stun-success':
+            result.callback(response)
+            return None
+        http_stun(result_defer=result)
+        return None
+
+    def _fallback(err):
+        http_stun(result_defer=result)
+        return None
+
+    first_result = Deferred()
+    first_result.addCallback(_check_response)
+    first_result.addErrback(_fallback)
+    udp_dht_stun(udp_port, dht_port, result_defer=first_result)
+    return result
+
+
+def test_safe_stun():
+    from twisted.internet import reactor  # @UnresolvedImport
+
+    def _cb(res):
+        print(res)
         reactor.stop()  # @UndefinedVariable
 
-    def _bk_start():
-        job = backup(backupID, backupPipe, blockSize=16*1024*1024)
-        job.finishCallback = _bk_done  # lambda bid, result: _bk_done(bid, result, job)
-        job.addStateChangedCallback(_bk_closed, oldstate=None, newstate='DONE')
-        reactor.callLater(1, job.automat, 'start')  # @UndefinedVariable
+    def _eb(err):
+        print(err)
+        reactor.stop()  # @UndefinedVariable
 
-    reactor.callLater(0, _bk_start)  # @UndefinedVariable
+    lg.set_debug_level(30)
+    safe_stun().addCallbacks(_cb, _eb)
+    reactor.run()  # @UndefinedVariable
+
+
+#------------------------------------------------------------------------------
+
+
+def main():
+    from twisted.internet import reactor  # @UnresolvedImport
+    from bitdust.dht import dht_service
+    settings.init()
+    lg.set_debug_level(30)
+    dht_port = settings.getDHTPort()
+    udp_port = settings.getUDPPort()
+    if len(sys.argv) > 1:
+        dht_port = int(sys.argv[1])
+    if len(sys.argv) > 2:
+        udp_port = int(sys.argv[2])
+    dht_service.init(dht_port)
+    dht_service.connect()
+    udp.listen(udp_port)
+
+    def _cb(result, typ, ip, details):
+        print(result, typ, ip, details)
+        A('shutdown')
+        reactor.stop()  # @UndefinedVariable
+
+    A('init', (udp_port))
+    A('start', _cb)
     reactor.run()  # @UndefinedVariable
     settings.shutdown()
 
 
+#------------------------------------------------------------------------------
+
 if __name__ == '__main__':
-    main()
+    from twisted.internet.defer import setDebugging
+    setDebugging(True)
+    # main()
+    test_safe_stun()
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_control.py` & `bitdust-0.1.9.241/bitdust/storage/backup_control.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_fs.py` & `bitdust-0.1.9.241/bitdust/storage/backup_fs.py`

 * *Files 0% similar despite different names*

```diff
@@ -343,17 +343,19 @@
     return _SizeBackups
 
 
 #------------------------------------------------------------------------------
 
 
 class FSItemInfo():
+
     """
     A class to represent a remote file or folder.
     """
+
     def __init__(self, name='', path_id='', typ=UNKNOWN, key_id=None):
         self.unicodename = strng.to_text(name)
         self.path_id = path_id
         self.type = typ
         self.size = -1
         self.key_id = key_id
         self.versions = {}
@@ -715,14 +717,15 @@
 
 
 def AddLocalPath(localpath, read_stats=False, iter=None, iterID=None, key_id=None):
     """
     Operates like ``AddDir()`` but also recursively reads the entire folder and
     put all items in the index. Parameter ``localpath`` can be a file or folder path.
     """
+
     def recursive_read_dir(local_path, path_id, iter, iterID):
         c = 0
         lastID = -1
         path = bpio.portablePath(local_path)
         if not os.access(path, os.R_OK):
             return c
         for localname in bpio.list_dir_safe(path):
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_matrix.py` & `bitdust-0.1.9.241/bitdust/storage/backup_matrix.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_monitor.py` & `bitdust-0.1.9.241/bitdust/storage/backup_monitor.py`

 * *Files 0% similar despite different names*

```diff
@@ -145,14 +145,15 @@
         return
     _BackupMonitor.destroy()
     del _BackupMonitor
     _BackupMonitor = None
 
 
 class BackupMonitor(automat.Automat):
+
     """
     A class to monitor backups and manage rebuilding process.
     """
 
     timers = {
         'timer-5sec': (5.0, ['READY']),
     }
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_rebuilder.py` & `bitdust-0.1.9.241/bitdust/storage/backup_rebuilder.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_schedule.py` & `bitdust-0.1.9.241/bitdust/storage/backup_schedule.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/backup_tar.py` & `bitdust-0.1.9.241/bitdust/storage/backup_tar.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/index_synchronizer.py` & `bitdust-0.1.9.241/bitdust/storage/index_synchronizer.py`

 * *Files 0% similar despite different names*

```diff
@@ -82,15 +82,15 @@
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 16
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import time
 
 from twisted.internet import reactor  # @UnresolvedImport
 
@@ -174,14 +174,15 @@
     return _IndexSynchronizer
 
 
 #------------------------------------------------------------------------------
 
 
 class IndexSynchronizer(automat.Automat):
+
     """
     This class implements all the functionality of the ``index_synchronizer()``
     state machine.
     """
 
     fast = False
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/keys_synchronizer.py` & `bitdust-0.1.9.241/bitdust/storage/keys_synchronizer.py`

 * *Files 6% similar despite different names*

```diff
@@ -120,14 +120,15 @@
     return _KeysSynchronizer
 
 
 #------------------------------------------------------------------------------
 
 
 class KeysSynchronizer(automat.Automat):
+
     """
     This class implements all the functionality of ``keys_synchronizer()`` state machine.
     """
 
     fast = False
 
     def init(self):
@@ -240,21 +241,23 @@
             self.result_callbacks.append(args[0])
 
     def doCheckAndRun(self, *args, **kwargs):
         """
         Action method.
         """
         from bitdust.customer import list_files_orator
-        if list_files_orator.A().state in [
-            'SAW_FILES',
-            'NO_FILES',
-        ]:
+        from bitdust.customer import fire_hire
+        from bitdust.storage import backup_monitor
+        list_files_orator_is_ready = list_files_orator.A().state == 'SAW_FILES'
+        backup_monitor_is_ready = backup_monitor.A().state == 'READY'
+        fire_hire_is_ready = fire_hire.A().state == 'READY'
+        if list_files_orator_is_ready and backup_monitor_is_ready and fire_hire_is_ready:
             self.automat('run')
         else:
-            reactor.callLater(1, self.automat, 'sync')  # @UndefinedVariable
+            reactor.callLater(5, self.automat, 'sync')  # @UndefinedVariable
 
     def doPrepare(self, *args, **kwargs):
         """
         Action method.
         """
         self.restored_count = 0
         self.saved_count = 0
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/restore_monitor.py` & `bitdust-0.1.9.241/bitdust/storage/restore_monitor.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/storage/restore_worker.py` & `bitdust-0.1.9.241/bitdust/storage/restore_worker.py`

 * *Files 0% similar despite different names*

```diff
@@ -129,14 +129,15 @@
 from bitdust.userid import id_url
 from bitdust.userid import my_id
 
 #------------------------------------------------------------------------------
 
 
 class RestoreWorker(automat.Automat):
+
     """
     This class implements all the functionality of ``restore_worker()`` state machine.
     """
 
     timers = {
         'timer-5sec': (5.0, ['REQUESTED']),
     }
```

### Comparing `bitdust-0.1.8.234/bitdust/storage/tar_file.py` & `bitdust-0.1.9.241/bitdust/storage/tar_file.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stream/__init__.py` & `bitdust-0.1.9.241/bitdust/stream/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stream/data_receiver.py` & `bitdust-0.1.9.241/bitdust/stream/data_receiver.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stream/data_sender.py` & `bitdust-0.1.9.241/bitdust/stream/data_sender.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stream/file_down.py` & `bitdust-0.1.9.241/bitdust/stream/file_down.py`

 * *Files 0% similar despite different names*

```diff
@@ -116,15 +116,15 @@
         self.fileName = fileName
         self.ownerID = ownerID
         self.remoteID = remoteID
         self.requestTime = None
         self.fileReceivedTime = None
         self.requestTimeout = max(30, 2*int(settings.getBackupBlockSize()/settings.SendingSpeedLimit()))
         self.result = ''
-        self.created = utime.get_sec1970()
+        self.created = utime.utcnow_to_sec1970()
         super(FileDown, self).__init__(
             name='file_down_%s_%s/%s/%s' % (nameurl.GetName(self.remoteID), remotePath, versionName, fileName), state='AT_STARTUP', debug_level=debug_level, log_events=log_events, log_transitions=log_transitions,
             publish_events=publish_events, **kwargs
         )
 
     def A(self, event, *args, **kwargs):
         """
```

### Comparing `bitdust-0.1.8.234/bitdust/stream/file_up.py` & `bitdust-0.1.9.241/bitdust/stream/file_up.py`

 * *Files 2% similar despite different names*

```diff
@@ -125,15 +125,15 @@
         self.ownerID = ownerID
         self.callOnAck = callOnAck
         self.callOnFail = callOnFail
         self.sendTime = None
         self.ackTime = None
         self.sendTimeout = 10*2*(max(int(self.fileSize/settings.SendingSpeedLimit()), 5) + 5)  # maximum 5 seconds to get an Ack
         self.result = ''
-        self.created = utime.get_sec1970()
+        self.created = utime.utcnow_to_sec1970()
         super(FileUp, self).__init__(
             name='file_up_%s_%s/%s/%s' % (nameurl.GetName(self.remoteID), remotePath, versionName, fileName), state='AT_STARTUP', debug_level=debug_level, log_events=log_events, log_transitions=log_transitions,
             publish_events=publish_events, **kwargs
         )
 
     def A(self, event, *args, **kwargs):
         """
```

### Comparing `bitdust-0.1.8.234/bitdust/stream/io_throttle.py` & `bitdust-0.1.9.241/bitdust/stream/io_throttle.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stream/message.py` & `bitdust-0.1.9.241/bitdust/stream/message.py`

 * *Files 1% similar despite different names*

```diff
@@ -190,20 +190,22 @@
         lg.warn('callback method not exist')
 
 
 #------------------------------------------------------------------------------
 
 
 class PrivateMessage(object):
+
     """
     A class to represent a message.
 
     We always encrypt messages with a session key so we need to package
     with encrypted body.
     """
+
     def __init__(self, recipient, sender=None, encrypted_session=None, encrypted_body=None):
         self.sender = strng.to_text(sender or my_id.getGlobalID(key_alias='master'))
         self.recipient = strng.to_text(recipient)
         self.encrypted_session = encrypted_session
         self.encrypted_body = encrypted_body
 
     def __str__(self):
@@ -303,14 +305,15 @@
         return message_obj
 
 
 #------------------------------------------------------------------------------
 
 
 class GroupMessage(PrivateMessage):
+
     def __str__(self):
         return 'GroupMessage(%s->%s)' % (
             self.sender,
             self.recipient,
         )
 
 
@@ -324,16 +327,14 @@
     global _IncomingMessageCallbacks
     if _Debug:
         lg.out(_DebugLevel, 'message.on_incoming_message new PrivateMessage %r from %s' % (request.PacketID, request.OwnerID))
     private_message_object = PrivateMessage.deserialize(request.Payload)
     if private_message_object is None:
         lg.err('PrivateMessage deserialize failed, can not extract message from request payload of %d bytes' % len(request.Payload))
         return False
-    # if request.PacketID.startswith('queue_'):
-    #     queue_id, unique_id = packetid.SplitQueueMessagePacketID(request.PacketID)
     try:
         decrypted_message = private_message_object.decrypt()
         json_message = serialization.BytesToDict(
             decrypted_message,
             unpack_types=True,
             encoding='utf-8',
         )
@@ -613,24 +614,26 @@
 #------------------------------------------------------------------------------
 
 
 def push_message(direction, msg_type, recipient_id, sender_id, packet_id, owner_idurl, json_message, run_consumers=True):
     for consumers_callback_id in consumers_callbacks().keys():
         if consumers_callback_id not in message_queue():
             message_queue()[consumers_callback_id] = []
-        message_queue()[consumers_callback_id].append({
-            'type': msg_type,
-            'dir': direction,
-            'to': recipient_id,
-            'from': sender_id,
-            'data': json_message,
-            'packet_id': packet_id,
-            'owner_idurl': owner_idurl,
-            'time': utime.get_sec1970(),
-        })
+        message_queue()[consumers_callback_id].append(
+            {
+                'type': msg_type,
+                'dir': direction,
+                'to': recipient_id,
+                'from': sender_id,
+                'data': json_message,
+                'packet_id': packet_id,
+                'owner_idurl': owner_idurl,
+                'time': utime.utcnow_to_sec1970(),
+            }
+        )
         if _Debug:
             lg.args(_DebugLevel, dir=direction, msg_type=msg_type, to_id=recipient_id, from_id=sender_id, cb=consumers_callback_id, pending=len(message_queue()[consumers_callback_id]))
     if not run_consumers:
         return 0
     total_consumed = do_read()
     return total_consumed > 0
 
@@ -640,16 +643,14 @@
 
 def push_incoming_message(request, private_message_object, json_message):
     msg_type = None
     if request.PacketID.startswith('private_'):
         msg_type = 'private_message'
     if request.PacketID.startswith('queue_'):
         msg_type = 'queue_message'
-    elif request.PacketID.startswith('qreplica_'):
-        msg_type = 'queue_message_replica'
     if msg_type is None:
         raise Exception('undefined message type detected in %r' % request)
     return push_message(
         direction='incoming',
         msg_type=msg_type,
         recipient_id=private_message_object.recipient_id(),
         sender_id=private_message_object.sender_id(),
@@ -659,28 +660,28 @@
     )
 
 
 def push_outgoing_message(json_message, private_message_object, remote_identity, request, result):
     msg_type = 'private_message'
     if request.PacketID.startswith('queue_'):
         msg_type = 'queue_message'
-    elif request.PacketID.startswith('qreplica_'):
-        msg_type = 'queue_message_replica'
     return push_message(
         direction='outgoing',
         msg_type=msg_type,
         recipient_id=private_message_object.recipient_id(),
         sender_id=private_message_object.sender_id(),
         packet_id=request.PacketID,
         owner_idurl=request.OwnerID,
         json_message=json_message,
     )
 
 
 def push_group_message(json_message, direction, group_key_id, producer_id, sequence_id):
+    if _Debug:
+        lg.args(_DebugLevel, group_key_id=group_key_id, producer_id=producer_id, sequence_id=sequence_id)
     return push_message(
         direction=direction,
         msg_type='group_message',
         recipient_id=group_key_id,
         sender_id=producer_id,
         packet_id=sequence_id,
         owner_idurl=None,
```

### Comparing `bitdust-0.1.8.234/bitdust/stream/message_producer.py` & `bitdust-0.1.9.241/bitdust/stream/message_producer.py`

 * *Files 0% similar despite different names*

```diff
@@ -500,15 +500,15 @@
             lg.exc()
             raise Exception('message encryption failed')
         encrypted_payload = private_message_object.serialize()
         d = message.send_message(
             json_data={
                 'msg_type': 'queue_message',
                 'action': 'produce',
-                'created': utime.get_sec1970(),
+                'created': utime.utcnow_to_sec1970(),
                 'payload': encrypted_payload,
                 'queue_id': self.active_queue_id,
                 'producer_id': self.producer_id,
             },
             recipient_global_id=self.active_broker_id,
             packet_id=packetid.MakeQueueMessagePacketID(self.active_queue_id, packet_id),
             message_ack_timeout=config.conf().getInt('services/private-groups/message-ack-timeout'),
```

### Comparing `bitdust-0.1.8.234/bitdust/stream/p2p_queue.py` & `bitdust-0.1.9.241/bitdust/stream/p2p_queue.py`

 * *Files 2% similar despite different names*

```diff
@@ -647,15 +647,15 @@
     if len(queue(queue_id)) >= MAX_QUEUE_LENGTH:
         raise P2PQueueIsOverloaded('queue is overloaded')
     producer(producer_id).produced_messages += 1
     new_message = QueueMessage(producer_id, queue_id, data, created=creation_time)
     queue(queue_id)[new_message.message_id] = new_message
     queue(queue_id)[new_message.message_id].state = 'PUSHED'
     if _Debug:
-        lg.out(_DebugLevel, 'p2p_queue.write_message  %r added to queue %s with %r' % (new_message.message_id, queue_id, data))
+        lg.out(_DebugLevel, 'p2p_queue.write_message  %r added to queue %s' % (new_message.message_id, queue_id))
     touch_queues()
     return new_message
 
 
 def pull_message(queue_id, message_id=None):
     if not valid_queue_id(queue_id):
         raise Exception('invalid queue id')
@@ -967,20 +967,15 @@
                 matching = False
                 for interested_queue in interested_queues_list:
                     if _queue_id.startswith(interested_queue):
                         matching = True
                         break
                 if not matching:
                     continue
-            do_notify(
-                callback_method,
-                _consumer_id,
-                _queue_id,
-                _message_id,
-            )
+            do_notify(callback_method, _consumer_id, _queue_id, _message_id)
             notifications_count += 1
             consumers_affected.append(_consumer_id)
             break
     if _Debug:
         lg.args(_DebugLevel, notifications_count=notifications_count, consumers_affected=consumers_affected)
     del to_be_consumed
     del consumers_affected
@@ -1002,53 +997,45 @@
             if _message.state == 'SENT':
                 found_pending_notifications = False
                 for defer_result in _message.notifications.values():
                     if defer_result and not defer_result.called:
                         found_pending_notifications = True
                 if not found_pending_notifications:
                     # no pending notifications found, but state is SENT : all is done
-                    to_be_removed.add((
-                        queue_id,
-                        _message.message_id,
-                    ))
+                    to_be_removed.add((queue_id, _message.message_id))
                     continue
                 if len(_message.failed_notifications) + len(_message.success_notifications) >= len(_message.consumers):
                     # all notifications are sent and results are received (or timeouts) - remove message from the queue
-                    to_be_removed.add((
-                        queue_id,
-                        _message.message_id,
-                    ))
+                    to_be_removed.add((queue_id, _message.message_id))
                     continue
             if len(_message.consumers) == 0:
                 # there is no consumers for that message - remove it
-                to_be_removed.add((
-                    queue_id,
-                    _message.message_id,
-                ))
+                to_be_removed.add((queue_id, _message.message_id))
                 continue
     for queue_id, message_id in to_be_removed:
         processed_message = pull_message(queue_id, message_id)
         if processed_message:
             for cb in _MessageProcessedCallbacks:
                 if not cb(processed_message):
-                    lg.warn('message %r was not correctly processed' % message_id)
+                    lg.warn('message %r was not correctly processed in %r' % (message_id, cb))
     to_be_removed.clear()
     del to_be_removed
     return True
 
 
 #------------------------------------------------------------------------------
 
 
 class QueueMessage(object):
+
     def __init__(self, producer_id, queue_id, json_data, created=None):
         self.message_id = make_message_id()
         self.producer_id = producer_id
         self.queue_id = queue_id
-        self.created = created or utime.get_sec1970()
+        self.created = created or utime.utcnow_to_sec1970()
         self.payload = jsn.dict_items_to_text(json_data)
         self.state = 'CREATED'
         self.notifications = {}
         self.success_notifications = []
         self.failed_notifications = []
         self.consumers = []
         for consumer_id in consumer():
@@ -1070,28 +1057,30 @@
         return self.payload.get('sequence_id', None)
 
 
 #------------------------------------------------------------------------------
 
 
 class ConsumerInfo(object):
+
     def __init__(self, consumer_id):
         self.state = 'READY'
         self.consumer_id = consumer_id
         self.commands = {}
         self.queues = []
         self.consumed_messages = 0
         self.success_notifications = 0
         self.failed_notifications = 0
 
 
 #------------------------------------------------------------------------------
 
 
 class ProducerInfo(object):
+
     def __init__(self, producer_id):
         self.state = 'READY'
         self.producer_id = producer_id
         self.produced_messages = 0
         self.queues = []
         self.publishers = {}
 
@@ -1101,20 +1090,15 @@
     def do_push_message(self, evt):
         if not self.queues:
             if _Debug:
                 lg.warn('producer is not connected to any queue')
             return False
         for queue_id in self.queues:
             try:
-                write_message(
-                    producer_id=self.producer_id,
-                    queue_id=queue_id,
-                    data=evt.data,
-                    creation_time=evt.created,
-                )
+                write_message(producer_id=self.producer_id, queue_id=queue_id, data=evt.data, creation_time=evt.created)
             except P2PQueueIsOverloaded as exc:
                 lg.warn('queue_id=%s producer_id=%s: %s' % (queue_id, self.producer_id, exc))
         return True
 
     def start_publisher(self, event_id):
         if event_id in self.publishers:
             raise Exception('event publisher already exist')
```

### Comparing `bitdust-0.1.8.234/bitdust/stream/queue_keeper.py` & `bitdust-0.1.9.241/bitdust/transport/proxy/proxy_receiver.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 #!/usr/bin/env python
-# queue_keeper.py
-#
+# proxy_receiver.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (queue_keeper.py) is part of BitDust Software.
+# This file (proxy_receiver.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -16,885 +15,958 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
-#
-#
-#
-#
 """
-.. module:: queue_keeper
+.. module:: proxy_receiver.
+
 .. role:: red
 
-BitDust queue_keeper() Automat
+BitDust proxy_receiver(at_startup) Automat
+
+.. raw:: html
+
+    <i>generated using <a href="https://bitdust.io/visio2python/" target="_blank">visio2python</a> tool</i><br>
+    <a href="proxy_receiver.png" target="_blank">
+    <img src="proxy_receiver.png" style="max-width:100%;">
+    </a>
 
 EVENTS:
-    * :red:`accepted`
-    * :red:`connect`
-    * :red:`cooperation-mismatch`
-    * :red:`dht-mismatch`
-    * :red:`dht-read-failed`
-    * :red:`dht-read-success`
-    * :red:`dht-write-failed`
-    * :red:`dht-write-success`
-    * :red:`failed`
+    * :red:`ack-received`
+    * :red:`ack-timeout`
+    * :red:`fail-received`
+    * :red:`found-one-node`
+    * :red:`inbox-packet`
     * :red:`init`
-    * :red:`msg-in`
-    * :red:`rejected`
-    * :red:`request-invalid`
-    * :red:`request-rejected`
-    * :red:`restore`
+    * :red:`nodes-not-found`
+    * :red:`request-timeout`
+    * :red:`router-disconnected`
+    * :red:`router-id-received`
+    * :red:`sending-failed`
+    * :red:`service-accepted`
+    * :red:`service-refused`
     * :red:`shutdown`
+    * :red:`start`
+    * :red:`stop`
+    * :red:`timer-10sec`
+    * :red:`timer-15sec`
+    * :red:`timer-30sec`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
+from io import BytesIO
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 10
+_DebugLevel = 16
+
+_PacketLogFileEnabled = False
 
 #------------------------------------------------------------------------------
 
-import os
-import sys
 import re
+import time
+import random
 
-try:
-    from twisted.internet import reactor  # @UnresolvedImport
-except:
-    sys.exit('Error initializing twisted.internet.reactor in queue_keeper.py')
-
-from twisted.python.failure import Failure
-from twisted.internet.defer import Deferred
-from twisted.internet.task import LoopingCall
+from twisted.internet import reactor  # @UnresolvedImport
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
+from bitdust.lib import packetid
+from bitdust.lib import strng
+from bitdust.lib import serialization
+from bitdust.lib import net_misc
+
 from bitdust.automats import automat
 
-from bitdust.system import local_fs
+from bitdust.main import config
+from bitdust.main import settings
 
-from bitdust.lib import utime
-from bitdust.lib import strng
-from bitdust.lib import jsn
+from bitdust.crypt import key
+from bitdust.crypt import signed
+from bitdust.crypt import encrypted
 
-from bitdust.main import settings
-from bitdust.main import config
+from bitdust.p2p import commands
+from bitdust.p2p import lookup
+from bitdust.p2p import online_status
 
-from bitdust.dht import dht_relations
+from bitdust.contacts import identitycache
 
-from bitdust.p2p import p2p_service_seeker
+from bitdust.services import driver
 
-from bitdust.access import groups
+from bitdust.transport import callback
+from bitdust.transport import packet_in
+from bitdust.transport import packet_out
 
-from bitdust.stream import broker_negotiator
+from bitdust.transport import gateway
+from bitdust.transport.proxy import proxy_interface
 
-from bitdust.userid import id_url
+from bitdust.userid import identity
 from bitdust.userid import global_id
+from bitdust.userid import id_url
 from bitdust.userid import my_id
 
 #------------------------------------------------------------------------------
 
-_QueueKeepers = {}
-
-#------------------------------------------------------------------------------
-
-DHT_RECORD_REFRESH_INTERVAL = 10*60
+_ProxyReceiver = None
 
 #------------------------------------------------------------------------------
 
 
-def init():
-    """
-    Called from top level code when the software is starting.
-    Needs to be called before other methods here.
-    """
-    if _Debug:
-        lg.out(_DebugLevel, 'queue_keeper.init')
+def GetRouterIDURL():
+    global _ProxyReceiver
+    if not _ProxyReceiver:
+        return None
+    return _ProxyReceiver.router_idurl
 
 
-def shutdown():
-    """
-    Called from top level code when the software is stopping.
-    """
-    if _Debug:
-        lg.out(_DebugLevel, 'queue_keeper.shutdown')
+def GetPossibleRouterIDURL():
+    global _ProxyReceiver
+    if not _ProxyReceiver:
+        return None
+    return _ProxyReceiver.possible_router_idurl
 
 
-#------------------------------------------------------------------------------
+def GetRouterIdentity():
+    global _ProxyReceiver
+    if not _ProxyReceiver:
+        return None
+    return _ProxyReceiver.router_identity
 
 
-def queue_keepers():
-    global _QueueKeepers
-    return _QueueKeepers
+def GetRouterProtoHost():
+    global _ProxyReceiver
+    if not _ProxyReceiver:
+        return None
+    return _ProxyReceiver.router_proto_host
 
 
-def existing(customer_idurl):
-    """
-    Returns instance of existing `queue_keeper()` or None.
-    """
-    global _QueueKeepers
-    customer_idurl = id_url.to_bin(customer_idurl)
-    if id_url.is_empty(customer_idurl):
-        return None
-    if not id_url.is_cached(customer_idurl):
-        lg.warn('customer idurl is not cached yet, can not start QueueKeeper()')
-        return None
-    customer_idurl = id_url.field(customer_idurl)
-    return customer_idurl in _QueueKeepers
+def ReadMyOriginalIdentitySource():
+    return config.conf().getData('services/proxy-transport/my-original-identity').strip()
 
 
-#------------------------------------------------------------------------------
+def WriteMyOriginalIdentitySource(new_identity_xml_src):
+    return config.conf().setData('services/proxy-transport/my-original-identity', new_identity_xml_src)
 
 
-def check_create(customer_idurl, auto_create=True, event='init'):
-    """
-    Creates new instance of `queue_keeper()` state machine and send "init" event to it.
-    """
-    customer_idurl = id_url.to_bin(customer_idurl)
-    if _Debug:
-        lg.args(_DebugLevel, customer_idurl=customer_idurl)
-    if id_url.is_empty(customer_idurl):
-        return None
-    if not id_url.is_cached(customer_idurl):
-        lg.warn('customer idurl is not cached yet, can not start QueueKeeper()')
-        return None
-    customer_idurl = id_url.field(customer_idurl)
-    if customer_idurl not in list(queue_keepers().keys()):
-        if not auto_create:
-            return None
-        if event:
-            A(customer_idurl, event)
-            if _Debug:
-                lg.out(_DebugLevel, 'queue_keeper.check_create instance for customer %r was not found, made a new instance' % customer_idurl)
-    return A(customer_idurl)
+def ReadCurrentRouter():
+    return config.conf().getString('services/proxy-transport/current-router').strip()
 
 
-def close(customer_idurl):
-    """
-    Closes instance of queue_keeper() state machine related to given customer.
-    """
-    customer_idurl = strng.to_bin(customer_idurl)
-    if _Debug:
-        lg.args(_DebugLevel, customer_idurl=customer_idurl)
-    if id_url.is_empty(customer_idurl):
+def VerifyExistingRouter():
+    if ReadCurrentRouter() and not ReadMyOriginalIdentitySource():
+        lg.err('current router is set, but my original identity is empty')
         return False
-    if not id_url.is_cached(customer_idurl):
-        lg.warn('customer idurl is not cached yet, can not stop QueueKeeper()')
+    if not ReadCurrentRouter() and ReadMyOriginalIdentitySource():
+        lg.err('current router is not set, but some wrong data found as original identity')
         return False
-    customer_idurl = id_url.field(customer_idurl)
-    qk = queue_keepers().get(customer_idurl)
-    if not qk:
-        lg.warn('instance of queue_keeper() not found for given customer %r' % customer_idurl)
-        return False
-    qk.event('shutdown')
-    del qk
     return True
 
 
-#------------------------------------------------------------------------------
-
-
-def read_state(customer_id, broker_id):
-    service_dir = settings.ServiceDir('service_message_broker')
-    keepers_dir = os.path.join(service_dir, 'keepers')
-    broker_dir = os.path.join(keepers_dir, broker_id)
-    keeper_state_file_path = os.path.join(broker_dir, customer_id)
-    json_value = None
-    if os.path.isfile(keeper_state_file_path):
-        try:
-            json_value = jsn.loads_text(local_fs.ReadTextFile(keeper_state_file_path))
-        except:
-            lg.exc()
-            return None
-        if _Debug:
-            lg.args(_DebugLevel, customer_id=customer_id, broker_id=broker_id, json_value=json_value)
-        return json_value
-    broker_idurl = global_id.glob2idurl(broker_id)
-    if id_url.is_cached(broker_idurl):
-        for one_broker_id in os.listdir(keepers_dir):
-            one_broker_idurl = global_id.glob2idurl(one_broker_id)
-            if id_url.is_cached(one_broker_idurl):
-                if one_broker_idurl == broker_idurl:
-                    broker_dir = os.path.join(keepers_dir, one_broker_id)
-                    keeper_state_file_path = os.path.join(broker_dir, customer_id)
-                    json_value = None
-                    if os.path.isfile(keeper_state_file_path):
-                        try:
-                            json_value = jsn.loads_text(local_fs.ReadTextFile(keeper_state_file_path))
-                        except:
-                            lg.exc()
-                            return None
-                        if _Debug:
-                            lg.args(_DebugLevel, customer_id=customer_id, broker_id=one_broker_id, json_value=json_value)
-                        return json_value
-    return None
-
-
-def write_state(customer_id, broker_id, json_value):
-    service_dir = settings.ServiceDir('service_message_broker')
-    keepers_dir = os.path.join(service_dir, 'keepers')
-    broker_dir = os.path.join(keepers_dir, broker_id)
-    keeper_state_file_path = os.path.join(broker_dir, customer_id)
-    if json_value is None:
-        if os.path.isfile(keeper_state_file_path):
-            try:
-                os.remove(keeper_state_file_path)
-            except:
-                lg.exc()
-        if _Debug:
-            lg.args(_DebugLevel, customer_id=customer_id, broker_id=broker_id)
-        return None
-    if not os.path.isdir(broker_dir):
-        try:
-            os.makedirs(broker_dir)
-        except:
-            lg.exc()
-            return None
-    if not local_fs.WriteTextFile(keeper_state_file_path, jsn.dumps(json_value)):
-        lg.err('failed writing queue_keeper state for customer %r of broker %r to %r' % (customer_id, broker_id, keeper_state_file_path))
-        return None
-    if _Debug:
-        lg.args(_DebugLevel, customer_id=customer_id, broker_id=broker_id, json_value=json_value)
-    return json_value
+def LatestPacketReceived():
+    global _ProxyReceiver
+    if not _ProxyReceiver:
+        return 0
+    return _ProxyReceiver.latest_packet_received
 
 
 #------------------------------------------------------------------------------
 
 
-def A(customer_idurl, event=None, *args, **kwargs):
+def A(event=None, *args, **kwargs):
     """
-    Access method to interact with a state machine created for given contact.
+    Access method to interact with proxy_receiver machine.
     """
-    global _QueueKeepers
-    customer_idurl = id_url.field(customer_idurl)
-    if customer_idurl not in _QueueKeepers:
-        if not event or event in [
-            'shutdown',
-            'failed',
-            'rejected',
-        ]:
-            return None
-        _QueueKeepers[customer_idurl] = QueueKeeper(
-            customer_idurl=customer_idurl,
-            debug_level=_DebugLevel,
-            log_events=_Debug,
-            log_transitions=_Debug,
-        )
+    global _ProxyReceiver
+    if event is None and not args:
+        return _ProxyReceiver
+    if _ProxyReceiver is None:
+        # set automat name and starting state here
+        _ProxyReceiver = ProxyReceiver()
     if event is not None:
-        _QueueKeepers[customer_idurl].automat(event, *args, **kwargs)
-    return _QueueKeepers[customer_idurl]
+        _ProxyReceiver.automat(event, *args, **kwargs)
+    return _ProxyReceiver
 
 
 #------------------------------------------------------------------------------
 
 
-class QueueKeeper(automat.Automat):
+class ProxyReceiver(automat.Automat):
     """
-    This class implements all the functionality of ``queue_keeper()`` state machine.
+    This class implements all the functionality of the ``proxy_receiver()``
+    state machine.
     """
-    def __init__(self, customer_idurl, broker_idurl=None, debug_level=0, log_events=False, log_transitions=False, publish_events=False, **kwargs):
+
+    timers = {
+        'timer-10sec': (10.0, ['LISTEN']),
+        'timer-15sec': (15.0, ['ACK?']),
+        'timer-30sec': (30.0, ['FIND_NODE?']),
+    }
+
+    def __init__(self):
         """
-        Builds `queue_keeper()` state machine.
+        Builds `proxy_receiver()` state machine.
         """
-        self.customer_idurl = id_url.field(customer_idurl)
-        self.customer_id = self.customer_idurl.to_id()
-        self.broker_idurl = id_url.field(broker_idurl or my_id.getIDURL())
-        self.broker_id = self.broker_idurl.to_id()
-        self.cooperated_brokers = {}
-        self.known_position = -1
-        self.known_streams = {}
-        self.current_connect_request = None
-        self.pending_connect_requests = []
-        self.latest_dht_records = {}
-        self.InSync = False
-        super(QueueKeeper, self).__init__(name='queue_keeper_%s' % self.customer_id, state='AT_STARTUP', debug_level=debug_level, log_events=log_events, log_transitions=log_transitions, publish_events=publish_events, **kwargs)
+        self.possible_router_idurl = None
+        self.router_idurl = None
+        self.router_identity = None
+        self.router_id = ''
+        self.router_proto_host = None
+        self.request_service_packet_id = []
+        self.latest_packet_received = 0
+        self.router_connection_info = None
+        self.traffic_in = 0
+        super(ProxyReceiver, self).__init__(
+            name='proxy_receiver',
+            state='AT_STARTUP',
+            debug_level=_DebugLevel,
+            log_events=False,
+            log_transitions=_Debug,
+            publish_events=False,
+        )
 
     def __repr__(self):
-        return '%s[%d](%s)' % (self.id, self.known_position, self.state)
+        return '%s_%s_%s(%s)' % (self.id, self.router_id, (self.router_connection_info or {}).get('repr', '?'), self.state)
 
     def to_json(self):
         j = super().to_json()
-        j.update({
-            'customer_id': self.customer_id,
-            'broker_id': self.broker_id,
-            'position': self.known_position,
-            'brokers': self.cooperated_brokers,
-            'streams': self.known_streams,
-        })
+        j.update(
+            {
+                'proto': self.router_proto_host[0] if self.router_proto_host else '',
+                'host': net_misc.pack_address(self.router_proto_host[1]) if self.router_proto_host else '',
+                'idurl': self.router_idurl,
+                'bytes_received': self.traffic_in,
+                'bytes_sent': 0,
+                'connection_info': self.router_connection_info,
+                'idle_seconds': int(time.time() - self.latest_packet_received),
+            }
+        )
         return j
 
+    def state_changed(self, oldstate, newstate, event, *args, **kwargs):
+        """
+        Method to catch the moment when proxy_receiver() state were changed.
+        """
+        from bitdust.transport.proxy import proxy_sender
+        proxy_sender.A('proxy_receiver.state', newstate)
+
     def A(self, event, *args, **kwargs):
         """
-        The state machine code, generated using `visio2python <http://bitdust.io/visio2python/>`_ tool.
+        The core proxy_receiver() code, generated using `visio2python
+        <https://bitdust.io/visio2python/>`_ tool.
         """
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
             if event == 'init':
-                self.state = 'DISCONNECTED'
-                self.InSync = False
-                self.doEraseState(*args, **kwargs)
-                self.doInit(*args, **kwargs)
-            elif event == 'restore':
-                self.state = 'DHT_READ'
-                self.InSync = False
+                self.state = 'OFFLINE'
                 self.doInit(*args, **kwargs)
-                self.doReadState(*args, **kwargs)
-                self.doBuildVerifyRequest(*args, **kwargs)
-                self.doDHTRead(*args, **kwargs)
-        #---DISCONNECTED---
-        elif self.state == 'DISCONNECTED':
-            if event == 'shutdown':
+        #---CLOSED---
+        elif self.state == 'CLOSED':
+            pass
+        #---ACK?---
+        elif self.state == 'ACK?':
+            if event == 'ack-received':
+                self.state = 'SERVICE?'
+                self.doSendRequestService(*args, **kwargs)
+            elif event == 'shutdown':
                 self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'connect':
-                self.state = 'DHT_READ'
-                self.doBuildConnectRequest(*args, **kwargs)
-                self.doDHTRead(*args, **kwargs)
-        #---DHT_READ---
-        elif self.state == 'DHT_READ':
-            if event == 'shutdown':
+            elif event == 'stop':
+                self.state = 'OFFLINE'
+                self.doNotifyFailed(*args, **kwargs)
+            elif event == 'sending-failed':
+                self.Retries += 1
+                self.doSendMyIdentity(*args, **kwargs)
+            elif (event == 'sending-failed' and self.Retries > 3) or event == 'ack-timeout' or event == 'fail-received' or event == 'timer-15sec':
+                self.state = 'FIND_NODE?'
+                self.doLookupRandomNode(*args, **kwargs)
+        #---LISTEN---
+        elif self.state == 'LISTEN':
+            if event == 'router-id-received':
+                self.doUpdateRouterID(*args, **kwargs)
+            elif event == 'inbox-packet':
+                self.doProcessInboxPacket(*args, **kwargs)
+            elif event == 'shutdown':
                 self.state = 'CLOSED'
-                self.doCancelRequests(*args, **kwargs)
-                self.doNotify(event, *args, **kwargs)
+                self.doStopListening(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'msg-in':
-                self.doProc(*args, **kwargs)
-            elif event == 'connect':
-                self.doPushRequest(*args, **kwargs)
-            elif event == 'dht-read-success':
-                self.state = 'COOPERATE?'
-                self.doRunBrokerNegotiator(*args, **kwargs)
-            elif event == 'dht-read-failed':
-                self.state = 'DISCONNECTED'
-                self.InSync = False
-                self.doNotify(event, *args, **kwargs)
-                self.doPullRequests(*args, **kwargs)
-        #---COOPERATE?---
-        elif self.state == 'COOPERATE?':
-            if event == 'shutdown':
+            elif event == 'stop':
+                self.state = 'OFFLINE'
+                self.doSendCancelService(*args, **kwargs)
+                self.doStopListening(*args, **kwargs)
+                self.doNotifyDisconnected(*args, **kwargs)
+            elif event == 'timer-10sec':
+                self.doCheckPingRouter(*args, **kwargs)
+            elif event == 'service-refused' or event == 'router-disconnected':
+                self.state = 'FIND_NODE?'
+                self.doStopListening(*args, **kwargs)
+                self.doNotifyDisconnected(*args, **kwargs)
+                self.doLookupRandomNode(*args, **kwargs)
+        #---FIND_NODE?---
+        elif self.state == 'FIND_NODE?':
+            if event == 'found-one-node':
+                self.state = 'ACK?'
+                self.doRememberNode(*args, **kwargs)
+                self.Retries = 0
+                self.doSendMyIdentity(*args, **kwargs)
+            elif event == 'shutdown':
                 self.state = 'CLOSED'
-                self.doCancelRequests(*args, **kwargs)
-                self.doNotify(event, *args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'connect':
-                self.doPushRequest(*args, **kwargs)
-            elif event == 'request-invalid' or (event == 'rejected' and self.InSync) or event == 'accepted':
-                self.state = 'DHT_WRITE'
-                self.doRememberCooperation(event, *args, **kwargs)
-                self.doDHTWrite(event, *args, **kwargs)
-            elif (event == 'rejected' and not self.InSync) or event == 'failed' or event == 'dht-mismatch' or event == 'cooperation-mismatch':
-                self.state = 'DISCONNECTED'
-                self.doCancelCooperation(event, *args, **kwargs)
-                self.doEraseState(*args, **kwargs)
-                self.InSync = False
-                self.doNotify(event, *args, **kwargs)
-                self.doPullRequests(*args, **kwargs)
-        #---DHT_WRITE---
-        elif self.state == 'DHT_WRITE':
-            if event == 'shutdown':
+            elif event == 'stop' or event == 'nodes-not-found' or event == 'timer-30sec':
+                self.state = 'OFFLINE'
+                self.doNotifyFailed(*args, **kwargs)
+        #---SERVICE?---
+        elif self.state == 'SERVICE?':
+            if event == 'service-accepted':
+                self.state = 'LISTEN'
+                self.doStartListening(*args, **kwargs)
+                self.doNotifyConnected(*args, **kwargs)
+            elif event == 'shutdown':
                 self.state = 'CLOSED'
-                self.doCancelRequests(*args, **kwargs)
-                self.doNotify(event, *args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'msg-in':
-                self.doProc(*args, **kwargs)
-            elif event == 'dht-write-failed':
-                self.state = 'DISCONNECTED'
-                self.InSync = False
-                self.doEraseState(*args, **kwargs)
-                self.doCancelCooperation(event, *args, **kwargs)
-                self.doNotify(event, *args, **kwargs)
-                self.doPullRequests(*args, **kwargs)
-            elif event == 'connect':
-                self.doPushRequest(*args, **kwargs)
-            elif event == 'request-rejected' or event == 'dht-write-success':
-                self.state = 'CONNECTED'
-                self.doDHTRefresh(*args, **kwargs)
-                self.doRememberOwnPosition(*args, **kwargs)
-                self.InSync = True
-                self.doWriteState(*args, **kwargs)
-                self.doNotify(event, *args, **kwargs)
-                self.doPullRequests(*args, **kwargs)
-        #---CONNECTED---
-        elif self.state == 'CONNECTED':
-            if event == 'shutdown':
+            elif event == 'stop':
+                self.state = 'OFFLINE'
+                self.doSendCancelService(*args, **kwargs)
+                self.doNotifyFailed(*args, **kwargs)
+            elif event == 'request-timeout' or event == 'service-refused':
+                self.state = 'FIND_NODE?'
+                self.doLookupRandomNode(*args, **kwargs)
+        #---OFFLINE---
+        elif self.state == 'OFFLINE':
+            if event == 'start' and self.isCurrentRouterExist(*args, **kwargs):
+                self.state = 'ACK?'
+                self.doLoadRouterInfo(*args, **kwargs)
+                self.Retries = 0
+                self.doSendMyIdentity(*args, **kwargs)
+            elif event == 'start' and not self.isCurrentRouterExist(*args, **kwargs):
+                self.state = 'FIND_NODE?'
+                self.doLookupRandomNode(*args, **kwargs)
+            elif event == 'shutdown':
                 self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'msg-in':
-                self.doProc(*args, **kwargs)
-            elif event == 'connect':
-                self.state = 'DHT_READ'
-                self.doBuildConnectRequest(*args, **kwargs)
-                self.doDHTRead(*args, **kwargs)
-        #---CLOSED---
-        elif self.state == 'CLOSED':
-            pass
         return None
 
-    def doInit(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self.refresh_period = DHT_RECORD_REFRESH_INTERVAL
-        self.refresh_task = LoopingCall(self._on_queue_keeper_dht_refresh_task)
-
-    def doReadState(self, *args, **kwargs):
+    def isCurrentRouterExist(self, *args, **kwargs):
         """
-        Action method.
+        Condition method.
         """
-        json_value = read_state(customer_id=self.customer_id, broker_id=self.broker_id) or {}
-        self.cooperated_brokers = {int(k): id_url.field(v) for k, v in (json_value.get('cooperated_brokers') or {}).items()}
-        try:
-            self.known_position = int(json_value.get('position', -1))
-        except:
-            self.known_position = -1
-        self.known_streams = json_value.get('streams', {}) or {}
+        if not ReadCurrentRouter():
+            return False
+        if not ReadMyOriginalIdentitySource():
+            return False
+        return True
 
-    def doEraseState(self, *args, **kwargs):
+    def doInit(self, *args, **kwargs):
         """
         Action method.
         """
-        write_state(customer_id=self.customer_id, broker_id=self.broker_id, json_value=None)
-        self.cooperated_brokers = {}
-        self.known_position = -1
-        self.known_streams = {}
+        global _PacketLogFileEnabled
+        _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
+        callback.add_queue_item_status_callback(self._on_queue_item_status_changed)
 
-    def doWriteState(self, *args, **kwargs):
+    def doLoadRouterInfo(self, *args, **kwargs):
         """
         Action method.
         """
-        # store queue keeper info locally here to be able to start up again after application restart
-        write_state(
-            customer_id=self.customer_id,
-            broker_id=self.broker_id,
-            json_value={
-                'state': self.state,
-                'position': self.known_position,
-                'cooperated_brokers': self.cooperated_brokers,
-                'streams': self.known_streams,
-                'time': utime.get_sec1970(),
-            },
-        )
+        s = config.conf().getString('services/proxy-transport/current-router').strip()
+        try:
+            self.router_idurl = id_url.field(s.split(' ')[0])
+            self.router_id = global_id.idurl2glob(self.router_idurl)
+        except:
+            lg.exc()
+        if _Debug:
+            lg.out(_DebugLevel, 'proxy_receiver.doLoadRouterInfo : %s' % self.router_idurl)
 
-    def doBuildConnectRequest(self, *args, **kwargs):
+    def doLookupRandomNode(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.refresh_task.running:
-            self.refresh_task.stop()
-        self.current_connect_request = {
-            'request': 'connect',
-            'consumer_id': kwargs['consumer_id'],
-            'producer_id': kwargs['producer_id'],
-            'group_key_info': kwargs['group_key_info'],
-            'desired_position': kwargs['desired_position'],
-            'archive_folder_path': kwargs['archive_folder_path'],
-            'last_sequence_id': kwargs['last_sequence_id'],
-            'known_brokers': kwargs['known_brokers'],
-            'use_dht_cache': kwargs['use_dht_cache'],
-            'result': kwargs['result_callback'],
-        }
+        self._find_random_node(attempts=5)
 
-    def doBuildVerifyRequest(self, *args, **kwargs):
+    def doSendMyIdentity(self, *args, **kwargs):
         """
         Action method.
         """
-        self.current_connect_request = {
-            'request': 'verify',
-            'desired_position': self.known_position,
-            'streams': self.known_streams,
-            'known_brokers': self.cooperated_brokers,
-            'use_dht_cache': False,
-            'result': kwargs['result_callback'],
-        }
+        reactor.callLater(0, self._do_send_identity_to_router, my_id.getLocalIdentity().serialize(), failed_event='fail-received')  # @UndefinedVariable
+        identity_source = config.conf().getData('services/proxy-transport/my-original-identity').strip()
+        if identity_source:
+            if _Debug:
+                lg.out(_DebugLevel, '    also sending identity loaded from "my-original-identity" config')
+            reactor.callLater(0, self._do_send_identity_to_router, identity_source, failed_event='fail-received')  # @UndefinedVariable
 
-    def doPushRequest(self, *args, **kwargs):
+    def doRememberNode(self, *args, **kwargs):
         """
         Action method.
         """
-        self.pending_connect_requests.append(dict(**kwargs))
+        self.possible_router_idurl = None
+        self.router_idurl = id_url.field(args[0])
+        self.router_id = global_id.idurl2glob(self.router_idurl)
+        self.router_identity = None
+        self.router_proto_host = None
         if _Debug:
-            lg.args(_DebugLevel, pending=len(self.pending_connect_requests), **kwargs)
+            lg.out(_DebugLevel, 'proxy_receiver.doRememberNode %r' % self.router_idurl)
 
-    def doPullRequests(self, *args, **kwargs):
+    def doSendRequestService(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.pending_connect_requests:
-            req = self.pending_connect_requests.pop(0)
-            if _Debug:
-                lg.args(_DebugLevel, more_pending=len(self.pending_connect_requests), **req)
-            reactor.callLater(0, self.automat, 'connect', **req)  # @UndefinedVariable
+        self._do_send_request_service(args[0])
 
-    def doDHTRead(self, *args, **kwargs):
+    def doSendCancelService(self, *args, **kwargs):
         """
         Action method.
         """
-        use_cache = (self.current_connect_request or {}).get('use_dht_cache', False)
-        result = dht_relations.read_customer_message_brokers(
-            customer_idurl=self.customer_idurl,
-            positions=list(range(groups.REQUIRED_BROKERS_COUNT)),
-            use_cache=use_cache,
+        newpacket = signed.Packet(
+            commands.CancelService(),
+            my_id.getIDURL(),
+            my_id.getIDURL(),
+            packetid.UniqueID(),
+            serialization.DictToBytes({
+                'name': 'service_proxy_server',
+            }),
+            self.router_idurl,
+        )
+        packet_out.create(
+            newpacket,
+            wide=True,
+            callbacks={},
+            # callbacks={
+            #     commands.Ack(): self._on_request_service_ack,
+            #     commands.Fail(): self._on_request_service_fail,
+            # },
+            response_timeout=settings.P2PTimeOut(),
         )
-        # TODO: add more validations of dht_result
-        result.addCallback(self._on_read_customer_message_brokers)
-        result.addErrback(lg.errback, debug=_Debug, debug_level=_DebugLevel, method='queue_keeper.doDHTRead')
-        result.addErrback(lambda err: self.automat('dht-read-failed', err))
-
-    def doDHTWrite(self, event, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_dht_push_state(event=event, **kwargs)
 
-    def doDHTRefresh(self, *args, **kwargs):
+    def doProcessInboxPacket(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.refresh_task.running:
-            self.refresh_task.stop()
-        self.refresh_task.start(DHT_RECORD_REFRESH_INTERVAL, now=False)
+        self._do_process_inbox_packet(args[0])
 
-    def doRememberCooperation(self, event, *args, **kwargs):
+    def doStartListening(self, *args, **kwargs):
         """
         Action method.
         """
-        self.cooperated_brokers = self.cooperated_brokers or {}
-        archive_folder_path = None
-        if event in [
-            'accepted',
-        ]:
-            accepted_brokers = kwargs.get('cooperated_brokers', {}) or {}
-            archive_folder_path = accepted_brokers.pop('archive_folder_path', None)
-            self.cooperated_brokers.update(accepted_brokers)
+        try:
+            _, info, active_router_session_machine = args[0]
+            self.router_proto_host = (info.proto, info.host)
+        except:
+            try:
+                # TODO: move that setting to separate file
+                s = config.conf().getString('services/proxy-transport/current-router').strip()
+                _, router_proto, router_host = s.split(' ')
+                self.router_proto_host = (router_proto, strng.to_bin(router_host))
+            except:
+                lg.exc()
+        self.router_identity = identitycache.FromCache(self.router_idurl)
         if _Debug:
-            lg.args(_DebugLevel, e=event, cooperated=kwargs.get('cooperated_brokers'), af_path=archive_folder_path)
+            lg.args(_DebugLevel, router_idurl=self.router_idurl)
+        config.conf().setString('services/proxy-transport/current-router', '%s %s %s' % (
+            strng.to_text(self.router_idurl),
+            strng.to_text(self.router_proto_host[0]),
+            strng.to_text(self.router_proto_host[1]),
+        ))
+        current_identity = my_id.getLocalIdentity().serialize(as_text=True)
+        previous_identity = ReadMyOriginalIdentitySource()
+        if previous_identity:
+            lg.err('my original identity is not empty, SKIP overwriting')
+            if _Debug:
+                lg.out(_DebugLevel, 'PREVIOUS ORIGINAL IDENTITY:\n%s\n' % previous_identity)
+        WriteMyOriginalIdentitySource(current_identity)
+        lg.info('copy of my current identity was stored as my "original" identity')
+        self.request_service_packet_id = []
+        callback.insert_inbox_callback(0, self._on_inbox_packet_received)
+        if online_status.isKnown(self.router_idurl):
+            online_status.add_online_status_listener_callback(
+                idurl=self.router_idurl,
+                callback_method=self._on_router_contact_status_connected,
+                newstate='CONNECTED',
+            )
+            online_status.add_online_status_listener_callback(
+                idurl=self.router_idurl,
+                callback_method=self._on_router_contact_status_offline,
+                newstate='OFFLINE',
+            )
+        active_router_session_machine.addStateChangedCallback(self._on_router_session_disconnected, oldstate='CONNECTED')
+        lg.info('router %s is connected at %s://%s' % (self.router_idurl, self.router_proto_host[0], self.router_proto_host[1]))
+        my_id.rebuildLocalIdentity()
 
-    def doCancelCooperation(self, event, *args, **kwargs):
+    def doStopListening(self, *args, **kwargs):
         """
         Action method.
         """
         if _Debug:
-            lg.args(_DebugLevel, e=event, current=self.cooperated_brokers)
-        self.cooperated_brokers.clear()
-
-    def doRememberOwnPosition(self, *args, **kwargs):
+            lg.args(_DebugLevel, router_idurl=self.router_idurl)
+        if online_status.isKnown(self.router_idurl):
+            online_status.remove_online_status_listener_callback(
+                idurl=self.router_idurl,
+                callback_method=self._on_router_contact_status_connected,
+            )
+            online_status.remove_online_status_listener_callback(
+                idurl=self.router_idurl,
+                callback_method=self._on_router_contact_status_offline,
+            )
+        active_router_session_machine_index = None
+        if self.router_connection_info:
+            active_router_session_machine = None
+            active_router_session_machine_index = self.router_connection_info.get('index', None)
+            if active_router_session_machine_index is not None:
+                active_router_session_machine = automat.by_index(active_router_session_machine_index)
+            if not active_router_session_machine:
+                active_router_sessions = gateway.find_active_session(
+                    proto=self.router_connection_info.get('proto'),
+                    host=self.router_connection_info.get('host'),
+                )
+                if not active_router_sessions:
+                    active_router_sessions = gateway.find_active_session(
+                        proto=self.router_connection_info.get('proto'),
+                        idurl=id_url.to_bin(self.router_idurl),
+                    )
+                if active_router_sessions:
+                    active_router_session_machine = automat.by_index(active_router_sessions[0].index)
+            if active_router_session_machine is not None:
+                active_router_session_machine.removeStateChangedCallback(self._on_router_session_disconnected)
+                lg.info('removed callback from router active session: %r' % active_router_session_machine)
+            else:
+                lg.err('did not found active router session state machine with index %s' % active_router_session_machine_index)
+        WriteMyOriginalIdentitySource('')
+        config.conf().setString('services/proxy-transport/current-router', '')
+        callback.remove_inbox_callback(self._on_inbox_packet_received)
+        self.router_identity = None
+        self.router_idurl = None
+        self.router_id = ''
+        self.router_proto_host = None
+        self.request_service_packet_id = []
+        self.router_connection_info = None
+        my_id.rebuildLocalIdentity()
+
+    def doUpdateRouterID(self, *args, **kwargs):
         """
         Action method.
         """
-        my_new_position = -1
-        for pos, idurl in self.cooperated_brokers.items():
-            if idurl and id_url.is_the_same(idurl, self.broker_idurl):
-                my_new_position = pos
-        archive_folder_path = kwargs.get('archive_folder_path')
-        if _Debug:
-            lg.args(_DebugLevel, known=self.known_position, new=my_new_position, cooperated=self.cooperated_brokers, af_path=archive_folder_path)
-        if my_new_position >= 0:
-            self.known_position = my_new_position
-        if self.current_connect_request and self.current_connect_request.get('request') == 'connect' and archive_folder_path:
-            try:
-                self.known_streams[self.current_connect_request['group_key_info']['alias']] = archive_folder_path
-            except:
-                lg.exc(str(self.current_connect_request))
+        newpacket, _ = args[0]
+        newxml = newpacket.Payload
+        newidentity = identity.identity(xmlsrc=newxml)
+        cachedidentity = identitycache.FromCache(self.router_idurl)
+        if self.router_idurl != newidentity.getIDURL():
+            lg.warn('router idurl is unrecognized from response %r != %r' % (self.router_idurl, newidentity.getIDURL()))
+            return
+        if newidentity.serialize() != cachedidentity.serialize():
+            lg.warn('cached identity is not same, router identity changed')
+        self.router_identity = newidentity
 
-    def doRunBrokerNegotiator(self, *args, **kwargs):
+    def doCheckPingRouter(self, *args, **kwargs):
         """
         Action method.
         """
+        if self.router_connection_info:
+            gateway.send_keep_alive(self.router_connection_info['proto'], self.router_connection_info['host'])
+        live_time = time.time() - self.latest_packet_received
+        if live_time < 60.0:
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_receiver.doCheckPingRouter OK, latest packet received %f sec ago' % live_time)
+            return
         if _Debug:
-            lg.args(_DebugLevel, req=self.current_connect_request['request'], my_pos=self.known_position, dht_brokers=kwargs['dht_brokers'])
-        if self.current_connect_request['request'] == 'verify':
-            self._do_verify_cooperated_brokers()
-            return
-
-        def _run_broker_negotiator(d, **kw):
-            negotiator = broker_negotiator.BrokerNegotiator()
-            negotiator.automat(
-                event='connect',
-                my_position=self.known_position,
-                cooperated_brokers=self.cooperated_brokers,
-                dht_brokers=kw['dht_brokers'],
-                customer_idurl=self.customer_idurl,
-                broker_idurl=self.broker_idurl,
-                connect_request=self.current_connect_request,
-                result=d,
-            )
-
-        ret = Deferred()
-        ret.addCallback(self._on_broker_negotiator_callback)
-        ret.addErrback(self._on_broker_negotiator_errback)
-        reactor.callLater(0, _run_broker_negotiator, ret, **kwargs)  # @UndefinedVariable
+            lg.out(_DebugLevel, 'proxy_receiver.doCheckPingRouter to %s' % self.router_idurl)
+        identity_source = config.conf().getData('services/proxy-transport/my-original-identity').strip()
+        if identity_source:
+            if _Debug:
+                lg.out(_DebugLevel, '    "my-original-identity" prepared for sending')
+        else:
+            identity_source = my_id.getLocalIdentity().serialize()
+            if _Debug:
+                lg.out(_DebugLevel, '    local identity prepared for sending')
+        self._do_send_identity_to_router(identity_source, failed_event='router-disconnected')
 
-    def doNotify(self, event, *args, **kwargs):
+    def doNotifyConnected(self, *args, **kwargs):
         """
         Action method.
         """
-        result = self.current_connect_request['result']
-        self.current_connect_request = None
-        if _Debug:
-            lg.args(_DebugLevel, e=event, cooperated_brokers=self.cooperated_brokers, pos=self.known_position)
-        if result:
-            if not result.called:
-                if event == 'dht-write-success':
-                    result.callback(self.cooperated_brokers)
-                else:
-                    result.errback(Exception(event, args, kwargs))
-
-    def doCancelRequests(self, *args, **kwargs):
+        proxy_interface.interface_receiving_started(self.router_idurl, {
+            'router_idurl': self.router_idurl,
+        })
+
+    def doNotifyDisconnected(self, *args, **kwargs):
         """
         Action method.
         """
-        if self.pending_connect_requests:
-            for req in self.pending_connect_requests:
-                result = req['result_callback']
-                if result:
-                    if not result.called:
-                        result.errback(Exception('canceled'))
+        proxy_interface.interface_disconnected().addErrback(lambda _: None)
 
-    def doProc(self, *args, **kwargs):
+    def doNotifyFailed(self, *args, **kwargs):
         """
         Action method.
         """
+        proxy_interface.interface_receiving_failed()
 
     def doDestroyMe(self, *args, **kwargs):
         """
         Remove all references to the state machine object to destroy it.
         """
-        global _QueueKeepers
-        _QueueKeepers.pop(self.customer_idurl, None)
-        if self.refresh_task.running:
-            self.refresh_task.stop()
-        self.refresh_task = None
-        self.customer_idurl = None
-        self.customer_id = None
-        self.broker_idurl = None
-        self.broker_id = None
-        self.known_position = -1
-        self.known_streams.clear()
-        self.cooperated_brokers.clear()
-        self.latest_dht_records.clear()
+        global _PacketLogFileEnabled
+        global _ProxyReceiver
+        _PacketLogFileEnabled = False
+        callback.remove_queue_item_status_callback(self._on_queue_item_status_changed)
+        self.possible_router_idurl = None
+        self.router_idurl = None
+        self.router_id = ''
+        self.router_identity = None
+        self.router_proto_host = None
+        self.request_service_packet_id = []
+        self.latest_packet_received = 0
+        self.router_connection_info = None
+        self.traffic_in = 0
         self.destroy()
+        del _ProxyReceiver
+        _ProxyReceiver = None
 
-    #------------------------------------------------------------------------------
-
-    def verify_broker(self, broker_idurl, position, known_brokers, known_streams):
-        if not self.InSync or self.state != 'CONNECTED':
-            lg.warn('not able to verify another broker because %r is not in sync' % self)
-            return None
-        if self.cooperated_brokers:
-            if id_url.is_not_in(broker_idurl, self.cooperated_brokers.values()):
-                return 'unknown broker'
-            if position not in self.cooperated_brokers.keys():
-                return 'unknown position'
-            if not id_url.is_the_same(self.cooperated_brokers[position], broker_idurl):
-                return 'position mismatch'
-            if len(self.cooperated_brokers) != len(known_brokers):
-                return 'brokers count mismatch'
-            for i, b_idurl in self.cooperated_brokers.items():
-                if not id_url.is_the_same(known_brokers[i], b_idurl):
-                    return 'broker mismatch'
-        if self.known_streams and known_streams:
-            for my_queue_alias, my_archive_folder_path in self.known_streams.items():
-                for other_queue_alias, other_archive_folder_path in self.known_streams.items():
-                    # TODO: verify streams
-                    pass
-        return None
-
-    #------------------------------------------------------------------------------
-
-    def _do_dht_write(self, desired_position, archive_folder_path, revision, retry, event=None, **kwargs):
-        result = dht_relations.write_customer_message_broker(
-            customer_idurl=self.customer_idurl,
-            broker_idurl=self.broker_idurl,
-            position=desired_position,
-            revision=revision,
-        )
-        result.addCallback(self._on_write_customer_message_broker_success, desired_position, archive_folder_path, revision, event, **kwargs)
-        result.addErrback(lg.errback, debug=_Debug, debug_level=_DebugLevel, method='queue_keeper.doDHTWrite')
-        result.addErrback(self._on_write_customer_message_broker_failed, desired_position, archive_folder_path, revision, retry, event, **kwargs)
-
-    def _do_dht_push_state(self, event=None, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, known_position=self.known_position, cooperated_brokers=self.cooperated_brokers, e=event, kw=kwargs)
-        desired_position = self.known_position
-        if desired_position is None or desired_position == -1:
-            for pos, idurl in self.cooperated_brokers.items():
-                if idurl and id_url.is_the_same(idurl, self.broker_idurl):
-                    desired_position = pos
-        if desired_position is None or desired_position == -1:
-            raise Exception('not able to write record into DHT, my position is unknown')
-        archive_folder_path = None
-        if self.current_connect_request and self.current_connect_request.get('archive_folder_path'):
-            archive_folder_path = self.current_connect_request['archive_folder_path']
-        prev_revision = self.latest_dht_records.get(desired_position, {}).get('revision', None)
-        if prev_revision is None:
-            prev_revision = 0
-        if _Debug:
-            lg.args(_DebugLevel, c=self.customer_id, p=desired_position, b=self.broker_id, r=prev_revision + 1)
-        self._do_dht_write(
-            desired_position=desired_position,
-            archive_folder_path=archive_folder_path,
-            revision=prev_revision + 1,
-            retry=True,
-            event=event,
-            **kwargs,
-        )
-
-    def _do_verify_cooperated_brokers(self):
-        other_brokers = list(self.cooperated_brokers.values())
-        if self.broker_idurl in other_brokers:
-            other_brokers.remove(self.broker_idurl)
-        if not other_brokers:
-            self.automat('failed')
-            return
-        other_broker_idurl = other_brokers[0]
-        service_params = {
-            'action': 'broker-verify',
-            'customer_id': self.customer_id,
-            'broker_id': self.broker_id,
-            'position': self.known_position,
-            'streams': self.known_streams,
-            'known_brokers': self.cooperated_brokers,
-        }
-        if _Debug:
-            lg.args(_DebugLevel, target=other_broker_idurl, service_params=service_params)
-        result = p2p_service_seeker.connect_known_node(
-            remote_idurl=other_broker_idurl,
-            service_name='service_message_broker',
-            service_params=service_params,
-            request_service_timeout=config.conf().getInt('services/message-broker/broker-negotiate-ack-timeout'),
-            force_handshake=False,
-            attempts=1,
-        )
-        result.addCallback(self._on_broker_verify_result)
-        result.addErrback(lg.errback, debug=_Debug, debug_level=_DebugLevel, method='queue_keeper._do_verify_cooperated_brokers')
-        result.addErrback(self._on_broker_verify_failed)
-
-    def _on_read_customer_message_brokers(self, dht_brokers_info_list):
-        self.latest_dht_records.clear()
-        dht_brokers = {}
-        if not dht_brokers_info_list:
-            lg.warn('no brokers found in DHT records for customer %r' % self.customer_id)
-            self.automat('dht-read-success', dht_brokers=dht_brokers)
-            return
-        for dht_broker_info in dht_brokers_info_list:
-            if not dht_broker_info:
-                continue
-            dht_broker_idurl = dht_broker_info.get('broker_idurl')
-            dht_broker_position = int(dht_broker_info.get('position'))
-            dht_brokers[dht_broker_position] = dht_broker_idurl
-            self.latest_dht_records[dht_broker_position] = dht_broker_info
-        if _Debug:
-            lg.args(_DebugLevel, dht_brokers=dht_brokers)
-        self.automat('dht-read-success', dht_brokers=dht_brokers)
-
-    def _on_write_customer_message_broker_success(self, nodes, desired_broker_position, archive_folder_path, revision, event, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, nodes=type(nodes), pos=desired_broker_position, af_path=archive_folder_path, rev=revision)
-        if nodes:
-            if event == 'request-invalid':
-                self.automat('request-rejected', desired_position=desired_broker_position, archive_folder_path=archive_folder_path, **kwargs)
-            else:
-                self.automat('dht-write-success', desired_position=desired_broker_position, archive_folder_path=archive_folder_path)
-        else:
-            self.automat('dht-write-failed', desired_position=desired_broker_position, archive_folder_path=archive_folder_path)
-
-    def _on_write_customer_message_broker_failed(self, err, desired_broker_position, archive_folder_path, revision, retry, event, **kwargs):
-        if _Debug:
-            lg.args(_DebugLevel, err=err, desired_broker_position=desired_broker_position, e=event, kw=kwargs)
+    def _do_process_inbox_packet(self, *args, **kwargs):
+        newpacket, info, _, _ = args[0]
+        block = encrypted.Unserialize(newpacket.Payload)
+        if block is None:
+            lg.err('reading data from %s' % newpacket.CreatorID)
+            return
         try:
-            errmsg = err.value.subFailure.getErrorMessage()
+            session_key = key.DecryptLocalPrivateKey(block.EncryptedSessionKey)
+            padded_data = key.DecryptWithSessionKey(session_key, block.EncryptedData, session_key_type=block.SessionKeyType)
+            inpt = BytesIO(padded_data[:int(block.Length)])
+            data = inpt.read()
         except:
+            lg.err('reading data from %s' % newpacket.CreatorID)
+            lg.exc()
             try:
-                errmsg = err.getErrorMessage()
+                inpt.close()
             except:
-                try:
-                    errmsg = err.value
-                except:
-                    errmsg = str(err)
-        err_msg = strng.to_text(errmsg)
-        lg.err('failed to write new broker info for %s : %s' % (self.customer_id, err_msg))
-        if err_msg.count('current revision is'):
+                pass
+            return
+        inpt.close()
+
+        if newpacket.Command == commands.RelayAck():
             try:
-                current_revision = re.search('current revision is (\d+)', err_msg).group(1)
-                current_revision = int(current_revision)
+                ack_info = serialization.BytesToDict(data, keys_to_text=True, values_to_text=True)
             except:
                 lg.exc()
-                current_revision = self.transaction['revision']
-            current_revision += 1
+                return
             if _Debug:
-                lg.warn('recognized "DHT write operation failed" because of late revision, increase revision to %d and retry' % current_revision)
-            if retry:
-                self._do_dht_write(
-                    desired_position=desired_broker_position,
-                    archive_folder_path=archive_folder_path,
-                    revision=current_revision,
-                    retry=False,
-                    event=event,
-                    **kwargs,
+                lg.out(_DebugLevel, '<<<Relay-ACK %s:%s from %s://%s with %d bytes %s' % (ack_info['command'], ack_info['packet_id'], info.proto, info.host, len(data), ack_info['error']))
+            if _PacketLogFileEnabled:
+                lg.out(
+                    0, '                \033[0;49;33mRELAY ACK %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
+                    (ack_info['command'], ack_info['packet_id'], info.bytes_received, global_id.UrlToGlobalID(ack_info['from']), global_id.UrlToGlobalID(ack_info['to']), info.transfer_id), log_name='packet', showtime=True
                 )
+            from bitdust.transport.proxy import proxy_sender
+            if proxy_sender.A():
+                proxy_sender.A('relay-ack', ack_info, info)
+            return True
+
+        if newpacket.Command == commands.RelayFail():
+            try:
+                fail_info = serialization.BytesToDict(data, keys_to_text=True, values_to_text=True)
+            except:
+                lg.exc()
                 return
-        if event == 'request-invalid':
-            self.automat('request-rejected', desired_position=desired_broker_position, archive_folder_path=archive_folder_path, **kwargs)
-        else:
-            self.automat('dht-write-failed', desired_position=desired_broker_position)
+            if _Debug:
+                lg.out(_DebugLevel, '<<<Relay-FAIL %s:%s from %s://%s with %d bytes %s' % (fail_info['command'], fail_info['packet_id'], info.proto, info.host, len(data), fail_info['error']))
+            if _PacketLogFileEnabled:
+                lg.out(
+                    0, '                \033[0;49;33mRELAY FAIL %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
+                    (fail_info['command'], fail_info['packet_id'], info.bytes_received, global_id.UrlToGlobalID(fail_info['from']), global_id.UrlToGlobalID(fail_info['to']), info.transfer_id), log_name='packet', showtime=True
+                )
+            from bitdust.transport.proxy import proxy_sender
+            if proxy_sender.A():
+                proxy_sender.A('relay-failed', fail_info, info)
+            return True
+
+        routed_packet = signed.Unserialize(data)
+        if not routed_packet:
+            lg.err('unserialize packet failed from %s' % newpacket.CreatorID)
+            return
 
-    def _on_broker_negotiator_callback(self, cooperated_brokers):
         if _Debug:
-            lg.args(_DebugLevel, cooperated_brokers=cooperated_brokers)
-        self.automat('accepted', cooperated_brokers=cooperated_brokers)
+            lg.out(_DebugLevel, '<<<Relay-IN %s from %s://%s with %d bytes' % (str(routed_packet), info.proto, info.host, len(data)))
+        if _PacketLogFileEnabled:
+            lg.out(
+                0, '                \033[0;49;33mRELAY IN %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
+                (routed_packet.Command, routed_packet.PacketID, info.bytes_received, global_id.UrlToGlobalID(info.sender_idurl), global_id.UrlToGlobalID(routed_packet.RemoteID), info.transfer_id), log_name='packet', showtime=True
+            )
 
-    def _on_broker_negotiator_errback(self, err):
-        if isinstance(err, Failure):
+        if routed_packet.Command == commands.Identity():
+            if _Debug:
+                lg.out(_DebugLevel, '    found identity in relay packet %s' % routed_packet)
+            newidentity = identity.identity(xmlsrc=routed_packet.Payload)
+            idurl = newidentity.getIDURL()
+            if not identitycache.HasKey(idurl):
+                lg.info('received new identity %s rev %r' % (idurl.original(), newidentity.getRevisionValue()))
+            if not identitycache.UpdateAfterChecking(idurl, routed_packet.Payload):
+                lg.warn('ERROR has non-Valid identity')
+                return
+
+        if routed_packet.Command in [
+            commands.Relay(),
+            commands.RelayIn(),
+        ] and routed_packet.PacketID.lower().startswith('identity:'):
+            if _Debug:
+                lg.out(_DebugLevel, '    found routed identity in relay packet %s' % routed_packet)
             try:
-                evt, args, kwargs = err.value.args
+                routed_identity = signed.Unserialize(routed_packet.Payload)
+                newidentity = identity.identity(xmlsrc=routed_identity.Payload)
+                idurl = newidentity.getIDURL()
+                if not identitycache.HasKey(idurl):
+                    lg.warn('received new "routed" identity: %s' % idurl)
+                if not identitycache.UpdateAfterChecking(idurl, routed_identity.Payload):
+                    lg.warn('ERROR has non-Valid identity')
+                    return
             except:
                 lg.exc()
-                return None
-            if _Debug:
-                lg.args(_DebugLevel, event=evt, args=args, kwargs=kwargs)
-            if evt == 'request-invalid':
-                self.automat('request-invalid', *args, **kwargs)
-                return None
-            if evt in [
-                'top-record-busy',
-                'prev-record-own',
-            ]:
-                self.automat('dht-mismatch', **kwargs)
-                return None
-            if evt in [
-                'broker-rejected',
-                'new-broker-rejected',
-                'broker-rotate-denied',
-            ]:
-                self.automat('cooperation-mismatch', **kwargs)
-                return None
-            if evt.count('-failed'):
-                self.automat('failed')
-                return None
-        else:
+
+        if newpacket.Command == commands.RelayIn() and routed_packet.Command == commands.Fail():
+            if routed_packet.Payload == b'route not exist' or routed_packet.Payload == b'route already closed':
+                for pout in packet_out.search_by_packet_id(routed_packet.PacketID):
+                    lg.warn('received %r from %r, outgoing packet is failed: %r' % (routed_packet.Payload, newpacket.CreatorID, pout))
+                    pout.automat('request-failed')
+                return
+
+        self.traffic_in += len(data)
+        packet_in.process(routed_packet, info)
+        del block
+        del data
+        del padded_data
+        del inpt
+        del session_key
+        del routed_packet
+
+    def _do_send_identity_to_router(self, identity_source, failed_event):
+        try:
+            identity_obj = identity.identity(xmlsrc=identity_source)
+        except:
+            lg.exc()
+            return
+        if _Debug:
+            lg.out(_DebugLevel, 'proxy_receiver._do_send_identity_to_router to %s' % self.router_idurl)
+            lg.out(_DebugLevel, '        contacts=%r, sources=%r' % (identity_obj.contacts, identity_obj.getSources(as_originals=True)))
+        newpacket = signed.Packet(
+            Command=commands.Identity(),
+            OwnerID=my_id.getIDURL(),
+            CreatorID=my_id.getIDURL(),
+            PacketID=('proxy_receiver:%s' % packetid.UniqueID()),
+            Payload=identity_obj.serialize(),
+            RemoteID=self.router_idurl,
+        )
+        packet_out.create(
+            newpacket,
+            wide=True,
+            callbacks={
+                commands.Ack(): lambda response, info: self.automat('ack-received', (response, info)),
+                commands.Fail(): lambda x: self.automat(failed_event),
+                None: lambda pkt_out: self.automat('ack-timeout', pkt_out),
+                'failed': lambda pkt_out, error_message: self.automat('sending-failed', (pkt_out, error_message)),
+            },
+            keep_alive=True,
+            response_timeout=settings.P2PTimeOut(),
+        )
+
+    def _do_send_request_service(self, *args, **kwargs):
+        if len(self.request_service_packet_id) >= 10:
             if _Debug:
-                lg.args(_DebugLevel, err=err)
-        self.automat('rejected', *args, **kwargs)
-        return None
+                lg.warn('too many service requests to %r' % self.router_idurl)
+            self.automat('service-refused', *args, **kwargs)
+            return
+        orig_identity = config.conf().getData('services/proxy-transport/my-original-identity').strip()
+        if not orig_identity:
+            orig_identity = my_id.getLocalIdentity().serialize(as_text=True)
+        service_info = {
+            'name': 'service_proxy_server',
+            'payload': {
+                'identity': orig_identity,
+            },
+        }
+        newpacket = signed.Packet(
+            commands.RequestService(),
+            my_id.getIDURL(),
+            my_id.getIDURL(),
+            packetid.UniqueID(),
+            serialization.DictToBytes(service_info, values_to_text=True),
+            self.router_idurl,
+        )
+        packet_out.create(
+            newpacket,
+            wide=False,
+            callbacks={
+                commands.Ack(): self._on_request_service_ack,
+                commands.Fail(): self._on_request_service_fail,
+                # 'timeout': lambda pkt_out, err: self.automat('request-timeout', pkt_out),
+                None: lambda pkt_out: self.automat('request-timeout', pkt_out),
+            },
+            response_timeout=settings.P2PTimeOut(),
+        )
+        self.request_service_packet_id.append(newpacket.PacketID)
 
-    def _on_queue_keeper_dht_refresh_task(self):
-        self._do_dht_push_state()
+    def _on_nodes_lookup_finished(self, idurls, attempts):
+        if _Debug:
+            lg.out(_DebugLevel, 'proxy_receiver._on_nodes_lookup_finished : %r' % idurls)
+        for idurl in idurls:
+            ident = identitycache.FromCache(idurl)
+            remoteprotos = set(ident.getProtoOrder())
+            myprotos = set(my_id.getLocalIdentity().getProtoOrder())
+            if len(myprotos.intersection(remoteprotos)) > 0:
+                self.possible_router_idurl = id_url.field(idurl)
+                if _Debug:
+                    lg.out(_DebugLevel, 'proxy_receiver._on_nodes_lookup_finished found : %r' % self.possible_router_idurl)
+                self.automat('found-one-node', self.possible_router_idurl)
+                return
+        if attempts > 0:
+            self._find_random_node(attempts - 1)
+        else:
+            self.automat('nodes-not-found')
 
-    def _on_broker_verify_result(self, ret):
+    def _find_random_node(self, attempts):
+        preferred_routers = []
+        preferred_routers_raw = config.conf().getString('services/proxy-transport/preferred-routers').strip()
+        if preferred_routers_raw:
+            preferred_routers_list = re.split('\n|,|;| ', preferred_routers_raw)
+            preferred_routers.extend(preferred_routers_list)
+        if preferred_routers:
+            self.possible_router_idurl = id_url.field(random.choice(preferred_routers))
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_receiver._find_random_node selected random item from preferred_routers: %r' % self.possible_router_idurl)
+            idcache_defer = identitycache.immediatelyCaching(self.possible_router_idurl)
+            idcache_defer.addCallback(lambda *args: self.automat('found-one-node', self.possible_router_idurl))
+            idcache_defer.addErrback(lambda err: self.automat('nodes-not-found') and None)
+            return
         if _Debug:
-            lg.args(_DebugLevel, ret=ret)
-        self.automat('accepted', cooperated_brokers=self.cooperated_brokers)
+            lg.out(_DebugLevel, 'proxy_receiver._find_random_node will start DHT lookup')
+        tsk = lookup.random_proxy_router()
+        if tsk:
+            tsk.result_defer.addCallback(self._on_nodes_lookup_finished, attempts=attempts)
+            tsk.result_defer.addErrback(lambda err: self.automat('nodes-not-found'))
+        else:
+            self.automat('nodes-not-found')
 
-    def _on_broker_verify_failed(self, err):
+    def _on_request_service_ack(self, response, info):
+        self.router_connection_info = None
+        if response.PacketID not in self.request_service_packet_id:
+            lg.warn('wrong PacketID in response: %s, but outgoing was : %s' % (response.PacketID, str(self.request_service_packet_id)))
+            self.automat('service-refused', (response, info))
+            return
+        if response.PacketID in self.request_service_packet_id:
+            self.request_service_packet_id.remove(response.PacketID)
+        else:
+            lg.warn('%s was not found in pending requests: %s' % (response.PacketID, self.request_service_packet_id))
         if _Debug:
-            lg.args(_DebugLevel, err=err)
-        self.automat('failed')
+            lg.out(_DebugLevel, 'proxy_receiver._on_request_service_ack : %s' % str(response.Payload))
+        if self.router_idurl != response.CreatorID:
+            lg.err('received unexpected response from another node: %r ~ %r' % (self.router_idurl, response.CreatorID))
+            self.automat('service-refused', (response, info))
+            return
+        service_ack_info = strng.to_text(response.Payload)
+        if service_ack_info.startswith('rejected'):
+            self.automat('service-refused', (response, info))
+            return
+        active_router_sessions = gateway.find_active_session(info.proto, host=info.host)
+        if not active_router_sessions:
+            active_router_sessions = gateway.find_active_session(info.proto, idurl=id_url.to_bin(response.CreatorID))
+        if not active_router_sessions:
+            lg.err('active connection with proxy router at %s:%s was not found' % (info.proto, info.host))
+            if _Debug:
+                lg.args(_DebugLevel, router_idurl=self.router_idurl, ack_packet=info, active_sessions=gateway.list_active_sessions(info.proto))
+            self.automat('service-refused', (response, info))
+            return
+        self.router_connection_info = {
+            'id': active_router_sessions[0].id,
+            'index': active_router_sessions[0].index,
+            'repr': repr(active_router_sessions[0]),
+            'proto': info.proto,
+            'host': info.host,
+            'idurl': self.router_idurl,
+            'global_id': global_id.UrlToGlobalID(self.router_idurl),
+        }
+        active_router_session_machine = automat.by_index(self.router_connection_info['index'])
+        if active_router_session_machine is None:
+            lg.err('did not found proxy router session state machine instance: %s' % self.router_connection_info)
+            self.router_connection_info = None
+            if _Debug:
+                lg.args(_DebugLevel, automats=automat.objects())
+            self.automat('service-refused', (response, info))
+            return
+        lg.info('found active session for proxy router: %s' % active_router_session_machine)
+        self.automat('service-accepted', (response, info, active_router_session_machine))
+
+    def _on_request_service_fail(self, response, info):
+        if response.PacketID not in self.request_service_packet_id:
+            lg.warn('wrong PacketID in response: %s, but outgoing was : %s' % (response.PacketID, str(self.request_service_packet_id)))
+        else:
+            self.request_service_packet_id.remove(response.PacketID)
+        self.automat('service-refused', (response, info))
+
+    def _on_inbox_packet_received(self, newpacket, info, status, error_message):
+        if newpacket.Command == commands.Identity() and \
+                newpacket.CreatorID == self.router_idurl and \
+                newpacket.RemoteID == my_id.getIDURL():
+            self.automat('router-id-received', (newpacket, info))
+            self.latest_packet_received = time.time()
+            return True
+        if newpacket.CreatorID == self.router_idurl:
+            self.latest_packet_received = time.time()
+        if newpacket.Command in [
+            commands.Relay(),
+            commands.RelayIn(),
+            commands.RelayAck(),
+            commands.RelayFail(),
+        ]:
+            if driver.is_enabled('service_proxy_server'):
+                # TODO:
+                # in case this node already running proxy router service this will not work
+                # actually you can not use proxy transport for receiving and running proxy router at same time
+                # need to change one of the services to solve that dependency and prevent this
+                return False
+            self.automat('inbox-packet', (newpacket, info, status, error_message))
+            return True
+        return False
+
+    def _on_router_contact_status_connected(self, oldstate, newstate, event_string, *args, **kwargs):
+        lg.info('router %r contact status online: %s->%s after "%s"' % (self.router_idurl, oldstate, newstate, event_string))
+
+    def _on_router_contact_status_offline(self, oldstate, newstate, event_string, *args, **kwargs):
+        lg.warn('router %r contact status offline: %s->%s after "%s"' % (self.router_idurl, oldstate, newstate, event_string))
+        # self.automat('router-disconnected')
+
+    def _on_router_session_disconnected(self, oldstate, newstate, event_string, *args, **kwargs):
+        lg.err('router session disconnected: %s->%s because of %r' % (oldstate, newstate, event_string))
+        self.automat('router-disconnected')
+
+    def _on_queue_item_status_changed(self, pkt_out, status, error=''):
+        from bitdust.transport.proxy import proxy_receiver
+        if status == 'finished':
+            return False
+        if error != 'connection failed':
+            return False
+        if not pkt_out.remote_idurl or not pkt_out.outpacket:
+            return False
+        if id_url.to_bin(pkt_out.remote_idurl) == pkt_out.outpacket.RemoteID.to_bin():
+            return False
+        if not proxy_receiver.GetRouterIDURL():
+            return False
+        if pkt_out.remote_idurl != proxy_receiver.GetRouterIDURL():
+            return False
+        lg.err('connection failed with current proxy router, must reconnect to another router: %r %r %r' % (pkt_out, status, error))
+        self.automat('router-disconnected')
+        return True
+
+
+#------------------------------------------------------------------------------
+
+
+def main():
+    from twisted.internet import reactor  # @UnresolvedImport
+    reactor.callWhenRunning(A, 'init')  # @UndefinedVariable
+    reactor.run()  # @UndefinedVariable
+
+
+if __name__ == '__main__':
+    main()
```

### Comparing `bitdust-0.1.8.234/bitdust/stun/__init__.py` & `bitdust-0.1.9.241/bitdust/stun/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/stun/stun_client.py` & `bitdust-0.1.9.241/bitdust/transport/packet_in.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/env python
-# stun_client.py
+# packet_in.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (stun_client.py) is part of BitDust Software.
+# This file (packet_in.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -16,664 +16,588 @@
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
 """
-.. module:: stun_client.
+.. module:: packet_in.
 
 .. role:: red
 
-BitDust ``stun_client()`` Automat
+BitDust packet_in() Automat
 
+.. raw:: html
+
+    <a href="packet_in.png" target="_blank">
+    <img src="packet_in.png" style="max-width:100%;">
+    </a>
 
 EVENTS:
-    * :red:`datagram-received`
-    * :red:`dht-nodes-not-found`
-    * :red:`found-some-nodes`
-    * :red:`init`
-    * :red:`port-number-received`
-    * :red:`shutdown`
-    * :red:`start`
-    * :red:`timer-10sec`
-    * :red:`timer-1sec`
-    * :red:`timer-2sec`
+    * :red:`cancel`
+    * :red:`failed`
+    * :red:`register-item`
+    * :red:`remote-id-cached`
+    * :red:`unregister-item`
+    * :red:`unserialize-failed`
+    * :red:`valid-inbox-packet`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
-from __future__ import print_function
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 10
-
-#------------------------------------------------------------------------------
+_DebugLevel = 16
 
-import sys
-import random
-import re
+_PacketLogFileEnabled = False
 
 #------------------------------------------------------------------------------
 
-if __name__ == '__main__':
-    import os.path as _p
-    sys.path.insert(0, _p.abspath(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..')))
+import os
+import time
+
+from twisted.internet import reactor  # @UnresolvedImport
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
-from bitdust.system import bpio
+from bitdust.main import settings
+from bitdust.main import config
 
 from bitdust.automats import automat
 
-from bitdust.lib import strng
-from bitdust.lib import udp
-from bitdust.lib import net_misc
 from bitdust.lib import nameurl
-from bitdust.lib import misc
+from bitdust.lib import strng
 
-from bitdust.main import settings
-from bitdust.main import events
+from bitdust.system import bpio
+from bitdust.system import tmpfile
+
+from bitdust.userid import global_id
+from bitdust.userid import id_url
+
+from bitdust.contacts import contactsdb
+from bitdust.contacts import identitycache
 
 from bitdust.services import driver
 
+from bitdust.p2p import commands
+from bitdust.p2p import p2p_stats
+
+from bitdust.transport import callback
+
+#------------------------------------------------------------------------------
+
+_InboxItems = {}
+_PacketsCounter = 0
+_History = []
+
+#------------------------------------------------------------------------------
+
+
+def init():
+    global _PacketLogFileEnabled
+    _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
+
+
+def shutdown():
+    global _PacketLogFileEnabled
+    _PacketLogFileEnabled = False
+
+
 #------------------------------------------------------------------------------
 
-_StunClient = None
+
+def get_packets_counter():
+    global _PacketsCounter
+    return _PacketsCounter
+
+
+def increment_packets_counter():
+    global _PacketsCounter
+    _PacketsCounter += 1
+
 
 #------------------------------------------------------------------------------
 
 
-def A(event=None, *args, **kwargs):
+def inbox_items():
+    global _InboxItems
+    return _InboxItems
+
+
+def create(transfer_id):
+    p = PacketIn(transfer_id)
+    inbox_items()[transfer_id] = p
+    # lg.out(10, 'packet_in.create  %s,  %d working items now' % (
+    #     transfer_id, len(items())))
+    return p
+
+
+def get(transfer_id):
+    return inbox_items().get(transfer_id, None)
+
+
+def search(sender_idurl=None, proto=None, host=None):
     """
-    Access method to interact with the state machine.
+    Returns list of transfer ids of incoming packets which satisfies given criteria.
     """
-    global _StunClient
-    if event is None:
-        return _StunClient
-    if _StunClient is None:
-        # set automat name and starting state here
-        _StunClient = StunClient(
-            name='stun_client',
-            state='AT_STARTUP',
-            debug_level=_DebugLevel,
-            log_events=_Debug,
-            log_transitions=_Debug,
+    if sender_idurl and not isinstance(sender_idurl, list):
+        sender_idurl = [
+            sender_idurl,
+        ]
+    results = set()
+    for transfer_id, itm in inbox_items().items():
+        if sender_idurl:
+            if itm.sender_idurl and itm.sender_idurl == sender_idurl:
+                results.add(transfer_id)
+                continue
+        if proto and host:
+            if itm.proto and itm.proto == proto and itm.host and itm.host == host:
+                results.add(transfer_id)
+                continue
+        if host:
+            if itm.host and itm.host == host:
+                results.add(transfer_id)
+                continue
+        if proto:
+            if itm.proto and itm.proto == proto:
+                results.add(transfer_id)
+                continue
+    return list(results)
+
+
+def history():
+    global _History
+    return _History
+
+
+#------------------------------------------------------------------------------
+
+
+def process(newpacket, info):
+    """
+    Main entry point where all incoming signed packets are coming from remote peers.
+    The main aspect here is to "authenticate" remote node - need to know it identity.
+    """
+    # from bitdust.p2p import p2p_service
+    from bitdust.transport import gateway
+    from bitdust.userid import my_id
+    if not driver.is_on('service_p2p_hookups'):
+        if _Debug:
+            lg.out(_DebugLevel, 'packet_in.process SKIP incoming packet, service_p2p_hookups is not started')
+        return None
+    if _Debug:
+        lg.out(
+            _DebugLevel, 'packet_in.process [%s/%s/%s]:%s(%s) from %s://%s is "%s"' % (
+                nameurl.GetName(newpacket.OwnerID),
+                nameurl.GetName(newpacket.CreatorID),
+                nameurl.GetName(newpacket.RemoteID),
+                newpacket.Command,
+                newpacket.PacketID,
+                info.proto,
+                info.host,
+                info.status,
+            )
         )
-    if event is not None:
-        _StunClient.automat(event, *args, **kwargs)
-    return _StunClient
+    if info.status != 'finished':
+        if _Debug:
+            lg.out(_DebugLevel, '    skip, packet status is : [%s]' % info.status)
+        return None
+
+
+#     if _PacketLogFileEnabled:
+#         lg.out(0, '        \033[0;49;92mIN %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
+#             newpacket.Command, newpacket.PacketID, info.bytes_received,
+#             global_id.UrlToGlobalID(info.sender_idurl), global_id.UrlToGlobalID(newpacket.RemoteID),
+#             info.transfer_id), log_name='packet', showtime=True)
+# we must know recipient identity
+    if not id_url.is_cached(newpacket.RemoteID):
+        d = identitycache.immediatelyCaching(newpacket.RemoteID)
+        d.addCallback(lambda _: process(newpacket, info))
+        d.addErrback(lambda err: lg.err('incoming remote ID is unknown, failed caching remote %s identity: %s' % (newpacket.RemoteID, str(err))) and None)
+        return d
+    if newpacket.Command == commands.Identity():
+        if not id_url.is_the_same(newpacket.RemoteID, my_id.getIDURL()):
+            if _Debug:
+                lg.out(_DebugLevel, '    incoming Identity is routed to another user')
+            if not gateway.on_identity_received(newpacket, send_ack=False):
+                lg.warn('received identity was not processed')
+                return None
+            # remote peer sending a valid identity to another peer routed via my machine
+            # need to handle that packet - it should be processed by proxy_server
+            return handle(newpacket, info)
+        # contact sending us current identity we might not have
+        # so we handle it before check that packet is valid
+        # because we might not have his identity on hands and so can not verify the packet
+        # so we check that his Identity is valid and save it into cache
+        # than we check the packet to be valid too.
+        if not gateway.on_identity_received(newpacket):
+            lg.warn('received identity was not processed')
+            return None
+    if not identitycache.HasKey(newpacket.CreatorID):
+        if _Debug:
+            lg.out(_DebugLevel, '    will cache remote identity %s before processing incoming packet %s' % (newpacket.CreatorID, newpacket))
+        d = identitycache.immediatelyCaching(newpacket.CreatorID)
+        d.addCallback(lambda _: handle(newpacket, info))
+        d.addErrback(lambda err: lg.err('failed caching remote %s identity: %s' % (newpacket.CreatorID, str(err))) and None)
+        return d
+    return handle(newpacket, info)
 
 
-class StunClient(automat.Automat):
+def handle(newpacket, info):
     """
-    This class implements all the functionality of the ``stun_client()`` state
-    machine.
+    Actually process incoming packet. Here we can be sure that owner/creator of the packet is identified.
     """
-    # fast = True
+    from bitdust.transport import packet_out
+    handled = False
+    # check that signed by a contact of ours
+    try:
+        is_signature_valid = newpacket.Valid(raise_signature_invalid=False)
+    except:
+        is_signature_valid = False
+        # lg.exc('new packet from %s://%s is NOT VALID:\n\n%r\n' % (
+        #     info.proto, info.host, newpacket.Serialize()))
+    if not is_signature_valid:
+        if _Debug:
+            lg.args(_DebugLevel, PacketID=newpacket.PacketID, OwnerID=newpacket.OwnerID, CreatorID=newpacket.CreatorID, RemoteID=newpacket.RemoteID)
+        lg.warn('signature is not valid for %r from %r|%r to %r' % (newpacket, newpacket.OwnerID, newpacket.CreatorID, newpacket.RemoteID))
+        return None
+    try:
+        if not commands.IsRelay(newpacket.Command):
+            for p in packet_out.search_by_response_packet(newpacket, info.proto, info.host):
+                p.automat('inbox-packet', (newpacket, info))
+                handled = True
+                if _Debug:
+                    lg.out(_DebugLevel, '    processed by %s as response packet' % p)
+    except:
+        lg.exc()
+    try:
+        handled = callback.run_inbox_callbacks(newpacket, info, info.status, info.error_message) or handled
+    except:
+        lg.exc()
+    if not handled and newpacket.Command not in [
+        commands.Ack(),
+        commands.Fail(),
+        commands.Identity(),
+    ]:
+        lg.warn('incoming %s from [%s://%s] was NOT HANDLED' % (newpacket, info.proto, info.host))
+        if _PacketLogFileEnabled:
+            lg.out(
+                0,
+                '                \033[1;49;91mIN NOT HANDLED %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
+                    newpacket.Command,
+                    newpacket.PacketID,
+                    info.bytes_received,
+                    global_id.UrlToGlobalID(info.sender_idurl),
+                    global_id.UrlToGlobalID(newpacket.RemoteID),
+                    info.transfer_id,
+                ),
+                log_name='packet',
+                showtime=True,
+            )
+    else:
+        if _PacketLogFileEnabled:
+            lg.out(
+                0,
+                '                \033[0;49;93mIN OK %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
+                    newpacket.Command,
+                    newpacket.PacketID,
+                    info.bytes_received,
+                    global_id.UrlToGlobalID(info.sender_idurl),
+                    global_id.UrlToGlobalID(newpacket.RemoteID),
+                    info.transfer_id,
+                ),
+                log_name='packet',
+                showtime=True,
+            )
+    if _Debug and False:
+        history().append(
+            {
+                'time': newpacket.Date,
+                'command': newpacket.Command,
+                'packet_id': newpacket.PacketID,
+                'creator_id': newpacket.CreatorID,
+                'owner_id': newpacket.OwnerID,
+                'remote_id': newpacket.RemoteID,
+                'payload': len(newpacket.Payload),
+                'address': '%s://%s' % (info.proto, info.host),
+            }
+        )
+        if len(history()) > 100:
+            history().pop(0)
+    return handled
+
 
-    timers = {
-        'timer-1sec': (1.0, ['REQUEST']),
-        'timer-2sec': (2.0, ['REQUEST']),
-        'timer-10sec': (10.0, ['PORT_NUM?', 'REQUEST']),
-    }
-
-    MESSAGES = {
-        'MSG_01': 'not found any DHT nodes',
-        'MSG_02': 'not found any available stun servers',
-        'MSG_03': 'timeout responding from stun servers',
-    }
+#------------------------------------------------------------------------------
 
-    def msg(self, msgid, *args, **kwargs):
-        return self.MESSAGES.get(msgid, '')
 
-    def init(self):
-        self.listen_port = None
-        self.callbacks = []
-        self.find_nodes_attempts = 1
-        self.minimum_needed_servers = 1
-        self.minimum_needed_results = 1
-        self.stun_nodes = []
-        self.stun_servers = []
-        self.stun_results = {}
-        self.my_address = None
-        self.deferreds = {}
+class PacketIn(automat.Automat):
+    """
+    This class implements all the functionality of the ``packet_in()`` state
+    machine.
+    """
+    def __init__(self, transfer_id):
+        self.transfer_id = transfer_id
+        self.time = None
+        self.timeout = None
+        self.proto = None
+        self.host = None
+        self.sender_idurl = None
+        self.filename = None
+        self.size = None
+        self.bytes_received = None
+        self.status = None
+        self.error_message = None
+        _counter = get_packets_counter()
+        increment_packets_counter()
+        self.label = ''
+        automat.Automat.__init__(
+            self,
+            name='in_%d_%s' % (_counter, self.transfer_id),
+            state='AT_STARTUP',
+            debug_level=_DebugLevel,
+            log_events=_Debug,
+            log_transitions=_Debug,
+            publish_events=False,
+        )
+
+    def __repr__(self):
+        """
+        Will return something like: "in_4_1315435345[Ack(987654321)](DONE)".
+        """
+        return '%s%s(%s)' % (self.id, self.label, self.state)
 
-    def getMyExternalAddress(self):
-        return self.my_address
+    def is_timed_out(self):
+        #         if self.time is None or self.timeout is None:
+        #             return False
+        #         return time.time() - self.time > self.timeout
+        return False
 
-    def dropMyExternalAddress(self):
-        self.my_address = None
+    def init(self):
+        """
+        Method to initialize additional variables and flags at creation of the
+        state machine.
+        """
 
     def A(self, event, *args, **kwargs):
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
-            if event == 'init':
-                self.state = 'STOPPED'
+            if event == 'register-item':
+                self.state = 'RECEIVING'
                 self.doInit(*args, **kwargs)
-        #---STOPPED---
-        elif self.state == 'STOPPED':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'start':
-                self.state = 'RANDOM_NODES'
-                self.doAddCallback(*args, **kwargs)
-                self.doDHTFindRandomNode(*args, **kwargs)
-        #---REQUEST---
-        elif self.state == 'REQUEST':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
+        #---RECEIVING---
+        elif self.state == 'RECEIVING':
+            if event == 'cancel':
+                self.doCancelItem(*args, **kwargs)
+            elif event == 'unregister-item' and not self.isTransferFinished(*args, **kwargs):
+                self.state = 'FAILED'
+                self.doReportFailed(*args, **kwargs)
+                self.doEraseInputFile(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'timer-2sec':
-                self.doStun(*args, **kwargs)
-            elif event == 'timer-10sec' and not self.isSomeServersResponded(*args, **kwargs):
-                self.state = 'STOPPED'
-                self.doReportFailed(self.msg('MSG_03', *args, **kwargs))
-                self.doClearResults(*args, **kwargs)
-            elif event == 'start':
-                self.doAddCallback(*args, **kwargs)
-            elif event == 'datagram-received' and self.isMyIPPort(*args, **kwargs) and self.isNeedMoreResults(*args, **kwargs):
-                self.doRecordResult(*args, **kwargs)
-            elif event == 'port-number-received':
-                self.doAddStunServer(*args, **kwargs)
-                self.doStun(*args, **kwargs)
-            elif (event == 'timer-1sec' and self.isSomeServersResponded(*args, **kwargs)) or (event == 'datagram-received' and self.isMyIPPort(*args, **kwargs) and not self.isNeedMoreResults(*args, **kwargs)):
-                self.state = 'KNOW_MY_IP'
-                self.doRecordResult(*args, **kwargs)
-                self.doReportSuccess(*args, **kwargs)
-                self.doClearResults(*args, **kwargs)
-        #---KNOW_MY_IP---
-        elif self.state == 'KNOW_MY_IP':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
+            elif event == 'unregister-item' and self.isTransferFinished(*args, **kwargs) and not self.isRemoteIdentityCached(*args, **kwargs):
+                self.state = 'CACHING'
+                self.doCacheRemoteIdentity(*args, **kwargs)
+            elif event == 'unregister-item' and self.isTransferFinished(*args, **kwargs) and self.isRemoteIdentityCached(*args, **kwargs):
+                self.state = 'INBOX?'
+                self.doReadAndUnserialize(*args, **kwargs)
+        #---INBOX?---
+        elif self.state == 'INBOX?':
+            if event == 'valid-inbox-packet':
+                self.state = 'DONE'
+                self.doReportReceived(*args, **kwargs)
+                self.doEraseInputFile(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'start':
-                self.state = 'RANDOM_NODES'
-                self.doAddCallback(*args, **kwargs)
-                self.doDHTFindRandomNode(*args, **kwargs)
-        #---RANDOM_NODES---
-        elif self.state == 'RANDOM_NODES':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
+            elif event == 'unserialize-failed':
+                self.state = 'FAILED'
+                self.doReportFailed(*args, **kwargs)
+                self.doEraseInputFile(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'dht-nodes-not-found':
-                self.state = 'STOPPED'
-                self.doReportFailed(self.msg('MSG_01', *args, **kwargs))
-            elif event == 'start':
-                self.doAddCallback(*args, **kwargs)
-            elif event == 'found-some-nodes' and self.isNeedMoreNodes(*args, **kwargs):
-                self.doRememberStunNodes(*args, **kwargs)
-                self.doDHTFindRandomNode(*args, **kwargs)
-            elif event == 'found-some-nodes' and not self.isNeedMoreNodes(*args, **kwargs):
-                self.state = 'PORT_NUM?'
-                self.doRememberStunNodes(*args, **kwargs)
-                self.doRequestStunPortNumbers(*args, **kwargs)
-        #---PORT_NUM?---
-        elif self.state == 'PORT_NUM?':
-            if event == 'start':
-                self.doAddCallback(*args, **kwargs)
-            elif event == 'timer-10sec':
-                self.state = 'STOPPED'
-                self.doReportFailed(self.msg('MSG_02', *args, **kwargs))
-                self.doClearResults(*args, **kwargs)
-            elif event == 'port-number-received':
-                self.state = 'REQUEST'
-                self.doAddStunServer(*args, **kwargs)
-                self.doStun(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-        #---CLOSED---
-        elif self.state == 'CLOSED':
+        #---FAILED---
+        elif self.state == 'FAILED':
+            pass
+        #---DONE---
+        elif self.state == 'DONE':
             pass
+        #---CACHING---
+        elif self.state == 'CACHING':
+            if event == 'failed':
+                self.state = 'FAILED'
+                self.doReportCacheFailed(*args, **kwargs)
+                self.doEraseInputFile(*args, **kwargs)
+                self.doDestroyMe(*args, **kwargs)
+            elif event == 'remote-id-cached':
+                self.state = 'INBOX?'
+                self.doReadAndUnserialize(*args, **kwargs)
         return None
 
-    def isMyIPPort(self, *args, **kwargs):
+    def isTransferFinished(self, *args, **kwargs):
         """
         Condition method.
         """
-        try:
-            datagram, address = args[0]
-            command, payload = datagram
-        except:
+        status, bytes_received, _ = args[0]
+        if status != 'finished':
             return False
-        return command == udp.CMD_MYIPPORT
-
-    def isSomeServersResponded(self, *args, **kwargs):
-        """
-        Condition method.
-        """
-        return len(self.stun_results) > 0
-
-    def isNeedMoreResults(self, *args, **kwargs):
-        """
-        Condition method.
-        """
-        return len(self.stun_results) <= self.minimum_needed_results
+        if self.size and self.size > 0 and self.size != bytes_received:
+            return False
+        return True
 
-    def isNeedMoreNodes(self, *args, **kwargs):
+    def isRemoteIdentityCached(self, *args, **kwargs):
         """
         Condition method.
         """
-        return len(self.stun_nodes) + len(*args, **kwargs) < self.minimum_needed_servers
+        if not self.sender_idurl:
+            return True
+        return self.sender_idurl and identitycache.HasKey(self.sender_idurl)
 
     def doInit(self, *args, **kwargs):
         """
         Action method.
         """
-        self.listen_port = args[0]
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.doInit on port %d' % self.listen_port)
-        if udp.proto(self.listen_port):
-            udp.proto(self.listen_port).add_callback(self._datagram_received)
+        self.proto, self.host, self.sender_idurl, self.filename, self.size = args[0]
+        self.time = time.time()
+        # 300  # max(10 * int(self.size/float(settings.SendingSpeedLimit())), 10)
+        if self.size < 1024*10:
+            self.timeout = 10
+        elif self.size > 1024*1024:
+            self.timeout = int(self.size/float(settings.SendingSpeedLimit()))
         else:
-            lg.warn('udp port %s is not opened' % self.listen_port)
-
-    def doAddCallback(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        if args and args[0]:
-            self.callbacks.append(args[0])
-
-    def doDHTFindRandomNode(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._find_random_node()
+            self.timeout = 300
+        if not self.sender_idurl:
+            lg.warn('sender_idurl is None: %s' % str(*args, **kwargs))
+        reactor.callLater(0, callback.run_begin_file_receiving_callbacks, self)  # @UndefinedVariable
 
-    def doRememberStunNodes(self, *args, **kwargs):
+    def doEraseInputFile(self, *args, **kwargs):
         """
         Action method.
         """
-        nodes = args[0]
-        for node in nodes:
-            if node not in self.stun_nodes:
-                self.stun_nodes.append(node)
+        reactor.callLater(1, tmpfile.throw_out, self.filename, 'received')  # @UndefinedVariable
 
-    def doRequestStunPortNumbers(self, *args, **kwargs):
+    def doCancelItem(self, *args, **kwargs):
         """
         Action method.
         """
-        if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client.doRequestStunPortNumbers')
-        for node in self.stun_nodes:
-            if node.id in self.deferreds:
-                lg.warn('Already requested stun_port from %r' % node)
-                continue
-            if _Debug:
-                lg.out(_DebugLevel + 4, '    from %s' % node)
-            d = node.request('stun_port')
-            d.addBoth(self._stun_port_received, node)
-            self.deferreds[node.id] = d
+        from bitdust.transport import gateway
+        t = gateway.transports().get(self.proto, None)
+        if t:
+            t.call('cancel_file_receiving', self.transfer_id)
 
-    def doAddStunServer(self, *args, **kwargs):
+    def doCacheRemoteIdentity(self, *args, **kwargs):
         """
         Action method.
         """
-        if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client.doAddStunServer %s' % str(*args, **kwargs))
-        self.stun_servers.append(args[0])
+        d = identitycache.immediatelyCaching(self.sender_idurl)
+        d.addCallback(self._on_remote_identity_cached, *args, **kwargs)
+        d.addErrback(self._on_remote_identity_cache_failed, *args, **kwargs)
 
-    def doStun(self, *args, **kwargs):
+    def doReadAndUnserialize(self, *args, **kwargs):
         """
         Action method.
         """
-        if args and args[0] is not None:
+        from bitdust.transport import gateway
+        self.status, self.bytes_received, self.error_message = args[0]
+        if _PacketLogFileEnabled:
+            lg.out(
+                0,
+                '                \033[2;49;32mRECEIVED %d bytes from %s://%s TID:%s\033[0m' % (self.bytes_received, self.proto, self.host, self.transfer_id),
+                log_name='packet',
+                showtime=True,
+            )
+        # DO UNSERIALIZE HERE , no exceptions
+        newpacket = gateway.inbox(self)
+        if newpacket is None:
             if _Debug:
-                lg.out(_DebugLevel + 4, 'stun_client.doStun to one stun_server: %s' % str(*args, **kwargs))
-            udp.send_command(self.listen_port, udp.CMD_STUN, b'', *args, **kwargs)
+                lg.out(_DebugLevel, '<<< IN <<< !!!NONE!!! [%s] %s from %s %s' % (
+                    self.proto.upper().ljust(5),
+                    self.status.ljust(8),
+                    self.host,
+                    os.path.basename(self.filename),
+                ))
+            # net_misc.ConnectionFailed(None, proto, 'receiveStatusReport %s' % host)
+            try:
+                fd, _ = tmpfile.make('error', extension='.inbox')
+                data = bpio.ReadBinaryFile(self.filename)
+                os.write(fd, strng.to_bin('from %s:%s %s\n' % (self.proto, self.host, self.status)))
+                os.write(fd, data)
+                os.close(fd)
+            except:
+                lg.exc()
+            if os.path.isfile(self.filename):
+                try:
+                    os.remove(self.filename)
+                except:
+                    lg.exc()
+            self.automat('unserialize-failed', None)
             return
+        self.label = '[%s@%s]' % (newpacket.Command, newpacket.PacketID)
         if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client.doStun to %d stun_servers' % (len(self.stun_servers)))  # , self.stun_servers))
-        for address in self.stun_servers:
-            if address is None:
-                continue
-            if address in list(self.stun_results.keys()):
-                continue
-            udp.send_command(self.listen_port, udp.CMD_STUN, b'', address)
-
-    def doRecordResult(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        if not args or args[0] is None:
-            return
-        try:
-            datagram, address = args[0]
-            command, payload = datagram
-            ip, port = payload.split(b':')
-            port = int(port)
-        except:
-            lg.exc()
-        self.stun_results[address] = (ip, port)
-        # if len(self.stun_results) >= len(self.stun_servers):
-        #     self.automat('all-responded')
+            lg.out(_DebugLevel, 'packet_in.doReadAndUnserialize: %s' % newpacket)
+        self.automat('valid-inbox-packet', newpacket)
 
-    def doClearResults(self, *args, **kwargs):
+    def doReportReceived(self, *args, **kwargs):
         """
         Action method.
         """
-        self.stun_nodes = []
-        self.stun_servers = []
-        self.stun_results = {}
+        newpacket = args[0]
+        p2p_stats.count_inbox(self.sender_idurl, self.proto, self.status, self.bytes_received)
+        process(newpacket, self)
 
-    def doReportSuccess(self, *args, **kwargs):
+    def doReportFailed(self, *args, **kwargs):
         """
         Action method.
         """
         try:
-            min_port = min([addr[1] for addr in list(self.stun_results.values())])
-            max_port = max([addr[1] for addr in list(self.stun_results.values())])
-            my_ip = strng.to_text(list(self.stun_results.values())[0][0])
-            if min_port == max_port:
-                result = ('stun-success', 'non-symmetric', my_ip, min_port)
-            else:
-                result = ('stun-success', 'symmetric', my_ip, self.stun_results)
-            self.my_address = (my_ip, min_port)
+            status, bytes_received, _ = args[0]
         except:
-            lg.exc()
-            result = ('stun-failed', None, None, [])
-            self.my_address = None
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.doReportSuccess based on %d nodes: %r' % (len(self.stun_results), result))
-        if self.my_address:
-            current_external_ip = misc.readExternalIP()
-            if current_external_ip != self.my_address[0]:
-                events.send('my-external-ip-changed', data=dict(
-                    old=current_external_ip,
-                    new=self.my_address[0],
-                ))
-            bpio.WriteTextFile(settings.ExternalIPFilename(), self.my_address[0])
-            bpio.WriteTextFile(settings.ExternalUDPPortFilename(), str(self.my_address[1]))
-        for cb in self.callbacks:
-            cb(result[0], result[1], result[2], result[3])
-        self.callbacks = []
+            status = 'failed'
+            bytes_received = 0
+        p2p_stats.count_inbox(self.sender_idurl, self.proto, status, bytes_received)
+        lg.warn('incoming packet failed %s with %s' % (self.transfer_id, status))
+        if _PacketLogFileEnabled:
+            lg.out(
+                0,
+                '                \033[0;49;31mIN FAILED with status "%s" from %s://%s TID:%s\033[0m' % (status, self.proto, self.host, self.transfer_id),
+                log_name='packet',
+                showtime=True,
+            )
 
-    def doReportFailed(self, *args, **kwargs):
+    def doReportCacheFailed(self, *args, **kwargs):
         """
         Action method.
         """
-        self.my_address = None
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.doReportFailed : %s' % args[0])
-        for cb in self.callbacks:
-            cb('stun-failed', None, None, [])
-        self.callbacks = []
+        if args and args[0]:
+            status, bytes_received, msg = args[0]
+            p2p_stats.count_inbox(self.sender_idurl, self.proto, status, bytes_received)
+        else:
+            status = 'failed'
+            bytes_received = 0
+            msg = 'unknown reason'
+        lg.warn('cache failed : %s' % self.sender_idurl)
+        if _PacketLogFileEnabled:
+            lg.out(
+                0,
+                '                \033[0;49;31mIN CACHE FAILED with "%s" for %s TID:%s\033[0m' % (msg, self.sender_idurl, self.transfer_id),
+                log_name='packet',
+                showtime=True,
+            )
 
     def doDestroyMe(self, *args, **kwargs):
         """
-        Action method.
+        Remove all references to the state machine object to destroy it.
         """
-        global _StunClient
-        _StunClient = None
-        for d in list(self.deferreds.values()):
-            if d and not d.called:
-                d.cancel()
-        self.deferreds.clear()
-        if udp.proto(self.listen_port):
-            udp.proto(self.listen_port).remove_callback(self._datagram_received)
+        inbox_items().pop(self.transfer_id)
         self.destroy()
 
-    def _datagram_received(self, datagram, address):
-        self.automat('datagram-received', (
-            datagram,
-            address,
-        ))
-        return False
-
-    def _find_random_nodes(self, tries, result_list, prev_key=None):
-        if prev_key and prev_key in self.deferreds:
-            self.deferreds.pop(prev_key)
-        if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client._find_random_nodes tries=%d result_list=%d' % (tries, len(result_list)))
-        if tries <= 0 or len(result_list) >= self.minimum_needed_servers:
-            if len(result_list) > 0:
-                self.automat('found-some-nodes', result_list)
-            else:
-                self.automat('dht-nodes-not-found')
-            return
-        from bitdust.dht import dht_service
-        new_key = dht_service.random_key()
-        d = dht_service.find_node(new_key)
-        d.addCallback(lambda nodes: self._find_random_nodes(tries - 1, list(set(result_list + nodes)), new_key))
-        d.addErrback(lambda x: self._find_random_nodes(tries - 1, result_list, new_key))
-        self.deferreds[new_key] = d
-
-    def _find_random_node(self):
-        if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client._find_random_node')
-        from bitdust.dht import dht_service
-        new_key = dht_service.random_key()
-        d = dht_service.find_node(new_key)
-        d.addCallback(self._some_nodes_found)
-        d.addErrback(self._nodes_not_found)
-        # self.deferreds[new_key] = d
-
-    def _some_nodes_found(self, nodes):
-        if _Debug:
-            lg.out(_DebugLevel + 4, 'stun_client._some_nodes_found : %r' % nodes)
-        if nodes and len(nodes) > 0:
-            self.automat('found-some-nodes', nodes)
+    def _on_remote_identity_cached(self, xmlsrc, *args, **kwargs):
+        sender_identity = contactsdb.get_contact_identity(self.sender_idurl)
+        if sender_identity is None:
+            self.automat('failed')
         else:
-            self.automat('dht-nodes-not-found')
-
-    def _nodes_not_found(self, err):
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client._nodes_not_found err=%s' % str(err))
-        self.automat('dht-nodes-not-found')
-
-    def _stun_port_received(self, result, node):
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client._stun_port_received  %r from %s node_id=%r' % (result, node, node.id))
-        self.deferreds.pop(node.id, None)
-        if not isinstance(result, dict):
-            if _Debug:
-                lg.dbg(_DebugLevel, 'empty result received from node %r : %r' % (node, result))
-            return
-        try:
-            port = int(strng.to_text(result['stun_port']))
-            address = node.address
-        except:
-            lg.exc()
-            return
-        if port == 0:
-            return
-        if _Debug:
-            lg.out(_DebugLevel, '        new stun port server found  %s:%s' % (address, port))
-        self.automat('port-number-received', (address, port))
-
-
-#------------------------------------------------------------------------------
-
-
-def udp_dht_stun(udp_port=None, dht_port=None, result_defer=None):
-    if not driver.is_on('service_my_ip_port'):
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   SKIP because service_my_ip_port() is not started')
-        if result_defer:
-            result_defer.errback(Exception('service_my_ip_port() is not started'))
-        return False
-
-    from bitdust.dht import dht_service
-
-    if dht_service.node().connectingTask() and not dht_service.node().connectingTask().called:
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   SKIP and run later because dht_service is still joining the network')
-        dht_service.node().connectingTask().addCallback(lambda ok: udp_dht_stun(udp_port=udp_port, dht_port=dht_port, result_defer=result_defer))
-        if result_defer:
-            dht_service.node().connectingTask().addErrback(result_defer.errback)
-        return True
-
-    dht_port = dht_port or settings.getDHTPort()
-    udp_port = udp_port or settings.getUDPPort()
-    if udp_port:
-        udp.listen(udp_port)
-    if dht_port:
-        dht_service.init(dht_port)
-    d = dht_service.connect()
-
-    def _cb(cod, typ, ip, details):
-        # A('shutdown')
-        ret = {
-            'result': cod,  # 'stun-success' or 'stun-failed'
-            'type': typ,
-            'ip': ip,
-            'details': details,
-        }
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   result : %r' % ret)
-        result_defer.callback(ret)
-        return None
-
-    def _go(live_nodes):
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.udp_dht_stun   GO with nodes: %r' % live_nodes)
-        A('init', udp_port)
-        A('start', _cb)
-        return live_nodes
-
-    d.addCallback(_go)
-    if result_defer:
-        d.addErrback(result_defer.errback)
-        # d.addErrback(lambda err: result_defer.callback(dict(ip='127.0.0.1', errors=[str(err), ])))
-    return True
-
-
-def http_stun(result_defer=None):
-    from bitdust.userid import known_servers
-    identity_servers = known_servers.by_host()
-    if not identity_servers:
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.http_stun   SKIP, no known identity servers found')
-        return False
-    one_host = random.choice(list(identity_servers.keys()))
-    one_port = identity_servers[one_host][0]
-    one_url = nameurl.UrlMake('http', one_host, one_port)
-    if _Debug:
-        lg.out(_DebugLevel, 'stun_client.http_stun   GO with one node : %r' % one_url)
-
-    def _check_body(html_response):
-        ret = {
-            'result': 'stun-failed',
-            'type': None,
-            'ip': None,
-            'details': ['unknown client host from response'],
-        }
-        mo = re.search(b'\<\!\-\-CLIENT_HOST\=([\d\.]+):(\d+)\-\-\>', html_response)
-        if not mo:
-            if _Debug:
-                lg.out(_DebugLevel, 'stun_client.http_stun   FAILED : unknown client host from response')
-            if result_defer:
-                result_defer.callback(ret)
-            return None
-        ret = {
-            'result': 'stun-success',
-            'type': 'unknown',
-            'ip': strng.to_text(mo.group(1)),
-            'details': [],
-        }
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.http_stun   SUCCESS : %r' % ret)
-        if result_defer:
-            result_defer.callback(ret)
-        return None
-
-    def _request_failed(err):
-        if _Debug:
-            lg.out(_DebugLevel, 'stun_client.http_stun   FAILED : %r' % err)
-        ret = {
-            'result': 'stun-failed',
-            'type': None,
-            'ip': None,
-            'details': [err.getErrorMessage()],
-        }
-        if result_defer:
-            result_defer.callback(ret)
-        return None
-
-    d = net_misc.getPageTwisted(one_url)
-    d.addCallback(_check_body)
-    d.addErrback(_request_failed)
-    return True
-
-
-def safe_stun(udp_port=None, dht_port=None, result_defer=None):
-    from twisted.internet.defer import Deferred
-    result = result_defer or Deferred()
-
-    def _check_response(response):
-        if response.get('result') == 'stun-success':
-            result.callback(response)
-            return None
-        http_stun(result_defer=result)
-        return None
+            self.automat('remote-id-cached', *args, **kwargs)
 
-    def _fallback(err):
-        http_stun(result_defer=result)
+    def _on_remote_identity_cache_failed(self, err, *args, **kwargs):
+        lg.warn('%s : %s' % (repr(self), str(err)))
+        self.automat('failed')
         return None
-
-    first_result = Deferred()
-    first_result.addCallback(_check_response)
-    first_result.addErrback(_fallback)
-    udp_dht_stun(udp_port, dht_port, result_defer=first_result)
-    return result
-
-
-def test_safe_stun():
-    from twisted.internet import reactor  # @UnresolvedImport
-
-    def _cb(res):
-        print(res)
-        reactor.stop()  # @UndefinedVariable
-
-    def _eb(err):
-        print(err)
-        reactor.stop()  # @UndefinedVariable
-
-    lg.set_debug_level(30)
-    safe_stun().addCallbacks(_cb, _eb)
-    reactor.run()  # @UndefinedVariable
-
-
-#------------------------------------------------------------------------------
-
-
-def main():
-    from twisted.internet import reactor  # @UnresolvedImport
-    from bitdust.dht import dht_service
-    settings.init()
-    lg.set_debug_level(30)
-    dht_port = settings.getDHTPort()
-    udp_port = settings.getUDPPort()
-    if len(sys.argv) > 1:
-        dht_port = int(sys.argv[1])
-    if len(sys.argv) > 2:
-        udp_port = int(sys.argv[2])
-    dht_service.init(dht_port)
-    dht_service.connect()
-    udp.listen(udp_port)
-
-    def _cb(result, typ, ip, details):
-        print(result, typ, ip, details)
-        A('shutdown')
-        reactor.stop()  # @UndefinedVariable
-
-    A('init', (udp_port))
-    A('start', _cb)
-    reactor.run()  # @UndefinedVariable
-    settings.shutdown()
-
-
-#------------------------------------------------------------------------------
-
-if __name__ == '__main__':
-    from twisted.internet.defer import setDebugging
-    setDebugging(True)
-    # main()
-    test_safe_stun()
```

### Comparing `bitdust-0.1.8.234/bitdust/stun/stun_server.py` & `bitdust-0.1.9.241/bitdust/stun/stun_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/supplier/__init__.py` & `bitdust-0.1.9.241/bitdust/supplier/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/supplier/customer_assistant.py` & `bitdust-0.1.9.241/bitdust/supplier/customer_assistant.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/supplier/customer_space.py` & `bitdust-0.1.9.241/bitdust/supplier/customer_space.py`

 * *Files 22% similar despite different names*

```diff
@@ -25,20 +25,16 @@
 """
 .. module:: customer_space.
 
 """
 
 #------------------------------------------------------------------------------
 
-from __future__ import absolute_import
-
-#------------------------------------------------------------------------------
-
 _Debug = False
-_DebugLevel = 6
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import os
 import time
 import base64
 
@@ -49,14 +45,15 @@
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
 from bitdust.lib import strng
 from bitdust.lib import packetid
 from bitdust.lib import serialization
+from bitdust.lib import jsn
 
 from bitdust.system import bpio
 
 from bitdust.main import settings
 from bitdust.main import events
 
 from bitdust.contacts import contactsdb
@@ -68,17 +65,22 @@
 
 from bitdust.storage import accounting
 
 from bitdust.crypt import signed
 from bitdust.crypt import my_keys
 
 from bitdust.transport import gateway
+from bitdust.transport import callback
 
 from bitdust.stream import p2p_queue
 
+from bitdust.dht import dht_service
+from bitdust.dht import dht_records
+from bitdust.dht import known_nodes
+
 from bitdust.supplier import list_files
 from bitdust.supplier import local_tester
 
 from bitdust.userid import global_id
 from bitdust.userid import id_url
 from bitdust.userid import my_id
 
@@ -86,14 +88,70 @@
 
 _SupplierFileModifiedLatest = {}
 _SupplierFileModifiedNotifyTasks = {}
 
 #------------------------------------------------------------------------------
 
 
+def init():
+    callback.append_inbox_callback(on_inbox_packet_received)
+    events.add_subscriber(on_identity_url_changed, 'identity-url-changed')
+    events.add_subscriber(on_customer_accepted, 'existing-customer-accepted')
+    events.add_subscriber(on_customer_accepted, 'new-customer-accepted')
+    events.add_subscriber(on_customer_terminated, 'existing-customer-denied')
+    events.add_subscriber(on_customer_terminated, 'existing-customer-terminated')
+    space_dict, _ = accounting.read_customers_quotas()
+    for customer_idurl in contactsdb.customers():
+        known_customer_meta_info = contactsdb.get_customer_meta_info(customer_idurl)
+        # yapf: disable
+        events.send('existing-customer-accepted', data=dict(
+            idurl=customer_idurl,
+            allocated_bytes=space_dict.get(customer_idurl.to_bin()),
+            ecc_map=known_customer_meta_info.get('ecc_map'),
+            position=known_customer_meta_info.get('position'),
+        ))
+        # yapf: enable
+    if driver.is_on('service_entangled_dht'):
+        connect_suppliers_dht_layer()
+    else:
+        lg.warn('service service_entangled_dht is OFF')
+    events.add_subscriber(on_dht_layer_connected, 'dht-layer-connected')
+
+
+def shutdown():
+    events.remove_subscriber(on_dht_layer_connected, 'dht-layer-connected')
+    if driver.is_on('service_entangled_dht'):
+        dht_service.suspend(layer_id=dht_records.LAYER_SUPPLIERS)
+    events.remove_subscriber(on_customer_accepted, 'existing-customer-accepted')
+    events.remove_subscriber(on_customer_accepted, 'new-customer-accepted')
+    events.remove_subscriber(on_customer_terminated, 'existing-customer-denied')
+    events.remove_subscriber(on_customer_terminated, 'existing-customer-terminated')
+    events.remove_subscriber(on_identity_url_changed, 'identity-url-changed')
+    callback.remove_inbox_callback(on_inbox_packet_received)
+
+
+#------------------------------------------------------------------------------
+
+
+def connect_suppliers_dht_layer():
+    known_seeds = known_nodes.nodes()
+    d = dht_service.open_layer(
+        layer_id=dht_records.LAYER_SUPPLIERS,
+        seed_nodes=known_seeds,
+        connect_now=True,
+        attach=True,
+    )
+    d.addCallback(on_suppliers_dht_layer_connected)
+    d.addErrback(lambda *args: lg.err(str(args)))
+    return d
+
+
+#------------------------------------------------------------------------------
+
+
 def register_customer_key(customer_public_key_id, customer_public_key):
     """
     Check/refresh/store customer public key locally.
     """
     if not customer_public_key_id or not customer_public_key:
         lg.warn('customer public key was not provided in the request')
         return False
@@ -131,15 +189,15 @@
     packet_key_alias, packet_owner_id, _ = packetid.SplitKeyOwnerData(newpacket.PacketID)
     customer_idurl = global_id.glob2idurl(packet_owner_id)
     packet_key_id = my_keys.latest_key_id(my_keys.make_key_id(packet_key_alias, creator_idurl, creator_glob_id=packet_owner_id))
     packet_key_id_registered = my_keys.is_key_registered(packet_key_id)
     if _Debug:
         lg.args(_DebugLevel, owner_id=owner_id, creator_id=creator_id, customer_id=packet_owner_id, key_registered=packet_key_id_registered)
     if newpacket.Command == commands.Data():
-        if owner_idurl == creator_idurl:
+        if id_url.is_the_same(owner_idurl, creator_idurl):
             if contactsdb.is_customer(creator_idurl):
                 if _Debug:
                     lg.dbg(_DebugLevel, 'OK, scenario 1: customer is sending own data to own supplier')
                 return customer_idurl, creator_idurl
             if packet_key_id_registered:
                 if _Debug:
                     lg.dbg(_DebugLevel, 'OK, scenario 10: data sender is not my customer but packet key is registered')
@@ -786,8 +844,255 @@
             if os.path.exists(old_owner_dir):
                 bpio._dir_remove(old_owner_dir)
                 lg.warn('removed %r' % old_owner_dir)
         except:
             lg.exc()
     # update customer idurl in "spaceused" file
     local_tester.TestSpaceTime()
+    # TODO: reconnect "supplier-file-modified" consumers & producers
     return True
+
+
+#------------------------------------------------------------------------------
+
+
+def on_service_supplier_request(json_payload, newpacket, info):
+    customer_idurl = newpacket.OwnerID
+    customer_id = global_id.UrlToGlobalID(customer_idurl)
+    bytes_for_customer = 0
+    try:
+        bytes_for_customer = int(json_payload['needed_bytes'])
+    except:
+        lg.exc()
+        return p2p_service.SendFail(newpacket, 'invalid payload')
+    try:
+        customer_public_key = json_payload['customer_public_key']
+        customer_public_key_id = customer_public_key['key_id']
+    except:
+        customer_public_key = None
+        customer_public_key_id = None
+    data_owner_idurl = None
+    target_customer_idurl = None
+    family_position = json_payload.get('position')
+    ecc_map = json_payload.get('ecc_map')
+    family_snapshot = json_payload.get('family_snapshot')
+    if family_snapshot:
+        family_snapshot = id_url.to_bin_list(family_snapshot)
+    target_customer_id = json_payload.get('customer_id')
+    key_id = my_keys.latest_key_id(json_payload.get('key_id'))
+    if key_id:
+        # this is a request from external user to access shared data stored by one of my customers
+        # this is "second" customer requesting data from "first" customer
+        if not key_id or not my_keys.is_valid_key_id(key_id):
+            lg.warn('missed or invalid key id')
+            return p2p_service.SendFail(newpacket, 'invalid key id')
+        target_customer_idurl = global_id.GlobalUserToIDURL(target_customer_id)
+        if not contactsdb.is_customer(target_customer_idurl):
+            lg.warn('target user %s is not a customer' % target_customer_id)
+            return p2p_service.SendFail(newpacket, 'not a customer')
+        if target_customer_idurl == customer_idurl:
+            lg.warn('customer %s requesting shared access to own files' % customer_idurl)
+            return p2p_service.SendFail(newpacket, 'invalid case')
+        if not my_keys.is_key_registered(key_id):
+            lg.warn('key not registered: %s' % key_id)
+            p2p_service.SendFail(newpacket, 'key not registered')
+            return False
+        data_owner_idurl = my_keys.split_key_id(key_id)[1]
+        if not id_url.is_the_same(data_owner_idurl, target_customer_idurl) and not id_url.is_the_same(data_owner_idurl, customer_idurl):
+            # pretty complex scenario:
+            # external customer requesting access to data which belongs not to that customer
+            # this is "third" customer accessing data belongs to "second" customer
+            # TODO: for now just refuse it
+            lg.warn('under construction, key_id=%s customer_idurl=%s target_customer_idurl=%s' % (key_id, customer_idurl, target_customer_idurl))
+            p2p_service.SendFail(newpacket, 'under construction')
+            return False
+        register_customer_key(customer_public_key_id, customer_public_key)
+        # do not create connection with that customer, only accept the request
+        lg.info('external customer %s requested access to shared data at %s' % (customer_id, key_id))
+        return p2p_service.SendAck(newpacket, 'accepted')
+    # key_id is not present in the request:
+    # this is a request to connect new customer (or reconnect existing one) to that supplier
+    if not bytes_for_customer or bytes_for_customer < 0:
+        lg.warn('wrong payload : %s' % newpacket.Payload)
+        return p2p_service.SendFail(newpacket, 'wrong storage value')
+    current_customers = contactsdb.customers()
+    if accounting.check_create_customers_quotas():
+        lg.info('created new customers quotas file')
+    space_dict, free_space = accounting.read_customers_quotas()
+    try:
+        free_bytes = int(free_space)
+    except:
+        lg.exc()
+        return p2p_service.SendFail(newpacket, 'broken quotas file')
+    if (customer_idurl not in current_customers and customer_idurl.to_bin() in list(space_dict.keys())):
+        lg.err('broken quotas file: %r is not a customer, but found in the quotas file' % customer_idurl.to_bin())
+        return p2p_service.SendFail(newpacket, 'broken quotas file')
+    if (customer_idurl in current_customers and customer_idurl.to_bin() not in list(space_dict.keys())):
+        # seems like customer's idurl was rotated, but space file still have the old idurl
+        # need to find that old idurl value and replace with the new one
+        for other_customer_idurl in space_dict.keys():
+            if other_customer_idurl and other_customer_idurl != 'free' and id_url.field(other_customer_idurl) == customer_idurl:
+                lg.info('found rotated customer identity in space file, switching: %r -> %r' % (other_customer_idurl, customer_idurl.to_bin()))
+                space_dict[customer_idurl.to_bin()] = space_dict.pop(other_customer_idurl)
+                break
+        if customer_idurl.to_bin() not in list(space_dict.keys()):
+            lg.err('broken customers file: %r is a customer, but not found in the quotas file' % customer_idurl.to_bin())
+            return p2p_service.SendFail(newpacket, 'broken customers file')
+    # check/verify/create/update contract with requestor customer
+    # the contracts are needed to keep track of consumed resources
+    current_contract = {}
+    if driver.is_on('service_supplier_contracts'):
+        from bitdust.supplier import storage_contract
+        try:
+            current_contract = storage_contract.prepare_customer_contract(customer_idurl, details={
+                'allocated_bytes': bytes_for_customer,
+                'ecc_position': family_position,
+                'ecc_map': ecc_map,
+            })
+        except:
+            lg.exc()
+            current_contract = {}
+        if current_contract and current_contract.get('deny'):
+            lg.warn('contract processing denied with user %s' % customer_idurl)
+            return p2p_service.SendFail(newpacket, 'deny:' + jsn.dumps(current_contract))
+    # check if this is a new customer or an existing one
+    # for existing one, we have to first release currently allocated resources
+    if customer_idurl in current_customers:
+        current_allocated_byes = int(space_dict.get(customer_idurl.to_bin(), 0))
+        free_bytes += current_allocated_byes
+        current_customers.remove(customer_idurl)
+        space_dict.pop(customer_idurl.to_bin())
+        new_customer = False
+    else:
+        new_customer = True
+    # lg.args(8, new_customer=new_customer, current_allocated_bytes=space_dict.get(customer_idurl.to_bin()))
+    if free_bytes <= bytes_for_customer:
+        contactsdb.remove_customer_meta_info(customer_idurl)
+        accounting.write_customers_quotas(space_dict, free_bytes)
+        contactsdb.update_customers(current_customers)
+        contactsdb.save_customers()
+        if customer_public_key_id:
+            my_keys.erase_key(customer_public_key_id)
+        reactor.callLater(0, local_tester.TestUpdateCustomers)  # @UndefinedVariable
+        if new_customer:
+            lg.info('NEW CUSTOMER: DENIED     not enough space available')
+            events.send('new-customer-denied', data=dict(idurl=customer_idurl))
+        else:
+            lg.info('OLD CUSTOMER: DENIED     not enough space available')
+            events.send('existing-customer-denied', data=dict(idurl=customer_idurl))
+        return p2p_service.SendAck(newpacket, 'deny:{"reason": "not enough space available"}')
+    free_bytes = free_bytes - bytes_for_customer
+    current_customers.append(customer_idurl)
+    space_dict[customer_idurl.to_bin()] = bytes_for_customer
+    contactsdb.add_customer_meta_info(customer_idurl, {
+        'ecc_map': ecc_map,
+        'position': family_position,
+        'family_snapshot': family_snapshot,
+    })
+    accounting.write_customers_quotas(space_dict, free_bytes)
+    contactsdb.update_customers(current_customers)
+    contactsdb.save_customers()
+    register_customer_key(customer_public_key_id, customer_public_key)
+    reactor.callLater(0, local_tester.TestUpdateCustomers)  # @UndefinedVariable
+    if new_customer:
+        lg.info('NEW CUSTOMER: ACCEPTED   %s family_position=%s ecc_map=%s allocated_bytes=%s' % (customer_idurl, family_position, ecc_map, bytes_for_customer))
+        events.send(
+            'new-customer-accepted', data=dict(
+                idurl=customer_idurl,
+                allocated_bytes=bytes_for_customer,
+                ecc_map=ecc_map,
+                position=family_position,
+                family_snapshot=family_snapshot,
+                key_id=customer_public_key_id,
+                contract=current_contract,
+            )
+        )
+    else:
+        lg.info('EXISTING CUSTOMER: ACCEPTED  %s family_position=%s ecc_map=%s allocated_bytes=%s' % (customer_idurl, family_position, ecc_map, bytes_for_customer))
+        events.send(
+            'existing-customer-accepted', data=dict(
+                idurl=customer_idurl,
+                allocated_bytes=bytes_for_customer,
+                ecc_map=ecc_map,
+                position=family_position,
+                key_id=customer_public_key_id,
+                family_snapshot=family_snapshot,
+                contract=current_contract,
+            )
+        )
+    if current_contract:
+        return p2p_service.SendAck(newpacket, 'accepted:' + jsn.dumps(current_contract))
+    return p2p_service.SendAck(newpacket, 'accepted')
+
+
+def on_service_supplier_cancel(json_payload, newpacket, info):
+    customer_idurl = newpacket.OwnerID
+    try:
+        customer_public_key = json_payload['customer_public_key']
+        customer_public_key_id = customer_public_key['key_id']
+    except:
+        customer_public_key = None
+        customer_public_key_id = None
+    customer_ecc_map = json_payload.get('ecc_map')
+    if driver.is_on('service_supplier_contracts'):
+        from bitdust.supplier import storage_contract
+        storage_contract.cancel_customer_contract(customer_idurl)
+    if not contactsdb.is_customer(customer_idurl):
+        lg.warn('got packet from %s, but he is not a customer' % customer_idurl)
+        return p2p_service.SendFail(newpacket, 'not a customer')
+    if accounting.check_create_customers_quotas():
+        lg.info('created a new space file')
+    space_dict, free_space = accounting.read_customers_quotas()
+    if customer_idurl.to_bin() not in list(space_dict.keys()):
+        lg.warn('got packet from %s, but not found him in space dictionary' % customer_idurl)
+        return p2p_service.SendFail(newpacket, 'not a customer')
+    try:
+        free_bytes = int(free_space)
+        free_space = free_bytes + int(space_dict[customer_idurl.to_bin()])
+    except:
+        lg.exc()
+        return p2p_service.SendFail(newpacket, 'broken quotas file')
+    new_customers = list(contactsdb.customers())
+    new_customers.remove(customer_idurl)
+    space_dict.pop(customer_idurl.to_bin())
+    accounting.write_customers_quotas(space_dict, free_space)
+    contactsdb.remove_customer_meta_info(customer_idurl)
+    contactsdb.update_customers(new_customers)
+    contactsdb.save_customers()
+    if customer_public_key_id:
+        my_keys.erase_key(customer_public_key_id)
+    # TODO: erase customer's groups keys also
+    reactor.callLater(0, local_tester.TestUpdateCustomers)  # @UndefinedVariable
+    lg.info('EXISTING CUSTOMER TERMINATED %r' % customer_idurl)
+    events.send('existing-customer-terminated', data=dict(idurl=customer_idurl, ecc_map=customer_ecc_map))
+    return p2p_service.SendAck(newpacket, 'accepted')
+
+
+#------------------------------------------------------------------------------
+
+
+def on_inbox_packet_received(newpacket, info, status, error_message):
+    if newpacket.Command == commands.DeleteFile():
+        return on_delete_file(newpacket)
+    elif newpacket.Command == commands.DeleteBackup():
+        return on_delete_backup(newpacket)
+    elif newpacket.Command == commands.Retrieve():
+        return on_retrieve(newpacket)
+    elif newpacket.Command == commands.Data():
+        return on_data(newpacket)
+    elif newpacket.Command == commands.ListFiles():
+        return on_list_files(newpacket)
+    return False
+
+
+def on_suppliers_dht_layer_connected(ok):
+    lg.info('connected to DHT layer for suppliers: %r' % ok)
+    if my_id.getIDURL():
+        dht_service.set_node_data('idurl', my_id.getIDURL().to_text(), layer_id=dht_records.LAYER_SUPPLIERS)
+    return ok
+
+
+def on_dht_layer_connected(evt):
+    if evt.data['layer_id'] == 0:
+        connect_suppliers_dht_layer()
+    elif evt.data['layer_id'] == dht_records.LAYER_SUPPLIERS:
+        on_suppliers_dht_layer_connected(True)
```

### Comparing `bitdust-0.1.8.234/bitdust/supplier/customers_rejector.py` & `bitdust-0.1.9.241/bitdust/supplier/customers_rejector.py`

 * *Files 22% similar despite different names*

```diff
@@ -29,24 +29,30 @@
 .. raw:: html
 
     <a href="customers_rejector.png" target="_blank">
     <img src="customers_rejector.png" style="max-width:100%;">
     </a>
 
 EVENTS:
+    * :red:`contracts-verified`
     * :red:`customers-rejected`
     * :red:`found-idle-customers`
+    * :red:`found-unpaid-customers`
     * :red:`no-idle-customers`
     * :red:`restart`
     * :red:`space-enough`
     * :red:`space-overflow`
     * :red:`start`
+    * :red:`timer-1hour`
 """
 
-from __future__ import absolute_import
+#------------------------------------------------------------------------------
+
+_Debug = False
+_DebugLevel = 8
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
 from bitdust.automats import automat
 
@@ -57,38 +63,41 @@
 
 from bitdust.interface import api
 
 from bitdust.contacts import contactsdb
 
 from bitdust.lib import utime
 
+from bitdust.services import driver
+
 from bitdust.p2p import ratings
 
 from bitdust.storage import accounting
 
 #------------------------------------------------------------------------------
 
-_Debug = False
-_DebugLevel = 8
-
-#------------------------------------------------------------------------------
-
 _CustomersRejector = None
 
 #------------------------------------------------------------------------------
 
 
 def A(event=None, *args, **kwargs):
     """
     Access method to interact with the state machine.
     """
     global _CustomersRejector
     if _CustomersRejector is None:
         # set automat name and starting state here
-        _CustomersRejector = CustomersRejector('customers_rejector', 'READY', 4)
+        _CustomersRejector = CustomersRejector(
+            name='customers_rejector',
+            state='READY',
+            debug_level=_DebugLevel,
+            log_events=_Debug,
+            log_transitions=_Debug,
+        )
     if event is not None:
         _CustomersRejector.automat(event, *args, **kwargs)
     return _CustomersRejector
 
 
 def Destroy():
     """
@@ -99,56 +108,72 @@
         return
     _CustomersRejector.destroy()
     del _CustomersRejector
     _CustomersRejector = None
 
 
 class CustomersRejector(automat.Automat):
+
     """
     This class implements all the functionality of the ``customers_rejector()``
     state machine.
     """
+
+    timers = {
+        'timer-1hour': (3600, ['READY']),
+    }
+
     def init(self):
         """
         Method to initialize additional variables and flags at creation of the
         state machine.
         """
 
     def A(self, event, *args, **kwargs):
         #---READY---
         if self.state == 'READY':
-            if event == 'start' or event == 'restart':
+            if event == 'timer-1hour' or event == 'start' or event == 'restart':
                 self.state = 'CAPACITY?'
                 self.doTestMyCapacity(*args, **kwargs)
         #---CAPACITY?---
         elif self.state == 'CAPACITY?':
-            if event == 'space-enough':
-                self.state = 'IDLE?'
-                self.doTestIdleDays(*args, **kwargs)
-            elif event == 'space-overflow':
+            if event == 'space-overflow':
                 self.state = 'REJECT!'
                 self.doRemoveCustomers(*args, **kwargs)
+            elif event == 'space-enough':
+                self.state = 'CONTRACTS?'
+                self.doVerifyStorageContracts(*args, **kwargs)
         #---REJECT!---
         elif self.state == 'REJECT!':
             if event == 'restart':
                 self.state = 'CAPACITY?'
                 self.doTestMyCapacity(*args, **kwargs)
             elif event == 'customers-rejected':
                 self.state = 'READY'
                 self.doRestartLocalTester(*args, **kwargs)
+                self.doRestartLater(*args, **kwargs)
         #---IDLE?---
         elif self.state == 'IDLE?':
             if event == 'found-idle-customers':
                 self.state = 'REJECT!'
                 self.doRemoveCustomers(*args, **kwargs)
             elif event == 'restart':
                 self.state = 'CAPACITY?'
                 self.doTestMyCapacity(*args, **kwargs)
             elif event == 'no-idle-customers':
                 self.state = 'READY'
+                self.doCountStatistics(*args, **kwargs)
+        #---CONTRACTS?---
+        elif self.state == 'CONTRACTS?':
+            if event == 'found-unpaid-customers':
+                self.state = 'REJECT!'
+                self.doRemoveCustomers(*args, **kwargs)
+            elif event == 'contracts-verified':
+                self.state = 'IDLE?'
+                self.doTestIdleDays(*args, **kwargs)
         return None
 
     def doTestMyCapacity(self, *args, **kwargs):
         """
         Here are some values.
 
         + donated_bytes : you set this in the settings
@@ -156,14 +181,15 @@
         + free_bytes = donated_bytes - consumed_bytes : not yet allocated space
         + used_bytes : size of all files, which you store on your disk for your customers
         + ratio : currently used space compared to consumed space
         """
         if _Debug:
             lg.out(_DebugLevel, 'customers_rejector.doTestMyCapacity')
         if bpio.Android():
+            #TODO:
             self.automat('space-enough')
             return
         failed_customers = set()
         current_customers = contactsdb.customers()
         donated_bytes = settings.getDonatedBytes()
         space_dict, free_space = accounting.read_customers_quotas()
         used_dict = accounting.read_customers_usage()
@@ -208,37 +234,67 @@
         """
         dead_customers = []
         customer_idle_days = config.conf().getInt('services/customer-patrol/customer-idle-days', 0)
         if not customer_idle_days:
             self.automat('no-idle-customers')
             return
         for customer_idurl in contactsdb.customers():
+            if driver.is_on('service_supplier_contracts'):
+                from bitdust.supplier import storage_contract
+                if storage_contract.is_current_customer_contract_active(customer_idurl):
+                    continue
             connected_time = ratings.connected_time(customer_idurl.to_bin())
             if connected_time is None:
                 lg.warn('last connected_time for customer %r is unknown, rejecting customer' % customer_idurl)
                 dead_customers.append(customer_idurl)
                 continue
-            if utime.get_sec1970() - connected_time > customer_idle_days*24*60*60:
-                lg.warn('customer %r connected last time %r seconds ago, rejecting customer' % (customer_idurl, utime.get_sec1970() - connected_time))
+            if utime.utcnow_to_sec1970() - connected_time > customer_idle_days*24*60*60:
+                lg.warn('customer %r connected last time %r seconds ago, rejecting customer' % (customer_idurl, utime.utcnow_to_sec1970() - connected_time))
                 dead_customers.append(customer_idurl)
         if dead_customers:
             lg.warn('found idle customers: %r' % dead_customers)
             self.automat('found-idle-customers', dead_customers)
         else:
             lg.info('all customers has some activity recently, no idle customers found')
             self.automat('no-idle-customers')
 
+    def doRestartLocalTester(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        from bitdust.supplier import local_tester
+        local_tester.TestSpaceTime()
+
+    def doRestartLater(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        self.automat('restart', delay=5)
+
+    def doVerifyStorageContracts(self, *args, **kwargs):
+        """
+        Action method.
+        """
+        rejected_customers = []
+        if driver.is_on('service_supplier_contracts'):
+            from bitdust.supplier import storage_contract
+            rejected_customers = storage_contract.verify_all_current_customers_contracts()
+        if rejected_customers:
+            lg.warn('found unpaid customers: %r' % rejected_customers)
+            self.automat('found-unpaid-customers', rejected_customers)
+        else:
+            lg.info('all customers have valid contracts')
+            self.automat('contracts-verified')
+
+    def doCountStatistics(self, *args, **kwargs):
+        """
+        Action method.
+        """
+
     def doRemoveCustomers(self, *args, **kwargs):
         """
         Action method.
         """
         removed_customers = args[0]
         for customer_idurl in removed_customers:
             api.customer_reject(customer_id=customer_idurl, erase_customer_key=True)
         self.automat('customers-rejected', removed_customers)
-
-    def doRestartLocalTester(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        from bitdust.supplier import local_tester
-        local_tester.TestSpaceTime()
```

### Comparing `bitdust-0.1.8.234/bitdust/supplier/family_member.py` & `bitdust-0.1.9.241/bitdust/supplier/family_member.py`

 * *Files 0% similar despite different names*

```diff
@@ -104,14 +104,15 @@
     return families().get(customer_idurl, None)
 
 
 #------------------------------------------------------------------------------
 
 
 class FamilyMember(automat.Automat):
+
     """
     This class implements all the functionality of ``family_member()`` state machine.
     """
 
     timers = {
         'timer-10sec': (10.0, ['SUPPLIERS']),
     }
@@ -352,15 +353,15 @@
 
 #         if not merged_info:
 #             lg.err('failed to merge customer family info after reading from DHT, skip transaction')
 #             self.transaction = None
 #             return
         possible_transaction = self._do_process_request(merged_info, self.current_request)
         if not possible_transaction:
-            lg.warn('failed to process customer family change request, skip transaction')
+            lg.warn('failed to process customer family %r change request, skip transaction' % self)
             return
         self.transaction = self._do_increment_revision(possible_transaction)
         if _Debug:
             lg.args(_DebugLevel, transaction=self.transaction)
         if self.transaction:
             known_ecc_map = self.transaction.get('ecc_map')
             if known_ecc_map:
@@ -504,17 +505,17 @@
         try:
             dht_revision = int(out['revision'])
             out['suppliers'] = id_url.to_bin_list(out['suppliers'])
             ecc_map = out['ecc_map']
             if dht_revision < 1:
                 raise Exception('invalid revision')
             if not isinstance(out['suppliers'], list) or len(out['suppliers']) < 1:
-                raise Exception('must include some suppliers')
+                raise Exception('family %r must include some suppliers' % self)
             if ecc_map and ecc_map not in eccmap.EccMapNames():
-                raise Exception('invalid ecc_map name')
+                raise Exception('invalid ecc_map name in family %r' % self)
             out['publisher_idurl'] = id_url.field(out['publisher_idurl'])
             # TODO: add publisher_signature and Validate method to check publisher signature
             out['customer_idurl'] = id_url.field(out['customer_idurl'])
             # TODO: add customer_signature and Validate method to check customer signature
         except:
             lg.exc()
             lg.warn('skip invalid DHT info and assume DHT record is not exist')
@@ -534,22 +535,22 @@
                 raise Exception('invalid revision')
         except Exception as exc:
             lg.warn(str(exc))
             return None
         try:
             out['suppliers'] = id_url.to_bin_list(out['suppliers'])
             if not isinstance(out['suppliers'], list) or len(out['suppliers']) < 1:
-                raise Exception('must include some suppliers')
+                raise Exception('family %r must include some suppliers' % self)
         except Exception as exc:
             lg.warn(str(exc))
             return None
         try:
             ecc_map = out['ecc_map']
             if ecc_map and ecc_map not in eccmap.EccMapNames():
-                raise Exception('invalid ecc_map name')
+                raise Exception('invalid ecc_map name in family %r' % self)
         except Exception as exc:
             lg.warn(str(exc))
             return None
         try:
             out['publisher_idurl'] = id_url.field(out['publisher_idurl'])
             # TODO: if I am a publisher - revision number must be the same as my info
         except Exception as exc:
```

### Comparing `bitdust-0.1.8.234/bitdust/supplier/list_files.py` & `bitdust-0.1.9.241/bitdust/supplier/list_files.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/supplier/local_tester.py` & `bitdust-0.1.9.241/bitdust/supplier/local_tester.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/__init__.py` & `bitdust-0.1.9.241/bitdust/system/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/bpio.py` & `bitdust-0.1.9.241/bitdust/system/bpio.py`

 * *Files 0% similar despite different names*

```diff
@@ -827,15 +827,15 @@
         return False
     if not os.path.exists(p):
         return False
     # ok, on Linux we have devices, mounts, links ...
     if Linux():
         try:
             import stat
-            st = os.path.stat(localpath)
+            st = os.path.stat(localpath)  # @UndefinedVariable
             return stat.S_ISDIR(st.st_mode)
         except:
             return False
     # now we are in really big trouble
     raise Exception('path is not exist: %s' % p)
     return False
 
@@ -1232,15 +1232,15 @@
 
 def kill_process_linux(pid):
     """
     Make a call to system ``kill`` command.
     """
     try:
         import signal
-        os.kill(pid, signal.SIGTERM)
+        os.kill(pid, signal.SIGKILL)
     except:
         lg.exc()
 
 
 def kill_process_win32(pid):
     """
     Call to system Windows API ``TerminateProcess`` method.
```

### Comparing `bitdust-0.1.8.234/bitdust/system/child_process.py` & `bitdust-0.1.9.241/bitdust/system/child_process.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/deploy.py` & `bitdust-0.1.9.241/bitdust/system/deploy.py`

 * *Files 1% similar despite different names*

```diff
@@ -277,15 +277,18 @@
     make_venv_cmd = 'virtualenv -p {} {}'.format(current_python, venv_path)
     if on_windows:
         python_exe = '"%s"' % os.path.join(base_dir, 'python', 'python.exe')
         if not os.path.exists(python_exe):
             python_exe = current_python
         make_venv_cmd = '{} -m virtualenv --system-site-packages {}'.format(python_exe, venv_path)
     if on_mac:
-        make_venv_cmd = '{} -m virtualenv --clear --always-copy {}'.format(current_python, venv_path)
+        if sys.version_info >= (3, 11):
+            make_venv_cmd = '{} -m venv --clear --copies {}'.format(current_python, venv_path)
+        else:
+            make_venv_cmd = '{} -m virtualenv --clear --always-copy {}'.format(current_python, venv_path)
 
     print_text('\n***** Executing "{}"'.format(make_venv_cmd))
     status = os.system(make_venv_cmd)
     if on_mac and status != 0:
         make_venv_cmd = 'virtualenv -p {} {}'.format(current_python, venv_path)
         status = os.system(make_venv_cmd)
     if on_linux and status != 0:
```

### Comparing `bitdust-0.1.8.234/bitdust/system/dirsize.py` & `bitdust-0.1.9.241/bitdust/system/dirsize.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/diskusage.py` & `bitdust-0.1.9.241/bitdust/system/diskusage.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/local_fs.py` & `bitdust-0.1.9.241/bitdust/system/local_fs.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/nonblocking.py` & `bitdust-0.1.9.241/bitdust/system/nonblocking.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/run_upnpc.py` & `bitdust-0.1.9.241/bitdust/system/run_upnpc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/tmpfile.py` & `bitdust-0.1.9.241/bitdust/system/tmpfile.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/system/tray_icon.py` & `bitdust-0.1.9.241/bitdust/system/tray_icon.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/__init__.py` & `bitdust-0.1.9.241/bitdust/transport/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/bandwidth.py` & `bitdust-0.1.9.241/bitdust/transport/bandwidth.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/callback.py` & `bitdust-0.1.9.241/bitdust/transport/callback.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/gateway.py` & `bitdust-0.1.9.241/bitdust/transport/gateway.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/__init__.py` & `bitdust-0.1.9.241/bitdust/transport/http/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/http_interface.py` & `bitdust-0.1.9.241/bitdust/transport/http/http_interface.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/http_node.py` & `bitdust-0.1.9.241/bitdust/transport/http/http_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/sum_client.py` & `bitdust-0.1.9.241/bitdust/transport/http/sum_client.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/sum_server.py` & `bitdust-0.1.9.241/bitdust/transport/http/sum_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/transport_http_old.py` & `bitdust-0.1.9.241/bitdust/transport/http/transport_http_old.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/http/twisted-web-ssl.py` & `bitdust-0.1.9.241/bitdust/transport/http/twisted-web-ssl.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/network_transport.py` & `bitdust-0.1.9.241/bitdust/transport/network_transport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/packet_in.py` & `bitdust-0.1.9.241/bitdust/transport/proxy/proxy_sender.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 #!/usr/bin/env python
-# packet_in.py
+# proxy_sender.py
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (packet_in.py) is part of BitDust Software.
+# This file (proxy_sender.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -16,34 +16,39 @@
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
 """
-.. module:: packet_in.
+.. module:: proxy_sender.
 
 .. role:: red
 
-BitDust packet_in() Automat
+BitDust proxy_sender() Automat
 
 .. raw:: html
 
-    <a href="packet_in.png" target="_blank">
-    <img src="packet_in.png" style="max-width:100%;">
+    <a href="proxy_sender.png" target="_blank">
+    <img src="proxy_sender.png" style="max-width:100%;">
     </a>
 
 EVENTS:
-    * :red:`cancel`
-    * :red:`failed`
-    * :red:`register-item`
-    * :red:`remote-id-cached`
-    * :red:`unregister-item`
-    * :red:`unserialize-failed`
-    * :red:`valid-inbox-packet`
+    * :red:`init`
+    * :red:`proxy_receiver.state`
+    * :red:`relay-ack`
+    * :red:`relay-failed`
+    * :red:`relay-out`
+    * :red:`retry`
+    * :red:`retry-cache-failed`
+    * :red:`retry-failed`
+    * :red:`retry-send-failed`
+    * :red:`shutdown`
+    * :red:`start`
+    * :red:`stop`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
 
 #------------------------------------------------------------------------------
@@ -51,553 +56,533 @@
 _Debug = False
 _DebugLevel = 16
 
 _PacketLogFileEnabled = False
 
 #------------------------------------------------------------------------------
 
-import os
-import time
-
+from twisted.internet.defer import Deferred
 from twisted.internet import reactor  # @UnresolvedImport
 
 #------------------------------------------------------------------------------
 
-from bitdust.logs import lg
-
-from bitdust.main import settings
-from bitdust.main import config
-
 from bitdust.automats import automat
 
-from bitdust.lib import nameurl
-from bitdust.lib import strng
+from bitdust.logs import lg
 
-from bitdust.system import bpio
-from bitdust.system import tmpfile
+from bitdust.lib import nameurl
+from bitdust.lib import serialization
+from bitdust.lib import net_misc
 
-from bitdust.userid import global_id
-from bitdust.userid import id_url
+from bitdust.main import config
+from bitdust.main import settings
 
-from bitdust.contacts import contactsdb
-from bitdust.contacts import identitycache
+from bitdust.crypt import encrypted
+from bitdust.crypt import key
+from bitdust.crypt import signed
 
 from bitdust.services import driver
 
+from bitdust.contacts import identitycache
+
 from bitdust.p2p import commands
-from bitdust.p2p import p2p_stats
+from bitdust.p2p import network_connector
 
 from bitdust.transport import callback
+from bitdust.transport import packet_out
 
-#------------------------------------------------------------------------------
-
-_InboxItems = {}
-_PacketsCounter = 0
-_History = []
-
-#------------------------------------------------------------------------------
-
-
-def init():
-    global _PacketLogFileEnabled
-    _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
-
-
-def shutdown():
-    global _PacketLogFileEnabled
-    _PacketLogFileEnabled = False
-
-
-#------------------------------------------------------------------------------
-
-
-def get_packets_counter():
-    global _PacketsCounter
-    return _PacketsCounter
-
-
-def increment_packets_counter():
-    global _PacketsCounter
-    _PacketsCounter += 1
+from bitdust.transport.proxy import proxy_receiver
 
+from bitdust.userid import id_url
+from bitdust.userid import global_id
+from bitdust.userid import my_id
 
 #------------------------------------------------------------------------------
 
-
-def inbox_items():
-    global _InboxItems
-    return _InboxItems
-
-
-def create(transfer_id):
-    p = PacketIn(transfer_id)
-    inbox_items()[transfer_id] = p
-    # lg.out(10, 'packet_in.create  %s,  %d working items now' % (
-    #     transfer_id, len(items())))
-    return p
-
-
-def get(transfer_id):
-    return inbox_items().get(transfer_id, None)
-
-
-def search(sender_idurl=None, proto=None, host=None):
-    """
-    Returns list of transfer ids of incoming packets which satisfies given criteria.
-    """
-    if sender_idurl and not isinstance(sender_idurl, list):
-        sender_idurl = [
-            sender_idurl,
-        ]
-    results = set()
-    for transfer_id, itm in inbox_items().items():
-        if sender_idurl:
-            if itm.sender_idurl and itm.sender_idurl == sender_idurl:
-                results.add(transfer_id)
-                continue
-        if proto and host:
-            if itm.proto and itm.proto == proto and itm.host and itm.host == host:
-                results.add(transfer_id)
-                continue
-        if host:
-            if itm.host and itm.host == host:
-                results.add(transfer_id)
-                continue
-        if proto:
-            if itm.proto and itm.proto == proto:
-                results.add(transfer_id)
-                continue
-    return list(results)
-
-
-def history():
-    global _History
-    return _History
-
+_ProxySender = None
 
 #------------------------------------------------------------------------------
 
 
-def process(newpacket, info):
+def A(event=None, *args, **kwargs):
     """
-    Main entry point where all incoming signed packets are coming from remote peers.
-    The main aspect here is to "authenticate" remote node - need to know it identity.
+    Access method to interact with proxy_sender machine.
     """
-    # from bitdust.p2p import p2p_service
-    from bitdust.transport import gateway
-    from bitdust.userid import my_id
-    if not driver.is_on('service_p2p_hookups'):
-        if _Debug:
-            lg.out(_DebugLevel, 'packet_in.process SKIP incoming packet, service_p2p_hookups is not started')
-        return None
-    if _Debug:
-        lg.out(
-            _DebugLevel, 'packet_in.process [%s/%s/%s]:%s(%s) from %s://%s is "%s"' % (
-                nameurl.GetName(newpacket.OwnerID),
-                nameurl.GetName(newpacket.CreatorID),
-                nameurl.GetName(newpacket.RemoteID),
-                newpacket.Command,
-                newpacket.PacketID,
-                info.proto,
-                info.host,
-                info.status,
-            )
-        )
-    if info.status != 'finished':
-        if _Debug:
-            lg.out(_DebugLevel, '    skip, packet status is : [%s]' % info.status)
-        return None
-
-
-#     if _PacketLogFileEnabled:
-#         lg.out(0, '        \033[0;49;92mIN %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
-#             newpacket.Command, newpacket.PacketID, info.bytes_received,
-#             global_id.UrlToGlobalID(info.sender_idurl), global_id.UrlToGlobalID(newpacket.RemoteID),
-#             info.transfer_id), log_name='packet', showtime=True)
-# we must know recipient identity
-    if not id_url.is_cached(newpacket.RemoteID):
-        d = identitycache.immediatelyCaching(newpacket.RemoteID)
-        d.addCallback(lambda _: process(newpacket, info))
-        d.addErrback(lambda err: lg.err('incoming remote ID is unknown, failed caching remote %s identity: %s' % (newpacket.RemoteID, str(err))) and None)
-        return d
-    if newpacket.Command == commands.Identity():
-        if not id_url.is_the_same(newpacket.RemoteID, my_id.getIDURL()):
-            if _Debug:
-                lg.out(_DebugLevel, '    incoming Identity is routed to another user')
-            if not gateway.on_identity_received(newpacket, send_ack=False):
-                lg.warn('received identity was not processed')
-                return None
-            # remote peer sending a valid identity to another peer routed via my machine
-            # need to handle that packet - it should be processed by proxy_server
-            return handle(newpacket, info)
-        # contact sending us current identity we might not have
-        # so we handle it before check that packet is valid
-        # because we might not have his identity on hands and so can not verify the packet
-        # so we check that his Identity is valid and save it into cache
-        # than we check the packet to be valid too.
-        if not gateway.on_identity_received(newpacket):
-            lg.warn('received identity was not processed')
-            return None
-    if not identitycache.HasKey(newpacket.CreatorID):
-        if _Debug:
-            lg.out(_DebugLevel, '    will cache remote identity %s before processing incoming packet %s' % (newpacket.CreatorID, newpacket))
-        d = identitycache.immediatelyCaching(newpacket.CreatorID)
-        d.addCallback(lambda _: handle(newpacket, info))
-        d.addErrback(lambda err: lg.err('failed caching remote %s identity: %s' % (newpacket.CreatorID, str(err))) and None)
-        return d
-    return handle(newpacket, info)
-
-
-def handle(newpacket, info):
-    """
-    Actually process incoming packet. Here we can be sure that owner/creator of the packet is identified.
-    """
-    from bitdust.transport import packet_out
-    handled = False
-    # check that signed by a contact of ours
-    try:
-        is_signature_valid = newpacket.Valid(raise_signature_invalid=False)
-    except:
-        is_signature_valid = False
-        # lg.exc('new packet from %s://%s is NOT VALID:\n\n%r\n' % (
-        #     info.proto, info.host, newpacket.Serialize()))
-    if not is_signature_valid:
-        if _Debug:
-            lg.args(_DebugLevel, PacketID=newpacket.PacketID, OwnerID=newpacket.OwnerID, CreatorID=newpacket.CreatorID, RemoteID=newpacket.RemoteID)
-        lg.warn('signature is not valid for %r from %r|%r to %r' % (newpacket, newpacket.OwnerID, newpacket.CreatorID, newpacket.RemoteID))
-        return None
-    try:
-        if not commands.IsRelay(newpacket.Command):
-            for p in packet_out.search_by_response_packet(newpacket, info.proto, info.host):
-                p.automat('inbox-packet', (newpacket, info))
-                handled = True
-                if _Debug:
-                    lg.out(_DebugLevel, '    processed by %s as response packet' % p)
-    except:
-        lg.exc()
-    try:
-        handled = callback.run_inbox_callbacks(newpacket, info, info.status, info.error_message) or handled
-    except:
-        lg.exc()
-    if not handled and newpacket.Command not in [
-        commands.Ack(),
-        commands.Fail(),
-        commands.Identity(),
-    ]:
-        lg.warn('incoming %s from [%s://%s] was NOT HANDLED' % (newpacket, info.proto, info.host))
-        if _PacketLogFileEnabled:
-            lg.out(
-                0,
-                '                \033[1;49;91mIN NOT HANDLED %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
-                    newpacket.Command,
-                    newpacket.PacketID,
-                    info.bytes_received,
-                    global_id.UrlToGlobalID(info.sender_idurl),
-                    global_id.UrlToGlobalID(newpacket.RemoteID),
-                    info.transfer_id,
-                ),
-                log_name='packet',
-                showtime=True,
-            )
-    else:
-        if _PacketLogFileEnabled:
-            lg.out(
-                0,
-                '                \033[0;49;93mIN OK %s(%s) with %d bytes from %s to %s TID:%s\033[0m' % (
-                    newpacket.Command,
-                    newpacket.PacketID,
-                    info.bytes_received,
-                    global_id.UrlToGlobalID(info.sender_idurl),
-                    global_id.UrlToGlobalID(newpacket.RemoteID),
-                    info.transfer_id,
-                ),
-                log_name='packet',
-                showtime=True,
-            )
-    if _Debug and False:
-        history().append(
-            {
-                'time': newpacket.Date,
-                'command': newpacket.Command,
-                'packet_id': newpacket.PacketID,
-                'creator_id': newpacket.CreatorID,
-                'owner_id': newpacket.OwnerID,
-                'remote_id': newpacket.RemoteID,
-                'payload': len(newpacket.Payload),
-                'address': '%s://%s' % (info.proto, info.host),
-            }
+    global _ProxySender
+    if event is None and not args:
+        return _ProxySender
+    if _ProxySender is None:
+        # set automat name and starting state here
+        _ProxySender = ProxySender(
+            name='proxy_sender',
+            state='AT_STARTUP',
+            debug_level=_DebugLevel,
+            log_events=False,
+            log_transitions=_Debug,
         )
-        if len(history()) > 100:
-            history().pop(0)
-    return handled
+    if event is not None:
+        _ProxySender.automat(event, *args, **kwargs)
+    return _ProxySender
 
 
 #------------------------------------------------------------------------------
 
 
-class PacketIn(automat.Automat):
+class ProxySender(automat.Automat):
     """
-    This class implements all the functionality of the ``packet_in()`` state
+    This class implements all the functionality of the ``proxy_sender()`` state
     machine.
     """
-    def __init__(self, transfer_id):
-        self.transfer_id = transfer_id
-        self.time = None
-        self.timeout = None
-        self.proto = None
-        self.host = None
-        self.sender_idurl = None
-        self.filename = None
-        self.size = None
-        self.bytes_received = None
-        self.status = None
-        self.error_message = None
-        _counter = get_packets_counter()
-        increment_packets_counter()
-        self.label = ''
-        automat.Automat.__init__(
-            self,
-            name='in_%d_%s' % (_counter, self.transfer_id),
-            state='AT_STARTUP',
-            debug_level=_DebugLevel,
-            log_events=_Debug,
-            log_transitions=_Debug,
-            publish_events=False,
+    def init(self, **kwargs):
+        global _PacketLogFileEnabled
+        _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
+        self._sending_enabled = settings.enablePROXYsending()
+
+    def to_json(self):
+        j = super().to_json()
+        j.update(
+            {
+                'proto': proxy_receiver.GetRouterProtoHost()[0] if proxy_receiver.GetRouterProtoHost() else '',
+                'host': net_misc.pack_address_text(proxy_receiver.GetRouterProtoHost()[1]) if proxy_receiver.GetRouterProtoHost() else '',
+                'idurl': proxy_receiver.GetRouterIDURL(),
+                'bytes_received': 0,
+                'bytes_sent': self.traffic_out,
+            }
         )
+        return j
 
-    def __repr__(self):
-        """
-        Will return something like: "in_4_1315435345[Ack(987654321)](DONE)".
-        """
-        return '%s%s(%s)' % (self.id, self.label, self.state)
-
-    def is_timed_out(self):
-        #         if self.time is None or self.timeout is None:
-        #             return False
-        #         return time.time() - self.time > self.timeout
-        return False
-
-    def init(self):
+    def A(self, event, *args, **kwargs):
         """
-        Method to initialize additional variables and flags at creation of the
-        state machine.
+        The state machine code, generated using `visio2python
+        <http://code.google.com/p/visio2python/>`_ tool.
         """
-
-    def A(self, event, *args, **kwargs):
         #---AT_STARTUP---
         if self.state == 'AT_STARTUP':
-            if event == 'register-item':
-                self.state = 'RECEIVING'
+            if event == 'init':
+                self.state = 'STOPPED'
                 self.doInit(*args, **kwargs)
-        #---RECEIVING---
-        elif self.state == 'RECEIVING':
-            if event == 'cancel':
-                self.doCancelItem(*args, **kwargs)
-            elif event == 'unregister-item' and not self.isTransferFinished(*args, **kwargs):
-                self.state = 'FAILED'
-                self.doReportFailed(*args, **kwargs)
-                self.doEraseInputFile(*args, **kwargs)
+        #---STOPPED---
+        elif self.state == 'STOPPED':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'unregister-item' and self.isTransferFinished(*args, **kwargs) and not self.isRemoteIdentityCached(*args, **kwargs):
-                self.state = 'CACHING'
-                self.doCacheRemoteIdentity(*args, **kwargs)
-            elif event == 'unregister-item' and self.isTransferFinished(*args, **kwargs) and self.isRemoteIdentityCached(*args, **kwargs):
-                self.state = 'INBOX?'
-                self.doReadAndUnserialize(*args, **kwargs)
-        #---INBOX?---
-        elif self.state == 'INBOX?':
-            if event == 'valid-inbox-packet':
-                self.state = 'DONE'
-                self.doReportReceived(*args, **kwargs)
-                self.doEraseInputFile(*args, **kwargs)
+            elif event == 'start' and proxy_receiver.A().state != 'LISTEN' and self.isSendingEnabled(*args, **kwargs):
+                self.state = 'ROUTER?'
+                self.doStartFilterOutgoingTraffic(*args, **kwargs)
+            elif ((event == 'proxy_receiver.state' and args[0] == 'LISTEN') or (event == 'start' and proxy_receiver.A().state == 'LISTEN')) and self.isSendingEnabled(*args, **kwargs):
+                self.state = 'REDIRECTING'
+                self.doStartFilterOutgoingTraffic(*args, **kwargs)
+        #---ROUTER?---
+        elif self.state == 'ROUTER?':
+            if event == 'shutdown':
+                self.state = 'CLOSED'
+                self.doStopFilterOutgoingTraffic(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-            elif event == 'unserialize-failed':
-                self.state = 'FAILED'
-                self.doReportFailed(*args, **kwargs)
-                self.doEraseInputFile(*args, **kwargs)
+            elif (event == 'proxy_receiver.state' and args[0] == 'LISTEN'):
+                self.state = 'REDIRECTING'
+                self.doSendAllPendingPackets(*args, **kwargs)
+            elif (event == 'proxy_receiver.state' and args[0] == 'OFFLINE'):
+                self.state = 'STOPPED'
+                self.doStopFilterOutgoingTraffic(*args, **kwargs)
+        #---REDIRECTING---
+        elif self.state == 'REDIRECTING':
+            if event == 'stop':
+                self.state = 'STOPPED'
+                self.doStopFilterOutgoingTraffic(*args, **kwargs)
+            elif event == 'shutdown':
+                self.state = 'CLOSED'
+                self.doStopFilterOutgoingTraffic(*args, **kwargs)
                 self.doDestroyMe(*args, **kwargs)
-        #---FAILED---
-        elif self.state == 'FAILED':
-            pass
-        #---DONE---
-        elif self.state == 'DONE':
+            elif event == 'relay-failed':
+                self.doRetryCancelPacket(*args, **kwargs)
+            elif event == 'retry' or event == 'retry-cache-failed' or event == 'retry-send-failed' or event == 'retry-failed':
+                self.doReportRetry(event, *args, **kwargs)
+            elif event == 'relay-ack':
+                self.doCleanPacket(*args, **kwargs)
+            elif event == 'relay-out':
+                self.doCountTraffic(*args, **kwargs)
+            elif (event == 'proxy_receiver.state' and args[0] != 'LISTEN'):
+                self.state = 'ROUTER?'
+        #---CLOSED---
+        elif self.state == 'CLOSED':
             pass
-        #---CACHING---
-        elif self.state == 'CACHING':
-            if event == 'failed':
-                self.state = 'FAILED'
-                self.doReportCacheFailed(*args, **kwargs)
-                self.doEraseInputFile(*args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'remote-id-cached':
-                self.state = 'INBOX?'
-                self.doReadAndUnserialize(*args, **kwargs)
         return None
 
-    def isTransferFinished(self, *args, **kwargs):
-        """
-        Condition method.
-        """
-        status, bytes_received, _ = args[0]
-        if status != 'finished':
-            return False
-        if self.size and self.size > 0 and self.size != bytes_received:
-            return False
-        return True
-
-    def isRemoteIdentityCached(self, *args, **kwargs):
+    def isSendingEnabled(self, *args, **kwargs):
         """
         Condition method.
         """
-        if not self.sender_idurl:
-            return True
-        return self.sender_idurl and identitycache.HasKey(self.sender_idurl)
+        return self._sending_enabled
 
     def doInit(self, *args, **kwargs):
         """
         Action method.
         """
-        self.proto, self.host, self.sender_idurl, self.filename, self.size = args[0]
-        self.time = time.time()
-        # 300  # max(10 * int(self.size/float(settings.SendingSpeedLimit())), 10)
-        if self.size < 1024*10:
-            self.timeout = 10
-        elif self.size > 1024*1024:
-            self.timeout = int(self.size/float(settings.SendingSpeedLimit()))
-        else:
-            self.timeout = 300
-        if not self.sender_idurl:
-            lg.warn('sender_idurl is None: %s' % str(*args, **kwargs))
-        reactor.callLater(0, callback.run_begin_file_receiving_callbacks, self)  # @UndefinedVariable
+        self.traffic_out = 0
+        self.pending_packets = []
+        self.pending_ping_packets = []
+        self.max_pending_packets = 100  # TODO: read from settings
+        self.packets_retries = {}
+        self.sent_packets = {}
 
-    def doEraseInputFile(self, *args, **kwargs):
+    def doStartFilterOutgoingTraffic(self, *args, **kwargs):
         """
         Action method.
         """
-        reactor.callLater(1, tmpfile.throw_out, self.filename, 'received')  # @UndefinedVariable
+        callback.insert_outbox_filter_callback(0, self._on_first_outbox_packet)
 
-    def doCancelItem(self, *args, **kwargs):
+    def doStopFilterOutgoingTraffic(self, *args, **kwargs):
         """
         Action method.
         """
-        from bitdust.transport import gateway
-        t = gateway.transports().get(self.proto, None)
-        if t:
-            t.call('cancel_file_receiving', self.transfer_id)
+        callback.remove_outbox_filter_callback(self._on_first_outbox_packet)
 
-    def doCacheRemoteIdentity(self, *args, **kwargs):
+    def doCountTraffic(self, *args, **kwargs):
         """
         Action method.
         """
-        d = identitycache.immediatelyCaching(self.sender_idurl)
-        d.addCallback(self._on_remote_identity_cached, *args, **kwargs)
-        d.addErrback(self._on_remote_identity_cache_failed, *args, **kwargs)
+        _, newpacket, _ = args[0]
+        self.traffic_out += len(newpacket.Payload)
 
-    def doReadAndUnserialize(self, *args, **kwargs):
+    def doCleanPacket(self, *args, **kwargs):
         """
         Action method.
         """
-        from bitdust.transport import gateway
-        self.status, self.bytes_received, self.error_message = args[0]
-        if _PacketLogFileEnabled:
-            lg.out(
-                0,
-                '                \033[2;49;32mRECEIVED %d bytes from %s://%s TID:%s\033[0m' % (self.bytes_received, self.proto, self.host, self.transfer_id),
-                log_name='packet',
-                showtime=True,
-            )
-        # DO UNSERIALIZE HERE , no exceptions
-        newpacket = gateway.inbox(self)
-        if newpacket is None:
-            if _Debug:
-                lg.out(_DebugLevel, '<<< IN <<< !!!NONE!!! [%s] %s from %s %s' % (
-                    self.proto.upper().ljust(5),
-                    self.status.ljust(8),
-                    self.host,
-                    os.path.basename(self.filename),
-                ))
-            # net_misc.ConnectionFailed(None, proto, 'receiveStatusReport %s' % host)
-            try:
-                fd, _ = tmpfile.make('error', extension='.inbox')
-                data = bpio.ReadBinaryFile(self.filename)
-                os.write(fd, strng.to_bin('from %s:%s %s\n' % (self.proto, self.host, self.status)))
-                os.write(fd, data)
-                os.close(fd)
-            except:
-                lg.exc()
-            if os.path.isfile(self.filename):
-                try:
-                    os.remove(self.filename)
-                except:
-                    lg.exc()
-            self.automat('unserialize-failed', None)
-            return
-        self.label = '[%s@%s]' % (newpacket.Command, newpacket.PacketID)
-        if _Debug:
-            lg.out(_DebugLevel, 'packet_in.doReadAndUnserialize: %s' % newpacket)
-        self.automat('valid-inbox-packet', newpacket)
+        self._do_clean_sent_packet(args[0])
 
-    def doReportReceived(self, *args, **kwargs):
+    def doRetryCancelPacket(self, *args, **kwargs):
         """
         Action method.
         """
-        newpacket = args[0]
-        p2p_stats.count_inbox(self.sender_idurl, self.proto, self.status, self.bytes_received)
-        process(newpacket, self)
+        self._do_retry_one_time(args[0])
 
-    def doReportFailed(self, *args, **kwargs):
+    def doReportRetry(self, event, *args, **kwargs):
         """
         Action method.
         """
-        try:
-            status, bytes_received, _ = args[0]
-        except:
-            status = 'failed'
-            bytes_received = 0
-        p2p_stats.count_inbox(self.sender_idurl, self.proto, status, bytes_received)
-        lg.warn('incoming packet failed %s with %s' % (self.transfer_id, status))
         if _PacketLogFileEnabled:
+            label = event.upper().replace('-', ' ')
+            fail_info = args[0]
             lg.out(
                 0,
-                '                \033[0;49;31mIN FAILED with status "%s" from %s://%s TID:%s\033[0m' % (status, self.proto, self.host, self.transfer_id),
+                '\033[0;49;36m%s %s(%s) from %s to %s %s\033[0m' % (label, fail_info['command'], fail_info['packet_id'], global_id.UrlToGlobalID(fail_info['from']), global_id.UrlToGlobalID(fail_info['to']), fail_info['error']),
                 log_name='packet',
                 showtime=True,
             )
 
-    def doReportCacheFailed(self, *args, **kwargs):
+    def doSendAllPendingPackets(self, *args, **kwargs):
         """
         Action method.
         """
-        if args and args[0]:
-            status, bytes_received, msg = args[0]
-            p2p_stats.count_inbox(self.sender_idurl, self.proto, status, bytes_received)
-        else:
-            status = 'failed'
-            bytes_received = 0
-            msg = 'unknown reason'
-        lg.warn('cache failed : %s' % self.sender_idurl)
-        if _PacketLogFileEnabled:
-            lg.out(
-                0,
-                '                \033[0;49;31mIN CACHE FAILED with "%s" for %s TID:%s\033[0m' % (msg, self.sender_idurl, self.transfer_id),
-                log_name='packet',
-                showtime=True,
-            )
+        def _do_send():
+            while len(self.pending_packets):
+                outpacket, callbacks, wide, response_timeout, keep_alive, pending_result = self.pending_packets.pop(0)
+                if _Debug:
+                    lg.out(_DebugLevel, 'proxy_sender.doSendAllPendingPackets populate one more item, %d more in the queue' % (len(self.pending_packets)))
+                result_packet = self._on_first_outbox_packet(outpacket, wide, callbacks, response_timeout=response_timeout, keep_alive=keep_alive)
+                if not isinstance(result_packet, packet_out.PacketOut):
+                    lg.warn('failed sending pending packet %s, skip all pending packets' % outpacket)
+                    self.pending_packets = []
+                    break
+                pending_result.callback(result_packet)
+
+        reactor.callLater(0, _do_send)  # @UndefinedVariable
 
     def doDestroyMe(self, *args, **kwargs):
         """
         Remove all references to the state machine object to destroy it.
         """
-        inbox_items().pop(self.transfer_id)
+        global _PacketLogFileEnabled
+        _PacketLogFileEnabled = False
+        self.traffic_out = 0
+        self.pending_packets = []
+        self.pending_ping_packets = []
+        self.max_pending_packets = 0
+        self.packets_retries.clear()
+        self.sent_packets.clear()
         self.destroy()
+        global _ProxySender
+        del _ProxySender
+        _ProxySender = None
+
+    def _do_add_pending_packet(self, outpacket, callbacks, wide, response_timeout, keep_alive):
+        if len(self.pending_packets) > self.max_pending_packets:
+            if _Debug:
+                lg.warn('pending packets queue is full, skip sending outgoing packet')
+            return None
+        pending_result = Deferred()
+        self.pending_packets.append((outpacket, callbacks, wide, response_timeout, keep_alive, pending_result))
+        if _Debug:
+            lg.out(_DebugLevel, 'proxy_sender._do_add_pending_packet %s' % outpacket)
+        return pending_result
 
-    def _on_remote_identity_cached(self, xmlsrc, *args, **kwargs):
-        sender_identity = contactsdb.get_contact_identity(self.sender_idurl)
-        if sender_identity is None:
-            self.automat('failed')
-        else:
-            self.automat('remote-id-cached', *args, **kwargs)
-
-    def _on_remote_identity_cache_failed(self, err, *args, **kwargs):
-        lg.warn('%s : %s' % (repr(self), str(err)))
-        self.automat('failed')
+    def _do_send_packet_to_router(self, outpacket, callbacks, wide, response_timeout, keep_alive, is_retry=False):
+        router_idurl = proxy_receiver.GetRouterIDURL()
+        router_identity_obj = proxy_receiver.GetRouterIdentity()
+        router_proto_host = proxy_receiver.GetRouterProtoHost()
+        router_proto, router_host = router_proto_host
+        publickey = router_identity_obj.publickey
+        my_original_identity_src = proxy_receiver.ReadMyOriginalIdentitySource()
+        if not router_idurl or not router_identity_obj or not router_proto_host or not my_original_identity_src:
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._do_send_packet_to_router SKIP because router not ready yet')
+            return self._do_add_pending_packet(outpacket, callbacks, wide, response_timeout, keep_alive)
+        if outpacket.RemoteID.to_bin() == router_idurl.to_bin():
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._do_send_packet_to_router SKIP, packet addressed to router and must be sent in a usual way')
+            return None
+        try:
+            raw_data = outpacket.Serialize()
+        except:
+            lg.exc('failed to Serialize %s' % outpacket)
+            return None
+        # see proxy_router.ProxyRouter : doForwardOutboxPacket() for receiving part
+        json_payload = {
+            'f': my_id.getIDURL().to_bin(),  # from
+            't': outpacket.RemoteID.to_bin(),  # to
+            'p': raw_data,  # payload
+            'w': wide,  # wide
+            'i': response_timeout,
+            'a': keep_alive,
+            'r': is_retry,
+        }
+        if not json_payload['t']:
+            raise ValueError('receiver idurl was not set')
+        raw_bytes = serialization.DictToBytes(json_payload)
+        block = encrypted.Block(
+            CreatorID=my_id.getIDURL(),
+            BackupID='routed outgoing data',
+            BlockNumber=0,
+            SessionKey=key.NewSessionKey(session_key_type=key.SessionKeyType()),
+            SessionKeyType=key.SessionKeyType(),
+            LastBlock=True,
+            Data=raw_bytes,
+            EncryptKey=lambda inp: key.EncryptOpenSSHPublicKey(publickey, inp),
+        )
+        block_encrypted = block.Serialize()
+        newpacket = signed.Packet(
+            Command=commands.RelayOut(),
+            OwnerID=outpacket.OwnerID,
+            CreatorID=my_id.getIDURL(),
+            PacketID=outpacket.PacketID,
+            Payload=block_encrypted,
+            RemoteID=router_idurl,
+        )
+        if response_timeout is not None:
+            # must give some extra time for the proxy re-routing
+            response_timeout += 10.0
+        routed_packet = packet_out.create(
+            outpacket=outpacket,
+            wide=False,
+            callbacks={},
+            route={
+                'packet': newpacket,  # pointing "newpacket" to router node
+                'proto': router_proto,
+                'host': router_host,
+                'remoteid': router_idurl,
+                'description': 'RelayOut_%s[%s]_%s' % (outpacket.Command, outpacket.PacketID, nameurl.GetName(router_idurl)),
+            },
+            response_timeout=response_timeout,
+            keep_alive=True,
+        )
+        for command, cb_list in callbacks.items():
+            if isinstance(cb_list, list):
+                for cb in cb_list:
+                    routed_packet.set_callback(command, cb)
+            else:
+                routed_packet.set_callback(command, cb_list)
+        if not is_retry:
+            _key = (outpacket.Command, outpacket.PacketID, outpacket.RemoteID.to_bin())
+            self.sent_packets[_key] = (routed_packet, outpacket)
+        self.event('relay-out', (outpacket, newpacket, routed_packet))
+        if _Debug:
+            lg.out(_DebugLevel, '>>>Relay-OUT %s sent to %s://%s with %d bytes, timeout=%r' % (str(outpacket), router_proto, router_host, len(block_encrypted), response_timeout))
+        if _PacketLogFileEnabled:
+            lg.out(
+                0, '\033[0;49;36mRELAY OUT %s(%s) with %s bytes from %s to %s via %s\033[0m' %
+                (outpacket.Command, outpacket.PacketID, len(raw_bytes), global_id.UrlToGlobalID(outpacket.CreatorID), global_id.UrlToGlobalID(outpacket.RemoteID), global_id.UrlToGlobalID(router_idurl)), log_name='packet', showtime=True
+            )
+        del raw_bytes
+        del block
+        del newpacket
+        del outpacket
+        del router_identity_obj
+        del router_idurl
+        del router_proto_host
+        return routed_packet
+
+    def _do_cancel_outbox_packets(self, fail_info):
+        to_idurl = id_url.field(fail_info['to'])
+        from_idurl = id_url.field(fail_info['from'])
+        for p in packet_out.search_by_packet_id(fail_info['packet_id']):
+            if p.outpacket.Command == fail_info['command']:
+                if id_url.to_bin(to_idurl) == p.outpacket.RemoteID.to_bin():
+                    if p.outpacket.CreatorID.to_bin() == id_url.to_bin(from_idurl) or p.outpacket.OwnerID.to_bin() == id_url.to_bin(from_idurl):
+                        if _Debug:
+                            lg.dbg(_DebugLevel, 'about to cancel %r because sending via proxy transport is failed' % p)
+                        p.automat('cancel')
+
+    def _do_retry_one_time(self, fail_info):
+        to_idurl = id_url.field(fail_info['to']).to_bin()
+        from_idurl = id_url.field(fail_info['from']).to_bin()
+        _key = (fail_info['command'], fail_info['packet_id'], from_idurl, to_idurl)
+        current_retries = self.packets_retries.get(_key, 0)
+        if _Debug:
+            lg.args(_DebugLevel, key=_key, retries=current_retries)
+        if fail_info.get('error') != 'route already closed':
+            if _Debug:
+                lg.dbg(_DebugLevel, 'failed sending routed packet : %r' % fail_info)
+            self._do_clean_sent_packet(fail_info)
+            self._do_cancel_outbox_packets(fail_info)
+            self.packets_retries.pop(_key, None)
+            return
+        if current_retries >= 1:
+            if _Debug:
+                lg.dbg(_DebugLevel, 'failed sending routed packet after few attempts : %r' % fail_info)
+            self.automat('retry-failed', fail_info)
+            self._do_clean_sent_packet(fail_info)
+            self._do_cancel_outbox_packets(fail_info)
+            self.packets_retries.pop(_key, None)
+            return
+        self.packets_retries[_key] = current_retries + 1
+        d = identitycache.immediatelyCaching(fail_info['to'])
+        d.addCallback(self._on_cache_retry_success, fail_info)
+        d.addErrback(self._on_cache_retry_failed, fail_info)
+
+    def _do_clean_sent_packet(self, info):
+        to_idurl = id_url.to_bin(info['to'])
+        to_remove = []
+        for _key in self.sent_packets.keys():
+            routed_packet, outpacket = self.sent_packets.get(_key, (
+                None,
+                None,
+            ))
+            if not outpacket:
+                if _Debug:
+                    lg.dbg(_DebugLevel, 'found empty outpacket : %r' % routed_packet)
+                to_remove.append(_key)
+                continue
+            if outpacket.Command != info['command']:
+                continue
+            if outpacket.PacketID != info['packet_id']:
+                continue
+            if outpacket.RemoteID.to_bin() != to_idurl:
+                continue
+            to_remove.append(_key)
+        for _key in to_remove:
+            routed_packet, outpacket = self.sent_packets.pop(_key, (
+                None,
+                None,
+            ))
+
+    def _on_cache_retry_success(self, xmlsrc, fail_info):
+        if _Debug:
+            lg.args(_DebugLevel, sent_packets=len(self.sent_packets), fail_info=fail_info)
+        to_idurl = id_url.to_bin(fail_info['to'])
+        for _key in self.sent_packets.keys():
+            routed_packet, outpacket = self.sent_packets.get(_key, (
+                None,
+                None,
+            ))
+            if not outpacket:
+                if _Debug:
+                    lg.dbg(_DebugLevel, 'found empty outpacket : %r' % routed_packet)
+                continue
+            if outpacket.Command != fail_info['command']:
+                continue
+            if outpacket.PacketID != fail_info['packet_id']:
+                continue
+            if outpacket.RemoteID.to_bin() != to_idurl:
+                continue
+            routed_retry_packet = self._do_send_packet_to_router(
+                outpacket=outpacket,
+                callbacks=routed_packet.callbacks,
+                wide=fail_info.get('wide', False),
+                keep_alive=fail_info.get('keep_alive', False),
+                response_timeout=fail_info.get('response_timeout', None),
+                is_retry=True,
+            )
+            if not routed_retry_packet:
+                self.automat('retry-send-failed', fail_info)
+            else:
+                self.sent_packets[_key] = (
+                    routed_retry_packet,
+                    outpacket,
+                )
+                self.automat('retry', fail_info)
+            del routed_packet
         return None
+
+    def _on_cache_retry_failed(self, err, fail_info):
+        if _Debug:
+            lg.args(_DebugLevel, err=err, fail_info=fail_info)
+        self.automat('retry-cache-failed', fail_info)
+        self._do_cancel_outbox_packets(fail_info)
+        return None
+
+    def _on_first_outbox_packet(self, outpacket, wide, callbacks, target=None, route=None, response_timeout=None, keep_alive=True):
+        """
+        Will be called first for every outgoing packet.
+        Must return `None` if that packet should be sent in a normal way.
+        Otherwise will create another "routed" packet instead and return it.
+        """
+        if not driver.is_on('service_proxy_transport'):
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because service_proxy_transport is not started yet' % outpacket)
+            return None
+        if not proxy_receiver.A():
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because proxy_receiver() not exist' % outpacket)
+            return None
+        if outpacket.Command == commands.Identity() and outpacket.CreatorID == my_id.getIDURL():
+            if proxy_receiver.GetPossibleRouterIDURL() and proxy_receiver.GetPossibleRouterIDURL().to_bin() == outpacket.RemoteID.to_bin():
+                if network_connector.A().state == 'DISCONNECTED':
+                    if _Debug:
+                        lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because network_connector() is DISCONNECTED' % outpacket)
+                    return None
+                if network_connector.A().state == 'CONNECTED':
+                    lg.warn('sending %r to "possible" proxy router %r' % (outpacket, proxy_receiver.GetPossibleRouterIDURL()))
+                    pkt_out = packet_out.create(outpacket, wide, callbacks, target, route, response_timeout, keep_alive)
+                    return pkt_out
+                if _Debug:
+                    lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r, network_connector() have transition state' % outpacket)
+                return None
+        if proxy_receiver.A().state != 'LISTEN':
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet DELLAYED %r because proxy_receiver state is not LISTEN yet' % outpacket)
+            return self._do_add_pending_packet(outpacket, callbacks, wide, response_timeout, keep_alive)
+        return self._do_send_packet_to_router(
+            outpacket=outpacket,
+            callbacks=callbacks,
+            wide=wide,
+            keep_alive=keep_alive,
+            response_timeout=response_timeout,
+        )
+
+    def _on_network_connector_state_changed(self, oldstate, newstate, event_string, *args, **kwargs):
+        if newstate == 'CONNECTED' and oldstate != newstate:
+            if _Debug:
+                lg.out(_DebugLevel, 'proxy_sender._on_network_connector_state_changed will send %d pending "ping" packets' % len(self.pending_ping_packets))
+            while len(self.pending_ping_packets):
+                outpacket, wide, callbacks, target, route, response_timeout, keep_alive, pending_result = self.pending_ping_packets.pop(0)
+                if _Debug:
+                    lg.out(_DebugLevel, 'proxy_sender._on_network_connector_state_changed populate one more item, %d more in the queue' % (len(self.pending_packets)))
+                result_packet = self._on_first_outbox_packet(outpacket, wide, callbacks, target, route, response_timeout, keep_alive)
+                if not isinstance(result_packet, packet_out.PacketOut):
+                    lg.warn('failed sending pending packet %s, skip all pending packets' % outpacket)
+                    self.pending_ping_packets = []
+                    break
+                pending_result.callback(result_packet)
+
+
+#------------------------------------------------------------------------------
+
+
+def main():
+    reactor.callWhenRunning(A, 'init')  # @UndefinedVariable
+    reactor.run()  # @UndefinedVariable
+
+
+#------------------------------------------------------------------------------
+
+if __name__ == '__main__':
+    main()
```

### Comparing `bitdust-0.1.8.234/bitdust/transport/packet_out.py` & `bitdust-0.1.9.241/bitdust/transport/packet_out.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/proxy/__init__.py` & `bitdust-0.1.9.241/bitdust/transport/proxy/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/proxy/proxy_interface.py` & `bitdust-0.1.9.241/bitdust/transport/proxy/proxy_interface.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/proxy/proxy_receiver.py` & `bitdust-0.1.9.241/bitdust/userid/id_url.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,13 +1,14 @@
-#!/usr/bin/env python
-# proxy_receiver.py
+#!/usr/bin/python
+# id_url.py
+#
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (proxy_receiver.py) is part of BitDust Software.
+# This file (id_url.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -15,958 +16,1016 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
+#
+#
+#
+#
+#
 """
-.. module:: proxy_receiver.
+.. module:: id_url.
 
 .. role:: red
 
-BitDust proxy_receiver(at_startup) Automat
+This is a core module.
 
-.. raw:: html
+IDURL of your node can changed over time, see id_rotator() state machine which does that.
+So you must remember your "old" identity sources and store locally old IDURL's you had.
+This way when you receive a packet from another node which do not know your new IDURL yet,
+you can understand that he is actually trying to contact you and act properly.
 
-    <i>generated using <a href="https://bitdust.io/visio2python/" target="_blank">visio2python</a> tool</i><br>
-    <a href="proxy_receiver.png" target="_blank">
-    <img src="proxy_receiver.png" style="max-width:100%;">
-    </a>
-
-EVENTS:
-    * :red:`ack-received`
-    * :red:`ack-timeout`
-    * :red:`fail-received`
-    * :red:`found-one-node`
-    * :red:`inbox-packet`
-    * :red:`init`
-    * :red:`nodes-not-found`
-    * :red:`request-timeout`
-    * :red:`router-disconnected`
-    * :red:`router-id-received`
-    * :red:`sending-failed`
-    * :red:`service-accepted`
-    * :red:`service-refused`
-    * :red:`shutdown`
-    * :red:`start`
-    * :red:`stop`
-    * :red:`timer-10sec`
-    * :red:`timer-15sec`
-    * :red:`timer-30sec`
+Also if you stored some packet for user A and then his IDURL changed you must still be able to
+correctly reply to him and send stored data back when he requests.
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
-from io import BytesIO
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 16
-
-_PacketLogFileEnabled = False
+_DebugLevel = 12
 
 #------------------------------------------------------------------------------
 
-import re
-import time
-import random
-
-from twisted.internet import reactor  # @UnresolvedImport
+import os
+import sys
+import tempfile
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
-from bitdust.lib import packetid
-from bitdust.lib import strng
-from bitdust.lib import serialization
-from bitdust.lib import net_misc
+from bitdust.system import bpio
+from bitdust.system import local_fs
 
-from bitdust.automats import automat
+from bitdust.crypt import hashes
 
-from bitdust.main import config
-from bitdust.main import settings
+from bitdust.lib import strng
+from bitdust.lib import nameurl
 
-from bitdust.crypt import key
-from bitdust.crypt import signed
-from bitdust.crypt import encrypted
+from bitdust.main import settings
 
-from bitdust.p2p import commands
-from bitdust.p2p import lookup
-from bitdust.p2p import online_status
+#------------------------------------------------------------------------------
 
-from bitdust.contacts import identitycache
+_IdentityHistoryDir = None
+# TODO: if this dictionary grow too much use CodernityDB instead of in-memory storage
+_KnownUsers = {}
+_KnownIDURLs = {}
+_MergedIDURLs = {}
+_KnownSources = {}
+_Ready = False
 
-from bitdust.services import driver
+#------------------------------------------------------------------------------
 
-from bitdust.transport import callback
-from bitdust.transport import packet_in
-from bitdust.transport import packet_out
 
-from bitdust.transport import gateway
-from bitdust.transport.proxy import proxy_interface
+def init():
+    global _IdentityHistoryDir
+    global _KnownUsers
+    global _KnownIDURLs
+    global _MergedIDURLs
+    global _KnownSources
+    global _Ready
+    from bitdust.userid import identity
+    if _Debug:
+        lg.out(_DebugLevel, 'id_url.init')
+    if not _IdentityHistoryDir:
+        _IdentityHistoryDir = settings.IdentityHistoryDir()
+    if not os.path.exists(_IdentityHistoryDir):
+        bpio._dir_make(_IdentityHistoryDir)
+        lg.info('created new folder %r' % _IdentityHistoryDir)
+    else:
+        lg.info('using existing folder %r' % _IdentityHistoryDir)
+    for_cleanup = []
+    for one_user_dir in os.listdir(_IdentityHistoryDir):
+        one_user_dir_path = os.path.join(_IdentityHistoryDir, one_user_dir)
+        if not os.path.isdir(one_user_dir_path):
+            continue
+        one_user_identity_files = []
+        for one_filename in os.listdir(one_user_dir_path):
+            try:
+                one_ident_number = int(one_filename)
+            except:
+                lg.exc()
+                continue
+            one_user_identity_files.append(one_ident_number)
+        if _Debug:
+            lg.out(_DebugLevel, 'id_url.init   found %d historical records in %r' % (len(one_user_identity_files), one_user_dir_path))
+        one_user_identity_files.sort()
+        for one_ident_file in one_user_identity_files:
+            one_ident_path = os.path.join(one_user_dir_path, strng.to_text(one_ident_file))
+            try:
+                xmlsrc = local_fs.ReadTextFile(one_ident_path)
+                known_id_obj = identity.identity(xmlsrc=xmlsrc)
+                if not known_id_obj.isCorrect():
+                    raise Exception('identity history in %r is broken, identity is not correct: %r' % (one_user_dir, one_ident_path))
+                if not known_id_obj.Valid():
+                    raise Exception('identity history in %r is broken, identity is not valid: %r' % (one_user_dir, one_ident_path))
+            except Exception as exc:
+                lg.warn(str(exc))
+                for_cleanup.append(one_ident_path)
+                continue
+            one_pub_key = known_id_obj.getPublicKey()
+            one_revision = known_id_obj.getRevisionValue()
+            if one_pub_key not in _KnownUsers:
+                _KnownUsers[one_pub_key] = one_user_dir_path
+            known_sources = known_id_obj.getSources(as_originals=True)
+            for known_idurl in reversed(known_sources):
+                if known_idurl not in _KnownIDURLs:
+                    _KnownIDURLs[known_idurl] = known_id_obj.getPublicKey()
+                    if _Debug:
+                        lg.out(_DebugLevel, '    new IDURL added: %r' % known_idurl)
+                else:
+                    if _KnownIDURLs[known_idurl] != known_id_obj.getPublicKey():
+                        _KnownIDURLs[known_idurl] = known_id_obj.getPublicKey()
+                        lg.warn('another user had same identity source: %r' % known_idurl)
+                if one_pub_key not in _MergedIDURLs:
+                    _MergedIDURLs[one_pub_key] = {}
+                    if _Debug:
+                        lg.out(_DebugLevel, '    new Public Key added: %s...' % one_pub_key[-10:])
+                if one_revision in _MergedIDURLs[one_pub_key]:
+                    if _MergedIDURLs[one_pub_key][one_revision] != known_idurl:
+                        if _MergedIDURLs[one_pub_key][one_revision] not in known_sources:
+                            lg.warn('rewriting existing identity revision %d : %r -> %r' % (one_revision, _MergedIDURLs[one_pub_key][one_revision], known_idurl))
+                    _MergedIDURLs[one_pub_key][one_revision] = known_idurl
+                else:
+                    _MergedIDURLs[one_pub_key][one_revision] = known_idurl
+                    if _Debug:
+                        lg.out(_DebugLevel, '        revision %d merged with other %d known items' % (one_revision, len(_MergedIDURLs[one_pub_key])))
+                if one_pub_key not in _KnownSources:
+                    _KnownSources[one_pub_key] = []
+                for one_source in known_id_obj.getSources(as_originals=True):
+                    if one_source not in _KnownSources[one_pub_key]:
+                        _KnownSources[one_pub_key].append(one_source)
+                        if _Debug:
+                            lg.out(_DebugLevel, '    new source %r added for %r' % (one_source, one_pub_key[-10:]))
+    for one_ident_path in for_cleanup:
+        if os.path.isfile(one_ident_path):
+            lg.warn('about to erase broken historical identity file: %r' % one_ident_path)
+            try:
+                os.remove(one_ident_path)
+            except:
+                lg.exc()
+    _Ready = True
 
-from bitdust.userid import identity
-from bitdust.userid import global_id
-from bitdust.userid import id_url
-from bitdust.userid import my_id
 
-#------------------------------------------------------------------------------
+def shutdown():
+    global _IdentityHistoryDir
+    global _KnownIDURLs
+    global _KnownUsers
+    global _Ready
+    global _MergedIDURLs
+    global _KnownSources
+    _IdentityHistoryDir = None
+    _KnownUsers.clear()
+    _KnownIDURLs.clear()
+    _MergedIDURLs.clear()
+    _KnownSources.clear()
+    _Ready = False
 
-_ProxyReceiver = None
 
 #------------------------------------------------------------------------------
 
 
-def GetRouterIDURL():
-    global _ProxyReceiver
-    if not _ProxyReceiver:
-        return None
-    return _ProxyReceiver.router_idurl
+def known():
+    global _KnownIDURLs
+    return _KnownIDURLs
+
+
+def merged(pub_key=None):
+    global _MergedIDURLs
+    if pub_key is None:
+        return _MergedIDURLs
+    return _MergedIDURLs.get(pub_key, {})
+
+
+def users(pub_key=None):
+    global _KnownUsers
+    if pub_key is None:
+        return _KnownUsers
+    return _KnownUsers.get(pub_key, None)
+
+
+def sources(pub_key=None):
+    global _KnownSources
+    if pub_key is None:
+        return _KnownSources
+    return _KnownSources.get(pub_key, [])
 
 
-def GetPossibleRouterIDURL():
-    global _ProxyReceiver
-    if not _ProxyReceiver:
-        return None
-    return _ProxyReceiver.possible_router_idurl
+#------------------------------------------------------------------------------
 
 
-def GetRouterIdentity():
-    global _ProxyReceiver
-    if not _ProxyReceiver:
-        return None
-    return _ProxyReceiver.router_identity
+def identity_cached(new_id_obj):
+    """
+    After receiving identity file of another user we need to check his identity sources.
+    I can be file from identity server or Identity() packet received directly from remote peer.
+    Also it can be my own identity that was changed locally.
+    In any case we need to take certain actions if those identity sources changed.
+    First identity source forms IDURL of that identity and act as unique global ID of that BitDust node.
+    When first identity source changed (because identity server went down) identity is "rotated":
+    second identity source will be placed on the first position and IDURL will change.
+    In that case we need to remember new IDURL and keep track of old IDURL of that user - this way we can
+    match and merge different IDURL's for one owner.
+    """
+    global _IdentityHistoryDir
+    global _KnownUsers
+    global _KnownIDURLs
+    global _MergedIDURLs
+    global _KnownSources
+    from bitdust.userid import identity
+    pub_key = new_id_obj.getPublicKey()
+    user_name = new_id_obj.getIDName()
+    if _Debug:
+        lg.args(_DebugLevel, user_name=user_name)
+    is_identity_rotated = False
+    latest_id_obj = None
+    latest_sources = []
+    for_cleanup = []
+    if pub_key not in _KnownUsers:
+        user_path = tempfile.mkdtemp(prefix=user_name + '@', dir=_IdentityHistoryDir)
+        _KnownUsers[pub_key] = user_path
+        first_identity_file_path = os.path.join(user_path, '0')
+        local_fs.WriteBinaryFile(first_identity_file_path, new_id_obj.serialize())
+        if _Debug:
+            lg.out(_DebugLevel, 'id_url.identity_cached wrote first item for user %r in identity history: %r' % (user_name, first_identity_file_path))
+    else:
+        user_path = _KnownUsers[pub_key]
+        user_identity_files = sorted(map(int, os.listdir(user_path)))
+        if len(user_identity_files) == 0:
+            lg.warn('identity history for user %r is broken, public key is known, but no identity files found' % user_name)
+        latest_identity_file_path = ''
+        latest_pub_key = None
+        latest_revision = -1
+        known_revisions = set()
+        for id_file in user_identity_files:
+            identity_file_path = os.path.join(user_path, strng.to_text(id_file))
+            xmlsrc = local_fs.ReadBinaryFile(identity_file_path)
+            one_id_obj = identity.identity(xmlsrc=xmlsrc)
+            if not one_id_obj.isCorrect():
+                lg.warn('identity history for user %r is broken, identity in the file %r is not correct' % (user_name, identity_file_path))
+                for_cleanup.append(identity_file_path)
+                continue
+            if not one_id_obj.Valid():
+                lg.warn('identity history for user %r is broken, identity in the file %r is not valid' % (user_name, identity_file_path))
+                for_cleanup.append(identity_file_path)
+                continue
+            if not latest_pub_key:
+                latest_pub_key = one_id_obj.getPublicKey()
+            if latest_pub_key != one_id_obj.getPublicKey():
+                lg.err('identity history for user %r is broken, public key not matching in the file %r' % (user_name, identity_file_path))
+                for_cleanup.append(identity_file_path)
+                continue
+            known_revisions.add(one_id_obj.getRevisionValue())
+            if one_id_obj.getRevisionValue() > latest_revision:
+                latest_revision = one_id_obj.getRevisionValue()
+                latest_identity_file_path = identity_file_path
+        xmlsrc = local_fs.ReadBinaryFile(latest_identity_file_path)
+        if xmlsrc:
+            latest_id_obj = identity.identity(xmlsrc=xmlsrc)
+            if latest_id_obj.getPublicKey() != new_id_obj.getPublicKey():
+                raise Exception('identity history for user %r is broken, public key not matching' % user_name)
+            if latest_id_obj.getIDName() != new_id_obj.getIDName():
+                lg.warn('found another user name in identity history for user %r : %r' % (user_name, latest_id_obj.getIDName()))
+            if new_id_obj.getRevisionValue() in known_revisions:
+                if _Debug:
+                    lg.out(_DebugLevel, 'id_url.identity_cached revision %d already known for user %r' % (new_id_obj.getRevisionValue(), user_name))
+            else:
+                latest_sources = latest_id_obj.getSources(as_originals=True)
+                new_sources = new_id_obj.getSources(as_originals=True)
+                if latest_sources == new_sources:
+                    local_fs.WriteBinaryFile(latest_identity_file_path, new_id_obj.serialize())
+                    if _Debug:
+                        lg.out(_DebugLevel, 'id_url.identity_cached latest identity sources for user %r did not changed, updated file %r' % (user_name, latest_identity_file_path))
+                else:
+                    next_identity_file = user_identity_files[-1] + 1
+                    next_identity_file_path = os.path.join(user_path, strng.to_text(next_identity_file))
+                    local_fs.WriteBinaryFile(next_identity_file_path, new_id_obj.serialize())
+                    is_identity_rotated = True
+                    if _Debug:
+                        lg.out(_DebugLevel, 'id_url.identity_cached identity sources for user %r changed, wrote new item in the history: %r' % (user_name, next_identity_file_path))
+    new_revision = new_id_obj.getRevisionValue()
+    new_sources = new_id_obj.getSources(as_originals=True)
+    for new_idurl in reversed(new_sources):
+        if new_idurl not in _KnownIDURLs:
+            _KnownIDURLs[new_idurl] = new_id_obj.getPublicKey()
+            if _Debug:
+                lg.out(_DebugLevel, 'id_url.identity_cached new IDURL added: %r' % new_idurl)
+        else:
+            if _KnownIDURLs[new_idurl] != new_id_obj.getPublicKey():
+                lg.warn('another user had same identity source: %r' % new_idurl)
+                _KnownIDURLs[new_idurl] = new_id_obj.getPublicKey()
+        if pub_key not in _MergedIDURLs:
+            _MergedIDURLs[pub_key] = {}
+            if _Debug:
+                lg.out(_DebugLevel, 'id_url.identity_cached new Public Key added: %s...' % pub_key[-10:])
+        prev_idurl = _MergedIDURLs[pub_key].get(new_revision, None)
+        if new_revision in _MergedIDURLs[pub_key]:
+            if _MergedIDURLs[pub_key][new_revision] != new_idurl:
+                if nameurl.GetName(_MergedIDURLs[pub_key][new_revision]) == nameurl.GetName(new_idurl):
+                    if _MergedIDURLs[pub_key][new_revision] not in new_sources:
+                        lg.warn('rewriting existing identity revision %d : %r -> %r' % (new_revision, _MergedIDURLs[pub_key][new_revision], new_idurl))
+            _MergedIDURLs[pub_key][new_revision] = new_idurl
+        else:
+            _MergedIDURLs[pub_key][new_revision] = new_idurl
+            if _Debug:
+                lg.out(_DebugLevel, 'id_url.identity_cached added new revision %d for user %r, total revisions %d: %r -> %r' % (new_revision, user_name, len(_MergedIDURLs[pub_key]), prev_idurl, new_idurl))
+    if pub_key not in _KnownSources:
+        _KnownSources[pub_key] = []
+    for one_source in new_sources:
+        if one_source not in _KnownSources[pub_key]:
+            _KnownSources[pub_key].append(one_source)
+            if _Debug:
+                lg.out(_DebugLevel, 'id_url.identity_cached added new source %r for user %r' % (one_source, user_name))
+    if _Debug:
+        lg.args(_DebugLevel, is_identity_rotated=is_identity_rotated, latest_id_obj=bool(latest_id_obj))
+    if is_identity_rotated and latest_id_obj is not None:
+        latest_revision = latest_id_obj.getRevisionValue()
+        if _Debug:
+            lg.args(_DebugLevel, new_revision=new_revision, latest_revision=latest_revision)
+        if new_revision > latest_revision:
+            lg.info('found rotated identity after caching %r -> %r' % (latest_id_obj.getSources(as_originals=True)[0], new_sources[0]))
+            from bitdust.main import events
+            events.send('identity-rotated', data=dict(
+                old_idurls=latest_id_obj.getSources(as_originals=True),
+                new_idurls=new_id_obj.getSources(as_originals=True),
+                old_revision=latest_id_obj.getRevisionValue(),
+                new_revision=new_revision,
+            ))
+            if latest_id_obj.getIDURL(as_original=True) != new_id_obj.getIDURL(as_original=True):
+                events.send('identity-url-changed', data=dict(
+                    old_idurl=latest_id_obj.getIDURL(as_original=True),
+                    new_idurl=new_id_obj.getIDURL(as_original=True),
+                    old_revision=latest_id_obj.getRevisionValue(),
+                    new_revision=new_revision,
+                ))
+            from bitdust.userid import my_id
+            if my_id.isLocalIdentityReady():
+                if my_id.getIDURL() == new_id_obj.getIDURL():
+                    # yapf: disable
+                    events.send('my-identity-rotated', data=dict(
+                        old_idurls=latest_id_obj.getSources(as_originals=True),
+                        new_idurls=new_id_obj.getSources(as_originals=True),
+                        old_revision=latest_id_obj.getRevisionValue(),
+                        new_revision=new_revision,
+                    ))
+                    # yapf: enable
+                    if latest_id_obj.getIDURL(as_original=True) != new_id_obj.getIDURL(as_original=True):
+                        # yapf: disable
+                        events.send('my-identity-url-changed', data=dict(
+                            old_idurl=latest_id_obj.getIDURL(as_original=True),
+                            new_idurl=new_id_obj.getIDURL(as_original=True),
+                            old_revision=latest_id_obj.getRevisionValue(),
+                            new_revision=new_revision,
+                        ))
+                        # yapf: enable
+        else:
+            lg.warn('cached out-dated revision %d for %r, most recent revision is %d' % (new_revision, new_sources[0], latest_revision))
+    else:
+        if _Debug:
+            lg.out(_DebugLevel, 'id_url.identity_cached revision %d for %r' % (new_revision, new_sources[0]))
+    for identity_file_path in for_cleanup:
+        if os.path.isfile(identity_file_path):
+            try:
+                os.remove(identity_file_path)
+            except:
+                lg.exc()
+    return True
 
 
-def GetRouterProtoHost():
-    global _ProxyReceiver
-    if not _ProxyReceiver:
-        return None
-    return _ProxyReceiver.router_proto_host
+#------------------------------------------------------------------------------
 
 
-def ReadMyOriginalIdentitySource():
-    return config.conf().getData('services/proxy-transport/my-original-identity').strip()
+def field(idurl):
+    """
+    Translates string into `ID_URL_FIELD` object.
+    Also we try to read from local identity cache folder if do not know given "idurl".
+    """
+    global _KnownIDURLs
+    if isinstance(idurl, ID_URL_FIELD):
+        return idurl
+    if idurl in [None, 'None', '', b'None', b'', False]:
+        return ID_URL_FIELD(idurl)
+    idurl = strng.to_bin(idurl.strip())
+    if idurl not in _KnownIDURLs:
+        if _Debug:
+            lg.out(_DebugLevel, 'id_url.field   will try to find %r in local identity cache' % idurl)
+        from bitdust.contacts import identitydb
+        cached_ident = identitydb.get_ident(idurl)
+        if cached_ident:
+            identity_cached(cached_ident)
+        else:
+            if _Debug:
+                cod = sys._getframe(1).f_back.f_code
+                modul = os.path.basename(cod.co_filename).replace('.py', '')
+                caller = cod.co_name
+                lg.warn('unknown yet idurl %s, call from %s.%s' % (idurl, modul, caller))
+    return ID_URL_FIELD(idurl)
 
 
-def WriteMyOriginalIdentitySource(new_identity_xml_src):
-    return config.conf().setData('services/proxy-transport/my-original-identity', new_identity_xml_src)
+def fields_list(idurl_list):
+    """
+    Same as `field()` but for lists.
+    """
+    return list(map(field, idurl_list))
 
 
-def ReadCurrentRouter():
-    return config.conf().getString('services/proxy-transport/current-router').strip()
+def fields_dict(idurl_dict):
+    """
+    Translates dictionary keys into `ID_URL_FIELD` objects.
+    """
+    return {field(k): v for k, v in idurl_dict.items()}
 
 
-def VerifyExistingRouter():
-    if ReadCurrentRouter() and not ReadMyOriginalIdentitySource():
-        lg.err('current router is set, but my original identity is empty')
+def is_idurl(value):
+    """
+    Return True if input is `ID_URL_FIELD` field or string in valid format.
+    """
+    if value in [None, 'None', '', b'None', b'', False]:
+        return False
+    if isinstance(value, ID_URL_FIELD):
+        return True
+    if not strng.is_string(value):
         return False
-    if not ReadCurrentRouter() and ReadMyOriginalIdentitySource():
-        lg.err('current router is not set, but some wrong data found as original identity')
+    v = strng.to_text(value)
+    if not v.startswith('http') or not v.endswith('.xml') or v.count('://') != 1:
         return False
     return True
 
 
-def LatestPacketReceived():
-    global _ProxyReceiver
-    if not _ProxyReceiver:
-        return 0
-    return _ProxyReceiver.latest_packet_received
+def to_bin(idurl):
+    """
+    Translates `ID_URL_FIELD` to binary string.
+    """
+    if isinstance(idurl, ID_URL_FIELD):
+        return idurl.to_bin()
+    if idurl in [None, 'None', '', b'None', b'', False]:
+        return b''
+    return strng.to_bin(idurl)
 
 
-#------------------------------------------------------------------------------
+def to_original(idurl):
+    """
+    Translates `ID_URL_FIELD` to binary string, but returns its original value.
+    """
+    if isinstance(idurl, ID_URL_FIELD):
+        return idurl.original()
+    if idurl in [None, 'None', '', b'None', b'', False]:
+        return b''
+    return strng.to_bin(idurl)
 
 
-def A(event=None, *args, **kwargs):
+def to_list(iterable_object, as_field=True, as_bin=False, as_original=False):
     """
-    Access method to interact with proxy_receiver machine.
+    Creates list of desired objects from given `iterable_object`.
     """
-    global _ProxyReceiver
-    if event is None and not args:
-        return _ProxyReceiver
-    if _ProxyReceiver is None:
-        # set automat name and starting state here
-        _ProxyReceiver = ProxyReceiver()
-    if event is not None:
-        _ProxyReceiver.automat(event, *args, **kwargs)
-    return _ProxyReceiver
+    if not iterable_object:
+        return iterable_object
+    if as_original:
+        return list(map(to_original, iterable_object))
+    if as_field:
+        return list(map(field, iterable_object))
+    if as_bin:
+        return list(map(to_bin, iterable_object))
+    return list(map(strng.to_text, iterable_object))
 
 
-#------------------------------------------------------------------------------
+def to_bin_list(iterable_object):
+    """
+    Just an alias for to_list().
+    """
+    if not iterable_object:
+        return iterable_object
+    return to_list(iterable_object, as_field=False, as_bin=True)
 
 
-class ProxyReceiver(automat.Automat):
+def to_original_list(iterable_object):
     """
-    This class implements all the functionality of the ``proxy_receiver()``
-    state machine.
+    Just an alias for to_list() to extract original values from idurl's.
     """
+    if not iterable_object:
+        return iterable_object
+    return to_list(iterable_object, as_original=True)
 
-    timers = {
-        'timer-10sec': (10.0, ['LISTEN']),
-        'timer-15sec': (15.0, ['ACK?']),
-        'timer-30sec': (30.0, ['FIND_NODE?']),
-    }
-
-    def __init__(self):
-        """
-        Builds `proxy_receiver()` state machine.
-        """
-        self.possible_router_idurl = None
-        self.router_idurl = None
-        self.router_identity = None
-        self.router_id = ''
-        self.router_proto_host = None
-        self.request_service_packet_id = []
-        self.latest_packet_received = 0
-        self.router_connection_info = None
-        self.traffic_in = 0
-        super(ProxyReceiver, self).__init__(
-            name='proxy_receiver',
-            state='AT_STARTUP',
-            debug_level=_DebugLevel,
-            log_events=False,
-            log_transitions=_Debug,
-            publish_events=False,
-        )
 
-    def __repr__(self):
-        return '%s_%s_%s(%s)' % (self.id, self.router_id, (self.router_connection_info or {}).get('repr', '?'), self.state)
+def to_bin_dict(idurl_dict):
+    """
+    Translates dictionary keys into binary strings if they were `ID_URL_FIELD` objects.
+    """
+    return {to_bin(k): v for k, v in idurl_dict.items()}
 
-    def to_json(self):
-        j = super().to_json()
-        j.update(
-            {
-                'proto': self.router_proto_host[0] if self.router_proto_host else '',
-                'host': net_misc.pack_address(self.router_proto_host[1]) if self.router_proto_host else '',
-                'idurl': self.router_idurl,
-                'bytes_received': self.traffic_in,
-                'bytes_sent': 0,
-                'connection_info': self.router_connection_info,
-                'idle_seconds': int(time.time() - self.latest_packet_received),
-            }
-        )
-        return j
-
-    def state_changed(self, oldstate, newstate, event, *args, **kwargs):
-        """
-        Method to catch the moment when proxy_receiver() state were changed.
-        """
-        from bitdust.transport.proxy import proxy_sender
-        proxy_sender.A('proxy_receiver.state', newstate)
-
-    def A(self, event, *args, **kwargs):
-        """
-        The core proxy_receiver() code, generated using `visio2python
-        <https://bitdust.io/visio2python/>`_ tool.
-        """
-        #---AT_STARTUP---
-        if self.state == 'AT_STARTUP':
-            if event == 'init':
-                self.state = 'OFFLINE'
-                self.doInit(*args, **kwargs)
-        #---CLOSED---
-        elif self.state == 'CLOSED':
-            pass
-        #---ACK?---
-        elif self.state == 'ACK?':
-            if event == 'ack-received':
-                self.state = 'SERVICE?'
-                self.doSendRequestService(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'stop':
-                self.state = 'OFFLINE'
-                self.doNotifyFailed(*args, **kwargs)
-            elif event == 'sending-failed':
-                self.Retries += 1
-                self.doSendMyIdentity(*args, **kwargs)
-            elif (event == 'sending-failed' and self.Retries > 3) or event == 'ack-timeout' or event == 'fail-received' or event == 'timer-15sec':
-                self.state = 'FIND_NODE?'
-                self.doLookupRandomNode(*args, **kwargs)
-        #---LISTEN---
-        elif self.state == 'LISTEN':
-            if event == 'router-id-received':
-                self.doUpdateRouterID(*args, **kwargs)
-            elif event == 'inbox-packet':
-                self.doProcessInboxPacket(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doStopListening(*args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'stop':
-                self.state = 'OFFLINE'
-                self.doSendCancelService(*args, **kwargs)
-                self.doStopListening(*args, **kwargs)
-                self.doNotifyDisconnected(*args, **kwargs)
-            elif event == 'timer-10sec':
-                self.doCheckPingRouter(*args, **kwargs)
-            elif event == 'service-refused' or event == 'router-disconnected':
-                self.state = 'FIND_NODE?'
-                self.doStopListening(*args, **kwargs)
-                self.doNotifyDisconnected(*args, **kwargs)
-                self.doLookupRandomNode(*args, **kwargs)
-        #---FIND_NODE?---
-        elif self.state == 'FIND_NODE?':
-            if event == 'found-one-node':
-                self.state = 'ACK?'
-                self.doRememberNode(*args, **kwargs)
-                self.Retries = 0
-                self.doSendMyIdentity(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'stop' or event == 'nodes-not-found' or event == 'timer-30sec':
-                self.state = 'OFFLINE'
-                self.doNotifyFailed(*args, **kwargs)
-        #---SERVICE?---
-        elif self.state == 'SERVICE?':
-            if event == 'service-accepted':
-                self.state = 'LISTEN'
-                self.doStartListening(*args, **kwargs)
-                self.doNotifyConnected(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'stop':
-                self.state = 'OFFLINE'
-                self.doSendCancelService(*args, **kwargs)
-                self.doNotifyFailed(*args, **kwargs)
-            elif event == 'request-timeout' or event == 'service-refused':
-                self.state = 'FIND_NODE?'
-                self.doLookupRandomNode(*args, **kwargs)
-        #---OFFLINE---
-        elif self.state == 'OFFLINE':
-            if event == 'start' and self.isCurrentRouterExist(*args, **kwargs):
-                self.state = 'ACK?'
-                self.doLoadRouterInfo(*args, **kwargs)
-                self.Retries = 0
-                self.doSendMyIdentity(*args, **kwargs)
-            elif event == 'start' and not self.isCurrentRouterExist(*args, **kwargs):
-                self.state = 'FIND_NODE?'
-                self.doLookupRandomNode(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-        return None
 
-    def isCurrentRouterExist(self, *args, **kwargs):
-        """
-        Condition method.
-        """
-        if not ReadCurrentRouter():
-            return False
-        if not ReadMyOriginalIdentitySource():
-            return False
-        return True
+def is_in(idurl, iterable_object, as_field=True, as_bin=False):
+    """
+    Equivalent of `idurl in iterable_object`.
+    Because it can be that you need to compare not `ID_URL_FIELD` objects in memory but normal strings.
+    So then you will prefer to avoid translating into field object.
+    """
+    if not iterable_object:
+        return False
+    if as_field:
+        return field(idurl) in fields_list(iterable_object)
+    if as_bin:
+        return to_bin(idurl) in to_bin_list(iterable_object)
+    return strng.to_text(idurl) in to_list(iterable_object, as_field=False, as_bin=False)
 
-    def doInit(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        global _PacketLogFileEnabled
-        _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
-        callback.add_queue_item_status_callback(self._on_queue_item_status_changed)
-
-    def doLoadRouterInfo(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        s = config.conf().getString('services/proxy-transport/current-router').strip()
-        try:
-            self.router_idurl = id_url.field(s.split(' ')[0])
-            self.router_id = global_id.idurl2glob(self.router_idurl)
-        except:
-            lg.exc()
+
+def is_not_in(idurl, iterable_object, as_field=True, as_bin=False):
+    """
+    Vise-versa of `is_in()` method.
+    """
+    return not is_in(idurl=idurl, iterable_object=iterable_object, as_field=as_field, as_bin=as_bin)
+
+
+def get_from_dict(idurl, dict_object, default=None, as_field=True, as_bin=False):
+    """
+    Equivalent of `{<some dict>}.get(idurl, default)`.
+    Because it can be that you need to keep not `ID_URL_FIELD` objects in your dictionary but a normal strings.
+    So then you will prefer to avoid translating into field object.
+    """
+    if as_field:
+        return dict_object.get(field(idurl), default)
+    if as_bin:
+        return dict_object.get(to_bin(idurl), default)
+    return dict_object.get(strng.to_text(idurl), default)
+
+
+def is_cached(idurl):
+    """
+    Return True if given identity was already cached - that means I know his public key.
+    """
+    global _KnownIDURLs
+    if isinstance(idurl, ID_URL_FIELD):
+        idurl = idurl.to_bin()
+    else:
+        idurl = strng.to_bin(idurl)
+    cached = idurl in _KnownIDURLs
+    if not cached:
         if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver.doLoadRouterInfo : %s' % self.router_idurl)
+            lg.args(_DebugLevel, idurl=idurl, cached=cached)
+    return cached
 
-    def doLookupRandomNode(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._find_random_node(attempts=5)
-
-    def doSendMyIdentity(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        reactor.callLater(0, self._do_send_identity_to_router, my_id.getLocalIdentity().serialize(), failed_event='fail-received')  # @UndefinedVariable
-        identity_source = config.conf().getData('services/proxy-transport/my-original-identity').strip()
-        if identity_source:
-            if _Debug:
-                lg.out(_DebugLevel, '    also sending identity loaded from "my-original-identity" config')
-            reactor.callLater(0, self._do_send_identity_to_router, identity_source, failed_event='fail-received')  # @UndefinedVariable
 
-    def doRememberNode(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self.possible_router_idurl = None
-        self.router_idurl = id_url.field(args[0])
-        self.router_id = global_id.idurl2glob(self.router_idurl)
-        self.router_identity = None
-        self.router_proto_host = None
-        if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver.doRememberNode %r' % self.router_idurl)
-
-    def doSendRequestService(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_send_request_service(args[0])
-
-    def doSendCancelService(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        newpacket = signed.Packet(
-            commands.CancelService(),
-            my_id.getIDURL(),
-            my_id.getIDURL(),
-            packetid.UniqueID(),
-            serialization.DictToBytes({
-                'name': 'service_proxy_server',
-            }),
-            self.router_idurl,
-        )
-        packet_out.create(
-            newpacket,
-            wide=True,
-            callbacks={},
-            # callbacks={
-            #     commands.Ack(): self._on_request_service_ack,
-            #     commands.Fail(): self._on_request_service_fail,
-            # },
-            response_timeout=settings.P2PTimeOut(),
-        )
-
-    def doProcessInboxPacket(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_process_inbox_packet(args[0])
-
-    def doStartListening(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        try:
-            _, info, active_router_session_machine = args[0]
-            self.router_proto_host = (info.proto, info.host)
-        except:
-            try:
-                # TODO: move that setting to separate file
-                s = config.conf().getString('services/proxy-transport/current-router').strip()
-                _, router_proto, router_host = s.split(' ')
-                self.router_proto_host = (router_proto, strng.to_bin(router_host))
-            except:
-                lg.exc()
-        self.router_identity = identitycache.FromCache(self.router_idurl)
+def is_empty(idurl):
+    """
+    Return True if given input is None, empty string or empty ID_URL_FIELD object.
+    """
+    if isinstance(idurl, ID_URL_FIELD):
+        return not bool(idurl)
+    if idurl in [None, 'None', '', b'None', b'', False]:
+        return True
+    return not bool(idurl)
+
+
+def is_some_empty(iterable_object):
+    """
+    Returns True if given iterable_object contains some empty idurl field.
+    """
+    return is_in(ID_URL_FIELD(b''), iterable_object=iterable_object, as_field=True, as_bin=False)
+
+
+def is_the_same(idurl1, idurl2):
+    """
+    Compares two ID_URL_FIELD objects or binary strings taking in account if those IDURLs are already cached.
+    """
+    idurl1 = field(idurl1)
+    idurl2 = field(idurl2)
+    if not idurl1 or not idurl2:
+        return False
+    if is_cached(idurl1) and is_cached(idurl2):
+        return idurl1 == idurl2
+    return idurl1.to_bin() == idurl2.to_bin()
+
+
+def empty_count(iterable_object):
+    """
+    Returns number of empty idurl fields or empty strings found in given `iterable_object`.
+    """
+    count = 0
+    for idurl in iterable_object:
+        if is_empty(idurl):
+            count += 1
+    return count
+
+
+def get_latest_revision(idurl):
+    """
+    Return latest known IDURL (as binary string) and revision number for given idurl field or string.
+    This info is extracted from in-memory "index" of all known identity objects.
+    """
+    global _MergedIDURLs
+    global _KnownIDURLs
+    latest_rev = -1
+    latest_idurl = b''
+    idurl_bin = to_bin(idurl)
+    if not idurl_bin:
+        return latest_idurl, latest_rev
+    if idurl_bin not in _KnownIDURLs:
+        return latest_idurl, latest_rev
+    pub_key = _KnownIDURLs[idurl_bin]
+    if pub_key not in _MergedIDURLs:
+        lg.warn('idurl %r is known but has no known revisions yet' % idurl_bin)
+        return latest_idurl, latest_rev
+    for rev, another_idurl in _MergedIDURLs[pub_key].items():
+        if rev >= latest_rev:
+            latest_idurl = another_idurl
+            latest_rev = rev
+    return latest_idurl, latest_rev
+
+
+def get_latest_ident(pub_key):
+    global _KnownUsers
+    from bitdust.userid import identity
+    user_path = _KnownUsers.get(pub_key)
+    if not user_path:
+        return None
+    user_identity_files = sorted(map(int, os.listdir(user_path)))
+    if len(user_identity_files) == 0:
+        lg.warn('identity history is broken, public key is known, but no identity files found')
+    latest_revision = -1
+    latest_ident = None
+    known_revisions = set()
+    for_cleanup = []
+    for id_file in user_identity_files:
+        identity_file_path = os.path.join(user_path, strng.to_text(id_file))
+        xmlsrc = local_fs.ReadBinaryFile(identity_file_path)
+        one_id_obj = identity.identity(xmlsrc=xmlsrc)
+        if not one_id_obj.isCorrect():
+            lg.warn('identity history is broken, identity in the file %r is not correct' % identity_file_path)
+            for_cleanup.append(identity_file_path)
+            continue
+        if not one_id_obj.Valid():
+            lg.warn('identity history is broken, identity in the file %r is not valid' % identity_file_path)
+            for_cleanup.append(identity_file_path)
+            continue
+        if pub_key != one_id_obj.getPublicKey():
+            lg.err('identity history is broken, public key not matching in the file %r' % identity_file_path)
+            for_cleanup.append(identity_file_path)
+            continue
+        known_revisions.add(one_id_obj.getRevisionValue())
+        if one_id_obj.getRevisionValue() > latest_revision:
+            latest_revision = one_id_obj.getRevisionValue()
+            latest_ident = one_id_obj
+    return latest_ident
+
+
+def list_known_idurls(idurl, num_revisions=5, include_revisions=False):
+    """
+    Return latest known revisions of given `idurl` (as binary strings) and revision numbers as a list of tuples.
+    This info is extracted from in-memory "index" of all known identity objects.
+    """
+    global _MergedIDURLs
+    global _KnownIDURLs
+    idurl_bin = to_bin(idurl)
+    if not idurl_bin:
         if _Debug:
-            lg.args(_DebugLevel, router_idurl=self.router_idurl)
-        config.conf().setString('services/proxy-transport/current-router', '%s %s %s' % (
-            strng.to_text(self.router_idurl),
-            strng.to_text(self.router_proto_host[0]),
-            strng.to_text(self.router_proto_host[1]),
-        ))
-        current_identity = my_id.getLocalIdentity().serialize(as_text=True)
-        previous_identity = ReadMyOriginalIdentitySource()
-        if previous_identity:
-            lg.err('my original identity is not empty, SKIP overwriting')
-            if _Debug:
-                lg.out(_DebugLevel, 'PREVIOUS ORIGINAL IDENTITY:\n%s\n' % previous_identity)
-        WriteMyOriginalIdentitySource(current_identity)
-        lg.info('copy of my current identity was stored as my "original" identity')
-        self.request_service_packet_id = []
-        callback.insert_inbox_callback(0, self._on_inbox_packet_received)
-        if online_status.isKnown(self.router_idurl):
-            online_status.add_online_status_listener_callback(
-                idurl=self.router_idurl,
-                callback_method=self._on_router_contact_status_connected,
-                newstate='CONNECTED',
-            )
-            online_status.add_online_status_listener_callback(
-                idurl=self.router_idurl,
-                callback_method=self._on_router_contact_status_offline,
-                newstate='OFFLINE',
-            )
-        active_router_session_machine.addStateChangedCallback(self._on_router_session_disconnected, oldstate='CONNECTED')
-        lg.info('router %s is connected at %s://%s' % (self.router_idurl, self.router_proto_host[0], self.router_proto_host[1]))
-        my_id.rebuildLocalIdentity()
-
-    def doStopListening(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        if _Debug:
-            lg.args(_DebugLevel, router_idurl=self.router_idurl)
-        if online_status.isKnown(self.router_idurl):
-            online_status.remove_online_status_listener_callback(
-                idurl=self.router_idurl,
-                callback_method=self._on_router_contact_status_connected,
-            )
-            online_status.remove_online_status_listener_callback(
-                idurl=self.router_idurl,
-                callback_method=self._on_router_contact_status_offline,
-            )
-        active_router_session_machine_index = None
-        if self.router_connection_info:
-            active_router_session_machine = None
-            active_router_session_machine_index = self.router_connection_info.get('index', None)
-            if active_router_session_machine_index is not None:
-                active_router_session_machine = automat.by_index(active_router_session_machine_index)
-            if not active_router_session_machine:
-                active_router_sessions = gateway.find_active_session(
-                    proto=self.router_connection_info.get('proto'),
-                    host=self.router_connection_info.get('host'),
-                )
-                if not active_router_sessions:
-                    active_router_sessions = gateway.find_active_session(
-                        proto=self.router_connection_info.get('proto'),
-                        idurl=id_url.to_bin(self.router_idurl),
-                    )
-                if active_router_sessions:
-                    active_router_session_machine = automat.by_index(active_router_sessions[0].index)
-            if active_router_session_machine is not None:
-                active_router_session_machine.removeStateChangedCallback(self._on_router_session_disconnected)
-                lg.info('removed callback from router active session: %r' % active_router_session_machine)
-            else:
-                lg.err('did not found active router session state machine with index %s' % active_router_session_machine_index)
-        WriteMyOriginalIdentitySource('')
-        config.conf().setString('services/proxy-transport/current-router', '')
-        callback.remove_inbox_callback(self._on_inbox_packet_received)
-        self.router_identity = None
-        self.router_idurl = None
-        self.router_id = ''
-        self.router_proto_host = None
-        self.request_service_packet_id = []
-        self.router_connection_info = None
-        my_id.rebuildLocalIdentity()
-
-    def doUpdateRouterID(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        newpacket, _ = args[0]
-        newxml = newpacket.Payload
-        newidentity = identity.identity(xmlsrc=newxml)
-        cachedidentity = identitycache.FromCache(self.router_idurl)
-        if self.router_idurl != newidentity.getIDURL():
-            lg.warn('router idurl is unrecognized from response %r != %r' % (self.router_idurl, newidentity.getIDURL()))
-            return
-        if newidentity.serialize() != cachedidentity.serialize():
-            lg.warn('cached identity is not same, router identity changed')
-        self.router_identity = newidentity
-
-    def doCheckPingRouter(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        if self.router_connection_info:
-            gateway.send_keep_alive(self.router_connection_info['proto'], self.router_connection_info['host'])
-        live_time = time.time() - self.latest_packet_received
-        if live_time < 60.0:
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_receiver.doCheckPingRouter OK, latest packet received %f sec ago' % live_time)
-            return
+            lg.args(_DebugLevel, idurl=idurl, ret=idurl_bin)
+        if include_revisions:
+            return [(idurl_bin, -1)]
+        return [idurl_bin]
+    if idurl_bin not in _KnownIDURLs:
         if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver.doCheckPingRouter to %s' % self.router_idurl)
-        identity_source = config.conf().getData('services/proxy-transport/my-original-identity').strip()
-        if identity_source:
-            if _Debug:
-                lg.out(_DebugLevel, '    "my-original-identity" prepared for sending')
+            lg.args(_DebugLevel, idurl=idurl, ret=idurl_bin)
+        if include_revisions:
+            return [(idurl_bin, -1)]
+        return [idurl_bin]
+    pub_key = _KnownIDURLs[idurl_bin]
+    if pub_key not in _MergedIDURLs:
+        lg.warn('idurl %r does not have any known revisions' % idurl_bin)
+        if include_revisions:
+            return [(idurl_bin, -1)]
+        return [idurl_bin]
+    known_revisions = sorted(_MergedIDURLs[pub_key].keys(), reverse=True)
+    results = []
+    for rev in known_revisions:
+        another_idurl = _MergedIDURLs[pub_key][rev]
+        if include_revisions:
+            if another_idurl not in [i[0] for i in results]:
+                results.append((another_idurl, rev))
         else:
-            identity_source = my_id.getLocalIdentity().serialize()
-            if _Debug:
-                lg.out(_DebugLevel, '    local identity prepared for sending')
-        self._do_send_identity_to_router(identity_source, failed_event='router-disconnected')
+            if another_idurl not in results:
+                results.append(another_idurl)
+        if len(results) >= num_revisions:
+            break
+    if _Debug:
+        lg.args(_DebugLevel, idurl=idurl, ret=results)
+    return results
 
-    def doNotifyConnected(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        proxy_interface.interface_receiving_started(self.router_idurl, {
-            'router_idurl': self.router_idurl,
-        })
-
-    def doNotifyDisconnected(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        proxy_interface.interface_disconnected().addErrback(lambda _: None)
-
-    def doNotifyFailed(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        proxy_interface.interface_receiving_failed()
-
-    def doDestroyMe(self, *args, **kwargs):
-        """
-        Remove all references to the state machine object to destroy it.
-        """
-        global _PacketLogFileEnabled
-        global _ProxyReceiver
-        _PacketLogFileEnabled = False
-        callback.remove_queue_item_status_callback(self._on_queue_item_status_changed)
-        self.possible_router_idurl = None
-        self.router_idurl = None
-        self.router_id = ''
-        self.router_identity = None
-        self.router_proto_host = None
-        self.request_service_packet_id = []
-        self.latest_packet_received = 0
-        self.router_connection_info = None
-        self.traffic_in = 0
-        self.destroy()
-        del _ProxyReceiver
-        _ProxyReceiver = None
-
-    def _do_process_inbox_packet(self, *args, **kwargs):
-        newpacket, info, _, _ = args[0]
-        block = encrypted.Unserialize(newpacket.Payload)
-        if block is None:
-            lg.err('reading data from %s' % newpacket.CreatorID)
-            return
-        try:
-            session_key = key.DecryptLocalPrivateKey(block.EncryptedSessionKey)
-            padded_data = key.DecryptWithSessionKey(session_key, block.EncryptedData, session_key_type=block.SessionKeyType)
-            inpt = BytesIO(padded_data[:int(block.Length)])
-            data = inpt.read()
-        except:
-            lg.err('reading data from %s' % newpacket.CreatorID)
-            lg.exc()
-            try:
-                inpt.close()
-            except:
-                pass
-            return
-        inpt.close()
 
-        if newpacket.Command == commands.RelayAck():
-            try:
-                ack_info = serialization.BytesToDict(data, keys_to_text=True, values_to_text=True)
-            except:
-                lg.exc()
-                return
-            if _Debug:
-                lg.out(_DebugLevel, '<<<Relay-ACK %s:%s from %s://%s with %d bytes %s' % (ack_info['command'], ack_info['packet_id'], info.proto, info.host, len(data), ack_info['error']))
-            if _PacketLogFileEnabled:
-                lg.out(
-                    0, '                \033[0;49;33mRELAY ACK %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
-                    (ack_info['command'], ack_info['packet_id'], info.bytes_received, global_id.UrlToGlobalID(ack_info['from']), global_id.UrlToGlobalID(ack_info['to']), info.transfer_id), log_name='packet', showtime=True
-                )
-            from bitdust.transport.proxy import proxy_sender
-            if proxy_sender.A():
-                proxy_sender.A('relay-ack', ack_info, info)
-            return True
+def idurl_to_id(idurl_text, by_parts=False):
+    """
+    Translates raw IDURL string (not ID_URL_FIELD) into global id short form:
+        "http://somehost.com/alice.xml" -> "alice@somehost.com"
+    """
+    if not idurl_text:
+        if by_parts:
+            return '', ''
+        return idurl_text
+    _, host, port, _, filename = nameurl.UrlParseFast(idurl_text)
+    if filename.count('.'):
+        username = filename.split('.')[0]
+    else:
+        username = filename
+    if port:
+        host = '%s_%s' % (host, port)
+    if by_parts:
+        return username, host
+    return '%s@%s' % (username, host)
 
-        if newpacket.Command == commands.RelayFail():
-            try:
-                fail_info = serialization.BytesToDict(data, keys_to_text=True, values_to_text=True)
-            except:
-                lg.exc()
-                return
-            if _Debug:
-                lg.out(_DebugLevel, '<<<Relay-FAIL %s:%s from %s://%s with %d bytes %s' % (fail_info['command'], fail_info['packet_id'], info.proto, info.host, len(data), fail_info['error']))
-            if _PacketLogFileEnabled:
-                lg.out(
-                    0, '                \033[0;49;33mRELAY FAIL %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
-                    (fail_info['command'], fail_info['packet_id'], info.bytes_received, global_id.UrlToGlobalID(fail_info['from']), global_id.UrlToGlobalID(fail_info['to']), info.transfer_id), log_name='packet', showtime=True
-                )
-            from bitdust.transport.proxy import proxy_sender
-            if proxy_sender.A():
-                proxy_sender.A('relay-failed', fail_info, info)
-            return True
-
-        routed_packet = signed.Unserialize(data)
-        if not routed_packet:
-            lg.err('unserialize packet failed from %s' % newpacket.CreatorID)
-            return
-
-        if _Debug:
-            lg.out(_DebugLevel, '<<<Relay-IN %s from %s://%s with %d bytes' % (str(routed_packet), info.proto, info.host, len(data)))
-        if _PacketLogFileEnabled:
-            lg.out(
-                0, '                \033[0;49;33mRELAY IN %s(%s) with %d bytes from %s to %s TID:%s\033[0m' %
-                (routed_packet.Command, routed_packet.PacketID, info.bytes_received, global_id.UrlToGlobalID(info.sender_idurl), global_id.UrlToGlobalID(routed_packet.RemoteID), info.transfer_id), log_name='packet', showtime=True
-            )
 
-        if routed_packet.Command == commands.Identity():
-            if _Debug:
-                lg.out(_DebugLevel, '    found identity in relay packet %s' % routed_packet)
-            newidentity = identity.identity(xmlsrc=routed_packet.Payload)
-            idurl = newidentity.getIDURL()
-            if not identitycache.HasKey(idurl):
-                lg.info('received new identity %s rev %r' % (idurl.original(), newidentity.getRevisionValue()))
-            if not identitycache.UpdateAfterChecking(idurl, routed_packet.Payload):
-                lg.warn('ERROR has non-Valid identity')
-                return
-
-        if routed_packet.Command in [
-            commands.Relay(),
-            commands.RelayIn(),
-        ] and routed_packet.PacketID.lower().startswith('identity:'):
-            if _Debug:
-                lg.out(_DebugLevel, '    found routed identity in relay packet %s' % routed_packet)
-            try:
-                routed_identity = signed.Unserialize(routed_packet.Payload)
-                newidentity = identity.identity(xmlsrc=routed_identity.Payload)
-                idurl = newidentity.getIDURL()
-                if not identitycache.HasKey(idurl):
-                    lg.warn('received new "routed" identity: %s' % idurl)
-                if not identitycache.UpdateAfterChecking(idurl, routed_identity.Payload):
-                    lg.warn('ERROR has non-Valid identity')
-                    return
-            except:
-                lg.exc()
+#------------------------------------------------------------------------------
+
+
+class ID_URL_FIELD(object):
+
+    """
+    A class represents a valid, verified and synced IDURL identifier of a device.
+    The IDURL is always corresponding to the identity file.
+
+    When your identity file is updated due to rotation to another identity server,
+    the "host" component of your IDURL is changed:
+        `http://old-server/alice.xml` will become `http://new-server.org/alice.xml`
 
-        if newpacket.Command == commands.RelayIn() and routed_packet.Command == commands.Fail():
-            if routed_packet.Payload == b'route not exist' or routed_packet.Payload == b'route already closed':
-                for pout in packet_out.search_by_packet_id(routed_packet.PacketID):
-                    lg.warn('received %r from %r, outgoing packet is failed: %r' % (routed_packet.Payload, newpacket.CreatorID, pout))
-                    pout.automat('request-failed')
-                return
-
-        self.traffic_in += len(data)
-        packet_in.process(routed_packet, info)
-        del block
-        del data
-        del padded_data
-        del inpt
-        del session_key
-        del routed_packet
+    The IDURL can also be presented in a shorter form, which is also called global user ID, so:
+        `alice@old-server.com` will become `alice@new-server.org`
 
-    def _do_send_identity_to_router(self, identity_source, failed_event):
+    All that is handled automatically and your instance of `ID_URL_FIELD` will receive updated info automatically.
+    When incoming identity files are first received, processed and cached your `ID_URL_FIELD` variable is
+    automatically synchornized using `ID_URL_FIELD.refresh()` method.
+
+    This is why you can always trust and be able to compare two user IDs and verify recipient/sender identity.
+    """
+
+    def __init__(self, idurl):
+        self.current = b''
+        self.current_as_string = ''
+        self.current_id = ''
+        self.latest = b''
+        self.latest_as_string = ''
+        self.latest_id = ''
+        self.latest_revision = -1
+        self._unique_name = ''
+        if isinstance(idurl, ID_URL_FIELD):
+            self.current = idurl.current
+        else:
+            if idurl in [None, 'None', '', b'None', b'', False]:
+                self.current = b''
+            else:
+                self.current = strng.to_bin(idurl.strip())
+        self.current_as_string = strng.to_text(self.current)
+        username, current_host = idurl_to_id(self.current, by_parts=True)
+        self.username = username
+        self.current_host = current_host
+        self.current_id = '%s@%s' % (self.username, self.current_host)
+        self.latest, self.latest_revision = get_latest_revision(self.current)
+        if not self.latest:
+            self.latest = self.current
+            self.latest_revision = -1
+        self.latest_as_string = strng.to_text(self.latest)
+        latest_username, latest_host = idurl_to_id(self.latest, by_parts=True)
+        if latest_username != self.username:
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method == 'field':
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            exc = ValueError('tried to modify username of the identity %r -> %r' % (self.current, self.latest))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+        self.latest_host = latest_host
+        self.latest_id = '%s@%s' % (self.username, self.latest_host)
+        if _Debug:
+            lg.out(_DebugLevel*2, 'NEW ID_URL_FIELD(%r) with id=%r latest=%r' % (self.current, id(self), self.latest))
+
+    def __del__(self):
         try:
-            identity_obj = identity.identity(xmlsrc=identity_source)
+            if _Debug:
+                lg.out(_DebugLevel*2, 'DELETED ID_URL_FIELD(%r) with id=%r latest=%r' % (self.current, id(self), self.latest))
         except:
             lg.exc()
-            return
+
+    def __eq__(self, idurl):
+        # always check type : must be `ID_URL_FIELD`
+        if not isinstance(idurl, ID_URL_FIELD):
+            # to be able to compare with empty value lets make an exception
+            if idurl in [None, 'None', '', b'None', b'', False]:
+                return not bool(self.latest)
+            # in other cases must raise an exception
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda'):
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            exc = TypeError('tried to compare ID_URL_FIELD(%r) with %r of type %r' % (self.latest_as_string, idurl, type(idurl)))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+
+        # could be empty field also
+        if not idurl:
+            return not bool(self.latest)
+
+        # check if we know both sources
+        my_pub_key = self.to_public_key(raise_error=False)
+        other_pub_key = idurl.to_public_key(raise_error=False)
+        if my_pub_key is None or other_pub_key is None:
+            # if we do not know some of the sources - so can't be sure
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method.startswith('_'):
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            if my_pub_key is None:
+                exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
+            else:
+                exc = KeyError('unknown idurl %r in %s.%s' % (idurl.current, caller_modul, caller_method))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+
+        # now compare based on public key
+        result = (other_pub_key == my_pub_key)
         if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver._do_send_identity_to_router to %s' % self.router_idurl)
-            lg.out(_DebugLevel, '        contacts=%r, sources=%r' % (identity_obj.contacts, identity_obj.getSources(as_originals=True)))
-        newpacket = signed.Packet(
-            Command=commands.Identity(),
-            OwnerID=my_id.getIDURL(),
-            CreatorID=my_id.getIDURL(),
-            PacketID=('proxy_receiver:%s' % packetid.UniqueID()),
-            Payload=identity_obj.serialize(),
-            RemoteID=self.router_idurl,
-        )
-        packet_out.create(
-            newpacket,
-            wide=True,
-            callbacks={
-                commands.Ack(): lambda response, info: self.automat('ack-received', (response, info)),
-                commands.Fail(): lambda x: self.automat(failed_event),
-                None: lambda pkt_out: self.automat('ack-timeout', pkt_out),
-                'failed': lambda pkt_out, error_message: self.automat('sending-failed', (pkt_out, error_message)),
-            },
-            keep_alive=True,
-            response_timeout=settings.P2PTimeOut(),
-        )
+            lg.args(_DebugLevel*2, idurl=idurl, current=self.current, latest=self.latest, result=result)
+        return result
 
-    def _do_send_request_service(self, *args, **kwargs):
-        if len(self.request_service_packet_id) >= 10:
-            if _Debug:
-                lg.warn('too many service requests to %r' % self.router_idurl)
-            self.automat('service-refused', *args, **kwargs)
-            return
-        orig_identity = config.conf().getData('services/proxy-transport/my-original-identity').strip()
-        if not orig_identity:
-            orig_identity = my_id.getLocalIdentity().serialize(as_text=True)
-        service_info = {
-            'name': 'service_proxy_server',
-            'payload': {
-                'identity': orig_identity,
-            },
-        }
-        newpacket = signed.Packet(
-            commands.RequestService(),
-            my_id.getIDURL(),
-            my_id.getIDURL(),
-            packetid.UniqueID(),
-            serialization.DictToBytes(service_info, values_to_text=True),
-            self.router_idurl,
-        )
-        packet_out.create(
-            newpacket,
-            wide=False,
-            callbacks={
-                commands.Ack(): self._on_request_service_ack,
-                commands.Fail(): self._on_request_service_fail,
-                # 'timeout': lambda pkt_out, err: self.automat('request-timeout', pkt_out),
-                None: lambda pkt_out: self.automat('request-timeout', pkt_out),
-            },
-            response_timeout=settings.P2PTimeOut(),
-        )
-        self.request_service_packet_id.append(newpacket.PacketID)
-
-    def _on_nodes_lookup_finished(self, idurls, attempts):
-        if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver._on_nodes_lookup_finished : %r' % idurls)
-        for idurl in idurls:
-            ident = identitycache.FromCache(idurl)
-            remoteprotos = set(ident.getProtoOrder())
-            myprotos = set(my_id.getLocalIdentity().getProtoOrder())
-            if len(myprotos.intersection(remoteprotos)) > 0:
-                self.possible_router_idurl = id_url.field(idurl)
-                if _Debug:
-                    lg.out(_DebugLevel, 'proxy_receiver._on_nodes_lookup_finished found : %r' % self.possible_router_idurl)
-                self.automat('found-one-node', self.possible_router_idurl)
-                return
-        if attempts > 0:
-            self._find_random_node(attempts - 1)
-        else:
-            self.automat('nodes-not-found')
+    def __ne__(self, idurl):
+        # always check type : must be `ID_URL_FIELD`
+        if not isinstance(idurl, ID_URL_FIELD):
+            # to be able to compare with empty value lets make an exception
+            if idurl in [None, 'None', '', b'None', b'', False]:
+                return bool(self.latest)
+            # in other cases must raise an exception
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method.startswith('_'):
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            exc = TypeError('tried to compare ID_URL_FIELD(%r) with %r of type %r' % (self.latest_as_string, idurl, type(idurl)))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+
+        # could be empty field also
+        if not idurl:
+            return bool(self.latest)
+
+        # check if we know both sources
+        my_pub_key = self.to_public_key(raise_error=True)
+        other_pub_key = idurl.to_public_key(raise_error=True)
+        if my_pub_key is None or other_pub_key is None:
+            # if we do not know some of the sources - so can't be sure
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method.startswith('_'):
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            if my_pub_key is None:
+                exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
+            else:
+                exc = KeyError('unknown idurl %r in %s.%s' % (idurl.current, caller_modul, caller_method))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
 
-    def _find_random_node(self, attempts):
-        preferred_routers = []
-        preferred_routers_raw = config.conf().getData('services/proxy-transport/preferred-routers').strip()
-        if preferred_routers_raw:
-            preferred_routers_list = re.split('\n|,|;| ', preferred_routers_raw)
-            preferred_routers.extend(preferred_routers_list)
-        if preferred_routers:
-            self.possible_router_idurl = id_url.field(random.choice(preferred_routers))
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_receiver._find_random_node selected random item from preferred_routers: %r' % self.possible_router_idurl)
-            idcache_defer = identitycache.immediatelyCaching(self.possible_router_idurl)
-            idcache_defer.addCallback(lambda *args: self.automat('found-one-node', self.possible_router_idurl))
-            idcache_defer.addErrback(lambda err: self.automat('nodes-not-found') and None)
-            return
-        if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver._find_random_node will start DHT lookup')
-        tsk = lookup.random_proxy_router()
-        if tsk:
-            tsk.result_defer.addCallback(self._on_nodes_lookup_finished, attempts=attempts)
-            tsk.result_defer.addErrback(lambda err: self.automat('nodes-not-found'))
-        else:
-            self.automat('nodes-not-found')
+        # now compare based on public key
+        result = (other_pub_key != my_pub_key)
+        if _Debug:
+            lg.args(_DebugLevel*2, idurl=idurl, current=self.current, latest=self.latest, result=result)
+        return result
 
-    def _on_request_service_ack(self, response, info):
-        self.router_connection_info = None
-        if response.PacketID not in self.request_service_packet_id:
-            lg.warn('wrong PacketID in response: %s, but outgoing was : %s' % (response.PacketID, str(self.request_service_packet_id)))
-            self.automat('service-refused', (response, info))
-            return
-        if response.PacketID in self.request_service_packet_id:
-            self.request_service_packet_id.remove(response.PacketID)
-        else:
-            lg.warn('%s was not found in pending requests: %s' % (response.PacketID, self.request_service_packet_id))
+    def __hash__(self):
+        # this trick should make `idurl in some_dictionary` work correctly
+        # if idurl1 and idurl2 are different sources of same identity they both must be matching
+        # so it must never happen like that: (idurl1 in some_dictionary) and (idurl2 in some_dictionary)
+        # same check you can do in a different way: `id_url.is_in(idurl, some_dictionary)`
+        pub_key = self.to_public_key()
+        hsh = pub_key.__hash__()
         if _Debug:
-            lg.out(_DebugLevel, 'proxy_receiver._on_request_service_ack : %s' % str(response.Payload))
-        if self.router_idurl != response.CreatorID:
-            lg.err('received unexpected response from another node: %r ~ %r' % (self.router_idurl, response.CreatorID))
-            self.automat('service-refused', (response, info))
-            return
-        service_ack_info = strng.to_text(response.Payload)
-        if service_ack_info.startswith('rejected'):
-            self.automat('service-refused', (response, info))
-            return
-        active_router_sessions = gateway.find_active_session(info.proto, host=info.host)
-        if not active_router_sessions:
-            active_router_sessions = gateway.find_active_session(info.proto, idurl=id_url.to_bin(response.CreatorID))
-        if not active_router_sessions:
-            lg.err('active connection with proxy router at %s:%s was not found' % (info.proto, info.host))
-            if _Debug:
-                lg.args(_DebugLevel, router_idurl=self.router_idurl, ack_packet=info, active_sessions=gateway.list_active_sessions(info.proto))
-            self.automat('service-refused', (response, info))
-            return
-        self.router_connection_info = {
-            'id': active_router_sessions[0].id,
-            'index': active_router_sessions[0].index,
-            'repr': repr(active_router_sessions[0]),
-            'proto': info.proto,
-            'host': info.host,
-            'idurl': self.router_idurl,
-            'global_id': global_id.UrlToGlobalID(self.router_idurl),
-        }
-        active_router_session_machine = automat.by_index(self.router_connection_info['index'])
-        if active_router_session_machine is None:
-            lg.err('did not found proxy router session state machine instance: %s' % self.router_connection_info)
-            self.router_connection_info = None
-            if _Debug:
-                lg.args(_DebugLevel, automats=automat.objects())
-            self.automat('service-refused', (response, info))
-            return
-        lg.info('found active session for proxy router: %s' % active_router_session_machine)
-        self.automat('service-accepted', (response, info, active_router_session_machine))
-
-    def _on_request_service_fail(self, response, info):
-        if response.PacketID not in self.request_service_packet_id:
-            lg.warn('wrong PacketID in response: %s, but outgoing was : %s' % (response.PacketID, str(self.request_service_packet_id)))
-        else:
-            self.request_service_packet_id.remove(response.PacketID)
-        self.automat('service-refused', (response, info))
+            lg.args(_DebugLevel*2, current=self.current, latest=self.latest, hash=hsh)
+        return hsh
 
-    def _on_inbox_packet_received(self, newpacket, info, status, error_message):
-        if newpacket.Command == commands.Identity() and \
-                newpacket.CreatorID == self.router_idurl and \
-                newpacket.RemoteID == my_id.getIDURL():
-            self.automat('router-id-received', (newpacket, info))
-            self.latest_packet_received = time.time()
-            return True
-        if newpacket.CreatorID == self.router_idurl:
-            self.latest_packet_received = time.time()
-        if newpacket.Command in [
-            commands.Relay(),
-            commands.RelayIn(),
-            commands.RelayAck(),
-            commands.RelayFail(),
-        ]:
-            if driver.is_enabled('service_proxy_server'):
-                # TODO:
-                # in case this node already running proxy router service this will not work
-                # actually you can not use proxy transport for receiving and running proxy router at same time
-                # need to change one of the services to solve that dependency and prevent this
-                return False
-            self.automat('inbox-packet', (newpacket, info, status, error_message))
-            return True
-        return False
+    def __repr__(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest_as_string=self.latest_as_string)
+        return '{%s%s}' % ('' if self.is_latest() else '*', self.latest_as_string)
 
-    def _on_router_contact_status_connected(self, oldstate, newstate, event_string, *args, **kwargs):
-        lg.info('router %r contact status online: %s->%s after "%s"' % (self.router_idurl, oldstate, newstate, event_string))
+    def __str__(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest_as_string=self.latest_as_string)
+        return self.latest_as_string
 
-    def _on_router_contact_status_offline(self, oldstate, newstate, event_string, *args, **kwargs):
-        lg.warn('router %r contact status offline: %s->%s after "%s"' % (self.router_idurl, oldstate, newstate, event_string))
-        # self.automat('router-disconnected')
-
-    def _on_router_session_disconnected(self, oldstate, newstate, event_string, *args, **kwargs):
-        lg.err('router session disconnected: %s->%s because of %r' % (oldstate, newstate, event_string))
-        self.automat('router-disconnected')
-
-    def _on_queue_item_status_changed(self, pkt_out, status, error=''):
-        from bitdust.transport.proxy import proxy_receiver
-        if status == 'finished':
-            return False
-        if error != 'connection failed':
-            return False
-        if not pkt_out.remote_idurl or not pkt_out.outpacket:
-            return False
-        if id_url.to_bin(pkt_out.remote_idurl) == pkt_out.outpacket.RemoteID.to_bin():
-            return False
-        if not proxy_receiver.GetRouterIDURL():
-            return False
-        if pkt_out.remote_idurl != proxy_receiver.GetRouterIDURL():
+    def __bytes__(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest)
+        return self.latest
+
+    def __bool__(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest)
+        return bool(self.latest)
+
+    def __len__(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest)
+        return len(self.latest)
+
+    def refresh(self, replace_original=True):
+        _latest, _latest_revision = get_latest_revision(self.current)
+        if self.latest and self.latest == _latest:
+            if _Debug:
+                lg.args(_DebugLevel, latest=self.latest_as_string, refreshed=False)
             return False
-        lg.err('connection failed with current proxy router, must reconnect to another router: %r %r %r' % (pkt_out, status, error))
-        self.automat('router-disconnected')
+        self.latest = _latest
+        self.latest_revision = _latest_revision
+        if not self.latest:
+            self.latest = self.current
+            self.latest_revision = -1
+        self.latest_as_string = strng.to_text(self.latest)
+        latest_username, latest_host = idurl_to_id(self.latest, by_parts=True)
+        if latest_username != self.username:
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method == 'field':
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            exc = ValueError('while refreshing tried to modify username of the identity %r -> %r' % (self.current, self.latest))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+        self.latest_host = latest_host
+        self.latest_id = '%s@%s' % (self.username, self.latest_host)
+        if replace_original:
+            self.current = self.latest
+            self.current_as_string = self.latest_as_string
+            self.current_id = self.latest_id
+        if _Debug:
+            lg.args(_DebugLevel, latest=self.latest_as_string, current=self.current_as_string, refreshed=True)
         return True
 
+    def strip(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest_as_string)
+        return self.latest
+
+    def original(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
+        return self.current
 
-#------------------------------------------------------------------------------
+    def original_id(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, current=self.current_id, latest=self.latest_id)
+        return self.current_id
 
+    def is_latest(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
+        return self.latest and self.current == self.latest
 
-def main():
-    from twisted.internet import reactor  # @UnresolvedImport
-    reactor.callWhenRunning(A, 'init')  # @UndefinedVariable
-    reactor.run()  # @UndefinedVariable
+    def to_id(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest_id=self.latest_id)
+        return self.latest_id
 
+    def to_text(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest_as_string)
+        return self.latest_as_string
 
-if __name__ == '__main__':
-    main()
+    def to_bin(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest)
+        return self.latest
+
+    def to_original(self):
+        if _Debug:
+            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
+        return self.current
+
+    def to_public_key(self, raise_error=True):
+        global _KnownIDURLs
+        if _Debug:
+            lg.args(_DebugLevel*2, latest=self.latest, current=self.current)
+        if not self.current:
+            return b''
+        if self.current not in _KnownIDURLs:
+            if not raise_error:
+                return None
+            caller_code = sys._getframe().f_back.f_code
+            caller_method = caller_code.co_name
+            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
+            if caller_method.count('lambda') or caller_method.startswith('_'):
+                caller_method = sys._getframe(1).f_back.f_code.co_name
+            exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
+            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
+            raise exc
+        pub_key = _KnownIDURLs[self.current]
+        return pub_key
+
+    def unique_name(self, raise_error=True):
+        if not self._unique_name:
+            self._unique_name = '{}_{}'.format(
+                self.username,
+                strng.to_text(hashes.sha1(self.to_public_key(raise_error=raise_error), hexdigest=True)),
+            )
+        return self._unique_name
```

### Comparing `bitdust-0.1.8.234/bitdust/transport/proxy/proxy_router.py` & `bitdust-0.1.9.241/bitdust/transport/proxy/proxy_router.py`

 * *Files 0% similar despite different names*

```diff
@@ -1296,15 +1296,15 @@
                 if _Debug:
                     lg.out(_DebugLevel, '        found %s in identity : %s' % (my_contact, ident.getIDURL()))
                 return True
         return False
 
     def _load_routes(self):
         # TODO: move services/proxy-server/current-routes out from settings into a separate file
-        src = config.conf().getData('services/proxy-server/current-routes')
+        src = config.conf().getString('services/proxy-server/current-routes')
         if src is None:
             lg.warn('setting [services/proxy-server/current-routes] not exist')
             return
         try:
             dct = serialization.BytesToDict(strng.to_bin(src), keys_to_text=True, values_to_text=True)
         except:
             dct = {}
@@ -1319,44 +1319,44 @@
                 if _Debug:
                     lg.out(_DebugLevel, '        skip overriding %s' % k)
         if _Debug:
             lg.out(_DebugLevel, 'proxy_router._load_routes %d routes total' % len(self.routes))
 
     def _clear_routes(self):
         # TODO: move services/proxy-server/current-routes out from settings into a separate file
-        config.conf().setData('services/proxy-server/current-routes', '{}')
+        config.conf().setString('services/proxy-server/current-routes', '{}')
         if _Debug:
             lg.out(_DebugLevel, 'proxy_router._clear_routes')
 
     def _write_route(self, user_idurl):
         # TODO: move services/proxy-server/current-routes out from settings into a separate file
-        src = config.conf().getData('services/proxy-server/current-routes')
+        src = config.conf().getString('services/proxy-server/current-routes')
         try:
             dct = serialization.BytesToDict(strng.to_bin(src), keys_to_text=True, values_to_text=True)
         except:
             dct = {}
         user_idurl_txt = strng.to_text(id_url.field(user_idurl).original())
         dct[user_idurl_txt] = self.routes[id_url.field(user_idurl).original()]
         newsrc = strng.to_text(serialization.DictToBytes(dct, keys_to_text=True, values_to_text=True))
-        config.conf().setData('services/proxy-server/current-routes', newsrc)
+        config.conf().setString('services/proxy-server/current-routes', newsrc)
         if _Debug:
             lg.out(_DebugLevel, 'proxy_router._write_route %d bytes wrote' % len(newsrc))
 
     def _remove_route(self, user_idurl):
         # TODO: move services/proxy-server/current-routes out from settings into a separate file
-        src = config.conf().getData('services/proxy-server/current-routes')
+        src = config.conf().getString('services/proxy-server/current-routes')
         try:
             dct = serialization.BytesToDict(strng.to_bin(src), keys_to_text=True, values_to_text=True)
         except:
             dct = {}
         user_idurl_txt = strng.to_text(id_url.field(user_idurl).original())
         if user_idurl_txt in dct:
             dct.pop(user_idurl_txt)
             newsrc = strng.to_text(serialization.DictToBytes(dct, keys_to_text=True, values_to_text=True))
-            config.conf().setData('services/proxy-server/current-routes', newsrc)
+            config.conf().setString('services/proxy-server/current-routes', newsrc)
             if _Debug:
                 lg.out(_DebugLevel, 'proxy_router._remove_route %d bytes wrote' % len(newsrc))
 
 
 #------------------------------------------------------------------------------
```

### Comparing `bitdust-0.1.8.234/bitdust/transport/proxy/proxy_sender.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/indexcreator.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,588 +1,649 @@
 #!/usr/bin/env python
-# proxy_sender.py
+# -*- coding: utf-8 -*-
 #
-# Copyright (C) 2008 Veselin Penev, https://bitdust.io
+# Copyright 2011-2013 Codernity (http://codernity.com)
 #
-# This file (proxy_sender.py) is part of BitDust Software.
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
 #
-# BitDust is free software: you can redistribute it and/or modify
-# it under the terms of the GNU Affero General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
+#     http://www.apache.org/licenses/LICENSE-2.0
 #
-# BitDust Software is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU Affero General Public License for more details.
-#
-# You should have received a copy of the GNU Affero General Public License
-# along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
-#
-# Please contact us if you have any questions at bitdust.io@gmail.com
-"""
-.. module:: proxy_sender.
-
-.. role:: red
-
-BitDust proxy_sender() Automat
-
-.. raw:: html
-
-    <a href="proxy_sender.png" target="_blank">
-    <img src="proxy_sender.png" style="max-width:100%;">
-    </a>
-
-EVENTS:
-    * :red:`init`
-    * :red:`proxy_receiver.state`
-    * :red:`relay-ack`
-    * :red:`relay-failed`
-    * :red:`relay-out`
-    * :red:`retry`
-    * :red:`retry-cache-failed`
-    * :red:`retry-failed`
-    * :red:`retry-send-failed`
-    * :red:`shutdown`
-    * :red:`start`
-    * :red:`stop`
-"""
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
 
-#------------------------------------------------------------------------------
 
 from __future__ import absolute_import
+import re
+import tokenize
+import token
+import uuid
+from six.moves import range
+
+
+class IndexCreatorException(Exception):
+
+    def __init__(self, ex, line=None):
+        self.ex = ex
+        self.line = line
+
+    def __str__(self):
+        if self.line:
+            return repr(self.ex + "(in line: %d)" % self.line)
+        return repr(self.ex)
+
+
+class IndexCreatorFunctionException(IndexCreatorException):
+    pass
+
+
+class IndexCreatorValueException(IndexCreatorException):
+    pass
+
+
+class Parser(object):
+
+    def __init__(self):
+        pass
+
+    def parse(self, data, name=None):
+        if not name:
+            self.name = "_" + uuid.uuid4().hex
+        else:
+            self.name = name
+
+        self.ind = 0
+        self.stage = 0
+        self.logic = ['and', 'or', 'in']
+        self.logic2 = ['&', '|']
+        self.allowed_props = {'TreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format'],
+                              'HashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
+                              'MultiHashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
+                              'MultiTreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format']
+                              }
+        self.funcs = {'md5': (['md5'], ['.digest()']),
+                      'len': (['len'], []),
+                      'str': (['str'], []),
+                      'fix_r': (['self.fix_r'], []),
+                      'prefix': (['self.prefix'], []),
+                      'infix': (['self.infix'], []),
+                      'suffix': (['self.suffix'], [])
+                      }
+        self.handle_int_imports = {'infix': "from itertools import izip\n"}
+
+        self.funcs_with_body = {'fix_r':
+                                ("""    def fix_r(self,s,l):
+        e = len(s)
+        if e == l:
+            return s
+        elif e > l:
+            return s[:l]
+        else:
+            return s.rjust(l,'_')\n""", False),
+                                'prefix':
+                                ("""    def prefix(self,s,m,l,f):
+        t = len(s)
+        if m < 1:
+            m = 1
+        o = set()
+        if t > l:
+            s = s[:l]
+            t = l
+        while m <= t:
+            o.add(s.rjust(f,'_'))
+            s = s[:-1]
+            t -= 1
+        return o\n""", False),
+                                'suffix':
+                                ("""    def suffix(self,s,m,l,f):
+        t = len(s)
+        if m < 1:
+            m = 1
+        o = set()
+        if t > l:
+            s = s[t-l:]
+            t = len(s)
+        while m <= t:
+            o.add(s.rjust(f,'_'))
+            s = s[1:]
+            t -= 1
+        return o\n""", False),
+                                'infix':
+                                ("""    def infix(self,s,m,l,f):
+        t = len(s)
+        o = set()
+        for x in xrange(m - 1, l):
+            t = (s, )
+            for y in xrange(0, x):
+                t += (s[y + 1:],)
+            o.update(set(''.join(x).rjust(f, '_').lower() for x in izip(*t)))
+        return o\n""", False)}
+        self.none = ['None', 'none', 'null']
+        self.props_assign = ['=', ':']
+        self.all_adj_num_comp = {token.NUMBER: (
+            token.NUMBER, token.NAME, '-', '('),
+            token.NAME: (token.NUMBER, token.NAME, '-', '('),
+            ')': (token.NUMBER, token.NAME, '-', '(')
+        }
 
-#------------------------------------------------------------------------------
-
-_Debug = False
-_DebugLevel = 16
+        self.all_adj_num_op = {token.NUMBER: (token.NUMBER, token.NAME, '('),
+                               token.NAME: (token.NUMBER, token.NAME, '('),
+                               ')': (token.NUMBER, token.NAME, '(')
+                               }
+        self.allowed_adjacent = {
+            "<=": self.all_adj_num_comp,
+            ">=": self.all_adj_num_comp,
+            ">": self.all_adj_num_comp,
+            "<": self.all_adj_num_comp,
+
+            "==": {token.NUMBER: (token.NUMBER, token.NAME, '('),
+                   token.NAME: (token.NUMBER, token.NAME, token.STRING, '('),
+                   token.STRING: (token.NAME, token.STRING, '('),
+                   ')': (token.NUMBER, token.NAME, token.STRING, '('),
+                   ']': (token.NUMBER, token.NAME, token.STRING, '(')
+                   },
+
+            "+": {token.NUMBER: (token.NUMBER, token.NAME, '('),
+                  token.NAME: (token.NUMBER, token.NAME, token.STRING, '('),
+                  token.STRING: (token.NAME, token.STRING, '('),
+                  ')': (token.NUMBER, token.NAME, token.STRING, '('),
+                  ']': (token.NUMBER, token.NAME, token.STRING, '(')
+                  },
+
+            "-": {token.NUMBER: (token.NUMBER, token.NAME, '('),
+                  token.NAME: (token.NUMBER, token.NAME, '('),
+                  ')': (token.NUMBER, token.NAME, '('),
+                  '<': (token.NUMBER, token.NAME, '('),
+                  '>': (token.NUMBER, token.NAME, '('),
+                  '<=': (token.NUMBER, token.NAME, '('),
+                  '>=': (token.NUMBER, token.NAME, '('),
+                  '==': (token.NUMBER, token.NAME, '('),
+                  ']': (token.NUMBER, token.NAME, '(')
+                  },
+            "*": self.all_adj_num_op,
+            "/": self.all_adj_num_op,
+            "%": self.all_adj_num_op,
+            ",": {token.NUMBER: (token.NUMBER, token.NAME, token.STRING, '{', '[', '('),
+                  token.NAME: (token.NUMBER, token.NAME, token.STRING, '(', '{', '['),
+                  token.STRING: (token.NAME, token.STRING, token.NUMBER, '(', '{', '['),
+                  ')': (token.NUMBER, token.NAME, token.STRING, '(', '{', '['),
+                  ']': (token.NUMBER, token.NAME, token.STRING, '(', '{', '['),
+                  '}': (token.NUMBER, token.NAME, token.STRING, '(', '{', '[')
+                  }
+        }
 
-_PacketLogFileEnabled = False
+        def is_num(s):
+            m = re.search('[^0-9*()+\-\s/]+', s)
+            return not m
+
+        def is_string(s):
+            m = re.search('\s*(?P<a>[\'\"]+).*?(?P=a)\s*', s)
+            return m
+        data = re.split('make_key_value\:', data)
+
+        if len(data) < 2:
+            raise IndexCreatorFunctionException(
+                "Couldn't find a definition of make_key_value function!\n")
+
+        spl1 = re.split('make_key\:', data[0])
+        spl2 = re.split('make_key\:', data[1])
+
+        self.funcs_rev = False
+
+        if len(spl1) > 1:
+            data = [spl1[0]] + [data[1]] + [spl1[1]]
+            self.funcs_rev = True
+        elif len(spl2) > 1:
+            data = [data[0]] + spl2
+        else:
+            data.append("key")
+
+        if data[1] == re.search('\s*', data[1], re.S | re.M).group(0):  # @UndefinedVariable
+            raise IndexCreatorFunctionException("Empty function body ",
+                                                len(re.split('\n', data[0])) + (len(re.split('\n', data[2])) if self.funcs_rev else 1) - 1)
+        if data[2] == re.search('\s*', data[2], re.S | re.M).group(0):  # @UndefinedVariable
+            raise IndexCreatorFunctionException("Empty function body ",
+                                                len(re.split('\n', data[0])) + (1 if self.funcs_rev else len(re.split('\n', data[1]))) - 1)
+        if data[0] == re.search('\s*', data[0], re.S | re.M).group(0):  # @UndefinedVariable
+            raise IndexCreatorValueException("You didn't set any properity or you set them not at the begining of the code\n")
+
+        data = [re.split(
+            '\n', data[0]), re.split('\n', data[1]), re.split('\n', data[2])]
+        self.cnt_lines = (len(data[0]), len(data[1]), len(data[2]))
+        ind = 0
+        self.predata = data
+        self.data = [[], [], []]
+        for i, v in enumerate(self.predata[0]):
+            for k, w in enumerate(self.predata[0][i]):
+                if self.predata[0][i][k] in self.props_assign:
+                    if not is_num(self.predata[0][i][k + 1:]) and self.predata[0][i].strip()[:4] != 'type' and self.predata[0][i].strip()[:4] != 'name':
+                        s = self.predata[0][i][k + 1:]
+                        self.predata[0][i] = self.predata[0][i][:k + 1]
+
+                        m = re.search('\s+', s.strip())
+                        if not is_string(s) and not m:
+                            s = "'" + s.strip() + "'"
+                        self.predata[0][i] += s
+                        break
+
+        for n, i in enumerate(self.predata):
+            for k in i:
+                k = k.strip()
+                if k:
+                    self.data[ind].append(k)
+                    self.check_enclosures(k, n)
+            ind += 1
+
+        return self.parse_ex()
+
+    def readline(self, stage):
+        def foo():
+            if len(self.data[stage]) <= self.ind:
+                self.ind = 0
+                return ""
+            else:
+                self.ind += 1
+                return self.data[stage][self.ind - 1]
+        return foo
+
+    def add(self, l, i):
+        def add_aux(*args):
+            # print args,self.ind
+            if len(l[i]) < self.ind:
+                l[i].append([])
+            l[i][self.ind - 1].append(args)
+        return add_aux
+
+    def parse_ex(self):
+        self.index_name = ""
+        self.index_type = ""
+        self.curLine = -1
+        self.con = -1
+        self.brackets = -1
+        self.curFunc = None
+        self.colons = 0
+        self.line_cons = ([], [], [])
+        self.pre_tokens = ([], [], [])
+        self.known_dicts_in_mkv = []
+        self.prop_name = True
+        self.prop_assign = False
+        self.is_one_arg_enough = False
+        self.funcs_stack = []
+        self.last_line = [-1, -1, -1]
+        self.props_set = []
+        self.custom_header = set()
+
+        self.tokens = []
+        self.tokens_head = ['# %s\n' % self.name, 'class %s(' % self.name, '):\n', '    def __init__(self, *args, **kwargs):        ']
+
+        for i in range(3):
+            tokenize.tokenize(self.readline(i), self.add(self.pre_tokens, i))
+            # tokenize treats some keyword not in the right way, thats why we
+            # have to change some of them
+            for nk, k in enumerate(self.pre_tokens[i]):
+                for na, a in enumerate(k):
+                    if a[0] == token.NAME and a[1] in self.logic:
+                        self.pre_tokens[i][nk][
+                            na] = (token.OP, a[1], a[2], a[3], a[4])
+
+        for i in self.pre_tokens[1]:
+            self.line_cons[1].append(self.check_colons(i, 1))
+            self.check_adjacents(i, 1)
+            if self.check_for_2nd_arg(i) == -1 and not self.is_one_arg_enough:
+                raise IndexCreatorValueException("No 2nd value to return (did u forget about ',None'?", self.cnt_line_nr(i[0][4], 1))
+            self.is_one_arg_enough = False
+
+        for i in self.pre_tokens[2]:
+            self.line_cons[2].append(self.check_colons(i, 2))
+            self.check_adjacents(i, 2)
+
+        for i in self.pre_tokens[0]:
+            self.handle_prop_line(i)
+
+        self.cur_brackets = 0
+        self.tokens += ['\n        super(%s, self).__init__(*args, **kwargs)\n    def make_key_value(self, data):        ' % self.name]
+
+        for i in self.pre_tokens[1]:
+            for k in i:
+                self.handle_make_value(*k)
+
+        self.curLine = -1
+        self.con = -1
+        self.cur_brackets = 0
+        self.tokens += ['\n    def make_key(self, key):']
+
+        for i in self.pre_tokens[2]:
+            for k in i:
+                self.handle_make_key(*k)
+
+        if self.index_type == "":
+            raise IndexCreatorValueException("Missing index type definition\n")
+        if self.index_name == "":
+            raise IndexCreatorValueException("Missing index name\n")
+
+        self.tokens_head[0] = "# " + self.index_name + "\n" + \
+            self.tokens_head[0]
+
+        for i in self.funcs_with_body:
+            if self.funcs_with_body[i][1]:
+                self.tokens_head.insert(4, self.funcs_with_body[i][0])
+
+        if None in self.custom_header:
+            self.custom_header.remove(None)
+        if self.custom_header:
+            s = '    custom_header = """'
+            for i in self.custom_header:
+                s += i
+            s += '"""\n'
+            self.tokens_head.insert(4, s)
+
+        if self.index_type in self.allowed_props:
+            for i in self.props_set:
+                if i not in self.allowed_props[self.index_type]:
+                    raise IndexCreatorValueException("Properity %s is not allowed for index type: %s" % (i, self.index_type))
+
+        # print "".join(self.tokens_head)
+        # print "----------"
+        # print (" ".join(self.tokens))
+        return "".join(self.custom_header), "".join(self.tokens_head) + (" ".join(self.tokens))
+
+    # has to be run BEFORE tokenize
+    def check_enclosures(self, d, st):
+        encs = []
+        contr = {'(': ')', '{': '}', '[': ']', "'": "'", '"': '"'}
+        ends = [')', '}', ']', "'", '"']
+        for i in d:
+            if len(encs) > 0 and encs[-1] in ['"', "'"]:
+                if encs[-1] == i:
+                    del encs[-1]
+            elif i in contr:
+                encs += [i]
+            elif i in ends:
+                if len(encs) < 1 or contr[encs[-1]] != i:
+                    raise IndexCreatorValueException("Missing opening enclosure for \'%s\'" % i, self.cnt_line_nr(d, st))
+                del encs[-1]
+
+        if len(encs) > 0:
+            raise IndexCreatorValueException("Missing closing enclosure for \'%s\'" % encs[0], self.cnt_line_nr(d, st))
+
+    def check_adjacents(self, d, st):
+        def std_check(d, n):
+            if n == 0:
+                prev = -1
+            else:
+                prev = d[n - 1][1] if d[n - 1][0] == token.OP else d[n - 1][0]
 
-#------------------------------------------------------------------------------
+            cur = d[n][1] if d[n][0] == token.OP else d[n][0]
 
-from twisted.internet.defer import Deferred
-from twisted.internet import reactor  # @UnresolvedImport
-
-#------------------------------------------------------------------------------
-
-from bitdust.automats import automat
-
-from bitdust.logs import lg
-
-from bitdust.lib import nameurl
-from bitdust.lib import serialization
-from bitdust.lib import net_misc
-
-from bitdust.main import config
-from bitdust.main import settings
-
-from bitdust.crypt import encrypted
-from bitdust.crypt import key
-from bitdust.crypt import signed
-
-from bitdust.services import driver
-
-from bitdust.contacts import identitycache
-
-from bitdust.p2p import commands
-from bitdust.p2p import network_connector
-
-from bitdust.transport import callback
-from bitdust.transport import packet_out
-
-from bitdust.transport.proxy import proxy_receiver
-
-from bitdust.userid import id_url
-from bitdust.userid import global_id
-from bitdust.userid import my_id
-
-#------------------------------------------------------------------------------
-
-_ProxySender = None
-
-#------------------------------------------------------------------------------
-
-
-def A(event=None, *args, **kwargs):
-    """
-    Access method to interact with proxy_sender machine.
-    """
-    global _ProxySender
-    if event is None and not args:
-        return _ProxySender
-    if _ProxySender is None:
-        # set automat name and starting state here
-        _ProxySender = ProxySender(
-            name='proxy_sender',
-            state='AT_STARTUP',
-            debug_level=_DebugLevel,
-            log_events=False,
-            log_transitions=_Debug,
-        )
-    if event is not None:
-        _ProxySender.automat(event, *args, **kwargs)
-    return _ProxySender
-
-
-#------------------------------------------------------------------------------
-
-
-class ProxySender(automat.Automat):
-    """
-    This class implements all the functionality of the ``proxy_sender()`` state
-    machine.
-    """
-    def init(self, **kwargs):
-        global _PacketLogFileEnabled
-        _PacketLogFileEnabled = config.conf().getBool('logs/packet-enabled')
-        self._sending_enabled = settings.enablePROXYsending()
-
-    def to_json(self):
-        j = super().to_json()
-        j.update(
-            {
-                'proto': proxy_receiver.GetRouterProtoHost()[0] if proxy_receiver.GetRouterProtoHost() else '',
-                'host': net_misc.pack_address_text(proxy_receiver.GetRouterProtoHost()[1]) if proxy_receiver.GetRouterProtoHost() else '',
-                'idurl': proxy_receiver.GetRouterIDURL(),
-                'bytes_received': 0,
-                'bytes_sent': self.traffic_out,
-            }
-        )
-        return j
-
-    def A(self, event, *args, **kwargs):
-        """
-        The state machine code, generated using `visio2python
-        <http://code.google.com/p/visio2python/>`_ tool.
-        """
-        #---AT_STARTUP---
-        if self.state == 'AT_STARTUP':
-            if event == 'init':
-                self.state = 'STOPPED'
-                self.doInit(*args, **kwargs)
-        #---STOPPED---
-        elif self.state == 'STOPPED':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'start' and proxy_receiver.A().state != 'LISTEN' and self.isSendingEnabled(*args, **kwargs):
-                self.state = 'ROUTER?'
-                self.doStartFilterOutgoingTraffic(*args, **kwargs)
-            elif ((event == 'proxy_receiver.state' and args[0] == 'LISTEN') or (event == 'start' and proxy_receiver.A().state == 'LISTEN')) and self.isSendingEnabled(*args, **kwargs):
-                self.state = 'REDIRECTING'
-                self.doStartFilterOutgoingTraffic(*args, **kwargs)
-        #---ROUTER?---
-        elif self.state == 'ROUTER?':
-            if event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doStopFilterOutgoingTraffic(*args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-            elif (event == 'proxy_receiver.state' and args[0] == 'LISTEN'):
-                self.state = 'REDIRECTING'
-                self.doSendAllPendingPackets(*args, **kwargs)
-            elif (event == 'proxy_receiver.state' and args[0] == 'OFFLINE'):
-                self.state = 'STOPPED'
-                self.doStopFilterOutgoingTraffic(*args, **kwargs)
-        #---REDIRECTING---
-        elif self.state == 'REDIRECTING':
-            if event == 'stop':
-                self.state = 'STOPPED'
-                self.doStopFilterOutgoingTraffic(*args, **kwargs)
-            elif event == 'shutdown':
-                self.state = 'CLOSED'
-                self.doStopFilterOutgoingTraffic(*args, **kwargs)
-                self.doDestroyMe(*args, **kwargs)
-            elif event == 'relay-failed':
-                self.doRetryCancelPacket(*args, **kwargs)
-            elif event == 'retry' or event == 'retry-cache-failed' or event == 'retry-send-failed' or event == 'retry-failed':
-                self.doReportRetry(event, *args, **kwargs)
-            elif event == 'relay-ack':
-                self.doCleanPacket(*args, **kwargs)
-            elif event == 'relay-out':
-                self.doCountTraffic(*args, **kwargs)
-            elif (event == 'proxy_receiver.state' and args[0] != 'LISTEN'):
-                self.state = 'ROUTER?'
-        #---CLOSED---
-        elif self.state == 'CLOSED':
-            pass
-        return None
-
-    def isSendingEnabled(self, *args, **kwargs):
-        """
-        Condition method.
-        """
-        return self._sending_enabled
-
-    def doInit(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self.traffic_out = 0
-        self.pending_packets = []
-        self.pending_ping_packets = []
-        self.max_pending_packets = 100  # TODO: read from settings
-        self.packets_retries = {}
-        self.sent_packets = {}
-
-    def doStartFilterOutgoingTraffic(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        callback.insert_outbox_filter_callback(0, self._on_first_outbox_packet)
-
-    def doStopFilterOutgoingTraffic(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        callback.remove_outbox_filter_callback(self._on_first_outbox_packet)
-
-    def doCountTraffic(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        _, newpacket, _ = args[0]
-        self.traffic_out += len(newpacket.Payload)
-
-    def doCleanPacket(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_clean_sent_packet(args[0])
-
-    def doRetryCancelPacket(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        self._do_retry_one_time(args[0])
-
-    def doReportRetry(self, event, *args, **kwargs):
-        """
-        Action method.
-        """
-        if _PacketLogFileEnabled:
-            label = event.upper().replace('-', ' ')
-            fail_info = args[0]
-            lg.out(
-                0,
-                '\033[0;49;36m%s %s(%s) from %s to %s %s\033[0m' % (label, fail_info['command'], fail_info['packet_id'], global_id.UrlToGlobalID(fail_info['from']), global_id.UrlToGlobalID(fail_info['to']), fail_info['error']),
-                log_name='packet',
-                showtime=True,
-            )
-
-    def doSendAllPendingPackets(self, *args, **kwargs):
-        """
-        Action method.
-        """
-        def _do_send():
-            while len(self.pending_packets):
-                outpacket, callbacks, wide, response_timeout, keep_alive, pending_result = self.pending_packets.pop(0)
-                if _Debug:
-                    lg.out(_DebugLevel, 'proxy_sender.doSendAllPendingPackets populate one more item, %d more in the queue' % (len(self.pending_packets)))
-                result_packet = self._on_first_outbox_packet(outpacket, wide, callbacks, response_timeout=response_timeout, keep_alive=keep_alive)
-                if not isinstance(result_packet, packet_out.PacketOut):
-                    lg.warn('failed sending pending packet %s, skip all pending packets' % outpacket)
-                    self.pending_packets = []
-                    break
-                pending_result.callback(result_packet)
-
-        reactor.callLater(0, _do_send)  # @UndefinedVariable
-
-    def doDestroyMe(self, *args, **kwargs):
-        """
-        Remove all references to the state machine object to destroy it.
-        """
-        global _PacketLogFileEnabled
-        _PacketLogFileEnabled = False
-        self.traffic_out = 0
-        self.pending_packets = []
-        self.pending_ping_packets = []
-        self.max_pending_packets = 0
-        self.packets_retries.clear()
-        self.sent_packets.clear()
-        self.destroy()
-        global _ProxySender
-        del _ProxySender
-        _ProxySender = None
-
-    def _do_add_pending_packet(self, outpacket, callbacks, wide, response_timeout, keep_alive):
-        if len(self.pending_packets) > self.max_pending_packets:
-            if _Debug:
-                lg.warn('pending packets queue is full, skip sending outgoing packet')
-            return None
-        pending_result = Deferred()
-        self.pending_packets.append((outpacket, callbacks, wide, response_timeout, keep_alive, pending_result))
-        if _Debug:
-            lg.out(_DebugLevel, 'proxy_sender._do_add_pending_packet %s' % outpacket)
-        return pending_result
-
-    def _do_send_packet_to_router(self, outpacket, callbacks, wide, response_timeout, keep_alive, is_retry=False):
-        router_idurl = proxy_receiver.GetRouterIDURL()
-        router_identity_obj = proxy_receiver.GetRouterIdentity()
-        router_proto_host = proxy_receiver.GetRouterProtoHost()
-        router_proto, router_host = router_proto_host
-        publickey = router_identity_obj.publickey
-        my_original_identity_src = proxy_receiver.ReadMyOriginalIdentitySource()
-        if not router_idurl or not router_identity_obj or not router_proto_host or not my_original_identity_src:
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._do_send_packet_to_router SKIP because router not ready yet')
-            return self._do_add_pending_packet(outpacket, callbacks, wide, response_timeout, keep_alive)
-        if outpacket.RemoteID.to_bin() == router_idurl.to_bin():
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._do_send_packet_to_router SKIP, packet addressed to router and must be sent in a usual way')
-            return None
-        try:
-            raw_data = outpacket.Serialize()
-        except:
-            lg.exc('failed to Serialize %s' % outpacket)
-            return None
-        # see proxy_router.ProxyRouter : doForwardOutboxPacket() for receiving part
-        json_payload = {
-            'f': my_id.getIDURL().to_bin(),  # from
-            't': outpacket.RemoteID.to_bin(),  # to
-            'p': raw_data,  # payload
-            'w': wide,  # wide
-            'i': response_timeout,
-            'a': keep_alive,
-            'r': is_retry,
-        }
-        if not json_payload['t']:
-            raise ValueError('receiver idurl was not set')
-        raw_bytes = serialization.DictToBytes(json_payload)
-        block = encrypted.Block(
-            CreatorID=my_id.getIDURL(),
-            BackupID='routed outgoing data',
-            BlockNumber=0,
-            SessionKey=key.NewSessionKey(session_key_type=key.SessionKeyType()),
-            SessionKeyType=key.SessionKeyType(),
-            LastBlock=True,
-            Data=raw_bytes,
-            EncryptKey=lambda inp: key.EncryptOpenSSHPublicKey(publickey, inp),
-        )
-        block_encrypted = block.Serialize()
-        newpacket = signed.Packet(
-            Command=commands.RelayOut(),
-            OwnerID=outpacket.OwnerID,
-            CreatorID=my_id.getIDURL(),
-            PacketID=outpacket.PacketID,
-            Payload=block_encrypted,
-            RemoteID=router_idurl,
-        )
-        if response_timeout is not None:
-            # must give some extra time for the proxy re-routing
-            response_timeout += 10.0
-        routed_packet = packet_out.create(
-            outpacket=outpacket,
-            wide=False,
-            callbacks={},
-            route={
-                'packet': newpacket,  # pointing "newpacket" to router node
-                'proto': router_proto,
-                'host': router_host,
-                'remoteid': router_idurl,
-                'description': 'RelayOut_%s[%s]_%s' % (outpacket.Command, outpacket.PacketID, nameurl.GetName(router_idurl)),
-            },
-            response_timeout=response_timeout,
-            keep_alive=True,
-        )
-        for command, cb_list in callbacks.items():
-            if isinstance(cb_list, list):
-                for cb in cb_list:
-                    routed_packet.set_callback(command, cb)
+            # there always is an endmarker at the end, but this is a precaution
+            if n + 2 > len(d):
+                nex = -1
             else:
-                routed_packet.set_callback(command, cb_list)
-        if not is_retry:
-            _key = (outpacket.Command, outpacket.PacketID, outpacket.RemoteID.to_bin())
-            self.sent_packets[_key] = (routed_packet, outpacket)
-        self.event('relay-out', (outpacket, newpacket, routed_packet))
-        if _Debug:
-            lg.out(_DebugLevel, '>>>Relay-OUT %s sent to %s://%s with %d bytes, timeout=%r' % (str(outpacket), router_proto, router_host, len(block_encrypted), response_timeout))
-        if _PacketLogFileEnabled:
-            lg.out(
-                0, '\033[0;49;36mRELAY OUT %s(%s) with %s bytes from %s to %s via %s\033[0m' %
-                (outpacket.Command, outpacket.PacketID, len(raw_bytes), global_id.UrlToGlobalID(outpacket.CreatorID), global_id.UrlToGlobalID(outpacket.RemoteID), global_id.UrlToGlobalID(router_idurl)), log_name='packet', showtime=True
-            )
-        del raw_bytes
-        del block
-        del newpacket
-        del outpacket
-        del router_identity_obj
-        del router_idurl
-        del router_proto_host
-        return routed_packet
-
-    def _do_cancel_outbox_packets(self, fail_info):
-        to_idurl = id_url.field(fail_info['to'])
-        from_idurl = id_url.field(fail_info['from'])
-        for p in packet_out.search_by_packet_id(fail_info['packet_id']):
-            if p.outpacket.Command == fail_info['command']:
-                if id_url.to_bin(to_idurl) == p.outpacket.RemoteID.to_bin():
-                    if p.outpacket.CreatorID.to_bin() == id_url.to_bin(from_idurl) or p.outpacket.OwnerID.to_bin() == id_url.to_bin(from_idurl):
-                        if _Debug:
-                            lg.dbg(_DebugLevel, 'about to cancel %r because sending via proxy transport is failed' % p)
-                        p.automat('cancel')
-
-    def _do_retry_one_time(self, fail_info):
-        to_idurl = id_url.field(fail_info['to']).to_bin()
-        from_idurl = id_url.field(fail_info['from']).to_bin()
-        _key = (fail_info['command'], fail_info['packet_id'], from_idurl, to_idurl)
-        current_retries = self.packets_retries.get(_key, 0)
-        if _Debug:
-            lg.args(_DebugLevel, key=_key, retries=current_retries)
-        if fail_info.get('error') != 'route already closed':
-            if _Debug:
-                lg.dbg(_DebugLevel, 'failed sending routed packet : %r' % fail_info)
-            self._do_clean_sent_packet(fail_info)
-            self._do_cancel_outbox_packets(fail_info)
-            self.packets_retries.pop(_key, None)
+                nex = d[n + 1][1] if d[n + 1][0] == token.OP else d[n + 1][0]
+
+            if prev not in self.allowed_adjacent[cur]:
+                raise IndexCreatorValueException("Wrong left value of the %s" % cur, self.cnt_line_nr(line, st))
+
+            # there is an assumption that whole data always ends with 0 marker, the idea prolly needs a rewritting to allow more whitespaces
+            # between tokens, so it will be handled anyway
+            elif nex not in self.allowed_adjacent[cur][prev]:
+                raise IndexCreatorValueException("Wrong right value of the %s" % cur, self.cnt_line_nr(line, st))
+
+        for n, (t, i, _, _, line) in enumerate(d):
+            if t == token.NAME or t == token.STRING:
+                if n + 1 < len(d) and d[n + 1][0] in [token.NAME, token.STRING]:
+                    raise IndexCreatorValueException("Did you forget about an operator in between?", self.cnt_line_nr(line, st))
+            elif i in self.allowed_adjacent:
+                std_check(d, n)
+
+    def check_colons(self, d, st):
+        cnt = 0
+        br = 0
+
+        def check_ret_args_nr(a, s):
+            c_b_cnt = 0
+            s_b_cnt = 0
+            n_b_cnt = 0
+            comas_cnt = 0
+            for _, i, _, _, line in a:
+
+                if c_b_cnt == n_b_cnt == s_b_cnt == 0:
+                    if i == ',':
+                        comas_cnt += 1
+                        if (s == 1 and comas_cnt > 1) or (s == 2 and comas_cnt > 0):
+                            raise IndexCreatorFunctionException("Too much arguments to return", self.cnt_line_nr(line, st))
+                        if s == 0 and comas_cnt > 0:
+                            raise IndexCreatorValueException("A coma here doesn't make any sense", self.cnt_line_nr(line, st))
+
+                    elif i == ':':
+                            if s == 0:
+                                raise IndexCreatorValueException("A colon here doesn't make any sense", self.cnt_line_nr(line, st))
+                            raise IndexCreatorFunctionException("Two colons don't make any sense", self.cnt_line_nr(line, st))
+
+                if i == '{':
+                    c_b_cnt += 1
+                elif i == '}':
+                    c_b_cnt -= 1
+                elif i == '(':
+                    n_b_cnt += 1
+                elif i == ')':
+                    n_b_cnt -= 1
+                elif i == '[':
+                    s_b_cnt += 1
+                elif i == ']':
+                    s_b_cnt -= 1
+
+        def check_if_empty(a):
+            for i in a:
+                if i not in [token.NEWLINE, token.INDENT, token.ENDMARKER]:
+                    return False
+            return True
+        if st == 0:
+            check_ret_args_nr(d, st)
             return
-        if current_retries >= 1:
-            if _Debug:
-                lg.dbg(_DebugLevel, 'failed sending routed packet after few attempts : %r' % fail_info)
-            self.automat('retry-failed', fail_info)
-            self._do_clean_sent_packet(fail_info)
-            self._do_cancel_outbox_packets(fail_info)
-            self.packets_retries.pop(_key, None)
+
+        for n, i in enumerate(d):
+            if i[1] == ':':
+                if br == 0:
+                    if len(d) < n or check_if_empty(d[n + 1:]):
+                        raise IndexCreatorValueException(
+                            "Empty return value", self.cnt_line_nr(i[4], st))
+                    elif len(d) >= n:
+                        check_ret_args_nr(d[n + 1:], st)
+                    return cnt
+                else:
+                    cnt += 1
+            elif i[1] == '{':
+                br += 1
+            elif i[1] == '}':
+                br -= 1
+        check_ret_args_nr(d, st)
+        return -1
+
+    def check_for_2nd_arg(self, d):
+        c_b_cnt = 0  # curly brackets counter '{}'
+        s_b_cnt = 0  # square brackets counter '[]'
+        n_b_cnt = 0  # normal brackets counter '()'
+
+        def check_2nd_arg(d, ind):
+            d = d[ind[0]:]
+            for t, i, (n, r), _, line in d:
+                if i == '{' or i is None:
+                    return 0
+                elif t == token.NAME:
+                    self.known_dicts_in_mkv.append((i, (n, r)))
+                    return 0
+                elif t == token.STRING or t == token.NUMBER:
+                    raise IndexCreatorValueException("Second return value of make_key_value function has to be a dictionary!", self.cnt_line_nr(line, 1))
+
+        for ind in enumerate(d):
+            t, i, _, _, _ = ind[1]
+            if s_b_cnt == n_b_cnt == c_b_cnt == 0:
+                if i == ',':
+                    return check_2nd_arg(d, ind)
+                elif (t == token.NAME and i not in self.funcs) or i == '{':
+                    self.is_one_arg_enough = True
+
+            if i == '{':
+                c_b_cnt += 1
+                self.is_one_arg_enough = True
+            elif i == '}':
+                c_b_cnt -= 1
+            elif i == '(':
+                n_b_cnt += 1
+            elif i == ')':
+                n_b_cnt -= 1
+            elif i == '[':
+                s_b_cnt += 1
+            elif i == ']':
+                s_b_cnt -= 1
+        return -1
+
+    def cnt_line_nr(self, l, stage):
+        nr = -1
+        for n, i in enumerate(self.predata[stage]):
+            # print i,"|||",i.strip(),"|||",l
+            if l == i.strip():
+                nr = n
+        if nr == -1:
+            return -1
+
+        if stage == 0:
+            return nr + 1
+        elif stage == 1:
+            return nr + self.cnt_lines[0] + (self.cnt_lines[2] - 1 if self.funcs_rev else 0)
+        elif stage == 2:
+            return nr + self.cnt_lines[0] + (self.cnt_lines[1] - 1 if not self.funcs_rev else 0)
+
+        return -1
+
+    def handle_prop_line(self, d):
+        d_len = len(d)
+        if d[d_len - 1][0] == token.ENDMARKER:
+            d_len -= 1
+
+        if d_len < 3:
+            raise IndexCreatorValueException("Can't handle properity assingment ", self.cnt_line_nr(d[0][4], 0))
+
+        if not d[1][1] in self.props_assign:
+            raise IndexCreatorValueException(
+                "Did you forget : or =?", self.cnt_line_nr(d[0][4], 0))
+
+        if d[0][0] == token.NAME or d[0][0] == token.STRING:
+            if d[0][1] in self.props_set:
+                raise IndexCreatorValueException("Properity %s is set more than once" % d[0][1], self.cnt_line_nr(d[0][4], 0))
+            self.props_set += [d[0][1]]
+            if d[0][1] == "type" or d[0][1] == "name":
+                t, tk, _, _, line = d[2]
+
+                if d_len > 3:
+                    raise IndexCreatorValueException(
+                        "Wrong value to assign", self.cnt_line_nr(line, 0))
+
+                if t == token.STRING:
+                    m = re.search('\s*(?P<a>[\'\"]+)(.*?)(?P=a)\s*', tk)
+                    if m:
+                        tk = m.groups()[1]
+                elif t != token.NAME:
+                    raise IndexCreatorValueException(
+                        "Wrong value to assign", self.cnt_line_nr(line, 0))
+
+                if d[0][1] == "type":
+                    if d[2][1] == "TreeBasedIndex":
+                        self.custom_header.add("from CodernityDB.tree_index import TreeBasedIndex\n")
+                    elif d[2][1] == "MultiTreeBasedIndex":
+                        self.custom_header.add("from CodernityDB.tree_index import MultiTreeBasedIndex\n")
+                    elif d[2][1] == "MultiHashIndex":
+                        self.custom_header.add("from CodernityDB.hash_index import MultiHashIndex\n")
+                    self.tokens_head.insert(2, tk)
+                    self.index_type = tk
+                else:
+                    self.index_name = tk
+                return
+            else:
+                self.tokens += ['\n        kwargs["' + d[0][1] + '"]']
+        else:
+            raise IndexCreatorValueException("Can't handle properity assingment ", self.cnt_line_nr(d[0][4], 0))
+
+        self.tokens += ['=']
+
+        self.check_adjacents(d[2:], 0)
+        self.check_colons(d[2:], 0)
+
+        for i in d[2:]:
+            self.tokens += [i[1]]
+
+    def generate_func(self, t, tk, pos_start, pos_end, line, hdata, stage):
+        if self.last_line[stage] != -1 and pos_start[0] > self.last_line[stage] and line != '':
+            raise IndexCreatorFunctionException("This line will never be executed!", self.cnt_line_nr(line, stage))
+        if t == 0:
             return
-        self.packets_retries[_key] = current_retries + 1
-        d = identitycache.immediatelyCaching(fail_info['to'])
-        d.addCallback(self._on_cache_retry_success, fail_info)
-        d.addErrback(self._on_cache_retry_failed, fail_info)
-
-    def _do_clean_sent_packet(self, info):
-        to_idurl = id_url.to_bin(info['to'])
-        to_remove = []
-        for _key in self.sent_packets.keys():
-            routed_packet, outpacket = self.sent_packets.get(_key, (
-                None,
-                None,
-            ))
-            if not outpacket:
-                if _Debug:
-                    lg.dbg(_DebugLevel, 'found empty outpacket : %r' % routed_packet)
-                to_remove.append(_key)
-                continue
-            if outpacket.Command != info['command']:
-                continue
-            if outpacket.PacketID != info['packet_id']:
-                continue
-            if outpacket.RemoteID.to_bin() != to_idurl:
-                continue
-            to_remove.append(_key)
-        for _key in to_remove:
-            routed_packet, outpacket = self.sent_packets.pop(_key, (
-                None,
-                None,
-            ))
-
-    def _on_cache_retry_success(self, xmlsrc, fail_info):
-        if _Debug:
-            lg.args(_DebugLevel, sent_packets=len(self.sent_packets), fail_info=fail_info)
-        to_idurl = id_url.to_bin(fail_info['to'])
-        for _key in self.sent_packets.keys():
-            routed_packet, outpacket = self.sent_packets.get(_key, (
-                None,
-                None,
-            ))
-            if not outpacket:
-                if _Debug:
-                    lg.dbg(_DebugLevel, 'found empty outpacket : %r' % routed_packet)
-                continue
-            if outpacket.Command != fail_info['command']:
-                continue
-            if outpacket.PacketID != fail_info['packet_id']:
-                continue
-            if outpacket.RemoteID.to_bin() != to_idurl:
-                continue
-            routed_retry_packet = self._do_send_packet_to_router(
-                outpacket=outpacket,
-                callbacks=routed_packet.callbacks,
-                wide=fail_info.get('wide', False),
-                keep_alive=fail_info.get('keep_alive', False),
-                response_timeout=fail_info.get('response_timeout', None),
-                is_retry=True,
-            )
-            if not routed_retry_packet:
-                self.automat('retry-send-failed', fail_info)
+
+        if pos_start[1] == 0:
+            if self.line_cons[stage][pos_start[0] - 1] == -1:
+                self.tokens += ['\n        return']
+                self.last_line[stage] = pos_start[0]
             else:
-                self.sent_packets[_key] = (
-                    routed_retry_packet,
-                    outpacket,
-                )
-                self.automat('retry', fail_info)
-            del routed_packet
-        return None
-
-    def _on_cache_retry_failed(self, err, fail_info):
-        if _Debug:
-            lg.args(_DebugLevel, err=err, fail_info=fail_info)
-        self.automat('retry-cache-failed', fail_info)
-        self._do_cancel_outbox_packets(fail_info)
-        return None
-
-    def _on_first_outbox_packet(self, outpacket, wide, callbacks, target=None, route=None, response_timeout=None, keep_alive=True):
-        """
-        Will be called first for every outgoing packet.
-        Must return `None` if that packet should be sent in a normal way.
-        Otherwise will create another "routed" packet instead and return it.
-        """
-        if not driver.is_on('service_proxy_transport'):
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because service_proxy_transport is not started yet' % outpacket)
-            return None
-        if not proxy_receiver.A():
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because proxy_receiver() not exist' % outpacket)
-            return None
-        if outpacket.Command == commands.Identity() and outpacket.CreatorID == my_id.getIDURL():
-            if proxy_receiver.GetPossibleRouterIDURL() and proxy_receiver.GetPossibleRouterIDURL().to_bin() == outpacket.RemoteID.to_bin():
-                if network_connector.A().state == 'DISCONNECTED':
-                    if _Debug:
-                        lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r because network_connector() is DISCONNECTED' % outpacket)
-                    return None
-                if network_connector.A().state == 'CONNECTED':
-                    lg.warn('sending %r to "possible" proxy router %r' % (outpacket, proxy_receiver.GetPossibleRouterIDURL()))
-                    pkt_out = packet_out.create(outpacket, wide, callbacks, target, route, response_timeout, keep_alive)
-                    return pkt_out
-                if _Debug:
-                    lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet SKIP sending %r, network_connector() have transition state' % outpacket)
-                return None
-        if proxy_receiver.A().state != 'LISTEN':
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._on_first_outbox_packet DELLAYED %r because proxy_receiver state is not LISTEN yet' % outpacket)
-            return self._do_add_pending_packet(outpacket, callbacks, wide, response_timeout, keep_alive)
-        return self._do_send_packet_to_router(
-            outpacket=outpacket,
-            callbacks=callbacks,
-            wide=wide,
-            keep_alive=keep_alive,
-            response_timeout=response_timeout,
-        )
-
-    def _on_network_connector_state_changed(self, oldstate, newstate, event_string, *args, **kwargs):
-        if newstate == 'CONNECTED' and oldstate != newstate:
-            if _Debug:
-                lg.out(_DebugLevel, 'proxy_sender._on_network_connector_state_changed will send %d pending "ping" packets' % len(self.pending_ping_packets))
-            while len(self.pending_ping_packets):
-                outpacket, wide, callbacks, target, route, response_timeout, keep_alive, pending_result = self.pending_ping_packets.pop(0)
-                if _Debug:
-                    lg.out(_DebugLevel, 'proxy_sender._on_network_connector_state_changed populate one more item, %d more in the queue' % (len(self.pending_packets)))
-                result_packet = self._on_first_outbox_packet(outpacket, wide, callbacks, target, route, response_timeout, keep_alive)
-                if not isinstance(result_packet, packet_out.PacketOut):
-                    lg.warn('failed sending pending packet %s, skip all pending packets' % outpacket)
-                    self.pending_ping_packets = []
-                    break
-                pending_result.callback(result_packet)
-
-
-#------------------------------------------------------------------------------
-
-
-def main():
-    reactor.callWhenRunning(A, 'init')  # @UndefinedVariable
-    reactor.run()  # @UndefinedVariable
+                self.tokens += ['\n        if']
+        elif tk == ':' and self.line_cons[stage][pos_start[0] - 1] > -1:
+            if self.line_cons[stage][pos_start[0] - 1] == 0:
+                self.tokens += [':\n            return']
+                return
+            self.line_cons[stage][pos_start[0] - 1] -= 1
+
+        if tk in self.logic2:
+            # print tk
+            if line[pos_start[1] - 1] != tk and line[pos_start[1] + 1] != tk:
+                self.tokens += [tk]
+            if line[pos_start[1] - 1] != tk and line[pos_start[1] + 1] == tk:
+                if tk == '&':
+                    self.tokens += ['and']
+                else:
+                    self.tokens += ['or']
+            return
 
+        if self.brackets != 0:
+            def search_through_known_dicts(a):
+                for i, (n, r) in self.known_dicts_in_mkv:
+                    if i == tk and r > pos_start[1] and n == pos_start[0] and hdata == 'data':
+                        return True
+                return False
+
+            if t == token.NAME and len(self.funcs_stack) > 0 and self.funcs_stack[-1][0] == 'md5' and search_through_known_dicts(tk):
+                raise IndexCreatorValueException("Second value returned by make_key_value for sure isn't a dictionary ", self.cnt_line_nr(line, 1))
+
+        if tk == ')':
+            self.cur_brackets -= 1
+            if len(self.funcs_stack) > 0 and self.cur_brackets == self.funcs_stack[-1][1]:
+                self.tokens += [tk]
+                self.tokens += self.funcs[self.funcs_stack[-1][0]][1]
+                del self.funcs_stack[-1]
+                return
+        if tk == '(':
+            self.cur_brackets += 1
+
+        if tk in self.none:
+            self.tokens += ['None']
+            return
+
+        if t == token.NAME and tk not in self.logic and tk != hdata:
+            if tk not in self.funcs:
+                self.tokens += [hdata + '["' + tk + '"]']
+            else:
+                self.tokens += self.funcs[tk][0]
+                if tk in self.funcs_with_body:
+                    self.funcs_with_body[tk] = (
+                        self.funcs_with_body[tk][0], True)
+                self.custom_header.add(self.handle_int_imports.get(tk))
+                self.funcs_stack += [(tk, self.cur_brackets)]
+        else:
+            self.tokens += [tk]
 
-#------------------------------------------------------------------------------
+    def handle_make_value(self, t, tk, pos_start, pos_end, line):
+        self.generate_func(t, tk, pos_start, pos_end, line, 'data', 1)
 
-if __name__ == '__main__':
-    main()
+    def handle_make_key(self, t, tk, pos_start, pos_end, line):
+        self.generate_func(t, tk, pos_start, pos_end, line, 'key', 2)
```

### Comparing `bitdust-0.1.8.234/bitdust/transport/tcp/__init__.py` & `bitdust-0.1.9.241/bitdust/transport/tcp/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/tcp/tcp_connection.py` & `bitdust-0.1.9.241/bitdust/transport/tcp/tcp_connection.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/tcp/tcp_interface.py` & `bitdust-0.1.9.241/bitdust/transport/tcp/tcp_interface.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/tcp/tcp_node.py` & `bitdust-0.1.9.241/bitdust/transport/tcp/tcp_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/tcp/tcp_stream.py` & `bitdust-0.1.9.241/bitdust/transport/tcp/tcp_stream.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/__init__.py` & `bitdust-0.1.9.241/bitdust/transport/udp/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_connector.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_connector.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_file_queue.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_file_queue.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_interface.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_interface.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_node.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_session.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_session.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/transport/udp/udp_stream.py` & `bitdust-0.1.9.241/bitdust/transport/udp/udp_stream.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/updates/__init__.py` & `bitdust-0.1.9.241/bitdust/updates/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/updates/git_proc.py` & `bitdust-0.1.9.241/bitdust/updates/git_proc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/userid/__init__.py` & `bitdust-0.1.9.241/bitdust/userid/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust/userid/global_id.py` & `bitdust-0.1.9.241/bitdust/userid/global_id.py`

 * *Files 1% similar despite different names*

```diff
@@ -68,14 +68,18 @@
 def glob2idurl(glob_id, as_field=True):
     """
     Alias.
     """
     return GlobalUserToIDURL(glob_id, as_field=as_field)
 
 
+def latest_glob_id(glob_id):
+    return glob2idurl(glob_id, as_field=True).to_id()
+
+
 #------------------------------------------------------------------------------
 
 
 def MakeGlobalKeyID(key_alias, user_id):
     return _FORMAT_GLOBAL_ID_KEY_USER.format(
         key_alias=key_alias,
         user=user_id,
@@ -460,14 +464,7 @@
 
 
 def GetGlobalQueueKeyID(queue_id):
     queue_alias_owner_id, _, _ = queue_id.rpartition('&')
     queue_alias, _, owner_id = queue_alias_owner_id.partition('&')
     key_id = MakeGlobalKeyID(queue_alias, owner_id)
     return key_id
-
-
-#------------------------------------------------------------------------------
-
-
-def latest_glob_id(glob_id):
-    return glob2idurl(glob_id, as_field=True).to_id()
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/id_registrator.py` & `bitdust-0.1.9.241/bitdust/userid/id_registrator.py`

 * *Files 6% similar despite different names*

```diff
@@ -362,26 +362,27 @@
             login = kwargs['username']
             preferred_servers = kwargs.get('preferred_servers', [])
         self.preferred_servers = [s.strip() for s in preferred_servers]
         if not self.known_servers:
             self.known_servers = known_servers.by_host()
         if not self.preferred_servers:
             try:
-                for srv in strng.to_text(config.conf().getData('services/identity-propagate/preferred-servers')).split(','):
+                for srv in strng.to_text(config.conf().getString('services/identity-propagate/preferred-servers')).split(','):
                     if srv.strip():
                         self.preferred_servers.append(srv.strip())
             except:
                 pass
         self.min_servers = max(settings.MinimumIdentitySources(), config.conf().getInt('services/identity-propagate/min-servers') or settings.MinimumIdentitySources())
         self.max_servers = min(settings.MaximumIdentitySources(), config.conf().getInt('services/identity-propagate/max-servers') or settings.MaximumIdentitySources())
-        lg.out(4, 'id_registrator.doSaveMyName [%s]' % login)
-        lg.out(4, '    known_servers=%s' % self.known_servers)
-        lg.out(4, '    preferred_servers=%s' % self.preferred_servers)
-        lg.out(4, '    min_servers=%s' % self.min_servers)
-        lg.out(4, '    max_servers=%s' % self.max_servers)
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doSaveMyName [%s]' % login)
+            lg.out(_DebugLevel, '    known_servers=%s' % self.known_servers)
+            lg.out(_DebugLevel, '    preferred_servers=%s' % self.preferred_servers)
+            lg.out(_DebugLevel, '    min_servers=%s' % self.min_servers)
+            lg.out(_DebugLevel, '    max_servers=%s' % self.max_servers)
         bpio.WriteTextFile(settings.UserNameFilename(), login)
 
     def doSelectRandomServers(self, *args, **kwargs):
         """
         Action method.
         TODO: we also can search available id servers in DHT network as well
         """
@@ -393,45 +394,50 @@
             # take a list of all known servers (only host names)
             s = set(self.known_servers.keys())
             # exclude already discovered servers
             s.difference_update(self.discovered_servers)
             if len(s) > 0:
                 # if found some known servers - just pick a random one
                 self.discovered_servers.append(random.choice(list(s)))
-        lg.out(4, 'id_registrator.doSelectRandomServers %s' % str(self.discovered_servers))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doSelectRandomServers %s' % str(self.discovered_servers))
 
     def doPingServers(self, *args, **kwargs):
         """
         Action method.
         """
-        lg.out(4, 'id_registrator.doPingServers    %d in list' % len(self.discovered_servers))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doPingServers    %d in list' % len(self.discovered_servers))
 
         def _cb(htmlsrc, id_server_host):
-            lg.out(4, '            RESPONDED: %s' % id_server_host)
+            if _Debug:
+                lg.out(_DebugLevel, '            RESPONDED: %s' % id_server_host)
             if self.preferred_servers and id_server_host in self.preferred_servers:
                 self.good_servers.insert(0, id_server_host)
             else:
                 self.good_servers.append(id_server_host)
             self.discovered_servers.remove(id_server_host)
             self.automat('id-server-response', (id_server_host, htmlsrc))
 
         def _eb(err, id_server_host):
-            lg.out(4, '               FAILED: %s : %s' % (id_server_host, err.getErrorMessage()))
+            if _Debug:
+                lg.out(_DebugLevel, '               FAILED: %s : %s' % (id_server_host, err.getErrorMessage()))
             self.discovered_servers.remove(id_server_host)
             self.automat('id-server-failed', (id_server_host, err))
 
         for host in self.discovered_servers:
             webport, tcpport = known_servers.by_host().get(
                 host,
                 (settings.IdentityWebPort(), settings.IdentityServerPort()),
             )
             if webport == 80:
                 webport = ''
             server_url = nameurl.UrlMake('http', strng.to_text(host), webport, '')
-            lg.out(4, '               connecting to %s' % server_url)
+            if _Debug:
+                lg.out(_DebugLevel, '               connecting to %s' % server_url)
             d = net_misc.getPageTwisted(server_url, timeout=7)
             d.addCallback(_cb, host)
             d.addErrback(_eb, host)
 
     def doRequestServers(self, *args, **kwargs):
         """
         Action method.
@@ -446,20 +452,22 @@
                     else:
                         self.free_idurls.insert(1, idurl)
                 else:
                     self.free_idurls.append(idurl)
                 self.registrations.remove(idurl)
                 self.automat('id-not-exist', idurl)
             else:
-                lg.out(4, '                EXIST: %s' % idurl)
+                if _Debug:
+                    lg.out(_DebugLevel, '                EXIST: %s' % idurl)
                 self.registrations.remove(idurl)
                 self.automat('id-exist', idurl)
 
         def _eb(err, idurl, host):
-            lg.out(4, '            NOT EXIST: %s' % idurl)
+            if _Debug:
+                lg.out(_DebugLevel, '            NOT EXIST: %s' % idurl)
             if self.preferred_servers and host in self.preferred_servers:
                 if self.preferred_servers[0] == host:
                     self.free_idurls.insert(0, idurl)
                 else:
                     self.free_idurls.insert(1, idurl)
             else:
                 self.free_idurls.append(idurl)
@@ -467,43 +475,48 @@
             self.automat('id-not-exist', idurl)
 
         for host in self.good_servers:
             webport, tcpport = known_servers.by_host().get(host, (settings.IdentityWebPort(), settings.IdentityServerPort()))
             if webport == 80:
                 webport = ''
             idurl = nameurl.UrlMake('http', strng.to_text(host), webport, login + '.xml')
-            lg.out(4, '    %s' % idurl)
+            if _Debug:
+                lg.out(_DebugLevel, '    %s' % idurl)
             d = net_misc.getPageTwisted(idurl, timeout=10)
             d.addCallback(_cb, idurl, host)
             d.addErrback(_eb, idurl, host)
             self.registrations.append(idurl)
-        lg.out(4, 'id_registrator.doRequestServers login=%s registrations=%d' % (login, len(self.registrations)))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doRequestServers login=%s registrations=%d' % (login, len(self.registrations)))
 
     def doDetectLocalIP(self, *args, **kwargs):
         """
         Action method.
         """
         localip = net_misc.getLocalIp()
         bpio.WriteTextFile(settings.LocalIPFilename(), localip)
-        lg.out(4, 'id_registrator.doDetectLocalIP [%s]' % localip)
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doDetectLocalIP [%s]' % localip)
         self.automat('local-ip-detected')
 
     def doStunExternalIP(self, *args, **kwargs):
         """
         Action method.
         """
-        lg.out(4, 'id_registrator.doStunExternalIP')
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doStunExternalIP')
         if len(self.free_idurls) == 1:
             if self.free_idurls[0].count(b'localhost:') or self.free_idurls[0].count(b'127.0.0.1:'):
                 # if you wish to create a local identity you do not need to stun external IP at all
                 self.automat('stun-success', '127.0.0.1')
                 return True
 
         def save(result):
-            lg.out(4, '            external IP : %s' % result)
+            if _Debug:
+                lg.out(_DebugLevel, '            external IP : %s' % result)
             if result['result'] != 'stun-success':
                 self.automat('stun-failed')
                 return
             ip = result['ip']
             bpio.WriteTextFile(settings.ExternalIPFilename(), ip)
             self.automat('stun-success', ip)
 
@@ -551,35 +564,38 @@
         dl.addCallback(_cb)
         dl.addErrback(_eb)
 
     def doRequestMyIdentity(self, *args, **kwargs):
         """
         Action method.
         """
-        lg.out(8, 'id_registrator.doRequestMyIdentity')
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doRequestMyIdentity')
 
         def _cb(src):
             # TODO: validate my identity and make sure other servers also stored
             self.automat('my-id-exist', src)
 
         def _eb(err):
             # TODO: this is actually can be an issue if one server failed but others are fine...
             self.automat('my-id-not-exist', err)
 
         for idurl in self.new_identity.getSources(as_originals=True):
-            lg.out(8, '        %s' % idurl)
+            if _Debug:
+                lg.out(_DebugLevel, '        %s' % idurl)
             d = net_misc.getPageTwisted(idurl, timeout=15)
             d.addCallback(_cb)
             d.addErrback(_eb)
 
     def doSaveMyIdentity(self, *args, **kwargs):
         """
         Action method.
         """
-        lg.out(4, 'id_registrator.doSaveMyIdentity %s' % self.new_identity)
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doSaveMyIdentity %s' % self.new_identity)
         my_id.setLocalIdentity(self.new_identity)
         my_id.saveLocalIdentity()
 
     def doDestroyMe(self, *args, **kwargs):
         """
         Action method.
         """
@@ -591,44 +607,48 @@
     def doPrint(self, *args, **kwargs):
         """
         Action method.
         """
         from bitdust.main import installer
         installer.A().event('print', *args, **kwargs)
         self.last_message = args[0][0]
-        lg.out(6, 'id_registrator.doPrint: %s' % str(*args, **kwargs))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator.doPrint: %s' % str(*args, **kwargs))
 
     def _create_new_identity(self):
         """
         Generate new Private key and new identity file.
         Reads some extra info from config files.
         """
         login = strng.to_bin(bpio.ReadTextFile(settings.UserNameFilename()))
         externalIP = strng.to_bin(misc.readExternalIP()) or b'127.0.0.1'
         if self.free_idurls[0].count(b'127.0.0.1'):
             externalIP = b'127.0.0.1'
-        lg.out(4, 'id_registrator._create_new_identity %s %s ' % (login, externalIP))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_registrator._create_new_identity %s %s ' % (login, externalIP))
 
         my_id.forgetLocalIdentity()
         my_id.eraseLocalIdentity(do_backup=True)
         key.ForgetMyKey(erase_file=True, do_backup=True)
         key.InitMyKey()
         if not key.isMyKeyReady():
             key.GenerateNewKey()
-        lg.out(4, '    my key is ready')
+        if _Debug:
+            lg.out(_DebugLevel, '    my key is ready')
         ident = my_id.buildDefaultIdentity(name=login, ip=externalIP, idurls=self.free_idurls)
         my_identity_xmlsrc = ident.serialize(as_text=True)
         newfilename = settings.LocalIdentityFilename() + '.new'
         bpio.WriteTextFile(newfilename, my_identity_xmlsrc)
         try:
             id_url.identity_cached(ident)
         except:
             lg.exc()
         self.new_identity = ident
-        lg.out(4, '    wrote %d bytes to %s' % (len(my_identity_xmlsrc), newfilename))
+        if _Debug:
+            lg.out(_DebugLevel, '    wrote %d bytes to %s' % (len(my_identity_xmlsrc), newfilename))
 
     def _send_new_identity(self):
         """
         Send created identity to the identity servers to register it.
         """
         if _Debug:
             lg.out(_DebugLevel, 'id_registrator._send_new_identity')
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/id_server.py` & `bitdust-0.1.9.241/bitdust/userid/id_server.py`

 * *Files 18% similar despite different names*

```diff
@@ -33,14 +33,22 @@
     * :red:`start`
     * :red:`stop`
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
+
+#------------------------------------------------------------------------------
+
+_Debug = False
+_DebugLevel = 14
+
+#------------------------------------------------------------------------------
+
 from io import BytesIO
 
 #------------------------------------------------------------------------------
 
 import os
 import sys
 import struct
@@ -52,14 +60,15 @@
 from twisted.web import server, resource, static
 
 #------------------------------------------------------------------------------
 
 if __name__ == '__main__':
     import os.path as _p
     sys.path.insert(0, _p.abspath(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..')))
+    sys.path.insert(0, _p.abspath(_p.join(_p.dirname(_p.abspath(sys.argv[0])), '..', '..')))
 
 #------------------------------------------------------------------------------
 
 from bitdust.logs import lg
 
 from bitdust.system import bpio
 from bitdust.system import tmpfile
@@ -67,14 +76,16 @@
 from bitdust.automats import automat
 
 from bitdust.lib import strng
 from bitdust.lib import nameurl
 from bitdust.lib import misc
 from bitdust.lib import net_misc
 
+from bitdust.interface import web_html_template
+
 from bitdust.main import settings
 
 from bitdust.userid import identity
 from bitdust.userid import known_servers
 
 #------------------------------------------------------------------------------
 
@@ -89,28 +100,30 @@
     """
     global _IdServer
     if _IdServer is None:
         # set automat name and starting state here
         _IdServer = IdServer(
             name='id_server',
             state='AT_STARTUP',
-            debug_level=2,
-            log_events=True,
-            log_transitions=True,
+            debug_level=_DebugLevel,
+            log_events=_Debug,
+            log_transitions=_Debug,
         )
     if event is None:
         return _IdServer
     _IdServer.automat(event, *args, **kwargs)
 
 
 class IdServer(automat.Automat):
+
     """
     This class implements all the functionality of the ``id_server()`` state
     machine.
     """
+
     def init(self):
         """
         Method to initialize additional variables and flags at creation of the
         state machine.
         """
         self.web_listener = None
         self.tcp_listener = None
@@ -172,49 +185,58 @@
         Action method.
         """
         self.hostname = settings.getIdServerHost()
         if self.hostname == '':
             self.hostname = strng.to_bin(misc.readExternalIP())
         if self.hostname == '':
             self.hostname = net_misc.getLocalIp()
-        lg.out(4, 'id_server.doSetUp hostname=%s' % strng.to_text(self.hostname))
+        if _Debug:
+            lg.out(_DebugLevel, 'id_server.doSetUp hostname=%s' % strng.to_text(self.hostname))
         if not os.path.isdir(settings.IdentityServerDir()):
             os.makedirs(settings.IdentityServerDir())
-            lg.out(4, '            created a folder %s' % settings.IdentityServerDir())
+            if _Debug:
+                lg.out(_DebugLevel, '            created a folder %s' % settings.IdentityServerDir())
         root = WebRoot()
         root.putChild(b'', WebMainPage())
         try:
             self.tcp_listener = reactor.listenTCP(self.tcp_port, IdServerFactory())  # @UndefinedVariable
-            lg.out(4, '            identity server listen on TCP port %d started' % (self.tcp_port))
+            if _Debug:
+                lg.out(_DebugLevel, '            identity server listen on TCP port %d started' % (self.tcp_port))
         except:
-            lg.out(4, 'id_server.set_up ERROR exception trying to listen on port ' + str(self.tcp_port))
+            if _Debug:
+                lg.out(_DebugLevel, 'id_server.set_up ERROR exception trying to listen on port ' + str(self.tcp_port))
             lg.exc()
         try:
             self.web_listener = reactor.listenTCP(self.web_port, server.Site(root))  # @UndefinedVariable
-            lg.out(4, '            have started web server at port %d   hostname=%s' % (self.web_port, strng.to_text(self.hostname)))
+            if _Debug:
+                lg.out(_DebugLevel, '            have started web server at port %d   hostname=%s' % (self.web_port, strng.to_text(self.hostname)))
         except:
-            lg.out(4, 'id_server.set_up ERROR exception trying to listen on port ' + str(self.web_port))
+            if _Debug:
+                lg.out(_DebugLevel, 'id_server.set_up ERROR exception trying to listen on port ' + str(self.web_port))
             lg.exc()
 
     def doSetDown(self, *args, **kwargs):
         """
         Action method.
         """
-        lg.out(4, 'id_server.doSetDown')
+        if _Debug:
+            lg.out(_DebugLevel, 'id_server.doSetDown')
         shutlist = []
         if self.web_listener:
             d = self.web_listener.stopListening()
             if d:
                 shutlist.append(d)
-            lg.out(4, '            stopped web listener')
+            if _Debug:
+                lg.out(_DebugLevel, '            stopped web listener')
         if self.tcp_listener:
             d = self.tcp_listener.stopListening()
             if d:
                 shutlist.append(d)
-            lg.out(4, '            stopped TCP listener')
+            if _Debug:
+                lg.out(_DebugLevel, '            stopped TCP listener')
         self.web_listener = None
         self.tcp_listener = None
         DeferredList(shutlist).addBoth(lambda x: self.automat('server-down'))
 
     def doCheckAndSaveIdentity(self, *args, **kwargs):
         """
         Action method.
@@ -230,42 +252,48 @@
         _IdServer = None
         if args and args[0] and len(args[0]) > 0 and isinstance(args[0][-1], Deferred):
             args[0][-1].callback(True)
 
     def _save_identity(self, inputfilename):
         """
         """
-        lg.out(6, 'id_server._save_identity ' + inputfilename)
+        if _Debug:
+            lg.out(_DebugLevel, 'id_server._save_identity ' + inputfilename)
         if os.path.getsize(inputfilename) > 50000:
             lg.warn('input file too big - ignoring')
             tmpfile.erase('idsrv', inputfilename, 'input file too big')
             return
         newxml = bpio.ReadTextFile(inputfilename)
         if not newxml or len(newxml.strip()) < 500:
             lg.warn('input file too small - ignoring')
             tmpfile.erase('idsrv', inputfilename, 'input file too small')
             return
+        if not newxml.startswith('<?xml version="1.0" encoding="utf-8"?>'):
+            lg.warn('input file is not an XML - ignoring')
+            tmpfile.erase('idsrv', inputfilename, 'input file is not an XML')
+            return
         try:
             newidentity = identity.identity(xmlsrc=newxml)
         except:
-            lg.warn('input file is wrong - ignoring ')
+            lg.warn('input file is wrong - ignoring')
             tmpfile.erase('idsrv', inputfilename, 'input file is wrong')
             return
         tmpfile.erase('idsrv', inputfilename, 'id received')
         if not newidentity.isCorrect():
             lg.warn('has non-Correct identity')
             return
         if not newidentity.Valid():
             lg.warn('has non-Valid identity')
             return
         matchid = b''
         for idurl_bin in newidentity.getSources(as_originals=True):
             protocol, host, port, filename = nameurl.UrlParse(idurl_bin)
             if strng.to_text(host) == strng.to_text(self.hostname):
-                lg.out(4, 'id_server._save_identity found match for us')
+                if _Debug:
+                    lg.out(_DebugLevel, 'id_server._save_identity found match for us')
                 matchid = idurl_bin
                 break
         if not matchid:
             lg.warn('identity is not for this nameserver sources: %r' % newidentity.getSources(as_originals=True))
             return
         protocol, host, port, filename = nameurl.UrlParse(matchid)
         name, justxml = filename.split('.')
@@ -283,30 +311,33 @@
             if c not in settings.LegalUsernameChars():
                 lg.warn('identity name ' + filename)
                 return
         localfilename = os.path.join(settings.IdentityServerDir(), filename)
         oldxml = ''
         # need to make sure id was not already used by different key - which would mean someone is trying to steal identity
         if os.path.exists(localfilename):
-            lg.out(6, 'id_server._save_identity was already an identity with this name ' + localfilename)
+            if _Debug:
+                lg.out(_DebugLevel, 'id_server._save_identity was already an identity with this name ' + localfilename)
             oldxml = bpio.ReadTextFile(localfilename)
             oldidentity = identity.identity(xmlsrc=oldxml)
             if oldidentity.publickey != newidentity.publickey:
                 lg.warn('new public key does not match old ' + localfilename)
                 return
         if newxml != oldxml:
             if not os.path.exists(localfilename):
-                lg.out(6, 'id_server._save_identity will save NEW Identity: ' + filename)
+                if _Debug:
+                    lg.out(_DebugLevel, 'id_server._save_identity will save NEW Identity: ' + filename)
             bpio.WriteTextFile(localfilename, newxml)
 
 
 #------------------------------------------------------------------------------
 
 
 class IdServerProtocol(basic.Int32StringReceiver):
+
     def __init__(self):
         self.fpath = None  # string with path/filename
         self.fin = None  # integer file descriptor like os.open() returns
         self.received = 0
 
     def disconnect(self):
         try:
@@ -369,52 +400,49 @@
         """
 
 
 #------------------------------------------------------------------------------
 
 
 class IdServerFactory(ServerFactory):
+
     def buildProtocol(self, addr):
         p = IdServerProtocol()
         p.factory = self
         return p
 
 
 #------------------------------------------------------------------------------
 
 
 class WebMainPage(resource.Resource):
+
     def render_POST(self, request):
         inp = BytesIO(request.content.read())
         fin, fpath = tmpfile.make('idsrv', extension='.xml')
         inp_data = inp.read()
         inp.close()
         os.write(fin, inp_data)
         os.close(fin)
         A('incoming-identity-file', fpath)
         return ''
 
     def render_GET(self, request):
-        src = '''<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
-<html>
-<head>
-<title>Identities on %(hostname)s</title>
-<style>
-body{margin: 0 auto; padding: 0;}
-#content {margin: 0 auto; padding: 0; text-align: justify; line-height: 1.7;
-min-height: 500px; width: 960px; font-size: 18px; text-decoration: none;
-font-family: "Tw Cen MT", "Century Gothic", Futura, Arial, sans-serif;}
-</style>
-</head>
-<body>
-<div id="content">
-<h1 align=center>Identities on %(hostname)s</h1>
-''' % {
-            'hostname': strng.to_text(A().hostname),
-        }
+        src = ''
+
+        src += '<div id="ui-id-servers" class="section bg-light">\n'
+        src += '<div class="container">\n'
+        src += '<div class="ui-card">\n'
+        src += '<div class="card-body">\n'
+
+        src += '<div class="row justify-content-center">\n'
+        src += '<h1 align=center>Identities on %s</h1>' % strng.to_text(A().hostname)
+        src += '</div><br>\n'
+
+        src += '<div class="row">\n'
         src += '<table cellspacing=0 width=100% border=0><tr valign=top>\n'
         src += '<td width=152px nowrap>\n'
         HTDOCS_DIR = settings.IdentityServerDir()
         files = []
         if os.path.isdir(HTDOCS_DIR):
             for filename in os.listdir(HTDOCS_DIR):
                 filepath = os.path.join(HTDOCS_DIR, filename)
@@ -432,33 +460,51 @@
                 if charIndex % 4 == 3:
                     src += '\n</td>\n<td width=152px nowrap>\n'
                 charIndex += 1
                 src += '\n<br>\n<h3>%s</h3>\n' % str(currentChar).upper()
             url = '/' + filename
             name = filename[:-4]
             src += '<p><a href="%s"><nobr>%s</nobr></a></p>\n' % (strng.to_text(url), strng.to_text(name))
-        src += '</td>\n</tr>\n</table>\n</td>\n</tr>\n<tr><td align=left>'
+        src += '</td>\n</tr>\n</table>\n'
         src += '<br><br><p>Total identities on "%s": %d</p><br><br>\n' % (strng.to_text(A().hostname), len(files))
+        del files
         src += '<p>Other known identity servers:\n'
         for idhost in sorted(known_servers.by_host().keys()):
             idport = known_servers.by_host()[idhost][0]
             if idport != 80:
                 idhost += b':%d' % idport
             src += '<a href="http://%s/"><nobr>%s</nobr></a>&nbsp;&nbsp;\n' % (strng.to_text(idhost), strng.to_text(idhost))
         src += '</p>'
         src += '<!--CLIENT_HOST=%s:%s-->\n' % (request.client.host, request.client.port)
-        src += '</body>\n</html>'
-        del files
-        return strng.to_bin(src)
+        src += '</div>\n'
+        src += '</div>\n'
+        src += '</div>\n'
+        src += '</div>\n'
+        src += '</div>\n'
+
+        html_src = web_html_template.WEB_ROOT_TEMPLATE % dict(
+            title='Identities on %s' % strng.to_text(A().hostname),
+            site_url='https://bitdust.io',
+            basepath='https://identities.bitdust.io/',
+            wikipath='https://bitdust.io/wiki/',
+            idserverspath='https://identities.bitdust.io/',
+            blockchainpath='https://blockchain.bitdust.io/',
+            div_main_class='main idservers',
+            div_main_body=src,
+            google_analytics='',
+            pre_footer='',
+        )
+        return strng.to_bin(html_src)
 
 
 #------------------------------------------------------------------------------
 
 
 class WebRoot(resource.Resource):
+
     def getChild(self, path, request):
         if not path:
             return self
         try:
             path = strng.to_text(path)
         except:
             return resource.NoResource('Not found')
@@ -473,35 +519,111 @@
             return static.File(filepath)
         return resource.NoResource('Not found')
 
 
 #------------------------------------------------------------------------------
 
 
+class KnownIDServersWebRoot(resource.Resource):
+
+    def getChild(self, path, request):
+        if not path:
+            return self
+        return resource.NoResource('Not found')
+
+
+class KnownIDServersWebMainPage(resource.Resource):
+
+    def render_GET(self, request):
+        src = ''
+        src += '<div id="ui-blockchain-explorer" class="section bg-light">\n'
+        src += '<div class="container">\n'
+        src += '<div class="ui-card">\n'
+        src += '<div class="card-body">\n'
+
+        src += '<div class="row justify-content-center">\n'
+        src += '<h1 align=center>BitDust identity servers</h1>\n'
+        src += '</div><br>\n'
+
+        src += '<div class="row">\n'
+        for idhost in sorted(known_servers.by_host().keys()):
+            idport = known_servers.by_host()[idhost][0]
+            if idport != 80:
+                idhost += ':%d' % idport
+            src += '<div class="col-4">\n'
+            src += '<div class="ui-card ui-action-card ui-accordion shadow-sm" data-target="http://%s/">\n' % strng.to_text(idhost)
+            src += '<div class="card-body">\n'
+            src += '<h5 align=center><a class="card-link" href="http://%s/">%s</a></h5>\n' % (strng.to_text(idhost), strng.to_text(idhost))
+            src += '</div>\n'
+            src += '</div>\n'
+            src += '</div>\n'
+        src += '</div>\n'
+
+        src += '</div>\n'
+        src += '</div>\n'
+        src += '</div>\n'
+        src += '</div>\n'
+
+        html_src = web_html_template.WEB_ROOT_TEMPLATE % dict(
+            title='BitDust identity servers',
+            site_url='https://bitdust.io',
+            basepath='https://identities.bitdust.io/',
+            wikipath='https://bitdust.io/wiki/',
+            idserverspath='https://identities.bitdust.io/',
+            blockchainpath='https://blockchain.bitdust.io/',
+            div_main_class='main idservers',
+            div_main_body=src,
+            google_analytics='',
+            pre_footer=web_html_template.pre_footer % dict(basepath='https://identities.bitdust.io/'),
+        )
+        return strng.to_bin(html_src)
+
+
+def render_known_id_servers(web_port):
+    root = KnownIDServersWebRoot()
+    root.putChild(b'', KnownIDServersWebMainPage())
+    reactor.listenTCP(web_port, server.Site(root))  # @UndefinedVariable
+
+
+#------------------------------------------------------------------------------
+
+
 def main():
     bpio.init()
     settings.init()
+    lg.set_debug_level(_DebugLevel)
+
+    serve_known_id_servers = False
     if len(sys.argv) > 1:
-        web_port = int(sys.argv[1])
+        if sys.argv[1].strip() == 'known_id_servers':
+            serve_known_id_servers = True
+            web_port = settings.getIdServerWebPort()
+        else:
+            web_port = int(sys.argv[1])
     else:
         web_port = settings.getIdServerWebPort()
     if len(sys.argv) > 2:
         tcp_port = int(sys.argv[2])
     else:
         tcp_port = settings.getIdServerTCPPort()
-    lg.set_debug_level(20)
-    lg.out(2, 'starting ID server ...')
-    reactor.addSystemEventTrigger(  # @UndefinedVariable
-        'before',
-        'shutdown',
-        A().automat,
-        'shutdown',
-    )
-    reactor.callWhenRunning(A, 'init', (web_port, tcp_port))  # @UndefinedVariable
-    reactor.callLater(0, A, 'start')  # @UndefinedVariable
+
+    if serve_known_id_servers:
+        web_port = int(sys.argv[2])
+        lg.out(2, 'serving known ID servers web_port=%d' % web_port)
+        reactor.callWhenRunning(render_known_id_servers, web_port)  # @UndefinedVariable
+
+    else:
+        lg.out(2, 'starting ID server web_port=%d tcp_port=%d' % (
+            web_port,
+            tcp_port,
+        ))
+        reactor.addSystemEventTrigger('before', 'shutdown', A().automat, 'shutdown')  # @UndefinedVariable
+        reactor.callWhenRunning(A, 'init', (web_port, tcp_port))  # @UndefinedVariable
+        reactor.callLater(0, A, 'start')  # @UndefinedVariable
+
     reactor.run()  # @UndefinedVariable
     settings.shutdown()
     lg.out(2, 'reactor stopped, EXIT')
 
 
 #------------------------------------------------------------------------------
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/id_url.py` & `bitdust-0.1.9.241/bitdust/userid/identity.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 #!/usr/bin/python
-# id_url.py
+# identity.py
 #
 #
 # Copyright (C) 2008 Veselin Penev, https://bitdust.io
 #
-# This file (id_url.py) is part of BitDust Software.
+# This file (identity.py) is part of BitDust Software.
 #
 # BitDust is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # BitDust Software is distributed in the hope that it will be useful,
@@ -22,949 +22,1072 @@
 # Please contact us if you have any questions at bitdust.io@gmail.com
 #
 #
 #
 #
 #
 """
-.. module:: id_url.
+.. module:: identity.
 
 .. role:: red
 
 This is a core module.
 
-IDURL of your node can changed over time, see id_rotator() state machine which does that.
-So you must remember your "old" identity sources and store locally old IDURL's you had.
-This way when you receive a packet from another node which do not know your new IDURL yet,
-you can understand that he is actually trying to contact you and act properly.
-
-Also if you stored some packet for user A and then his IDURL changed you must still be able to
-correctly reply to him and send stored data back when he requests.
+Identity might better be called business card, since it is really
+mostly just your contact info. But more than that since public key.
+Hum.
+
+The whole idea of identity files is that they can be stored anywhere.
+User can decide to put his identity file on his own host, or he can use some another trusted public host.
+All identity files is signed with user's Key and client code should verify signatures.
+Even if someone tried to fake my identity - this will be refused by other nodes in the network.
+
+Example in http://seed.bitdust.io/veselin.xml
+
+Could have info just be XML on a web page.  So an Identity could be a URL.
+If we do this, then we get the scaling of DNS for free.
+
+BitDust could have mappings from unique short names to URLs for
+identities.  Or we could just make sure that the MD5 of the URL was
+always unique (this is 16 bytes).  Or we could go with the primary URL.
+Hum. BitDust does need some sort of unique identifier, as do others.
+Also, would be nice to be able to send someone a list of their
+current 64 nodes they use, or the 300 that use them, without
+crazy amounts of data.  For display
+of backup status I would like a unique identifier that is short,
+like 15 chars or something.  Can get main part of URLs that is
+short like that, say "id.ai/vince1".  Seems funny to limit the
+length of a URL like this, but we could as there will be
+identity servers and they can get very short names like id.ai.
+If we forced them all to be ".com/" we could display "id:vince1",
+or "cate:vince1", which is short.  The force could just be
+a lower rating for those that did not do this.  Could have
+short name take up 2 lines out of my 5, and just plan on
+letting user click on things to change what things are
+displayed.  So they have 5 lines and full URL takes 2,
+but last of URL is just 1 line, and maybe they don't
+care what the name is and just display other stuff.
+
+If we open it up a bit, people could just use tinyurl.com/foolksd
+if their URL was too long.  We could limit primary URL
+to 32 chars and not really have any trouble.  Can say it
+must start with http:// (so we don't have to store that)
+and be less than 32 chars after that.  If does not really
+start with http:// then tiny URL can fix that too.
+
+It is a bit like bittorrent using a .torrent file on the
+web to get the original start for things.  This seems good.
+
+All Identity/business-card info in XML:
+PublicKey
+primary URL for this identity (say https://cate.com/vinceID)
+backup URLs for this identity (maybe URLs) that secondary this identity
+contact: domain/port  pairs  (good even if IP out of date)
+contact: IP/port  pairs    (good even if DNS in trouble)
+contact: nat-traverser/ID pairs  (for those without fixed IPs)
+contact: emails for this identity (recommend people have one just in case)
+contact: http://foobar.com/data.pl    (use a web account to forward requests/data)
+scrubbers: URL1, URL2, URL3           (people who can access our data if we stop checking it)
+date
+version number
+revision number
+signature on all identity info
+
+Contact list has enough info we can tell what protocol to use.
+User could put in order he prefers us to try the contact methods.
+So we might have a list like:
+    tcp://123.45.67.89:9876
+    udp://user123@idserver456.com
+    http://123.45.67.89:8765
+
+Really best if all the identity servers use SSL.
+We could make certificates for identity servers, but might
+not bother as it is probably best if they have ones that
+web browsers understand.
+On the other hand, this might be a good way to get into the certificate-authority business. :-)
+
+Having XML on a web site means we can start before we
+really have identity server code.  Also means it is
+easy to grow and debug.
+
+As long as identity server is just some CGI that we can run on
+any ISP anywhere (pair.com etc), and users always use 3 identity servers,
+then we could just pop up as many as needed on ISPs all over
+the world as fast as we grew.  It would not be an infrastructure
+limitation really.  And we don't need to farm it out.
+Identity's are signed and have a revision number, so an identity
+server can pass on an update that it gets to other servers listed
+for that identity (in case there is network partition funnyness)
+to help keep all of them updated.
+
+But we really want actually people to run own identity servers and not rely on us.
+ID server is a first target to external hacker to attack actually if he wants to brake/block the network.
+Also ownership is important - 1000 servers owned by one company can be easily attacked via "legal/court" order.
+But 1000 servers owned and maintained by 1000 people in 100 different countries is completely different scenario.
+So more distribution of ID servers we will have in BitDust - more secured and protected network will become.
 """
 
 #------------------------------------------------------------------------------
 
 from __future__ import absolute_import
+from __future__ import print_function
+from six.moves import range  # @UnresolvedImport
 
 #------------------------------------------------------------------------------
 
 _Debug = False
-_DebugLevel = 12
+_DebugLevel = 10
 
 #------------------------------------------------------------------------------
 
 import os
 import sys
-import tempfile
+
+from xml.dom import minidom, Node
+from xml.dom.minidom import getDOMImplementation
 
 #------------------------------------------------------------------------------
 
-from bitdust.logs import lg
+try:
+    from bitdust.logs import lg
+except:
+    dirpath = os.path.dirname(os.path.abspath(sys.argv[0]))
+    sys.path.insert(0, os.path.abspath(os.path.join(dirpath, '..')))
+    from bitdust.logs import lg
+
+#------------------------------------------------------------------------------
+
+from bitdust.main import settings
 
 from bitdust.system import bpio
-from bitdust.system import local_fs
 
 from bitdust.lib import strng
 from bitdust.lib import nameurl
 
-from bitdust.main import settings
-
-#------------------------------------------------------------------------------
+from bitdust.crypt import key
 
-_IdentityHistoryDir = None
-# TODO: if this dictionary grow too much use CodernityDB instead of in-memory storage
-_KnownUsers = {}
-_KnownIDURLs = {}
-_MergedIDURLs = {}
-_KnownSources = {}
-_Ready = False
+from bitdust.userid import global_id
+from bitdust.userid import id_url
 
 #------------------------------------------------------------------------------
 
-
-def init():
-    global _IdentityHistoryDir
-    global _KnownUsers
-    global _KnownIDURLs
-    global _MergedIDURLs
-    global _KnownSources
-    global _Ready
-    from bitdust.userid import identity
-    if _Debug:
-        lg.out(_DebugLevel, 'id_url.init')
-    if not _IdentityHistoryDir:
-        _IdentityHistoryDir = settings.IdentityHistoryDir()
-    if not os.path.exists(_IdentityHistoryDir):
-        bpio._dir_make(_IdentityHistoryDir)
-        lg.info('created new folder %r' % _IdentityHistoryDir)
-    else:
-        lg.info('using existing folder %r' % _IdentityHistoryDir)
-    for_cleanup = []
-    for one_user_dir in os.listdir(_IdentityHistoryDir):
-        one_user_dir_path = os.path.join(_IdentityHistoryDir, one_user_dir)
-        one_user_identity_files = []
-        for one_filename in os.listdir(one_user_dir_path):
-            try:
-                one_ident_number = int(one_filename)
-            except:
-                lg.exc()
-                continue
-            one_user_identity_files.append(one_ident_number)
-        if _Debug:
-            lg.out(_DebugLevel, 'id_url.init   found %d historical records in %r' % (len(one_user_identity_files), one_user_dir_path))
-        one_user_identity_files.sort()
-        for one_ident_file in one_user_identity_files:
-            one_ident_path = os.path.join(one_user_dir_path, strng.to_text(one_ident_file))
-            try:
-                xmlsrc = local_fs.ReadTextFile(one_ident_path)
-                known_id_obj = identity.identity(xmlsrc=xmlsrc)
-                if not known_id_obj.isCorrect():
-                    raise Exception('identity history in %r is broken, identity is not correct: %r' % (one_user_dir, one_ident_path))
-                if not known_id_obj.Valid():
-                    raise Exception('identity history in %r is broken, identity is not valid: %r' % (one_user_dir, one_ident_path))
-            except Exception as exc:
-                lg.warn(str(exc))
-                for_cleanup.append(one_ident_path)
-                continue
-            one_pub_key = known_id_obj.getPublicKey()
-            one_revision = known_id_obj.getRevisionValue()
-            if one_pub_key not in _KnownUsers:
-                _KnownUsers[one_pub_key] = one_user_dir_path
-            known_sources = known_id_obj.getSources(as_originals=True)
-            for known_idurl in reversed(known_sources):
-                if known_idurl not in _KnownIDURLs:
-                    _KnownIDURLs[known_idurl] = known_id_obj.getPublicKey()
-                    if _Debug:
-                        lg.out(_DebugLevel, '    new IDURL added: %r' % known_idurl)
-                else:
-                    if _KnownIDURLs[known_idurl] != known_id_obj.getPublicKey():
-                        _KnownIDURLs[known_idurl] = known_id_obj.getPublicKey()
-                        lg.warn('another user had same identity source: %r' % known_idurl)
-                if one_pub_key not in _MergedIDURLs:
-                    _MergedIDURLs[one_pub_key] = {}
-                    if _Debug:
-                        lg.out(_DebugLevel, '    new Public Key added: %s...' % one_pub_key[-10:])
-                if one_revision in _MergedIDURLs[one_pub_key]:
-                    if _MergedIDURLs[one_pub_key][one_revision] != known_idurl:
-                        if _MergedIDURLs[one_pub_key][one_revision] not in known_sources:
-                            lg.warn('rewriting existing identity revision %d : %r -> %r' % (one_revision, _MergedIDURLs[one_pub_key][one_revision], known_idurl))
-                    _MergedIDURLs[one_pub_key][one_revision] = known_idurl
-                else:
-                    _MergedIDURLs[one_pub_key][one_revision] = known_idurl
-                    if _Debug:
-                        lg.out(_DebugLevel, '        revision %d merged with other %d known items' % (one_revision, len(_MergedIDURLs[one_pub_key])))
-                if one_pub_key not in _KnownSources:
-                    _KnownSources[one_pub_key] = []
-                for one_source in known_id_obj.getSources(as_originals=True):
-                    if one_source not in _KnownSources[one_pub_key]:
-                        _KnownSources[one_pub_key].append(one_source)
-                        if _Debug:
-                            lg.out(_DebugLevel, '    new source %r added for %r' % (one_source, one_pub_key[-10:]))
-    for one_ident_path in for_cleanup:
-        if os.path.isfile(one_ident_path):
-            lg.warn('about to erase broken historical identity file: %r' % one_ident_path)
-            try:
-                os.remove(one_ident_path)
-            except:
-                lg.exc()
-    _Ready = True
-
-
-def shutdown():
-    global _IdentityHistoryDir
-    global _KnownIDURLs
-    global _KnownUsers
-    global _Ready
-    global _MergedIDURLs
-    global _KnownSources
-    _IdentityHistoryDir = None
-    _KnownUsers.clear()
-    _KnownIDURLs.clear()
-    _MergedIDURLs.clear()
-    _KnownSources.clear()
-    _Ready = False
-
+default_identity_src = """<?xml version="1.0" encoding="ISO-8859-1"?>
+<identity>
+  <sources></sources>
+  <contacts></contacts>
+  <certificates></certificates>
+  <scrubbers></scrubbers>
+  <postage>1</postage>
+  <date></date>
+  <version></version>
+  <revision>0</revision>
+  <publickey></publickey>
+  <signature></signature>
+</identity>"""
 
 #------------------------------------------------------------------------------
 
 
-def known():
-    global _KnownIDURLs
-    return _KnownIDURLs
-
-
-def merged(pub_key=None):
-    global _MergedIDURLs
-    if pub_key is None:
-        return _MergedIDURLs
-    return _MergedIDURLs.get(pub_key, {})
-
-
-def users(pub_key=None):
-    global _KnownUsers
-    if pub_key is None:
-        return _KnownUsers
-    return _KnownUsers.get(pub_key, None)
-
-
-def sources(pub_key=None):
-    global _KnownSources
-    if pub_key is None:
-        return _KnownSources
-    return _KnownSources.get(pub_key, [])
-
-
-#------------------------------------------------------------------------------
-
+class identity(object):
 
-def identity_cached(new_id_obj):
     """
-    After receiving identity file of another user we need to check his identity sources.
-    I can be file from identity server or Identity() packet received directly from remote peer.
-    Also it can be my own identity that was changed locally.
-    In any case we need to take certain actions if those identity sources changed.
-    First identity source forms IDURL of that identity and act as unique global ID of that BitDust node.
-    When first identity source changed (because identity server went down) identity is "rotated":
-    second identity source will be placed on the first position and IDURL will change.
-    In that case we need to remember new IDURL and keep track of old IDURL of that user - this way we can
-    match and merge different IDURL's for one owner.
-    """
-    global _IdentityHistoryDir
-    global _KnownUsers
-    global _KnownIDURLs
-    global _MergedIDURLs
-    global _KnownSources
-    from bitdust.userid import identity
-    pub_key = new_id_obj.getPublicKey()
-    user_name = new_id_obj.getIDName()
-    if _Debug:
-        lg.args(_DebugLevel, user_name=user_name)
-    is_identity_rotated = False
-    latest_id_obj = None
-    latest_sources = []
-    for_cleanup = []
-    if pub_key not in _KnownUsers:
-        user_path = tempfile.mkdtemp(prefix=user_name + '@', dir=_IdentityHistoryDir)
-        _KnownUsers[pub_key] = user_path
-        first_identity_file_path = os.path.join(user_path, '0')
-        local_fs.WriteBinaryFile(first_identity_file_path, new_id_obj.serialize())
-        if _Debug:
-            lg.out(_DebugLevel, 'id_url.identity_cached wrote first item for user %r in identity history: %r' % (user_name, first_identity_file_path))
-    else:
-        user_path = _KnownUsers[pub_key]
-        user_identity_files = sorted(map(int, os.listdir(user_path)))
-        if len(user_identity_files) == 0:
-            lg.warn('identity history for user %r is broken, public key is known, but no identity files found' % user_name)
-        latest_identity_file_path = ''
-        latest_pub_key = None
-        latest_revision = -1
-        known_revisions = set()
-        for id_file in user_identity_files:
-            identity_file_path = os.path.join(user_path, strng.to_text(id_file))
-            xmlsrc = local_fs.ReadBinaryFile(identity_file_path)
-            one_id_obj = identity.identity(xmlsrc=xmlsrc)
-            if not one_id_obj.isCorrect():
-                lg.warn('identity history for user %r is broken, identity in the file %r is not correct' % (user_name, identity_file_path))
-                for_cleanup.append(identity_file_path)
-                continue
-            if not one_id_obj.Valid():
-                lg.warn('identity history for user %r is broken, identity in the file %r is not valid' % (user_name, identity_file_path))
-                for_cleanup.append(identity_file_path)
-                continue
-            if not latest_pub_key:
-                latest_pub_key = one_id_obj.getPublicKey()
-            if latest_pub_key != one_id_obj.getPublicKey():
-                lg.err('identity history for user %r is broken, public key not matching in the file %r' % (user_name, identity_file_path))
-                for_cleanup.append(identity_file_path)
-                continue
-            known_revisions.add(one_id_obj.getRevisionValue())
-            if one_id_obj.getRevisionValue() > latest_revision:
-                latest_revision = one_id_obj.getRevisionValue()
-                latest_identity_file_path = identity_file_path
-        xmlsrc = local_fs.ReadBinaryFile(latest_identity_file_path)
-        if xmlsrc:
-            latest_id_obj = identity.identity(xmlsrc=xmlsrc)
-            if latest_id_obj.getPublicKey() != new_id_obj.getPublicKey():
-                raise Exception('identity history for user %r is broken, public key not matching' % user_name)
-            if latest_id_obj.getIDName() != new_id_obj.getIDName():
-                lg.warn('found another user name in identity history for user %r : %r' % (user_name, latest_id_obj.getIDName()))
-            if new_id_obj.getRevisionValue() in known_revisions:
-                if _Debug:
-                    lg.out(_DebugLevel, 'id_url.identity_cached revision %d already known for user %r' % (new_id_obj.getRevisionValue(), user_name))
-            else:
-                latest_sources = latest_id_obj.getSources(as_originals=True)
-                new_sources = new_id_obj.getSources(as_originals=True)
-                if latest_sources == new_sources:
-                    local_fs.WriteBinaryFile(latest_identity_file_path, new_id_obj.serialize())
-                    if _Debug:
-                        lg.out(_DebugLevel, 'id_url.identity_cached latest identity sources for user %r did not changed, updated file %r' % (user_name, latest_identity_file_path))
-                else:
-                    next_identity_file = user_identity_files[-1] + 1
-                    next_identity_file_path = os.path.join(user_path, strng.to_text(next_identity_file))
-                    local_fs.WriteBinaryFile(next_identity_file_path, new_id_obj.serialize())
-                    is_identity_rotated = True
-                    if _Debug:
-                        lg.out(_DebugLevel, 'id_url.identity_cached identity sources for user %r changed, wrote new item in the history: %r' % (user_name, next_identity_file_path))
-    new_revision = new_id_obj.getRevisionValue()
-    new_sources = new_id_obj.getSources(as_originals=True)
-    for new_idurl in reversed(new_sources):
-        if new_idurl not in _KnownIDURLs:
-            _KnownIDURLs[new_idurl] = new_id_obj.getPublicKey()
-            if _Debug:
-                lg.out(_DebugLevel, 'id_url.identity_cached new IDURL added: %r' % new_idurl)
-        else:
-            if _KnownIDURLs[new_idurl] != new_id_obj.getPublicKey():
-                lg.warn('another user had same identity source: %r' % new_idurl)
-                _KnownIDURLs[new_idurl] = new_id_obj.getPublicKey()
-        if pub_key not in _MergedIDURLs:
-            _MergedIDURLs[pub_key] = {}
-            if _Debug:
-                lg.out(_DebugLevel, 'id_url.identity_cached new Public Key added: %s...' % pub_key[-10:])
-        prev_idurl = _MergedIDURLs[pub_key].get(new_revision, None)
-        if new_revision in _MergedIDURLs[pub_key]:
-            if _MergedIDURLs[pub_key][new_revision] != new_idurl:
-                if nameurl.GetName(_MergedIDURLs[pub_key][new_revision]) == nameurl.GetName(new_idurl):
-                    if _MergedIDURLs[pub_key][new_revision] not in new_sources:
-                        lg.warn('rewriting existing identity revision %d : %r -> %r' % (new_revision, _MergedIDURLs[pub_key][new_revision], new_idurl))
-            _MergedIDURLs[pub_key][new_revision] = new_idurl
-        else:
-            _MergedIDURLs[pub_key][new_revision] = new_idurl
-            if _Debug:
-                lg.out(_DebugLevel, 'id_url.identity_cached added new revision %d for user %r, total revisions %d: %r -> %r' % (new_revision, user_name, len(_MergedIDURLs[pub_key]), prev_idurl, new_idurl))
-    if pub_key not in _KnownSources:
-        _KnownSources[pub_key] = []
-    for one_source in new_sources:
-        if one_source not in _KnownSources[pub_key]:
-            _KnownSources[pub_key].append(one_source)
-            if _Debug:
-                lg.out(_DebugLevel, 'id_url.identity_cached added new source %r for user %r' % (one_source, user_name))
-    if _Debug:
-        lg.args(_DebugLevel, is_identity_rotated=is_identity_rotated, latest_id_obj=bool(latest_id_obj))
-    if is_identity_rotated and latest_id_obj is not None:
-        latest_revision = latest_id_obj.getRevisionValue()
-        if _Debug:
-            lg.args(_DebugLevel, new_revision=new_revision, latest_revision=latest_revision)
-        if new_revision > latest_revision:
-            lg.info('found rotated identity after caching %r -> %r' % (latest_id_obj.getSources(as_originals=True)[0], new_sources[0]))
-            from bitdust.main import events
-            events.send('identity-rotated', data=dict(
-                old_idurls=latest_id_obj.getSources(as_originals=True),
-                new_idurls=new_id_obj.getSources(as_originals=True),
-                old_revision=latest_id_obj.getRevisionValue(),
-                new_revision=new_revision,
-            ))
-            if latest_id_obj.getIDURL(as_original=True) != new_id_obj.getIDURL(as_original=True):
-                events.send('identity-url-changed', data=dict(
-                    old_idurl=latest_id_obj.getIDURL(as_original=True),
-                    new_idurl=new_id_obj.getIDURL(as_original=True),
-                    old_revision=latest_id_obj.getRevisionValue(),
-                    new_revision=new_revision,
-                ))
-            from bitdust.userid import my_id
-            if my_id.isLocalIdentityReady():
-                if my_id.getIDURL() == new_id_obj.getIDURL():
-                    # yapf: disable
-                    events.send('my-identity-rotated', data=dict(
-                        old_idurls=latest_id_obj.getSources(as_originals=True),
-                        new_idurls=new_id_obj.getSources(as_originals=True),
-                        old_revision=latest_id_obj.getRevisionValue(),
-                        new_revision=new_revision,
-                    ))
-                    # yapf: enable
-                    if latest_id_obj.getIDURL(as_original=True) != new_id_obj.getIDURL(as_original=True):
-                        # yapf: disable
-                        events.send('my-identity-url-changed', data=dict(
-                            old_idurl=latest_id_obj.getIDURL(as_original=True),
-                            new_idurl=new_id_obj.getIDURL(as_original=True),
-                            old_revision=latest_id_obj.getRevisionValue(),
-                            new_revision=new_revision,
-                        ))
-                        # yapf: enable
-        else:
-            lg.warn('cached out-dated revision %d for %r, most recent revision is %d' % (new_revision, new_sources[0], latest_revision))
-    else:
-        if _Debug:
-            lg.out(_DebugLevel, 'id_url.identity_cached revision %d for %r' % (new_revision, new_sources[0]))
-    for identity_file_path in for_cleanup:
-        if os.path.isfile(identity_file_path):
-            try:
-                os.remove(identity_file_path)
-            except:
-                lg.exc()
-    return True
-
+    We are passed an XML version of an identity and make an Identity. Also can
+    construct an Identity by providing all fields. The fields is:
 
-#------------------------------------------------------------------------------
+    * sources : list of URLs, first is primary URL and name
+    * contacts : list of ways to contact this identity
+    * certificates : signatures by identity servers
+    * scrubbers : list of URLs for people allowed to scrub
+    * postage : a price for message delivery if not on correspondents list
+    * date : the date an time when that identity was created
+    * version : a version string - some info about BitDust software and platform
+    * revision : every time identity were modified this value will be increased by 1
+    * publickey : the public part of user's key, string in twisted.conch.ssh format
+    * signature : digital signature to protect the file
+    """
+    sources = []  # list of URLs, first is primary URL and name
+    contacts = []  # list of ways to contact this identity
+    certificates = []  # signatures by identity servers
+    scrubbers = []  # list of URLs for people allowed to scrub
+    postage = b'1'  # a price for message delivery if not on correspondents list
+    date = b''  # date
+    version = b''  # version string
+    revision = b'0'  # revision number, every time my id were modified this value will be increased by 1
+    publickey = b''  # string in twisted.conch.ssh format
+    signature = b''  # digital signature
+
+    def __init__(self, sources=[], contacts=[], certificates=[], scrubbers=[], postage=b'1', date=b'', version=b'', revision=b'0', publickey=b'', xmlsrc=None, filename=b''):
+
+        self.sources = []
+        if sources:
+            self.setSources(sources)
+        self.contacts = contacts
+        self.certificates = certificates
+        self.scrubbers = scrubbers
+        self.postage = postage
+        self.date = date
+        self.version = version
+        self.revision = revision
+        self.publickey = publickey
 
-
-def field(idurl):
-    """
-    Translates string into `ID_URL_FIELD` object.
-    Also we try to read from local identity cache folder if do not know given "idurl".
-    """
-    global _KnownIDURLs
-    if isinstance(idurl, ID_URL_FIELD):
-        return idurl
-    if idurl in [None, 'None', '', b'None', b'', False]:
-        return ID_URL_FIELD(idurl)
-    idurl = strng.to_bin(idurl.strip())
-    if idurl not in _KnownIDURLs:
-        if _Debug:
-            lg.out(_DebugLevel, 'id_url.field   will try to find %r in local identity cache' % idurl)
-        from bitdust.contacts import identitydb
-        cached_ident = identitydb.get_ident(idurl)
-        if cached_ident:
-            identity_cached(cached_ident)
+        if publickey:
+            self.sign()
         else:
-            if _Debug:
-                cod = sys._getframe(1).f_back.f_code
-                modul = os.path.basename(cod.co_filename).replace('.py', '')
-                caller = cod.co_name
-                lg.warn('unknown yet idurl %s, call from %s.%s' % (idurl, modul, caller))
-    return ID_URL_FIELD(idurl)
-
+            self.signature = b''
+            # no point in signing if no public key listed, probably about to unserialize something
 
-def fields_list(idurl_list):
-    """
-    Same as `field()` but for lists.
-    """
-    return list(map(field, idurl_list))
+        if xmlsrc is not None:
+            self.unserialize(xmlsrc)
 
+        if filename:
+            self.unserialize(bpio.ReadTextFile(filename))
 
-def fields_dict(idurl_dict):
-    """
-    Translates dictionary keys into `ID_URL_FIELD` objects.
-    """
-    return {field(k): v for k, v in idurl_dict.items()}
-
-
-def is_idurl(value):
-    """
-    Return True if input is `ID_URL_FIELD` field or string in valid format.
-    """
-    if value in [None, 'None', '', b'None', b'', False]:
-        return False
-    if isinstance(value, ID_URL_FIELD):
+        if not xmlsrc and not filename:
+            self.default()
+
+    def __repr__(self, *args, **kwargs):
+        return object.__repr__(self, *args, **kwargs) + '[%s]' % self.makehash(hexdigest=True)
+
+    def clear_data(self):
+        """
+        Erase all fields data, clear identity.
+        """
+        self.sources = []  # list of URLs for fetching this identiy, first is primary URL and name - called IDURL
+        self.certificates = []  # identity servers each sign the source they are with - hash just (IDURL + publickey)
+        self.publickey = b''  # string
+        self.contacts = []  # list of ways to contact this identity
+        self.scrubbers = []  # list of URLs for people allowed to scrub
+        self.date = b''  # date
+        self.postage = b'1'  # postage price for message delivery if not on correspondents list
+        self.version = b''  # version string
+        self.signature = b''  # digital signature
+        self.revision = b'0'  # revision number
+
+    def default(self):
+        """
+        Set a "blank" identity.
+        """
+        global default_identity_src
+        self.unserialize(default_identity_src)
+
+    #------------------------------------------------------------------------------
+
+    def isCorrect(self):
+        """
+        Do some checking on the object fields.
+        """
+        if len(self.contacts) == 0:
+            return False
+        if len(self.sources) == 0:
+            return False
+        if not self.publickey:
+            return False
+        if not self.signature:
+            return False
+        if not self.revision:
+            return False
+        original_sources = self.getSources(as_originals=True)
+        if len(set(original_sources)) != len(self.sources):
+            lg.warn('original identity sources are duplicated: %r' % original_sources)
+            return False
+        if len(original_sources) > settings.MaximumIdentitySources():
+            lg.warn('too much sources')
+            return False
+        if len(original_sources) < settings.MinimumIdentitySources():
+            lg.warn('too few sources')
+            return False
+        try:
+            int(self.revision)
+        except:
+            lg.warn('identity revision: %s' % self.revision)
+            return False
+        names = set()
+        for source in original_sources:
+            if not source:
+                lg.warn('found empty source')
+                return False
+            proto, host, port, filename = nameurl.UrlParse(source)
+            if filename.count('/'):
+                lg.warn('incorrect identity name: %s' % filename)
+                return False
+            name, justxml = filename.split('.')
+            names.add(name)
+            # SECURITY check that name is simple
+            if justxml != 'xml':
+                lg.warn('incorrect identity name: %s' % filename)
+                return False
+            if len(name) > settings.MaximumUsernameLength():
+                lg.warn('incorrect identity name: %s' % filename)
+                return False
+            if len(name) < settings.MinimumUsernameLength():
+                lg.warn('incorrect identity name: %s' % filename)
+                return False
+            for c in name:
+                if c not in settings.LegalUsernameChars():
+                    lg.warn('incorrect identity name: %s' % filename)
+                    return False
+        if len(names) > 1:
+            lg.warn('names are not consistent: %s' % str(names))
+            return False
         return True
-    if not strng.is_string(value):
-        return False
-    v = strng.to_text(value)
-    if not v.startswith('http') or not v.endswith('.xml') or v.count('://') != 1:
-        return False
-    return True
-
-
-def to_bin(idurl):
-    """
-    Translates `ID_URL_FIELD` to binary string.
-    """
-    if isinstance(idurl, ID_URL_FIELD):
-        return idurl.to_bin()
-    if idurl in [None, 'None', '', b'None', b'', False]:
-        return b''
-    return strng.to_bin(idurl)
-
-
-def to_original(idurl):
-    """
-    Translates `ID_URL_FIELD` to binary string, but returns its original value.
-    """
-    if isinstance(idurl, ID_URL_FIELD):
-        return idurl.original()
-    if idurl in [None, 'None', '', b'None', b'', False]:
-        return b''
-    return strng.to_bin(idurl)
-
-
-def to_list(iterable_object, as_field=True, as_bin=False, as_original=False):
-    """
-    Creates list of desired objects from given `iterable_object`.
-    """
-    if not iterable_object:
-        return iterable_object
-    if as_original:
-        return list(map(to_original, iterable_object))
-    if as_field:
-        return list(map(field, iterable_object))
-    if as_bin:
-        return list(map(to_bin, iterable_object))
-    return list(map(strng.to_text, iterable_object))
-
-
-def to_bin_list(iterable_object):
-    """
-    Just an alias for to_list().
-    """
-    if not iterable_object:
-        return iterable_object
-    return to_list(iterable_object, as_field=False, as_bin=True)
-
-
-def to_original_list(iterable_object):
-    """
-    Just an alias for to_list() to extract original values from idurl's.
-    """
-    if not iterable_object:
-        return iterable_object
-    return to_list(iterable_object, as_original=True)
-
-
-def to_bin_dict(idurl_dict):
-    """
-    Translates dictionary keys into binary strings if they were `ID_URL_FIELD` objects.
-    """
-    return {to_bin(k): v for k, v in idurl_dict.items()}
 
+    def makehash(self, hexdigest=False):
+        """
+        http://docs.python.org/lib/module-urlparse.html Note that certificates
+        and signatures are not part of what is hashed. PREPRO Thinking of
+        standard that fields have labels and empty fields are left out,
+        including label, so future versions could have same signatures as older
+        which had fewer fields - can just do this for fields after these, so
+        maybe don't need to change anything for now.
+        Don't include certificate - so identity server can just add it.
+        """
+        sep = b'-'
+        hsh = b''
+        hsh += sep + sep.join(map(lambda s: s.original(), self.sources))
+        hsh += sep + sep.join(self.contacts)
+        # hsh += sep + sep.join(self.certificates)
+        hsh += sep + sep.join(self.scrubbers)
+        hsh += sep + self.postage
+        hsh += sep + self.date.replace(b' ', b'_')
+        hsh += sep + self.version
+        hsh += sep + self.revision
+        # lg.out(12, "identity.makehash: %r" % hsh)
+        hashcode = key.Hash(hsh, hexdigest=hexdigest)
+        return hashcode
+
+    def sign(self):
+        """
+        Make a hash, generate digital signature on it and remember the
+        signature.
+        """
+        hashcode = self.makehash()
+        self.signature = key.Sign(hashcode)
+        if not self.Valid():
+            lg.warn('identity is not valid after making sign!')
+            raise Exception('identity sign fails')
+
+    def Valid(self):
+        """
+        This will make a hash and verify the signature by public key.
+
+        PREPRO - should test certificate too.
+        """
+        # print('Valid %r' % self.signature)
+        hashcode = self.makehash()
+        result = key.VerifySignature(
+            self.publickey,
+            hashcode,
+            self.signature,
+        )
+        return result
 
-def is_in(idurl, iterable_object, as_field=True, as_bin=False):
-    """
-    Equivalent of `idurl in iterable_object`.
-    Because it can be that you need to compare not `ID_URL_FIELD` objects in memory but normal strings.
-    So then you will prefer to avoid translating into field object.
-    """
-    if not iterable_object:
-        return False
-    if as_field:
-        return field(idurl) in fields_list(iterable_object)
-    if as_bin:
-        return to_bin(idurl) in to_bin_list(iterable_object)
-    return strng.to_text(idurl) in to_list(iterable_object, as_field=False, as_bin=False)
+    #------------------------------------------------------------------------------
 
+    def encrypt(self, inp):
+        """
+        Encrypt some `inp` data with public key from this identity object.
+        You can use this method to send a private messages addressed to the owner of this identity.
+        """
+        return key.EncryptOpenSSHPublicKey(self.publickey, inp)
+
+    def decrypt(self, inp, private_key=None):
+        """
+        Decrypt `inp` data with private key provided (callable, key_id or openssh format).
+        When `private_key` is not provided will decrypt using my own "master" key.
+        """
+        if private_key is None:
+            return key.DecryptLocalPrivateKey(inp)
+        if callable(private_key):
+            return private_key(inp)
+        from bitdust.crypt import my_keys
+        if my_keys.is_valid_key_id(private_key):
+            return my_keys.decrypt(private_key, inp)
+        return key.DecryptOpenSSHPrivateKey(private_key, inp)
+
+    #------------------------------------------------------------------------------
+
+    def unserialize(self, xmlsrc):
+        """
+        A smart method to load object fields data from XML content.
+        """
+        try:
+            doc = minidom.parseString(strng.to_bin(xmlsrc))
+        except:
+            lg.warn('failed reading identity source from %d bytes' % len(strng.to_bin(xmlsrc)))
+            return
+        self.clear_data()
+        self.from_xmlobj(doc.documentElement)
+
+    def unserialize_object(self, xmlobject):
+        """
+        This is almost same but load data from existing DOM object.
+        """
+        self.clear_data()
+        self.from_xmlobj(xmlobject)
+
+    def unserialize_json(self, json_data):
+        """
+        This loads data from Python dictionary.
+        """
+        self.clear_data()
+        self.setSources(json_data['sources'])
+        self.setContacts(json_data['contacts'])
+        self.setCertificates(json_data['certificates'])
+        self.setScrubbers(json_data['scrubbers'])
+        self.setDate(json_data['date'])
+        self.setPostage(json_data['postage'])
+        self.setVersion(json_data['version'])
+        self.setRevision(json_data['version'])
+        self.setPublicKey(json_data['publickey'])
+        self.setSignature(json_data['signature'])
+
+    def serialize(self, as_text=False):
+        """
+        A method to generate XML content for that identity object.
+
+        Used to save identity on disk or transfer over network.
+        """
+        if as_text:
+            return strng.to_text(self.toxml()[0].strip())
+        return self.toxml()[0].strip()
+
+    def serialize_object(self):
+        """
+        Almost the same but return a DOM object.
+        """
+        return self.toxml()[1]
+
+    def serialize_json(self):
+        """
+        A method to generate JSON dictionary for that identity object.
+
+        Used to represent identity in API methods.
+        """
+        return {
+            'name': self.getIDName(),
+            'idurl': strng.to_text(self.getIDURL().original()),
+            'global_id': global_id.MakeGlobalID(idurl=self.getIDURL().original()),
+            'sources': [strng.to_text(i) for i in self.getSources(as_originals=True)],
+            'contacts': [strng.to_text(i) for i in self.getContacts()],
+            'certificates': [strng.to_text(i) for i in self.certificates],
+            'scrubbers': [strng.to_text(i) for i in self.scrubbers],
+            'postage': strng.to_text(self.postage),
+            'date': strng.to_text(self.date),
+            'version': strng.to_text(self.version),
+            'revision': strng.to_text(self.revision),
+            'publickey': strng.to_text(self.publickey),
+            'signature': strng.to_text(self.signature),
+        }
+
+    def toxml(self):
+        """
+        Call this to convert to XML format.
+        """
+        impl = getDOMImplementation()
+
+        doc = impl.createDocument(None, 'identity', None)
+        root = doc.documentElement
+
+        sources = doc.createElement('sources')
+        root.appendChild(sources)
+        for source in self.sources:
+            n = doc.createElement('source')
+            n.appendChild(doc.createTextNode(strng.to_text(source.original())))
+            sources.appendChild(n)
+
+        contacts = doc.createElement('contacts')
+        root.appendChild(contacts)
+        for contact in self.contacts:
+            n = doc.createElement('contact')
+            n.appendChild(doc.createTextNode(strng.to_text(contact)))
+            contacts.appendChild(n)
+
+        certificates = doc.createElement('certificates')
+        root.appendChild(certificates)
+        for certificate in self.certificates:
+            n = doc.createElement('certificate')
+            n.appendChild(doc.createTextNode(strng.to_text(certificate)))
+            certificates.appendChild(n)
+
+        scrubbers = doc.createElement('scrubbers')
+        root.appendChild(scrubbers)
+        for scrubber in self.scrubbers:
+            n = doc.createElement('scrubber')
+            n.appendChild(doc.createTextNode(strng.to_text(scrubber)))
+            scrubbers.appendChild(n)
+
+        postage = doc.createElement('postage')
+        postage.appendChild(doc.createTextNode(strng.to_text(self.postage)))
+        root.appendChild(postage)
+
+        date = doc.createElement('date')
+        date.appendChild(doc.createTextNode(strng.to_text(self.date)))
+        root.appendChild(date)
+
+        version = doc.createElement('version')
+        version.appendChild(doc.createTextNode(strng.to_text(self.version)))
+        root.appendChild(version)
+
+        revision = doc.createElement('revision')
+        revision.appendChild(doc.createTextNode(strng.to_text(self.revision)))
+        root.appendChild(revision)
+
+        publickey = doc.createElement('publickey')
+        publickey.appendChild(doc.createTextNode(strng.to_text(self.publickey)))
+        root.appendChild(publickey)
+
+        signature = doc.createElement('signature')
+        signature.appendChild(doc.createTextNode(strng.to_text(self.signature)))
+        root.appendChild(signature)
+
+        xmlsrc = doc.toprettyxml(indent='  ', newl='\n', encoding='utf-8')
+        return xmlsrc, root, doc
+
+    def from_xmlobj(self, root_node):
+        """
+        This is to load identity fields from DOM object - used during ``unserialize`` procedure.
+        """
+        for xsection in root_node.childNodes:
+            if xsection.nodeType != Node.ELEMENT_NODE:
+                continue
+            if xsection.tagName == 'sources':
+                for xsources in xsection.childNodes:
+                    for xsource in xsources.childNodes:
+                        if (xsource.nodeType == Node.TEXT_NODE):
+                            self.sources.append(id_url.ID_URL_FIELD(xsource.wholeText.strip()))
+                            break
+            elif xsection.tagName == 'contacts':
+                for xcontacts in xsection.childNodes:
+                    for xcontact in xcontacts.childNodes:
+                        if (xcontact.nodeType == Node.TEXT_NODE):
+                            self.contacts.append(strng.to_bin(xcontact.wholeText.strip()))
+                            break
+            elif xsection.tagName == 'certificates':
+                for xcertificates in xsection.childNodes:
+                    for xcertificate in xcertificates.childNodes:
+                        if (xcertificate.nodeType == Node.TEXT_NODE):
+                            self.certificates.append(strng.to_bin(xcertificate.wholeText.strip()))
+                            break
+            elif xsection.tagName == 'scrubbers':
+                for xscrubbers in xsection.childNodes:
+                    for xscrubber in xscrubbers.childNodes:
+                        if (xscrubber.nodeType == Node.TEXT_NODE):
+                            self.scrubbers.append(strng.to_bin(xscrubber.wholeText.strip()))
+                            break
+            elif xsection.tagName == 'postage':
+                for xpostage in xsection.childNodes:
+                    if (xpostage.nodeType == Node.TEXT_NODE):
+                        self.postage = strng.to_bin(xpostage.wholeText.strip())
+                        break
+            elif xsection.tagName == 'date':
+                for xkey in xsection.childNodes:
+                    if (xkey.nodeType == Node.TEXT_NODE):
+                        self.date = strng.to_bin(xkey.wholeText.strip())
+                        break
+            elif xsection.tagName == 'version':
+                for xkey in xsection.childNodes:
+                    if (xkey.nodeType == Node.TEXT_NODE):
+                        self.version = strng.to_bin(xkey.wholeText.strip())
+                        break
+            elif xsection.tagName == 'revision':
+                for xkey in xsection.childNodes:
+                    if (xkey.nodeType == Node.TEXT_NODE):
+                        self.revision = strng.to_bin(xkey.wholeText.strip())
+                        break
+            elif xsection.tagName == 'publickey':
+                for xkey in xsection.childNodes:
+                    if (xkey.nodeType == Node.TEXT_NODE):
+                        self.publickey = strng.to_bin(xkey.wholeText.strip())
+                        break
+            elif xsection.tagName == 'signature':
+                for xkey in xsection.childNodes:
+                    if (xkey.nodeType == Node.TEXT_NODE):
+                        self.signature = strng.to_bin(xkey.wholeText.strip())
+                        break
+
+    #------------------------------------------------------------------------------
+
+    def getSources(self, as_fields=True, as_originals=False):
+        """
+        Return identity sources.
+        """
+        if as_originals:
+            return id_url.to_original_list(self.sources)
+        if not as_fields:
+            return id_url.to_bin_list(self.sources)
+        return self.sources
+
+    def getIDURL(self, index=0, as_field=True, as_original=False):
+        """
+        Return a source IDURL - this is a user ID.
+        Must have at least one IDURL in the ``sources``.
+        """
+        result = self.sources[index]
+        if as_original:
+            return result.original()
+        if not as_field:
+            return result.to_bin()
+        return result
 
-def is_not_in(idurl, iterable_object, as_field=True, as_bin=False):
-    """
-    Vise-versa of `is_in()` method.
-    """
-    return not is_in(idurl=idurl, iterable_object=iterable_object, as_field=as_field, as_bin=as_bin)
+    def getIDName(self, index=0):
+        """
+        Return an account name - this is just a user name taken from IDURL:
+            "veselin" for "http://id.bitdust.io/veselin.xml"
+        """
+        protocol, host, port, filename = nameurl.UrlParse(self.getIDURL(index))
+        return filename.strip()[0:-4]
+
+    def getIDHost(self, index=0):
+        """
+        Return a server host name where that identity is stored:
+        "id.bitdust.io" for "http://id.bitdust.io/veselin.xml".
+        """
+        protocol, host, port, filename = nameurl.UrlParse(self.getIDURL(index))
+        if port:
+            host += ':' + str(port)
+        return host
+
+    def getContacts(self):
+        """
+        Return identity contacts list.
+        """
+        return self.contacts
+
+    def getContactsNumber(self):
+        """
+        Return identity contacts number.
+        """
+        return len(self.contacts)
+
+    def getContact(self, index=0):
+        """
+        Return a contact with given ``index`` number or None.
+        """
+        try:
+            return self.contacts[index]
+        except:
+            return None
 
+    def getContactHost(self, index=0):
+        """
+        Get the host name part of the contact.
+        """
+        protocol, host, port, filename = nameurl.UrlParse(self.contacts[index])
+        return host
+
+    def getContactPort(self, index=0):
+        """
+        Get the port part of the contact.
+        """
+        protocol, host, port, filename = nameurl.UrlParse(self.contacts[index])
+        return port
+
+    def getContactParts(self, index=0):
+        """
+        Return tuple with 4 parts of the contact: (proto, host, port, filename)
+        """
+        return nameurl.UrlParse(self.contacts[index])
+
+    def getProtoParts(self, proto):
+        """
+        See ``getProtoContact``, return a tuple for given ``proto``: (proto,
+        host, port, filename)
+        """
+        contact = self.getProtoContact(proto)
+        if contact is None:
+            return None, None, None, None
+        return nameurl.UrlParse(contact)
+
+    def getProtoHost(self, proto, default=None):
+        """
+        See ``getProtoParts``, return a host of a contact with given ``proto``.
+        """
+        protocol, host, port, filename = self.getProtoParts(proto)
+        if host is None:
+            return default
+        return host
+
+    def getContactIndex(self, proto='', host='', contact=''):
+        """
+        Search a first contact with given conditions.
+        """
+        for i in range(0, len(self.contacts)):
+            c = strng.to_bin(self.contacts[i])
+            if proto:
+                if c.find(strng.to_bin(proto) + b'://') == 0:
+                    return i
+            if host:
+                if c.find(b'://' + strng.to_bin(host)) == 0:
+                    return i
+            if contact:
+                if c == strng.to_bin(contact):
+                    return i
+        return -1
+
+    def getProtoContact(self, proto):
+        """
+        Search for first found contact with given ``proto``.
+
+        Return None if not found a contact.
+        """
+        for contact in self.contacts:
+            if contact.startswith(strng.to_bin(proto) + b'://'):
+                return contact
+        return None
 
-def get_from_dict(idurl, dict_object, default=None, as_field=True, as_bin=False):
-    """
-    Equivalent of `{<some dict>}.get(idurl, default)`.
-    Because it can be that you need to keep not `ID_URL_FIELD` objects in your dictionary but a normal strings.
-    So then you will prefer to avoid translating into field object.
-    """
-    if as_field:
-        return dict_object.get(field(idurl), default)
-    if as_bin:
-        return dict_object.get(to_bin(idurl), default)
-    return dict_object.get(strng.to_text(idurl), default)
+    def getProtoOrder(self):
+        """
+        Return a list of "proto" parts of all contacts. In other words return a
+        list of all supported protocols.
+
+        This keeps the order of the protos - this is a sort of priority of the transports.
+        """
+        orderL = []
+        for c in self.contacts:
+            proto, host, port, filename = nameurl.UrlParse(c)
+            orderL.append(proto)
+        return orderL
+
+    def getContactsAsTuples(self, as_text=False):
+        """
+        """
+        result = []
+        for c in self.contacts:
+            proto, host = c.split(b'://')
+            if as_text:
+                result.append((strng.to_text(proto), strng.to_text(host)))
+            else:
+                result.append((proto, host))
+        return result
 
+    def getContactsByProto(self):
+        """
+        Return a dictionary of all contacts where keys are protos.
+        """
+        d = {}
+        for i in range(len(self.contacts)):
+            proto, x, x, x = nameurl.UrlParse(self.contacts[i])
+            d[proto] = self.contacts[i]
+        return d
+
+    def getContactProto(self, index):
+        """
+        Return a proto part of the contact at given position.
+        """
+        c = self.getContact(index)
+        if c is None:
+            return None
+        return nameurl.UrlParse(c)[0]
+
+    def getPublicKey(self):
+        """
+        Returns public key as binary string.
+        """
+        return self.publickey
+
+    def getSignature(self):
+        """
+        Returns signature as binary string.
+        """
+        return self.signature
+
+    def getIP(self, proto=None):
+        """
+        A smart way to get the IP address of the user.
+
+        Check TCP proto if available and get host from contact.
+        """
+        if proto:
+            host = self.getProtoHost(proto)
+            if host:
+                return host
+        return self.getProtoHost('tcp')
+
+    def getDateStr(self):
+        """
+        Returns identity creation date as string.
+        """
+        return strng.to_text(self.date)
+
+    def getPostageValue(self):
+        """
+        Returns price for message delivery if not on correspondents list.
+        Not used at the moment.
+        """
+        return int(self.postage)
+
+    def getVersionStr(self):
+        """
+        Returns a version string - some info about BitDust software and platform.
+        Just informative thing, no real logic around it yet.
+        """
+        return strng.to_text(self.version)
+
+    def getRevisionValue(self):
+        """
+        Returns identity revision number.
+        Every time identity changes, identity must increment by one.
+        """
+        return int(self.revision)
+
+    #------------------------------------------------------------------------------
+
+    def setSources(self, sources_list):
+        """
+        """
+        self.sources = []
+        for source in sources_list:
+            s = id_url.field(source)
+            s.refresh()
+            self.sources.append(s)
+
+    def setContacts(self, contacts_list):
+        """
+        """
+        self.contacts = []
+        for cont in contacts_list:
+            self.contacts.append(strng.to_bin(cont))
+
+    def setContactsFromDict(self, contacts_dict, contacts_order=None):
+        """
+        """
+        if contacts_order is None:
+            contacts_order = list(contacts_dict.keys())
+        for proto in contacts_order:
+            self.contacts.append(strng.to_bin(contacts_dict[proto]))
+
+    def setContact(self, contact, index):
+        """
+        Set a string value ``contact`` at given ``index`` position in the list.
+        """
+        try:
+            self.contacts[index] = strng.to_bin(contact)
+        except:
+            lg.exc()
 
-def is_cached(idurl):
-    """
-    Return True if given identity was already cached - that means I know his public key.
-    """
-    global _KnownIDURLs
-    if isinstance(idurl, ID_URL_FIELD):
-        idurl = idurl.to_bin()
+    def setProtoContact(self, proto, contact):
+        """
+        Found a contact with given ``proto`` and set its value or append a new
+        contact.
+        """
+        for i in range(0, len(self.contacts)):
+            proto_, _, _, _ = nameurl.UrlParse(self.contacts[i])
+            if proto_.strip() == strng.to_bin(proto).strip():
+                self.contacts[i] = strng.to_bin(contact)
+                return
+        self.contacts.append(strng.to_bin(contact))
+
+    def setContactParts(self, index, protocol, host, port, filename):
+        """
+        Set a contact at given position by its 4 parts.
+        """
+        url = nameurl.UrlMake(protocol, host, port, filename)
+        self.contacts[index] = strng.to_bin(url).strip()
+
+    def setContactHost(self, host, index):
+        """
+        This is to set only host part of the contact.
+        """
+        protocol, _, port, filename = nameurl.UrlParse(self.contacts[index])
+        url = nameurl.UrlMake(protocol, host, port, filename)
+        self.contacts[index] = strng.to_bin(url).strip()
+
+    def setContactPort(self, index, newport):
+        """
+        This is useful when listening port get changed.
+        """
+        protocol, host, _, filename = nameurl.UrlParse(self.contacts[index])
+        url = nameurl.UrlMake(protocol, host, newport, filename)
+        self.contacts[index] = strng.to_bin(url).strip()
+
+    def setPublicKey(self, pub_key_raw):
+        """
+        """
+        self.publickey = strng.to_bin(pub_key_raw)
+
+    def setSignature(self, signature_raw):
+        """
+        """
+        self.signature = strng.to_bin(signature_raw)
+
+    def setCertificates(self, certificates_list):
+        """
+        Not used yet.
+        """
+        self.certificates = []
+        for cert in certificates_list:
+            self.certificates.append(strng.to_bin(cert))
+
+    def setScrubbers(self, scrubbers_list):
+        """
+        Not used yet.
+        """
+        self.scrubbers = []
+        for scrub in scrubbers_list:
+            self.scrubbers.append(strng.to_bin(scrub))
+
+    def setDate(self, date_string):
+        """
+        """
+        self.date = strng.to_bin(date_string)
+
+    def setPostage(self, postage_value):
+        """
+        """
+        self.postage = strng.to_bin(str(postage_value))
+
+    def setVersion(self, version_string):
+        """
+        """
+        self.version = strng.to_bin(version_string).strip()
+
+    def setRevision(self, revision):
+        """
+        """
+        self.revision = strng.to_bin(str(revision))
+
+    #------------------------------------------------------------------------------
+
+    def clearContacts(self):
+        """
+        Erase all items in identity contacts list.
+        """
+        self.contacts = []
+
+    def deleteProtoContact(self, proto):
+        """
+        Remove all contacts with given ``proto``.
+        """
+        for contact in self.contacts:
+            if contact.find(strng.to_bin(proto) + b'://') == 0:
+                self.contacts.remove(contact)
+
+    def pushProtoContact(self, proto):
+        """
+        Move given protocol in the bottom of the contacts list.
+
+        First contact in the list have more priority for remote machine,
+        so we can manipulate our protos to get more p2p connections.
+        Push less reliable protocols to the end of the list. This is to
+        decrease its priority.
+        """
+        i = self.getContactIndex(proto=proto)
+        if i < 0:
+            return
+        contact = self.contacts[i]
+        del self.contacts[i]
+        self.contacts.append(contact)
+
+    def popProtoContact(self, proto):
+        """
+        Move given protocol to the top of the contacts list.
+
+        This is to increase its priority.
+        """
+        i = self.getContactIndex(proto=proto)
+        if i < 0:
+            return
+        contact = self.contacts[i]
+        del self.contacts[i]
+        self.contacts.insert(0, contact)
+
+
+#-------------------------------------------------------------------------------
+
+
+def test1():
+    """
+    Some tests.
+    """
+    from bitdust.userid import my_id
+    myidentity = my_id.getLocalIdentity()
+    print('getIP =', myidentity.getIP())
+    if myidentity.Valid():
+        print('myidentity is Valid!!!!')
     else:
-        idurl = strng.to_bin(idurl)
-    cached = idurl in _KnownIDURLs
-    if not cached:
-        if _Debug:
-            lg.args(_DebugLevel, idurl=idurl, cached=cached)
-    return cached
-
+        print('myidentity is not Valid')
+        my_id.saveLocalIdentity()  # sign and save
+        raise Exception('myidentity is not Valid')
+    print('myidentity.contacts')
+    print(myidentity.contacts)
+    print('len myidentity.contacts ')
+    print(len(myidentity.contacts))
+    print('len myidentity.contacts[0] ')
+    print(myidentity.contacts[0])
+    con = myidentity.getContact()
+    print('con:', con, type(con))
+    protocol, machine, port, filename = nameurl.UrlParse(con)
+    print(protocol, machine, port, filename)
+    print('identity.main serialize:\n', myidentity.serialize())
+    for index in range(myidentity.getContactsNumber()):
+        proto, host, port, filename = myidentity.getContactParts(index)
+        print('[%s] [%s] [%s] [%s]' % (proto, host, port, filename))
+
+
+def test2():
+    """
+    More tests.
+    """
+    from bitdust.userid import my_id
+    ident = my_id.buildDefaultIdentity()
+    print(ident.serialize())
 
-def is_empty(idurl):
-    """
-    Return True if given input is None, empty string or empty ID_URL_FIELD object.
-    """
-    if isinstance(idurl, ID_URL_FIELD):
-        return not bool(idurl)
-    if idurl in [None, 'None', '', b'None', b'', False]:
-        return True
-    return not bool(idurl)
-
-
-def is_some_empty(iterable_object):
-    """
-    Returns True if given iterable_object contains some empty idurl field.
-    """
-    return is_in(ID_URL_FIELD(b''), iterable_object=iterable_object, as_field=True, as_bin=False)
 
-
-def is_the_same(idurl1, idurl2):
-    """
-    Compares two ID_URL_FIELD objects or binary strings taking in account if those IDURLs are already cached.
-    """
-    idurl1 = field(idurl1)
-    idurl2 = field(idurl2)
-    if not idurl1 or not idurl2:
-        return False
-    if is_cached(idurl1) and is_cached(idurl2):
-        return idurl1 == idurl2
-    return idurl1.to_bin() == idurl2.to_bin()
-
-
-def empty_count(iterable_object):
-    """
-    Returns number of empty idurl fields or empty strings found in given `iterable_object`.
-    """
-    count = 0
-    for idurl in iterable_object:
-        if is_empty(idurl):
-            count += 1
-    return count
-
-
-def get_latest_revision(idurl):
-    """
-    Return latest known IDURL (as binary string) and revision number for given idurl field or string.
-    This info is extracted from in-memory "index" of all known identity objects.
-    """
-    global _MergedIDURLs
-    global _KnownIDURLs
-    latest_rev = -1
-    latest_idurl = b''
-    idurl_bin = to_bin(idurl)
-    if not idurl_bin:
-        return latest_idurl, latest_rev
-    if idurl_bin not in _KnownIDURLs:
-        return latest_idurl, latest_rev
-    pub_key = _KnownIDURLs[idurl_bin]
-    if pub_key not in _MergedIDURLs:
-        lg.warn('idurl %r is known but has no known revisions yet' % idurl_bin)
-        return latest_idurl, latest_rev
-    for rev, another_idurl in _MergedIDURLs[pub_key].items():
-        if rev >= latest_rev:
-            latest_idurl = another_idurl
-            latest_rev = rev
-    return latest_idurl, latest_rev
-
-
-def get_latest_ident(pub_key):
-    global _KnownUsers
-    from bitdust.userid import identity
-    user_path = _KnownUsers.get(pub_key)
-    if not user_path:
-        return None
-    user_identity_files = sorted(map(int, os.listdir(user_path)))
-    if len(user_identity_files) == 0:
-        lg.warn('identity history is broken, public key is known, but no identity files found')
-    latest_revision = -1
-    latest_ident = None
-    known_revisions = set()
-    for_cleanup = []
-    for id_file in user_identity_files:
-        identity_file_path = os.path.join(user_path, strng.to_text(id_file))
-        xmlsrc = local_fs.ReadBinaryFile(identity_file_path)
-        one_id_obj = identity.identity(xmlsrc=xmlsrc)
-        if not one_id_obj.isCorrect():
-            lg.warn('identity history is broken, identity in the file %r is not correct' % identity_file_path)
-            for_cleanup.append(identity_file_path)
-            continue
-        if not one_id_obj.Valid():
-            lg.warn('identity history is broken, identity in the file %r is not valid' % identity_file_path)
-            for_cleanup.append(identity_file_path)
-            continue
-        if pub_key != one_id_obj.getPublicKey():
-            lg.err('identity history is broken, public key not matching in the file %r' % identity_file_path)
-            for_cleanup.append(identity_file_path)
-            continue
-        known_revisions.add(one_id_obj.getRevisionValue())
-        if one_id_obj.getRevisionValue() > latest_revision:
-            latest_revision = one_id_obj.getRevisionValue()
-            latest_ident = one_id_obj
-    return latest_ident
-
-
-def list_known_idurls(idurl, num_revisions=5, include_revisions=False):
-    """
-    Return latest known revisions of given `idurl` (as binary strings) and revision numbers as a list of tuples.
-    This info is extracted from in-memory "index" of all known identity objects.
-    """
-    global _MergedIDURLs
-    global _KnownIDURLs
-    idurl_bin = to_bin(idurl)
-    if not idurl_bin:
-        if _Debug:
-            lg.args(_DebugLevel, idurl=idurl, ret=idurl_bin)
-        if include_revisions:
-            return [(idurl_bin, -1)]
-        return [idurl_bin]
-    if idurl_bin not in _KnownIDURLs:
-        if _Debug:
-            lg.args(_DebugLevel, idurl=idurl, ret=idurl_bin)
-        if include_revisions:
-            return [(idurl_bin, -1)]
-        return [idurl_bin]
-    pub_key = _KnownIDURLs[idurl_bin]
-    if pub_key not in _MergedIDURLs:
-        lg.warn('idurl %r does not have any known revisions' % idurl_bin)
-        if include_revisions:
-            return [(idurl_bin, -1)]
-        return [idurl_bin]
-    known_revisions = sorted(_MergedIDURLs[pub_key].keys(), reverse=True)
-    results = []
-    for rev in known_revisions:
-        another_idurl = _MergedIDURLs[pub_key][rev]
-        if include_revisions:
-            if another_idurl not in [i[0] for i in results]:
-                results.append((another_idurl, rev))
-        else:
-            if another_idurl not in results:
-                results.append(another_idurl)
-        if len(results) >= num_revisions:
-            break
-    if _Debug:
-        lg.args(_DebugLevel, idurl=idurl, ret=results)
-    return results
+#------------------------------------------------------------------------------
 
 
-def idurl_to_id(idurl_text):
+def main():
     """
-    Translates raw IDURL string (not ID_URL_FIELD) into global id short form:
-        "http://somehost.com/alice.xml" -> "alice@somehost.com"
+    This should print a current identity or create a new one.
     """
-    if not idurl_text:
-        return idurl_text
-    _, host, port, _, filename = nameurl.UrlParseFast(idurl_text)
-    if filename.count('.'):
-        username = filename.split('.')[0]
+    settings.init()
+    from bitdust.userid import my_id
+    my_id.loadLocalIdentity()
+    if my_id.isLocalIdentityReady():
+        my_id.getLocalIdentity().sign()
+        print(my_id.getLocalIdentity().serialize())
+        print('Valid is: ', my_id.getLocalIdentity().Valid())
     else:
-        username = filename
-    if port:
-        host = '%s_%s' % (host, port)
-    return '%s@%s' % (username, host)
+        if not key.InitMyKey():
+            key.GenerateNewKey()
+        ipaddr = '127.0.0.1'
+        if len(sys.argv) > 2:
+            ipaddr = sys.argv[2]
+        rev = 0
+        if len(sys.argv) > 3:
+            rev = int(sys.argv[3])
+        idurls = []
+        if len(sys.argv) > 4:
+            idurls = sys.argv[4:]
+        my_id.setLocalIdentity(my_id.buildDefaultIdentity(name=sys.argv[1], ip=ipaddr, idurls=idurls, revision=rev))
+        my_id.saveLocalIdentity()
+        print(my_id.getLocalIdentity().serialize())
+        print('Valid is: ', my_id.getLocalIdentity().Valid())
+        my_id._LocalIdentity = None
+        my_id.loadLocalIdentity()
+    settings.shutdown()
+
+
+def update():
+    """
+    A good way to check all things - load and sign again.
+    Also will test rebuilding of the identity
+    """
+    from bitdust.userid import my_id
+    bpio.init()
+    settings.init()
+    src = bpio.ReadTextFile(settings.LocalIdentityFilename())
+    print(src)
+    my_id.setLocalIdentity(identity(xmlsrc=src))
+    my_id.getLocalIdentity().sign()
+    my_id.saveLocalIdentity()
+    print(my_id.getLocalIdentity().serialize())
+    print(my_id.rebuildLocalIdentity(revision_up=True))
+    settings.shutdown()
 
 
 #------------------------------------------------------------------------------
 
-
-class ID_URL_FIELD(object):
-    def __init__(self, idurl):
-        self.current = b''
-        self.current_as_string = ''
-        self.current_id = ''
-        self.latest = b''
-        self.latest_as_string = ''
-        self.latest_id = ''
-        self.latest_revision = -1
-        if isinstance(idurl, ID_URL_FIELD):
-            self.current = idurl.current
-        else:
-            if idurl in [None, 'None', '', b'None', b'', False]:
-                self.current = b''
-            else:
-                self.current = strng.to_bin(idurl.strip())
-        self.current_as_string = strng.to_text(self.current)
-        self.current_id = idurl_to_id(self.current)
-        self.latest, self.latest_revision = get_latest_revision(self.current)
-        if not self.latest:
-            self.latest = self.current
-            self.latest_revision = -1
-        self.latest_as_string = strng.to_text(self.latest)
-        self.latest_id = idurl_to_id(self.latest)
-        if _Debug:
-            lg.out(_DebugLevel*2, 'NEW ID_URL_FIELD(%r) with id=%r latest=%r' % (self.current, id(self), self.latest))
-
-    def __del__(self):
-        try:
-            if _Debug:
-                lg.out(_DebugLevel*2, 'DELETED ID_URL_FIELD(%r) with id=%r latest=%r' % (self.current, id(self), self.latest))
-        except:
-            lg.exc()
-
-    def __eq__(self, idurl):
-        # always check type : must be `ID_URL_FIELD`
-        if not isinstance(idurl, ID_URL_FIELD):
-            # to be able to compare with empty value lets make an exception
-            if idurl in [None, 'None', '', b'None', b'', False]:
-                return not bool(self.latest)
-            # in other cases must raise an exception
-            caller_code = sys._getframe().f_back.f_code
-            caller_method = caller_code.co_name
-            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
-            if caller_method.count('lambda'):
-                caller_method = sys._getframe(1).f_back.f_code.co_name
-            exc = TypeError('tried to compare ID_URL_FIELD(%r) with %r of type %r' % (self.latest_as_string, idurl, type(idurl)))
-            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
-            raise exc
-
-        # could be empty field also
-        if not idurl:
-            return not bool(self.latest)
-
-        # check if we know both sources
-        my_pub_key = self.to_public_key(raise_error=False)
-        other_pub_key = idurl.to_public_key(raise_error=False)
-        if my_pub_key is None or other_pub_key is None:
-            # if we do not know some of the sources - so can't be sure
-            caller_code = sys._getframe().f_back.f_code
-            caller_method = caller_code.co_name
-            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
-            if caller_method.count('lambda') or caller_method.startswith('_'):
-                caller_method = sys._getframe(1).f_back.f_code.co_name
-            if my_pub_key is None:
-                exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
-            else:
-                exc = KeyError('unknown idurl %r in %s.%s' % (idurl.current, caller_modul, caller_method))
-            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
-            raise exc
-
-        # now compare based on public key
-        result = (other_pub_key == my_pub_key)
-        if _Debug:
-            lg.args(_DebugLevel*2, idurl=idurl, current=self.current, latest=self.latest, result=result)
-        return result
-
-    def __ne__(self, idurl):
-        # always check type : must be `ID_URL_FIELD`
-        if not isinstance(idurl, ID_URL_FIELD):
-            # to be able to compare with empty value lets make an exception
-            if idurl in [None, 'None', '', b'None', b'', False]:
-                return bool(self.latest)
-            # in other cases must raise an exception
-            caller_code = sys._getframe().f_back.f_code
-            caller_method = caller_code.co_name
-            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
-            if caller_method.count('lambda') or caller_method.startswith('_'):
-                caller_method = sys._getframe(1).f_back.f_code.co_name
-            exc = TypeError('tried to compare ID_URL_FIELD(%r) with %r of type %r' % (self.latest_as_string, idurl, type(idurl)))
-            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
-            raise exc
-
-        # could be empty field also
-        if not idurl:
-            return bool(self.latest)
-
-        # check if we know both sources
-        my_pub_key = self.to_public_key(raise_error=True)
-        other_pub_key = idurl.to_public_key(raise_error=True)
-        if my_pub_key is None or other_pub_key is None:
-            # if we do not know some of the sources - so can't be sure
-            caller_code = sys._getframe().f_back.f_code
-            caller_method = caller_code.co_name
-            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
-            if caller_method.count('lambda') or caller_method.startswith('_'):
-                caller_method = sys._getframe(1).f_back.f_code.co_name
-            if my_pub_key is None:
-                exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
-            else:
-                exc = KeyError('unknown idurl %r in %s.%s' % (idurl.current, caller_modul, caller_method))
-            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
-            raise exc
-
-        # now compare based on public key
-        result = (other_pub_key != my_pub_key)
-        if _Debug:
-            lg.args(_DebugLevel*2, idurl=idurl, current=self.current, latest=self.latest, result=result)
-        return result
-
-    def __hash__(self):
-        # this trick should make `idurl in some_dictionary` work correctly
-        # if idurl1 and idurl2 are different sources of same identity they both must be matching
-        # so it must never happen like that: (idurl1 in some_dictionary) and (idurl2 in some_dictionary)
-        # same check you can do in a different way: `id_url.is_in(idurl, some_dictionary)`
-        pub_key = self.to_public_key()
-        hsh = pub_key.__hash__()
-        if _Debug:
-            lg.args(_DebugLevel*2, current=self.current, latest=self.latest, hash=hsh)
-        return hsh
-
-    def __repr__(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest_as_string=self.latest_as_string)
-        return '[%s%s]' % ('' if self.is_latest() else '*', self.latest_as_string)
-
-    def __str__(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest_as_string=self.latest_as_string)
-        return self.latest_as_string
-
-    def __bytes__(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest)
-        return self.latest
-
-    def __bool__(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest)
-        return bool(self.latest)
-
-    def __len__(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest)
-        return len(self.latest)
-
-    def refresh(self, replace_original=True):
-        _latest, _latest_revision = get_latest_revision(self.current)
-        if self.latest and self.latest == _latest:
-            if _Debug:
-                lg.args(_DebugLevel, latest=self.latest_as_string, refreshed=False)
-            return False
-        self.latest = _latest
-        self.latest_revision = _latest_revision
-        if not self.latest:
-            self.latest = self.current
-            self.latest_revision = -1
-        self.latest_as_string = strng.to_text(self.latest)
-        self.latest_id = idurl_to_id(self.latest)
-        if replace_original:
-            self.current = self.latest
-            self.current_as_string = self.latest_as_string
-            self.current_id = self.latest_id
-        if _Debug:
-            lg.args(_DebugLevel, latest=self.latest_as_string, current=self.current_as_string, refreshed=True)
-        return True
-
-    def strip(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest_as_string)
-        return self.latest
-
-    def original(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
-        return self.current
-
-    def original_id(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, current=self.current_id, latest=self.latest_id)
-        return self.current_id
-
-    def is_latest(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
-        return self.latest and self.current == self.latest
-
-    def to_id(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest_id=self.latest_id)
-        return self.latest_id
-
-    def to_text(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest_as_string)
-        return self.latest_as_string
-
-    def to_bin(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest)
-        return self.latest
-
-    def to_original(self):
-        if _Debug:
-            lg.args(_DebugLevel*2, current=self.current, latest=self.latest)
-        return self.current
-
-    def to_public_key(self, raise_error=True):
-        global _KnownIDURLs
-        if _Debug:
-            lg.args(_DebugLevel*2, latest=self.latest, current=self.current)
-        if not self.current:
-            return b''
-        if self.current not in _KnownIDURLs:
-            if not raise_error:
-                return None
-            caller_code = sys._getframe().f_back.f_code
-            caller_method = caller_code.co_name
-            caller_modul = os.path.basename(caller_code.co_filename).replace('.py', '')
-            if caller_method.count('lambda') or caller_method.startswith('_'):
-                caller_method = sys._getframe(1).f_back.f_code.co_name
-            exc = KeyError('unknown idurl %r in %s.%s' % (self.current, caller_modul, caller_method))
-            lg.exc(msg='called from %s.%s()' % (caller_modul, caller_method), exc_value=exc)
-            raise exc
-        pub_key = _KnownIDURLs[self.current]
-        return pub_key
+if __name__ == '__main__':
+    lg.set_debug_level(18)
+    main()
+    # update()
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/identity.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/pp/__init__.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,1099 +1,1034 @@
-#!/usr/bin/python
-# identity.py
-#
-#
-# Copyright (C) 2008 Veselin Penev, https://bitdust.io
-#
-# This file (identity.py) is part of BitDust Software.
-#
-# BitDust is free software: you can redistribute it and/or modify
-# it under the terms of the GNU Affero General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-#
-# BitDust Software is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU Affero General Public License for more details.
-#
-# You should have received a copy of the GNU Affero General Public License
-# along with BitDust Software.  If not, see <http://www.gnu.org/licenses/>.
-#
-# Please contact us if you have any questions at bitdust.io@gmail.com
-#
-#
-#
+#!/usr/bin/env python
+#__init__.py
 #
+# Parallel Python Software: http://www.parallelpython.com
+# Copyright (c) 2005-2009, Vitalii Vanovschi
+# All rights reserved.
+# Redistribution and use in source and binary forms, with or without
+# modification, are permitted provided that the following conditions are met:
+#    * Redistributions of source code must retain the above copyright notice,
+#      this list of conditions and the following disclaimer.
+#    * Redistributions in binary form must reproduce the above copyright
+#      notice, this list of conditions and the following disclaimer in the
+#      documentation and/or other materials provided with the distribution.
+#    * Neither the name of the author nor the names of its contributors
+#      may be used to endorse or promote products derived from this software
+#      without specific prior written permission.
 #
+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
+# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+# ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
+# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+# THE POSSIBILITY OF SUCH DAMAGE.
 """
-.. module:: identity.
-
-.. role:: red
-
-This is a core module.
+Parallel Python Software, Execution Server.
 
-Identity might better be called business card, since it is really
-mostly just your contact info. But more than that since public key.
-Hum.
-
-The whole idea of identity files is that they can be stored anywhere.
-User can decide to put his identity file on his own host, or he can use some another trusted public host.
-All identity files is signed with user's Key and client code should verify signatures.
-Even if someone tried to fake my identity - this will be refused by other nodes in the network.
-
-Example in http://seed.bitdust.io/veselin.xml
-
-Could have info just be XML on a web page.  So an Identity could be a URL.
-If we do this, then we get the scaling of DNS for free.
-
-BitDust could have mappings from unique short names to URLs for
-identities.  Or we could just make sure that the MD5 of the URL was
-always unique (this is 16 bytes).  Or we could go with the primary URL.
-Hum. BitDust does need some sort of unique identifier, as do others.
-Also, would be nice to be able to send someone a list of their
-current 64 nodes they use, or the 300 that use them, without
-crazy amounts of data.  For display
-of backup status I would like a unique identifier that is short,
-like 15 chars or something.  Can get main part of URLs that is
-short like that, say "id.ai/vince1".  Seems funny to limit the
-length of a URL like this, but we could as there will be
-identity servers and they can get very short names like id.ai.
-If we forced them all to be ".com/" we could display "id:vince1",
-or "cate:vince1", which is short.  The force could just be
-a lower rating for those that did not do this.  Could have
-short name take up 2 lines out of my 5, and just plan on
-letting user click on things to change what things are
-displayed.  So they have 5 lines and full URL takes 2,
-but last of URL is just 1 line, and maybe they don't
-care what the name is and just display other stuff.
-
-If we open it up a bit, people could just use tinyurl.com/foolksd
-if their URL was too long.  We could limit primary URL
-to 32 chars and not really have any trouble.  Can say it
-must start with http:// (so we don't have to store that)
-and be less than 32 chars after that.  If does not really
-start with http:// then tiny URL can fix that too.
-
-It is a bit like bittorrent using a .torrent file on the
-web to get the original start for things.  This seems good.
-
-All Identity/business-card info in XML:
-PublicKey
-primary URL for this identity (say https://cate.com/vinceID)
-backup URLs for this identity (maybe URLs) that secondary this identity
-contact: domain/port  pairs  (good even if IP out of date)
-contact: IP/port  pairs    (good even if DNS in trouble)
-contact: nat-traverser/ID pairs  (for those without fixed IPs)
-contact: emails for this identity (recommend people have one just in case)
-contact: http://foobar.com/data.pl    (use a web account to forward requests/data)
-scrubbers: URL1, URL2, URL3           (people who can access our data if we stop checking it)
-date
-version number
-revision number
-signature on all identity info
-
-Contact list has enough info we can tell what protocol to use.
-User could put in order he prefers us to try the contact methods.
-So we might have a list like:
-    tcp://123.45.67.89:9876
-    udp://user123@idserver456.com
-    http://123.45.67.89:8765
-
-Really best if all the identity servers use SSL.
-We could make certificates for identity servers, but might
-not bother as it is probably best if they have ones that
-web browsers understand.
-On the other hand, this might be a good way to get into the certificate-authority business. :-)
-
-Having XML on a web site means we can start before we
-really have identity server code.  Also means it is
-easy to grow and debug.
-
-As long as identity server is just some CGI that we can run on
-any ISP anywhere (pair.com etc), and users always use 3 identity servers,
-then we could just pop up as many as needed on ISPs all over
-the world as fast as we grew.  It would not be an infrastructure
-limitation really.  And we don't need to farm it out.
-Identity's are signed and have a revision number, so an identity
-server can pass on an update that it gets to other servers listed
-for that identity (in case there is network partition funnyness)
-to help keep all of them updated.
-
-But we really want actually people to run own identity servers and not rely on us.
-ID server is a first target to external hacker to attack actually if he wants to brake/block the network.
-Also ownership is important - 1000 servers owned by one company can be easily attacked via "legal/court" order.
-But 1000 servers owned and maintained by 1000 people in 100 different countries is completely different scenario.
-So more distribution of ID servers we will have in BitDust - more secured and protected network will become.
+http://www.parallelpython.com - updates, documentation, examples and support
+forums
 """
 
-#------------------------------------------------------------------------------
-
 from __future__ import absolute_import
 from __future__ import print_function
-from six.moves import range  # @UnresolvedImport
-
-#------------------------------------------------------------------------------
-
-_Debug = False
-_DebugLevel = 10
-
-#------------------------------------------------------------------------------
+# from six import text_type as str
+from six.moves import range
+# import six.moves.cPickle as pickle
+import six.moves._thread
+from io import TextIOWrapper
 
 import os
+import json
+import logging
+import inspect
 import sys
+import types
+import time
+import atexit
+import traceback
+
+# import user
+from . import pptransport
+from . import ppauto
 
-from xml.dom import minidom, Node
-from xml.dom.minidom import getDOMImplementation
+copyright = 'Copyright (c) 2005-2009 Vitalii Vanovschi. All rights reserved'
+version = '1.5.7'
 
-#------------------------------------------------------------------------------
+# reconnect persistent rworkers in 5 sec
+_RECONNECT_WAIT_TIME = 5
 
+# we need to have set even in Python 2.3
 try:
-    from bitdust.logs import lg
-except:
-    dirpath = os.path.dirname(os.path.abspath(sys.argv[0]))
-    sys.path.insert(0, os.path.abspath(os.path.join(dirpath, '..')))
-    from bitdust.logs import lg
-
-#------------------------------------------------------------------------------
-
-from bitdust.main import settings
-
-from bitdust.system import bpio
-
-from bitdust.lib import strng
-from bitdust.lib import nameurl
-
-from bitdust.crypt import key
-
-from bitdust.userid import global_id
-from bitdust.userid import id_url
-
-#------------------------------------------------------------------------------
+    set
+except NameError:
+    from sets import Set as set  # @UnresolvedImport
 
-default_identity_src = """<?xml version="1.0" encoding="ISO-8859-1"?>
-<identity>
-  <sources></sources>
-  <contacts></contacts>
-  <certificates></certificates>
-  <scrubbers></scrubbers>
-  <postage>1</postage>
-  <date></date>
-  <version></version>
-  <revision>0</revision>
-  <publickey></publickey>
-  <signature></signature>
-</identity>"""
-
-#------------------------------------------------------------------------------
+_USE_SUBPROCESS = False
+try:
+    import subprocess
+    _USE_SUBPROCESS = True
+except ImportError:
+    import popen2
 
 
-class identity(object):
+class _Task(object):
     """
-    We are passed an XML version of an identity and make an Identity. Also can
-    construct an Identity by providing all fields. The fields is:
-
-    * sources : list of URLs, first is primary URL and name
-    * contacts : list of ways to contact this identity
-    * certificates : signatures by identity servers
-    * scrubbers : list of URLs for people allowed to scrub
-    * postage : a price for message delivery if not on correspondents list
-    * date : the date an time when that identity was created
-    * version : a version string - some info about BitDust software and platform
-    * revision : every time identity were modified this value will be increased by 1
-    * publickey : the public part of user's key, string in twisted.conch.ssh format
-    * signature : digital signature to protect the file
+    Class describing single task (job)
     """
-    sources = []  # list of URLs, first is primary URL and name
-    contacts = []  # list of ways to contact this identity
-    certificates = []  # signatures by identity servers
-    scrubbers = []  # list of URLs for people allowed to scrub
-    postage = b'1'  # a price for message delivery if not on correspondents list
-    date = b''  # date
-    version = b''  # version string
-    revision = b'0'  # revision number, every time my id were modified this value will be increased by 1
-    publickey = b''  # string in twisted.conch.ssh format
-    signature = b''  # digital signature
-
-    def __init__(self, sources=[], contacts=[], certificates=[], scrubbers=[], postage=b'1', date=b'', version=b'', revision=b'0', publickey=b'', xmlsrc=None, filename=b''):
-
-        self.sources = []
-        if sources:
-            self.setSources(sources)
-        self.contacts = contacts
-        self.certificates = certificates
-        self.scrubbers = scrubbers
-        self.postage = postage
-        self.date = date
-        self.version = version
-        self.revision = revision
-        self.publickey = publickey
-
-        if publickey:
-            self.sign()
-        else:
-            self.signature = b''
-            # no point in signing if no public key listed, probably about to unserialize something
-
-        if xmlsrc is not None:
-            self.unserialize(xmlsrc)
-
-        if filename:
-            self.unserialize(bpio.ReadTextFile(filename))
-
-        if not xmlsrc and not filename:
-            self.default()
-
-    def __repr__(self, *args, **kwargs):
-        return object.__repr__(self, *args, **kwargs) + '[%s]' % self.makehash(hexdigest=True)
-
-    def clear_data(self):
-        """
-        Erase all fields data, clear identity.
-        """
-        self.sources = []  # list of URLs for fetching this identiy, first is primary URL and name - called IDURL
-        self.certificates = []  # identity servers each sign the source they are with - hash just (IDURL + publickey)
-        self.publickey = b''  # string
-        self.contacts = []  # list of ways to contact this identity
-        self.scrubbers = []  # list of URLs for people allowed to scrub
-        self.date = b''  # date
-        self.postage = b'1'  # postage price for message delivery if not on correspondents list
-        self.version = b''  # version string
-        self.signature = b''  # digital signature
-        self.revision = b'0'  # revision number
-
-    def default(self):
-        """
-        Set a "blank" identity.
-        """
-        global default_identity_src
-        self.unserialize(default_identity_src)
-
-    #------------------------------------------------------------------------------
-
-    def isCorrect(self):
-        """
-        Do some checking on the object fields.
-        """
-        if len(self.contacts) == 0:
-            return False
-        if len(self.sources) == 0:
-            return False
-        if not self.publickey:
-            return False
-        if not self.signature:
-            return False
-        if not self.revision:
-            return False
-        original_sources = self.getSources(as_originals=True)
-        if len(set(original_sources)) != len(self.sources):
-            lg.warn('original identity sources are duplicated: %r' % original_sources)
-            return False
-        if len(original_sources) > settings.MaximumIdentitySources():
-            lg.warn('too much sources')
-            return False
-        if len(original_sources) < settings.MinimumIdentitySources():
-            lg.warn('too few sources')
-            return False
-        try:
-            int(self.revision)
-        except:
-            lg.warn('identity revision: %s' % self.revision)
-            return False
-        names = set()
-        for source in original_sources:
-            if not source:
-                lg.warn('found empty source')
-                return False
-            proto, host, port, filename = nameurl.UrlParse(source)
-            if filename.count('/'):
-                lg.warn('incorrect identity name: %s' % filename)
-                return False
-            name, justxml = filename.split('.')
-            names.add(name)
-            # SECURITY check that name is simple
-            if justxml != 'xml':
-                lg.warn('incorrect identity name: %s' % filename)
-                return False
-            if len(name) > settings.MaximumUsernameLength():
-                lg.warn('incorrect identity name: %s' % filename)
-                return False
-            if len(name) < settings.MinimumUsernameLength():
-                lg.warn('incorrect identity name: %s' % filename)
-                return False
-            for c in name:
-                if c not in settings.LegalUsernameChars():
-                    lg.warn('incorrect identity name: %s' % filename)
-                    return False
-        if len(names) > 1:
-            lg.warn('names are not consistent: %s' % str(names))
-            return False
-        return True
-
-    def makehash(self, hexdigest=False):
-        """
-        http://docs.python.org/lib/module-urlparse.html Note that certificates
-        and signatures are not part of what is hashed. PREPRO Thinking of
-        standard that fields have labels and empty fields are left out,
-        including label, so future versions could have same signatures as older
-        which had fewer fields - can just do this for fields after these, so
-        maybe don't need to change anything for now.
-        Don't include certificate - so identity server can just add it.
-        """
-        sep = b'-'
-        hsh = b''
-        hsh += sep + sep.join(map(lambda s: s.original(), self.sources))
-        hsh += sep + sep.join(self.contacts)
-        # hsh += sep + sep.join(self.certificates)
-        hsh += sep + sep.join(self.scrubbers)
-        hsh += sep + self.postage
-        hsh += sep + self.date.replace(b' ', b'_')
-        hsh += sep + self.version
-        hsh += sep + self.revision
-        # lg.out(12, "identity.makehash: %r" % hsh)
-        hashcode = key.Hash(hsh, hexdigest=hexdigest)
-        return hashcode
-
-    def sign(self):
-        """
-        Make a hash, generate digital signature on it and remember the
-        signature.
-        """
-        hashcode = self.makehash()
-        self.signature = key.Sign(hashcode)
-        if not self.Valid():
-            lg.warn('identity is not valid after making sign!')
-            raise Exception('identity sign fails')
-
-    def Valid(self):
-        """
-        This will make a hash and verify the signature by public key.
-
-        PREPRO - should test certificate too.
-        """
-        # print('Valid %r' % self.signature)
-        hashcode = self.makehash()
-        result = key.VerifySignature(
-            self.publickey,
-            hashcode,
-            self.signature,
-        )
-        return result
-
-    #------------------------------------------------------------------------------
-
-    def encrypt(self, inp):
+    def __init__(self, server, tid, callback=None, callbackargs=(), group='default'):
         """
-        Encrypt some `inp` data with public key from this identity object.
-        You can use this method to send a private messages addressed to the owner of this identity.
+        Initializes the task.
         """
-        return key.EncryptOpenSSHPublicKey(self.publickey, inp)
+        self.lock = six.moves._thread.allocate_lock()
+        self.lock.acquire()
+        self.tid = tid
+        self.server = server
+        self.callback = callback
+        self.callbackargs = callbackargs
+        self.group = group
+        self.finished = False
+        self.unpickled = False
+        self.worker_pid = -1
+        self.cancelled = False
 
-    def decrypt(self, inp, private_key=None):
-        """
-        Decrypt `inp` data with private key provided (callable, key_id or openssh format).
-        When `private_key` is not provided will decrypt using my own "master" key.
+    def finalize(self, sresult):
         """
-        if private_key is None:
-            return key.DecryptLocalPrivateKey(inp)
-        if callable(private_key):
-            return private_key(inp)
-        from bitdust.crypt import my_keys
-        if my_keys.is_valid_key_id(private_key):
-            return my_keys.decrypt(private_key, inp)
-        return key.DecryptOpenSSHPrivateKey(private_key, inp)
+        Finalizes the task.
 
-    #------------------------------------------------------------------------------
-
-    def unserialize(self, xmlsrc):
-        """
-        A smart method to load object fields data from XML content.
-        """
-        try:
-            doc = minidom.parseString(strng.to_bin(xmlsrc))
-        except:
-            lg.exc('xmlsrc=%r' % xmlsrc)
-            return
-        self.clear_data()
-        self.from_xmlobj(doc.documentElement)
-
-    def unserialize_object(self, xmlobject):
-        """
-        This is almost same but load data from existing DOM object.
+        For internal use only
         """
-        self.clear_data()
-        self.from_xmlobj(xmlobject)
+        if self.cancelled:
+            self.sresult = None
+        else:
+            self.sresult = sresult
+        if self.callback:
+            self.__unpickle()
+        self.lock.release()
+        self.finished = True
 
-    def unserialize_json(self, json_data):
-        """
-        This loads data from Python dictionary.
+    def __call__(self, raw_result=False):
         """
-        self.clear_data()
-        self.setSources(json_data['sources'])
-        self.setContacts(json_data['contacts'])
-        self.setCertificates(json_data['certificates'])
-        self.setScrubbers(json_data['scrubbers'])
-        self.setDate(json_data['date'])
-        self.setPostage(json_data['postage'])
-        self.setVersion(json_data['version'])
-        self.setRevision(json_data['version'])
-        self.setPublicKey(json_data['publickey'])
-        self.setSignature(json_data['signature'])
-
-    def serialize(self, as_text=False):
+        Retrieves result of the task.
         """
-        A method to generate XML content for that identity object.
+        self.wait()
 
-        Used to save identity on disk or transfer over network.
-        """
-        if as_text:
-            return strng.to_text(self.toxml()[0].strip())
-        return self.toxml()[0].strip()
+        if not self.unpickled and not raw_result:
+            self.__unpickle()
 
-    def serialize_object(self):
-        """
-        Almost the same but return a DOM object.
-        """
-        return self.toxml()[1]
+        if raw_result:
+            return self.sresult
+        else:
+            return self.result
 
-    def serialize_json(self):
+    def wait(self):
         """
-        A method to generate JSON dictionary for that identity object.
-
-        Used to represent identity in API methods.
+        Waits for the task.
         """
-        return {
-            'name': self.getIDName(),
-            'idurl': strng.to_text(self.getIDURL().original()),
-            'global_id': global_id.MakeGlobalID(idurl=self.getIDURL().original()),
-            'sources': [strng.to_text(i) for i in self.getSources(as_originals=True)],
-            'contacts': [strng.to_text(i) for i in self.getContacts()],
-            'certificates': [strng.to_text(i) for i in self.certificates],
-            'scrubbers': [strng.to_text(i) for i in self.scrubbers],
-            'postage': strng.to_text(self.postage),
-            'date': strng.to_text(self.date),
-            'version': strng.to_text(self.version),
-            'revision': strng.to_text(self.revision),
-            'publickey': strng.to_text(self.publickey),
-            'signature': strng.to_text(self.signature),
-        }
+        if not self.finished:
+            self.lock.acquire()
+            self.lock.release()
 
-    def toxml(self):
+    def __unpickle(self):
         """
-        Call this to convert to XML format.
+        Unpickles the result of the task.
         """
-        impl = getDOMImplementation()
-
-        doc = impl.createDocument(None, 'identity', None)
-        root = doc.documentElement
-
-        sources = doc.createElement('sources')
-        root.appendChild(sources)
-        for source in self.sources:
-            n = doc.createElement('source')
-            n.appendChild(doc.createTextNode(strng.to_text(source.original())))
-            sources.appendChild(n)
-
-        contacts = doc.createElement('contacts')
-        root.appendChild(contacts)
-        for contact in self.contacts:
-            n = doc.createElement('contact')
-            n.appendChild(doc.createTextNode(strng.to_text(contact)))
-            contacts.appendChild(n)
-
-        certificates = doc.createElement('certificates')
-        root.appendChild(certificates)
-        for certificate in self.certificates:
-            n = doc.createElement('certificate')
-            n.appendChild(doc.createTextNode(strng.to_text(certificate)))
-            certificates.appendChild(n)
-
-        scrubbers = doc.createElement('scrubbers')
-        root.appendChild(scrubbers)
-        for scrubber in self.scrubbers:
-            n = doc.createElement('scrubber')
-            n.appendChild(doc.createTextNode(strng.to_text(scrubber)))
-            scrubbers.appendChild(n)
-
-        postage = doc.createElement('postage')
-        postage.appendChild(doc.createTextNode(strng.to_text(self.postage)))
-        root.appendChild(postage)
-
-        date = doc.createElement('date')
-        date.appendChild(doc.createTextNode(strng.to_text(self.date)))
-        root.appendChild(date)
-
-        version = doc.createElement('version')
-        version.appendChild(doc.createTextNode(strng.to_text(self.version)))
-        root.appendChild(version)
-
-        revision = doc.createElement('revision')
-        revision.appendChild(doc.createTextNode(strng.to_text(self.revision)))
-        root.appendChild(revision)
-
-        publickey = doc.createElement('publickey')
-        publickey.appendChild(doc.createTextNode(strng.to_text(self.publickey)))
-        root.appendChild(publickey)
+        if self.sresult is not None:
+            raw = self.sresult
+            try:
+                self.result, sout = json.loads(raw)['v']
+            except:
+                traceback.print_exc()
+                print(raw)
+            if len(sout) > 0:
+                print(sout, end=' ')
+        else:
+            self.result = None
+        self.unpickled = True
+        if self.callback:
+            args = self.callbackargs + (self.result, )
+            self.callback(*args)
 
-        signature = doc.createElement('signature')
-        signature.appendChild(doc.createTextNode(strng.to_text(self.signature)))
-        root.appendChild(signature)
 
-        xmlsrc = doc.toprettyxml(indent='  ', newl='\n', encoding='utf-8')
-        return xmlsrc, root, doc
+class _Worker(object):
+    """
+    Local worker class.
+    """
+    command = [sys.executable, '-u', 'bpworker.py']
 
-    def from_xmlobj(self, root_node):
+    def __init__(self, restart_on_free, pickle_proto):
         """
-        This is to load identity fields from DOM object - used during ``unserialize`` procedure.
+        Initializes local worker.
         """
-        if root_node is None:
-            return False
-        try:
-            for xsection in root_node.childNodes:
-                if xsection.nodeType != Node.ELEMENT_NODE:
-                    continue
-                if xsection.tagName == 'sources':
-                    for xsources in xsection.childNodes:
-                        for xsource in xsources.childNodes:
-                            if (xsource.nodeType == Node.TEXT_NODE):
-                                self.sources.append(id_url.ID_URL_FIELD(xsource.wholeText.strip()))
-                                break
-                elif xsection.tagName == 'contacts':
-                    for xcontacts in xsection.childNodes:
-                        for xcontact in xcontacts.childNodes:
-                            if (xcontact.nodeType == Node.TEXT_NODE):
-                                self.contacts.append(strng.to_bin(xcontact.wholeText.strip()))
-                                break
-                elif xsection.tagName == 'certificates':
-                    for xcertificates in xsection.childNodes:
-                        for xcertificate in xcertificates.childNodes:
-                            if (xcertificate.nodeType == Node.TEXT_NODE):
-                                self.certificates.append(strng.to_bin(xcertificate.wholeText.strip()))
-                                break
-                elif xsection.tagName == 'scrubbers':
-                    for xscrubbers in xsection.childNodes:
-                        for xscrubber in xscrubbers.childNodes:
-                            if (xscrubber.nodeType == Node.TEXT_NODE):
-                                self.scrubbers.append(strng.to_bin(xscrubber.wholeText.strip()))
-                                break
-                elif xsection.tagName == 'postage':
-                    for xpostage in xsection.childNodes:
-                        if (xpostage.nodeType == Node.TEXT_NODE):
-                            self.postage = strng.to_bin(xpostage.wholeText.strip())
-                            break
-                elif xsection.tagName == 'date':
-                    for xkey in xsection.childNodes:
-                        if (xkey.nodeType == Node.TEXT_NODE):
-                            self.date = strng.to_bin(xkey.wholeText.strip())
-                            break
-                elif xsection.tagName == 'version':
-                    for xkey in xsection.childNodes:
-                        if (xkey.nodeType == Node.TEXT_NODE):
-                            self.version = strng.to_bin(xkey.wholeText.strip())
-                            break
-                elif xsection.tagName == 'revision':
-                    for xkey in xsection.childNodes:
-                        if (xkey.nodeType == Node.TEXT_NODE):
-                            self.revision = strng.to_bin(xkey.wholeText.strip())
-                            break
-                elif xsection.tagName == 'publickey':
-                    for xkey in xsection.childNodes:
-                        if (xkey.nodeType == Node.TEXT_NODE):
-                            self.publickey = strng.to_bin(xkey.wholeText.strip())
-                            break
-                elif xsection.tagName == 'signature':
-                    for xkey in xsection.childNodes:
-                        if (xkey.nodeType == Node.TEXT_NODE):
-                            self.signature = strng.to_bin(xkey.wholeText.strip())
-                            break
-        except:
-            lg.exc()
-            return False
-        return True
-
-    #------------------------------------------------------------------------------
+        self.restart_on_free = restart_on_free
+        self.pickle_proto = pickle_proto
+        self.start()
+
+    def start(self):
+        """
+        Starts local worker.
+        """
+        if _USE_SUBPROCESS:
+            if sys.platform.startswith('win'):
+                import win32process  # @UnresolvedImport
+                my_env = os.environ
+                my_env['PYTHONIOENCODING'] = 'latin1'
+                proc = subprocess.Popen(
+                    self.command,
+                    shell=False,
+                    stdin=subprocess.PIPE,
+                    stdout=subprocess.PIPE,
+                    stderr=subprocess.PIPE,
+                    universal_newlines=False,
+                    creationflags=win32process.CREATE_NO_WINDOW,
+                    env=my_env,
+                )
+                self.t = pptransport.PipeTransport(proc.stdout, proc.stdin)
+            else:
+                if six.PY2:
+                    my_env = os.environ
+                    my_env['PYTHONIOENCODING'] = 'latin1'
+                    proc = subprocess.Popen(
+                        self.command,
+                        shell=False,
+                        stdin=subprocess.PIPE,
+                        stdout=subprocess.PIPE,
+                        stderr=subprocess.PIPE,
+                        universal_newlines=False,
+                        env=my_env,
+                    )
+                    self.t = pptransport.PipeTransport(proc.stdout, proc.stdin)
+                else:
+                    my_env = os.environ
+                    my_env['PYTHONIOENCODING'] = 'latin1'
+                    proc = subprocess.Popen(
+                        self.command,
+                        shell=False,
+                        stdin=subprocess.PIPE,
+                        stdout=subprocess.PIPE,
+                        stderr=subprocess.PIPE,
+                        universal_newlines=False,
+                        env=my_env,
+                    )
+                    self.t = pptransport.PipeTransport(proc.stdout, proc.stdin)
+        else:
+            self.t = pptransport.PipeTransport(*popen2.popen3(self.command)[:2])
+        self.pid = int(self.t.receive())
+        self.is_free = True
+        logging.info('Started new worker: %s with %s', self.pid, self.t)
 
-    def getSources(self, as_fields=True, as_originals=False):
+    def stop(self):
         """
-        Return identity sources.
+        Stops local worker.
         """
-        if as_originals:
-            return id_url.to_original_list(self.sources)
-        if not as_fields:
-            return id_url.to_bin_list(self.sources)
-        return self.sources
+        logging.info('Stop worker: %s with %s', self.pid, self.t)
+        self.is_free = False
+        self.t.close()
 
-    def getIDURL(self, index=0, as_field=True, as_original=False):
+    def restart(self):
         """
-        Return a source IDURL - this is a user ID.
-        Must have at least one IDURL in the ``sources``.
+        Restarts local worker.
         """
-        result = self.sources[index]
-        if as_original:
-            return result.original()
-        if not as_field:
-            return result.to_bin()
-        return result
+        self.stop()
+        self.start()
 
-    def getIDName(self, index=0):
+    def free(self):
         """
-        Return an account name - this is just a user name taken from IDURL:
-            "veselin" for "http://id.bitdust.io/veselin.xml"
+        Frees local worker.
         """
-        protocol, host, port, filename = nameurl.UrlParse(self.getIDURL(index))
-        return filename.strip()[0:-4]
+        if self.restart_on_free:
+            self.restart()
+        else:
+            self.is_free = True
 
-    def getIDHost(self, index=0):
-        """
-        Return a server host name where that identity is stored:
-        "id.bitdust.io" for "http://id.bitdust.io/veselin.xml".
-        """
-        protocol, host, port, filename = nameurl.UrlParse(self.getIDURL(index))
-        if port:
-            host += ':' + str(port)
-        return host
 
-    def getContacts(self):
+class _RWorker(pptransport.CSocketTransport):
+    """
+    Remote worker class.
+    """
+    def __init__(self, host, port, secret, message=None, persistent=True):
         """
-        Return identity contacts list.
+        Initializes remote worker.
         """
-        return self.contacts
+        self.persistent = persistent
+        self.host = host
+        self.port = port
+        self.secret = secret
+        self.address = (host, port)
+        self.id = host + ':' + six.text_type(port)
+        logging.info('Creating Rworker id=%s persistent=%s' % (self.id, persistent))
+        self.connect(message)
+        self.is_free = True
 
-    def getContactsNumber(self):
+    def __del__(self):
         """
-        Return identity contacts number.
+        Closes connection with remote server.
         """
-        return len(self.contacts)
+        self.close()
 
-    def getContact(self, index=0):
+    def connect(self, message=None):
         """
-        Return a contact with given ``index`` number or None.
+        Connects to a remote server.
         """
-        try:
-            return self.contacts[index]
-        except:
-            return None
+        while True:
+            try:
+                pptransport.SocketTransport.__init__(self)
+                self._connect(self.host, self.port)
+                if not self.authenticate(self.secret):
+                    logging.error('Authentication failed for host=%s, port=%s' % (self.host, self.port))
+                    return False
+                if message:
+                    self.send(message)
+                self.is_free = True
+                return True
+            except:
+                if not self.persistent:
+                    logging.info('Deleting from queue Rworker %s' % (self.id, ))
+                    return False
+                logging.info('Failed to reconnect with '
+                             '(host=%s, port=%i), will try again in %i s' % (self.host, self.port, _RECONNECT_WAIT_TIME), )
+                time.sleep(_RECONNECT_WAIT_TIME)
 
-    def getContactHost(self, index=0):
-        """
-        Get the host name part of the contact.
-        """
-        protocol, host, port, filename = nameurl.UrlParse(self.contacts[index])
-        return host
 
-    def getContactPort(self, index=0):
+class _Statistics(object):
+    """
+    Class to hold execution statisitcs for a single node.
+    """
+    def __init__(self, ncpus, rworker=None):
         """
-        Get the port part of the contact.
+        Initializes statistics for a node.
         """
-        protocol, host, port, filename = nameurl.UrlParse(self.contacts[index])
-        return port
+        self.ncpus = ncpus
+        self.time = 0.0
+        self.njobs = 0
+        self.rworker = rworker
 
-    def getContactParts(self, index=0):
-        """
-        Return tuple with 4 parts of the contact: (proto, host, port, filename)
-        """
-        return nameurl.UrlParse(self.contacts[index])
 
-    def getProtoParts(self, proto):
-        """
-        See ``getProtoContact``, return a tuple for given ``proto``: (proto,
-        host, port, filename)
+class Template(object):
+    """
+    Template class.
+    """
+    def __init__(self, job_server, func, depfuncs=(), modules=(), callback=None, callbackargs=(), group='default', globals=None):
         """
-        contact = self.getProtoContact(proto)
-        if contact is None:
-            return None, None, None, None
-        return nameurl.UrlParse(contact)
+        Creates Template instance.
 
-    def getProtoHost(self, proto, default=None):
-        """
-        See ``getProtoParts``, return a host of a contact with given ``proto``.
-        """
-        protocol, host, port, filename = self.getProtoParts(proto)
-        if host is None:
-            return default
-        return host
+        jobs_server - pp server for submitting jobs
+        func - function to be executed
+        depfuncs - tuple with functions which might be called from 'func'
+        modules - tuple with module names to import
+        callback - callback function which will be called with argument
+                list equal to callbackargs+(result,)
+                as soon as calculation is done
+        callbackargs - additional arguments for callback function
+        group - job group, is used when wait(group) is called to wait for
+        jobs in a given group to finish
+        globals - dictionary from which all modules, functions and classes
+        will be imported, for instance: globals=globals()
+        """
+        self.job_server = job_server
+        self.func = func
+        self.depfuncs = depfuncs
+        self.modules = modules
+        self.callback = callback
+        self.callbackargs = callbackargs
+        self.group = group
+        self.globals = globals
 
-    def getContactIndex(self, proto='', host='', contact=''):
+    def submit(self, *args):
         """
-        Search a first contact with given conditions.
+        Submits function with *arg arguments to the execution queue.
         """
-        for i in range(0, len(self.contacts)):
-            c = strng.to_bin(self.contacts[i])
-            if proto:
-                if c.find(strng.to_bin(proto) + b'://') == 0:
-                    return i
-            if host:
-                if c.find(b'://' + strng.to_bin(host)) == 0:
-                    return i
-            if contact:
-                if c == strng.to_bin(contact):
-                    return i
-        return -1
+        return self.job_server.submit(self.func, args, self.depfuncs, self.modules, self.callback, self.callbackargs, self.group, self.globals)
 
-    def getProtoContact(self, proto):
-        """
-        Search for first found contact with given ``proto``.
 
-        Return None if not found a contact.
-        """
-        for contact in self.contacts:
-            if contact.startswith(strng.to_bin(proto) + b'://'):
-                return contact
-        return None
+class Server(object):
+    """
+    Parallel Python SMP execution server class.
+    """
 
-    def getProtoOrder(self):
-        """
-        Return a list of "proto" parts of all contacts. In other words return a
-        list of all supported protocols.
+    default_port = 60000
+    default_secret = 'epo20pdosl;dksldkmm'
 
-        This keeps the order of the protos - this is a sort of priority of the transports.
+    def __init__(self, ncpus='autodetect', ppservers=(), secret=None, loglevel=logging.WARNING, logstream=sys.stderr, logfile=None, restart=False, proto=0):
         """
-        orderL = []
-        for c in self.contacts:
-            proto, host, port, filename = nameurl.UrlParse(c)
-            orderL.append(proto)
-        return orderL
+        Creates Server instance.
 
-    def getContactsAsTuples(self, as_text=False):
-        """
-        """
-        result = []
-        for c in self.contacts:
-            proto, host = c.split(b'://')
-            if as_text:
-                result.append((strng.to_text(proto), strng.to_text(host)))
+        ncpus - the number of worker processes to start on the local
+                computer, if parameter is omitted it will be set to
+                the number of processors in the system
+        ppservers - list of active parallel python execution servers
+                to connect with
+        secret - passphrase for network connections, if omitted a default
+                passphrase will be used. It's highly recommended to use a
+                custom passphrase for all network connections.
+        loglevel - logging level
+        logstream - log stream destination
+        logfile - if not None, will log to file instead of logstream
+        restart - wheather to restart worker process after each task completion
+        proto - protocol number for pickle module
+
+        With ncpus = 1 all tasks are executed consequently
+        For the best performance either use the default "autodetect" value
+        or set ncpus to the total number of processors in the system
+        """
+
+        if not isinstance(ppservers, tuple):
+            raise TypeError('ppservers argument must be a tuple')
+
+        self.__initlog(loglevel, logstream=logstream, logfile=logfile)
+        logging.info('Creating server instance (pp-' + version + ')' + repr(self))
+        self.__tid = 0
+        self.__active_tasks = 0
+        self.__active_tasks_lock = six.moves._thread.allocate_lock()
+        self.__queue = []
+        self.__queue_lock = six.moves._thread.allocate_lock()
+        self.__workers = []
+        self.__rworkers = []
+        self.__rworkers_reserved = []
+        self.__rworkers_reserved4 = []
+        self.__sourcesHM = {}
+        self.__sfuncHM = {}
+        self.__waittasks = []
+        self.__waittasks_lock = six.moves._thread.allocate_lock()
+        self.__exiting = False
+        self.__accurate_stats = True
+        self.autopp_list = {}
+        self.__active_rworkers_list_lock = six.moves._thread.allocate_lock()
+        self.__restart_on_free = restart
+        self.__pickle_proto = proto
+
+        # add local directory and sys.path to PYTHONPATH
+        pythondirs = [os.getcwd()] + sys.path
+
+        if 'PYTHONPATH' in os.environ and os.environ['PYTHONPATH']:
+            pythondirs += os.environ['PYTHONPATH'].split(os.pathsep)
+        os.environ['PYTHONPATH'] = os.pathsep.join(set(pythondirs))
+
+        atexit.register(self.destroy)
+        self.__stats = {'local': _Statistics(0)}
+        self.set_ncpus(ncpus)
+
+        self.ppservers = []
+        self.auto_ppservers = []
+
+        for ppserver in ppservers:
+            ppserver = ppserver.split(':')
+            host = ppserver[0]
+            if len(ppserver) > 1:
+                port = int(ppserver[1])
+            else:
+                port = Server.default_port
+            if host.find('*') == -1:
+                self.ppservers.append((host, port))
             else:
-                result.append((proto, host))
-        return result
+                if host == '*':
+                    host = '*.*.*.*'
+                interface = host.replace('*', '0')
+                broadcast = host.replace('*', '255')
+                self.auto_ppservers.append(((interface, port), (broadcast, port)))
+        self.__stats_lock = six.moves._thread.allocate_lock()
+        if secret is not None:
+            # if not isinstance(secret, bytes):
+            #     raise TypeError("secret must be of a string type")
+            # self.secret = str(secret)
+            self.secret = six.text_type(secret)
+#         elif hasattr(user, "pp_secret"):
+#             secret = user["pp_secret"]
+#             if not isinstance(secret, bytes):
+#                 raise TypeError("secret must be of a string type")
+#             self.secret = str(secret)
+        else:
+            self.secret = Server.default_secret
+        self.__connect()
+        self.__creation_time = time.time()
+        logging.info('pp local server started with %d workers' % (self.__ncpus, ))
+
+    def submit(self, func, args=(), depfuncs=(), modules=(), callback=None, callbackargs=(), group='default', globals=None):
+        """
+        Submits function to the execution queue.
+
+        func - function to be executed
+        args - tuple with arguments of the 'func'
+        depfuncs - tuple with functions which might be called from 'func'
+        modules - tuple with module names to import
+        callback - callback function which will be called with argument
+                list equal to callbackargs+(result,)
+                as soon as calculation is done
+        callbackargs - additional arguments for callback function
+        group - job group, is used when wait(group) is called to wait for
+        jobs in a given group to finish
+        globals - dictionary from which all modules, functions and classes
+        will be imported, for instance: globals=globals()
+        """
+        # perform some checks for frequent mistakes
+        if self.__exiting:
+            raise RuntimeError('Cannot submit jobs: server'
+                               ' instance has been destroyed', )
+
+        if not isinstance(args, tuple):
+            raise TypeError('args argument must be a tuple')
+
+        if not isinstance(depfuncs, tuple):
+            raise TypeError('depfuncs argument must be a tuple')
+
+        if not isinstance(modules, tuple):
+            raise TypeError('modules argument must be a tuple')
+
+        if not isinstance(callbackargs, tuple):
+            raise TypeError('callbackargs argument must be a tuple')
+
+        for module in modules:
+            if not isinstance(module, six.string_types):
+                raise TypeError('modules argument must be a list of strings')
+
+        tid = self.__gentid()
+
+        if globals:
+            modules += tuple(self.__find_modules('', globals))
+            modules = tuple(set(modules))
+            self.__logger.info('Task %i will autoimport next modules: %s' % (tid, six.text_type(modules)))
+            for object1 in globals.values():
+                if isinstance(object1, types.FunctionType) \
+                        or isinstance(object1, type):
+                    depfuncs += (object1, )
+
+        task = _Task(self, tid, callback, callbackargs, group)
+
+        self.__waittasks_lock.acquire()
+        self.__waittasks.append(task)
+        self.__waittasks_lock.release()
+
+        # if the function is a method of a class add self to the arguments list
+        if isinstance(func, types.MethodType) and func.__self__ is not None:
+            args = (func.__self__, ) + args
+
+        # if there is an instance of a user defined class in the arguments add
+        # whole class to dependancies
+        # for arg in args:
+        #     # Checks for both classic or new class instances
+        #     if isinstance(arg, object) or str(type(arg))[:6] == "<class":
+        #         depfuncs += (arg.__class__, )
+
+        # if there is a function in the arguments add this
+        # function to dependancies
+        for arg in args:
+            if isinstance(arg, types.FunctionType):
+                depfuncs += (arg, )
+
+        sfunc = self.__dumpsfunc((func, ) + depfuncs, modules)
+        # sargs = pickle.dumps(args, self.__pickle_proto)
+        sargs = json.dumps({
+            'v': args,
+        })
+
+        self.__queue_lock.acquire()
+        self.__queue.append((task, sfunc, sargs))
+        self.__queue_lock.release()
+
+        self.__logger.info("Task %i submited, function='%s'" % (tid, func.__name__))
+        self.__scheduler()
+        return task
+
+    def cancel(self, taskID):
+        """
+        Cancel a task.
+        """
+
+        wtask = None
+        self.__waittasks_lock.acquire()
+        for i in range(len(self.__waittasks)):
+            wtask = self.__waittasks[i]
+            if wtask.tid == taskID:
+                self.__waittasks[i].cancelled = True
+                break
+        self.__waittasks_lock.release()
 
-    def getContactsByProto(self):
-        """
-        Return a dictionary of all contacts where keys are protos.
-        """
-        d = {}
-        for i in range(len(self.contacts)):
-            proto, x, x, x = nameurl.UrlParse(self.contacts[i])
-            d[proto] = self.contacts[i]
-        return d
+        if not wtask:
+            return
 
-    def getContactProto(self, index):
-        """
-        Return a proto part of the contact at given position.
-        """
-        c = self.getContact(index)
-        if c is None:
-            return None
-        return nameurl.UrlParse(c)[0]
+        if wtask.worker_pid:
+            for worker in self.__workers:
+                if worker.pid == wtask.worker_pid:
+
+                    nworker = _Worker(self.__restart_on_free, self.__pickle_proto)
+                    self.__workers.append(nworker)
+                    self.__logger.info('Started new worker, new process %i created' % (nworker.pid))
+
+                    worker.t.exiting = True
+                    if sys.platform.startswith('win'):
+                        os.popen('TASKKILL /PID ' + six.text_type(worker.pid) + ' /F')
+                    else:
+                        try:
+                            os.kill(worker.pid, 9)
+                            os.waitpid(worker.pid, 0)
+                        except:
+                            pass
+
+                    self.__workers.remove(worker)
+                    self.__logger.info('Running task %i cancelled, process %i killed' % (taskID, wtask.worker_pid))
+                    break
+
+        else:
 
-    def getPublicKey(self):
+            self.__queue_lock.acquire()
+            for i in range(len(self.__queue)):
+                if self.__queue[i][0].tid == taskID:
+                    self.__queue.pop(i)
+            self.__queue_lock.release()
+
+            self.__waittasks_lock.acquire()
+            for i in range(len(self.__waittasks)):
+                if self.__waittasks[i].tid == taskID:
+                    self.__waittasks.pop(i)
+                    break
+            self.__waittasks_lock.release()
+
+            self.__logger.info('Scheduled task %i cancelled' % taskID)
+
+        self.__scheduler()
+
+    def wait(self, group=None):
+        """
+        Waits for all jobs in a given group to finish.
+
+        If group is omitted waits for all jobs to finish
+        """
+        while True:
+            self.__waittasks_lock.acquire()
+            for task in self.__waittasks:
+                if not group or task.group == group:
+                    self.__waittasks_lock.release()
+                    task.wait()
+                    break
+            else:
+                self.__waittasks_lock.release()
+                break
+
+    def get_ncpus(self):
         """
-        Returns public key as binary string.
+        Returns the number of local worker processes (ppworkers)
         """
-        return self.publickey
+        return self.__ncpus
 
-    def getSignature(self):
+    def set_ncpus(self, ncpus='autodetect'):
         """
-        Returns signature as binary string.
+        Sets the number of local worker processes (ppworkers)
+
+        ncpus - the number of worker processes, if parammeter is omitted
+                it will be set to the number of processors in the system
         """
-        return self.signature
+        if ncpus == 'autodetect':
+            ncpus = self.__detect_ncpus()
+        if not isinstance(ncpus, int):
+            raise TypeError("ncpus must have 'int' type")
+        if ncpus < 0:
+            raise ValueError('ncpus must be an integer > 0')
+        if ncpus > len(self.__workers):
+            try:
+                self.__workers.extend([_Worker(self.__restart_on_free, self.__pickle_proto) for x in range(ncpus - len(self.__workers))])
+            except:
+                traceback.print_exc()
+        self.__stats['local'].ncpus = ncpus
+        self.__ncpus = ncpus
 
-    def getIP(self, proto=None):
+    def get_active_nodes(self):
         """
-        A smart way to get the IP address of the user.
+        Returns active nodes as a dictionary.
 
-        Check TCP proto if available and get host from contact.
+        [keys - nodes, values - ncpus]
         """
-        if proto:
-            host = self.getProtoHost(proto)
-            if host:
-                return host
-        return self.getProtoHost('tcp')
+        active_nodes = {}
+        for node, stat in self.__stats.items():
+            if node == 'local' or node in self.autopp_list \
+                    and self.autopp_list[node]:
+                active_nodes[node] = stat.ncpus
+        return active_nodes
 
-    def getDateStr(self):
+    def get_stats(self):
         """
-        Returns identity creation date as string.
+        Returns job execution statistics as a dictionary.
         """
-        return strng.to_text(self.date)
+        for node, stat in self.__stats.items():
+            if stat.rworker:
+                try:
+                    stat.rworker.send('TIME')
+                    stat.time = float(stat.rworker.receive())
+                except:
+                    self.__accurate_stats = False
+                    stat.time = 0.0
+        return self.__stats
 
-    def getPostageValue(self):
+    def print_stats(self):
         """
-        Returns price for message delivery if not on correspondents list.
-        Not used at the moment.
+        Prints job execution statistics.
+
+        Useful for benchmarking on clusters
         """
-        return int(self.postage)
 
-    def getVersionStr(self):
+        print('Job execution statistics:')
+        walltime = time.time() - self.__creation_time
+        statistics = list(self.get_stats().items())
+        totaljobs = 0.0
+        for ppserver, stat in statistics:
+            totaljobs += stat.njobs
+        print(
+            ' job count | % of all jobs | job time sum | ' \
+            'time per job | job server',
+        )
+        for ppserver, stat in statistics:
+            if stat.njobs:
+                print(
+                    '    %6i |        %6.2f |     %8.4f |  %11.6f | %s' \
+                    % (
+                        stat.njobs, 100.0 * stat.njobs / totaljobs, stat.time,
+                        stat.time / stat.njobs, ppserver, ),
+                )
+        print('Time elapsed since server creation', walltime)
+
+        if not self.__accurate_stats:
+            print(
+                'WARNING: statistics provided above is not accurate' \
+                  ' due to job rescheduling',
+            )
+        print()
+
+    # all methods below are for internal use only
+
+    def insert(self, sfunc, sargs, task=None):
+        """
+        Inserts function into the execution queue.
+
+        It's intended for internal use only (ppserver.py).
+        """
+        if not task:
+            tid = self.__gentid()
+            task = _Task(self, tid)
+        self.__queue_lock.acquire()
+        self.__queue.append((task, sfunc, sargs))
+        self.__queue_lock.release()
+
+        self.__logger.info('Task %i inserted' % (task.tid, ))
+        self.__scheduler()
+        return task
+
+    def connect1(self, host, port, persistent=True):
         """
-        Returns a version string - some info about BitDust software and platform.
-        Just informative thing, no real logic around it yet.
+        Conects to a remote ppserver specified by host and port.
         """
-        return strng.to_text(self.version)
+        try:
+            rworker = _RWorker(host, port, self.secret, 'STAT', persistent)
+            ncpus = int(rworker.receive())
+            hostid = host + ':' + six.text_type(port)
+            self.__stats[hostid] = _Statistics(ncpus, rworker)
+
+            for x in range(ncpus):
+                rworker = _RWorker(host, port, self.secret, 'EXEC', persistent)
+                self.__update_active_rworkers(rworker.id, 1)
+                # append is atomic - no need to lock self.__rworkers
+                self.__rworkers.append(rworker)
+            # creating reserved rworkers
+            for x in range(ncpus):
+                rworker = _RWorker(host, port, self.secret, 'EXEC', persistent)
+                self.__update_active_rworkers(rworker.id, 1)
+                self.__rworkers_reserved.append(rworker)
+            # creating reserved4 rworkers
+            for x in range(ncpus*0):
+                rworker = _RWorker(host, port, self.secret, 'EXEC', persistent)
+                #                    self.__update_active_rworkers(rworker.id, 1)
+                self.__rworkers_reserved4.append(rworker)
+            logging.info('Connected to ppserver (host=%s, port=%i) \
+                    with %i workers' % (host, port, ncpus))
+            self.__scheduler()
+        except:
+            pass
+#            sys.excepthook(*sys.exc_info())
 
-    def getRevisionValue(self):
+    def __connect(self):
         """
-        Returns identity revision number.
-        Every time identity changes, identity must increment by one.
+        Connects to all remote ppservers.
         """
-        return int(self.revision)
+        for ppserver in self.ppservers:
+            six.moves._thread.start_new_thread(self.connect1, ppserver)
 
-    #------------------------------------------------------------------------------
+        discover = ppauto.Discover(self, True)
+        for ppserver in self.auto_ppservers:
+            six.moves._thread.start_new_thread(discover.run, ppserver)
 
-    def setSources(self, sources_list):
+    def __detect_ncpus(self):
         """
+        Detects the number of effective CPUs in the system.
         """
-        self.sources = []
-        for source in sources_list:
-            s = id_url.field(source)
-            s.refresh()
-            self.sources.append(s)
+        # for Linux, Unix and MacOS
+        if hasattr(os, 'sysconf'):
+            if 'SC_NPROCESSORS_ONLN' in os.sysconf_names:
+                #Linux and Unix
+                ncpus = os.sysconf('SC_NPROCESSORS_ONLN')
+                if isinstance(ncpus, int) and ncpus > 0:
+                    return ncpus
+            else:
+                # MacOS X
+                return int(os.popen2('sysctl -n hw.ncpu')[1].read())  # @UndefinedVariable
+        # for Windows
+        if 'NUMBER_OF_PROCESSORS' in os.environ:
+            ncpus = int(os.environ['NUMBER_OF_PROCESSORS'])
+            if ncpus > 0:
+                return ncpus
+        # return the default value
+        return 1
 
-    def setContacts(self, contacts_list):
+    def __initlog(self, loglevel, logstream=None, logfile=None):
         """
+        Initializes logging facility.
         """
-        self.contacts = []
-        for cont in contacts_list:
-            self.contacts.append(strng.to_bin(cont))
+        if logfile:
+            log_handler = logging.FileHandler(logfile)
+        else:
+            log_handler = logging.StreamHandler(logstream)
+        log_handler.setLevel(loglevel)
+        LOG_FORMAT = '        %(levelname)s %(message)s'
+        log_handler.setFormatter(logging.Formatter(LOG_FORMAT))
+        self.__logger = logging.getLogger('')
+        self.__logger.addHandler(log_handler)
+        self.__logger.setLevel(loglevel)
+
+    def __dumpsfunc(self, funcs, modules):
+        """
+        Serializes functions and modules.
+        """
+        hashs = hash(funcs + modules)
+        if hashs not in self.__sfuncHM:
+            sources = [self.__get_source(func) for func in funcs]
+            # self.__sfuncHM[hashs] = pickle.dumps(
+            #     (funcs[0].__name__, sources, modules),
+            #     self.__pickle_proto)
+            self.__sfuncHM[hashs] = json.dumps({
+                'v': (funcs[0].__name__, sources, modules),
+            })
+        return self.__sfuncHM[hashs]
+
+    def __find_modules(self, prefix, dict):
+        """
+        recursively finds all the modules in dict.
+        """
+        modules = []
+        for name, object in dict.items():
+            if isinstance(object, types.ModuleType) \
+                    and name not in ('__builtins__', 'pp'):
+                if object.__name__ == prefix + name or prefix == '':
+                    modules.append(object.__name__)
+                    modules.extend(self.__find_modules(object.__name__ + '.', object.__dict__))
+        return modules
+
+    def __scheduler(self):
+        """
+        Schedules jobs for execution.
+        """
+        self.__queue_lock.acquire()
+        while self.__queue:
+            if self.__active_tasks < self.__ncpus:
+                # TODO: select a job number on the basis of heuristic
+                task = self.__queue.pop(0)
+                for worker in self.__workers:
+                    if worker.is_free:
+                        worker.is_free = False
+                        break
+                else:
+                    self.__logger.error('There are no free workers left')
+                    raise RuntimeError('Error: No free workers')
+                self.__add_to_active_tasks(1)
+                try:
+                    self.__stats['local'].njobs += 1
+                    six.moves._thread.start_new_thread(self.__run, task + (worker, ))
+                except:
+                    pass
+                for i in range(len(self.__waittasks)):
+                    if self.__waittasks[i].tid == task[0].tid:
+                        self.__waittasks[i].worker_pid = worker.pid
+                        break
+            else:
+                for rworker in self.__rworkers:
+                    if rworker.is_free:
+                        rworker.is_free = False
+                        task = self.__queue.pop(0)
+                        self.__stats[rworker.id].njobs += 1
+                        six.moves._thread.start_new_thread(self.__rrun, task + (rworker, ))
+                        break
+                else:
+                    if len(self.__queue) > self.__ncpus:
+                        for rworker in self.__rworkers_reserved:
+                            if rworker.is_free:
+                                rworker.is_free = False
+                                task = self.__queue.pop(0)
+                                self.__stats[rworker.id].njobs += 1
+                                six.moves._thread.start_new_thread(self.__rrun, task + (rworker, ))
+                                break
+                        else:
+                            break
+                            # this code will not be executed
+                            # and is left for further releases
+                            if len(self.__queue) > self.__ncpus*0:
+                                for rworker in self.__rworkers_reserved4:
+                                    if rworker.is_free:
+                                        rworker.is_free = False
+                                        task = self.__queue.pop(0)
+                                        self.__stats[rworker.id].njobs += 1
+                                        six.moves._thread.start_new_thread(self.__rrun, task + (rworker, ))
+                                        break
+                    else:
+                        break
+
+        self.__queue_lock.release()
+
+    def __get_source(self, func):
+        """
+        Fetches source of the function.
+        """
+        hashf = hash(func)
+        if hashf not in self.__sourcesHM:
+            # get lines of the source and adjust indent
+            sourcelines = inspect.getsourcelines(func)[0]
+            # remove indentation from the first line
+            sourcelines[0] = sourcelines[0].lstrip()
+            self.__sourcesHM[hashf] = ''.join(sourcelines)
+        return self.__sourcesHM[hashf]
 
-    def setContactsFromDict(self, contacts_dict, contacts_order=None):
+    def __rrun(self, job, sfunc, sargs, rworker):
         """
+        Runs a job remotelly.
         """
-        if contacts_order is None:
-            contacts_order = list(contacts_dict.keys())
-        for proto in contacts_order:
-            self.contacts.append(strng.to_bin(contacts_dict[proto]))
+        self.__logger.info('Task (remote) %i started' % (job.tid, ))
 
-    def setContact(self, contact, index):
-        """
-        Set a string value ``contact`` at given ``index`` position in the list.
-        """
         try:
-            self.contacts[index] = strng.to_bin(contact)
+            rworker.send(sfunc)
+            rworker.send(sargs)
+            sresult = rworker.receive()
+            rworker.is_free = True
         except:
-            lg.exc()
+            self.__logger.info('Task %i failed due to broken network '
+                               'connection - rescheduling' % (job.tid, ), )
+            self.insert(sfunc, sargs, job)
+            self.__scheduler()
+            self.__update_active_rworkers(rworker.id, -1)
+            if rworker.connect('EXEC'):
+                self.__update_active_rworkers(rworker.id, 1)
+                self.__scheduler()
+            return
 
-    def setProtoContact(self, proto, contact):
-        """
-        Found a contact with given ``proto`` and set its value or append a new
-        contact.
-        """
-        for i in range(0, len(self.contacts)):
-            proto_, _, _, _ = nameurl.UrlParse(self.contacts[i])
-            if proto_.strip() == strng.to_bin(proto).strip():
-                self.contacts[i] = strng.to_bin(contact)
-                return
-        self.contacts.append(strng.to_bin(contact))
+        job.finalize(sresult)
 
-    def setContactParts(self, index, protocol, host, port, filename):
-        """
-        Set a contact at given position by its 4 parts.
-        """
-        url = nameurl.UrlMake(protocol, host, port, filename)
-        self.contacts[index] = strng.to_bin(url).strip()
+        # remove the job from the waiting list
+        if self.__waittasks:
+            self.__waittasks_lock.acquire()
+            self.__waittasks.remove(job)
+            self.__waittasks_lock.release()
 
-    def setContactHost(self, host, index):
-        """
-        This is to set only host part of the contact.
-        """
-        protocol, _, port, filename = nameurl.UrlParse(self.contacts[index])
-        url = nameurl.UrlMake(protocol, host, port, filename)
-        self.contacts[index] = strng.to_bin(url).strip()
+        self.__logger.info('Task (remote) %i ended' % (job.tid, ))
+        self.__scheduler()
 
-    def setContactPort(self, index, newport):
+    def __run(self, job, sfunc, sargs, worker):
         """
-        This is useful when listening port get changed.
+        Runs a job locally.
         """
-        protocol, host, _, filename = nameurl.UrlParse(self.contacts[index])
-        url = nameurl.UrlMake(protocol, host, newport, filename)
-        self.contacts[index] = strng.to_bin(url).strip()
 
-    def setPublicKey(self, pub_key_raw):
-        """
-        """
-        self.publickey = strng.to_bin(pub_key_raw)
+        if self.__exiting:
+            return
+        self.__logger.info('Task %i started' % (job.tid, ))
 
-    def setSignature(self, signature_raw):
-        """
-        """
-        self.signature = strng.to_bin(signature_raw)
+        start_time = time.time()
 
-    def setCertificates(self, certificates_list):
-        """
-        Not used yet.
-        """
-        self.certificates = []
-        for cert in certificates_list:
-            self.certificates.append(strng.to_bin(cert))
+        sresult = None
+        try:
+            worker.t.send(sfunc)
+            worker.t.send(sargs)
+            sresult = worker.t.receive()
+        except:
+            if self.__exiting:
+                return
+            else:
+                if not job.cancelled:
+                    sys.excepthook(*sys.exc_info())
 
-    def setScrubbers(self, scrubbers_list):
-        """
-        Not used yet.
-        """
-        self.scrubbers = []
-        for scrub in scrubbers_list:
-            self.scrubbers.append(strng.to_bin(scrub))
+        worker.free()
 
-    def setDate(self, date_string):
-        """
-        """
-        self.date = strng.to_bin(date_string)
+        job.finalize(sresult)
 
-    def setPostage(self, postage_value):
-        """
-        """
-        self.postage = strng.to_bin(str(postage_value))
+        # remove the job from the waiting list
+        if self.__waittasks:
+            self.__waittasks_lock.acquire()
+            self.__waittasks.remove(job)
+            self.__waittasks_lock.release()
+
+        self.__add_to_active_tasks(-1)
+        if not self.__exiting:
+            self.__stat_add_time('local', time.time() - start_time)
+        self.__logger.info('Task %i ended' % (job.tid, ))
+        self.__scheduler()
 
-    def setVersion(self, version_string):
+    def __add_to_active_tasks(self, num):
         """
+        Updates the number of active tasks.
         """
-        self.version = strng.to_bin(version_string).strip()
+        self.__active_tasks_lock.acquire()
+        self.__active_tasks += num
+        self.__active_tasks_lock.release()
 
-    def setRevision(self, revision):
+    def __stat_add_time(self, node, time_add):
         """
+        Updates total runtime on the node.
         """
-        self.revision = strng.to_bin(str(revision))
+        self.__stats_lock.acquire()
+        self.__stats[node].time += time_add
+        self.__stats_lock.release()
 
-    #------------------------------------------------------------------------------
-
-    def clearContacts(self):
+    def __stat_add_job(self, node):
         """
-        Erase all items in identity contacts list.
+        Increments job count on the node.
         """
-        self.contacts = []
+        self.__stats_lock.acquire()
+        self.__stats[node].njobs += 1
+        self.__stats_lock.release()
 
-    def deleteProtoContact(self, proto):
+    def __update_active_rworkers(self, id, count):
         """
-        Remove all contacts with given ``proto``.
+        Updates list of active rworkers.
         """
-        for contact in self.contacts:
-            if contact.find(strng.to_bin(proto) + b'://') == 0:
-                self.contacts.remove(contact)
+        self.__active_rworkers_list_lock.acquire()
 
-    def pushProtoContact(self, proto):
-        """
-        Move given protocol in the bottom of the contacts list.
+        if id not in self.autopp_list:
+            self.autopp_list[id] = 0
+        self.autopp_list[id] += count
 
-        First contact in the list have more priority for remote machine,
-        so we can manipulate our protos to get more p2p connections.
-        Push less reliable protocols to the end of the list. This is to
-        decrease its priority.
-        """
-        i = self.getContactIndex(proto=proto)
-        if i < 0:
-            return
-        contact = self.contacts[i]
-        del self.contacts[i]
-        self.contacts.append(contact)
+        self.__active_rworkers_list_lock.release()
 
-    def popProtoContact(self, proto):
+    def __gentid(self):
         """
-        Move given protocol to the top of the contacts list.
-
-        This is to increase its priority.
+        Generates a unique job ID number.
         """
-        i = self.getContactIndex(proto=proto)
-        if i < 0:
-            return
-        contact = self.contacts[i]
-        del self.contacts[i]
-        self.contacts.insert(0, contact)
-
-
-#-------------------------------------------------------------------------------
-
-
-def test1():
-    """
-    Some tests.
-    """
-    from bitdust.userid import my_id
-    myidentity = my_id.getLocalIdentity()
-    print('getIP =', myidentity.getIP())
-    if myidentity.Valid():
-        print('myidentity is Valid!!!!')
-    else:
-        print('myidentity is not Valid')
-        my_id.saveLocalIdentity()  # sign and save
-        raise Exception('myidentity is not Valid')
-    print('myidentity.contacts')
-    print(myidentity.contacts)
-    print('len myidentity.contacts ')
-    print(len(myidentity.contacts))
-    print('len myidentity.contacts[0] ')
-    print(myidentity.contacts[0])
-    con = myidentity.getContact()
-    print('con:', con, type(con))
-    protocol, machine, port, filename = nameurl.UrlParse(con)
-    print(protocol, machine, port, filename)
-    print('identity.main serialize:\n', myidentity.serialize())
-    for index in range(myidentity.getContactsNumber()):
-        proto, host, port, filename = myidentity.getContactParts(index)
-        print('[%s] [%s] [%s] [%s]' % (proto, host, port, filename))
-
-
-def test2():
-    """
-    More tests.
-    """
-    from bitdust.userid import my_id
-    ident = my_id.buildDefaultIdentity()
-    print(ident.serialize())
-
-
-#------------------------------------------------------------------------------
+        self.__tid += 1
+        return self.__tid - 1
 
+    def destroy(self):
+        """
+        Kills ppworkers and closes open files.
+        """
+        self.__exiting = True
+        self.__queue_lock.acquire()
+        self.__queue = []
+        self.__queue_lock.release()
 
-def main():
-    """
-    This should print a current identity or create a new one.
-    """
-    settings.init()
-    from bitdust.userid import my_id
-    my_id.loadLocalIdentity()
-    if my_id.isLocalIdentityReady():
-        my_id.getLocalIdentity().sign()
-        print(my_id.getLocalIdentity().serialize())
-        print('Valid is: ', my_id.getLocalIdentity().Valid())
-    else:
-        if not key.InitMyKey():
-            key.GenerateNewKey()
-        ipaddr = '127.0.0.1'
-        if len(sys.argv) > 2:
-            ipaddr = sys.argv[2]
-        rev = 0
-        if len(sys.argv) > 3:
-            rev = int(sys.argv[3])
-        idurls = []
-        if len(sys.argv) > 4:
-            idurls = sys.argv[4:]
-        my_id.setLocalIdentity(my_id.buildDefaultIdentity(name=sys.argv[1], ip=ipaddr, idurls=idurls, revision=rev))
-        my_id.saveLocalIdentity()
-        print(my_id.getLocalIdentity().serialize())
-        print('Valid is: ', my_id.getLocalIdentity().Valid())
-        my_id._LocalIdentity = None
-        my_id.loadLocalIdentity()
-    settings.shutdown()
+        for worker in self.__workers:
+            worker.t.exiting = True
+            if sys.platform.startswith('win'):
+                os.popen('TASKKILL /PID ' + six.text_type(worker.pid) + ' /F')
+            else:
+                try:
+                    os.kill(worker.pid, 9)
+                    os.waitpid(worker.pid, 0)
+                except:
+                    pass
 
 
-def update():
-    """
-    A good way to check all things - load and sign again.
-    Also will test rebuilding of the identity
-    """
-    from bitdust.userid import my_id
-    bpio.init()
-    settings.init()
-    src = bpio.ReadTextFile(settings.LocalIdentityFilename())
-    print(src)
-    my_id.setLocalIdentity(identity(xmlsrc=src))
-    my_id.getLocalIdentity().sign()
-    my_id.saveLocalIdentity()
-    print(my_id.getLocalIdentity().serialize())
-    print(my_id.rebuildLocalIdentity(revision_up=True))
-    settings.shutdown()
-
-
-#------------------------------------------------------------------------------
-
-if __name__ == '__main__':
-    lg.set_debug_level(18)
-    main()
-    # update()
+# Parallel Python Software: http://www.parallelpython.com
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/known_servers.py` & `bitdust-0.1.9.241/bitdust/userid/known_servers.py`

 * *Files 0% similar despite different names*

```diff
@@ -74,15 +74,15 @@
     from bitdust.main import config
     from bitdust.lib import strng
 
     if _KnownServers is not None:
         return _KnownServers
 
     try:
-        overridden_identity_servers_str = str(config.conf().getData('services/identity-propagate/known-servers'))
+        overridden_identity_servers_str = str(config.conf().getString('services/identity-propagate/known-servers'))
     except:
         overridden_identity_servers_str = ''
 
     if not overridden_identity_servers_str:
         _KnownServers = default_nodes()
         return _KnownServers
```

### Comparing `bitdust-0.1.8.234/bitdust/userid/my_id.py` & `bitdust-0.1.9.241/bitdust/userid/my_id.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust.egg-info/PKG-INFO` & `bitdust-0.1.9.241/bitdust.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bitdust
-Version: 0.1.8.234
+Version: 0.1.9.241
 Summary: p2p secure distributed storage and communication engine
 Home-page: https://bitdust.io
 Download-URL: https://bitdust.io
 Author: Veselin Penev, BitDust
 Author-email: bitdust.io@gmail.com
 Maintainer: Veselin Penev, BitDust
 Maintainer-email: veselin@bitdust.io
```

### Comparing `bitdust-0.1.8.234/bitdust.egg-info/SOURCES.txt` & `bitdust-0.1.9.241/bitdust.egg-info/SOURCES.txt`

 * *Files 12% similar despite different names*

```diff
@@ -5,28 +5,37 @@
 bitdust.egg-info/PKG-INFO
 bitdust.egg-info/SOURCES.txt
 bitdust.egg-info/dependency_links.txt
 bitdust.egg-info/requires.txt
 bitdust.egg-info/top_level.txt
 bitdust/access/__init__.py
 bitdust/access/group_access_donor.py
-bitdust/access/group_member.py
+bitdust/access/group_participant.py
 bitdust/access/groups.py
 bitdust/access/key_ring.py
 bitdust/access/shared_access_coordinator.py
 bitdust/access/shared_access_donor.py
 bitdust/automats/__init__.py
 bitdust/automats/automat.py
 bitdust/automats/global_state.py
 bitdust/blockchain/__init__.py
+bitdust/blockchain/authority_node.py
+bitdust/blockchain/bismuth_miner.py
+bitdust/blockchain/bismuth_node.py
+bitdust/blockchain/bismuth_pool.py
+bitdust/blockchain/bismuth_wallet.py
+bitdust/blockchain/blockchain_explorer.py
+bitdust/blockchain/blockchain_registrator.py
+bitdust/blockchain/known_bismuth_nodes.py
 bitdust/broadcast/__init__.py
 bitdust/broadcast/broadcast_listener.py
 bitdust/broadcast/broadcast_service.py
 bitdust/broadcast/broadcaster_node.py
 bitdust/broadcast/broadcasters_finder.py
+bitdust/broadcast/service_broadcasting.py
 bitdust/chat/__init__.py
 bitdust/chat/kbhit.py
 bitdust/chat/message_database.py
 bitdust/chat/message_keeper.py
 bitdust/chat/nickname_holder.py
 bitdust/chat/nickname_observer.py
 bitdust/chat/terminal_chat.py
@@ -38,14 +47,17 @@
 bitdust/coins/coins_io.py
 bitdust/coins/coins_miner.py
 bitdust/coins/contract_chain_consumer.py
 bitdust/coins/contract_chain_node.py
 bitdust/coins/customer_contract_executor.py
 bitdust/coins/mine_old.py
 bitdust/coins/miner_old.py
+bitdust/coins/service_accountant.py
+bitdust/coins/service_contract_chain.py
+bitdust/coins/service_miner.py
 bitdust/coins/supplier_contract_executor.py
 bitdust/contacts/__init__.py
 bitdust/contacts/contactsdb.py
 bitdust/contacts/friends.py
 bitdust/contacts/identitycache.py
 bitdust/contacts/identitydb.py
 bitdust/crypt/__init__.py
@@ -59,28 +71,30 @@
 bitdust/crypt/rsa_key.py
 bitdust/crypt/signed.py
 bitdust/currency/__init__.py
 bitdust/currency/geth_service.py
 bitdust/customer/__init__.py
 bitdust/customer/fire_hire.py
 bitdust/customer/list_files_orator.py
+bitdust/customer/payment.py
 bitdust/customer/supplier_connector.py
 bitdust/customer/supplier_finder.py
 bitdust/dht/__init__.py
 bitdust/dht/dht_records.py
 bitdust/dht/dht_relations.py
 bitdust/dht/dht_service.py
 bitdust/dht/known_nodes.py
 bitdust/interface/__init__.py
 bitdust/interface/api.py
 bitdust/interface/api_rest_http_server.py
 bitdust/interface/api_web_socket.py
 bitdust/interface/cmd_line_json.py
 bitdust/interface/cmd_line_json_templates.py
 bitdust/interface/ftp_server.py
+bitdust/interface/web_html_template.py
 bitdust/lib/__init__.py
 bitdust/lib/diskspace.py
 bitdust/lib/getsizeof.py
 bitdust/lib/jsn.py
 bitdust/lib/jsontemplate.py
 bitdust/lib/maths.py
 bitdust/lib/misc.py
@@ -138,20 +152,25 @@
 bitdust/raid/raidutils.py
 bitdust/raid/read.py
 bitdust/raid/rebuild.py
 bitdust/raid/worker.py
 bitdust/services/__init__.py
 bitdust/services/driver.py
 bitdust/services/local_service.py
-bitdust/services/service_accountant.py
 bitdust/services/service_backup_db.py
 bitdust/services/service_backups.py
-bitdust/services/service_blockchain.py
-bitdust/services/service_broadcasting.py
-bitdust/services/service_contract_chain.py
+bitdust/services/service_bismuth_blockchain.py
+bitdust/services/service_bismuth_identity.py
+bitdust/services/service_bismuth_miner.py
+bitdust/services/service_bismuth_node.py
+bitdust/services/service_bismuth_pool.py
+bitdust/services/service_bismuth_wallet.py
+bitdust/services/service_blockchain_authority.py
+bitdust/services/service_blockchain_explorer.py
+bitdust/services/service_blockchain_id.py
 bitdust/services/service_customer.py
 bitdust/services/service_customer_contracts.py
 bitdust/services/service_customer_family.py
 bitdust/services/service_customer_patrol.py
 bitdust/services/service_customer_support.py
 bitdust/services/service_data_disintegration.py
 bitdust/services/service_data_motion.py
@@ -159,20 +178,20 @@
 bitdust/services/service_entangled_dht.py
 bitdust/services/service_gateway.py
 bitdust/services/service_http_connections.py
 bitdust/services/service_http_transport.py
 bitdust/services/service_identity_propagate.py
 bitdust/services/service_identity_server.py
 bitdust/services/service_ip_port_responder.py
+bitdust/services/service_joint_postman.py
 bitdust/services/service_keys_registry.py
 bitdust/services/service_keys_storage.py
 bitdust/services/service_list_files.py
 bitdust/services/service_message_broker.py
 bitdust/services/service_message_history.py
-bitdust/services/service_miner.py
 bitdust/services/service_my_data.py
 bitdust/services/service_my_ip_port.py
 bitdust/services/service_network.py
 bitdust/services/service_nodes_lookup.py
 bitdust/services/service_p2p_hookups.py
 bitdust/services/service_p2p_notifications.py
 bitdust/services/service_personal_messages.py
@@ -187,51 +206,48 @@
 bitdust/services/service_supplier_contracts.py
 bitdust/services/service_tcp_connections.py
 bitdust/services/service_tcp_transport.py
 bitdust/services/service_udp_datagrams.py
 bitdust/services/service_udp_transport.py
 bitdust/storage/__init__.py
 bitdust/storage/accounting.py
-bitdust/storage/archive_reader.py
-bitdust/storage/archive_writer.py
 bitdust/storage/backup.py
 bitdust/storage/backup_control.py
 bitdust/storage/backup_fs.py
 bitdust/storage/backup_matrix.py
 bitdust/storage/backup_monitor.py
 bitdust/storage/backup_rebuilder.py
 bitdust/storage/backup_schedule.py
 bitdust/storage/backup_tar.py
 bitdust/storage/index_synchronizer.py
 bitdust/storage/keys_synchronizer.py
 bitdust/storage/restore_monitor.py
 bitdust/storage/restore_worker.py
 bitdust/storage/tar_file.py
 bitdust/stream/__init__.py
-bitdust/stream/broker_negotiator.py
 bitdust/stream/data_receiver.py
 bitdust/stream/data_sender.py
 bitdust/stream/file_down.py
 bitdust/stream/file_up.py
 bitdust/stream/io_throttle.py
 bitdust/stream/message.py
-bitdust/stream/message_peddler.py
 bitdust/stream/message_producer.py
 bitdust/stream/p2p_queue.py
-bitdust/stream/queue_keeper.py
+bitdust/stream/postman.py
 bitdust/stun/__init__.py
 bitdust/stun/stun_client.py
 bitdust/stun/stun_server.py
 bitdust/supplier/__init__.py
 bitdust/supplier/customer_assistant.py
 bitdust/supplier/customer_space.py
 bitdust/supplier/customers_rejector.py
 bitdust/supplier/family_member.py
 bitdust/supplier/list_files.py
 bitdust/supplier/local_tester.py
+bitdust/supplier/storage_contract.py
 bitdust/system/__init__.py
 bitdust/system/bpio.py
 bitdust/system/child_process.py
 bitdust/system/deploy.py
 bitdust/system/dirsize.py
 bitdust/system/diskusage.py
 bitdust/system/local_fs.py
@@ -320,15 +336,14 @@
 bitdust_forks/Bismuth/peershandler.py
 bitdust_forks/Bismuth/plugins.py
 bitdust_forks/Bismuth/process_search.py
 bitdust_forks/Bismuth/quantizer.py
 bitdust_forks/Bismuth/regnet.py
 bitdust_forks/Bismuth/rewards_reindex.py
 bitdust_forks/Bismuth/rewards_test.py
-bitdust_forks/Bismuth/rpcconnections.py
 bitdust_forks/Bismuth/send_csv.py
 bitdust_forks/Bismuth/send_nogui_noconf.py
 bitdust_forks/Bismuth/simplecrypt.py
 bitdust_forks/Bismuth/staking.py
 bitdust_forks/Bismuth/tokensv2.py
 bitdust_forks/Bismuth/wallet_keys.py
 bitdust_forks/Bismuth/wallet_server.py
@@ -415,20 +430,8 @@
 bitdust_forks/websocket/_http.py
 bitdust_forks/websocket/_logging.py
 bitdust_forks/websocket/_socket.py
 bitdust_forks/websocket/_ssl_compat.py
 bitdust_forks/websocket/_url.py
 bitdust_forks/websocket/_utils.py
 scripts/bitdust
-scripts/bitdust_worker
-tests/test_backup_fs.py
-tests/test_backup_restore.py
-tests/test_codernity_db.py
-tests/test_crypt_signed.py
-tests/test_id_url.py
-tests/test_identity.py
-tests/test_my_keys.py
-tests/test_raid_make_read.py
-tests/test_raid_manager.py
-tests/test_raid_worker.py
-tests/test_rsa_key.py
-tests/test_serialize.py
+scripts/bitdust_worker
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/aliases.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/aliases.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/aliasesv2.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/aliasesv2.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/apihandler.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/apihandler.py`

 * *Files 0% similar despite different names*

```diff
@@ -699,15 +699,15 @@
             transaction_id = connections.receive(socket_handler)
             # and format
             format = connections.receive(socket_handler)
             # raw tx details
             if self.config.old_sqlite:
                 db_handler.execute_param(db_handler.h, 'SELECT * FROM transactions WHERE signature like ?1', (transaction_id + '%', ))
             else:
-                db_handler.execute_param(db_handler.h, 'SELECT * FROM transactions WHERE substr(signature,1,4)=substr(?1,1,4) and  signature like ?1', (transaction_id + '%', ))
+                db_handler.execute_param(db_handler.h, 'SELECT * FROM transactions WHERE substr(signature,1,4)=substr(?1,1,4) and signature like ?1', (transaction_id + '%', ))
             raw = db_handler.h.fetchone()
             if not format:
                 connections.send(socket_handler, raw)
                 print('api_gettransaction', format, raw)
                 return
 
             # current block height, needed for confirmations #
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/balance_nogui.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/balance_nogui.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/check_tx.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/check_tx.py`

 * *Files 2% similar despite different names*

```diff
@@ -42,15 +42,15 @@
         return (False, None)
 
 
 def is_in_ledger(txid):
     """
 	If txid is in ledger, sends back details of the tx and number of confirmations
 	"""
-    ledger = sqlite3.connect(ledger_path)
+    ledger = sqlite3.connect(ledger_path, timeout=1)
     ledger.text_factory = str
     m = ledger.cursor()
     m.execute('SELECT timestamp, address, recipient, amount, openfield, block_height FROM transactions WHERE signature like ?;', (txid + '%', ))
     result = m.fetchone()
     if result:
         m.execute('SELECT block_height FROM transactions ORDER BY block_height desc LIMIT 1')
         last = m.fetchone()
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_addpeers.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_addpeers.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_hn_last_block_ts.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_hn_last_block_ts.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/cmd_hn_reg_round.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/cmd_hn_reg_round.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/commands.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/commands.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/connectionmanager.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/connectionmanager.py`

 * *Files 10% similar despite different names*

```diff
@@ -6,19 +6,18 @@
 class ConnectionManager(threading.Thread):
     def __init__(self, node, mp):
         threading.Thread.__init__(self, name='ConnectionManagerThread')
         self.node = node
         self.mp = mp
 
     def run(self):
-
         self.connection_manager()
 
     def connection_manager(self):
-        self.node.logger.app_log.warning('Status: Starting connection manager')
+        # self.node.logger.app_log.warning('Status: Starting connection manager')
         until_purge = 0
 
         while not self.node.IS_STOPPING:
             # one loop every 30 sec
             try:
                 # dict_keys = peer_dict.keys()
                 # random.shuffle(peer_dict.items())
@@ -28,26 +27,26 @@
                     until_purge = 60
                 until_purge -= 1
 
                 # peer management
                 if not self.node.is_regnet:
                     # regnet never tries to connect
                     self.node.peers.client_loop(self.node, this_target=worker)
-                self.node.logger.app_log.warning(f'Status: Threads at {threading.active_count()} / {self.node.thread_limit}')
-                self.node.logger.app_log.info(f'Status: Syncing nodes: {self.node.syncing}')
-                self.node.logger.app_log.info(f'Status: Syncing nodes: {len(self.node.syncing)}/3')
+                # self.node.logger.app_log.warning(f'Status: Threads at {threading.active_count()} / {self.node.thread_limit}')
+                # self.node.logger.app_log.info(f'Status: Syncing nodes: {self.node.syncing}')
+                # self.node.logger.app_log.info(f'Status: Syncing nodes: {len(self.node.syncing)}/3')
 
                 # Status display for Peers related info
-                self.node.peers.status_log()
+                # self.node.peers.status_log()
                 self.mp.MEMPOOL.status()
                 # last block
                 if self.node.last_block_ago:
                     self.node.last_block_ago = time.time() - int(self.node.last_block_timestamp)
-                    self.node.logger.app_log.warning(f'Status: Last block {self.node.last_block} was generated '
-                                                     f"{'%.2f' % (self.node.last_block_ago / 60) } minutes ago", )
+                    # self.node.logger.app_log.warning(f'Status: Last block {self.node.last_block} was generated '
+                    #                                  f"{'%.2f' % (self.node.last_block_ago / 60) } minutes ago", )
                 # status Hook
                 uptime = int(time.time() - self.node.startup_time)
                 status = {
                     'protocolversion': self.node.version,
                     'walletversion': self.node.app_version,
                     'testnet': self.node.is_testnet,  # config data
                     'blocks': self.node.last_block,
@@ -61,15 +60,15 @@
                     'last_block_ago': self.node.last_block_ago,
                 }  # extra data
                 if self.node.is_regnet:
                     status['regnet'] = True
                 self.node.plugin_manager.execute_action_hook('status', status)
                 # end status hook
 
-                # logger.app_log.info(threading.enumerate() all threads)
+                # self.node.logger.app_log.warning('Current: {} All: {}'.format(threading.current_thread(), threading.enumerate()))
                 # time.sleep(30)
                 for i in range(30):
                     # faster stop
                     if not self.node.IS_STOPPING:
                         time.sleep(1)
             except Exception as e:
                 self.node.logger.app_log.warning(f'Error in connection manger ({e})')
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/connections.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/connections.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,23 +1,25 @@
 import select, json, platform
+import threading
 
 # Logical timeout
-LTIMEOUT = 45
+LTIMEOUT = 15
 # Fixed header length
 SLEN = 10
 
 _Debug = False
 
 
 def send(sdef, data, slen=SLEN):
     sdef.setblocking(1)
     # Make sure the packet is sent in one call
+    j = json.dumps(data)
     if _Debug:
-        print('        connections.send', sdef.getsockname(), sdef.getpeername(), data)
-    return sdef.sendall(str(len(json.dumps(data))).encode('utf-8').zfill(slen) + json.dumps(data).encode('utf-8'))
+        print(f'  connections.send {sdef.getsockname()} {sdef.getpeername()} <{j[:12]}> in {threading.current_thread().name}')
+    return sdef.sendall(str(len(j)).encode('utf-8').zfill(slen) + j.encode('utf-8'))
 
 
 if 'Linux' in platform.system():
     READ_OR_ERROR = select.POLLIN | select.POLLPRI | select.POLLHUP | select.POLLERR | select.POLLNVAL
 
     #READ_ONLY = select.POLLIN | select.POLLPRI
 
@@ -64,17 +66,19 @@
                 elif (flag & (select.POLLERR | select.POLLHUP | select.POLLNVAL)):
                     raise RuntimeError('Socket Error {}'.format(flag))
                 else:
                     raise RuntimeError('Socket Unexpected Error')
 
             poller.unregister(sdef)
             segments = b''.join(chunks).decode('utf-8')
+            ret = json.loads(segments)
             if _Debug:
-                print('        connections.receive', sdef.getsockname(), sdef.getpeername(), json.loads(segments))
-            return json.loads(segments)
+                print(f'  connections.receive {sdef.getsockname()} {sdef.getpeername()} <{segments[:10]}> in {threading.current_thread().name}')
+            return ret
+
         except Exception as e:
             if _Debug:
                 print('        connections.receive Exception:', sdef.getsockname(), sdef.getpeername(), e)
             """
             exc_type, exc_obj, exc_tb = sys.exc_info()
             fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
             print(exc_type, fname, exc_tb.tb_lineno)
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/dbhandler.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/dbhandler.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,72 +1,98 @@
 """
 Database handler module for Bismuth nodes
 """
 
 import time
+import json
 import sqlite3
 import essentials
+import threading
 from quantizer import quantize_two
 import functools
 from fork import Fork
 import sys
+import traceback
+
+
+_Debug = False
 
 
 def sql_trace_callback(log, id, statement):
-    line = f'SQL[{id}] {statement}'
+    line = f'SQL[{id}] {statement} in {threading.current_thread()}'
     log.warning(line)
 
 
 class DbHandler:
     def __init__(self, index_db, ledger_path, hyper_path, ram, ledger_ram_file, logger, trace_db_calls=False):
-        print('DbHandler', index_db, ledger_path, hyper_path, ram, ledger_ram_file)
         self.ram = ram
         self.ledger_ram_file = ledger_ram_file
         self.hyper_path = hyper_path
         self.logger = logger
         self.trace_db_calls = trace_db_calls
         self.index_db = index_db
         self.ledger_path = ledger_path
 
+        self.dbs = {}
+
+        sqlite3.threadsafety = 3
+
+        # if trace_db_calls:
+        #     sqlite3.enable_callback_tracebacks(True)
+
         self.index = sqlite3.connect(self.index_db, timeout=1)
         if self.trace_db_calls:
             self.index.set_trace_callback(functools.partial(sql_trace_callback, self.logger.app_log, 'INDEX'))
         self.index.text_factory = str
         self.index.execute('PRAGMA case_sensitive_like = 1;')
         self.index_cursor = self.index.cursor()
+        self.dbs[str(self.index)] = self.index_db
 
         self.hdd = sqlite3.connect(self.ledger_path, timeout=1)
         if self.trace_db_calls:
             self.hdd.set_trace_callback(functools.partial(sql_trace_callback, self.logger.app_log, 'HDD'))
         self.hdd.text_factory = str
         self.hdd.execute('PRAGMA case_sensitive_like = 1;')
         self.h = self.hdd.cursor()
+        self.dbs[str(self.hdd)] = self.ledger_path
 
         self.hdd2 = sqlite3.connect(self.hyper_path, timeout=1)
         if self.trace_db_calls:
             self.hdd2.set_trace_callback(functools.partial(sql_trace_callback, self.logger.app_log, 'HDD2'))
         self.hdd2.text_factory = str
         self.hdd2.execute('PRAGMA case_sensitive_like = 1;')
         self.h2 = self.hdd2.cursor()
+        self.dbs[str(self.hdd2)] = self.hyper_path
 
         if self.ram:
             self.conn = sqlite3.connect(self.ledger_ram_file, uri=True, isolation_level=None, timeout=1)
         else:
             self.conn = sqlite3.connect(self.hyper_path, uri=True, timeout=1)
+        self.dbs[str(self.conn)] = 'ram'
 
         if self.trace_db_calls:
             self.conn.set_trace_callback(functools.partial(sql_trace_callback, self.logger.app_log, 'CONN'))
         self.conn.execute('PRAGMA journal_mode = WAL;')
         self.conn.execute('PRAGMA case_sensitive_like = 1;')
         self.conn.text_factory = str
         self.c = self.conn.cursor()
 
         self.SQL_TO_TRANSACTIONS = 'INSERT INTO transactions VALUES (?,?,?,?,?,?,?,?,?,?,?,?)'
         self.SQL_TO_MISC = 'INSERT INTO misc VALUES (?,?)'
 
+        if _Debug:
+            try:
+                cur_connections_src = open('/tmp/db_connections', 'r').read()
+            except:
+                cur_connections_src = '{"l":[]}'
+            cur_connections = json.loads(cur_connections_src)
+            cur_connections['l'].append(threading.current_thread().name)
+            open('/tmp/db_connections', 'w').write(json.dumps(cur_connections))
+            self.logger.app_log.warning(f'DB_HANDLER OPEN in {threading.current_thread().name} and currently have {len(cur_connections["l"])} opened')
+
     def last_block_hash(self):
         self.execute(self.c, 'SELECT block_hash FROM transactions WHERE reward != 0 ORDER BY block_height DESC LIMIT 1;')
         result = self.c.fetchone()[0]
         return result
 
     def pubkeyget(self, address):
         self.execute_param(self.c, 'SELECT public_key FROM transactions WHERE address = ? and reward = 0 LIMIT 1', (address, ))
@@ -113,14 +139,48 @@
                 'ann',
             ))
             result = self.h.fetchone()[0]
         except:
             result = 'No announcement'
         return result
 
+    def txsearch(self, address=None, recipient=None, operation=None, openfield=None, limit=10, offset=0, block_height_from=None):
+        if not address and not recipient and not operation and not openfield:
+            return []
+        queries = []
+        params = []
+        if address:
+            queries.append('address = ?')
+            params.append(address)
+        if recipient:
+            queries.append('recipient = ?')
+            params.append(recipient)
+        if operation:
+            queries.append('operation = ?')
+            params.append(operation)
+        if openfield:
+            queries.append('openfield = ?')
+            params.append(openfield)
+        if block_height_from is not None:
+            queries.append('block_height >= ?')
+            params.append(block_height_from)
+        params.append(offset)
+        params.append(limit)
+        sql = 'SELECT * FROM transactions WHERE '
+        sql += ' AND '.join(queries)
+        sql += ' ORDER BY block_height DESC LIMIT ?, ?;'
+        try:
+            # print('DB:txsearch', sql, params)
+            self.execute_param(self.h, sql, tuple(params))
+            result = self.h.fetchall()
+        except:
+            traceback.print_exc()
+            return []
+        return result
+
     def block_max_ram(self):
         self.execute(self.c, 'SELECT * FROM transactions ORDER BY block_height DESC LIMIT 1')
         return essentials.format_raw_tx(self.c.fetchone())
 
     def aliasget(self, alias_address):
         self.execute_param(self.index_cursor, 'SELECT alias FROM aliases WHERE address = ? ', (alias_address, ))
         result = self.index_cursor.fetchall()
@@ -327,15 +387,15 @@
 
         try:
             if node.is_regnet:
                 node.hdd_block = node.last_block
                 node.hdd_hash = node.last_block_hash
                 self.logger.app_log.warning(f'Chain: Regnet simulated move to HDD')
                 return
-            node.logger.app_log.warning(f'Chain: Moving new data to HDD, {node.hdd_block + 1} to {node.last_block} ')
+            node.logger.app_log.warning(f'Chain: Moving new data to HDD, {node.hdd_block + 1} to {node.last_block} in {threading.current_thread()}')
 
             self.execute_param(
                 self.c,
                 'SELECT * FROM transactions '
                 'WHERE block_height > ? OR block_height < ? '
                 'ORDER BY block_height ASC',
                 (node.hdd_block, -node.hdd_block),
@@ -360,61 +420,70 @@
             node.logger.app_log.warning(f'Chain: {len(result1)} txs moved to HDD')
         except Exception as e:
             node.logger.app_log.warning(f'Chain: Exception Moving new data to HDD: {e}')
             # app_log.warning("Ledger digestion ended")  # dup with more informative digest_block notice.
 
     def commit(self, connection):
         """Secure commit for slow nodes"""
+        sleep_delay = 0.5
         while True:
             try:
                 connection.commit()
                 break
             except Exception as e:
-                self.logger.app_log.warning(f'Database connection: {connection}')
-                self.logger.app_log.warning(f'Database retry reason: {e}')
-                time.sleep(1)
+                self.logger.app_log.warning(f'Database {self.dbs.get(str(connection), "???")} connection error {e} in {threading.current_thread()}')
+                self.logger.app_log.warning(f'Current threads: {",".join(map(lambda t: t.name, threading.enumerate()))}')
+                time.sleep(sleep_delay)
+                # sleep_delay += 1
 
     def execute(self, cursor, query):
         """Secure execute for slow nodes"""
+        self.logger.app_log.debug(f'Execute {query} in {threading.current_thread()}')
+        sleep_delay = 0.5
         while True:
             try:
                 cursor.execute(query)
                 break
             except sqlite3.InterfaceError as e:
                 self.logger.app_log.warning(f'Database query to abort: {cursor} {query[:100]}')
-                self.logger.app_log.warning(f'Database abortion reason: {e}')
+                self.logger.app_log.warning(f'Database abortion reason: {e} in {threading.current_thread()}')
                 break
             except sqlite3.IntegrityError as e:
                 self.logger.app_log.warning(f'Database query to abort: {cursor} {query[:100]}')
-                self.logger.app_log.warning(f'Database abortion reason: {e}')
+                self.logger.app_log.warning(f'Database abortion reason: {e} in {threading.current_thread()}')
                 break
             except Exception as e:
-                self.logger.app_log.warning(f'Database query: {cursor} {query[:100]}')
-                self.logger.app_log.warning(f'Database retry reason: {e}')
-                time.sleep(1)
+                self.logger.app_log.warning(f'Database query: {cursor.connection} {query[:100]}')
+                self.logger.app_log.warning(f'Database retry reason: {e} in {threading.current_thread()}')
+                self.logger.app_log.warning(f'Current threads: {",".join(map(lambda t: t.name, threading.enumerate()))}')
+                time.sleep(sleep_delay)
+                # sleep_delay += 1
 
     def execute_param(self, cursor, query, param):
         """Secure execute w/ param for slow nodes"""
-
+        self.logger.app_log.debug(f'Execute with param {query} in {threading.current_thread()}')
+        sleep_delay = 0.5
         while True:
             try:
                 cursor.execute(query, param)
                 break
             except sqlite3.InterfaceError as e:
                 self.logger.app_log.warning(f'Database query to abort: {cursor} {str(query)[:100]} {str(param)[:100]}')
-                self.logger.app_log.warning(f'Database abortion reason: {e}')
+                self.logger.app_log.warning(f'Database abortion reason: {e} in {threading.current_thread()}')
                 break
             except sqlite3.IntegrityError as e:
                 self.logger.app_log.warning(f'Database query to abort: {cursor} {str(query)[:100]}')
-                self.logger.app_log.warning(f'Database abortion reason: {e}')
+                self.logger.app_log.warning(f'Database abortion reason: {e} in {threading.current_thread()}')
                 break
             except Exception as e:
-                self.logger.app_log.warning(f'Database query: {cursor} {str(query)[:100]} {str(param)[:100]}')
-                self.logger.app_log.warning(f'Database retry reason: {e}')
-                time.sleep(1)
+                self.logger.app_log.warning(f'Database query: {cursor.connection} {str(query)[:100]} {str(param)[:100]}')
+                self.logger.app_log.warning(f'Database retry reason: {e} in {threading.current_thread()}')
+                self.logger.app_log.warning(f'Current threads: {",".join(map(lambda t: t.name, threading.enumerate()))}')
+                time.sleep(sleep_delay)
+                # sleep_delay += 1
 
     def fetchall(self, cursor, query, param=None):
         """Helper to simplify calling code, execute and fetch in a single line instead of 2"""
         if param is None:
             self.execute(cursor, query)
         else:
             self.execute_param(cursor, query, param)
@@ -428,11 +497,27 @@
             self.execute_param(cursor, query, param)
         res = cursor.fetchone()
         if res:
             return res[0]
         return None
 
     def close(self):
-        self.index.close()
-        self.hdd.close()
-        self.hdd2.close()
-        self.conn.close()
+        try:
+            self.index.close()
+            self.hdd.close()
+            self.hdd2.close()
+            self.conn.close()
+        except:
+            traceback.print_exc()
+
+        if _Debug:
+            try:
+                cur_connections_src = open('/tmp/db_connections', 'r').read()
+            except:
+                cur_connections_src = '{"l":[]}'
+            cur_connections = json.loads(cur_connections_src)
+            if threading.current_thread().name in cur_connections['l']:
+                cur_connections['l'].remove(threading.current_thread().name)
+            else:
+                self.logger.app_log.warning(f'NOT FOUND opened DB connection in {threading.current_thread().name}')
+            open('/tmp/db_connections', 'w').write(json.dumps(cur_connections))
+            self.logger.app_log.warning(f'DB_HANDLER CLOSED in {threading.current_thread().name} and currently have {len(cur_connections["l"])} opened')
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/demo_getaddresssince.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/demo_getaddresssince.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/demo_getstatus.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/demo_getstatus.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/difficulty.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/difficulty.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,17 +1,25 @@
 from decimal import Decimal
 import regnet
 import math
 import time
-from fork import *
-from quantizer import quantize_two, quantize_ten
 from fork import Fork
+from quantizer import quantize_two, quantize_ten
+
+
+_Debug = False
+
+DEFAULT_DIFFICULTY = 10
 
 
 def difficulty(node, db_handler):
+
+    difficulty = [DEFAULT_DIFFICULTY, DEFAULT_DIFFICULTY, 0, 0, 0, 0, 0, 0]
+    return difficulty
+
     try:
         fork = Fork()
 
         db_handler.execute(db_handler.c, 'SELECT * FROM transactions WHERE reward != 0 ORDER BY block_height DESC LIMIT 2')
         result = db_handler.c.fetchone()
 
         timestamp_last = Decimal(result[1])
@@ -38,34 +46,39 @@
         diff_block_previous = Decimal(db_handler.c.fetchone()[0])
 
         time_to_generate = timestamp_last - timestamp_before_last
 
         if node.is_regnet:
             return (float('%.10f' % regnet.REGNET_DIFF), float('%.10f' % (regnet.REGNET_DIFF - 8)), float(time_to_generate), float(regnet.REGNET_DIFF), float(block_time), float(0), float(0), block_height)
 
-        hashrate = pow(2, diff_block_previous/Decimal(2.0))/(block_time*math.ceil(28 - diff_block_previous/Decimal(16.0)))
-        # Calculate new difficulty for desired blocktime of 60 seconds
-        target = Decimal(60.00)
-        ##D0 = diff_block_previous
-        difficulty_new = Decimal((2/math.log(2))*math.log(hashrate*target*math.ceil(28 - diff_block_previous/Decimal(16.0))))
+        try:
+            hashrate = pow(2, diff_block_previous/Decimal(2.0))/(block_time*math.ceil(28 - diff_block_previous/Decimal(16.0)))
+            # Calculate new difficulty for desired blocktime of 60 seconds
+            target = Decimal(60.00)
+            ##D0 = diff_block_previous
+            difficulty_new = Decimal((2/math.log(2))*math.log(hashrate*target*math.ceil(28 - diff_block_previous/Decimal(16.0))))
+        except:
+            hashrate = 1
+            difficulty_new = 10
+
         # Feedback controller
         Kd = 10
         difficulty_new = difficulty_new - Kd*(block_time - block_time_prev)
         diff_adjustment = (difficulty_new - diff_block_previous)/720  # reduce by factor of 720
 
         if diff_adjustment > Decimal(1.0):
             diff_adjustment = Decimal(1.0)
 
         difficulty_new_adjusted = quantize_ten(diff_block_previous + diff_adjustment)
         difficulty = difficulty_new_adjusted
 
         #fork handling
-        if node.is_mainnet:
-            if block_height == fork.POW_FORK - fork.FORK_AHEAD:
-                fork.limit_version(node)
+        # if node.is_mainnet:
+        #     if block_height == fork.POW_FORK - fork.FORK_AHEAD:
+        #         fork.limit_version(node)
         #fork handling
 
         diff_drop_time = Decimal(180)
 
         if Decimal(time.time()) > Decimal(timestamp_last) + Decimal(2*diff_drop_time):
             # Emergency diff drop
             time_difference = quantize_two(time.time()) - quantize_two(timestamp_last)
@@ -79,24 +92,27 @@
 
         if difficulty < 50:
             difficulty = 50
         if diff_dropped < 50:
             diff_dropped = 50
 
         # TODO: Verify!
-        difficulty = 10
-        diff_dropped = 10
+        difficulty = DEFAULT_DIFFICULTY
+        diff_dropped = DEFAULT_DIFFICULTY
 
         return (
             float('%.10f' % difficulty),
             float('%.10f' % diff_dropped),
             float(time_to_generate),
             float(diff_block_previous),
             float(block_time),
             float(hashrate),
             float(diff_adjustment),
             block_height,
         )  # need to keep float here for database inserts support
     except Exception as e:  #new chain or regnet
-        print('Failed to calculate difficulty (default difficulty will be used):', e)
-        difficulty = [10, 10, 0, 0, 0, 0, 0, 0]
+        if _Debug:
+            print('Failed to calculate difficulty (default difficulty will be used):', e)
+        # import traceback
+        # traceback.print_exc()
+        difficulty = [DEFAULT_DIFFICULTY, DEFAULT_DIFFICULTY, 0, 0, 0, 0, 0, 0]
         return difficulty
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/digest.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/digest.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,25 +1,34 @@
-import hashlib
 import os
 import sys
+import time
+import hashlib
+import threading
+
+from decimal import Decimal
 
 import essentials
-import mempool as mp
 import mining_heavy3
-from difficulty import *
+import regnet
+import mempool as mp
+import tokensv2 as tokens
+from difficulty import difficulty
 from essentials import address_is_rsa, checkpoint_set, ledger_balance3
 from polysign.signerfactory import SignerFactory
+from quantizer import quantize_two, quantize_eight
 from fork import Fork
-import tokensv2 as tokens
-from decimal import Decimal
 
 fork = Fork()
 
 
 def digest_block(node, data, sdef, peer_ip, db_handler):
+
+    # if not mining_heavy3.MMAP:
+    #     mining_heavy3.mining_open(node.heavy3_path)
+
     """node param for imports"""
     class Transaction:
         def __init__(self):
             self.start_time_tx = 0
             self.q_received_timestamp = 0
             self.received_timestamp = '0.00'
             self.received_address = None
@@ -57,15 +66,15 @@
             if node.last_block > fork.POW_FORK_TESTNET:
                 if not fork.check_postfork_reward_testnet(db_handler):
                     db_handler.rollback_under(fork.POW_FORK_TESTNET - 1)
                     raise ValueError('Rolling back chain due to old fork data')
         else:
             if node.last_block > fork.POW_FORK:
                 if not fork.check_postfork_reward(db_handler):
-                    print('Rolling back')
+                    # print('Rolling back')
                     db_handler.rollback_under(fork.POW_FORK - 1)
                     raise ValueError('Rolling back chain due to old fork data')
         # fork handling
 
     def transaction_validate():
         """Validates all transaction elements. Raise a ValueError exception on error."""
 
@@ -209,23 +218,25 @@
 
                 # node.logger.app_log.info("Fee: " + str(fee))
 
                 # decide reward
                 if tx_index == block_instance.tx_count - 1:
                     db_amount = 0  # prevent spending from another address, because mining txs allow delegation
 
-                    if node.is_testnet and node.last_block >= fork.POW_FORK_TESTNET:
-                        block_instance.mining_reward = 15 - (block_instance.block_height_new - fork.POW_FORK_TESTNET)/1100000 - 9.5
-                    elif node.is_mainnet and node.last_block >= fork.POW_FORK:
-                        block_instance.mining_reward = 15 - (block_instance.block_height_new - fork.POW_FORK)/1100000 - 9.5
-                    else:
-                        block_instance.mining_reward = 15 - (quantize_eight(block_instance.block_height_new)/quantize_eight(1000000/2)) - Decimal('2.4')
-
-                    if block_instance.mining_reward < 0.5:
-                        block_instance.mining_reward = 0.5
+                    # if node.is_testnet and node.last_block >= fork.POW_FORK_TESTNET:
+                    #     block_instance.mining_reward = 15 - (block_instance.block_height_new - fork.POW_FORK_TESTNET)/1100000 - 9.5
+                    # elif node.is_mainnet and node.last_block >= fork.POW_FORK:
+                    #     block_instance.mining_reward = 15 - (block_instance.block_height_new - fork.POW_FORK)/1100000 - 9.5
+                    # else:
+                    #     block_instance.mining_reward = 15 - (quantize_eight(block_instance.block_height_new)/quantize_eight(1000000/2)) - Decimal('2.4')
+                    # if block_instance.mining_reward < 0.5:
+                    #    block_instance.mining_reward = 0.5
+                    block_instance.mining_reward = node.REGULAR_MINER_REWARD
+                    if miner_tx.miner_address in node.FOUNDATION_MINERS and block_instance.tx_count == 1:
+                        block_instance.mining_reward = node.FOUNDATION_MINER_REWARD
 
                     reward = '{:.8f}'.format(Decimal(block_instance.mining_reward) + sum(fees_block))
 
                     # don't request a fee for mined block so new accounts can mine
                     fee = 0
                 else:
                     reward = 0
@@ -292,53 +303,65 @@
                 # EGG: Reminder: quick test first, **always**. Heavy tests only thereafter.
 
                 block_instance.tx_count = len(block)
 
                 block_instance.block_height_new = node.last_block + 1
                 block_instance.start_time_block = quantize_two(time.time())
 
-                fork_reward_check()
+                # fork_reward_check()
 
                 # sort_transactions also computes several hidden variables, like miner_tx.q_block_timestamp
                 # So it has to be run before the check
                 # TODO: rework to avoid hidden variables and make the sequence clear.
                 # sort_transactions also validates all transactions and sigs, and this is a waste of time if the block timestamp is wrong.
                 sort_transactions(block)
                 # reject blocks older than latest block
                 if miner_tx.q_block_timestamp <= node.last_block_timestamp:
                     # print("miner_tx2", miner_tx)
                     raise ValueError(f'!Block is older {miner_tx.q_block_timestamp} '
                                      f'than the previous one {node.last_block_timestamp} , will be rejected', )
 
+                if len(block) == 1:
+                    if miner_tx.miner_address not in node.FOUNDATION_MINERS:
+                        transaction = block[0]
+                        received_operation = str(transaction[6])[:30]
+                        received_amount = float(transaction[3])
+                        if received_operation.startswith('identity') and received_amount == 0:
+                            pass
+                        else:
+                            # only allow foundation miners to mine empty blocks
+                            raise ValueError('Only foundation miners are allowed to mine empty blocks')
+
                 check_signature(block)
 
                 # calculate current difficulty (is done for each block in block array, not super easy to isolate)
                 diff = difficulty(node, db_handler)
                 node.difficulty = diff
 
-                node.logger.app_log.warning(f"Time to generate block {node.last_block + 1}: {'%.2f' % diff[2]}")
-                node.logger.app_log.warning(f'Current difficulty: {diff[3]}')
-                node.logger.app_log.warning(f'Current blocktime: {diff[4]}')
-                node.logger.app_log.warning(f'Current hashrate: {diff[5]}')
-                node.logger.app_log.warning(f'Difficulty adjustment: {diff[6]}')
-                node.logger.app_log.warning(f'Difficulty: {diff[0]} {diff[1]}')
+                # node.logger.app_log.warning(f"Time to generate block {node.last_block + 1}: {'%.2f' % diff[2]}")
+                # node.logger.app_log.warning(f'Current difficulty: {diff[3]}')
+                # node.logger.app_log.warning(f'Current blocktime: {diff[4]}')
+                # node.logger.app_log.warning(f'Current hashrate: {diff[5]}')
+                # node.logger.app_log.warning(f'Difficulty adjustment: {diff[6]}')
+                # node.logger.app_log.warning(f'Difficulty: {diff[0]} {diff[1]}')
 
                 block_instance.block_hash = hashlib.sha224((str(block_instance.transaction_list_converted) + node.last_block_hash).encode('utf-8')).hexdigest()
                 del block_instance.transaction_list_converted[:]
 
                 # node.logger.app_log.info("Last block sha_hash: {}".format(block_hash))
-                node.logger.app_log.info(f'Calculated block sha_hash: {block_instance.block_hash}')
+                # node.logger.app_log.info(f'Calculated block sha_hash: {block_instance.block_hash}')
                 # node.logger.app_log.info("Nonce: {}".format(nonce))
 
                 # check if we already have the sha_hash
                 db_handler.execute_param(db_handler.h, 'SELECT block_height FROM transactions WHERE block_hash = ?', (block_instance.block_hash, ))
                 dummy = db_handler.h.fetchone()
                 if dummy:
                     raise ValueError('Skipping digestion of block {} from {}, because we already have it on block_height {}'.format(block_instance.block_hash[:10], peer_ip, dummy[0]))
 
+                mining_heavy3.mining_open(node.heavy3_path)
                 if node.is_mainnet:
                     diff_save = mining_heavy3.check_block(
                         block_instance.block_height_new,
                         miner_tx.miner_address,
                         miner_tx.nonce,
                         node.last_block_hash,
                         diff[0],
@@ -456,29 +479,30 @@
             # Left for edge cases debug
             print(e)
             exc_type, exc_obj, exc_tb = sys.exc_info()
             fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
             print(exc_type, fname, exc_tb.tb_lineno)
             raise
 
+    #--- digest start
     # TODO: no def in def, unreadable. we are 10 screens down the prototype of that function.
     # digestion begins here
     if node.peers.is_banned(peer_ip):
         # no need to loose any time with banned peers
         raise ValueError('Cannot accept blocks from a banned peer')
         # since we raise, it will also drop the connection, it's fine since he's banned.
 
     tx = Transaction()
     miner_tx = MinerTransaction()
     block_instance = Block()
 
     if not node.db_lock.locked():
 
         node.db_lock.acquire()
-        node.logger.app_log.warning(f'Database lock acquired')
+        node.logger.app_log.warning(f'Database lock acquired in {threading.current_thread().name}')
 
         while mp.MEMPOOL.lock.locked():
             time.sleep(0.1)
             node.logger.app_log.info(f'Chain: Waiting for mempool to unlock {peer_ip}')
 
         node.logger.app_log.warning(f'Chain: Digesting started from {peer_ip}')
         # variables that have been quantized are prefixed by q_ So we can avoid any unnecessary quantize again later.
@@ -515,17 +539,18 @@
             raise ValueError('Chain: digestion aborted')
 
         finally:
 
             db_handler.db_to_drive(node)
 
             node.db_lock.release()
-            node.logger.app_log.warning(f'Database lock released')
+            node.logger.app_log.warning(f'Database lock released in {threading.current_thread().name}')
 
             delta_t = time.time() - float(block_instance.start_time_block)
             # node.logger.app_log.warning("Block: {}: {} digestion completed in {}s."
             # .format(block_instance.block_height_new,  block_hash[:10], delta_t))
             node.plugin_manager.execute_action_hook('digestblock', {'failed': block_instance.failed_cause, 'ip': peer_ip, 'deltat': delta_t, 'blocks': block_instance.block_count, 'txs': block_instance.tx_count})
 
     else:
         node.logger.app_log.warning(f'Chain: Skipping processing from {peer_ip}, someone delivered data faster')
         node.plugin_manager.execute_action_hook('digestblock', {'failed': 'skipped', 'ip': peer_ip})
+    #--- digest end
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/essentials.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/essentials.py`

 * *Files 2% similar despite different names*

```diff
@@ -26,14 +26,18 @@
 0.0.7 : decrease checkpoint limit to 30 blocks at 1450000 (meaning max 59 blocks rollback)
 """
 """
 For temp. code compatibility, dup code moved to polysign module
 """
 
 
+DUST_FEE = 0.00001
+OPENFIELD_SIZE = 100000
+
+
 def address_validate(address: str) -> bool:
     return SignerFactory.address_is_valid(address)
 
 
 def address_is_rsa(address: str) -> bool:
     return SignerFactory.address_is_rsa(address)
 
@@ -86,20 +90,20 @@
         total_size = int(r.headers.get('content-length'))/1024
 
         with open(filename, 'wb') as fp:
             chunkno = 0
             for chunk in r.iter_content(chunk_size=1024):
                 if chunk:
                     chunkno = chunkno + 1
-                    if chunkno % 10000 == 0:  # every x chunks
-                        print(f'Downloaded {int(100 * (chunkno / total_size))} %')
+                    # if chunkno % 10000 == 0:  # every x chunks
+                    #     print(f'Downloaded {int(100 * (chunkno / total_size))} %')
 
                     fp.write(chunk)
                     fp.flush()
-            print('Downloaded 100 %')
+            # print('Downloaded 100 %')
     except:
         raise
 
 
 def most_common(lst: list):
     """Used by consensus"""
     # TODO: factorize the two helpers in one. and use a less cpu hungry method (counter)
@@ -169,22 +173,22 @@
                   str(signature_enc.decode('utf-8')), str(public_key_b64encoded.decode('utf-8')), \
                   str(operation), str(openfield)
         return full_tx
     except:
         return False
 
 
-def keys_check(app_log, keyfile_name: str) -> None:
+def keys_check(app_log, keyfile_name: str, data_dir='.') -> None:
     # TODO: move, make use of polysign module
     # key maintenance
-    if os.path.isfile('privkey.der') is True:
+    if os.path.isfile(os.path.join(data_dir, 'privkey.der')) is True:
         app_log.warning('privkey.der found')
-    elif os.path.isfile('privkey_encrypted.der') is True:
+    elif os.path.isfile(os.path.join(data_dir, 'privkey_encrypted.der')) is True:
         app_log.warning('privkey_encrypted.der found')
-        os.rename('privkey_encrypted.der', 'privkey.der')
+        os.rename(os.path.join(data_dir, 'privkey_encrypted.der'), os.path.join(data_dir, 'privkey.der'))
 
     elif os.path.isfile(keyfile_name) is True:
         app_log.warning('{} found'.format(keyfile_name))
     else:
         # generate key pair and an address
         key = RSA.generate(4096)
         # public_key = key.publickey()
@@ -209,19 +213,19 @@
     wallet_dict['Address'] = address
     if not isinstance(file, str):
         file = file.name
     with open(file, 'w') as keyfile:
         json.dump(wallet_dict, keyfile)
 
 
-def keys_load(privkey_filename: str = 'privkey.der', pubkey_filename: str = 'pubkey.der'):
+def keys_load(privkey_filename: str = 'privkey.der', pubkey_filename: str = 'pubkey.der', wallet_filename: str ='wallet.der'):
     keyfile = 'wallet.der'
-    if os.path.exists('wallet.der'):
-        print('Using modern wallet method')
-        return keys_load_new('wallet.der')
+    if wallet_filename and os.path.exists(wallet_filename):
+        # print('Using modern wallet method')
+        return keys_load_new(wallet_filename)
 
     else:
         # print("loaded",privkey, pubkey)
         # import keys
         try:  # unencrypted
             with open(privkey_filename) as fp:
                 key = RSA.importKey(fp.read())
@@ -242,18 +246,18 @@
 
         if len(public_key_readable) not in (271, 799):
             raise ValueError('Invalid public key length: {}'.format(len(public_key_readable)))
 
         public_key_b64encoded = base64.b64encode(public_key_readable.encode('utf-8'))
         address = hashlib.sha224(public_key_readable.encode('utf-8')).hexdigest()
 
-        print('Upgrading wallet')
-        keys_save(private_key_readable, public_key_readable, address, keyfile)
+        # print('Upgrading wallet')
+        keys_save(private_key_readable, public_key_readable, address, wallet_filename or keyfile)
 
-        return key, public_key_readable, private_key_readable, encrypted, unlocked, public_key_b64encoded, address, keyfile
+        return key, public_key_readable, private_key_readable, encrypted, unlocked, public_key_b64encoded, address, wallet_filename or keyfile
 
 
 def keys_unlock(private_key_encrypted: str) -> tuple:
     password = getpass.getpass()
     encrypted_privkey = private_key_encrypted
     decrypted_privkey = decrypt(password, base64.b64decode(encrypted_privkey))
     key = RSA.importKey(decrypted_privkey)  # be able to sign
@@ -288,15 +292,15 @@
     public_key_b64encoded = base64.b64encode(public_key_readable.encode('utf-8'))
 
     return key, public_key_readable, private_key_readable, encrypted, unlocked, public_key_b64encoded, address, keyfile
 
 
 def fee_calculate(openfield: str, operation: str = '', block: int = 0) -> Decimal:
     # block var will be removed after HF
-    fee = Decimal('0.01') + (Decimal(len(openfield))/Decimal('100000'))  # 0.01 dust
+    fee = Decimal('{}'.format(DUST_FEE)) + (Decimal(len(openfield))/Decimal('{}'.format(OPENFIELD_SIZE)))  # dust + openfield cost
     if operation == 'token:issue':
         fee = Decimal(fee) + Decimal('10')
     if openfield.startswith('alias='):
         fee = Decimal(fee) + Decimal('1')
     #if operation == "alias:register": #add in the future, careful about forking
     #    fee = Decimal(fee) + Decimal("1")
     return quantize_eight(fee)
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/fork.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/fork.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,19 +1,19 @@
+
 class Fork():
     def __init__(self):
         self.POW_FORK = 1450000
         self.POW_FORK_TESTNET = 894170
         self.FORK_AHEAD = 5
         self.versions_remove = ['mainnet0020', 'mainnet0019', 'mainnet0018', 'mainnet0017']
         self.FORK_REWARD = None
         self.FORK_REWARD_TESTNET = None
         self.PASSED = False
         self.PASSED_TESTNET = False
         self.REWARD_MAX = 6
-
         #self.POW_FORK = 1168860 #HACK
         #self.versions_remove = [] #HACK
         #self.REWARD_MAX = 5 #HACK
 
     def limit_version(self, node):
         for allowed_version in node.version_allow:
             if allowed_version in self.versions_remove:
@@ -41,12 +41,12 @@
             db_handler.execute_param(db_handler.c, 'SELECT reward FROM transactions WHERE block_height = ? AND reward != 0', (self.POW_FORK_TESTNET + 1, ))
             self.FORK_REWARD_TESTNET = db_handler.c.fetchone()[0]
         except:
             #hdd in case we have not saved yet
             db_handler.execute_param(db_handler.h, 'SELECT reward FROM transactions WHERE block_height = ? AND reward != 0', (self.POW_FORK_TESTNET + 1, ))
             self.FORK_REWARD_TESTNET = db_handler.h.fetchone()[0]
 
-        print(type(self.FORK_REWARD_TESTNET))
+        # print(type(self.FORK_REWARD_TESTNET))
 
         if self.FORK_REWARD_TESTNET < self.REWARD_MAX:
             self.PASSED_TESTNET = True
         return self.PASSED_TESTNET
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/genesis.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/genesis.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/hmac_drbg.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/hmac_drbg.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/hyperlane.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/hyperlane.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/hyperlane_asyncio.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/hyperlane_asyncio.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/ledger_explorer.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/ledger_explorer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/log.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/log.py`

 * *Files 0% similar despite different names*

```diff
@@ -35,15 +35,15 @@
     app_log.setLevel(level)
     app_log.addHandler(my_handler)
 
     # This part is what goes on console.
     ch = logging.StreamHandler(sys.stdout)
     ch.setLevel(level)
     # TODO: We could have 2 level in the config, one for screen and one for files.
-    print('Logging level: {} ({})'.format(level_input, level))
+    # print('Logging level: {} ({})'.format(level_input, level))
     if terminal_output != True:
         ch.addFilter(filter_status)
         # No need for complete func and line info here.
         formatter = logging.Formatter('%(asctime)s %(message)s')
     else:
         formatter = logging.Formatter('%(asctime)s %(funcName)s(%(lineno)d) %(message)s')
     ch.setFormatter(formatter)
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/mempool.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/mempool.py`

 * *Files 1% similar despite different names*

```diff
@@ -149,15 +149,15 @@
         return self.fetchall(SQL_MEMPOOL_GET, (balance_address, ))
 
     def check(self):
         """
         Checks if mempool exists, create if not.
         :return:
         """
-        self.app_log.warning('Mempool Check')
+        self.app_log.debug('Mempool Check')
         with self.lock:
             if self.ram:
                 self.db = sqlite3.connect(self.mempool_ram_file, uri=True, timeout=1, isolation_level=None, check_same_thread=False)
                 if self.trace_db_calls:
                     self.db.set_trace_callback(functools.partial(sql_trace_callback, self.app_log, 'MEMPOOL-RAM'))
                 self.db.execute('PRAGMA journal_mode = WAL;')
                 self.db.execute('PRAGMA page_size = 4096;')
@@ -321,24 +321,24 @@
         """
         Stats on the current mempool
         :return: tuple(tx#, openfield len, distinct sender#, distinct recipients#
         """
         try:
             limit = time.time()
             frozen = [peer for peer in self.peers_sent if self.peers_sent[peer] > limit]
-            self.app_log.warning('Status: MEMPOOL Frozen = {}'.format(', '.join(frozen)))
+            # self.app_log.warning('Status: MEMPOOL Frozen = {}'.format(', '.join(frozen)))
             # print(limit, self.peers_sent, frozen)
             # Cleanup old nodes not synced since 15 min
             limit = limit - 15*60
             with self.peers_lock:
                 self.peers_sent = {peer: self.peers_sent[peer] for peer in self.peers_sent if self.peers_sent[peer] > limit}
-            self.app_log.warning('Status: MEMPOOL Live = {}'.format(', '.join(set(self.peers_sent.keys()) - set(frozen))))
+            # self.app_log.warning('Status: MEMPOOL Live = {}'.format(', '.join(set(self.peers_sent.keys()) - set(frozen))))
             status = self.fetchall(SQL_STATUS)
             count, open_len, senders, recipients = status[0]
-            self.app_log.warning('Status: MEMPOOL {} Txs from {} senders to {} distinct recipients. Openfield len {}'.format(count, senders, recipients, open_len))
+            self.app_log.debug('Status: MEMPOOL {} Txs from {} senders to {} distinct recipients. Openfield len {}'.format(count, senders, recipients, open_len))
             return status[0]
         except:
             return 0
 
     def size(self):
         """
         Curent size of the mempool in Mo
@@ -390,15 +390,15 @@
         :return:
         """
         if DEBUG_DO_NOT_SEND_TX:
             all = self.fetchall(SQL_SELECT_TX_TO_SEND)
             tx_count = len(all)
             tx_list = [tx[1] + ' ' + tx[2] + ' : ' + str(tx[3]) for tx in all]
             # print("I have {} txs for {} but won't send: {}".format(tx_count, peer_ip, "\n".join(tx_list)))
-            print("I have {} txs for {} but won't send".format(tx_count, peer_ip))
+            # print("I have {} txs for {} but won't send".format(tx_count, peer_ip))
             return []
         # Get our raw txs
         if peer_ip not in self.peers_sent:
             # new peer, never seen, send all
             raw = self.fetchall(SQL_SELECT_TX_TO_SEND)
         else:
             # add some margin to account for tx in the future, 5 sec ?
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/mining.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/mining.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/mining_heavy3.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/mining_heavy3.py`

 * *Files 17% similar despite different names*

```diff
@@ -6,28 +6,29 @@
 From bismuth node
 """
 
 import mmap
 import os
 import struct
 import sys
+import threading
 from hashlib import sha224
+
 from hmac_drbg import DRBG
 from quantizer import quantize_ten
 from decimal import Decimal
-
 import regnet
 
 from fork import Fork
 
 fork = Fork()
 
 __version__ = '0.1.4'
 
-print('Mining_Heavy3 v{}'.format(__version__))
+# print('Mining_Heavy3 v{}'.format(__version__))
 
 RND_LEN = 0
 
 MMAP = None
 F = None
 
 is_regnet = False
@@ -41,14 +42,15 @@
 def anneal3(mmap, n):
     """
     Converts 224 bits number into annealed version, hexstring
 
     :param n: a 224 = 7x32 bits
     :return:  56 char in hex encoding.
     """
+    # print('anneal3', threading.current_thread(), mmap, RND_LEN, id(RND_LEN))
     h7 = n & 0xffffffff
     n = n >> 32
     index = ((h7 & ~0x7) % RND_LEN)*4
     # f1 = struct.unpack('I', mmap[index:index + 4])[0]
     value = h7 ^ struct.unpack('I', mmap[index:index + 4])[0]
     res = '{:08x}'.format(value)
     for i in range(6):
@@ -145,26 +147,28 @@
             else:
                 raise ValueError('Readjusted difficulty too low for block {} from {}, {} should be at least {}'.format(block_height_new, peer_ip, real_diff, diff_dropped))
         else:
             raise ValueError('Difficulty {} too low for block {} from {}, should be at least {}'.format(real_diff, block_height_new, peer_ip, diff0))
         return diff_save
     except Exception as e:
         # Left for edge cases debug
-        print('MH3 check block', e)
+        # print('MH3 check block', e)
+        # import traceback
+        # traceback.print_exc()
         exc_type, exc_obj, exc_tb = sys.exc_info()
         fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
-        print(exc_type, fname, exc_tb.tb_lineno)
+        # print(exc_type, fname, exc_tb.tb_lineno)
         raise
 
 
 def create_heavy3a(file_name='heavy3a.bin'):
     if (not heavy) and is_regnet:
-        print('Regnet, no heavy file')
+        # print('Regnet, no heavy file')
         return
-    print('Creating Junction Noise file, this usually takes a few minutes...')
+    # print('Creating Junction Noise file, this usually takes a few minutes...')
     gen = DRBG(b'Bismuth is a chemical element with symbol Bi and atomic number 83. It is a pentavalent post-transition metal and one of the pnictogens with chemical properties resembling its lighter homologs arsenic and antimony.')
     # Size in Gb - No more than 4Gb from a single seed
     GB = 1
     # Do not change chunk size, it would change the file content.
     CHUNK_SIZE = 1024*4  # time 3m20.990s
     COUNT = GB*1024*1024*1024 // CHUNK_SIZE
     with open(file_name, 'wb') as f:
@@ -173,58 +177,67 @@
 
 
 def mining_open(file_name='heavy3a.bin'):
     """
     Opens the Junction MMapped file
     """
     if (not heavy) and is_regnet:
-        print('Regnet, no heavy file to open')
+        # print('Regnet, no heavy file to open')
         return
     global F
     global MMAP
     global RND_LEN
+    if MMAP:
+        print(f'Junction memory-map file already loaded in {threading.current_thread().name}')
+        return
+    print(f'Loading Junction memory-map file from {file_name} in {threading.current_thread().name}')
     if os.path.isfile(file_name):
         size = os.path.getsize(file_name)
         if size != 1073741824:
-            print('Invalid size of heavy file {}.'.format(file_name))
+            # print('Invalid size of heavy file {}.'.format(file_name))
             try:
                 os.remove(file_name)
-                print('Deleted, Will be re-created')
+                # print('Deleted, Will be re-created')
             except Exception as e:
-                print(e)
-                sys.exit()
+                # print('mining_open', e)
+                # sys.exit()
+                raise e
     if not os.path.isfile(file_name):
         create_heavy3a(file_name)
     try:
         F = open(file_name, 'rb+')
         # memory-map the file, size 0 means whole file
         MMAP = mmap.mmap(F.fileno(), 0)
         RND_LEN = os.path.getsize(file_name) // 4
         if read_int_from_map(MMAP, 0) != 3786993664:
             raise ValueError('Wrong file: {}'.format(file_name))
         if read_int_from_map(MMAP, 1024) != 1742706086:
             raise ValueError('Wrong file: {}'.format(file_name))
     except Exception as e:
-        print('Error while loading Junction file: {}'.format(e))
-        sys.exit()
+        # print('error while loading Junction file: {}'.format(e))
+        # sys.exit()
+        raise e
+    # print('mining_open', file_name, threading.current_thread())
 
 
 def mining_close():
     """
     Close the MMAP access, HAS to be called at end of program.
     """
     if (not heavy) and is_regnet:
-        print('Regnet, no heavy file to close')
+        # print('Regnet, no heavy file to close')
         return
     global F
     global MMAP
     try:
         assert MMAP
         MMAP.close()
     except:
         pass
+    MMAP = None
 
     try:
         assert F
         F.close()
     except:
         pass
+    F = None
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/node.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/node.py`

 * *Files 15% similar despite different names*

```diff
@@ -45,7213 +45,8056 @@
 000002c0: 2f57 414c 2068 6464 206c 6576 656c 732c  /WAL hdd levels,
 000002d0: 2069 7420 6d61 6b65 7320 7361 7669 6e67   it makes saving
 000002e0: 2073 6c6f 770a 2320 6973 7375 6573 2077   slow.# issues w
 000002f0: 6974 6820 6462 3f20 7065 7268 6170 7320  ith db? perhaps 
 00000300: 796f 7520 6d69 7373 6564 2061 2063 6f6d  you missed a com
 00000310: 6d69 7428 2920 6f72 2074 776f 0a0a 5645  mit() or two..VE
 00000320: 5253 494f 4e20 3d20 2734 2e34 2e30 2e31  RSION = '4.4.0.1
-00000330: 3327 0a0a 696d 706f 7274 2066 756e 6374  3'..import funct
-00000340: 6f6f 6c73 0a69 6d70 6f72 7420 676c 6f62  ools.import glob
-00000350: 0a69 6d70 6f72 7420 706c 6174 666f 726d  .import platform
-00000360: 0a69 6d70 6f72 7420 7368 7574 696c 0a69  .import shutil.i
-00000370: 6d70 6f72 7420 736f 636b 6574 7365 7276  mport socketserv
-00000380: 6572 0a69 6d70 6f72 7420 7371 6c69 7465  er.import sqlite
-00000390: 330a 696d 706f 7274 2074 6172 6669 6c65  3.import tarfile
-000003a0: 0a69 6d70 6f72 7420 7468 7265 6164 696e  .import threadin
-000003b0: 670a 6672 6f6d 2073 7973 2069 6d70 6f72  g.from sys impor
-000003c0: 7420 7665 7273 696f 6e5f 696e 666f 0a0a  t version_info..
-000003d0: 696d 706f 7274 2061 6c69 6173 6573 2020  import aliases  
-000003e0: 2320 5052 4546 4f52 4b5f 414c 4941 5345  # PREFORK_ALIASE
-000003f0: 530a 2320 696d 706f 7274 2061 6c69 6173  S.# import alias
-00000400: 6573 7632 2061 7320 616c 6961 7365 7320  esv2 as aliases 
-00000410: 2320 504f 5354 464f 524b 5f41 4c49 4153  # POSTFORK_ALIAS
-00000420: 4553 0a0a 2320 4269 7320 7370 6563 6966  ES..# Bis specif
-00000430: 6963 206d 6f64 756c 6573 0a69 6d70 6f72  ic modules.impor
-00000440: 7420 6170 6968 616e 646c 6572 0a69 6d70  t apihandler.imp
-00000450: 6f72 7420 636f 6e6e 6563 7469 6f6e 6d61  ort connectionma
-00000460: 6e61 6765 720a 696d 706f 7274 2064 6268  nager.import dbh
-00000470: 616e 646c 6572 0a69 6d70 6f72 7420 6c6f  andler.import lo
-00000480: 670a 696d 706f 7274 206f 7074 696f 6e73  g.import options
-00000490: 0a69 6d70 6f72 7420 7065 6572 7368 616e  .import peershan
-000004a0: 646c 6572 0a69 6d70 6f72 7420 706c 7567  dler.import plug
-000004b0: 696e 730a 2320 696d 706f 7274 2074 6f6b  ins.# import tok
-000004c0: 656e 7376 3220 6173 2074 6f6b 656e 7320  ensv2 as tokens 
-000004d0: 2023 2054 4f44 4f3a 2075 6e75 7365 6420   # TODO: unused 
-000004e0: 6865 7265 0a69 6d70 6f72 7420 7761 6c6c  here.import wall
-000004f0: 6574 5f6b 6579 730a 6672 6f6d 2063 6f6e  et_keys.from con
-00000500: 6e65 6374 696f 6e73 2069 6d70 6f72 7420  nections import 
-00000510: 7365 6e64 2c20 7265 6365 6976 650a 6672  send, receive.fr
-00000520: 6f6d 2064 6967 6573 7420 696d 706f 7274  om digest import
-00000530: 202a 0a66 726f 6d20 6573 7365 6e74 6961   *.from essentia
-00000540: 6c73 2069 6d70 6f72 7420 6665 655f 6361  ls import fee_ca
-00000550: 6c63 756c 6174 652c 2064 6f77 6e6c 6f61  lculate, downloa
-00000560: 645f 6669 6c65 0a66 726f 6d20 6c69 6273  d_file.from libs
-00000570: 2069 6d70 6f72 7420 6e6f 6465 2061 7320   import node as 
-00000580: 5f6e 6f64 652c 206c 6f67 6765 722c 206b  _node, logger, k
-00000590: 6579 732c 2063 6c69 656e 740a 6672 6f6d  eys, client.from
-000005a0: 2066 6f72 6b20 696d 706f 7274 2046 6f72   fork import For
-000005b0: 6b0a 0a23 2074 6f64 6f3a 206d 6967 7261  k..# todo: migra
-000005c0: 7465 2074 6869 7320 746f 2070 6f6c 7973  te this to polys
-000005d0: 6967 6e5c 7369 676e 6572 5f63 7277 2e70  ign\signer_crw.p
-000005e0: 790a 6672 6f6d 2043 7279 7074 6f64 6f6d  y.from Cryptodom
-000005f0: 652e 4861 7368 2069 6d70 6f72 7420 5348  e.Hash import SH
-00000600: 410a 6672 6f6d 2043 7279 7074 6f64 6f6d  A.from Cryptodom
-00000610: 652e 5075 626c 6963 4b65 7920 696d 706f  e.PublicKey impo
-00000620: 7274 2052 5341 0a66 726f 6d20 4372 7970  rt RSA.from Cryp
-00000630: 746f 646f 6d65 2e53 6967 6e61 7475 7265  todome.Signature
-00000640: 2069 6d70 6f72 7420 504b 4353 315f 7631   import PKCS1_v1
-00000650: 5f35 0a69 6d70 6f72 7420 6261 7365 3634  _5.import base64
-00000660: 0a23 202f 746f 646f 0a0a 666f 726b 203d  .# /todo..fork =
-00000670: 2046 6f72 6b28 290a 0a61 7070 6e61 6d65   Fork()..appname
-00000680: 203d 2027 4269 736d 7574 6827 0a61 7070   = 'Bismuth'.app
-00000690: 6175 7468 6f72 203d 2027 4269 736d 7574  author = 'Bismut
-000006a0: 6820 466f 756e 6461 7469 6f6e 270a 0a23  h Foundation'..#
-000006b0: 206e 6f64 6573 5f62 616e 5f72 6573 6574   nodes_ban_reset
-000006c0: 3d63 6f6e 6669 672e 6e6f 6465 735f 6261  =config.nodes_ba
-000006d0: 6e5f 7265 7365 740a 0a0a 6465 6620 7371  n_reset...def sq
-000006e0: 6c5f 7472 6163 655f 6361 6c6c 6261 636b  l_trace_callback
-000006f0: 286c 6f67 2c20 6964 2c20 7374 6174 656d  (log, id, statem
-00000700: 656e 7429 3a0a 2020 2020 6c69 6e65 203d  ent):.    line =
-00000710: 2066 2753 514c 5b7b 6964 7d5d 207b 7374   f'SQL[{id}] {st
-00000720: 6174 656d 656e 747d 270a 2020 2020 6c6f  atement}'.    lo
-00000730: 672e 7761 726e 696e 6728 6c69 6e65 290a  g.warning(line).
-00000740: 0a0a 6465 6620 626f 6f74 7374 7261 7028  ..def bootstrap(
-00000750: 293a 0a20 2020 2023 2054 4f44 4f3a 2043  ):.    # TODO: C
-00000760: 616e 6469 6461 7465 2066 6f72 2073 696e  andidate for sin
-00000770: 676c 6520 7573 6572 206d 6f64 650a 2020  gle user mode.  
-00000780: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
-00000790: 7970 6573 203d 205b 2773 7461 7469 632f  ypes = ['static/
-000007a0: 2a2e 6462 2d77 616c 272c 2027 7374 6174  *.db-wal', 'stat
-000007b0: 6963 2f2a 2e64 622d 7368 6d27 5d0a 2020  ic/*.db-shm'].  
-000007c0: 2020 2020 2020 666f 7220 7420 696e 2074        for t in t
-000007d0: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
-000007e0: 2020 666f 7220 6620 696e 2067 6c6f 622e    for f in glob.
-000007f0: 676c 6f62 2874 293a 0a20 2020 2020 2020  glob(t):.       
-00000800: 2020 2020 2020 2020 206f 732e 7265 6d6f           os.remo
-00000810: 7665 2866 290a 2020 2020 2020 2020 2020  ve(f).          
-00000820: 2020 2020 2020 7072 696e 7428 662c 2027        print(f, '
-00000830: 6465 6c65 7465 6427 290a 0a20 2020 2020  deleted')..     
-00000840: 2020 2023 2061 7263 6869 7665 5f70 6174     # archive_pat
-00000850: 6820 3d20 6e6f 6465 2e6c 6564 6765 725f  h = node.ledger_
-00000860: 7061 7468 202b 2022 2e74 6172 2e67 7a22  path + ".tar.gz"
-00000870: 0a20 2020 2020 2020 2023 2064 6f77 6e6c  .        # downl
-00000880: 6f61 645f 6669 6c65 2822 6874 7470 733a  oad_file("https:
-00000890: 2f2f 6269 736d 7574 682e 637a 2f6c 6564  //bismuth.cz/led
-000008a0: 6765 722e 7461 722e 677a 222c 2061 7263  ger.tar.gz", arc
-000008b0: 6869 7665 5f70 6174 6829 0a20 2020 2020  hive_path).     
-000008c0: 2020 2023 2077 6974 6820 7461 7266 696c     # with tarfil
-000008d0: 652e 6f70 656e 2861 7263 6869 7665 5f70  e.open(archive_p
-000008e0: 6174 6829 2061 7320 7461 723a 0a20 2020  ath) as tar:.   
-000008f0: 2020 2020 2023 2020 2020 2074 6172 2e65       #     tar.e
-00000900: 7874 7261 6374 616c 6c28 2273 7461 7469  xtractall("stati
-00000910: 632f 2229 2020 2320 4e4f 5420 434f 4d50  c/")  # NOT COMP
-00000920: 4154 4942 4c45 2057 4954 4820 4355 5354  ATIBLE WITH CUST
-00000930: 4f4d 2050 4154 4820 434f 4e46 530a 0a20  OM PATH CONFS.. 
-00000940: 2020 2020 2020 2049 4e49 5449 414c 5f44         INITIAL_D
-00000950: 4946 4649 4355 4c54 5920 3d20 3130 0a20  IFFICULTY = 10. 
-00000960: 2020 2020 2020 2049 4e49 5449 414c 5f48         INITIAL_H
-00000970: 5950 4552 5f44 4946 4649 4355 4c54 5920  YPER_DIFFICULTY 
-00000980: 3d20 3130 0a0a 2020 2020 2020 2020 6864  = 10..        hd
-00000990: 6420 3d20 7371 6c69 7465 332e 636f 6e6e  d = sqlite3.conn
-000009a0: 6563 7428 2773 7461 7469 632f 6c65 6467  ect('static/ledg
-000009b0: 6572 2e64 6227 2c20 7469 6d65 6f75 743d  er.db', timeout=
-000009c0: 3129 0a20 2020 2020 2020 2068 6464 2e74  1).        hdd.t
-000009d0: 6578 745f 6661 6374 6f72 7920 3d20 7374  ext_factory = st
-000009e0: 720a 2020 2020 2020 2020 6864 642e 6578  r.        hdd.ex
-000009f0: 6563 7574 6528 2750 5241 474d 4120 6361  ecute('PRAGMA ca
-00000a00: 7365 5f73 656e 7369 7469 7665 5f6c 696b  se_sensitive_lik
-00000a10: 6520 3d20 313b 2729 0a20 2020 2020 2020  e = 1;').       
-00000a20: 2068 6464 5f63 7572 736f 7220 3d20 6864   hdd_cursor = hd
-00000a30: 642e 6375 7273 6f72 2829 0a20 2020 2020  d.cursor().     
-00000a40: 2020 2068 6464 5f63 7572 736f 722e 6578     hdd_cursor.ex
-00000a50: 6563 7574 6528 2743 5245 4154 4520 5441  ecute('CREATE TA
-00000a60: 424c 4520 4946 204e 4f54 2045 5849 5354  BLE IF NOT EXIST
-00000a70: 5320 226d 6973 6322 2028 2262 6c6f 636b  S "misc" ("block
-00000a80: 5f68 6569 6768 7422 2049 4e54 4547 4552  _height" INTEGER
-00000a90: 2c20 2264 6966 6669 6375 6c74 7922 2054  , "difficulty" T
-00000aa0: 4558 5429 2729 0a20 2020 2020 2020 2068  EXT)').        h
-00000ab0: 6464 5f63 7572 736f 722e 6578 6563 7574  dd_cursor.execut
-00000ac0: 6528 0a20 2020 2020 2020 2020 2020 2027  e(.            '
-00000ad0: 4352 4541 5445 2054 4142 4c45 2049 4620  CREATE TABLE IF 
-00000ae0: 4e4f 5420 4558 4953 5453 2022 7472 616e  NOT EXISTS "tran
-00000af0: 7361 6374 696f 6e73 2220 2822 626c 6f63  sactions" ("bloc
-00000b00: 6b5f 6865 6967 6874 2220 494e 5445 4745  k_height" INTEGE
-00000b10: 522c 2022 7469 6d65 7374 616d 7022 204e  R, "timestamp" N
-00000b20: 554d 4552 4943 2c20 2261 6464 7265 7373  UMERIC, "address
-00000b30: 2220 5445 5854 2c20 2272 6563 6970 6965  " TEXT, "recipie
-00000b40: 6e74 2220 5445 5854 2c20 2261 6d6f 756e  nt" TEXT, "amoun
-00000b50: 7422 204e 554d 4552 4943 2c20 2273 6967  t" NUMERIC, "sig
-00000b60: 6e61 7475 7265 2220 5445 5854 2c20 2270  nature" TEXT, "p
-00000b70: 7562 6c69 635f 6b65 7922 2054 4558 542c  ublic_key" TEXT,
-00000b80: 2022 626c 6f63 6b5f 6861 7368 2220 5445   "block_hash" TE
-00000b90: 5854 2c20 2266 6565 2220 4e55 4d45 5249  XT, "fee" NUMERI
-00000ba0: 432c 2022 7265 7761 7264 2220 4e55 4d45  C, "reward" NUME
-00000bb0: 5249 432c 2022 6f70 6572 6174 696f 6e22  RIC, "operation"
-00000bc0: 2054 4558 542c 2022 6f70 656e 6669 656c   TEXT, "openfiel
-00000bd0: 6422 2054 4558 5429 272c 0a20 2020 2020  d" TEXT)',.     
-00000be0: 2020 2029 0a20 2020 2020 2020 2068 6464     ).        hdd
-00000bf0: 5f63 7572 736f 722e 6578 6563 7574 6528  _cursor.execute(
-00000c00: 2743 5245 4154 4520 494e 4445 5820 2254  'CREATE INDEX "T
-00000c10: 696d 6573 7461 6d70 2049 6e64 6578 2220  imestamp Index" 
-00000c20: 4f4e 2022 7472 616e 7361 6374 696f 6e73  ON "transactions
-00000c30: 2220 2822 7469 6d65 7374 616d 7022 2927  " ("timestamp")'
-00000c40: 290a 2020 2020 2020 2020 6864 645f 6375  ).        hdd_cu
-00000c50: 7273 6f72 2e65 7865 6375 7465 2827 4352  rsor.execute('CR
-00000c60: 4541 5445 2049 4e44 4558 2022 5369 676e  EATE INDEX "Sign
-00000c70: 6174 7572 6520 496e 6465 7822 204f 4e20  ature Index" ON 
-00000c80: 2274 7261 6e73 6163 7469 6f6e 7322 2028  "transactions" (
-00000c90: 2273 6967 6e61 7475 7265 2229 2729 0a20  "signature")'). 
-00000ca0: 2020 2020 2020 2068 6464 5f63 7572 736f         hdd_curso
-00000cb0: 722e 6578 6563 7574 6528 2743 5245 4154  r.execute('CREAT
-00000cc0: 4520 494e 4445 5820 2252 6577 6172 6420  E INDEX "Reward 
-00000cd0: 496e 6465 7822 204f 4e20 2274 7261 6e73  Index" ON "trans
-00000ce0: 6163 7469 6f6e 7322 2028 2272 6577 6172  actions" ("rewar
-00000cf0: 6422 2927 290a 2020 2020 2020 2020 6864  d")').        hd
-00000d00: 645f 6375 7273 6f72 2e65 7865 6375 7465  d_cursor.execute
-00000d10: 2827 4352 4541 5445 2049 4e44 4558 2022  ('CREATE INDEX "
-00000d20: 5265 6369 7069 656e 7420 496e 6465 7822  Recipient Index"
-00000d30: 204f 4e20 2274 7261 6e73 6163 7469 6f6e   ON "transaction
-00000d40: 7322 2028 2272 6563 6970 6965 6e74 2229  s" ("recipient")
-00000d50: 2729 0a20 2020 2020 2020 2068 6464 5f63  ').        hdd_c
-00000d60: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00000d70: 5245 4154 4520 494e 4445 5820 224f 7065  REATE INDEX "Ope
-00000d80: 6e66 6965 6c64 2049 6e64 6578 2220 4f4e  nfield Index" ON
-00000d90: 2022 7472 616e 7361 6374 696f 6e73 2220   "transactions" 
-00000da0: 2822 6f70 656e 6669 656c 6422 2927 290a  ("openfield")').
-00000db0: 2020 2020 2020 2020 6864 645f 6375 7273          hdd_curs
-00000dc0: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
-00000dd0: 5445 2049 4e44 4558 2022 4665 6520 496e  TE INDEX "Fee In
-00000de0: 6465 7822 204f 4e20 2274 7261 6e73 6163  dex" ON "transac
-00000df0: 7469 6f6e 7322 2028 2266 6565 2229 2729  tions" ("fee")')
-00000e00: 0a20 2020 2020 2020 2068 6464 5f63 7572  .        hdd_cur
-00000e10: 736f 722e 6578 6563 7574 6528 2743 5245  sor.execute('CRE
-00000e20: 4154 4520 494e 4445 5820 2242 6c6f 636b  ATE INDEX "Block
-00000e30: 2048 6569 6768 7420 496e 6465 7822 204f   Height Index" O
-00000e40: 4e20 2274 7261 6e73 6163 7469 6f6e 7322  N "transactions"
-00000e50: 2028 2262 6c6f 636b 5f68 6569 6768 7422   ("block_height"
-00000e60: 2927 290a 2020 2020 2020 2020 6864 645f  )').        hdd_
-00000e70: 6375 7273 6f72 2e65 7865 6375 7465 2827  cursor.execute('
-00000e80: 4352 4541 5445 2049 4e44 4558 2022 426c  CREATE INDEX "Bl
-00000e90: 6f63 6b20 4861 7368 2049 6e64 6578 2220  ock Hash Index" 
-00000ea0: 4f4e 2022 7472 616e 7361 6374 696f 6e73  ON "transactions
-00000eb0: 2220 2822 626c 6f63 6b5f 6861 7368 2229  " ("block_hash")
-00000ec0: 2729 0a20 2020 2020 2020 2068 6464 5f63  ').        hdd_c
-00000ed0: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00000ee0: 5245 4154 4520 494e 4445 5820 2241 6d6f  REATE INDEX "Amo
-00000ef0: 756e 7420 496e 6465 7822 204f 4e20 2274  unt Index" ON "t
-00000f00: 7261 6e73 6163 7469 6f6e 7322 2028 2261  ransactions" ("a
-00000f10: 6d6f 756e 7422 2927 290a 2020 2020 2020  mount")').      
-00000f20: 2020 6864 645f 6375 7273 6f72 2e65 7865    hdd_cursor.exe
-00000f30: 6375 7465 2827 4352 4541 5445 2049 4e44  cute('CREATE IND
-00000f40: 4558 2022 4164 6472 6573 7320 496e 6465  EX "Address Inde
-00000f50: 7822 204f 4e20 2274 7261 6e73 6163 7469  x" ON "transacti
-00000f60: 6f6e 7322 2028 2261 6464 7265 7373 2229  ons" ("address")
-00000f70: 2729 0a20 2020 2020 2020 2068 6464 5f63  ').        hdd_c
-00000f80: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00000f90: 5245 4154 4520 494e 4445 5820 224f 7065  REATE INDEX "Ope
-00000fa0: 7261 7469 6f6e 2049 6e64 6578 2220 4f4e  ration Index" ON
-00000fb0: 2022 7472 616e 7361 6374 696f 6e73 2220   "transactions" 
-00000fc0: 2822 6f70 6572 6174 696f 6e22 2927 290a  ("operation")').
-00000fd0: 2020 2020 2020 2020 6864 645f 6375 7273          hdd_curs
-00000fe0: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
-00000ff0: 5445 2049 4e44 4558 2054 5849 4434 5f49  TE INDEX TXID4_I
-00001000: 6e64 6578 204f 4e20 7472 616e 7361 6374  ndex ON transact
-00001010: 696f 6e73 2873 7562 7374 7228 7369 676e  ions(substr(sign
-00001020: 6174 7572 652c 312c 3429 2927 290a 2020  ature,1,4))').  
-00001030: 2020 2020 2020 6864 645f 6375 7273 6f72        hdd_cursor
-00001040: 2e65 7865 6375 7465 2827 4352 4541 5445  .execute('CREATE
-00001050: 2049 4e44 4558 2022 4d69 7363 2042 6c6f   INDEX "Misc Blo
-00001060: 636b 2048 6569 6768 7420 496e 6465 7822  ck Height Index"
-00001070: 206f 6e20 6d69 7363 2862 6c6f 636b 5f68   on misc(block_h
-00001080: 6569 6768 7429 2729 0a20 2020 2020 2020  eight)').       
-00001090: 2068 6464 5f63 7572 736f 722e 6578 6563   hdd_cursor.exec
-000010a0: 7574 6528 2749 4e53 4552 5420 494e 544f  ute('INSERT INTO
-000010b0: 206d 6973 6320 2864 6966 6669 6375 6c74   misc (difficult
-000010c0: 792c 2062 6c6f 636b 5f68 6569 6768 7429  y, block_height)
-000010d0: 2056 414c 5545 5320 287b 7d2c 3129 272e   VALUES ({},1)'.
-000010e0: 666f 726d 6174 2849 4e49 5449 414c 5f44  format(INITIAL_D
-000010f0: 4946 4649 4355 4c54 5929 290a 2020 2020  IFFICULTY)).    
-00001100: 2020 2020 6864 645f 6375 7273 6f72 2e65      hdd_cursor.e
-00001110: 7865 6375 7465 280a 2020 2020 2020 2020  xecute(.        
-00001120: 2020 2020 2749 4e53 4552 5420 494e 544f      'INSERT INTO
-00001130: 2074 7261 6e73 6163 7469 6f6e 7320 5641   transactions VA
-00001140: 4c55 4553 2028 3f2c 3f2c 3f2c 3f2c 3f2c  LUES (?,?,?,?,?,
-00001150: 3f2c 3f2c 3f2c 3f2c 3f2c 3f2c 3f29 272c  ?,?,?,?,?,?,?)',
-00001160: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00001170: 2020 2027 3127 2c0a 2020 2020 2020 2020     '1',.        
-00001180: 2020 2020 2020 2020 2731 3636 3033 3836          '1660386
-00001190: 3136 352e 3935 3432 3527 2c0a 2020 2020  165.95425',.    
-000011a0: 2020 2020 2020 2020 2020 2020 2767 656e              'gen
-000011b0: 6573 6973 272c 0a20 2020 2020 2020 2020  esis',.         
-000011c0: 2020 2020 2020 2027 3362 3963 6139 3961         '3b9ca99a
-000011d0: 3738 3034 3031 3566 3865 6165 6262 3738  7804015f8eaebb78
-000011e0: 6434 6235 3035 3730 6264 3833 3337 6538  d4b50570bd8337e8
-000011f0: 6138 3139 3633 3433 6462 6262 3539 6334  a8196343dbbb59c4
-00001200: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00001210: 2020 2027 3027 2c0a 2020 2020 2020 2020     '0',.        
-00001220: 2020 2020 2020 2020 2751 5763 4866 3467          'QWcHf4g
-00001230: 3949 4f79 2f58 6770 2b6b 616b 6b6e 3953  9IOy/Xgp+kakkn9S
-00001240: 6a6c 2f62 624d 7663 7a38 3963 334c 4870  jl/bbMvcz89c3LHp
-00001250: 365a 2b44 6736 4178 5943 4c4f 3770 6c57  6Z+Dg6AxYCLO7plW
-00001260: 4d4a 304c 6968 4345 4a50 4158 6b76 5239  MJ0LihCEJPAXkvR9
-00001270: 6d66 5659 6e65 7875 7353 367a 4d49 3652  mfVYnexusS6zMI6R
-00001280: 5054 5061 6f6a 6c72 7664 3159 472f 4e4a  PTPaojlrvd1YG/NJ
-00001290: 4551 5063 444d 4854 3358 3268 4679 414b  EQPcDMHT3X2hFyAK
-000012a0: 3562 5442 336f 6c61 5356 6f6f 4966 2f38  5bTB3olaSVooIf/8
-000012b0: 4f66 5233 3254 446f 7553 706d 324f 354c  OfR32TDouSpm2O5L
-000012c0: 6b64 4f57 5549 4549 6738 6571 474b 3864  kdOWUIEIg8eqGK8d
-000012d0: 492b 7036 4576 7651 6731 6745 436e 4e6f  I+p6EvvQg1gECnNo
-000012e0: 4a4c 7964 4766 3675 3846 574c 4c65 2f55  JLydGf6u8FWLLe/U
-000012f0: 6972 3662 3358 3648 664f 6f59 5370 3265  ir6b3X6HfOoYSp2e
-00001300: 5642 546b 6e38 6a6a 4854 677a 2f7a 5349  VBTkn8jjHTgz/zSI
-00001310: 424e 7338 6c61 504e 4c32 6e55 314a 4666  BNs8laPNL2nU1JFf
-00001320: 5171 472f 5850 5748 6b57 7935 5734 4c78  QqG/XPWHkWy5W4Lx
-00001330: 5443 6a4e 5332 6e34 6830 4b6a 4164 4664  TCjNS2n4h0KjAdFd
-00001340: 7a65 434d 376d 3372 5866 3745 3031 3442  zeCM7m3rXf7E014B
-00001350: 656c 594c 5471 5945 305a 3033 382b 7a6d  elYLTqYE0Z038+zm
-00001360: 6173 6c52 5172 6f61 522b 434b 6642 7548  aslRQroaR+CKfBuH
-00001370: 3367 6d2f 5477 4f57 6d38 4a69 396a 5465  3gm/TwOWm8Ji9jTe
-00001380: 4131 7847 736a 6b68 5754 7944 7974 7075  A1xGsjkhWTyDytpu
-00001390: 734d 7651 5259 4631 7733 516a 6c77 456a  sMvQRYF1w3QjlwEj
-000013a0: 5872 5a59 5658 3155 4742 7934 3338 3662  XrZYVX1UGBy4386b
-000013b0: 6337 665a 565a 7838 5675 5169 6f62 4f6a  c7fZVZx8VuQiobOj
-000013c0: 4355 3048 4c59 326c 384e 6365 6c56 4645  CU0HLY2l8NcelVFE
-000013d0: 4169 3068 6e53 4a76 7270 3967 3365 4757  Ai0hnSJvrp9g3eGW
-000013e0: 756f 436e 662f 5857 6339 2b63 7134 4472  uoCnf/XWc9+cq4Dr
-000013f0: 6376 7a61 3943 424e 4c67 6e58 5a4d 6574  cvza9CBNLgnXZMet
-00001400: 5a52 5772 562b 5762 4446 7771 7149 3471  ZRWrV+WbDFwqqI4q
-00001410: 4b43 6c6f 2b2f 2b48 3344 4b77 6430 6568  KClo+/+H3DKwd0eh
-00001420: 544c 5666 6a4b 366b 4545 4866 724b 3463  TLVfjK6kEEHfrK4c
-00001430: 566b 716c 656d 716d 3557 4d77 2f4c 7843  Vkqlemqm5WMw/LxC
-00001440: 3350 4243 444e 396f 614e 3163 6855 716f  3PBCDN9oaN1chUqo
-00001450: 704c 5734 6958 4470 676f 2f64 5a51 7868  pLW4iXDpgo/dZQxh
-00001460: 6e4b 2b43 4a31 5642 3047 4772 735a 7755  nK+CJ1VB0GGrsZwU
-00001470: 544c 714a 7236 6b37 7079 624a 796a 5859  TLqJr6k7pybJyjXY
-00001480: 5865 374e 2f35 326f 7551 622b 6d39 5576  Xe7N/52ouQb+m9Uv
-00001490: 595a 3544 496d 4e78 3652 7765 664e 384a  YZ5DImNx6RwefN8J
-000014a0: 6972 6333 486f 737a 7273 7730 4268 466a  irc3Hoszrsw0BhFj
-000014b0: 7653 3368 536f 3038 754b 414b 447a 6f34  vS3hSo08uKAKDzo4
-000014c0: 796b 395a 4a42 526a 7442 4163 4d34 514f  yk9ZJBRjtBAcM4QO
-000014d0: 5358 3745 3d27 2c0a 2020 2020 2020 2020  SX7E=',.        
-000014e0: 2020 2020 2020 2020 274c 5330 744c 5331          'LS0tLS1
-000014f0: 4352 5564 4a54 6942 5156 554a 4d53 554d  CRUdJTiBQVUJMSUM
-00001500: 6753 3056 5a4c 5330 744c 5330 4b54 556c  gS0VZLS0tLS0KTUl
-00001510: 4a51 306c 7151 5535 435a 3274 7861 4774  JQ0lqQU5CZ2txaGt
-00001520: 7052 7a6c 334d 454a 4255 5556 4751 5546  pRzl3MEJBUUVGQUF
-00001530: 5051 3046 6e4f 4546 4e53 556c 4451 3264  PQ0FnOEFNSUlDQ2d
-00001540: 4c51 3046 6e52 5546 3253 575a 7356 6939  LQ0FnRUF2SWZsVi9
-00001550: 4c51 6b55 7263 6b39 4362 5652 4664 564a  LQkUrck9CbVRFdVJ
-00001560: 4d55 5170 6953 5451 315a 325a 7954 5746  MUQpiSTQ1Z2ZyTWF
-00001570: 3562 6974 614e 3056 7957 6d6c 5065 5646  5bitaN0VyWmlPeVF
-00001580: 444d 6a52 5962 5652 5063 4552 5661 584a  DMjRYbVRPcERVaXJ
-00001590: 5357 6b35 4a59 7a4e 345a 544e 6e57 6c6c  SWk5JYzN4ZTNnWll
-000015a0: 3356 575a 5153 6d68 5053 5568 7657 6b4a  3VWZQSmhPSUhvWkJ
-000015b0: 4856 456c 5253 466b 7643 6a63 775a 6e4e  HVElRSFkvCjcwZnN
-000015c0: 7651 7a63 7851 7a56 7759 5568 6152 3142  vQzcxQzVwYUhaR1B
-000015d0: 7856 4774 4954 4464 6f5a 456c 585a 6c52  xVGtITDdoZElXZlR
-000015e0: 5053 4468 584d 6e4a 7361 6d46 7557 564e  PSDhXMnJsamFuWVN
-000015f0: 6953 5774 4763 3046 314f 4764 5363 4538  iSWtGc0F1OGdScE8
-00001600: 3164 3051 7951 6c56 7061 444e 7564 7a51  1d0QyQlVpaDNudzQ
-00001610: 4b64 3270 4551 5749 3156 4467 7a52 555a  Kd2pEQWI1VDgzRUZ
-00001620: 565a 4856 3551 575a 3064 6b31 4362 306c  VZHV5QWZ0dk1Cb0l
-00001630: 444c 325a 485a 3264 4b4d 4642 7261 6c4e  DL2ZHZ2dKMFBralN
-00001640: 504e 5556 7455 586f 7956 4538 3357 6b68  PNUVtUXoyVE83Wkh
-00001650: 6b52 6c51 7857 6b70 4b63 6c64 7853 4373  kRlQxWkpKcldxSCs
-00001660: 7a57 455a 4d57 4170 6e65 575a 495a 7a68  zWEZMWApneWZIZzh
-00001670: 5362 5739 7854 7a4a 4e56 5852 5854 6c56  SbW9xTzJNVXRXTlV
-00001680: 6a51 314a 5655 4530 724d 4656 4663 305a  jQ1JVUE0rMFVFc0Z
-00001690: 564d 3142 7057 4670 5861 566c 5457 5570  VM1BpWFpXaVlTWUp
-000016a0: 7854 316c 6a62 6d49 7655 5764 4d64 4339  xT1ljbmIvUWdMdC9
-000016b0: 6a4e 544a 6b57 4534 7253 4664 6d43 6c5a  jNTJkWE4rSFdmClZ
-000016c0: 3653 336c 334d 6d64 5053 4564 4f53 7a46  6S3l3MmdPSEdOSzF
-000016d0: 6164 465a 305a 324e 3052 6e68 7062 4768  adFZ0Z2N0RnhpbGh
-000016e0: 5753 5756 475a 584e 6a57 6c64 4356 564a  WSWVGZXNjWldCVVJ
-000016f0: 4b63 454a 5557 6c70 6c4b 3056 6d5a 5752  KcEJUWlplK0VmZWR
-00001700: 694d 554e 3261 314e 594d 4731 7063 6e4a  iMUN2a1NYMG1pcnJ
-00001710: 6c53 6d73 4b63 464e 4653 6a68 3357 5755  lSmsKcFNFSjh3WWU
-00001720: 3464 5464 3553 6b68 5a63 6e49 7661 565a  4dTd5SkhZcnIvaVZ
-00001730: 5353 3370 3553 6e52 4863 3074 4557 4568  SS3p5SnRHc0tEWEh
-00001740: 5555 4764 7362 6e59 3355 3270 6161 4731  UUGdsbnY3U2paaG1
-00001750: 6161 5764 7364 4574 4554 5764 714f 464a  aaWdsdEtETWdqOFJ
-00001760: 7461 6e64 554e 6d39 5855 5170 5563 5668  tandUNm9XUQpUcVh
-00001770: 694f 5842 4963 3342 4656 6d46 4357 5845  iOXBIc3BFVmFCWXE
-00001780: 7a63 3056 6d62 5535 6b61 6a56 5464 5374  zc0VmbU5kajVTdSt
-00001790: 5065 4578 3551 3368 4753 6c4d 7854 3273  PeEx5Q3hGSlMxT2s
-000017a0: 794d 474e 564e 4842 3359 304a 6f62 476c  yMGNVNHB3Y0JobGl
-000017b0: 7751 6c5a 554e 4531 4f54 6e41 3354 3156  wQlZUNE1OTnA3T1V
-000017c0: 4e43 6a49 7962 3046 714e 4578 784d 4856  NCjIyb0FqNExxMHV
-000017d0: 4a53 3364 4959 6c6f 784d 5731 7462 6d4e  JS3dIYloxMW1tbmN
-000017e0: 4362 3252 504e 6d39 7463 6d6c 7053 324d  Cb2RPNm9tcmlpS2M
-000017f0: 344e 6b5a 7759 6e41 7655 4535 6162 5646  4NkZwYnAvUE5abVF
-00001800: 6c62 3352 4d64 464e 7563 546c 4963 6e5a  lb3RMdFNucTlIcnZ
-00001810: 725a 6b46 6d62 484d 4b4e 3368 424f 4374  rZkFmbHMKN3hBOCt
-00001820: 4c62 464e 6f65 564a 6d59 5668 3065 5552  LbFNoeVJmYVh0eUR
-00001830: 7657 5773 344e 3234 3453 5777 7952 3238  vWWs4N244SWwyR28
-00001840: 7756 6b4e 3364 566c 6b62 5442 714f 5852  wVkN3dVlkbTBqOXR
-00001850: 4659 3367 304d 3064 5751 3056 4a4f 485a  FY3g0M0dWQ0VJOHZ
-00001860: 324e 7a46 3464 6d5a 6a56 486c 424d 6770  2NzF4dmZjVHlBMgp
-00001870: 6e61 3039 6862 304a 4857 5568 545a 4446  na09hb0JHWUhTZDF
-00001880: 5962 6e52 6d53 3163 3164 5759 315a 5570  YbnRmS1c1dWY1ZUp
-00001890: 4f61 5849 3063 6c4e 6e63 6d52 5757 6e64  OaXI0clNncmRWWnd
-000018a0: 4c5a 484e 504e 6a5a 4c65 6c6b 334d 5446  LZHNPNjZLelk3MTF
-000018b0: 764d 315a 6862 5442 6a55 584e 6a59 5578  vM1ZhbTBjUXNjYUx
-000018c0: 5063 5777 7843 6e51 7259 5652 564d 454e  PcWwxCnQrYVRVMEN
-000018d0: 544d 4442 4754 3270 4c55 4764 424b 3170  TMDBGT2pLUGdBK1p
-000018e0: 6a4d 3255 7751 3046 3352 5546 4255 5430  jM2UwQ0F3RUFBUT0
-000018f0: 3943 6930 744c 5330 7452 5535 4549 4642  9Ci0tLS0tRU5EIFB
-00001900: 5651 6b78 4a51 7942 4c52 566b 744c 5330  VQkxJQyBLRVktLS0
-00001910: 744c 513d 3d27 2c0a 2020 2020 2020 2020  tLQ==',.        
-00001920: 2020 2020 2020 2020 2730 3662 3633 3534          '06b6354
-00001930: 3664 3066 3837 3766 3537 6537 3439 3830  6d0f877f57e74980
-00001940: 6664 6339 3631 6235 3234 3763 3166 3037  fdc961b5247c1f07
-00001950: 3133 6638 3237 6239 6166 3661 3336 6332  13f827b9af6a36c2
-00001960: 3927 2c0a 2020 2020 2020 2020 2020 2020  9',.            
-00001970: 2020 2020 302c 0a20 2020 2020 2020 2020      0,.         
-00001980: 2020 2020 2020 2031 2c0a 2020 2020 2020         1,.      
-00001990: 2020 2020 2020 2020 2020 312c 0a20 2020            1,.   
-000019a0: 2020 2020 2020 2020 2020 2020 2027 6765               'ge
-000019b0: 6e65 7369 7327 2c0a 2020 2020 2020 2020  nesis',.        
-000019c0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-000019d0: 2020 2020 2020 2020 6864 642e 636f 6d6d          hdd.comm
-000019e0: 6974 2829 0a20 2020 2020 2020 2068 6464  it().        hdd
-000019f0: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
-00001a00: 2020 6879 7020 3d20 7371 6c69 7465 332e    hyp = sqlite3.
-00001a10: 636f 6e6e 6563 7428 2773 7461 7469 632f  connect('static/
-00001a20: 6879 7065 722e 6462 272c 2074 696d 656f  hyper.db', timeo
-00001a30: 7574 3d31 290a 2020 2020 2020 2020 6879  ut=1).        hy
-00001a40: 702e 7465 7874 5f66 6163 746f 7279 203d  p.text_factory =
-00001a50: 2073 7472 0a20 2020 2020 2020 2068 7970   str.        hyp
-00001a60: 2e65 7865 6375 7465 2827 5052 4147 4d41  .execute('PRAGMA
-00001a70: 2063 6173 655f 7365 6e73 6974 6976 655f   case_sensitive_
-00001a80: 6c69 6b65 203d 2031 3b27 290a 2020 2020  like = 1;').    
-00001a90: 2020 2020 6879 705f 6375 7273 6f72 203d      hyp_cursor =
-00001aa0: 2068 7970 2e63 7572 736f 7228 290a 2020   hyp.cursor().  
-00001ab0: 2020 2020 2020 6879 705f 6375 7273 6f72        hyp_cursor
-00001ac0: 2e65 7865 6375 7465 2827 4352 4541 5445  .execute('CREATE
-00001ad0: 2054 4142 4c45 2049 4620 4e4f 5420 4558   TABLE IF NOT EX
-00001ae0: 4953 5453 2022 6d69 7363 2220 2822 626c  ISTS "misc" ("bl
-00001af0: 6f63 6b5f 6865 6967 6874 2220 494e 5445  ock_height" INTE
-00001b00: 4745 522c 2022 6469 6666 6963 756c 7479  GER, "difficulty
-00001b10: 2220 5445 5854 2927 290a 2020 2020 2020  " TEXT)').      
-00001b20: 2020 6879 705f 6375 7273 6f72 2e65 7865    hyp_cursor.exe
-00001b30: 6375 7465 280a 2020 2020 2020 2020 2020  cute(.          
-00001b40: 2020 2743 5245 4154 4520 5441 424c 4520    'CREATE TABLE 
-00001b50: 4946 204e 4f54 2045 5849 5354 5320 2274  IF NOT EXISTS "t
-00001b60: 7261 6e73 6163 7469 6f6e 7322 2028 2262  ransactions" ("b
-00001b70: 6c6f 636b 5f68 6569 6768 7422 2049 4e54  lock_height" INT
-00001b80: 4547 4552 2c20 2274 696d 6573 7461 6d70  EGER, "timestamp
-00001b90: 2220 4e55 4d45 5249 432c 2022 6164 6472  " NUMERIC, "addr
-00001ba0: 6573 7322 2054 4558 542c 2022 7265 6369  ess" TEXT, "reci
-00001bb0: 7069 656e 7422 2054 4558 542c 2022 616d  pient" TEXT, "am
-00001bc0: 6f75 6e74 2220 4e55 4d45 5249 432c 2022  ount" NUMERIC, "
-00001bd0: 7369 676e 6174 7572 6522 2054 4558 542c  signature" TEXT,
-00001be0: 2022 7075 626c 6963 5f6b 6579 2220 5445   "public_key" TE
-00001bf0: 5854 2c20 2262 6c6f 636b 5f68 6173 6822  XT, "block_hash"
-00001c00: 2054 4558 542c 2022 6665 6522 204e 554d   TEXT, "fee" NUM
-00001c10: 4552 4943 2c20 2272 6577 6172 6422 204e  ERIC, "reward" N
-00001c20: 554d 4552 4943 2c20 226f 7065 7261 7469  UMERIC, "operati
-00001c30: 6f6e 2220 5445 5854 2c20 226f 7065 6e66  on" TEXT, "openf
-00001c40: 6965 6c64 2220 5445 5854 2927 2c0a 2020  ield" TEXT)',.  
-00001c50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00001c60: 6879 705f 6375 7273 6f72 2e65 7865 6375  hyp_cursor.execu
-00001c70: 7465 2827 4352 4541 5445 2049 4e44 4558  te('CREATE INDEX
-00001c80: 2022 5469 6d65 7374 616d 7020 496e 6465   "Timestamp Inde
-00001c90: 7822 204f 4e20 2274 7261 6e73 6163 7469  x" ON "transacti
-00001ca0: 6f6e 7322 2028 2274 696d 6573 7461 6d70  ons" ("timestamp
-00001cb0: 2229 2729 0a20 2020 2020 2020 2068 7970  ")').        hyp
-00001cc0: 5f63 7572 736f 722e 6578 6563 7574 6528  _cursor.execute(
-00001cd0: 2743 5245 4154 4520 494e 4445 5820 2253  'CREATE INDEX "S
-00001ce0: 6967 6e61 7475 7265 2049 6e64 6578 2220  ignature Index" 
-00001cf0: 4f4e 2022 7472 616e 7361 6374 696f 6e73  ON "transactions
-00001d00: 2220 2822 7369 676e 6174 7572 6522 2927  " ("signature")'
-00001d10: 290a 2020 2020 2020 2020 6879 705f 6375  ).        hyp_cu
-00001d20: 7273 6f72 2e65 7865 6375 7465 2827 4352  rsor.execute('CR
-00001d30: 4541 5445 2049 4e44 4558 2022 5265 7761  EATE INDEX "Rewa
-00001d40: 7264 2049 6e64 6578 2220 4f4e 2022 7472  rd Index" ON "tr
-00001d50: 616e 7361 6374 696f 6e73 2220 2822 7265  ansactions" ("re
-00001d60: 7761 7264 2229 2729 0a20 2020 2020 2020  ward")').       
-00001d70: 2068 7970 5f63 7572 736f 722e 6578 6563   hyp_cursor.exec
-00001d80: 7574 6528 2743 5245 4154 4520 494e 4445  ute('CREATE INDE
-00001d90: 5820 2252 6563 6970 6965 6e74 2049 6e64  X "Recipient Ind
-00001da0: 6578 2220 4f4e 2022 7472 616e 7361 6374  ex" ON "transact
-00001db0: 696f 6e73 2220 2822 7265 6369 7069 656e  ions" ("recipien
-00001dc0: 7422 2927 290a 2020 2020 2020 2020 6879  t")').        hy
-00001dd0: 705f 6375 7273 6f72 2e65 7865 6375 7465  p_cursor.execute
-00001de0: 2827 4352 4541 5445 2049 4e44 4558 2022  ('CREATE INDEX "
-00001df0: 4f70 656e 6669 656c 6420 496e 6465 7822  Openfield Index"
-00001e00: 204f 4e20 2274 7261 6e73 6163 7469 6f6e   ON "transaction
-00001e10: 7322 2028 226f 7065 6e66 6965 6c64 2229  s" ("openfield")
-00001e20: 2729 0a20 2020 2020 2020 2068 7970 5f63  ').        hyp_c
-00001e30: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00001e40: 5245 4154 4520 494e 4445 5820 2246 6565  REATE INDEX "Fee
-00001e50: 2049 6e64 6578 2220 4f4e 2022 7472 616e   Index" ON "tran
-00001e60: 7361 6374 696f 6e73 2220 2822 6665 6522  sactions" ("fee"
-00001e70: 2927 290a 2020 2020 2020 2020 6879 705f  )').        hyp_
-00001e80: 6375 7273 6f72 2e65 7865 6375 7465 2827  cursor.execute('
-00001e90: 4352 4541 5445 2049 4e44 4558 2022 426c  CREATE INDEX "Bl
-00001ea0: 6f63 6b20 4865 6967 6874 2049 6e64 6578  ock Height Index
-00001eb0: 2220 4f4e 2022 7472 616e 7361 6374 696f  " ON "transactio
-00001ec0: 6e73 2220 2822 626c 6f63 6b5f 6865 6967  ns" ("block_heig
-00001ed0: 6874 2229 2729 0a20 2020 2020 2020 2068  ht")').        h
-00001ee0: 7970 5f63 7572 736f 722e 6578 6563 7574  yp_cursor.execut
-00001ef0: 6528 2743 5245 4154 4520 494e 4445 5820  e('CREATE INDEX 
-00001f00: 2242 6c6f 636b 2048 6173 6820 496e 6465  "Block Hash Inde
-00001f10: 7822 204f 4e20 2274 7261 6e73 6163 7469  x" ON "transacti
-00001f20: 6f6e 7322 2028 2262 6c6f 636b 5f68 6173  ons" ("block_has
-00001f30: 6822 2927 290a 2020 2020 2020 2020 6879  h")').        hy
-00001f40: 705f 6375 7273 6f72 2e65 7865 6375 7465  p_cursor.execute
-00001f50: 2827 4352 4541 5445 2049 4e44 4558 2022  ('CREATE INDEX "
-00001f60: 416d 6f75 6e74 2049 6e64 6578 2220 4f4e  Amount Index" ON
-00001f70: 2022 7472 616e 7361 6374 696f 6e73 2220   "transactions" 
-00001f80: 2822 616d 6f75 6e74 2229 2729 0a20 2020  ("amount")').   
-00001f90: 2020 2020 2068 7970 5f63 7572 736f 722e       hyp_cursor.
-00001fa0: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
-00001fb0: 494e 4445 5820 2241 6464 7265 7373 2049  INDEX "Address I
-00001fc0: 6e64 6578 2220 4f4e 2022 7472 616e 7361  ndex" ON "transa
-00001fd0: 6374 696f 6e73 2220 2822 6164 6472 6573  ctions" ("addres
-00001fe0: 7322 2927 290a 2020 2020 2020 2020 6879  s")').        hy
-00001ff0: 705f 6375 7273 6f72 2e65 7865 6375 7465  p_cursor.execute
-00002000: 2827 4352 4541 5445 2049 4e44 4558 2022  ('CREATE INDEX "
-00002010: 4f70 6572 6174 696f 6e20 496e 6465 7822  Operation Index"
-00002020: 204f 4e20 2274 7261 6e73 6163 7469 6f6e   ON "transaction
-00002030: 7322 2028 226f 7065 7261 7469 6f6e 2229  s" ("operation")
-00002040: 2729 0a20 2020 2020 2020 2068 7970 5f63  ').        hyp_c
-00002050: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00002060: 5245 4154 4520 494e 4445 5820 5458 4944  REATE INDEX TXID
-00002070: 345f 496e 6465 7820 4f4e 2074 7261 6e73  4_Index ON trans
-00002080: 6163 7469 6f6e 7328 7375 6273 7472 2873  actions(substr(s
-00002090: 6967 6e61 7475 7265 2c31 2c34 2929 2729  ignature,1,4))')
-000020a0: 0a20 2020 2020 2020 2068 7970 5f63 7572  .        hyp_cur
-000020b0: 736f 722e 6578 6563 7574 6528 2743 5245  sor.execute('CRE
-000020c0: 4154 4520 494e 4445 5820 224d 6973 6320  ATE INDEX "Misc 
-000020d0: 426c 6f63 6b20 4865 6967 6874 2049 6e64  Block Height Ind
-000020e0: 6578 2220 6f6e 206d 6973 6328 626c 6f63  ex" on misc(bloc
-000020f0: 6b5f 6865 6967 6874 2927 290a 2020 2020  k_height)').    
-00002100: 2020 2020 6879 705f 6375 7273 6f72 2e65      hyp_cursor.e
-00002110: 7865 6375 7465 2827 494e 5345 5254 2049  xecute('INSERT I
-00002120: 4e54 4f20 6d69 7363 2028 6469 6666 6963  NTO misc (diffic
-00002130: 756c 7479 2c20 626c 6f63 6b5f 6865 6967  ulty, block_heig
-00002140: 6874 2920 5641 4c55 4553 2028 7b7d 2c31  ht) VALUES ({},1
-00002150: 2927 2e66 6f72 6d61 7428 494e 4954 4941  )'.format(INITIA
-00002160: 4c5f 4859 5045 525f 4449 4646 4943 554c  L_HYPER_DIFFICUL
-00002170: 5459 2929 0a20 2020 2020 2020 2068 7970  TY)).        hyp
-00002180: 5f63 7572 736f 722e 6578 6563 7574 6528  _cursor.execute(
-00002190: 0a20 2020 2020 2020 2020 2020 2027 494e  .            'IN
-000021a0: 5345 5254 2049 4e54 4f20 7472 616e 7361  SERT INTO transa
-000021b0: 6374 696f 6e73 2056 414c 5545 5320 283f  ctions VALUES (?
-000021c0: 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f  ,?,?,?,?,?,?,?,?
-000021d0: 2c3f 2c3f 2c3f 2927 2c20 280a 2020 2020  ,?,?,?)', (.    
-000021e0: 2020 2020 2020 2020 2020 2020 2731 272c              '1',
-000021f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002200: 2027 3136 3630 3233 3031 3937 2e37 3532   '1660230197.752
-00002210: 3939 272c 0a20 2020 2020 2020 2020 2020  99',.           
-00002220: 2020 2020 2027 6765 6e65 7369 7327 2c0a       'genesis',.
-00002230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002240: 2733 6239 6361 3939 6137 3830 3430 3135  '3b9ca99a7804015
-00002250: 6638 6561 6562 6237 3864 3462 3530 3537  f8eaebb78d4b5057
-00002260: 3062 6438 3333 3765 3861 3831 3936 3334  0bd8337e8a819634
-00002270: 3364 6262 6235 3963 3427 2c0a 2020 2020  3dbbb59c4',.    
-00002280: 2020 2020 2020 2020 2020 2020 2730 272c              '0',
-00002290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000022a0: 2027 5157 6348 6634 6739 494f 792f 5867   'QWcHf4g9IOy/Xg
-000022b0: 702b 6b61 6b6b 6e39 536a 6c2f 6262 4d76  p+kakkn9Sjl/bbMv
-000022c0: 637a 3839 6333 4c48 7036 5a2b 4467 3641  cz89c3LHp6Z+Dg6A
-000022d0: 7859 434c 4f37 706c 574d 4a30 4c69 6843  xYCLO7plWMJ0LihC
-000022e0: 454a 5041 586b 7652 396d 6656 596e 6578  EJPAXkvR9mfVYnex
-000022f0: 7573 5336 7a4d 4936 5250 5450 616f 6a6c  usS6zMI6RPTPaojl
-00002300: 7276 6431 5947 2f4e 4a45 5150 6344 4d48  rvd1YG/NJEQPcDMH
-00002310: 5433 5832 6846 7941 4b35 6254 4233 6f6c  T3X2hFyAK5bTB3ol
-00002320: 6153 566f 6f49 662f 384f 6652 3332 5444  aSVooIf/8OfR32TD
-00002330: 6f75 5370 6d32 4f35 4c6b 644f 5755 4945  ouSpm2O5LkdOWUIE
-00002340: 4967 3865 7147 4b38 6449 2b70 3645 7676  Ig8eqGK8dI+p6Evv
-00002350: 5167 3167 4543 6e4e 6f4a 4c79 6447 6636  Qg1gECnNoJLydGf6
-00002360: 7538 4657 4c4c 652f 5569 7236 6233 5836  u8FWLLe/Uir6b3X6
-00002370: 4866 4f6f 5953 7032 6556 4254 6b6e 386a  HfOoYSp2eVBTkn8j
-00002380: 6a48 5467 7a2f 7a53 4942 4e73 386c 6150  jHTgz/zSIBNs8laP
-00002390: 4e4c 326e 5531 4a46 6651 7147 2f58 5057  NL2nU1JFfQqG/XPW
-000023a0: 486b 5779 3557 344c 7854 436a 4e53 326e  HkWy5W4LxTCjNS2n
-000023b0: 3468 304b 6a41 6446 647a 6543 4d37 6d33  4h0KjAdFdzeCM7m3
-000023c0: 7258 6637 4530 3134 4265 6c59 4c54 7159  rXf7E014BelYLTqY
-000023d0: 4530 5a30 3338 2b7a 6d61 736c 5251 726f  E0Z038+zmaslRQro
-000023e0: 6152 2b43 4b66 4275 4833 676d 2f54 774f  aR+CKfBuH3gm/TwO
-000023f0: 576d 384a 6939 6a54 6541 3178 4773 6a6b  Wm8Ji9jTeA1xGsjk
-00002400: 6857 5479 4479 7470 7573 4d76 5152 5946  hWTyDytpusMvQRYF
-00002410: 3177 3351 6a6c 7745 6a58 725a 5956 5831  1w3QjlwEjXrZYVX1
-00002420: 5547 4279 3433 3836 6263 3766 5a56 5a78  UGBy4386bc7fZVZx
-00002430: 3856 7551 696f 624f 6a43 5530 484c 5932  8VuQiobOjCU0HLY2
-00002440: 6c38 4e63 656c 5646 4541 6930 686e 534a  l8NcelVFEAi0hnSJ
-00002450: 7672 7039 6733 6547 5775 6f43 6e66 2f58  vrp9g3eGWuoCnf/X
-00002460: 5763 392b 6371 3444 7263 767a 6139 4342  Wc9+cq4Drcvza9CB
-00002470: 4e4c 676e 585a 4d65 745a 5257 7256 2b57  NLgnXZMetZRWrV+W
-00002480: 6244 4677 7171 4934 714b 436c 6f2b 2f2b  bDFwqqI4qKClo+/+
-00002490: 4833 444b 7764 3065 6854 4c56 666a 4b36  H3DKwd0ehTLVfjK6
-000024a0: 6b45 4548 6672 4b34 6356 6b71 6c65 6d71  kEEHfrK4cVkqlemq
-000024b0: 6d35 574d 772f 4c78 4333 5042 4344 4e39  m5WMw/LxC3PBCDN9
-000024c0: 6f61 4e31 6368 5571 6f70 4c57 3469 5844  oaN1chUqopLW4iXD
-000024d0: 7067 6f2f 645a 5178 686e 4b2b 434a 3156  pgo/dZQxhnK+CJ1V
-000024e0: 4230 4747 7273 5a77 5554 4c71 4a72 366b  B0GGrsZwUTLqJr6k
-000024f0: 3770 7962 4a79 6a58 5958 6537 4e2f 3532  7pybJyjXYXe7N/52
-00002500: 6f75 5162 2b6d 3955 7659 5a35 4449 6d4e  ouQb+m9UvYZ5DImN
-00002510: 7836 5277 6566 4e38 4a69 7263 3348 6f73  x6RwefN8Jirc3Hos
-00002520: 7a72 7377 3042 6846 6a76 5333 6853 6f30  zrsw0BhFjvS3hSo0
-00002530: 3875 4b41 4b44 7a6f 3479 6b39 5a4a 4252  8uKAKDzo4yk9ZJBR
-00002540: 6a74 4241 634d 3451 4f53 5837 453d 272c  jtBAcM4QOSX7E=',
-00002550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002560: 2027 4c53 3074 4c53 3143 5255 644a 5469   'LS0tLS1CRUdJTi
-00002570: 4251 5655 4a4d 5355 4d67 5330 565a 4c53  BQVUJMSUMgS0VZLS
-00002580: 3074 4c53 304b 5455 6c4a 5130 6c71 5155  0tLS0KTUlJQ0lqQU
-00002590: 3543 5a32 7478 6147 7470 527a 6c33 4d45  5CZ2txaGtpRzl3ME
-000025a0: 4a42 5555 5647 5155 4650 5130 466e 4f45  JBUUVGQUFPQ0FnOE
-000025b0: 464e 5355 6c44 5132 644c 5130 466e 5255  FNSUlDQ2dLQ0FnRU
-000025c0: 4632 5357 5a73 5669 394c 516b 5572 636b  F2SWZsVi9LQkUrck
-000025d0: 3943 6256 5246 6456 4a4d 5551 7069 5354  9CbVRFdVJMUQpiST
-000025e0: 5131 5a32 5a79 5457 4635 6269 7461 4e30  Q1Z2ZyTWF5bitaN0
-000025f0: 5679 576d 6c50 6556 4644 4d6a 5259 6256  VyWmlPeVFDMjRYbV
-00002600: 5250 6345 5256 6158 4a53 576b 354a 597a  RPcERVaXJSWk5JYz
-00002610: 4e34 5a54 4e6e 576c 6c33 5657 5a51 536d  N4ZTNnWll3VWZQSm
-00002620: 6850 5355 6876 576b 4a48 5645 6c52 5346  hPSUhvWkJHVElRSF
-00002630: 6b76 436a 6377 5a6e 4e76 517a 6378 517a  kvCjcwZnNvQzcxQz
-00002640: 5677 5955 6861 5231 4278 5647 7449 5444  VwYUhaR1BxVGtITD
-00002650: 646f 5a45 6c58 5a6c 5250 5344 6858 4d6e  doZElXZlRPSDhXMn
-00002660: 4a73 616d 4675 5756 4e69 5357 7447 6330  JsamFuWVNiSWtGc0
-00002670: 4631 4f47 6453 6345 3831 6430 5179 516c  F1OGdScE81d0QyQl
-00002680: 5670 6144 4e75 647a 514b 6432 7045 5157  VpaDNudzQKd2pEQW
-00002690: 4931 5644 677a 5255 5a56 5a48 5635 5157  I1VDgzRUZVZHV5QW
-000026a0: 5a30 646b 3143 6230 6c44 4c32 5a48 5a32  Z0dk1Cb0lDL2ZHZ2
-000026b0: 644b 4d46 4272 616c 4e50 4e55 5674 5558  dKMFBralNPNUVtUX
-000026c0: 6f79 5645 3833 576b 686b 526c 5178 576b  oyVE83WkhkRlQxWk
-000026d0: 704b 636c 6478 5343 737a 5745 5a4d 5741  pKcldxSCszWEZMWA
-000026e0: 706e 6557 5a49 5a7a 6853 6257 3978 547a  pneWZIZzhSbW9xTz
-000026f0: 4a4e 5658 5258 546c 566a 5131 4a56 5545  JNVXRXTlVjQ1JVUE
-00002700: 3072 4d46 5646 6330 5a56 4d31 4270 5746  0rMFVFc0ZVM1BpWF
-00002710: 7058 6156 6c54 5755 7078 5431 6c6a 626d  pXaVlTWUpxT1ljbm
-00002720: 4976 5557 644d 6443 396a 4e54 4a6b 5745  IvUWdMdC9jNTJkWE
-00002730: 3472 5346 646d 436c 5a36 5333 6c33 4d6d  4rSFdmClZ6S3l3Mm
-00002740: 6450 5345 644f 537a 4661 6446 5a30 5a32  dPSEdOSzFadFZ0Z2
-00002750: 4e30 526e 6870 6247 6857 5357 5647 5a58  N0RnhpbGhWSWVGZX
-00002760: 4e6a 576c 6443 5656 4a4b 6345 4a55 576c  NjWldCVVJKcEJUWl
-00002770: 706c 4b30 566d 5a57 5269 4d55 4e32 6131  plK0VmZWRiMUN2a1
-00002780: 4e59 4d47 3170 636e 4a6c 536d 734b 6346  NYMG1pcnJlSmsKcF
-00002790: 4e46 536a 6833 5757 5534 6454 6435 536b  NFSjh3WWU4dTd5Sk
-000027a0: 685a 636e 4976 6156 5a53 5333 7035 536e  hZcnIvaVZSS3p5Sn
-000027b0: 5248 6330 7445 5745 6855 5547 6473 626e  RHc0tEWEhUUGdsbn
-000027c0: 5933 5532 7061 6147 3161 6157 6473 6445  Y3U2paaG1aaWdsdE
-000027d0: 7445 5457 6471 4f46 4a74 616e 6455 4e6d  tETWdqOFJtandUNm
-000027e0: 3958 5551 7055 6356 6869 4f58 4249 6333  9XUQpUcVhiOXBIc3
-000027f0: 4246 566d 4643 5758 457a 6330 566d 6255  BFVmFCWXEzc0VmbU
-00002800: 356b 616a 5654 6453 7450 6545 7835 5133  5kajVTdStPeEx5Q3
-00002810: 6847 536c 4d78 5432 7379 4d47 4e56 4e48  hGSlMxT2syMGNVNH
-00002820: 4233 5930 4a6f 6247 6c77 516c 5a55 4e45  B3Y0JobGlwQlZUNE
-00002830: 314f 546e 4133 5431 564e 436a 4979 6230  1OTnA3T1VNCjIyb0
-00002840: 4671 4e45 7878 4d48 564a 5333 6449 596c  FqNExxMHVJS3dIYl
-00002850: 6f78 4d57 3174 626d 4e43 6232 5250 4e6d  oxMW1tbmNCb2RPNm
-00002860: 3974 636d 6c70 5332 4d34 4e6b 5a77 596e  9tcmlpS2M4NkZwYn
-00002870: 4176 5545 3561 6256 466c 6233 524d 6446  AvUE5abVFlb3RMdF
-00002880: 4e75 6354 6c49 636e 5a72 5a6b 466d 6248  NucTlIcnZrZkFmbH
-00002890: 4d4b 4e33 6842 4f43 744c 6246 4e6f 6556  MKN3hBOCtLbFNoeV
-000028a0: 4a6d 5956 6830 6555 5276 5757 7334 4e32  JmYVh0eURvWWs4N2
-000028b0: 3434 5357 7779 5232 3877 566b 4e33 6456  44SWwyR28wVkN3dV
-000028c0: 6c6b 6254 4271 4f58 5246 5933 6730 4d30  lkbTBqOXRFY3g0M0
-000028d0: 6457 5130 564a 4f48 5a32 4e7a 4634 646d  dWQ0VJOHZ2NzF4dm
-000028e0: 5a6a 5648 6c42 4d67 706e 6130 3968 6230  ZjVHlBMgpna09hb0
-000028f0: 4a48 5755 6854 5a44 4659 626e 526d 5331  JHWUhTZDFYbnRmS1
-00002900: 6331 6457 5931 5a55 704f 6158 4930 636c  c1dWY1ZUpOaXI0cl
-00002910: 4e6e 636d 5257 576e 644c 5a48 4e50 4e6a  NncmRWWndLZHNPNj
-00002920: 5a4c 656c 6b33 4d54 4676 4d31 5a68 6254  ZLelk3MTFvM1ZhbT
-00002930: 426a 5558 4e6a 5955 7850 6357 7778 436e  BjUXNjYUxPcWwxCn
-00002940: 5172 5956 5256 4d45 4e54 4d44 4247 5432  QrYVRVMENTMDBGT2
-00002950: 704c 5547 6442 4b31 706a 4d32 5577 5130  pLUGdBK1pjM2UwQ0
-00002960: 4633 5255 4642 5554 3039 4369 3074 4c53  F3RUFBUT09Ci0tLS
-00002970: 3074 5255 3545 4946 4256 516b 784a 5179  0tRU5EIFBVQkxJQy
-00002980: 424c 5256 6b74 4c53 3074 4c51 3d3d 272c  BLRVktLS0tLQ==',
-00002990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000029a0: 2027 3036 6236 3335 3436 6430 6638 3737   '06b63546d0f877
-000029b0: 6635 3765 3734 3938 3066 6463 3936 3162  f57e74980fdc961b
-000029c0: 3532 3437 6331 6630 3731 3366 3832 3762  5247c1f0713f827b
-000029d0: 3961 6636 6133 3663 3239 272c 0a20 2020  9af6a36c29',.   
-000029e0: 2020 2020 2020 2020 2020 2020 2030 2c0a               0,.
-000029f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a00: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00002a10: 2020 2031 2c0a 2020 2020 2020 2020 2020     1,.          
-00002a20: 2020 2020 2020 2767 656e 6573 6973 272c        'genesis',
-00002a30: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00002a40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00002a50: 2068 7970 2e63 6f6d 6d69 7428 290a 2020   hyp.commit().  
-00002a60: 2020 2020 2020 6879 702e 636c 6f73 6528        hyp.close(
-00002a70: 290a 0a20 2020 2020 2020 2069 6e64 6578  )..        index
-00002a80: 203d 2073 716c 6974 6533 2e63 6f6e 6e65   = sqlite3.conne
-00002a90: 6374 2827 7374 6174 6963 2f69 6e64 6578  ct('static/index
-00002aa0: 2e64 6227 2c20 7469 6d65 6f75 743d 3129  .db', timeout=1)
-00002ab0: 0a20 2020 2020 2020 2069 6e64 6578 2e74  .        index.t
-00002ac0: 6578 745f 6661 6374 6f72 7920 3d20 7374  ext_factory = st
-00002ad0: 720a 2020 2020 2020 2020 696e 6465 782e  r.        index.
-00002ae0: 6578 6563 7574 6528 2750 5241 474d 4120  execute('PRAGMA 
-00002af0: 6361 7365 5f73 656e 7369 7469 7665 5f6c  case_sensitive_l
-00002b00: 696b 6520 3d20 313b 2729 0a20 2020 2020  ike = 1;').     
-00002b10: 2020 2069 6e64 6578 5f63 7572 736f 7220     index_cursor 
-00002b20: 3d20 696e 6465 782e 6375 7273 6f72 2829  = index.cursor()
-00002b30: 0a20 2020 2020 2020 2069 6e64 6578 5f63  .        index_c
-00002b40: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
-00002b50: 5245 4154 4520 5441 424c 4520 746f 6b65  REATE TABLE toke
-00002b60: 6e73 2028 626c 6f63 6b5f 6865 6967 6874  ns (block_height
-00002b70: 2049 4e54 4547 4552 2c20 7469 6d65 7374   INTEGER, timest
-00002b80: 616d 702c 2074 6f6b 656e 2c20 6164 6472  amp, token, addr
-00002b90: 6573 732c 2072 6563 6970 6965 6e74 2c20  ess, recipient, 
-00002ba0: 7478 6964 2c20 616d 6f75 6e74 2049 4e54  txid, amount INT
-00002bb0: 4547 4552 2927 290a 2020 2020 2020 2020  EGER)').        
-00002bc0: 696e 6465 785f 6375 7273 6f72 2e65 7865  index_cursor.exe
-00002bd0: 6375 7465 2827 4352 4541 5445 2054 4142  cute('CREATE TAB
-00002be0: 4c45 2061 6c69 6173 6573 2028 626c 6f63  LE aliases (bloc
-00002bf0: 6b5f 6865 6967 6874 2049 4e54 4547 4552  k_height INTEGER
-00002c00: 2c20 6164 6472 6573 732c 2061 6c69 6173  , address, alias
-00002c10: 2927 290a 2020 2020 2020 2020 696e 6465  )').        inde
-00002c20: 785f 6375 7273 6f72 2e65 7865 6375 7465  x_cursor.execute
-00002c30: 2827 4352 4541 5445 2049 4e44 4558 2022  ('CREATE INDEX "
-00002c40: 416c 6961 7320 496e 6465 7822 204f 4e20  Alias Index" ON 
-00002c50: 2261 6c69 6173 6573 2220 2822 626c 6f63  "aliases" ("bloc
-00002c60: 6b5f 6865 6967 6874 222c 2022 6164 6472  k_height", "addr
-00002c70: 6573 7322 2c22 616c 6961 7322 2927 290a  ess","alias")').
-00002c80: 2020 2020 2020 2020 696e 6465 785f 6375          index_cu
-00002c90: 7273 6f72 2e65 7865 6375 7465 2827 4352  rsor.execute('CR
-00002ca0: 4541 5445 2049 4e44 4558 2022 546f 6b65  EATE INDEX "Toke
-00002cb0: 6e20 496e 6465 7822 204f 4e20 2274 6f6b  n Index" ON "tok
-00002cc0: 656e 7322 2028 2262 6c6f 636b 5f68 6569  ens" ("block_hei
-00002cd0: 6768 7422 2c22 7469 6d65 7374 616d 7022  ght","timestamp"
-00002ce0: 2c22 746f 6b65 6e22 2c22 6164 6472 6573  ,"token","addres
-00002cf0: 7322 2c22 7265 6369 7069 656e 7422 2c22  s","recipient","
-00002d00: 7478 6964 222c 2261 6d6f 756e 7422 2927  txid","amount")'
-00002d10: 290a 2020 2020 2020 2020 696e 6465 785f  ).        index_
-00002d20: 6375 7273 6f72 2e65 7865 6375 7465 2827  cursor.execute('
-00002d30: 4352 4541 5445 2054 4142 4c45 2073 7461  CREATE TABLE sta
-00002d40: 6b69 6e67 2028 626c 6f63 6b5f 6865 6967  king (block_heig
-00002d50: 6874 2049 4e54 4547 4552 2c20 7469 6d65  ht INTEGER, time
-00002d60: 7374 616d 7020 4e55 4d45 5249 432c 2061  stamp NUMERIC, a
-00002d70: 6464 7265 7373 2c20 6261 6c61 6e63 652c  ddress, balance,
-00002d80: 2069 702c 2070 6f72 742c 2070 6f73 5f61   ip, port, pos_a
-00002d90: 6464 7265 7373 2927 290a 2020 2020 2020  ddress)').      
-00002da0: 2020 696e 6465 782e 636f 6d6d 6974 2829    index.commit()
-00002db0: 0a20 2020 2020 2020 2069 6e64 6578 2e63  .        index.c
-00002dc0: 6c6f 7365 2829 0a0a 2020 2020 6578 6365  lose()..    exce
-00002dd0: 7074 3a0a 2020 2020 2020 2020 6e6f 6465  pt:.        node
-00002de0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-00002df0: 7761 726e 696e 6728 2753 6f6d 6574 6869  warning('Somethi
-00002e00: 6e67 2077 656e 7420 7772 6f6e 6720 6475  ng went wrong du
-00002e10: 7269 6e67 2062 6f6f 7473 7472 6170 7069  ring bootstrappi
-00002e20: 6e67 2c20 6162 6f72 7465 6427 290a 2020  ng, aborted').  
-00002e30: 2020 2020 2020 7261 6973 650a 0a0a 6465        raise...de
-00002e40: 6620 6368 6563 6b5f 696e 7465 6772 6974  f check_integrit
-00002e50: 7928 6461 7461 6261 7365 293a 0a20 2020  y(database):.   
-00002e60: 2023 2054 4f44 4f3a 2043 616e 6469 6461   # TODO: Candida
-00002e70: 7465 2066 6f72 2073 696e 676c 6520 7573  te for single us
-00002e80: 6572 206d 6f64 650a 2020 2020 2320 6368  er mode.    # ch
-00002e90: 6563 6b20 6c65 6467 6572 2069 6e74 6567  eck ledger integ
-00002ea0: 7269 7479 0a0a 2020 2020 6966 206e 6f74  rity..    if not
-00002eb0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-00002ec0: 2773 7461 7469 6327 293a 0a20 2020 2020  'static'):.     
-00002ed0: 2020 206f 732e 6d6b 6469 7228 2773 7461     os.mkdir('sta
-00002ee0: 7469 6327 290a 0a20 2020 2077 6974 6820  tic')..    with 
-00002ef0: 7371 6c69 7465 332e 636f 6e6e 6563 7428  sqlite3.connect(
-00002f00: 6461 7461 6261 7365 2920 6173 206c 6564  database) as led
-00002f10: 6765 725f 6368 6563 6b3a 0a20 2020 2020  ger_check:.     
-00002f20: 2020 2069 6620 6e6f 6465 2e74 7261 6365     if node.trace
-00002f30: 5f64 625f 6361 6c6c 733a 0a20 2020 2020  _db_calls:.     
-00002f40: 2020 2020 2020 206c 6564 6765 725f 6368         ledger_ch
-00002f50: 6563 6b2e 7365 745f 7472 6163 655f 6361  eck.set_trace_ca
-00002f60: 6c6c 6261 636b 2866 756e 6374 6f6f 6c73  llback(functools
-00002f70: 2e70 6172 7469 616c 2873 716c 5f74 7261  .partial(sql_tra
-00002f80: 6365 5f63 616c 6c62 6163 6b2c 206e 6f64  ce_callback, nod
-00002f90: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00002fa0: 2c20 2743 4845 434b 5f49 4e54 4547 5249  , 'CHECK_INTEGRI
-00002fb0: 5459 2729 290a 0a20 2020 2020 2020 206c  TY'))..        l
-00002fc0: 6564 6765 725f 6368 6563 6b2e 7465 7874  edger_check.text
-00002fd0: 5f66 6163 746f 7279 203d 2073 7472 0a20  _factory = str. 
-00002fe0: 2020 2020 2020 206c 203d 206c 6564 6765         l = ledge
-00002ff0: 725f 6368 6563 6b2e 6375 7273 6f72 2829  r_check.cursor()
-00003000: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-00003010: 2020 2020 2020 2020 2020 206c 2e65 7865             l.exe
-00003020: 6375 7465 2822 5052 4147 4d41 2074 6162  cute("PRAGMA tab
-00003030: 6c65 5f69 6e66 6f28 2774 7261 6e73 6163  le_info('transac
-00003040: 7469 6f6e 7327 2922 290a 2020 2020 2020  tions')").      
-00003050: 2020 2020 2020 7265 646f 776e 6c6f 6164        redownload
-00003060: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00003070: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00003080: 2020 2020 2072 6564 6f77 6e6c 6f61 6420       redownload 
-00003090: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-000030a0: 6966 206c 656e 286c 2e66 6574 6368 616c  if len(l.fetchal
-000030b0: 6c28 2929 2021 3d20 3132 3a0a 2020 2020  l()) != 12:.    
-000030c0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-000030d0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-000030e0: 696e 6728 6627 5374 6174 7573 3a20 496e  ing(f'Status: In
-000030f0: 7465 6772 6974 7920 6368 6563 6b20 6f6e  tegrity check on
-00003100: 2064 6174 6162 6173 6520 7b64 6174 6162   database {datab
-00003110: 6173 657d 2066 6169 6c65 642c 2062 6f6f  ase} failed, boo
-00003120: 7473 7472 6170 7069 6e67 2066 726f 6d20  tstrapping from 
-00003130: 7468 6520 7765 6273 6974 6527 290a 2020  the website').  
-00003140: 2020 2020 2020 2020 2020 7265 646f 776e            redown
-00003150: 6c6f 6164 203d 2054 7275 650a 0a20 2020  load = True..   
-00003160: 2069 6620 7265 646f 776e 6c6f 6164 2061   if redownload a
-00003170: 6e64 206e 6f64 652e 6973 5f6d 6169 6e6e  nd node.is_mainn
-00003180: 6574 3a0a 2020 2020 2020 2020 626f 6f74  et:.        boot
-00003190: 7374 7261 7028 290a 0a0a 6465 6620 726f  strap()...def ro
-000031a0: 6c6c 6261 636b 286e 6f64 652c 2064 625f  llback(node, db_
-000031b0: 6861 6e64 6c65 722c 2062 6c6f 636b 5f68  handler, block_h
-000031c0: 6569 6768 7429 3a0a 2020 2020 6e6f 6465  eight):.    node
-000031d0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-000031e0: 7761 726e 696e 6728 6627 5374 6174 7573  warning(f'Status
-000031f0: 3a20 526f 6c6c 696e 6720 6261 636b 2062  : Rolling back b
-00003200: 656c 6f77 3a20 7b62 6c6f 636b 5f68 6569  elow: {block_hei
-00003210: 6768 747d 2729 0a0a 2020 2020 6462 5f68  ght}')..    db_h
-00003220: 616e 646c 6572 2e72 6f6c 6c62 6163 6b5f  andler.rollback_
-00003230: 756e 6465 7228 626c 6f63 6b5f 6865 6967  under(block_heig
-00003240: 6874 290a 0a20 2020 2023 2072 6f6c 6c62  ht)..    # rollb
-00003250: 6163 6b20 696e 6469 6365 730a 2020 2020  ack indices.    
-00003260: 6462 5f68 616e 646c 6572 2e74 6f6b 656e  db_handler.token
-00003270: 735f 726f 6c6c 6261 636b 286e 6f64 652c  s_rollback(node,
-00003280: 2062 6c6f 636b 5f68 6569 6768 7429 0a20   block_height). 
-00003290: 2020 2064 625f 6861 6e64 6c65 722e 616c     db_handler.al
-000032a0: 6961 7365 735f 726f 6c6c 6261 636b 286e  iases_rollback(n
-000032b0: 6f64 652c 2062 6c6f 636b 5f68 6569 6768  ode, block_heigh
-000032c0: 7429 0a20 2020 2023 2072 6f6c 6c62 6163  t).    # rollbac
-000032d0: 6b20 696e 6469 6365 730a 0a20 2020 206e  k indices..    n
-000032e0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-000032f0: 6f67 2e77 6172 6e69 6e67 2866 2753 7461  og.warning(f'Sta
-00003300: 7475 733a 2043 6861 696e 2072 6f6c 6c65  tus: Chain rolle
-00003310: 6420 6261 636b 2062 656c 6f77 207b 626c  d back below {bl
-00003320: 6f63 6b5f 6865 6967 6874 7d20 616e 6420  ock_height} and 
-00003330: 7769 6c6c 2062 6520 7265 7379 6e63 6872  will be resynchr
-00003340: 6f6e 697a 6564 2729 0a0a 0a64 6566 2072  onized')...def r
-00003350: 6563 6f6d 7072 6573 735f 6c65 6467 6572  ecompress_ledger
-00003360: 286e 6f64 652c 2072 6562 7569 6c64 3d46  (node, rebuild=F
-00003370: 616c 7365 2c20 6465 7074 683d 3135 3030  alse, depth=1500
-00003380: 3029 3a0a 2020 2020 2320 544f 444f 3a20  0):.    # TODO: 
-00003390: 4361 6e64 6964 6174 6520 666f 7220 7369  Candidate for si
-000033a0: 6e67 6c65 2075 7365 7220 6d6f 6465 0a20  ngle user mode. 
-000033b0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-000033c0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
-000033d0: 2753 7461 7475 733a 2052 6563 6f6d 7072  'Status: Recompr
-000033e0: 6573 7369 6e67 2c20 706c 6561 7365 2062  essing, please b
-000033f0: 6520 7061 7469 656e 7427 290a 0a20 2020  e patient')..   
-00003400: 2066 696c 6573 5f72 656d 6f76 6520 3d20   files_remove = 
-00003410: 5b6e 6f64 652e 6c65 6467 6572 5f70 6174  [node.ledger_pat
-00003420: 6820 2b20 272e 7465 6d70 272c 206e 6f64  h + '.temp', nod
-00003430: 652e 6c65 6467 6572 5f70 6174 6820 2b20  e.ledger_path + 
-00003440: 272e 7465 6d70 2d73 686d 272c 206e 6f64  '.temp-shm', nod
-00003450: 652e 6c65 6467 6572 5f70 6174 6820 2b20  e.ledger_path + 
-00003460: 272e 7465 6d70 2d77 616c 275d 0a20 2020  '.temp-wal'].   
-00003470: 2066 6f72 2066 696c 6520 696e 2066 696c   for file in fil
-00003480: 6573 5f72 656d 6f76 653a 0a20 2020 2020  es_remove:.     
-00003490: 2020 2069 6620 6f73 2e70 6174 682e 6578     if os.path.ex
-000034a0: 6973 7473 2866 696c 6529 3a0a 2020 2020  ists(file):.    
-000034b0: 2020 2020 2020 2020 6f73 2e72 656d 6f76          os.remov
-000034c0: 6528 6669 6c65 290a 2020 2020 2020 2020  e(file).        
-000034d0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-000034e0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
-000034f0: 6627 5265 6d6f 7665 6420 6f6c 6420 7b66  f'Removed old {f
-00003500: 696c 657d 2729 0a0a 2020 2020 6966 2072  ile}')..    if r
-00003510: 6562 7569 6c64 3a0a 2020 2020 2020 2020  ebuild:.        
-00003520: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00003530: 6c6f 672e 7761 726e 696e 6728 6627 5374  log.warning(f'St
-00003540: 6174 7573 3a20 4879 7065 7262 6c6f 636b  atus: Hyperblock
-00003550: 7320 7769 6c6c 2062 6520 7265 6275 696c  s will be rebuil
-00003560: 7427 290a 0a20 2020 2020 2020 2073 6875  t')..        shu
-00003570: 7469 6c2e 636f 7079 286e 6f64 652e 6c65  til.copy(node.le
-00003580: 6467 6572 5f70 6174 682c 206e 6f64 652e  dger_path, node.
-00003590: 6c65 6467 6572 5f70 6174 6820 2b20 272e  ledger_path + '.
-000035a0: 7465 6d70 2729 0a20 2020 2020 2020 2068  temp').        h
-000035b0: 7970 6572 203d 2073 716c 6974 6533 2e63  yper = sqlite3.c
-000035c0: 6f6e 6e65 6374 286e 6f64 652e 6c65 6467  onnect(node.ledg
-000035d0: 6572 5f70 6174 6820 2b20 272e 7465 6d70  er_path + '.temp
-000035e0: 2729 0a20 2020 2065 6c73 653a 0a20 2020  ').    else:.   
-000035f0: 2020 2020 2073 6875 7469 6c2e 636f 7079       shutil.copy
-00003600: 286e 6f64 652e 6879 7065 725f 7061 7468  (node.hyper_path
-00003610: 2c20 6e6f 6465 2e6c 6564 6765 725f 7061  , node.ledger_pa
-00003620: 7468 202b 2027 2e74 656d 7027 290a 2020  th + '.temp').  
-00003630: 2020 2020 2020 6879 7065 7220 3d20 7371        hyper = sq
-00003640: 6c69 7465 332e 636f 6e6e 6563 7428 6e6f  lite3.connect(no
-00003650: 6465 2e6c 6564 6765 725f 7061 7468 202b  de.ledger_path +
-00003660: 2027 2e74 656d 7027 290a 2020 2020 6966   '.temp').    if
-00003670: 206e 6f64 652e 7472 6163 655f 6462 5f63   node.trace_db_c
-00003680: 616c 6c73 3a0a 2020 2020 2020 2020 6879  alls:.        hy
-00003690: 7065 722e 7365 745f 7472 6163 655f 6361  per.set_trace_ca
-000036a0: 6c6c 6261 636b 2866 756e 6374 6f6f 6c73  llback(functools
-000036b0: 2e70 6172 7469 616c 2873 716c 5f74 7261  .partial(sql_tra
-000036c0: 6365 5f63 616c 6c62 6163 6b2c 206e 6f64  ce_callback, nod
-000036d0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-000036e0: 2c20 2748 5950 4552 2729 290a 2020 2020  , 'HYPER')).    
-000036f0: 6879 7065 722e 7465 7874 5f66 6163 746f  hyper.text_facto
-00003700: 7279 203d 2073 7472 0a20 2020 2068 7970  ry = str.    hyp
-00003710: 203d 2068 7970 6572 2e63 7572 736f 7228   = hyper.cursor(
-00003720: 290a 0a20 2020 2068 7970 2e65 7865 6375  )..    hyp.execu
-00003730: 7465 2822 5550 4441 5445 2074 7261 6e73  te("UPDATE trans
-00003740: 6163 7469 6f6e 7320 5345 5420 6164 6472  actions SET addr
-00003750: 6573 7320 3d20 2748 7970 6f62 6c6f 636b  ess = 'Hypoblock
-00003760: 2720 5748 4552 4520 6164 6472 6573 7320  ' WHERE address 
-00003770: 3d20 2748 7970 6572 626c 6f63 6b27 2229  = 'Hyperblock'")
-00003780: 0a0a 2020 2020 6879 702e 6578 6563 7574  ..    hyp.execut
-00003790: 6528 2753 454c 4543 5420 6d61 7828 626c  e('SELECT max(bl
-000037a0: 6f63 6b5f 6865 6967 6874 2920 4652 4f4d  ock_height) FROM
-000037b0: 2074 7261 6e73 6163 7469 6f6e 7327 290a   transactions').
-000037c0: 2020 2020 6462 5f62 6c6f 636b 5f68 6569      db_block_hei
-000037d0: 6768 7420 3d20 696e 7428 6879 702e 6665  ght = int(hyp.fe
-000037e0: 7463 686f 6e65 2829 5b30 5d29 0a20 2020  tchone()[0]).   
-000037f0: 2064 6570 7468 5f73 7065 6369 6669 6320   depth_specific 
-00003800: 3d20 6462 5f62 6c6f 636b 5f68 6569 6768  = db_block_heigh
-00003810: 7420 2d20 6465 7074 680a 0a20 2020 2068  t - depth..    h
-00003820: 7970 2e65 7865 6375 7465 280a 2020 2020  yp.execute(.    
-00003830: 2020 2020 2753 454c 4543 5420 6469 7374      'SELECT dist
-00003840: 696e 6374 2872 6563 6970 6965 6e74 2920  inct(recipient) 
-00003850: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-00003860: 7320 5748 4552 4520 2862 6c6f 636b 5f68  s WHERE (block_h
-00003870: 6569 6768 7420 3c20 3f20 414e 4420 626c  eight < ? AND bl
-00003880: 6f63 6b5f 6865 6967 6874 203e 203f 2920  ock_height > ?) 
-00003890: 4f52 4445 5220 4259 2062 6c6f 636b 5f68  ORDER BY block_h
-000038a0: 6569 6768 743b 272c 0a20 2020 2020 2020  eight;',.       
-000038b0: 2028 0a20 2020 2020 2020 2020 2020 2064   (.            d
-000038c0: 6570 7468 5f73 7065 6369 6669 632c 0a20  epth_specific,. 
-000038d0: 2020 2020 2020 2020 2020 202d 6465 7074             -dept
-000038e0: 685f 7370 6563 6966 6963 2c0a 2020 2020  h_specific,.    
-000038f0: 2020 2020 292c 0a20 2020 2029 2020 2320      ),.    )  # 
-00003900: 6e65 7720 6164 6472 6573 7365 7320 7769  new addresses wi
-00003910: 6c6c 2062 6520 6967 6e6f 7265 6420 756e  ll be ignored un
-00003920: 7469 6c20 6465 7074 6820 7061 7373 6564  til depth passed
-00003930: 0a20 2020 2075 6e69 7175 655f 6164 6472  .    unique_addr
-00003940: 6573 7365 7373 203d 2068 7970 2e66 6574  essess = hyp.fet
-00003950: 6368 616c 6c28 290a 0a20 2020 2066 6f72  chall()..    for
-00003960: 2078 2069 6e20 7365 7428 756e 6971 7565   x in set(unique
-00003970: 5f61 6464 7265 7373 6573 7329 3a0a 2020  _addressess):.  
-00003980: 2020 2020 2020 6372 6564 6974 203d 2044        credit = D
-00003990: 6563 696d 616c 2827 3027 290a 2020 2020  ecimal('0').    
-000039a0: 2020 2020 666f 7220 656e 7472 7920 696e      for entry in
-000039b0: 2068 7970 2e65 7865 6375 7465 280a 2020   hyp.execute(.  
-000039c0: 2020 2020 2020 2020 2020 2753 454c 4543            'SELEC
-000039d0: 5420 616d 6f75 6e74 2c72 6577 6172 6420  T amount,reward 
-000039e0: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-000039f0: 7320 5748 4552 4520 7265 6369 7069 656e  s WHERE recipien
-00003a00: 7420 3d20 3f20 414e 4420 2862 6c6f 636b  t = ? AND (block
-00003a10: 5f68 6569 6768 7420 3c20 3f20 414e 4420  _height < ? AND 
-00003a20: 626c 6f63 6b5f 6865 6967 6874 203e 203f  block_height > ?
-00003a30: 293b 272c 0a20 2020 2020 2020 2020 2020  );',.           
-00003a40: 2028 785b 305d 2c20 2920 2b20 280a 2020   (x[0], ) + (.  
-00003a50: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00003a60: 7074 685f 7370 6563 6966 6963 2c0a 2020  pth_specific,.  
-00003a70: 2020 2020 2020 2020 2020 2020 2020 2d64                -d
-00003a80: 6570 7468 5f73 7065 6369 6669 632c 0a20  epth_specific,. 
-00003a90: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00003aa0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00003ab0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00003ac0: 2020 2020 2020 2020 2020 6372 6564 6974            credit
-00003ad0: 203d 2071 7561 6e74 697a 655f 6569 6768   = quantize_eigh
-00003ae0: 7428 6372 6564 6974 2920 2b20 7175 616e  t(credit) + quan
-00003af0: 7469 7a65 5f65 6967 6874 2865 6e74 7279  tize_eight(entry
-00003b00: 5b30 5d29 202b 2071 7561 6e74 697a 655f  [0]) + quantize_
-00003b10: 6569 6768 7428 656e 7472 795b 315d 290a  eight(entry[1]).
-00003b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b30: 6372 6564 6974 203d 2030 2069 6620 6372  credit = 0 if cr
-00003b40: 6564 6974 2069 7320 4e6f 6e65 2065 6c73  edit is None els
-00003b50: 6520 6372 6564 6974 0a20 2020 2020 2020  e credit.       
-00003b60: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00003b70: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-00003b80: 2020 2020 2020 2063 7265 6469 7420 3d20         credit = 
-00003b90: 300a 0a20 2020 2020 2020 2064 6562 6974  0..        debit
-00003ba0: 203d 2044 6563 696d 616c 2827 3027 290a   = Decimal('0').
-00003bb0: 2020 2020 2020 2020 666f 7220 656e 7472          for entr
-00003bc0: 7920 696e 2068 7970 2e65 7865 6375 7465  y in hyp.execute
-00003bd0: 280a 2020 2020 2020 2020 2020 2020 2753  (.            'S
-00003be0: 454c 4543 5420 616d 6f75 6e74 2c66 6565  ELECT amount,fee
-00003bf0: 2046 524f 4d20 7472 616e 7361 6374 696f   FROM transactio
-00003c00: 6e73 2057 4845 5245 2061 6464 7265 7373  ns WHERE address
-00003c10: 203d 203f 2041 4e44 2028 626c 6f63 6b5f   = ? AND (block_
-00003c20: 6865 6967 6874 203c 203f 2041 4e44 2062  height < ? AND b
-00003c30: 6c6f 636b 5f68 6569 6768 7420 3e20 3f29  lock_height > ?)
-00003c40: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
-00003c50: 2878 5b30 5d2c 2029 202b 2028 0a20 2020  (x[0], ) + (.   
-00003c60: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00003c70: 7468 5f73 7065 6369 6669 632c 0a20 2020  th_specific,.   
-00003c80: 2020 2020 2020 2020 2020 2020 202d 6465               -de
-00003c90: 7074 685f 7370 6563 6966 6963 2c0a 2020  pth_specific,.  
-00003ca0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00003cb0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00003cc0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00003cd0: 2020 2020 2020 2020 2064 6562 6974 203d           debit =
-00003ce0: 2071 7561 6e74 697a 655f 6569 6768 7428   quantize_eight(
-00003cf0: 6465 6269 7429 202b 2071 7561 6e74 697a  debit) + quantiz
-00003d00: 655f 6569 6768 7428 656e 7472 795b 305d  e_eight(entry[0]
-00003d10: 2920 2b20 7175 616e 7469 7a65 5f65 6967  ) + quantize_eig
-00003d20: 6874 2865 6e74 7279 5b31 5d29 0a20 2020  ht(entry[1]).   
-00003d30: 2020 2020 2020 2020 2020 2020 2064 6562               deb
-00003d40: 6974 203d 2030 2069 6620 6465 6269 7420  it = 0 if debit 
-00003d50: 6973 204e 6f6e 6520 656c 7365 2064 6562  is None else deb
-00003d60: 6974 0a20 2020 2020 2020 2020 2020 2065  it.            e
-00003d70: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00003d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003d90: 2064 6562 6974 203d 2030 0a0a 2020 2020   debit = 0..    
-00003da0: 2020 2020 656e 645f 6261 6c61 6e63 6520      end_balance 
-00003db0: 3d20 7175 616e 7469 7a65 5f65 6967 6874  = quantize_eight
-00003dc0: 2863 7265 6469 7420 2d20 6465 6269 7429  (credit - debit)
-00003dd0: 0a0a 2020 2020 2020 2020 6966 2065 6e64  ..        if end
-00003de0: 5f62 616c 616e 6365 203e 2030 3a0a 2020  _balance > 0:.  
-00003df0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
-00003e00: 616d 7020 3d20 7374 7228 7469 6d65 2e74  amp = str(time.t
-00003e10: 696d 6528 2929 0a20 2020 2020 2020 2020  ime()).         
-00003e20: 2020 2068 7970 2e65 7865 6375 7465 2827     hyp.execute('
-00003e30: 494e 5345 5254 2049 4e54 4f20 7472 616e  INSERT INTO tran
-00003e40: 7361 6374 696f 6e73 2056 414c 5545 5320  sactions VALUES 
-00003e50: 283f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f  (?,?,?,?,?,?,?,?
-00003e60: 2c3f 2c3f 2c3f 2c3f 2927 2c20 2864 6570  ,?,?,?,?)', (dep
-00003e70: 7468 5f73 7065 6369 6669 6320 2d20 312c  th_specific - 1,
-00003e80: 2074 696d 6573 7461 6d70 2c20 2748 7970   timestamp, 'Hyp
-00003e90: 6572 626c 6f63 6b27 2c20 785b 305d 2c20  erblock', x[0], 
-00003ea0: 7374 7228 656e 645f 6261 6c61 6e63 6529  str(end_balance)
-00003eb0: 2c20 2730 272c 2027 3027 2c20 2730 272c  , '0', '0', '0',
-00003ec0: 2027 3027 2c20 2730 272c 2027 3027 2c20   '0', '0', '0', 
-00003ed0: 2730 2729 290a 2020 2020 6879 7065 722e  '0')).    hyper.
-00003ee0: 636f 6d6d 6974 2829 0a0a 2020 2020 6879  commit()..    hy
-00003ef0: 702e 6578 6563 7574 6528 2244 454c 4554  p.execute("DELET
-00003f00: 4520 4652 4f4d 2074 7261 6e73 6163 7469  E FROM transacti
-00003f10: 6f6e 7320 5748 4552 4520 6164 6472 6573  ons WHERE addres
-00003f20: 7320 213d 2027 4879 7065 7262 6c6f 636b  s != 'Hyperblock
-00003f30: 2720 414e 4420 2862 6c6f 636b 5f68 6569  ' AND (block_hei
-00003f40: 6768 7420 3c20 3f20 414e 4420 626c 6f63  ght < ? AND bloc
-00003f50: 6b5f 6865 6967 6874 203e 203f 293b 222c  k_height > ?);",
-00003f60: 2028 0a20 2020 2020 2020 2064 6570 7468   (.        depth
-00003f70: 5f73 7065 6369 6669 632c 0a20 2020 2020  _specific,.     
-00003f80: 2020 202d 6465 7074 685f 7370 6563 6966     -depth_specif
-00003f90: 6963 2c0a 2020 2020 2929 0a20 2020 2068  ic,.    )).    h
-00003fa0: 7970 6572 2e63 6f6d 6d69 7428 290a 0a20  yper.commit().. 
-00003fb0: 2020 2068 7970 2e65 7865 6375 7465 280a     hyp.execute(.
-00003fc0: 2020 2020 2020 2020 2744 454c 4554 4520          'DELETE 
-00003fd0: 4652 4f4d 206d 6973 6320 5748 4552 4520  FROM misc WHERE 
-00003fe0: 2862 6c6f 636b 5f68 6569 6768 7420 3c20  (block_height < 
-00003ff0: 3f20 414e 4420 626c 6f63 6b5f 6865 6967  ? AND block_heig
-00004000: 6874 203e 203f 293b 272c 0a20 2020 2020  ht > ?);',.     
-00004010: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00004020: 2064 6570 7468 5f73 7065 6369 6669 632c   depth_specific,
-00004030: 0a20 2020 2020 2020 2020 2020 202d 6465  .            -de
-00004040: 7074 685f 7370 6563 6966 6963 2c0a 2020  pth_specific,.  
-00004050: 2020 2020 2020 292c 0a20 2020 2029 2020        ),.    )  
-00004060: 2320 7265 6d6f 7665 2064 6966 6620 6361  # remove diff ca
-00004070: 6c63 0a20 2020 2068 7970 6572 2e63 6f6d  lc.    hyper.com
-00004080: 6d69 7428 290a 0a20 2020 2068 7970 2e65  mit()..    hyp.e
-00004090: 7865 6375 7465 2827 5641 4355 554d 2729  xecute('VACUUM')
-000040a0: 0a20 2020 2068 7970 6572 2e63 6c6f 7365  .    hyper.close
-000040b0: 2829 0a0a 2020 2020 6966 206f 732e 7061  ()..    if os.pa
-000040c0: 7468 2e65 7869 7374 7328 6e6f 6465 2e68  th.exists(node.h
-000040d0: 7970 6572 5f70 6174 6829 3a0a 2020 2020  yper_path):.    
-000040e0: 2020 2020 6f73 2e72 656d 6f76 6528 6e6f      os.remove(no
-000040f0: 6465 2e68 7970 6572 5f70 6174 6829 2020  de.hyper_path)  
-00004100: 2320 7265 6d6f 7665 2074 6865 206f 6c64  # remove the old
-00004110: 2068 7970 6572 626c 6f63 6b73 2074 6f20   hyperblocks to 
-00004120: 7265 6275 696c 640a 2020 2020 2020 2020  rebuild.        
-00004130: 6f73 2e72 656e 616d 6528 6e6f 6465 2e6c  os.rename(node.l
-00004140: 6564 6765 725f 7061 7468 202b 2027 2e74  edger_path + '.t
-00004150: 656d 7027 2c20 6e6f 6465 2e68 7970 6572  emp', node.hyper
-00004160: 5f70 6174 6829 0a0a 0a64 6566 206c 6564  _path)...def led
-00004170: 6765 725f 6368 6563 6b5f 6865 6967 6874  ger_check_height
-00004180: 7328 6e6f 6465 2c20 6462 5f68 616e 646c  s(node, db_handl
-00004190: 6572 293a 0a20 2020 2023 2054 4f44 4f3a  er):.    # TODO:
-000041a0: 2043 616e 6469 6461 7465 2066 6f72 2073   Candidate for s
-000041b0: 696e 676c 6520 7573 6572 206d 6f64 650a  ingle user mode.
-000041c0: 2020 2020 2222 2263 6f6e 7665 7273 696f      """conversio
-000041d0: 6e20 6f66 206e 6f72 6d61 6c20 626c 6f63  n of normal bloc
-000041e0: 6b73 2069 6e74 6f20 6879 7065 7262 6c6f  ks into hyperblo
-000041f0: 636b 7320 6672 6f6d 206c 6564 6765 722e  cks from ledger.
-00004200: 6462 206f 7220 6879 7065 722e 6462 2074  db or hyper.db t
-00004210: 6f20 6879 7065 722e 6462 2222 220a 2020  o hyper.db""".  
-00004220: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
-00004230: 7374 7328 6e6f 6465 2e68 7970 6572 5f70  sts(node.hyper_p
-00004240: 6174 6829 3a0a 0a20 2020 2020 2020 2023  ath):..        #
-00004250: 2063 726f 7373 2d69 6e74 6567 7269 7479   cross-integrity
-00004260: 2063 6865 636b 0a20 2020 2020 2020 2068   check.        h
-00004270: 6464 5f62 6c6f 636b 5f6d 6178 203d 2064  dd_block_max = d
-00004280: 625f 6861 6e64 6c65 722e 626c 6f63 6b5f  b_handler.block_
-00004290: 6865 6967 6874 5f6d 6178 2829 0a20 2020  height_max().   
-000042a0: 2020 2020 2068 6464 5f62 6c6f 636b 5f6d       hdd_block_m
-000042b0: 6178 5f64 6966 6620 3d20 6462 5f68 616e  ax_diff = db_han
-000042c0: 646c 6572 2e62 6c6f 636b 5f68 6569 6768  dler.block_heigh
-000042d0: 745f 6d61 785f 6469 6666 2829 0a20 2020  t_max_diff().   
-000042e0: 2020 2020 2068 6464 325f 626c 6f63 6b5f       hdd2_block_
-000042f0: 6c61 7374 203d 2064 625f 6861 6e64 6c65  last = db_handle
-00004300: 722e 626c 6f63 6b5f 6865 6967 6874 5f6d  r.block_height_m
-00004310: 6178 5f68 7970 6572 2829 0a20 2020 2020  ax_hyper().     
-00004320: 2020 2068 6464 325f 626c 6f63 6b5f 6c61     hdd2_block_la
-00004330: 7374 5f6d 6973 6320 3d20 6462 5f68 616e  st_misc = db_han
-00004340: 646c 6572 2e62 6c6f 636b 5f68 6569 6768  dler.block_heigh
-00004350: 745f 6d61 785f 6469 6666 5f68 7970 6572  t_max_diff_hyper
-00004360: 2829 0a0a 2020 2020 2020 2020 2320 6372  ()..        # cr
-00004370: 6f73 732d 696e 7465 6772 6974 7920 6368  oss-integrity ch
-00004380: 6563 6b0a 2020 2020 2020 2020 6966 2068  eck.        if h
-00004390: 6464 5f62 6c6f 636b 5f6d 6178 203d 3d20  dd_block_max == 
-000043a0: 6864 6432 5f62 6c6f 636b 5f6c 6173 7420  hdd2_block_last 
-000043b0: 3d3d 2068 6464 325f 626c 6f63 6b5f 6c61  == hdd2_block_la
-000043c0: 7374 5f6d 6973 6320 3d3d 2068 6464 5f62  st_misc == hdd_b
-000043d0: 6c6f 636b 5f6d 6178 5f64 6966 6620 616e  lock_max_diff an
-000043e0: 6420 6e6f 6465 2e68 7970 6572 5f72 6563  d node.hyper_rec
-000043f0: 6f6d 7072 6573 733a 2020 2320 6372 6f73  ompress:  # cros
-00004400: 732d 696e 7465 6772 6974 7920 6368 6563  s-integrity chec
-00004410: 6b0a 2020 2020 2020 2020 2020 2020 6e6f  k.            no
-00004420: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00004430: 672e 7761 726e 696e 6728 2753 7461 7475  g.warning('Statu
-00004440: 733a 2052 6563 6f6d 7072 6573 7369 6e67  s: Recompressing
-00004450: 2068 7970 6572 626c 6f63 6b73 2028 6b65   hyperblocks (ke
-00004460: 6570 696e 6720 6675 6c6c 206c 6564 6765  eping full ledge
-00004470: 7229 2729 0a20 2020 2020 2020 2020 2020  r)').           
-00004480: 206e 6f64 652e 7265 636f 6d70 7265 7373   node.recompress
-00004490: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-000044a0: 2020 2020 2023 7072 696e 7420 2868 6464       #print (hdd
-000044b0: 5f62 6c6f 636b 5f6d 6178 2c68 6464 325f  _block_max,hdd2_
-000044c0: 626c 6f63 6b5f 6c61 7374 2c6e 6f64 652e  block_last,node.
-000044d0: 6879 7065 725f 7265 636f 6d70 7265 7373  hyper_recompress
-000044e0: 290a 2020 2020 2020 2020 656c 6966 2068  ).        elif h
-000044f0: 6464 5f62 6c6f 636b 5f6d 6178 203d 3d20  dd_block_max == 
-00004500: 6864 6432 5f62 6c6f 636b 5f6c 6173 7420  hdd2_block_last 
-00004510: 616e 6420 6e6f 7420 6e6f 6465 2e68 7970  and not node.hyp
-00004520: 6572 5f72 6563 6f6d 7072 6573 733a 0a20  er_recompress:. 
-00004530: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-00004540: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-00004550: 6172 6e69 6e67 2827 5374 6174 7573 3a20  arning('Status: 
-00004560: 4879 7065 7262 6c6f 636b 2072 6563 6f6d  Hyperblock recom
-00004570: 7072 6573 7369 6f6e 2073 6b69 7070 6564  pression skipped
-00004580: 2729 0a20 2020 2020 2020 2020 2020 206e  ').            n
-00004590: 6f64 652e 7265 636f 6d70 7265 7373 203d  ode.recompress =
-000045a0: 2046 616c 7365 0a20 2020 2020 2020 2065   False.        e
-000045b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000045c0: 206c 6f77 6573 745f 626c 6f63 6b20 3d20   lowest_block = 
-000045d0: 6d69 6e28 6864 645f 626c 6f63 6b5f 6d61  min(hdd_block_ma
-000045e0: 782c 2068 6464 325f 626c 6f63 6b5f 6c61  x, hdd2_block_la
-000045f0: 7374 2c20 6864 645f 626c 6f63 6b5f 6d61  st, hdd_block_ma
-00004600: 785f 6469 6666 2c20 6864 6432 5f62 6c6f  x_diff, hdd2_blo
-00004610: 636b 5f6c 6173 745f 6d69 7363 290a 2020  ck_last_misc).  
-00004620: 2020 2020 2020 2020 2020 6869 6768 6573            highes
-00004630: 745f 626c 6f63 6b20 3d20 6d61 7828 6864  t_block = max(hd
-00004640: 645f 626c 6f63 6b5f 6d61 782c 2068 6464  d_block_max, hdd
-00004650: 325f 626c 6f63 6b5f 6c61 7374 2c20 6864  2_block_last, hd
-00004660: 645f 626c 6f63 6b5f 6d61 785f 6469 6666  d_block_max_diff
-00004670: 2c20 6864 6432 5f62 6c6f 636b 5f6c 6173  , hdd2_block_las
-00004680: 745f 6d69 7363 290a 0a20 2020 2020 2020  t_misc)..       
-00004690: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-000046a0: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
-000046b0: 2866 2753 7461 7475 733a 2043 726f 7373  (f'Status: Cross
-000046c0: 2d69 6e74 6567 7269 7479 2063 6865 636b  -integrity check
-000046d0: 2066 6169 6c65 642c 207b 6869 6768 6573   failed, {highes
-000046e0: 745f 626c 6f63 6b7d 2077 696c 6c20 6265  t_block} will be
-000046f0: 2072 6f6c 6c65 6420 6261 636b 2062 656c   rolled back bel
-00004700: 6f77 207b 6c6f 7765 7374 5f62 6c6f 636b  ow {lowest_block
-00004710: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
-00004720: 2072 6f6c 6c62 6163 6b28 6e6f 6465 2c20   rollback(node, 
-00004730: 6462 5f68 616e 646c 6572 5f69 6e69 7469  db_handler_initi
-00004740: 616c 2c20 6c6f 7765 7374 5f62 6c6f 636b  al, lowest_block
-00004750: 2920 2023 726f 6c6c 6261 636b 2074 6f20  )  #rollback to 
-00004760: 7468 6520 6c6f 7765 7374 2076 616c 7565  the lowest value
-00004770: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00004780: 652e 7265 636f 6d70 7265 7373 203d 2046  e.recompress = F
-00004790: 616c 7365 0a0a 2020 2020 656c 7365 3a0a  alse..    else:.
-000047a0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-000047b0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-000047c0: 696e 6728 2753 7461 7475 733a 2043 6f6d  ing('Status: Com
-000047d0: 7072 6573 7369 6e67 206c 6564 6765 7220  pressing ledger 
-000047e0: 746f 2048 7970 6572 626c 6f63 6b73 2729  to Hyperblocks')
-000047f0: 0a20 2020 2020 2020 206e 6f64 652e 7265  .        node.re
-00004800: 636f 6d70 7265 7373 203d 2054 7275 650a  compress = True.
-00004810: 0a0a 6465 6620 6269 6e5f 636f 6e76 6572  ..def bin_conver
-00004820: 7428 7374 7269 6e67 293a 0a20 2020 2023  t(string):.    #
-00004830: 2054 4f44 4f3a 204d 6f76 6520 746f 2065   TODO: Move to e
-00004840: 7373 656e 7469 616c 732e 7079 0a20 2020  ssentials.py.   
-00004850: 2072 6574 7572 6e20 2727 2e6a 6f69 6e28   return ''.join(
-00004860: 666f 726d 6174 286f 7264 2878 292c 2027  format(ord(x), '
-00004870: 3862 2729 2e72 6570 6c61 6365 2827 2027  8b').replace(' '
-00004880: 2c20 2730 2729 2066 6f72 2078 2069 6e20  , '0') for x in 
-00004890: 7374 7269 6e67 290a 0a0a 6465 6620 6261  string)...def ba
-000048a0: 6c61 6e63 6567 6574 2862 616c 616e 6365  lanceget(balance
-000048b0: 5f61 6464 7265 7373 2c20 6462 5f68 616e  _address, db_han
-000048c0: 646c 6572 293a 0a20 2020 2023 2054 4f44  dler):.    # TOD
-000048d0: 4f3a 2054 6f20 6d6f 7665 2069 6e20 6462  O: To move in db
-000048e0: 5f68 616e 646c 6572 2c20 6361 6c6c 2062  _handler, call b
-000048f0: 7920 6462 5f68 616e 646c 6572 2e62 616c  y db_handler.bal
-00004900: 616e 6365 5f67 6574 2861 6464 7265 7373  ance_get(address
-00004910: 290a 2020 2020 2320 7665 7269 6679 2062  ).    # verify b
-00004920: 616c 616e 6365 0a0a 2020 2020 2320 6e6f  alance..    # no
-00004930: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00004940: 672e 696e 666f 2822 4d65 6d70 6f6f 6c3a  g.info("Mempool:
-00004950: 2056 6572 6966 7969 6e67 2062 616c 616e   Verifying balan
-00004960: 6365 2229 0a20 2020 2023 206e 6f64 652e  ce").    # node.
-00004970: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-00004980: 6e66 6f28 224d 656d 706f 6f6c 3a20 5265  nfo("Mempool: Re
-00004990: 6365 6976 6564 2061 6464 7265 7373 3a20  ceived address: 
-000049a0: 2220 2b20 7374 7228 6261 6c61 6e63 655f  " + str(balance_
-000049b0: 6164 6472 6573 7329 290a 0a20 2020 2062  address))..    b
-000049c0: 6173 655f 6d65 6d70 6f6f 6c20 3d20 6d70  ase_mempool = mp
-000049d0: 2e4d 454d 504f 4f4c 2e6d 705f 6765 7428  .MEMPOOL.mp_get(
-000049e0: 6261 6c61 6e63 655f 6164 6472 6573 7329  balance_address)
-000049f0: 0a0a 2020 2020 2320 696e 636c 7564 6520  ..    # include 
-00004a00: 6d65 6d70 6f6f 6c20 6665 6573 0a0a 2020  mempool fees..  
-00004a10: 2020 6465 6269 745f 6d65 6d70 6f6f 6c20    debit_mempool 
-00004a20: 3d20 300a 2020 2020 6966 2062 6173 655f  = 0.    if base_
-00004a30: 6d65 6d70 6f6f 6c3a 0a20 2020 2020 2020  mempool:.       
-00004a40: 2066 6f72 2078 2069 6e20 6261 7365 5f6d   for x in base_m
-00004a50: 656d 706f 6f6c 3a0a 2020 2020 2020 2020  empool:.        
-00004a60: 2020 2020 6465 6269 745f 7478 203d 2044      debit_tx = D
-00004a70: 6563 696d 616c 2878 5b30 5d29 0a20 2020  ecimal(x[0]).   
-00004a80: 2020 2020 2020 2020 2066 6565 203d 2066           fee = f
-00004a90: 6565 5f63 616c 6375 6c61 7465 2878 5b31  ee_calculate(x[1
-00004aa0: 5d2c 2078 5b32 5d2c 206e 6f64 652e 6c61  ], x[2], node.la
-00004ab0: 7374 5f62 6c6f 636b 290a 2020 2020 2020  st_block).      
-00004ac0: 2020 2020 2020 6465 6269 745f 6d65 6d70        debit_memp
-00004ad0: 6f6f 6c20 3d20 7175 616e 7469 7a65 5f65  ool = quantize_e
-00004ae0: 6967 6874 2864 6562 6974 5f6d 656d 706f  ight(debit_mempo
-00004af0: 6f6c 202b 2064 6562 6974 5f74 7820 2b20  ol + debit_tx + 
-00004b00: 6665 6529 0a20 2020 2065 6c73 653a 0a20  fee).    else:. 
-00004b10: 2020 2020 2020 2064 6562 6974 5f6d 656d         debit_mem
-00004b20: 706f 6f6c 203d 2030 0a20 2020 2023 2069  pool = 0.    # i
-00004b30: 6e63 6c75 6465 206d 656d 706f 6f6c 2066  nclude mempool f
-00004b40: 6565 730a 0a20 2020 2063 7265 6469 745f  ees..    credit_
-00004b50: 6c65 6467 6572 203d 2044 6563 696d 616c  ledger = Decimal
-00004b60: 2827 3027 290a 0a20 2020 2074 7279 3a0a  ('0')..    try:.
-00004b70: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
-00004b80: 6572 2e65 7865 6375 7465 5f70 6172 616d  er.execute_param
-00004b90: 2864 625f 6861 6e64 6c65 722e 682c 2027  (db_handler.h, '
-00004ba0: 5345 4c45 4354 2061 6d6f 756e 7420 4652  SELECT amount FR
-00004bb0: 4f4d 2074 7261 6e73 6163 7469 6f6e 7320  OM transactions 
-00004bc0: 5748 4552 4520 7265 6369 7069 656e 7420  WHERE recipient 
-00004bd0: 3d20 3f3b 272c 2028 6261 6c61 6e63 655f  = ?;', (balance_
-00004be0: 6164 6472 6573 732c 2029 290a 2020 2020  address, )).    
-00004bf0: 2020 2020 656e 7472 6965 7320 3d20 6462      entries = db
-00004c00: 5f68 616e 646c 6572 2e68 2e66 6574 6368  _handler.h.fetch
-00004c10: 616c 6c28 290a 2020 2020 6578 6365 7074  all().    except
-00004c20: 3a0a 2020 2020 2020 2020 656e 7472 6965  :.        entrie
-00004c30: 7320 3d20 5b5d 0a0a 2020 2020 7472 793a  s = []..    try:
-00004c40: 0a20 2020 2020 2020 2066 6f72 2065 6e74  .        for ent
-00004c50: 7279 2069 6e20 656e 7472 6965 733a 0a20  ry in entries:. 
-00004c60: 2020 2020 2020 2020 2020 2063 7265 6469             credi
-00004c70: 745f 6c65 6467 6572 203d 2071 7561 6e74  t_ledger = quant
-00004c80: 697a 655f 6569 6768 7428 6372 6564 6974  ize_eight(credit
-00004c90: 5f6c 6564 6765 7229 202b 2071 7561 6e74  _ledger) + quant
-00004ca0: 697a 655f 6569 6768 7428 656e 7472 795b  ize_eight(entry[
-00004cb0: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
-00004cc0: 6372 6564 6974 5f6c 6564 6765 7220 3d20  credit_ledger = 
-00004cd0: 3020 6966 2063 7265 6469 745f 6c65 6467  0 if credit_ledg
-00004ce0: 6572 2069 7320 4e6f 6e65 2065 6c73 6520  er is None else 
-00004cf0: 6372 6564 6974 5f6c 6564 6765 720a 2020  credit_ledger.  
-00004d00: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00004d10: 2020 6372 6564 6974 5f6c 6564 6765 7220    credit_ledger 
-00004d20: 3d20 300a 0a20 2020 2066 6565 7320 3d20  = 0..    fees = 
-00004d30: 4465 6369 6d61 6c28 2730 2729 0a20 2020  Decimal('0').   
-00004d40: 2064 6562 6974 5f6c 6564 6765 7220 3d20   debit_ledger = 
-00004d50: 4465 6369 6d61 6c28 2730 2729 0a0a 2020  Decimal('0')..  
-00004d60: 2020 7472 793a 0a20 2020 2020 2020 2064    try:.        d
-00004d70: 625f 6861 6e64 6c65 722e 6578 6563 7574  b_handler.execut
-00004d80: 655f 7061 7261 6d28 6462 5f68 616e 646c  e_param(db_handl
-00004d90: 6572 2e68 2c20 2753 454c 4543 5420 6665  er.h, 'SELECT fe
-00004da0: 652c 2061 6d6f 756e 7420 4652 4f4d 2074  e, amount FROM t
-00004db0: 7261 6e73 6163 7469 6f6e 7320 5748 4552  ransactions WHER
-00004dc0: 4520 6164 6472 6573 7320 3d20 3f3b 272c  E address = ?;',
-00004dd0: 2028 6261 6c61 6e63 655f 6164 6472 6573   (balance_addres
-00004de0: 732c 2029 290a 2020 2020 2020 2020 656e  s, )).        en
-00004df0: 7472 6965 7320 3d20 6462 5f68 616e 646c  tries = db_handl
-00004e00: 6572 2e68 2e66 6574 6368 616c 6c28 290a  er.h.fetchall().
-00004e10: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-00004e20: 2020 2020 656e 7472 6965 7320 3d20 5b5d      entries = []
-00004e30: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00004e40: 2020 2066 6f72 2065 6e74 7279 2069 6e20     for entry in 
-00004e50: 656e 7472 6965 733a 0a20 2020 2020 2020  entries:.       
-00004e60: 2020 2020 2066 6565 7320 3d20 7175 616e       fees = quan
-00004e70: 7469 7a65 5f65 6967 6874 2866 6565 7329  tize_eight(fees)
-00004e80: 202b 2071 7561 6e74 697a 655f 6569 6768   + quantize_eigh
-00004e90: 7428 656e 7472 795b 305d 290a 2020 2020  t(entry[0]).    
-00004ea0: 2020 2020 2020 2020 6665 6573 203d 2030          fees = 0
-00004eb0: 2069 6620 6665 6573 2069 7320 4e6f 6e65   if fees is None
-00004ec0: 2065 6c73 6520 6665 6573 0a20 2020 2065   else fees.    e
-00004ed0: 7863 6570 743a 0a20 2020 2020 2020 2066  xcept:.        f
-00004ee0: 6565 7320 3d20 300a 0a20 2020 2074 7279  ees = 0..    try
-00004ef0: 3a0a 2020 2020 2020 2020 666f 7220 656e  :.        for en
-00004f00: 7472 7920 696e 2065 6e74 7269 6573 3a0a  try in entries:.
-00004f10: 2020 2020 2020 2020 2020 2020 6465 6269              debi
-00004f20: 745f 6c65 6467 6572 203d 2064 6562 6974  t_ledger = debit
-00004f30: 5f6c 6564 6765 7220 2b20 4465 6369 6d61  _ledger + Decima
-00004f40: 6c28 656e 7472 795b 315d 290a 2020 2020  l(entry[1]).    
-00004f50: 2020 2020 2020 2020 6465 6269 745f 6c65          debit_le
-00004f60: 6467 6572 203d 2030 2069 6620 6465 6269  dger = 0 if debi
-00004f70: 745f 6c65 6467 6572 2069 7320 4e6f 6e65  t_ledger is None
-00004f80: 2065 6c73 6520 6465 6269 745f 6c65 6467   else debit_ledg
-00004f90: 6572 0a20 2020 2065 7863 6570 743a 0a20  er.    except:. 
-00004fa0: 2020 2020 2020 2064 6562 6974 5f6c 6564         debit_led
-00004fb0: 6765 7220 3d20 300a 0a20 2020 2064 6562  ger = 0..    deb
-00004fc0: 6974 203d 2071 7561 6e74 697a 655f 6569  it = quantize_ei
-00004fd0: 6768 7428 6465 6269 745f 6c65 6467 6572  ght(debit_ledger
-00004fe0: 202b 2064 6562 6974 5f6d 656d 706f 6f6c   + debit_mempool
-00004ff0: 290a 0a20 2020 2072 6577 6172 6473 203d  )..    rewards =
-00005000: 2044 6563 696d 616c 2827 3027 290a 0a20   Decimal('0').. 
-00005010: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00005020: 6462 5f68 616e 646c 6572 2e65 7865 6375  db_handler.execu
-00005030: 7465 5f70 6172 616d 2864 625f 6861 6e64  te_param(db_hand
-00005040: 6c65 722e 682c 2027 5345 4c45 4354 2072  ler.h, 'SELECT r
-00005050: 6577 6172 6420 4652 4f4d 2074 7261 6e73  eward FROM trans
-00005060: 6163 7469 6f6e 7320 5748 4552 4520 7265  actions WHERE re
-00005070: 6369 7069 656e 7420 3d20 3f3b 272c 2028  cipient = ?;', (
-00005080: 6261 6c61 6e63 655f 6164 6472 6573 732c  balance_address,
-00005090: 2029 290a 2020 2020 2020 2020 656e 7472   )).        entr
-000050a0: 6965 7320 3d20 6462 5f68 616e 646c 6572  ies = db_handler
-000050b0: 2e68 2e66 6574 6368 616c 6c28 290a 2020  .h.fetchall().  
-000050c0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-000050d0: 2020 656e 7472 6965 7320 3d20 5b5d 0a0a    entries = []..
-000050e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000050f0: 2066 6f72 2065 6e74 7279 2069 6e20 656e   for entry in en
-00005100: 7472 6965 733a 0a20 2020 2020 2020 2020  tries:.         
-00005110: 2020 2072 6577 6172 6473 203d 2071 7561     rewards = qua
-00005120: 6e74 697a 655f 6569 6768 7428 7265 7761  ntize_eight(rewa
-00005130: 7264 7329 202b 2071 7561 6e74 697a 655f  rds) + quantize_
-00005140: 6569 6768 7428 656e 7472 795b 305d 290a  eight(entry[0]).
-00005150: 2020 2020 2020 2020 2020 2020 7265 7761              rewa
-00005160: 7264 7320 3d20 3020 6966 2073 7472 2872  rds = 0 if str(r
-00005170: 6577 6172 6473 2920 3d3d 2027 3045 2d38  ewards) == '0E-8
-00005180: 2720 656c 7365 2072 6577 6172 6473 0a20  ' else rewards. 
-00005190: 2020 2020 2020 2020 2020 2072 6577 6172             rewar
-000051a0: 6473 203d 2030 2069 6620 7265 7761 7264  ds = 0 if reward
-000051b0: 7320 6973 204e 6f6e 6520 656c 7365 2072  s is None else r
-000051c0: 6577 6172 6473 0a20 2020 2065 7863 6570  ewards.    excep
-000051d0: 743a 0a20 2020 2020 2020 2072 6577 6172  t:.        rewar
-000051e0: 6473 203d 2030 0a0a 2020 2020 6261 6c61  ds = 0..    bala
-000051f0: 6e63 6520 3d20 7175 616e 7469 7a65 5f65  nce = quantize_e
-00005200: 6967 6874 2863 7265 6469 745f 6c65 6467  ight(credit_ledg
-00005210: 6572 202d 2064 6562 6974 202d 2066 6565  er - debit - fee
-00005220: 7320 2b20 7265 7761 7264 7329 0a20 2020  s + rewards).   
-00005230: 2062 616c 616e 6365 5f6e 6f5f 6d65 6d70   balance_no_memp
-00005240: 6f6f 6c20 3d20 666c 6f61 7428 6372 6564  ool = float(cred
-00005250: 6974 5f6c 6564 6765 7229 202d 2066 6c6f  it_ledger) - flo
-00005260: 6174 2864 6562 6974 5f6c 6564 6765 7229  at(debit_ledger)
-00005270: 202d 2066 6c6f 6174 2866 6565 7329 202b   - float(fees) +
-00005280: 2066 6c6f 6174 2872 6577 6172 6473 290a   float(rewards).
-00005290: 2020 2020 2320 6e6f 6465 2e6c 6f67 6765      # node.logge
-000052a0: 722e 6170 705f 6c6f 672e 696e 666f 2822  r.app_log.info("
-000052b0: 4d65 6d70 6f6f 6c3a 2050 726f 6a65 6374  Mempool: Project
-000052c0: 6564 2074 7261 6e73 6374 696f 6e20 6164  ed transction ad
-000052d0: 6472 6573 7320 6261 6c61 6e63 653a 2022  dress balance: "
-000052e0: 202b 2073 7472 2862 616c 616e 6365 2929   + str(balance))
-000052f0: 0a20 2020 2072 6574 7572 6e20 7374 7228  .    return str(
-00005300: 6261 6c61 6e63 6529 2c20 7374 7228 6372  balance), str(cr
-00005310: 6564 6974 5f6c 6564 6765 7229 2c20 7374  edit_ledger), st
-00005320: 7228 6465 6269 7429 2c20 7374 7228 6665  r(debit), str(fe
-00005330: 6573 292c 2073 7472 2872 6577 6172 6473  es), str(rewards
-00005340: 292c 2073 7472 2862 616c 616e 6365 5f6e  ), str(balance_n
-00005350: 6f5f 6d65 6d70 6f6f 6c29 0a0a 0a64 6566  o_mempool)...def
-00005360: 2062 6c6f 636b 6e66 286e 6f64 652c 2062   blocknf(node, b
-00005370: 6c6f 636b 5f68 6173 685f 6465 6c65 7465  lock_hash_delete
-00005380: 2c20 7065 6572 5f69 702c 2064 625f 6861  , peer_ip, db_ha
-00005390: 6e64 6c65 722c 2068 7970 6572 626c 6f63  ndler, hyperbloc
-000053a0: 6b73 3d46 616c 7365 293a 0a20 2020 2022  ks=False):.    "
-000053b0: 2222 0a20 2020 2052 6f6c 6c73 2062 6163  "".    Rolls bac
-000053c0: 6b20 6120 7369 6e67 6c65 2062 6c6f 636b  k a single block
-000053d0: 2c20 7570 6461 7465 7320 6e6f 6465 206f  , updates node o
-000053e0: 626a 6563 7420 7661 7269 6162 6c65 732e  bject variables.
-000053f0: 0a20 2020 2052 6f6c 6c62 6163 6b20 7461  .    Rollback ta
-00005400: 7267 6574 206d 7573 7420 6265 2061 626f  rget must be abo
-00005410: 7665 2063 6865 636b 706f 696e 742e 0a20  ve checkpoint.. 
-00005420: 2020 2048 6173 6820 746f 2072 6f6c 6c62     Hash to rollb
-00005430: 6163 6b20 6d75 7374 206d 6174 6368 2069  ack must match i
-00005440: 6e20 6361 7365 206f 7572 206c 6564 6765  n case our ledge
-00005450: 7220 6d6f 7665 642e 0a20 2020 204e 6f74  r moved..    Not
-00005460: 2074 7275 7374 696e 6720 6879 7065 7262   trusting hyperb
-00005470: 6c6f 636b 206e 6f64 6573 2066 6f72 206f  lock nodes for o
-00005480: 6c64 2062 6c6f 636b 7320 6265 6361 7573  ld blocks becaus
-00005490: 6520 6f66 2074 7269 6d6d 696e 672c 0a20  e of trimming,. 
-000054a0: 2020 2074 6865 7920 776f 756c 646e 2774     they wouldn't
-000054b0: 2066 696e 6420 7468 6520 6861 7368 2061   find the hash a
-000054c0: 6e64 2063 6175 7365 2072 6f6c 6c62 6163  nd cause rollbac
-000054d0: 6b2e 0a20 2020 2022 2222 0a20 2020 206e  k..    """.    n
-000054e0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-000054f0: 6f67 2e69 6e66 6f28 6627 526f 6c6c 6261  og.info(f'Rollba
-00005500: 636b 206f 7065 7261 7469 6f6e 206f 6e20  ck operation on 
-00005510: 7b62 6c6f 636b 5f68 6173 685f 6465 6c65  {block_hash_dele
-00005520: 7465 7d20 696e 6974 6961 7465 6420 6279  te} initiated by
-00005530: 207b 7065 6572 5f69 707d 2729 0a0a 2020   {peer_ip}')..  
-00005540: 2020 6d79 5f74 696d 6520 3d20 7469 6d65    my_time = time
-00005550: 2e74 696d 6528 290a 0a20 2020 2069 6620  .time()..    if 
-00005560: 6e6f 7420 6e6f 6465 2e64 625f 6c6f 636b  not node.db_lock
-00005570: 2e6c 6f63 6b65 6428 293a 0a20 2020 2020  .locked():.     
-00005580: 2020 206e 6f64 652e 6462 5f6c 6f63 6b2e     node.db_lock.
-00005590: 6163 7175 6972 6528 290a 2020 2020 2020  acquire().      
-000055a0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-000055b0: 705f 6c6f 672e 7761 726e 696e 6728 6627  p_log.warning(f'
-000055c0: 4461 7461 6261 7365 206c 6f63 6b20 6163  Database lock ac
-000055d0: 7175 6972 6564 2729 0a20 2020 2020 2020  quired').       
-000055e0: 2062 6163 6b75 705f 6461 7461 203d 204e   backup_data = N
-000055f0: 6f6e 6520 2023 2075 7365 6420 696e 2022  one  # used in "
-00005600: 6669 6e61 6c6c 7922 2073 6563 7469 6f6e  finally" section
-00005610: 0a20 2020 2020 2020 2073 6b69 7020 3d20  .        skip = 
-00005620: 4661 6c73 650a 2020 2020 2020 2020 7265  False.        re
-00005630: 6173 6f6e 203d 2027 270a 0a20 2020 2020  ason = ''..     
-00005640: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00005650: 2020 2020 626c 6f63 6b5f 6d61 785f 7261      block_max_ra
-00005660: 6d20 3d20 6462 5f68 616e 646c 6572 2e62  m = db_handler.b
-00005670: 6c6f 636b 5f6d 6178 5f72 616d 2829 0a20  lock_max_ram(). 
-00005680: 2020 2020 2020 2020 2020 2064 625f 626c             db_bl
-00005690: 6f63 6b5f 6865 6967 6874 203d 2062 6c6f  ock_height = blo
-000056a0: 636b 5f6d 6178 5f72 616d 5b27 626c 6f63  ck_max_ram['bloc
-000056b0: 6b5f 6865 6967 6874 275d 0a20 2020 2020  k_height'].     
-000056c0: 2020 2020 2020 2064 625f 626c 6f63 6b5f         db_block_
-000056d0: 6861 7368 203d 2062 6c6f 636b 5f6d 6178  hash = block_max
-000056e0: 5f72 616d 5b27 626c 6f63 6b5f 6861 7368  _ram['block_hash
-000056f0: 275d 0a0a 2020 2020 2020 2020 2020 2020  ']..            
-00005700: 6970 203d 207b 2769 7027 3a20 7065 6572  ip = {'ip': peer
-00005710: 5f69 707d 0a20 2020 2020 2020 2020 2020  _ip}.           
-00005720: 206e 6f64 652e 706c 7567 696e 5f6d 616e   node.plugin_man
-00005730: 6167 6572 2e65 7865 6375 7465 5f66 696c  ager.execute_fil
-00005740: 7465 725f 686f 6f6b 2827 6669 6c74 6572  ter_hook('filter
-00005750: 5f72 6f6c 6c62 6163 6b5f 6970 272c 2069  _rollback_ip', i
-00005760: 7029 0a20 2020 2020 2020 2020 2020 2069  p).            i
-00005770: 6620 6970 5b27 6970 275d 203d 3d20 276e  f ip['ip'] == 'n
-00005780: 6f27 3a0a 2020 2020 2020 2020 2020 2020  o':.            
-00005790: 2020 2020 7265 6173 6f6e 203d 2027 4669      reason = 'Fi
-000057a0: 6c74 6572 2062 6c6f 636b 6564 2074 6869  lter blocked thi
-000057b0: 7320 726f 6c6c 6261 636b 270a 2020 2020  s rollback'.    
-000057c0: 2020 2020 2020 2020 2020 2020 736b 6970              skip
-000057d0: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-000057e0: 2020 2020 2065 6c69 6620 6462 5f62 6c6f       elif db_blo
-000057f0: 636b 5f68 6569 6768 7420 3c20 6e6f 6465  ck_height < node
-00005800: 2e63 6865 636b 706f 696e 743a 0a20 2020  .checkpoint:.   
-00005810: 2020 2020 2020 2020 2020 2020 2072 6561               rea
-00005820: 736f 6e20 3d20 2742 6c6f 636b 2069 7320  son = 'Block is 
-00005830: 7061 7374 2063 6865 636b 706f 696e 742c  past checkpoint,
-00005840: 2077 696c 6c20 6e6f 7420 6265 2072 6f6c   will not be rol
-00005850: 6c65 6420 6261 636b 270a 2020 2020 2020  led back'.      
-00005860: 2020 2020 2020 2020 2020 736b 6970 203d            skip =
-00005870: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-00005880: 2020 2065 6c69 6620 6462 5f62 6c6f 636b     elif db_block
-00005890: 5f68 6173 6820 213d 2062 6c6f 636b 5f68  _hash != block_h
-000058a0: 6173 685f 6465 6c65 7465 3a0a 2020 2020  ash_delete:.    
-000058b0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-000058c0: 696e 7420 6462 5f62 6c6f 636b 5f68 6173  int db_block_has
-000058d0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-000058e0: 2020 2320 7072 696e 7420 626c 6f63 6b5f    # print block_
-000058f0: 6861 7368 5f64 656c 6574 650a 2020 2020  hash_delete.    
-00005900: 2020 2020 2020 2020 2020 2020 7265 6173              reas
-00005910: 6f6e 203d 2027 5765 206d 6f76 6564 2061  on = 'We moved a
-00005920: 7761 7920 6672 6f6d 2074 6865 2062 6c6f  way from the blo
-00005930: 636b 2074 6f20 726f 6c6c 6261 636b 2c20  ck to rollback, 
-00005940: 736b 6970 7069 6e67 270a 2020 2020 2020  skipping'.      
-00005950: 2020 2020 2020 2020 2020 736b 6970 203d            skip =
-00005960: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-00005970: 2020 2065 6c69 6620 6879 7065 7262 6c6f     elif hyperblo
-00005980: 636b 7320 616e 6420 6e6f 6465 2e6c 6173  cks and node.las
-00005990: 745f 626c 6f63 6b5f 6167 6f20 3e20 3330  t_block_ago > 30
-000059a0: 3030 303a 2020 236d 6f72 6520 7468 616e  000:  #more than
-000059b0: 2035 3030 3020 6d69 6e75 7465 732f 7461   5000 minutes/ta
-000059c0: 7267 6574 2062 6c6f 636b 7320 6177 6179  rget blocks away
-000059d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000059e0: 2072 6561 736f 6e20 3d20 6627 7b70 6565   reason = f'{pee
-000059f0: 725f 6970 7d20 6973 2072 756e 6e69 6e67  r_ip} is running
-00005a00: 206f 6e20 6879 7065 7262 6c6f 636b 7320   on hyperblocks 
-00005a10: 616e 6420 6f75 7220 6c61 7374 2062 6c6f  and our last blo
-00005a20: 636b 2069 7320 746f 6f20 6f6c 642c 2073  ck is too old, s
-00005a30: 6b69 7070 696e 6727 0a20 2020 2020 2020  kipping'.       
-00005a40: 2020 2020 2020 2020 2073 6b69 7020 3d20           skip = 
-00005a50: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
-00005a60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005a70: 2020 2020 2020 2020 6261 636b 7570 5f64          backup_d
-00005a80: 6174 6120 3d20 6462 5f68 616e 646c 6572  ata = db_handler
-00005a90: 2e62 6163 6b75 705f 6869 6768 6572 2864  .backup_higher(d
-00005aa0: 625f 626c 6f63 6b5f 6865 6967 6874 290a  b_block_height).
-00005ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ac0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00005ad0: 5f6c 6f67 2e77 6172 6e69 6e67 2866 224e  _log.warning(f"N
-00005ae0: 6f64 6520 7b70 6565 725f 6970 7d20 6469  ode {peer_ip} di
-00005af0: 646e 2774 2066 696e 6420 626c 6f63 6b20  dn't find block 
-00005b00: 7b64 625f 626c 6f63 6b5f 6865 6967 6874  {db_block_height
-00005b10: 7d28 7b64 625f 626c 6f63 6b5f 6861 7368  }({db_block_hash
-00005b20: 7d29 2229 0a0a 2020 2020 2020 2020 2020  })")..          
-00005b30: 2020 2020 2020 2320 726f 6c6c 2062 6163        # roll bac
-00005b40: 6b20 6864 6420 746f 6f0a 2020 2020 2020  k hdd too.      
-00005b50: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
-00005b60: 646c 6572 2e72 6f6c 6c62 6163 6b5f 756e  dler.rollback_un
-00005b70: 6465 7228 6462 5f62 6c6f 636b 5f68 6569  der(db_block_hei
-00005b80: 6768 7429 0a20 2020 2020 2020 2020 2020  ght).           
-00005b90: 2020 2020 2023 202f 726f 6c6c 2062 6163       # /roll bac
-00005ba0: 6b20 6864 6420 746f 6f0a 0a20 2020 2020  k hdd too..     
-00005bb0: 2020 2020 2020 2020 2020 2023 2072 6f6c             # rol
-00005bc0: 6c62 6163 6b20 696e 6469 6365 730a 2020  lback indices.  
-00005bd0: 2020 2020 2020 2020 2020 2020 2020 6462                db
-00005be0: 5f68 616e 646c 6572 2e74 6f6b 656e 735f  _handler.tokens_
-00005bf0: 726f 6c6c 6261 636b 286e 6f64 652c 2064  rollback(node, d
-00005c00: 625f 626c 6f63 6b5f 6865 6967 6874 290a  b_block_height).
-00005c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c20: 6462 5f68 616e 646c 6572 2e61 6c69 6173  db_handler.alias
-00005c30: 6573 5f72 6f6c 6c62 6163 6b28 6e6f 6465  es_rollback(node
-00005c40: 2c20 6462 5f62 6c6f 636b 5f68 6569 6768  , db_block_heigh
-00005c50: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00005c60: 2020 2023 202f 726f 6c6c 6261 636b 2069     # /rollback i
-00005c70: 6e64 6963 6573 0a0a 2020 2020 2020 2020  ndices..        
-00005c80: 2020 2020 2020 2020 6e6f 6465 2e6c 6173          node.las
-00005c90: 745f 626c 6f63 6b5f 7469 6d65 7374 616d  t_block_timestam
-00005ca0: 7020 3d20 6462 5f68 616e 646c 6572 2e6c  p = db_handler.l
-00005cb0: 6173 745f 626c 6f63 6b5f 7469 6d65 7374  ast_block_timest
-00005cc0: 616d 7028 290a 2020 2020 2020 2020 2020  amp().          
-00005cd0: 2020 2020 2020 6e6f 6465 2e6c 6173 745f        node.last_
-00005ce0: 626c 6f63 6b5f 6861 7368 203d 2064 625f  block_hash = db_
-00005cf0: 6861 6e64 6c65 722e 6c61 7374 5f62 6c6f  handler.last_blo
-00005d00: 636b 5f68 6173 6828 290a 2020 2020 2020  ck_hash().      
-00005d10: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-00005d20: 6173 745f 626c 6f63 6b20 3d20 6462 5f62  ast_block = db_b
-00005d30: 6c6f 636b 5f68 6569 6768 7420 2d20 310a  lock_height - 1.
-00005d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d50: 6e6f 6465 2e68 6464 5f68 6173 6820 3d20  node.hdd_hash = 
-00005d60: 6462 5f68 616e 646c 6572 2e6c 6173 745f  db_handler.last_
-00005d70: 626c 6f63 6b5f 6861 7368 2829 0a20 2020  block_hash().   
-00005d80: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00005d90: 652e 6864 645f 626c 6f63 6b20 3d20 6462  e.hdd_block = db
-00005da0: 5f62 6c6f 636b 5f68 6569 6768 7420 2d20  _block_height - 
-00005db0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00005dc0: 2020 746f 6b65 6e73 2e74 6f6b 656e 735f    tokens.tokens_
-00005dd0: 7570 6461 7465 286e 6f64 652c 2064 625f  update(node, db_
-00005de0: 6861 6e64 6c65 7229 0a0a 2020 2020 2020  handler)..      
-00005df0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00005e00: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00005e10: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-00005e20: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
-00005e30: 2865 290a 0a20 2020 2020 2020 2066 696e  (e)..        fin
-00005e40: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
-00005e50: 2020 6e6f 6465 2e64 625f 6c6f 636b 2e72    node.db_lock.r
-00005e60: 656c 6561 7365 2829 0a0a 2020 2020 2020  elease()..      
-00005e70: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-00005e80: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
-00005e90: 6728 6627 4461 7461 6261 7365 206c 6f63  g(f'Database loc
-00005ea0: 6b20 7265 6c65 6173 6564 2729 0a0a 2020  k released')..  
-00005eb0: 2020 2020 2020 2020 2020 6966 2073 6b69            if ski
-00005ec0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-00005ed0: 2020 2072 6f6c 6c62 6163 6b20 3d20 7b27     rollback = {'
-00005ee0: 7469 6d65 7374 616d 7027 3a20 6d79 5f74  timestamp': my_t
-00005ef0: 696d 652c 2027 6865 6967 6874 273a 2064  ime, 'height': d
-00005f00: 625f 626c 6f63 6b5f 6865 6967 6874 2c20  b_block_height, 
-00005f10: 2769 7027 3a20 7065 6572 5f69 702c 2027  'ip': peer_ip, '
-00005f20: 6861 7368 273a 2064 625f 626c 6f63 6b5f  hash': db_block_
-00005f30: 6861 7368 2c20 2773 6b69 7070 6564 273a  hash, 'skipped':
-00005f40: 2054 7275 652c 2027 7265 6173 6f6e 273a   True, 'reason':
-00005f50: 2072 6561 736f 6e7d 0a20 2020 2020 2020   reason}.       
-00005f60: 2020 2020 2020 2020 206e 6f64 652e 706c           node.pl
-00005f70: 7567 696e 5f6d 616e 6167 6572 2e65 7865  ugin_manager.exe
-00005f80: 6375 7465 5f61 6374 696f 6e5f 686f 6f6b  cute_action_hook
-00005f90: 2827 726f 6c6c 6261 636b 272c 2072 6f6c  ('rollback', rol
-00005fa0: 6c62 6163 6b29 0a20 2020 2020 2020 2020  lback).         
-00005fb0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-00005fc0: 6572 2e61 7070 5f6c 6f67 2e69 6e66 6f28  er.app_log.info(
-00005fd0: 6627 536b 6970 7069 6e67 2072 6f6c 6c62  f'Skipping rollb
-00005fe0: 6163 6b3a 207b 7265 6173 6f6e 7d27 290a  ack: {reason}').
-00005ff0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00006000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006010: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00006020: 2020 2020 2020 2020 2020 206e 625f 7478             nb_tx
-00006030: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00006040: 2020 2020 2020 2020 2066 6f72 2074 7820           for tx 
-00006050: 696e 2062 6163 6b75 705f 6461 7461 3a0a  in backup_data:.
-00006060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006070: 2020 2020 2020 2020 7478 5f73 686f 7274          tx_short
-00006080: 203d 2066 277b 7478 5b31 5d7d 202d 207b   = f'{tx[1]} - {
-00006090: 7478 5b32 5d7d 2074 6f20 7b74 785b 335d  tx[2]} to {tx[3]
-000060a0: 7d3a 207b 7478 5b34 5d7d 2028 7b74 785b  }: {tx[4]} ({tx[
-000060b0: 3131 5d7d 2927 0a20 2020 2020 2020 2020  11]})'.         
-000060c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000060d0: 6620 7478 5b39 5d20 3d3d 2030 3a0a 2020  f tx[9] == 0:.  
-000060e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00006100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006110: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006120: 625f 7478 202b 3d20 310a 2020 2020 2020  b_tx += 1.      
-00006130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006140: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-00006150: 6f67 6765 722e 6170 705f 6c6f 672e 696e  ogger.app_log.in
-00006160: 666f 286d 702e 4d45 4d50 4f4f 4c2e 6d65  fo(mp.MEMPOOL.me
-00006170: 7267 6528 2874 785b 315d 2c20 7478 5b32  rge((tx[1], tx[2
-00006180: 5d2c 2074 785b 335d 2c20 7478 5b34 5d2c  ], tx[3], tx[4],
-00006190: 2074 785b 355d 2c20 7478 5b36 5d2c 2074   tx[5], tx[6], t
-000061a0: 785b 3130 5d2c 2074 785b 3131 5d29 2c20  x[10], tx[11]), 
-000061b0: 7065 6572 5f69 702c 2064 625f 6861 6e64  peer_ip, db_hand
-000061c0: 6c65 722e 632c 2046 616c 7365 2c20 7265  ler.c, False, re
-000061d0: 7665 7274 3d54 7275 6529 2920 2023 2077  vert=True))  # w
-000061e0: 696c 6c20 6765 7420 7374 7563 6b20 6966  ill get stuck if
-000061f0: 2079 6f75 2063 6861 6e67 6520 6974 2074   you change it t
-00006200: 6f20 7265 7370 6563 7420 6e6f 6465 2e64  o respect node.d
-00006210: 625f 6c6f 636b 0a20 2020 2020 2020 2020  b_lock.         
-00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006230: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-00006240: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-00006250: 6e67 2866 274d 6f76 6564 2074 7820 6261  ng(f'Moved tx ba
-00006260: 636b 2074 6f20 6d65 6d70 6f6f 6c3a 207b  ck to mempool: {
-00006270: 7478 5f73 686f 7274 7d27 290a 2020 2020  tx_short}').    
-00006280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006290: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-000062a0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000062b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000062d0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-000062e0: 6f67 2e77 6172 6e69 6e67 2866 2745 7272  og.warning(f'Err
-000062f0: 6f72 2064 7572 696e 6720 6d6f 7669 6e67  or during moving
-00006300: 2074 7820 6261 636b 2074 6f20 6d65 6d70   tx back to memp
-00006310: 6f6f 6c3a 207b 657d 2729 0a20 2020 2020  ool: {e}').     
-00006320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006330: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00000330: 3327 0a0a 696d 706f 7274 206f 730a 696d  3'..import os.im
+00000340: 706f 7274 2073 7973 0a69 6d70 6f72 7420  port sys.import 
+00000350: 7469 6d65 0a69 6d70 6f72 7420 6675 6e63  time.import func
+00000360: 746f 6f6c 730a 696d 706f 7274 2067 6c6f  tools.import glo
+00000370: 620a 696d 706f 7274 2070 6c61 7466 6f72  b.import platfor
+00000380: 6d0a 696d 706f 7274 2073 6875 7469 6c0a  m.import shutil.
+00000390: 696d 706f 7274 2073 6f63 6b65 7473 6572  import socketser
+000003a0: 7665 720a 696d 706f 7274 2073 716c 6974  ver.import sqlit
+000003b0: 6533 0a69 6d70 6f72 7420 7461 7266 696c  e3.import tarfil
+000003c0: 650a 696d 706f 7274 2074 6872 6561 6469  e.import threadi
+000003d0: 6e67 0a69 6d70 6f72 7420 6261 7365 3634  ng.import base64
+000003e0: 0a69 6d70 6f72 7420 6861 7368 6c69 620a  .import hashlib.
+000003f0: 696d 706f 7274 2074 7261 6365 6261 636b  import traceback
+00000400: 0a0a 6672 6f6d 2073 7973 2069 6d70 6f72  ..from sys impor
+00000410: 7420 7665 7273 696f 6e5f 696e 666f 0a66  t version_info.f
+00000420: 726f 6d20 6465 6369 6d61 6c20 696d 706f  rom decimal impo
+00000430: 7274 2044 6563 696d 616c 0a0a 696d 706f  rt Decimal..impo
+00000440: 7274 2061 6c69 6173 6573 2020 2320 5052  rt aliases  # PR
+00000450: 4546 4f52 4b5f 414c 4941 5345 530a 2320  EFORK_ALIASES.# 
+00000460: 696d 706f 7274 2061 6c69 6173 6573 7632  import aliasesv2
+00000470: 2061 7320 616c 6961 7365 7320 2320 504f   as aliases # PO
+00000480: 5354 464f 524b 5f41 4c49 4153 4553 0a23  STFORK_ALIASES.#
+00000490: 2042 6973 2073 7065 6369 6669 6320 6d6f   Bis specific mo
+000004a0: 6475 6c65 730a 696d 706f 7274 2061 7069  dules.import api
+000004b0: 6861 6e64 6c65 720a 696d 706f 7274 2063  handler.import c
+000004c0: 6f6e 6e65 6374 696f 6e6d 616e 6167 6572  onnectionmanager
+000004d0: 0a69 6d70 6f72 7420 6462 6861 6e64 6c65  .import dbhandle
+000004e0: 720a 696d 706f 7274 206c 6f67 0a69 6d70  r.import log.imp
+000004f0: 6f72 7420 6f70 7469 6f6e 730a 696d 706f  ort options.impo
+00000500: 7274 2070 6565 7273 6861 6e64 6c65 720a  rt peershandler.
+00000510: 696d 706f 7274 2070 6c75 6769 6e73 0a69  import plugins.i
+00000520: 6d70 6f72 7420 6573 7365 6e74 6961 6c73  mport essentials
+00000530: 0a69 6d70 6f72 7420 7761 6c6c 6574 5f6b  .import wallet_k
+00000540: 6579 730a 696d 706f 7274 2072 6567 6e65  eys.import regne
+00000550: 740a 696d 706f 7274 206d 696e 696e 675f  t.import mining_
+00000560: 6865 6176 7933 0a69 6d70 6f72 7420 6d65  heavy3.import me
+00000570: 6d70 6f6f 6c20 6173 206d 700a 696d 706f  mpool as mp.impo
+00000580: 7274 2074 6f6b 656e 7376 3220 6173 2074  rt tokensv2 as t
+00000590: 6f6b 656e 730a 0a66 726f 6d20 636f 6e6e  okens..from conn
+000005a0: 6563 7469 6f6e 7320 696d 706f 7274 2073  ections import s
+000005b0: 656e 642c 2072 6563 6569 7665 0a66 726f  end, receive.fro
+000005c0: 6d20 6469 6765 7374 2069 6d70 6f72 7420  m digest import 
+000005d0: 6469 6765 7374 5f62 6c6f 636b 0a66 726f  digest_block.fro
+000005e0: 6d20 6469 6666 6963 756c 7479 2069 6d70  m difficulty imp
+000005f0: 6f72 7420 6469 6666 6963 756c 7479 0a66  ort difficulty.f
+00000600: 726f 6d20 6c69 6273 2069 6d70 6f72 7420  rom libs import 
+00000610: 6e6f 6465 2061 7320 5f6e 6f64 652c 206c  node as _node, l
+00000620: 6f67 6765 722c 206b 6579 732c 2063 6c69  ogger, keys, cli
+00000630: 656e 740a 6672 6f6d 2066 6f72 6b20 696d  ent.from fork im
+00000640: 706f 7274 2046 6f72 6b0a 6672 6f6d 2071  port Fork.from q
+00000650: 7561 6e74 697a 6572 2069 6d70 6f72 7420  uantizer import 
+00000660: 7175 616e 7469 7a65 5f74 776f 2c20 7175  quantize_two, qu
+00000670: 616e 7469 7a65 5f65 6967 6874 0a66 726f  antize_eight.fro
+00000680: 6d20 706f 6c79 7369 676e 2e73 6967 6e65  m polysign.signe
+00000690: 7266 6163 746f 7279 2069 6d70 6f72 7420  rfactory import 
+000006a0: 5369 676e 6572 4661 6374 6f72 790a 0a23  SignerFactory..#
+000006b0: 2074 6f64 6f3a 206d 6967 7261 7465 2074   todo: migrate t
+000006c0: 6869 7320 746f 2070 6f6c 7973 6967 6e5c  his to polysign\
+000006d0: 7369 676e 6572 5f63 7277 2e70 790a 6672  signer_crw.py.fr
+000006e0: 6f6d 2043 7279 7074 6f64 6f6d 652e 4861  om Cryptodome.Ha
+000006f0: 7368 2069 6d70 6f72 7420 5348 410a 6672  sh import SHA.fr
+00000700: 6f6d 2043 7279 7074 6f64 6f6d 652e 5075  om Cryptodome.Pu
+00000710: 626c 6963 4b65 7920 696d 706f 7274 2052  blicKey import R
+00000720: 5341 0a66 726f 6d20 4372 7970 746f 646f  SA.from Cryptodo
+00000730: 6d65 2e53 6967 6e61 7475 7265 2069 6d70  me.Signature imp
+00000740: 6f72 7420 504b 4353 315f 7631 5f35 0a0a  ort PKCS1_v1_5..
+00000750: 2320 2f74 6f64 6f0a 0a66 6f72 6b20 3d20  # /todo..fork = 
+00000760: 466f 726b 2829 0a0a 6170 706e 616d 6520  Fork()..appname 
+00000770: 3d20 2742 6973 6d75 7468 270a 6170 7061  = 'Bismuth'.appa
+00000780: 7574 686f 7220 3d20 2742 6973 6d75 7468  uthor = 'Bismuth
+00000790: 2046 6f75 6e64 6174 696f 6e27 0a0a 6462   Foundation'..db
+000007a0: 5f68 616e 646c 6572 5f69 6e69 7469 616c  _handler_initial
+000007b0: 203d 204e 6f6e 650a 0a23 206e 6f64 6573   = None..# nodes
+000007c0: 5f62 616e 5f72 6573 6574 3d63 6f6e 6669  _ban_reset=confi
+000007d0: 672e 6e6f 6465 735f 6261 6e5f 7265 7365  g.nodes_ban_rese
+000007e0: 740a 0a0a 6465 6620 7371 6c5f 7472 6163  t...def sql_trac
+000007f0: 655f 6361 6c6c 6261 636b 286c 6f67 2c20  e_callback(log, 
+00000800: 6964 2c20 7374 6174 656d 656e 7429 3a0a  id, statement):.
+00000810: 2020 2020 6c69 6e65 203d 2066 2753 514c      line = f'SQL
+00000820: 5b7b 6964 7d5d 207b 7374 6174 656d 656e  [{id}] {statemen
+00000830: 747d 270a 2020 2020 6c6f 672e 7761 726e  t}'.    log.warn
+00000840: 696e 6728 6c69 6e65 290a 0a0a 6465 6620  ing(line)...def 
+00000850: 626f 6f74 7374 7261 7028 293a 0a20 2020  bootstrap():.   
+00000860: 2023 2054 4f44 4f3a 2043 616e 6469 6461   # TODO: Candida
+00000870: 7465 2066 6f72 2073 696e 676c 6520 7573  te for single us
+00000880: 6572 206d 6f64 650a 2020 2020 7472 793a  er mode.    try:
+00000890: 0a20 2020 2020 2020 2074 7970 6573 203d  .        types =
+000008a0: 205b 2773 7461 7469 632f 2a2e 6462 2d77   ['static/*.db-w
+000008b0: 616c 272c 2027 7374 6174 6963 2f2a 2e64  al', 'static/*.d
+000008c0: 622d 7368 6d27 5d0a 2020 2020 2020 2020  b-shm'].        
+000008d0: 666f 7220 7420 696e 2074 7970 6573 3a0a  for t in types:.
+000008e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000008f0: 6620 696e 2067 6c6f 622e 676c 6f62 2874  f in glob.glob(t
+00000900: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00000910: 2020 206f 732e 7265 6d6f 7665 2866 290a     os.remove(f).
+00000920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000930: 7072 696e 7428 662c 2027 6465 6c65 7465  print(f, 'delete
+00000940: 6427 290a 0a20 2020 2020 2020 2023 2061  d')..        # a
+00000950: 7263 6869 7665 5f70 6174 6820 3d20 6e6f  rchive_path = no
+00000960: 6465 2e6c 6564 6765 725f 7061 7468 202b  de.ledger_path +
+00000970: 2022 2e74 6172 2e67 7a22 0a20 2020 2020   ".tar.gz".     
+00000980: 2020 2023 2064 6f77 6e6c 6f61 645f 6669     # download_fi
+00000990: 6c65 2822 6874 7470 733a 2f2f 6269 736d  le("https://bism
+000009a0: 7574 682e 637a 2f6c 6564 6765 722e 7461  uth.cz/ledger.ta
+000009b0: 722e 677a 222c 2061 7263 6869 7665 5f70  r.gz", archive_p
+000009c0: 6174 6829 0a20 2020 2020 2020 2023 2077  ath).        # w
+000009d0: 6974 6820 7461 7266 696c 652e 6f70 656e  ith tarfile.open
+000009e0: 2861 7263 6869 7665 5f70 6174 6829 2061  (archive_path) a
+000009f0: 7320 7461 723a 0a20 2020 2020 2020 2023  s tar:.        #
+00000a00: 2020 2020 2074 6172 2e65 7874 7261 6374       tar.extract
+00000a10: 616c 6c28 2273 7461 7469 632f 2229 2020  all("static/")  
+00000a20: 2320 4e4f 5420 434f 4d50 4154 4942 4c45  # NOT COMPATIBLE
+00000a30: 2057 4954 4820 4355 5354 4f4d 2050 4154   WITH CUSTOM PAT
+00000a40: 4820 434f 4e46 530a 0a20 2020 2020 2020  H CONFS..       
+00000a50: 2049 4e49 5449 414c 5f44 4946 4649 4355   INITIAL_DIFFICU
+00000a60: 4c54 5920 3d20 3130 0a20 2020 2020 2020  LTY = 10.       
+00000a70: 2049 4e49 5449 414c 5f48 5950 4552 5f44   INITIAL_HYPER_D
+00000a80: 4946 4649 4355 4c54 5920 3d20 3130 0a0a  IFFICULTY = 10..
+00000a90: 2020 2020 2020 2020 6864 6420 3d20 7371          hdd = sq
+00000aa0: 6c69 7465 332e 636f 6e6e 6563 7428 2773  lite3.connect('s
+00000ab0: 7461 7469 632f 6c65 6467 6572 2e64 6227  tatic/ledger.db'
+00000ac0: 2c20 7469 6d65 6f75 743d 3129 0a20 2020  , timeout=1).   
+00000ad0: 2020 2020 2068 6464 2e74 6578 745f 6661       hdd.text_fa
+00000ae0: 6374 6f72 7920 3d20 7374 720a 2020 2020  ctory = str.    
+00000af0: 2020 2020 6864 642e 6578 6563 7574 6528      hdd.execute(
+00000b00: 2750 5241 474d 4120 6361 7365 5f73 656e  'PRAGMA case_sen
+00000b10: 7369 7469 7665 5f6c 696b 6520 3d20 313b  sitive_like = 1;
+00000b20: 2729 0a20 2020 2020 2020 2068 6464 5f63  ').        hdd_c
+00000b30: 7572 736f 7220 3d20 6864 642e 6375 7273  ursor = hdd.curs
+00000b40: 6f72 2829 0a20 2020 2020 2020 2068 6464  or().        hdd
+00000b50: 5f63 7572 736f 722e 6578 6563 7574 6528  _cursor.execute(
+00000b60: 2743 5245 4154 4520 5441 424c 4520 4946  'CREATE TABLE IF
+00000b70: 204e 4f54 2045 5849 5354 5320 226d 6973   NOT EXISTS "mis
+00000b80: 6322 2028 2262 6c6f 636b 5f68 6569 6768  c" ("block_heigh
+00000b90: 7422 2049 4e54 4547 4552 2c20 2264 6966  t" INTEGER, "dif
+00000ba0: 6669 6375 6c74 7922 2054 4558 5429 2729  ficulty" TEXT)')
+00000bb0: 0a20 2020 2020 2020 2068 6464 5f63 7572  .        hdd_cur
+00000bc0: 736f 722e 6578 6563 7574 6528 0a20 2020  sor.execute(.   
+00000bd0: 2020 2020 2020 2020 2027 4352 4541 5445           'CREATE
+00000be0: 2054 4142 4c45 2049 4620 4e4f 5420 4558   TABLE IF NOT EX
+00000bf0: 4953 5453 2022 7472 616e 7361 6374 696f  ISTS "transactio
+00000c00: 6e73 2220 2822 626c 6f63 6b5f 6865 6967  ns" ("block_heig
+00000c10: 6874 2220 494e 5445 4745 522c 2022 7469  ht" INTEGER, "ti
+00000c20: 6d65 7374 616d 7022 204e 554d 4552 4943  mestamp" NUMERIC
+00000c30: 2c20 2261 6464 7265 7373 2220 5445 5854  , "address" TEXT
+00000c40: 2c20 2272 6563 6970 6965 6e74 2220 5445  , "recipient" TE
+00000c50: 5854 2c20 2261 6d6f 756e 7422 204e 554d  XT, "amount" NUM
+00000c60: 4552 4943 2c20 2273 6967 6e61 7475 7265  ERIC, "signature
+00000c70: 2220 5445 5854 2c20 2270 7562 6c69 635f  " TEXT, "public_
+00000c80: 6b65 7922 2054 4558 542c 2022 626c 6f63  key" TEXT, "bloc
+00000c90: 6b5f 6861 7368 2220 5445 5854 2c20 2266  k_hash" TEXT, "f
+00000ca0: 6565 2220 4e55 4d45 5249 432c 2022 7265  ee" NUMERIC, "re
+00000cb0: 7761 7264 2220 4e55 4d45 5249 432c 2022  ward" NUMERIC, "
+00000cc0: 6f70 6572 6174 696f 6e22 2054 4558 542c  operation" TEXT,
+00000cd0: 2022 6f70 656e 6669 656c 6422 2054 4558   "openfield" TEX
+00000ce0: 5429 272c 0a20 2020 2020 2020 2029 0a20  T)',.        ). 
+00000cf0: 2020 2020 2020 2068 6464 5f63 7572 736f         hdd_curso
+00000d00: 722e 6578 6563 7574 6528 2743 5245 4154  r.execute('CREAT
+00000d10: 4520 494e 4445 5820 2254 696d 6573 7461  E INDEX "Timesta
+00000d20: 6d70 2049 6e64 6578 2220 4f4e 2022 7472  mp Index" ON "tr
+00000d30: 616e 7361 6374 696f 6e73 2220 2822 7469  ansactions" ("ti
+00000d40: 6d65 7374 616d 7022 2927 290a 2020 2020  mestamp")').    
+00000d50: 2020 2020 6864 645f 6375 7273 6f72 2e65      hdd_cursor.e
+00000d60: 7865 6375 7465 2827 4352 4541 5445 2049  xecute('CREATE I
+00000d70: 4e44 4558 2022 5369 676e 6174 7572 6520  NDEX "Signature 
+00000d80: 496e 6465 7822 204f 4e20 2274 7261 6e73  Index" ON "trans
+00000d90: 6163 7469 6f6e 7322 2028 2273 6967 6e61  actions" ("signa
+00000da0: 7475 7265 2229 2729 0a20 2020 2020 2020  ture")').       
+00000db0: 2068 6464 5f63 7572 736f 722e 6578 6563   hdd_cursor.exec
+00000dc0: 7574 6528 2743 5245 4154 4520 494e 4445  ute('CREATE INDE
+00000dd0: 5820 2252 6577 6172 6420 496e 6465 7822  X "Reward Index"
+00000de0: 204f 4e20 2274 7261 6e73 6163 7469 6f6e   ON "transaction
+00000df0: 7322 2028 2272 6577 6172 6422 2927 290a  s" ("reward")').
+00000e00: 2020 2020 2020 2020 6864 645f 6375 7273          hdd_curs
+00000e10: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
+00000e20: 5445 2049 4e44 4558 2022 5265 6369 7069  TE INDEX "Recipi
+00000e30: 656e 7420 496e 6465 7822 204f 4e20 2274  ent Index" ON "t
+00000e40: 7261 6e73 6163 7469 6f6e 7322 2028 2272  ransactions" ("r
+00000e50: 6563 6970 6965 6e74 2229 2729 0a20 2020  ecipient")').   
+00000e60: 2020 2020 2068 6464 5f63 7572 736f 722e       hdd_cursor.
+00000e70: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+00000e80: 494e 4445 5820 224f 7065 6e66 6965 6c64  INDEX "Openfield
+00000e90: 2049 6e64 6578 2220 4f4e 2022 7472 616e   Index" ON "tran
+00000ea0: 7361 6374 696f 6e73 2220 2822 6f70 656e  sactions" ("open
+00000eb0: 6669 656c 6422 2927 290a 2020 2020 2020  field")').      
+00000ec0: 2020 6864 645f 6375 7273 6f72 2e65 7865    hdd_cursor.exe
+00000ed0: 6375 7465 2827 4352 4541 5445 2049 4e44  cute('CREATE IND
+00000ee0: 4558 2022 4665 6520 496e 6465 7822 204f  EX "Fee Index" O
+00000ef0: 4e20 2274 7261 6e73 6163 7469 6f6e 7322  N "transactions"
+00000f00: 2028 2266 6565 2229 2729 0a20 2020 2020   ("fee")').     
+00000f10: 2020 2068 6464 5f63 7572 736f 722e 6578     hdd_cursor.ex
+00000f20: 6563 7574 6528 2743 5245 4154 4520 494e  ecute('CREATE IN
+00000f30: 4445 5820 2242 6c6f 636b 2048 6569 6768  DEX "Block Heigh
+00000f40: 7420 496e 6465 7822 204f 4e20 2274 7261  t Index" ON "tra
+00000f50: 6e73 6163 7469 6f6e 7322 2028 2262 6c6f  nsactions" ("blo
+00000f60: 636b 5f68 6569 6768 7422 2927 290a 2020  ck_height")').  
+00000f70: 2020 2020 2020 6864 645f 6375 7273 6f72        hdd_cursor
+00000f80: 2e65 7865 6375 7465 2827 4352 4541 5445  .execute('CREATE
+00000f90: 2049 4e44 4558 2022 426c 6f63 6b20 4861   INDEX "Block Ha
+00000fa0: 7368 2049 6e64 6578 2220 4f4e 2022 7472  sh Index" ON "tr
+00000fb0: 616e 7361 6374 696f 6e73 2220 2822 626c  ansactions" ("bl
+00000fc0: 6f63 6b5f 6861 7368 2229 2729 0a20 2020  ock_hash")').   
+00000fd0: 2020 2020 2068 6464 5f63 7572 736f 722e       hdd_cursor.
+00000fe0: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+00000ff0: 494e 4445 5820 2241 6d6f 756e 7420 496e  INDEX "Amount In
+00001000: 6465 7822 204f 4e20 2274 7261 6e73 6163  dex" ON "transac
+00001010: 7469 6f6e 7322 2028 2261 6d6f 756e 7422  tions" ("amount"
+00001020: 2927 290a 2020 2020 2020 2020 6864 645f  )').        hdd_
+00001030: 6375 7273 6f72 2e65 7865 6375 7465 2827  cursor.execute('
+00001040: 4352 4541 5445 2049 4e44 4558 2022 4164  CREATE INDEX "Ad
+00001050: 6472 6573 7320 496e 6465 7822 204f 4e20  dress Index" ON 
+00001060: 2274 7261 6e73 6163 7469 6f6e 7322 2028  "transactions" (
+00001070: 2261 6464 7265 7373 2229 2729 0a20 2020  "address")').   
+00001080: 2020 2020 2068 6464 5f63 7572 736f 722e       hdd_cursor.
+00001090: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+000010a0: 494e 4445 5820 224f 7065 7261 7469 6f6e  INDEX "Operation
+000010b0: 2049 6e64 6578 2220 4f4e 2022 7472 616e   Index" ON "tran
+000010c0: 7361 6374 696f 6e73 2220 2822 6f70 6572  sactions" ("oper
+000010d0: 6174 696f 6e22 2927 290a 2020 2020 2020  ation")').      
+000010e0: 2020 6864 645f 6375 7273 6f72 2e65 7865    hdd_cursor.exe
+000010f0: 6375 7465 2827 4352 4541 5445 2049 4e44  cute('CREATE IND
+00001100: 4558 2054 5849 4434 5f49 6e64 6578 204f  EX TXID4_Index O
+00001110: 4e20 7472 616e 7361 6374 696f 6e73 2873  N transactions(s
+00001120: 7562 7374 7228 7369 676e 6174 7572 652c  ubstr(signature,
+00001130: 312c 3429 2927 290a 2020 2020 2020 2020  1,4))').        
+00001140: 6864 645f 6375 7273 6f72 2e65 7865 6375  hdd_cursor.execu
+00001150: 7465 2827 4352 4541 5445 2049 4e44 4558  te('CREATE INDEX
+00001160: 2022 4d69 7363 2042 6c6f 636b 2048 6569   "Misc Block Hei
+00001170: 6768 7420 496e 6465 7822 206f 6e20 6d69  ght Index" on mi
+00001180: 7363 2862 6c6f 636b 5f68 6569 6768 7429  sc(block_height)
+00001190: 2729 0a20 2020 2020 2020 2068 6464 5f63  ').        hdd_c
+000011a0: 7572 736f 722e 6578 6563 7574 6528 2749  ursor.execute('I
+000011b0: 4e53 4552 5420 494e 544f 206d 6973 6320  NSERT INTO misc 
+000011c0: 2864 6966 6669 6375 6c74 792c 2062 6c6f  (difficulty, blo
+000011d0: 636b 5f68 6569 6768 7429 2056 414c 5545  ck_height) VALUE
+000011e0: 5320 287b 7d2c 3129 272e 666f 726d 6174  S ({},1)'.format
+000011f0: 2849 4e49 5449 414c 5f44 4946 4649 4355  (INITIAL_DIFFICU
+00001200: 4c54 5929 290a 2020 2020 2020 2020 6864  LTY)).        hd
+00001210: 645f 6375 7273 6f72 2e65 7865 6375 7465  d_cursor.execute
+00001220: 280a 2020 2020 2020 2020 2020 2020 2749  (.            'I
+00001230: 4e53 4552 5420 494e 544f 2074 7261 6e73  NSERT INTO trans
+00001240: 6163 7469 6f6e 7320 5641 4c55 4553 2028  actions VALUES (
+00001250: 3f2c 3f2c 3f2c 3f2c 3f2c 3f2c 3f2c 3f2c  ?,?,?,?,?,?,?,?,
+00001260: 3f2c 3f2c 3f2c 3f29 272c 2028 0a20 2020  ?,?,?,?)', (.   
+00001270: 2020 2020 2020 2020 2020 2020 2027 3127               '1'
+00001280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001290: 2020 2731 3636 3033 3836 3136 352e 3935    '1660386165.95
+000012a0: 3432 3527 2c0a 2020 2020 2020 2020 2020  425',.          
+000012b0: 2020 2020 2020 2767 656e 6573 6973 272c        'genesis',
+000012c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000012d0: 2027 3362 3963 6139 3961 3738 3034 3031   '3b9ca99a780401
+000012e0: 3566 3865 6165 6262 3738 6434 6235 3035  5f8eaebb78d4b505
+000012f0: 3730 6264 3833 3337 6538 6138 3139 3633  70bd8337e8a81963
+00001300: 3433 6462 6262 3539 6334 272c 0a20 2020  43dbbb59c4',.   
+00001310: 2020 2020 2020 2020 2020 2020 2027 3027               '0'
+00001320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001330: 2020 2751 5763 4866 3467 3949 4f79 2f58    'QWcHf4g9IOy/X
+00001340: 6770 2b6b 616b 6b6e 3953 6a6c 2f62 624d  gp+kakkn9Sjl/bbM
+00001350: 7663 7a38 3963 334c 4870 365a 2b44 6736  vcz89c3LHp6Z+Dg6
+00001360: 4178 5943 4c4f 3770 6c57 4d4a 304c 6968  AxYCLO7plWMJ0Lih
+00001370: 4345 4a50 4158 6b76 5239 6d66 5659 6e65  CEJPAXkvR9mfVYne
+00001380: 7875 7353 367a 4d49 3652 5054 5061 6f6a  xusS6zMI6RPTPaoj
+00001390: 6c72 7664 3159 472f 4e4a 4551 5063 444d  lrvd1YG/NJEQPcDM
+000013a0: 4854 3358 3268 4679 414b 3562 5442 336f  HT3X2hFyAK5bTB3o
+000013b0: 6c61 5356 6f6f 4966 2f38 4f66 5233 3254  laSVooIf/8OfR32T
+000013c0: 446f 7553 706d 324f 354c 6b64 4f57 5549  DouSpm2O5LkdOWUI
+000013d0: 4549 6738 6571 474b 3864 492b 7036 4576  EIg8eqGK8dI+p6Ev
+000013e0: 7651 6731 6745 436e 4e6f 4a4c 7964 4766  vQg1gECnNoJLydGf
+000013f0: 3675 3846 574c 4c65 2f55 6972 3662 3358  6u8FWLLe/Uir6b3X
+00001400: 3648 664f 6f59 5370 3265 5642 546b 6e38  6HfOoYSp2eVBTkn8
+00001410: 6a6a 4854 677a 2f7a 5349 424e 7338 6c61  jjHTgz/zSIBNs8la
+00001420: 504e 4c32 6e55 314a 4666 5171 472f 5850  PNL2nU1JFfQqG/XP
+00001430: 5748 6b57 7935 5734 4c78 5443 6a4e 5332  WHkWy5W4LxTCjNS2
+00001440: 6e34 6830 4b6a 4164 4664 7a65 434d 376d  n4h0KjAdFdzeCM7m
+00001450: 3372 5866 3745 3031 3442 656c 594c 5471  3rXf7E014BelYLTq
+00001460: 5945 305a 3033 382b 7a6d 6173 6c52 5172  YE0Z038+zmaslRQr
+00001470: 6f61 522b 434b 6642 7548 3367 6d2f 5477  oaR+CKfBuH3gm/Tw
+00001480: 4f57 6d38 4a69 396a 5465 4131 7847 736a  OWm8Ji9jTeA1xGsj
+00001490: 6b68 5754 7944 7974 7075 734d 7651 5259  khWTyDytpusMvQRY
+000014a0: 4631 7733 516a 6c77 456a 5872 5a59 5658  F1w3QjlwEjXrZYVX
+000014b0: 3155 4742 7934 3338 3662 6337 665a 565a  1UGBy4386bc7fZVZ
+000014c0: 7838 5675 5169 6f62 4f6a 4355 3048 4c59  x8VuQiobOjCU0HLY
+000014d0: 326c 384e 6365 6c56 4645 4169 3068 6e53  2l8NcelVFEAi0hnS
+000014e0: 4a76 7270 3967 3365 4757 756f 436e 662f  Jvrp9g3eGWuoCnf/
+000014f0: 5857 6339 2b63 7134 4472 6376 7a61 3943  XWc9+cq4Drcvza9C
+00001500: 424e 4c67 6e58 5a4d 6574 5a52 5772 562b  BNLgnXZMetZRWrV+
+00001510: 5762 4446 7771 7149 3471 4b43 6c6f 2b2f  WbDFwqqI4qKClo+/
+00001520: 2b48 3344 4b77 6430 6568 544c 5666 6a4b  +H3DKwd0ehTLVfjK
+00001530: 366b 4545 4866 724b 3463 566b 716c 656d  6kEEHfrK4cVkqlem
+00001540: 716d 3557 4d77 2f4c 7843 3350 4243 444e  qm5WMw/LxC3PBCDN
+00001550: 396f 614e 3163 6855 716f 704c 5734 6958  9oaN1chUqopLW4iX
+00001560: 4470 676f 2f64 5a51 7868 6e4b 2b43 4a31  Dpgo/dZQxhnK+CJ1
+00001570: 5642 3047 4772 735a 7755 544c 714a 7236  VB0GGrsZwUTLqJr6
+00001580: 6b37 7079 624a 796a 5859 5865 374e 2f35  k7pybJyjXYXe7N/5
+00001590: 326f 7551 622b 6d39 5576 595a 3544 496d  2ouQb+m9UvYZ5DIm
+000015a0: 4e78 3652 7765 664e 384a 6972 6333 486f  Nx6RwefN8Jirc3Ho
+000015b0: 737a 7273 7730 4268 466a 7653 3368 536f  szrsw0BhFjvS3hSo
+000015c0: 3038 754b 414b 447a 6f34 796b 395a 4a42  08uKAKDzo4yk9ZJB
+000015d0: 526a 7442 4163 4d34 514f 5358 3745 3d27  RjtBAcM4QOSX7E='
+000015e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000015f0: 2020 274c 5330 744c 5331 4352 5564 4a54    'LS0tLS1CRUdJT
+00001600: 6942 5156 554a 4d53 554d 6753 3056 5a4c  iBQVUJMSUMgS0VZL
+00001610: 5330 744c 5330 4b54 556c 4a51 306c 7151  S0tLS0KTUlJQ0lqQ
+00001620: 5535 435a 3274 7861 4774 7052 7a6c 334d  U5CZ2txaGtpRzl3M
+00001630: 454a 4255 5556 4751 5546 5051 3046 6e4f  EJBUUVGQUFPQ0FnO
+00001640: 4546 4e53 556c 4451 3264 4c51 3046 6e52  EFNSUlDQ2dLQ0FnR
+00001650: 5546 3253 575a 7356 6939 4c51 6b55 7263  UF2SWZsVi9LQkUrc
+00001660: 6b39 4362 5652 4664 564a 4d55 5170 6953  k9CbVRFdVJMUQpiS
+00001670: 5451 315a 325a 7954 5746 3562 6974 614e  TQ1Z2ZyTWF5bitaN
+00001680: 3056 7957 6d6c 5065 5646 444d 6a52 5962  0VyWmlPeVFDMjRYb
+00001690: 5652 5063 4552 5661 584a 5357 6b35 4a59  VRPcERVaXJSWk5JY
+000016a0: 7a4e 345a 544e 6e57 6c6c 3356 575a 5153  zN4ZTNnWll3VWZQS
+000016b0: 6d68 5053 5568 7657 6b4a 4856 456c 5253  mhPSUhvWkJHVElRS
+000016c0: 466b 7643 6a63 775a 6e4e 7651 7a63 7851  FkvCjcwZnNvQzcxQ
+000016d0: 7a56 7759 5568 6152 3142 7856 4774 4954  zVwYUhaR1BxVGtIT
+000016e0: 4464 6f5a 456c 585a 6c52 5053 4468 584d  DdoZElXZlRPSDhXM
+000016f0: 6e4a 7361 6d46 7557 564e 6953 5774 4763  nJsamFuWVNiSWtGc
+00001700: 3046 314f 4764 5363 4538 3164 3051 7951  0F1OGdScE81d0QyQ
+00001710: 6c56 7061 444e 7564 7a51 4b64 3270 4551  lVpaDNudzQKd2pEQ
+00001720: 5749 3156 4467 7a52 555a 565a 4856 3551  WI1VDgzRUZVZHV5Q
+00001730: 575a 3064 6b31 4362 306c 444c 325a 485a  WZ0dk1Cb0lDL2ZHZ
+00001740: 3264 4b4d 4642 7261 6c4e 504e 5556 7455  2dKMFBralNPNUVtU
+00001750: 586f 7956 4538 3357 6b68 6b52 6c51 7857  XoyVE83WkhkRlQxW
+00001760: 6b70 4b63 6c64 7853 4373 7a57 455a 4d57  kpKcldxSCszWEZMW
+00001770: 4170 6e65 575a 495a 7a68 5362 5739 7854  ApneWZIZzhSbW9xT
+00001780: 7a4a 4e56 5852 5854 6c56 6a51 314a 5655  zJNVXRXTlVjQ1JVU
+00001790: 4530 724d 4656 4663 305a 564d 3142 7057  E0rMFVFc0ZVM1BpW
+000017a0: 4670 5861 566c 5457 5570 7854 316c 6a62  FpXaVlTWUpxT1ljb
+000017b0: 6d49 7655 5764 4d64 4339 6a4e 544a 6b57  mIvUWdMdC9jNTJkW
+000017c0: 4534 7253 4664 6d43 6c5a 3653 336c 334d  E4rSFdmClZ6S3l3M
+000017d0: 6d64 5053 4564 4f53 7a46 6164 465a 305a  mdPSEdOSzFadFZ0Z
+000017e0: 324e 3052 6e68 7062 4768 5753 5756 475a  2N0RnhpbGhWSWVGZ
+000017f0: 584e 6a57 6c64 4356 564a 4b63 454a 5557  XNjWldCVVJKcEJUW
+00001800: 6c70 6c4b 3056 6d5a 5752 694d 554e 3261  lplK0VmZWRiMUN2a
+00001810: 314e 594d 4731 7063 6e4a 6c53 6d73 4b63  1NYMG1pcnJlSmsKc
+00001820: 464e 4653 6a68 3357 5755 3464 5464 3553  FNFSjh3WWU4dTd5S
+00001830: 6b68 5a63 6e49 7661 565a 5353 3370 3553  khZcnIvaVZSS3p5S
+00001840: 6e52 4863 3074 4557 4568 5555 4764 7362  nRHc0tEWEhUUGdsb
+00001850: 6e59 3355 3270 6161 4731 6161 5764 7364  nY3U2paaG1aaWdsd
+00001860: 4574 4554 5764 714f 464a 7461 6e64 554e  EtETWdqOFJtandUN
+00001870: 6d39 5855 5170 5563 5668 694f 5842 4963  m9XUQpUcVhiOXBIc
+00001880: 3342 4656 6d46 4357 5845 7a63 3056 6d62  3BFVmFCWXEzc0Vmb
+00001890: 5535 6b61 6a56 5464 5374 5065 4578 3551  U5kajVTdStPeEx5Q
+000018a0: 3368 4753 6c4d 7854 3273 794d 474e 564e  3hGSlMxT2syMGNVN
+000018b0: 4842 3359 304a 6f62 476c 7751 6c5a 554e  HB3Y0JobGlwQlZUN
+000018c0: 4531 4f54 6e41 3354 3156 4e43 6a49 7962  E1OTnA3T1VNCjIyb
+000018d0: 3046 714e 4578 784d 4856 4a53 3364 4959  0FqNExxMHVJS3dIY
+000018e0: 6c6f 784d 5731 7462 6d4e 4362 3252 504e  loxMW1tbmNCb2RPN
+000018f0: 6d39 7463 6d6c 7053 324d 344e 6b5a 7759  m9tcmlpS2M4NkZwY
+00001900: 6e41 7655 4535 6162 5646 6c62 3352 4d64  nAvUE5abVFlb3RMd
+00001910: 464e 7563 546c 4963 6e5a 725a 6b46 6d62  FNucTlIcnZrZkFmb
+00001920: 484d 4b4e 3368 424f 4374 4c62 464e 6f65  HMKN3hBOCtLbFNoe
+00001930: 564a 6d59 5668 3065 5552 7657 5773 344e  VJmYVh0eURvWWs4N
+00001940: 3234 3453 5777 7952 3238 7756 6b4e 3364  244SWwyR28wVkN3d
+00001950: 566c 6b62 5442 714f 5852 4659 3367 304d  VlkbTBqOXRFY3g0M
+00001960: 3064 5751 3056 4a4f 485a 324e 7a46 3464  0dWQ0VJOHZ2NzF4d
+00001970: 6d5a 6a56 486c 424d 6770 6e61 3039 6862  mZjVHlBMgpna09hb
+00001980: 304a 4857 5568 545a 4446 5962 6e52 6d53  0JHWUhTZDFYbnRmS
+00001990: 3163 3164 5759 315a 5570 4f61 5849 3063  1c1dWY1ZUpOaXI0c
+000019a0: 6c4e 6e63 6d52 5757 6e64 4c5a 484e 504e  lNncmRWWndLZHNPN
+000019b0: 6a5a 4c65 6c6b 334d 5446 764d 315a 6862  jZLelk3MTFvM1Zhb
+000019c0: 5442 6a55 584e 6a59 5578 5063 5777 7843  TBjUXNjYUxPcWwxC
+000019d0: 6e51 7259 5652 564d 454e 544d 4442 4754  nQrYVRVMENTMDBGT
+000019e0: 3270 4c55 4764 424b 3170 6a4d 3255 7751  2pLUGdBK1pjM2UwQ
+000019f0: 3046 3352 5546 4255 5430 3943 6930 744c  0F3RUFBUT09Ci0tL
+00001a00: 5330 7452 5535 4549 4642 5651 6b78 4a51  S0tRU5EIFBVQkxJQ
+00001a10: 7942 4c52 566b 744c 5330 744c 513d 3d27  yBLRVktLS0tLQ=='
+00001a20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001a30: 2020 2730 3662 3633 3534 3664 3066 3837    '06b63546d0f87
+00001a40: 3766 3537 6537 3439 3830 6664 6339 3631  7f57e74980fdc961
+00001a50: 6235 3234 3763 3166 3037 3133 6638 3237  b5247c1f0713f827
+00001a60: 6239 6166 3661 3336 6332 3927 2c0a 2020  b9af6a36c29',.  
+00001a70: 2020 2020 2020 2020 2020 2020 2020 302c                0,
+00001a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001a90: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00001aa0: 2020 2020 312c 0a20 2020 2020 2020 2020      1,.         
+00001ab0: 2020 2020 2020 2027 6765 6e65 7369 7327         'genesis'
+00001ac0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00001ad0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00001ae0: 2020 6864 642e 636f 6d6d 6974 2829 0a20    hdd.commit(). 
+00001af0: 2020 2020 2020 2068 6464 2e63 6c6f 7365         hdd.close
+00001b00: 2829 0a0a 2020 2020 2020 2020 6879 7020  ()..        hyp 
+00001b10: 3d20 7371 6c69 7465 332e 636f 6e6e 6563  = sqlite3.connec
+00001b20: 7428 2773 7461 7469 632f 6879 7065 722e  t('static/hyper.
+00001b30: 6462 272c 2074 696d 656f 7574 3d31 290a  db', timeout=1).
+00001b40: 2020 2020 2020 2020 6879 702e 7465 7874          hyp.text
+00001b50: 5f66 6163 746f 7279 203d 2073 7472 0a20  _factory = str. 
+00001b60: 2020 2020 2020 2068 7970 2e65 7865 6375         hyp.execu
+00001b70: 7465 2827 5052 4147 4d41 2063 6173 655f  te('PRAGMA case_
+00001b80: 7365 6e73 6974 6976 655f 6c69 6b65 203d  sensitive_like =
+00001b90: 2031 3b27 290a 2020 2020 2020 2020 6879   1;').        hy
+00001ba0: 705f 6375 7273 6f72 203d 2068 7970 2e63  p_cursor = hyp.c
+00001bb0: 7572 736f 7228 290a 2020 2020 2020 2020  ursor().        
+00001bc0: 6879 705f 6375 7273 6f72 2e65 7865 6375  hyp_cursor.execu
+00001bd0: 7465 2827 4352 4541 5445 2054 4142 4c45  te('CREATE TABLE
+00001be0: 2049 4620 4e4f 5420 4558 4953 5453 2022   IF NOT EXISTS "
+00001bf0: 6d69 7363 2220 2822 626c 6f63 6b5f 6865  misc" ("block_he
+00001c00: 6967 6874 2220 494e 5445 4745 522c 2022  ight" INTEGER, "
+00001c10: 6469 6666 6963 756c 7479 2220 5445 5854  difficulty" TEXT
+00001c20: 2927 290a 2020 2020 2020 2020 6879 705f  )').        hyp_
+00001c30: 6375 7273 6f72 2e65 7865 6375 7465 280a  cursor.execute(.
+00001c40: 2020 2020 2020 2020 2020 2020 2743 5245              'CRE
+00001c50: 4154 4520 5441 424c 4520 4946 204e 4f54  ATE TABLE IF NOT
+00001c60: 2045 5849 5354 5320 2274 7261 6e73 6163   EXISTS "transac
+00001c70: 7469 6f6e 7322 2028 2262 6c6f 636b 5f68  tions" ("block_h
+00001c80: 6569 6768 7422 2049 4e54 4547 4552 2c20  eight" INTEGER, 
+00001c90: 2274 696d 6573 7461 6d70 2220 4e55 4d45  "timestamp" NUME
+00001ca0: 5249 432c 2022 6164 6472 6573 7322 2054  RIC, "address" T
+00001cb0: 4558 542c 2022 7265 6369 7069 656e 7422  EXT, "recipient"
+00001cc0: 2054 4558 542c 2022 616d 6f75 6e74 2220   TEXT, "amount" 
+00001cd0: 4e55 4d45 5249 432c 2022 7369 676e 6174  NUMERIC, "signat
+00001ce0: 7572 6522 2054 4558 542c 2022 7075 626c  ure" TEXT, "publ
+00001cf0: 6963 5f6b 6579 2220 5445 5854 2c20 2262  ic_key" TEXT, "b
+00001d00: 6c6f 636b 5f68 6173 6822 2054 4558 542c  lock_hash" TEXT,
+00001d10: 2022 6665 6522 204e 554d 4552 4943 2c20   "fee" NUMERIC, 
+00001d20: 2272 6577 6172 6422 204e 554d 4552 4943  "reward" NUMERIC
+00001d30: 2c20 226f 7065 7261 7469 6f6e 2220 5445  , "operation" TE
+00001d40: 5854 2c20 226f 7065 6e66 6965 6c64 2220  XT, "openfield" 
+00001d50: 5445 5854 2927 2c0a 2020 2020 2020 2020  TEXT)',.        
+00001d60: 290a 2020 2020 2020 2020 6879 705f 6375  ).        hyp_cu
+00001d70: 7273 6f72 2e65 7865 6375 7465 2827 4352  rsor.execute('CR
+00001d80: 4541 5445 2049 4e44 4558 2022 5469 6d65  EATE INDEX "Time
+00001d90: 7374 616d 7020 496e 6465 7822 204f 4e20  stamp Index" ON 
+00001da0: 2274 7261 6e73 6163 7469 6f6e 7322 2028  "transactions" (
+00001db0: 2274 696d 6573 7461 6d70 2229 2729 0a20  "timestamp")'). 
+00001dc0: 2020 2020 2020 2068 7970 5f63 7572 736f         hyp_curso
+00001dd0: 722e 6578 6563 7574 6528 2743 5245 4154  r.execute('CREAT
+00001de0: 4520 494e 4445 5820 2253 6967 6e61 7475  E INDEX "Signatu
+00001df0: 7265 2049 6e64 6578 2220 4f4e 2022 7472  re Index" ON "tr
+00001e00: 616e 7361 6374 696f 6e73 2220 2822 7369  ansactions" ("si
+00001e10: 676e 6174 7572 6522 2927 290a 2020 2020  gnature")').    
+00001e20: 2020 2020 6879 705f 6375 7273 6f72 2e65      hyp_cursor.e
+00001e30: 7865 6375 7465 2827 4352 4541 5445 2049  xecute('CREATE I
+00001e40: 4e44 4558 2022 5265 7761 7264 2049 6e64  NDEX "Reward Ind
+00001e50: 6578 2220 4f4e 2022 7472 616e 7361 6374  ex" ON "transact
+00001e60: 696f 6e73 2220 2822 7265 7761 7264 2229  ions" ("reward")
+00001e70: 2729 0a20 2020 2020 2020 2068 7970 5f63  ').        hyp_c
+00001e80: 7572 736f 722e 6578 6563 7574 6528 2743  ursor.execute('C
+00001e90: 5245 4154 4520 494e 4445 5820 2252 6563  REATE INDEX "Rec
+00001ea0: 6970 6965 6e74 2049 6e64 6578 2220 4f4e  ipient Index" ON
+00001eb0: 2022 7472 616e 7361 6374 696f 6e73 2220   "transactions" 
+00001ec0: 2822 7265 6369 7069 656e 7422 2927 290a  ("recipient")').
+00001ed0: 2020 2020 2020 2020 6879 705f 6375 7273          hyp_curs
+00001ee0: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
+00001ef0: 5445 2049 4e44 4558 2022 4f70 656e 6669  TE INDEX "Openfi
+00001f00: 656c 6420 496e 6465 7822 204f 4e20 2274  eld Index" ON "t
+00001f10: 7261 6e73 6163 7469 6f6e 7322 2028 226f  ransactions" ("o
+00001f20: 7065 6e66 6965 6c64 2229 2729 0a20 2020  penfield")').   
+00001f30: 2020 2020 2068 7970 5f63 7572 736f 722e       hyp_cursor.
+00001f40: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+00001f50: 494e 4445 5820 2246 6565 2049 6e64 6578  INDEX "Fee Index
+00001f60: 2220 4f4e 2022 7472 616e 7361 6374 696f  " ON "transactio
+00001f70: 6e73 2220 2822 6665 6522 2927 290a 2020  ns" ("fee")').  
+00001f80: 2020 2020 2020 6879 705f 6375 7273 6f72        hyp_cursor
+00001f90: 2e65 7865 6375 7465 2827 4352 4541 5445  .execute('CREATE
+00001fa0: 2049 4e44 4558 2022 426c 6f63 6b20 4865   INDEX "Block He
+00001fb0: 6967 6874 2049 6e64 6578 2220 4f4e 2022  ight Index" ON "
+00001fc0: 7472 616e 7361 6374 696f 6e73 2220 2822  transactions" ("
+00001fd0: 626c 6f63 6b5f 6865 6967 6874 2229 2729  block_height")')
+00001fe0: 0a20 2020 2020 2020 2068 7970 5f63 7572  .        hyp_cur
+00001ff0: 736f 722e 6578 6563 7574 6528 2743 5245  sor.execute('CRE
+00002000: 4154 4520 494e 4445 5820 2242 6c6f 636b  ATE INDEX "Block
+00002010: 2048 6173 6820 496e 6465 7822 204f 4e20   Hash Index" ON 
+00002020: 2274 7261 6e73 6163 7469 6f6e 7322 2028  "transactions" (
+00002030: 2262 6c6f 636b 5f68 6173 6822 2927 290a  "block_hash")').
+00002040: 2020 2020 2020 2020 6879 705f 6375 7273          hyp_curs
+00002050: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
+00002060: 5445 2049 4e44 4558 2022 416d 6f75 6e74  TE INDEX "Amount
+00002070: 2049 6e64 6578 2220 4f4e 2022 7472 616e   Index" ON "tran
+00002080: 7361 6374 696f 6e73 2220 2822 616d 6f75  sactions" ("amou
+00002090: 6e74 2229 2729 0a20 2020 2020 2020 2068  nt")').        h
+000020a0: 7970 5f63 7572 736f 722e 6578 6563 7574  yp_cursor.execut
+000020b0: 6528 2743 5245 4154 4520 494e 4445 5820  e('CREATE INDEX 
+000020c0: 2241 6464 7265 7373 2049 6e64 6578 2220  "Address Index" 
+000020d0: 4f4e 2022 7472 616e 7361 6374 696f 6e73  ON "transactions
+000020e0: 2220 2822 6164 6472 6573 7322 2927 290a  " ("address")').
+000020f0: 2020 2020 2020 2020 6879 705f 6375 7273          hyp_curs
+00002100: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
+00002110: 5445 2049 4e44 4558 2022 4f70 6572 6174  TE INDEX "Operat
+00002120: 696f 6e20 496e 6465 7822 204f 4e20 2274  ion Index" ON "t
+00002130: 7261 6e73 6163 7469 6f6e 7322 2028 226f  ransactions" ("o
+00002140: 7065 7261 7469 6f6e 2229 2729 0a20 2020  peration")').   
+00002150: 2020 2020 2068 7970 5f63 7572 736f 722e       hyp_cursor.
+00002160: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+00002170: 494e 4445 5820 5458 4944 345f 496e 6465  INDEX TXID4_Inde
+00002180: 7820 4f4e 2074 7261 6e73 6163 7469 6f6e  x ON transaction
+00002190: 7328 7375 6273 7472 2873 6967 6e61 7475  s(substr(signatu
+000021a0: 7265 2c31 2c34 2929 2729 0a20 2020 2020  re,1,4))').     
+000021b0: 2020 2068 7970 5f63 7572 736f 722e 6578     hyp_cursor.ex
+000021c0: 6563 7574 6528 2743 5245 4154 4520 494e  ecute('CREATE IN
+000021d0: 4445 5820 224d 6973 6320 426c 6f63 6b20  DEX "Misc Block 
+000021e0: 4865 6967 6874 2049 6e64 6578 2220 6f6e  Height Index" on
+000021f0: 206d 6973 6328 626c 6f63 6b5f 6865 6967   misc(block_heig
+00002200: 6874 2927 290a 2020 2020 2020 2020 6879  ht)').        hy
+00002210: 705f 6375 7273 6f72 2e65 7865 6375 7465  p_cursor.execute
+00002220: 2827 494e 5345 5254 2049 4e54 4f20 6d69  ('INSERT INTO mi
+00002230: 7363 2028 6469 6666 6963 756c 7479 2c20  sc (difficulty, 
+00002240: 626c 6f63 6b5f 6865 6967 6874 2920 5641  block_height) VA
+00002250: 4c55 4553 2028 7b7d 2c31 2927 2e66 6f72  LUES ({},1)'.for
+00002260: 6d61 7428 494e 4954 4941 4c5f 4859 5045  mat(INITIAL_HYPE
+00002270: 525f 4449 4646 4943 554c 5459 2929 0a20  R_DIFFICULTY)). 
+00002280: 2020 2020 2020 2068 7970 5f63 7572 736f         hyp_curso
+00002290: 722e 6578 6563 7574 6528 0a20 2020 2020  r.execute(.     
+000022a0: 2020 2020 2020 2027 494e 5345 5254 2049         'INSERT I
+000022b0: 4e54 4f20 7472 616e 7361 6374 696f 6e73  NTO transactions
+000022c0: 2056 414c 5545 5320 283f 2c3f 2c3f 2c3f   VALUES (?,?,?,?
+000022d0: 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f  ,?,?,?,?,?,?,?,?
+000022e0: 2927 2c20 280a 2020 2020 2020 2020 2020  )', (.          
+000022f0: 2020 2020 2020 2731 272c 0a20 2020 2020        '1',.     
+00002300: 2020 2020 2020 2020 2020 2027 3136 3630             '1660
+00002310: 3233 3031 3937 2e37 3532 3939 272c 0a20  230197.75299',. 
+00002320: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00002330: 6765 6e65 7369 7327 2c0a 2020 2020 2020  genesis',.      
+00002340: 2020 2020 2020 2020 2020 2733 6239 6361            '3b9ca
+00002350: 3939 6137 3830 3430 3135 6638 6561 6562  99a7804015f8eaeb
+00002360: 6237 3864 3462 3530 3537 3062 6438 3333  b78d4b50570bd833
+00002370: 3765 3861 3831 3936 3334 3364 6262 6235  7e8a8196343dbbb5
+00002380: 3963 3427 2c0a 2020 2020 2020 2020 2020  9c4',.          
+00002390: 2020 2020 2020 2730 272c 0a20 2020 2020        '0',.     
+000023a0: 2020 2020 2020 2020 2020 2027 5157 6348             'QWcH
+000023b0: 6634 6739 494f 792f 5867 702b 6b61 6b6b  f4g9IOy/Xgp+kakk
+000023c0: 6e39 536a 6c2f 6262 4d76 637a 3839 6333  n9Sjl/bbMvcz89c3
+000023d0: 4c48 7036 5a2b 4467 3641 7859 434c 4f37  LHp6Z+Dg6AxYCLO7
+000023e0: 706c 574d 4a30 4c69 6843 454a 5041 586b  plWMJ0LihCEJPAXk
+000023f0: 7652 396d 6656 596e 6578 7573 5336 7a4d  vR9mfVYnexusS6zM
+00002400: 4936 5250 5450 616f 6a6c 7276 6431 5947  I6RPTPaojlrvd1YG
+00002410: 2f4e 4a45 5150 6344 4d48 5433 5832 6846  /NJEQPcDMHT3X2hF
+00002420: 7941 4b35 6254 4233 6f6c 6153 566f 6f49  yAK5bTB3olaSVooI
+00002430: 662f 384f 6652 3332 5444 6f75 5370 6d32  f/8OfR32TDouSpm2
+00002440: 4f35 4c6b 644f 5755 4945 4967 3865 7147  O5LkdOWUIEIg8eqG
+00002450: 4b38 6449 2b70 3645 7676 5167 3167 4543  K8dI+p6EvvQg1gEC
+00002460: 6e4e 6f4a 4c79 6447 6636 7538 4657 4c4c  nNoJLydGf6u8FWLL
+00002470: 652f 5569 7236 6233 5836 4866 4f6f 5953  e/Uir6b3X6HfOoYS
+00002480: 7032 6556 4254 6b6e 386a 6a48 5467 7a2f  p2eVBTkn8jjHTgz/
+00002490: 7a53 4942 4e73 386c 6150 4e4c 326e 5531  zSIBNs8laPNL2nU1
+000024a0: 4a46 6651 7147 2f58 5057 486b 5779 3557  JFfQqG/XPWHkWy5W
+000024b0: 344c 7854 436a 4e53 326e 3468 304b 6a41  4LxTCjNS2n4h0KjA
+000024c0: 6446 647a 6543 4d37 6d33 7258 6637 4530  dFdzeCM7m3rXf7E0
+000024d0: 3134 4265 6c59 4c54 7159 4530 5a30 3338  14BelYLTqYE0Z038
+000024e0: 2b7a 6d61 736c 5251 726f 6152 2b43 4b66  +zmaslRQroaR+CKf
+000024f0: 4275 4833 676d 2f54 774f 576d 384a 6939  BuH3gm/TwOWm8Ji9
+00002500: 6a54 6541 3178 4773 6a6b 6857 5479 4479  jTeA1xGsjkhWTyDy
+00002510: 7470 7573 4d76 5152 5946 3177 3351 6a6c  tpusMvQRYF1w3Qjl
+00002520: 7745 6a58 725a 5956 5831 5547 4279 3433  wEjXrZYVX1UGBy43
+00002530: 3836 6263 3766 5a56 5a78 3856 7551 696f  86bc7fZVZx8VuQio
+00002540: 624f 6a43 5530 484c 5932 6c38 4e63 656c  bOjCU0HLY2l8Ncel
+00002550: 5646 4541 6930 686e 534a 7672 7039 6733  VFEAi0hnSJvrp9g3
+00002560: 6547 5775 6f43 6e66 2f58 5763 392b 6371  eGWuoCnf/XWc9+cq
+00002570: 3444 7263 767a 6139 4342 4e4c 676e 585a  4Drcvza9CBNLgnXZ
+00002580: 4d65 745a 5257 7256 2b57 6244 4677 7171  MetZRWrV+WbDFwqq
+00002590: 4934 714b 436c 6f2b 2f2b 4833 444b 7764  I4qKClo+/+H3DKwd
+000025a0: 3065 6854 4c56 666a 4b36 6b45 4548 6672  0ehTLVfjK6kEEHfr
+000025b0: 4b34 6356 6b71 6c65 6d71 6d35 574d 772f  K4cVkqlemqm5WMw/
+000025c0: 4c78 4333 5042 4344 4e39 6f61 4e31 6368  LxC3PBCDN9oaN1ch
+000025d0: 5571 6f70 4c57 3469 5844 7067 6f2f 645a  UqopLW4iXDpgo/dZ
+000025e0: 5178 686e 4b2b 434a 3156 4230 4747 7273  QxhnK+CJ1VB0GGrs
+000025f0: 5a77 5554 4c71 4a72 366b 3770 7962 4a79  ZwUTLqJr6k7pybJy
+00002600: 6a58 5958 6537 4e2f 3532 6f75 5162 2b6d  jXYXe7N/52ouQb+m
+00002610: 3955 7659 5a35 4449 6d4e 7836 5277 6566  9UvYZ5DImNx6Rwef
+00002620: 4e38 4a69 7263 3348 6f73 7a72 7377 3042  N8Jirc3Hoszrsw0B
+00002630: 6846 6a76 5333 6853 6f30 3875 4b41 4b44  hFjvS3hSo08uKAKD
+00002640: 7a6f 3479 6b39 5a4a 4252 6a74 4241 634d  zo4yk9ZJBRjtBAcM
+00002650: 3451 4f53 5837 453d 272c 0a20 2020 2020  4QOSX7E=',.     
+00002660: 2020 2020 2020 2020 2020 2027 4c53 3074             'LS0t
+00002670: 4c53 3143 5255 644a 5469 4251 5655 4a4d  LS1CRUdJTiBQVUJM
+00002680: 5355 4d67 5330 565a 4c53 3074 4c53 304b  SUMgS0VZLS0tLS0K
+00002690: 5455 6c4a 5130 6c71 5155 3543 5a32 7478  TUlJQ0lqQU5CZ2tx
+000026a0: 6147 7470 527a 6c33 4d45 4a42 5555 5647  aGtpRzl3MEJBUUVG
+000026b0: 5155 4650 5130 466e 4f45 464e 5355 6c44  QUFPQ0FnOEFNSUlD
+000026c0: 5132 644c 5130 466e 5255 4632 5357 5a73  Q2dLQ0FnRUF2SWZs
+000026d0: 5669 394c 516b 5572 636b 3943 6256 5246  Vi9LQkUrck9CbVRF
+000026e0: 6456 4a4d 5551 7069 5354 5131 5a32 5a79  dVJMUQpiSTQ1Z2Zy
+000026f0: 5457 4635 6269 7461 4e30 5679 576d 6c50  TWF5bitaN0VyWmlP
+00002700: 6556 4644 4d6a 5259 6256 5250 6345 5256  eVFDMjRYbVRPcERV
+00002710: 6158 4a53 576b 354a 597a 4e34 5a54 4e6e  aXJSWk5JYzN4ZTNn
+00002720: 576c 6c33 5657 5a51 536d 6850 5355 6876  Wll3VWZQSmhPSUhv
+00002730: 576b 4a48 5645 6c52 5346 6b76 436a 6377  WkJHVElRSFkvCjcw
+00002740: 5a6e 4e76 517a 6378 517a 5677 5955 6861  ZnNvQzcxQzVwYUha
+00002750: 5231 4278 5647 7449 5444 646f 5a45 6c58  R1BxVGtITDdoZElX
+00002760: 5a6c 5250 5344 6858 4d6e 4a73 616d 4675  ZlRPSDhXMnJsamFu
+00002770: 5756 4e69 5357 7447 6330 4631 4f47 6453  WVNiSWtGc0F1OGdS
+00002780: 6345 3831 6430 5179 516c 5670 6144 4e75  cE81d0QyQlVpaDNu
+00002790: 647a 514b 6432 7045 5157 4931 5644 677a  dzQKd2pEQWI1VDgz
+000027a0: 5255 5a56 5a48 5635 5157 5a30 646b 3143  RUZVZHV5QWZ0dk1C
+000027b0: 6230 6c44 4c32 5a48 5a32 644b 4d46 4272  b0lDL2ZHZ2dKMFBr
+000027c0: 616c 4e50 4e55 5674 5558 6f79 5645 3833  alNPNUVtUXoyVE83
+000027d0: 576b 686b 526c 5178 576b 704b 636c 6478  WkhkRlQxWkpKcldx
+000027e0: 5343 737a 5745 5a4d 5741 706e 6557 5a49  SCszWEZMWApneWZI
+000027f0: 5a7a 6853 6257 3978 547a 4a4e 5658 5258  ZzhSbW9xTzJNVXRX
+00002800: 546c 566a 5131 4a56 5545 3072 4d46 5646  TlVjQ1JVUE0rMFVF
+00002810: 6330 5a56 4d31 4270 5746 7058 6156 6c54  c0ZVM1BpWFpXaVlT
+00002820: 5755 7078 5431 6c6a 626d 4976 5557 644d  WUpxT1ljbmIvUWdM
+00002830: 6443 396a 4e54 4a6b 5745 3472 5346 646d  dC9jNTJkWE4rSFdm
+00002840: 436c 5a36 5333 6c33 4d6d 6450 5345 644f  ClZ6S3l3MmdPSEdO
+00002850: 537a 4661 6446 5a30 5a32 4e30 526e 6870  SzFadFZ0Z2N0Rnhp
+00002860: 6247 6857 5357 5647 5a58 4e6a 576c 6443  bGhWSWVGZXNjWldC
+00002870: 5656 4a4b 6345 4a55 576c 706c 4b30 566d  VVJKcEJUWlplK0Vm
+00002880: 5a57 5269 4d55 4e32 6131 4e59 4d47 3170  ZWRiMUN2a1NYMG1p
+00002890: 636e 4a6c 536d 734b 6346 4e46 536a 6833  cnJlSmsKcFNFSjh3
+000028a0: 5757 5534 6454 6435 536b 685a 636e 4976  WWU4dTd5SkhZcnIv
+000028b0: 6156 5a53 5333 7035 536e 5248 6330 7445  aVZSS3p5SnRHc0tE
+000028c0: 5745 6855 5547 6473 626e 5933 5532 7061  WEhUUGdsbnY3U2pa
+000028d0: 6147 3161 6157 6473 6445 7445 5457 6471  aG1aaWdsdEtETWdq
+000028e0: 4f46 4a74 616e 6455 4e6d 3958 5551 7055  OFJtandUNm9XUQpU
+000028f0: 6356 6869 4f58 4249 6333 4246 566d 4643  cVhiOXBIc3BFVmFC
+00002900: 5758 457a 6330 566d 6255 356b 616a 5654  WXEzc0VmbU5kajVT
+00002910: 6453 7450 6545 7835 5133 6847 536c 4d78  dStPeEx5Q3hGSlMx
+00002920: 5432 7379 4d47 4e56 4e48 4233 5930 4a6f  T2syMGNVNHB3Y0Jo
+00002930: 6247 6c77 516c 5a55 4e45 314f 546e 4133  bGlwQlZUNE1OTnA3
+00002940: 5431 564e 436a 4979 6230 4671 4e45 7878  T1VNCjIyb0FqNExx
+00002950: 4d48 564a 5333 6449 596c 6f78 4d57 3174  MHVJS3dIYloxMW1t
+00002960: 626d 4e43 6232 5250 4e6d 3974 636d 6c70  bmNCb2RPNm9tcmlp
+00002970: 5332 4d34 4e6b 5a77 596e 4176 5545 3561  S2M4NkZwYnAvUE5a
+00002980: 6256 466c 6233 524d 6446 4e75 6354 6c49  bVFlb3RMdFNucTlI
+00002990: 636e 5a72 5a6b 466d 6248 4d4b 4e33 6842  cnZrZkFmbHMKN3hB
+000029a0: 4f43 744c 6246 4e6f 6556 4a6d 5956 6830  OCtLbFNoeVJmYVh0
+000029b0: 6555 5276 5757 7334 4e32 3434 5357 7779  eURvWWs4N244SWwy
+000029c0: 5232 3877 566b 4e33 6456 6c6b 6254 4271  R28wVkN3dVlkbTBq
+000029d0: 4f58 5246 5933 6730 4d30 6457 5130 564a  OXRFY3g0M0dWQ0VJ
+000029e0: 4f48 5a32 4e7a 4634 646d 5a6a 5648 6c42  OHZ2NzF4dmZjVHlB
+000029f0: 4d67 706e 6130 3968 6230 4a48 5755 6854  Mgpna09hb0JHWUhT
+00002a00: 5a44 4659 626e 526d 5331 6331 6457 5931  ZDFYbnRmS1c1dWY1
+00002a10: 5a55 704f 6158 4930 636c 4e6e 636d 5257  ZUpOaXI0clNncmRW
+00002a20: 576e 644c 5a48 4e50 4e6a 5a4c 656c 6b33  WndLZHNPNjZLelk3
+00002a30: 4d54 4676 4d31 5a68 6254 426a 5558 4e6a  MTFvM1ZhbTBjUXNj
+00002a40: 5955 7850 6357 7778 436e 5172 5956 5256  YUxPcWwxCnQrYVRV
+00002a50: 4d45 4e54 4d44 4247 5432 704c 5547 6442  MENTMDBGT2pLUGdB
+00002a60: 4b31 706a 4d32 5577 5130 4633 5255 4642  K1pjM2UwQ0F3RUFB
+00002a70: 5554 3039 4369 3074 4c53 3074 5255 3545  UT09Ci0tLS0tRU5E
+00002a80: 4946 4256 516b 784a 5179 424c 5256 6b74  IFBVQkxJQyBLRVkt
+00002a90: 4c53 3074 4c51 3d3d 272c 0a20 2020 2020  LS0tLQ==',.     
+00002aa0: 2020 2020 2020 2020 2020 2027 3036 6236             '06b6
+00002ab0: 3335 3436 6430 6638 3737 6635 3765 3734  3546d0f877f57e74
+00002ac0: 3938 3066 6463 3936 3162 3532 3437 6331  980fdc961b5247c1
+00002ad0: 6630 3731 3366 3832 3762 3961 6636 6133  f0713f827b9af6a3
+00002ae0: 3663 3239 272c 0a20 2020 2020 2020 2020  6c29',.         
+00002af0: 2020 2020 2020 2030 2c0a 2020 2020 2020         0,.      
+00002b00: 2020 2020 2020 2020 2020 312c 0a20 2020            1,.   
+00002b10: 2020 2020 2020 2020 2020 2020 2031 2c0a               1,.
+00002b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b30: 2767 656e 6573 6973 272c 0a20 2020 2020  'genesis',.     
+00002b40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00002b50: 2029 0a20 2020 2020 2020 2068 7970 2e63   ).        hyp.c
+00002b60: 6f6d 6d69 7428 290a 2020 2020 2020 2020  ommit().        
+00002b70: 6879 702e 636c 6f73 6528 290a 0a20 2020  hyp.close()..   
+00002b80: 2020 2020 2069 6e64 6578 203d 2073 716c       index = sql
+00002b90: 6974 6533 2e63 6f6e 6e65 6374 2827 7374  ite3.connect('st
+00002ba0: 6174 6963 2f69 6e64 6578 2e64 6227 2c20  atic/index.db', 
+00002bb0: 7469 6d65 6f75 743d 3129 0a20 2020 2020  timeout=1).     
+00002bc0: 2020 2069 6e64 6578 2e74 6578 745f 6661     index.text_fa
+00002bd0: 6374 6f72 7920 3d20 7374 720a 2020 2020  ctory = str.    
+00002be0: 2020 2020 696e 6465 782e 6578 6563 7574      index.execut
+00002bf0: 6528 2750 5241 474d 4120 6361 7365 5f73  e('PRAGMA case_s
+00002c00: 656e 7369 7469 7665 5f6c 696b 6520 3d20  ensitive_like = 
+00002c10: 313b 2729 0a20 2020 2020 2020 2069 6e64  1;').        ind
+00002c20: 6578 5f63 7572 736f 7220 3d20 696e 6465  ex_cursor = inde
+00002c30: 782e 6375 7273 6f72 2829 0a20 2020 2020  x.cursor().     
+00002c40: 2020 2069 6e64 6578 5f63 7572 736f 722e     index_cursor.
+00002c50: 6578 6563 7574 6528 2743 5245 4154 4520  execute('CREATE 
+00002c60: 5441 424c 4520 746f 6b65 6e73 2028 626c  TABLE tokens (bl
+00002c70: 6f63 6b5f 6865 6967 6874 2049 4e54 4547  ock_height INTEG
+00002c80: 4552 2c20 7469 6d65 7374 616d 702c 2074  ER, timestamp, t
+00002c90: 6f6b 656e 2c20 6164 6472 6573 732c 2072  oken, address, r
+00002ca0: 6563 6970 6965 6e74 2c20 7478 6964 2c20  ecipient, txid, 
+00002cb0: 616d 6f75 6e74 2049 4e54 4547 4552 2927  amount INTEGER)'
+00002cc0: 290a 2020 2020 2020 2020 696e 6465 785f  ).        index_
+00002cd0: 6375 7273 6f72 2e65 7865 6375 7465 2827  cursor.execute('
+00002ce0: 4352 4541 5445 2054 4142 4c45 2061 6c69  CREATE TABLE ali
+00002cf0: 6173 6573 2028 626c 6f63 6b5f 6865 6967  ases (block_heig
+00002d00: 6874 2049 4e54 4547 4552 2c20 6164 6472  ht INTEGER, addr
+00002d10: 6573 732c 2061 6c69 6173 2927 290a 2020  ess, alias)').  
+00002d20: 2020 2020 2020 696e 6465 785f 6375 7273        index_curs
+00002d30: 6f72 2e65 7865 6375 7465 2827 4352 4541  or.execute('CREA
+00002d40: 5445 2049 4e44 4558 2022 416c 6961 7320  TE INDEX "Alias 
+00002d50: 496e 6465 7822 204f 4e20 2261 6c69 6173  Index" ON "alias
+00002d60: 6573 2220 2822 626c 6f63 6b5f 6865 6967  es" ("block_heig
+00002d70: 6874 222c 2022 6164 6472 6573 7322 2c22  ht", "address","
+00002d80: 616c 6961 7322 2927 290a 2020 2020 2020  alias")').      
+00002d90: 2020 696e 6465 785f 6375 7273 6f72 2e65    index_cursor.e
+00002da0: 7865 6375 7465 2827 4352 4541 5445 2049  xecute('CREATE I
+00002db0: 4e44 4558 2022 546f 6b65 6e20 496e 6465  NDEX "Token Inde
+00002dc0: 7822 204f 4e20 2274 6f6b 656e 7322 2028  x" ON "tokens" (
+00002dd0: 2262 6c6f 636b 5f68 6569 6768 7422 2c22  "block_height","
+00002de0: 7469 6d65 7374 616d 7022 2c22 746f 6b65  timestamp","toke
+00002df0: 6e22 2c22 6164 6472 6573 7322 2c22 7265  n","address","re
+00002e00: 6369 7069 656e 7422 2c22 7478 6964 222c  cipient","txid",
+00002e10: 2261 6d6f 756e 7422 2927 290a 2020 2020  "amount")').    
+00002e20: 2020 2020 696e 6465 785f 6375 7273 6f72      index_cursor
+00002e30: 2e65 7865 6375 7465 2827 4352 4541 5445  .execute('CREATE
+00002e40: 2054 4142 4c45 2073 7461 6b69 6e67 2028   TABLE staking (
+00002e50: 626c 6f63 6b5f 6865 6967 6874 2049 4e54  block_height INT
+00002e60: 4547 4552 2c20 7469 6d65 7374 616d 7020  EGER, timestamp 
+00002e70: 4e55 4d45 5249 432c 2061 6464 7265 7373  NUMERIC, address
+00002e80: 2c20 6261 6c61 6e63 652c 2069 702c 2070  , balance, ip, p
+00002e90: 6f72 742c 2070 6f73 5f61 6464 7265 7373  ort, pos_address
+00002ea0: 2927 290a 2020 2020 2020 2020 696e 6465  )').        inde
+00002eb0: 782e 636f 6d6d 6974 2829 0a20 2020 2020  x.commit().     
+00002ec0: 2020 2069 6e64 6578 2e63 6c6f 7365 2829     index.close()
+00002ed0: 0a0a 2020 2020 6578 6365 7074 3a0a 2020  ..    except:.  
+00002ee0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00002ef0: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00002f00: 6728 2753 6f6d 6574 6869 6e67 2077 656e  g('Something wen
+00002f10: 7420 7772 6f6e 6720 6475 7269 6e67 2062  t wrong during b
+00002f20: 6f6f 7473 7472 6170 7069 6e67 2c20 6162  ootstrapping, ab
+00002f30: 6f72 7465 6427 290a 2020 2020 2020 2020  orted').        
+00002f40: 7261 6973 650a 0a0a 6465 6620 6368 6563  raise...def chec
+00002f50: 6b5f 696e 7465 6772 6974 7928 6461 7461  k_integrity(data
+00002f60: 6261 7365 293a 0a20 2020 2023 2054 4f44  base):.    # TOD
+00002f70: 4f3a 2043 616e 6469 6461 7465 2066 6f72  O: Candidate for
+00002f80: 2073 696e 676c 6520 7573 6572 206d 6f64   single user mod
+00002f90: 650a 2020 2020 2320 6368 6563 6b20 6c65  e.    # check le
+00002fa0: 6467 6572 2069 6e74 6567 7269 7479 0a0a  dger integrity..
+00002fb0: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
+00002fc0: 7468 2e65 7869 7374 7328 2773 7461 7469  th.exists('stati
+00002fd0: 6327 293a 0a20 2020 2020 2020 206f 732e  c'):.        os.
+00002fe0: 6d6b 6469 7228 2773 7461 7469 6327 290a  mkdir('static').
+00002ff0: 0a20 2020 2077 6974 6820 7371 6c69 7465  .    with sqlite
+00003000: 332e 636f 6e6e 6563 7428 6461 7461 6261  3.connect(databa
+00003010: 7365 2920 6173 206c 6564 6765 725f 6368  se) as ledger_ch
+00003020: 6563 6b3a 0a20 2020 2020 2020 2069 6620  eck:.        if 
+00003030: 6e6f 6465 2e74 7261 6365 5f64 625f 6361  node.trace_db_ca
+00003040: 6c6c 733a 0a20 2020 2020 2020 2020 2020  lls:.           
+00003050: 206c 6564 6765 725f 6368 6563 6b2e 7365   ledger_check.se
+00003060: 745f 7472 6163 655f 6361 6c6c 6261 636b  t_trace_callback
+00003070: 2866 756e 6374 6f6f 6c73 2e70 6172 7469  (functools.parti
+00003080: 616c 2873 716c 5f74 7261 6365 5f63 616c  al(sql_trace_cal
+00003090: 6c62 6163 6b2c 206e 6f64 652e 6c6f 6767  lback, node.logg
+000030a0: 6572 2e61 7070 5f6c 6f67 2c20 2743 4845  er.app_log, 'CHE
+000030b0: 434b 5f49 4e54 4547 5249 5459 2729 290a  CK_INTEGRITY')).
+000030c0: 0a20 2020 2020 2020 206c 6564 6765 725f  .        ledger_
+000030d0: 6368 6563 6b2e 7465 7874 5f66 6163 746f  check.text_facto
+000030e0: 7279 203d 2073 7472 0a20 2020 2020 2020  ry = str.       
+000030f0: 206c 203d 206c 6564 6765 725f 6368 6563   l = ledger_chec
+00003100: 6b2e 6375 7273 6f72 2829 0a0a 2020 2020  k.cursor()..    
+00003110: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00003120: 2020 2020 206c 2e65 7865 6375 7465 2822       l.execute("
+00003130: 5052 4147 4d41 2074 6162 6c65 5f69 6e66  PRAGMA table_inf
+00003140: 6f28 2774 7261 6e73 6163 7469 6f6e 7327  o('transactions'
+00003150: 2922 290a 2020 2020 2020 2020 2020 2020  )").            
+00003160: 7265 646f 776e 6c6f 6164 203d 2046 616c  redownload = Fal
+00003170: 7365 0a20 2020 2020 2020 2065 7863 6570  se.        excep
+00003180: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00003190: 6564 6f77 6e6c 6f61 6420 3d20 5472 7565  edownload = True
+000031a0: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
+000031b0: 286c 2e66 6574 6368 616c 6c28 2929 2021  (l.fetchall()) !
+000031c0: 3d20 3132 3a0a 2020 2020 2020 2020 2020  = 12:.          
+000031d0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+000031e0: 705f 6c6f 672e 7761 726e 696e 6728 6627  p_log.warning(f'
+000031f0: 5374 6174 7573 3a20 496e 7465 6772 6974  Status: Integrit
+00003200: 7920 6368 6563 6b20 6f6e 2064 6174 6162  y check on datab
+00003210: 6173 6520 7b64 6174 6162 6173 657d 2066  ase {database} f
+00003220: 6169 6c65 642c 2062 6f6f 7473 7472 6170  ailed, bootstrap
+00003230: 7069 6e67 2066 726f 6d20 7468 6520 7765  ping from the we
+00003240: 6273 6974 6527 290a 2020 2020 2020 2020  bsite').        
+00003250: 2020 2020 7265 646f 776e 6c6f 6164 203d      redownload =
+00003260: 2054 7275 650a 0a20 2020 2069 6620 7265   True..    if re
+00003270: 646f 776e 6c6f 6164 2061 6e64 206e 6f64  download and nod
+00003280: 652e 6973 5f6d 6169 6e6e 6574 3a0a 2020  e.is_mainnet:.  
+00003290: 2020 2020 2020 626f 6f74 7374 7261 7028        bootstrap(
+000032a0: 290a 0a0a 6465 6620 726f 6c6c 6261 636b  )...def rollback
+000032b0: 286e 6f64 652c 2064 625f 6861 6e64 6c65  (node, db_handle
+000032c0: 722c 2062 6c6f 636b 5f68 6569 6768 7429  r, block_height)
+000032d0: 3a0a 2020 2020 6e6f 6465 2e6c 6f67 6765  :.    node.logge
+000032e0: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+000032f0: 6728 6627 5374 6174 7573 3a20 526f 6c6c  g(f'Status: Roll
+00003300: 696e 6720 6261 636b 2062 656c 6f77 3a20  ing back below: 
+00003310: 7b62 6c6f 636b 5f68 6569 6768 747d 2729  {block_height}')
+00003320: 0a0a 2020 2020 6462 5f68 616e 646c 6572  ..    db_handler
+00003330: 2e72 6f6c 6c62 6163 6b5f 756e 6465 7228  .rollback_under(
+00003340: 626c 6f63 6b5f 6865 6967 6874 290a 0a20  block_height).. 
+00003350: 2020 2023 2072 6f6c 6c62 6163 6b20 696e     # rollback in
+00003360: 6469 6365 730a 2020 2020 6462 5f68 616e  dices.    db_han
+00003370: 646c 6572 2e74 6f6b 656e 735f 726f 6c6c  dler.tokens_roll
+00003380: 6261 636b 286e 6f64 652c 2062 6c6f 636b  back(node, block
+00003390: 5f68 6569 6768 7429 0a20 2020 2064 625f  _height).    db_
+000033a0: 6861 6e64 6c65 722e 616c 6961 7365 735f  handler.aliases_
+000033b0: 726f 6c6c 6261 636b 286e 6f64 652c 2062  rollback(node, b
+000033c0: 6c6f 636b 5f68 6569 6768 7429 0a20 2020  lock_height).   
+000033d0: 2023 2072 6f6c 6c62 6163 6b20 696e 6469   # rollback indi
+000033e0: 6365 730a 0a20 2020 206e 6f64 652e 6c6f  ces..    node.lo
+000033f0: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
+00003400: 6e69 6e67 2866 2753 7461 7475 733a 2043  ning(f'Status: C
+00003410: 6861 696e 2072 6f6c 6c65 6420 6261 636b  hain rolled back
+00003420: 2062 656c 6f77 207b 626c 6f63 6b5f 6865   below {block_he
+00003430: 6967 6874 7d20 616e 6420 7769 6c6c 2062  ight} and will b
+00003440: 6520 7265 7379 6e63 6872 6f6e 697a 6564  e resynchronized
+00003450: 2729 0a0a 0a64 6566 2072 6563 6f6d 7072  ')...def recompr
+00003460: 6573 735f 6c65 6467 6572 286e 6f64 652c  ess_ledger(node,
+00003470: 2072 6562 7569 6c64 3d46 616c 7365 2c20   rebuild=False, 
+00003480: 6465 7074 683d 3135 3030 3029 3a0a 2020  depth=15000):.  
+00003490: 2020 2320 544f 444f 3a20 4361 6e64 6964    # TODO: Candid
+000034a0: 6174 6520 666f 7220 7369 6e67 6c65 2075  ate for single u
+000034b0: 7365 7220 6d6f 6465 0a20 2020 206e 6f64  ser mode.    nod
+000034c0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+000034d0: 2e77 6172 6e69 6e67 2866 2753 7461 7475  .warning(f'Statu
+000034e0: 733a 2052 6563 6f6d 7072 6573 7369 6e67  s: Recompressing
+000034f0: 2c20 706c 6561 7365 2062 6520 7061 7469  , please be pati
+00003500: 656e 7427 290a 0a20 2020 2066 696c 6573  ent')..    files
+00003510: 5f72 656d 6f76 6520 3d20 5b6e 6f64 652e  _remove = [node.
+00003520: 6c65 6467 6572 5f70 6174 6820 2b20 272e  ledger_path + '.
+00003530: 7465 6d70 272c 206e 6f64 652e 6c65 6467  temp', node.ledg
+00003540: 6572 5f70 6174 6820 2b20 272e 7465 6d70  er_path + '.temp
+00003550: 2d73 686d 272c 206e 6f64 652e 6c65 6467  -shm', node.ledg
+00003560: 6572 5f70 6174 6820 2b20 272e 7465 6d70  er_path + '.temp
+00003570: 2d77 616c 275d 0a20 2020 2066 6f72 2066  -wal'].    for f
+00003580: 696c 6520 696e 2066 696c 6573 5f72 656d  ile in files_rem
+00003590: 6f76 653a 0a20 2020 2020 2020 2069 6620  ove:.        if 
+000035a0: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
+000035b0: 696c 6529 3a0a 2020 2020 2020 2020 2020  ile):.          
+000035c0: 2020 6f73 2e72 656d 6f76 6528 6669 6c65    os.remove(file
+000035d0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
+000035e0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+000035f0: 672e 7761 726e 696e 6728 6627 5265 6d6f  g.warning(f'Remo
+00003600: 7665 6420 6f6c 6420 7b66 696c 657d 2729  ved old {file}')
+00003610: 0a0a 2020 2020 6966 2072 6562 7569 6c64  ..    if rebuild
+00003620: 3a0a 2020 2020 2020 2020 6e6f 6465 2e6c  :.        node.l
+00003630: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+00003640: 726e 696e 6728 6627 5374 6174 7573 3a20  rning(f'Status: 
+00003650: 4879 7065 7262 6c6f 636b 7320 7769 6c6c  Hyperblocks will
+00003660: 2062 6520 7265 6275 696c 7427 290a 0a20   be rebuilt').. 
+00003670: 2020 2020 2020 2073 6875 7469 6c2e 636f         shutil.co
+00003680: 7079 286e 6f64 652e 6c65 6467 6572 5f70  py(node.ledger_p
+00003690: 6174 682c 206e 6f64 652e 6c65 6467 6572  ath, node.ledger
+000036a0: 5f70 6174 6820 2b20 272e 7465 6d70 2729  _path + '.temp')
+000036b0: 0a20 2020 2020 2020 2068 7970 6572 203d  .        hyper =
+000036c0: 2073 716c 6974 6533 2e63 6f6e 6e65 6374   sqlite3.connect
+000036d0: 286e 6f64 652e 6c65 6467 6572 5f70 6174  (node.ledger_pat
+000036e0: 6820 2b20 272e 7465 6d70 2729 0a20 2020  h + '.temp').   
+000036f0: 2065 6c73 653a 0a20 2020 2020 2020 2073   else:.        s
+00003700: 6875 7469 6c2e 636f 7079 286e 6f64 652e  hutil.copy(node.
+00003710: 6879 7065 725f 7061 7468 2c20 6e6f 6465  hyper_path, node
+00003720: 2e6c 6564 6765 725f 7061 7468 202b 2027  .ledger_path + '
+00003730: 2e74 656d 7027 290a 2020 2020 2020 2020  .temp').        
+00003740: 6879 7065 7220 3d20 7371 6c69 7465 332e  hyper = sqlite3.
+00003750: 636f 6e6e 6563 7428 6e6f 6465 2e6c 6564  connect(node.led
+00003760: 6765 725f 7061 7468 202b 2027 2e74 656d  ger_path + '.tem
+00003770: 7027 290a 2020 2020 6966 206e 6f64 652e  p').    if node.
+00003780: 7472 6163 655f 6462 5f63 616c 6c73 3a0a  trace_db_calls:.
+00003790: 2020 2020 2020 2020 6879 7065 722e 7365          hyper.se
+000037a0: 745f 7472 6163 655f 6361 6c6c 6261 636b  t_trace_callback
+000037b0: 2866 756e 6374 6f6f 6c73 2e70 6172 7469  (functools.parti
+000037c0: 616c 2873 716c 5f74 7261 6365 5f63 616c  al(sql_trace_cal
+000037d0: 6c62 6163 6b2c 206e 6f64 652e 6c6f 6767  lback, node.logg
+000037e0: 6572 2e61 7070 5f6c 6f67 2c20 2748 5950  er.app_log, 'HYP
+000037f0: 4552 2729 290a 2020 2020 6879 7065 722e  ER')).    hyper.
+00003800: 7465 7874 5f66 6163 746f 7279 203d 2073  text_factory = s
+00003810: 7472 0a20 2020 2068 7970 203d 2068 7970  tr.    hyp = hyp
+00003820: 6572 2e63 7572 736f 7228 290a 0a20 2020  er.cursor()..   
+00003830: 2068 7970 2e65 7865 6375 7465 2822 5550   hyp.execute("UP
+00003840: 4441 5445 2074 7261 6e73 6163 7469 6f6e  DATE transaction
+00003850: 7320 5345 5420 6164 6472 6573 7320 3d20  s SET address = 
+00003860: 2748 7970 6f62 6c6f 636b 2720 5748 4552  'Hypoblock' WHER
+00003870: 4520 6164 6472 6573 7320 3d20 2748 7970  E address = 'Hyp
+00003880: 6572 626c 6f63 6b27 2229 0a0a 2020 2020  erblock'")..    
+00003890: 6879 702e 6578 6563 7574 6528 2753 454c  hyp.execute('SEL
+000038a0: 4543 5420 6d61 7828 626c 6f63 6b5f 6865  ECT max(block_he
+000038b0: 6967 6874 2920 4652 4f4d 2074 7261 6e73  ight) FROM trans
+000038c0: 6163 7469 6f6e 7327 290a 2020 2020 6462  actions').    db
+000038d0: 5f62 6c6f 636b 5f68 6569 6768 7420 3d20  _block_height = 
+000038e0: 696e 7428 6879 702e 6665 7463 686f 6e65  int(hyp.fetchone
+000038f0: 2829 5b30 5d29 0a20 2020 2064 6570 7468  ()[0]).    depth
+00003900: 5f73 7065 6369 6669 6320 3d20 6462 5f62  _specific = db_b
+00003910: 6c6f 636b 5f68 6569 6768 7420 2d20 6465  lock_height - de
+00003920: 7074 680a 0a20 2020 2068 7970 2e65 7865  pth..    hyp.exe
+00003930: 6375 7465 280a 2020 2020 2020 2020 2753  cute(.        'S
+00003940: 454c 4543 5420 6469 7374 696e 6374 2872  ELECT distinct(r
+00003950: 6563 6970 6965 6e74 2920 4652 4f4d 2074  ecipient) FROM t
+00003960: 7261 6e73 6163 7469 6f6e 7320 5748 4552  ransactions WHER
+00003970: 4520 2862 6c6f 636b 5f68 6569 6768 7420  E (block_height 
+00003980: 3c20 3f20 414e 4420 626c 6f63 6b5f 6865  < ? AND block_he
+00003990: 6967 6874 203e 203f 2920 4f52 4445 5220  ight > ?) ORDER 
+000039a0: 4259 2062 6c6f 636b 5f68 6569 6768 743b  BY block_height;
+000039b0: 272c 0a20 2020 2020 2020 2028 0a20 2020  ',.        (.   
+000039c0: 2020 2020 2020 2020 2064 6570 7468 5f73           depth_s
+000039d0: 7065 6369 6669 632c 0a20 2020 2020 2020  pecific,.       
+000039e0: 2020 2020 202d 6465 7074 685f 7370 6563       -depth_spec
+000039f0: 6966 6963 2c0a 2020 2020 2020 2020 292c  ific,.        ),
+00003a00: 0a20 2020 2029 2020 2320 6e65 7720 6164  .    )  # new ad
+00003a10: 6472 6573 7365 7320 7769 6c6c 2062 6520  dresses will be 
+00003a20: 6967 6e6f 7265 6420 756e 7469 6c20 6465  ignored until de
+00003a30: 7074 6820 7061 7373 6564 0a20 2020 2075  pth passed.    u
+00003a40: 6e69 7175 655f 6164 6472 6573 7365 7373  nique_addressess
+00003a50: 203d 2068 7970 2e66 6574 6368 616c 6c28   = hyp.fetchall(
+00003a60: 290a 0a20 2020 2066 6f72 2078 2069 6e20  )..    for x in 
+00003a70: 7365 7428 756e 6971 7565 5f61 6464 7265  set(unique_addre
+00003a80: 7373 6573 7329 3a0a 2020 2020 2020 2020  ssess):.        
+00003a90: 6372 6564 6974 203d 2044 6563 696d 616c  credit = Decimal
+00003aa0: 2827 3027 290a 2020 2020 2020 2020 666f  ('0').        fo
+00003ab0: 7220 656e 7472 7920 696e 2068 7970 2e65  r entry in hyp.e
+00003ac0: 7865 6375 7465 280a 2020 2020 2020 2020  xecute(.        
+00003ad0: 2020 2020 2753 454c 4543 5420 616d 6f75      'SELECT amou
+00003ae0: 6e74 2c72 6577 6172 6420 4652 4f4d 2074  nt,reward FROM t
+00003af0: 7261 6e73 6163 7469 6f6e 7320 5748 4552  ransactions WHER
+00003b00: 4520 7265 6369 7069 656e 7420 3d20 3f20  E recipient = ? 
+00003b10: 414e 4420 2862 6c6f 636b 5f68 6569 6768  AND (block_heigh
+00003b20: 7420 3c20 3f20 414e 4420 626c 6f63 6b5f  t < ? AND block_
+00003b30: 6865 6967 6874 203e 203f 293b 272c 0a20  height > ?);',. 
+00003b40: 2020 2020 2020 2020 2020 2028 785b 305d             (x[0]
+00003b50: 2c20 2920 2b20 280a 2020 2020 2020 2020  , ) + (.        
+00003b60: 2020 2020 2020 2020 6465 7074 685f 7370          depth_sp
+00003b70: 6563 6966 6963 2c0a 2020 2020 2020 2020  ecific,.        
+00003b80: 2020 2020 2020 2020 2d64 6570 7468 5f73          -depth_s
+00003b90: 7065 6369 6669 632c 0a20 2020 2020 2020  pecific,.       
+00003ba0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00003bb0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00003bc0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00003bd0: 2020 2020 6372 6564 6974 203d 2071 7561      credit = qua
+00003be0: 6e74 697a 655f 6569 6768 7428 6372 6564  ntize_eight(cred
+00003bf0: 6974 2920 2b20 7175 616e 7469 7a65 5f65  it) + quantize_e
+00003c00: 6967 6874 2865 6e74 7279 5b30 5d29 202b  ight(entry[0]) +
+00003c10: 2071 7561 6e74 697a 655f 6569 6768 7428   quantize_eight(
+00003c20: 656e 7472 795b 315d 290a 2020 2020 2020  entry[1]).      
+00003c30: 2020 2020 2020 2020 2020 6372 6564 6974            credit
+00003c40: 203d 2030 2069 6620 6372 6564 6974 2069   = 0 if credit i
+00003c50: 7320 4e6f 6e65 2065 6c73 6520 6372 6564  s None else cred
+00003c60: 6974 0a20 2020 2020 2020 2020 2020 2065  it.            e
+00003c70: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00003c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003c90: 2063 7265 6469 7420 3d20 300a 0a20 2020   credit = 0..   
+00003ca0: 2020 2020 2064 6562 6974 203d 2044 6563       debit = Dec
+00003cb0: 696d 616c 2827 3027 290a 2020 2020 2020  imal('0').      
+00003cc0: 2020 666f 7220 656e 7472 7920 696e 2068    for entry in h
+00003cd0: 7970 2e65 7865 6375 7465 280a 2020 2020  yp.execute(.    
+00003ce0: 2020 2020 2020 2020 2753 454c 4543 5420          'SELECT 
+00003cf0: 616d 6f75 6e74 2c66 6565 2046 524f 4d20  amount,fee FROM 
+00003d00: 7472 616e 7361 6374 696f 6e73 2057 4845  transactions WHE
+00003d10: 5245 2061 6464 7265 7373 203d 203f 2041  RE address = ? A
+00003d20: 4e44 2028 626c 6f63 6b5f 6865 6967 6874  ND (block_height
+00003d30: 203c 203f 2041 4e44 2062 6c6f 636b 5f68   < ? AND block_h
+00003d40: 6569 6768 7420 3e20 3f29 3b27 2c0a 2020  eight > ?);',.  
+00003d50: 2020 2020 2020 2020 2020 2878 5b30 5d2c            (x[0],
+00003d60: 2029 202b 2028 0a20 2020 2020 2020 2020   ) + (.         
+00003d70: 2020 2020 2020 2064 6570 7468 5f73 7065         depth_spe
+00003d80: 6369 6669 632c 0a20 2020 2020 2020 2020  cific,.         
+00003d90: 2020 2020 2020 202d 6465 7074 685f 7370         -depth_sp
+00003da0: 6563 6966 6963 2c0a 2020 2020 2020 2020  ecific,.        
+00003db0: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
+00003dc0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00003dd0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00003de0: 2020 2064 6562 6974 203d 2071 7561 6e74     debit = quant
+00003df0: 697a 655f 6569 6768 7428 6465 6269 7429  ize_eight(debit)
+00003e00: 202b 2071 7561 6e74 697a 655f 6569 6768   + quantize_eigh
+00003e10: 7428 656e 7472 795b 305d 2920 2b20 7175  t(entry[0]) + qu
+00003e20: 616e 7469 7a65 5f65 6967 6874 2865 6e74  antize_eight(ent
+00003e30: 7279 5b31 5d29 0a20 2020 2020 2020 2020  ry[1]).         
+00003e40: 2020 2020 2020 2064 6562 6974 203d 2030         debit = 0
+00003e50: 2069 6620 6465 6269 7420 6973 204e 6f6e   if debit is Non
+00003e60: 6520 656c 7365 2064 6562 6974 0a20 2020  e else debit.   
+00003e70: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00003e80: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00003e90: 2020 2020 2020 2020 2020 2064 6562 6974             debit
+00003ea0: 203d 2030 0a0a 2020 2020 2020 2020 656e   = 0..        en
+00003eb0: 645f 6261 6c61 6e63 6520 3d20 7175 616e  d_balance = quan
+00003ec0: 7469 7a65 5f65 6967 6874 2863 7265 6469  tize_eight(credi
+00003ed0: 7420 2d20 6465 6269 7429 0a0a 2020 2020  t - debit)..    
+00003ee0: 2020 2020 6966 2065 6e64 5f62 616c 616e      if end_balan
+00003ef0: 6365 203e 2030 3a0a 2020 2020 2020 2020  ce > 0:.        
+00003f00: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+00003f10: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
+00003f20: 0a20 2020 2020 2020 2020 2020 2068 7970  .            hyp
+00003f30: 2e65 7865 6375 7465 2827 494e 5345 5254  .execute('INSERT
+00003f40: 2049 4e54 4f20 7472 616e 7361 6374 696f   INTO transactio
+00003f50: 6e73 2056 414c 5545 5320 283f 2c3f 2c3f  ns VALUES (?,?,?
+00003f60: 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f 2c3f  ,?,?,?,?,?,?,?,?
+00003f70: 2c3f 2927 2c20 2864 6570 7468 5f73 7065  ,?)', (depth_spe
+00003f80: 6369 6669 6320 2d20 312c 2074 696d 6573  cific - 1, times
+00003f90: 7461 6d70 2c20 2748 7970 6572 626c 6f63  tamp, 'Hyperbloc
+00003fa0: 6b27 2c20 785b 305d 2c20 7374 7228 656e  k', x[0], str(en
+00003fb0: 645f 6261 6c61 6e63 6529 2c20 2730 272c  d_balance), '0',
+00003fc0: 2027 3027 2c20 2730 272c 2027 3027 2c20   '0', '0', '0', 
+00003fd0: 2730 272c 2027 3027 2c20 2730 2729 290a  '0', '0', '0')).
+00003fe0: 2020 2020 6879 7065 722e 636f 6d6d 6974      hyper.commit
+00003ff0: 2829 0a0a 2020 2020 6879 702e 6578 6563  ()..    hyp.exec
+00004000: 7574 6528 2244 454c 4554 4520 4652 4f4d  ute("DELETE FROM
+00004010: 2074 7261 6e73 6163 7469 6f6e 7320 5748   transactions WH
+00004020: 4552 4520 6164 6472 6573 7320 213d 2027  ERE address != '
+00004030: 4879 7065 7262 6c6f 636b 2720 414e 4420  Hyperblock' AND 
+00004040: 2862 6c6f 636b 5f68 6569 6768 7420 3c20  (block_height < 
+00004050: 3f20 414e 4420 626c 6f63 6b5f 6865 6967  ? AND block_heig
+00004060: 6874 203e 203f 293b 222c 2028 0a20 2020  ht > ?);", (.   
+00004070: 2020 2020 2064 6570 7468 5f73 7065 6369       depth_speci
+00004080: 6669 632c 0a20 2020 2020 2020 202d 6465  fic,.        -de
+00004090: 7074 685f 7370 6563 6966 6963 2c0a 2020  pth_specific,.  
+000040a0: 2020 2929 0a20 2020 2068 7970 6572 2e63    )).    hyper.c
+000040b0: 6f6d 6d69 7428 290a 0a20 2020 2068 7970  ommit()..    hyp
+000040c0: 2e65 7865 6375 7465 280a 2020 2020 2020  .execute(.      
+000040d0: 2020 2744 454c 4554 4520 4652 4f4d 206d    'DELETE FROM m
+000040e0: 6973 6320 5748 4552 4520 2862 6c6f 636b  isc WHERE (block
+000040f0: 5f68 6569 6768 7420 3c20 3f20 414e 4420  _height < ? AND 
+00004100: 626c 6f63 6b5f 6865 6967 6874 203e 203f  block_height > ?
+00004110: 293b 272c 0a20 2020 2020 2020 2028 0a20  );',.        (. 
+00004120: 2020 2020 2020 2020 2020 2064 6570 7468             depth
+00004130: 5f73 7065 6369 6669 632c 0a20 2020 2020  _specific,.     
+00004140: 2020 2020 2020 202d 6465 7074 685f 7370         -depth_sp
+00004150: 6563 6966 6963 2c0a 2020 2020 2020 2020  ecific,.        
+00004160: 292c 0a20 2020 2029 2020 2320 7265 6d6f  ),.    )  # remo
+00004170: 7665 2064 6966 6620 6361 6c63 0a20 2020  ve diff calc.   
+00004180: 2068 7970 6572 2e63 6f6d 6d69 7428 290a   hyper.commit().
+00004190: 0a20 2020 2068 7970 2e65 7865 6375 7465  .    hyp.execute
+000041a0: 2827 5641 4355 554d 2729 0a20 2020 2068  ('VACUUM').    h
+000041b0: 7970 6572 2e63 6c6f 7365 2829 0a0a 2020  yper.close()..  
+000041c0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
+000041d0: 7374 7328 6e6f 6465 2e68 7970 6572 5f70  sts(node.hyper_p
+000041e0: 6174 6829 3a0a 2020 2020 2020 2020 6f73  ath):.        os
+000041f0: 2e72 656d 6f76 6528 6e6f 6465 2e68 7970  .remove(node.hyp
+00004200: 6572 5f70 6174 6829 2020 2320 7265 6d6f  er_path)  # remo
+00004210: 7665 2074 6865 206f 6c64 2068 7970 6572  ve the old hyper
+00004220: 626c 6f63 6b73 2074 6f20 7265 6275 696c  blocks to rebuil
+00004230: 640a 2020 2020 2020 2020 6f73 2e72 656e  d.        os.ren
+00004240: 616d 6528 6e6f 6465 2e6c 6564 6765 725f  ame(node.ledger_
+00004250: 7061 7468 202b 2027 2e74 656d 7027 2c20  path + '.temp', 
+00004260: 6e6f 6465 2e68 7970 6572 5f70 6174 6829  node.hyper_path)
+00004270: 0a0a 0a64 6566 206c 6564 6765 725f 6368  ...def ledger_ch
+00004280: 6563 6b5f 6865 6967 6874 7328 6e6f 6465  eck_heights(node
+00004290: 2c20 6462 5f68 616e 646c 6572 293a 0a20  , db_handler):. 
+000042a0: 2020 2067 6c6f 6261 6c20 6462 5f68 616e     global db_han
+000042b0: 646c 6572 5f69 6e69 7469 616c 0a20 2020  dler_initial.   
+000042c0: 2023 2054 4f44 4f3a 2043 616e 6469 6461   # TODO: Candida
+000042d0: 7465 2066 6f72 2073 696e 676c 6520 7573  te for single us
+000042e0: 6572 206d 6f64 650a 2020 2020 2222 2263  er mode.    """c
+000042f0: 6f6e 7665 7273 696f 6e20 6f66 206e 6f72  onversion of nor
+00004300: 6d61 6c20 626c 6f63 6b73 2069 6e74 6f20  mal blocks into 
+00004310: 6879 7065 7262 6c6f 636b 7320 6672 6f6d  hyperblocks from
+00004320: 206c 6564 6765 722e 6462 206f 7220 6879   ledger.db or hy
+00004330: 7065 722e 6462 2074 6f20 6879 7065 722e  per.db to hyper.
+00004340: 6462 2222 220a 2020 2020 6966 206f 732e  db""".    if os.
+00004350: 7061 7468 2e65 7869 7374 7328 6e6f 6465  path.exists(node
+00004360: 2e68 7970 6572 5f70 6174 6829 3a0a 0a20  .hyper_path):.. 
+00004370: 2020 2020 2020 2023 2063 726f 7373 2d69         # cross-i
+00004380: 6e74 6567 7269 7479 2063 6865 636b 0a20  ntegrity check. 
+00004390: 2020 2020 2020 2068 6464 5f62 6c6f 636b         hdd_block
+000043a0: 5f6d 6178 203d 2064 625f 6861 6e64 6c65  _max = db_handle
+000043b0: 722e 626c 6f63 6b5f 6865 6967 6874 5f6d  r.block_height_m
+000043c0: 6178 2829 0a20 2020 2020 2020 2068 6464  ax().        hdd
+000043d0: 5f62 6c6f 636b 5f6d 6178 5f64 6966 6620  _block_max_diff 
+000043e0: 3d20 6462 5f68 616e 646c 6572 2e62 6c6f  = db_handler.blo
+000043f0: 636b 5f68 6569 6768 745f 6d61 785f 6469  ck_height_max_di
+00004400: 6666 2829 0a20 2020 2020 2020 2068 6464  ff().        hdd
+00004410: 325f 626c 6f63 6b5f 6c61 7374 203d 2064  2_block_last = d
+00004420: 625f 6861 6e64 6c65 722e 626c 6f63 6b5f  b_handler.block_
+00004430: 6865 6967 6874 5f6d 6178 5f68 7970 6572  height_max_hyper
+00004440: 2829 0a20 2020 2020 2020 2068 6464 325f  ().        hdd2_
+00004450: 626c 6f63 6b5f 6c61 7374 5f6d 6973 6320  block_last_misc 
+00004460: 3d20 6462 5f68 616e 646c 6572 2e62 6c6f  = db_handler.blo
+00004470: 636b 5f68 6569 6768 745f 6d61 785f 6469  ck_height_max_di
+00004480: 6666 5f68 7970 6572 2829 0a0a 2020 2020  ff_hyper()..    
+00004490: 2020 2020 2320 6372 6f73 732d 696e 7465      # cross-inte
+000044a0: 6772 6974 7920 6368 6563 6b0a 2020 2020  grity check.    
+000044b0: 2020 2020 6966 2068 6464 5f62 6c6f 636b      if hdd_block
+000044c0: 5f6d 6178 203d 3d20 6864 6432 5f62 6c6f  _max == hdd2_blo
+000044d0: 636b 5f6c 6173 7420 3d3d 2068 6464 325f  ck_last == hdd2_
+000044e0: 626c 6f63 6b5f 6c61 7374 5f6d 6973 6320  block_last_misc 
+000044f0: 3d3d 2068 6464 5f62 6c6f 636b 5f6d 6178  == hdd_block_max
+00004500: 5f64 6966 6620 616e 6420 6e6f 6465 2e68  _diff and node.h
+00004510: 7970 6572 5f72 6563 6f6d 7072 6573 733a  yper_recompress:
+00004520: 2020 2320 6372 6f73 732d 696e 7465 6772    # cross-integr
+00004530: 6974 7920 6368 6563 6b0a 2020 2020 2020  ity check.      
+00004540: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00004550: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00004560: 6728 2753 7461 7475 733a 2052 6563 6f6d  g('Status: Recom
+00004570: 7072 6573 7369 6e67 2068 7970 6572 626c  pressing hyperbl
+00004580: 6f63 6b73 2028 6b65 6570 696e 6720 6675  ocks (keeping fu
+00004590: 6c6c 206c 6564 6765 7229 2729 0a20 2020  ll ledger)').   
+000045a0: 2020 2020 2020 2020 206e 6f64 652e 7265           node.re
+000045b0: 636f 6d70 7265 7373 203d 2054 7275 650a  compress = True.
+000045c0: 0a20 2020 2020 2020 2020 2020 2023 7072  .            #pr
+000045d0: 696e 7420 2868 6464 5f62 6c6f 636b 5f6d  int (hdd_block_m
+000045e0: 6178 2c68 6464 325f 626c 6f63 6b5f 6c61  ax,hdd2_block_la
+000045f0: 7374 2c6e 6f64 652e 6879 7065 725f 7265  st,node.hyper_re
+00004600: 636f 6d70 7265 7373 290a 2020 2020 2020  compress).      
+00004610: 2020 656c 6966 2068 6464 5f62 6c6f 636b    elif hdd_block
+00004620: 5f6d 6178 203d 3d20 6864 6432 5f62 6c6f  _max == hdd2_blo
+00004630: 636b 5f6c 6173 7420 616e 6420 6e6f 7420  ck_last and not 
+00004640: 6e6f 6465 2e68 7970 6572 5f72 6563 6f6d  node.hyper_recom
+00004650: 7072 6573 733a 0a20 2020 2020 2020 2020  press:.         
+00004660: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+00004670: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
+00004680: 5374 6174 7573 3a20 4879 7065 7262 6c6f  Status: Hyperblo
+00004690: 636b 2072 6563 6f6d 7072 6573 7369 6f6e  ck recompression
+000046a0: 2073 6b69 7070 6564 2729 0a20 2020 2020   skipped').     
+000046b0: 2020 2020 2020 206e 6f64 652e 7265 636f         node.reco
+000046c0: 6d70 7265 7373 203d 2046 616c 7365 0a20  mpress = False. 
+000046d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000046e0: 2020 2020 2020 2020 206c 6f77 6573 745f           lowest_
+000046f0: 626c 6f63 6b20 3d20 6d69 6e28 6864 645f  block = min(hdd_
+00004700: 626c 6f63 6b5f 6d61 782c 2068 6464 325f  block_max, hdd2_
+00004710: 626c 6f63 6b5f 6c61 7374 2c20 6864 645f  block_last, hdd_
+00004720: 626c 6f63 6b5f 6d61 785f 6469 6666 2c20  block_max_diff, 
+00004730: 6864 6432 5f62 6c6f 636b 5f6c 6173 745f  hdd2_block_last_
+00004740: 6d69 7363 290a 2020 2020 2020 2020 2020  misc).          
+00004750: 2020 6869 6768 6573 745f 626c 6f63 6b20    highest_block 
+00004760: 3d20 6d61 7828 6864 645f 626c 6f63 6b5f  = max(hdd_block_
+00004770: 6d61 782c 2068 6464 325f 626c 6f63 6b5f  max, hdd2_block_
+00004780: 6c61 7374 2c20 6864 645f 626c 6f63 6b5f  last, hdd_block_
+00004790: 6d61 785f 6469 6666 2c20 6864 6432 5f62  max_diff, hdd2_b
+000047a0: 6c6f 636b 5f6c 6173 745f 6d69 7363 290a  lock_last_misc).
+000047b0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+000047c0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+000047d0: 2e77 6172 6e69 6e67 2866 2753 7461 7475  .warning(f'Statu
+000047e0: 733a 2043 726f 7373 2d69 6e74 6567 7269  s: Cross-integri
+000047f0: 7479 2063 6865 636b 2066 6169 6c65 642c  ty check failed,
+00004800: 207b 6869 6768 6573 745f 626c 6f63 6b7d   {highest_block}
+00004810: 2077 696c 6c20 6265 2072 6f6c 6c65 6420   will be rolled 
+00004820: 6261 636b 2062 656c 6f77 207b 6c6f 7765  back below {lowe
+00004830: 7374 5f62 6c6f 636b 7d27 290a 0a20 2020  st_block}')..   
+00004840: 2020 2020 2020 2020 2072 6f6c 6c62 6163           rollbac
+00004850: 6b28 6e6f 6465 2c20 6462 5f68 616e 646c  k(node, db_handl
+00004860: 6572 5f69 6e69 7469 616c 2c20 6c6f 7765  er_initial, lowe
+00004870: 7374 5f62 6c6f 636b 2920 2023 726f 6c6c  st_block)  #roll
+00004880: 6261 636b 2074 6f20 7468 6520 6c6f 7765  back to the lowe
+00004890: 7374 2076 616c 7565 0a20 2020 2020 2020  st value.       
+000048a0: 2020 2020 206e 6f64 652e 7265 636f 6d70       node.recomp
+000048b0: 7265 7373 203d 2046 616c 7365 0a0a 2020  ress = False..  
+000048c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000048d0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+000048e0: 6c6f 672e 7761 726e 696e 6728 2753 7461  log.warning('Sta
+000048f0: 7475 733a 2043 6f6d 7072 6573 7369 6e67  tus: Compressing
+00004900: 206c 6564 6765 7220 746f 2048 7970 6572   ledger to Hyper
+00004910: 626c 6f63 6b73 2729 0a20 2020 2020 2020  blocks').       
+00004920: 206e 6f64 652e 7265 636f 6d70 7265 7373   node.recompress
+00004930: 203d 2054 7275 650a 0a0a 6465 6620 6269   = True...def bi
+00004940: 6e5f 636f 6e76 6572 7428 7374 7269 6e67  n_convert(string
+00004950: 293a 0a20 2020 2023 2054 4f44 4f3a 204d  ):.    # TODO: M
+00004960: 6f76 6520 746f 2065 7373 656e 7469 616c  ove to essential
+00004970: 732e 7079 0a20 2020 2072 6574 7572 6e20  s.py.    return 
+00004980: 2727 2e6a 6f69 6e28 666f 726d 6174 286f  ''.join(format(o
+00004990: 7264 2878 292c 2027 3862 2729 2e72 6570  rd(x), '8b').rep
+000049a0: 6c61 6365 2827 2027 2c20 2730 2729 2066  lace(' ', '0') f
+000049b0: 6f72 2078 2069 6e20 7374 7269 6e67 290a  or x in string).
+000049c0: 0a0a 6465 6620 6261 6c61 6e63 6567 6574  ..def balanceget
+000049d0: 2862 616c 616e 6365 5f61 6464 7265 7373  (balance_address
+000049e0: 2c20 6462 5f68 616e 646c 6572 293a 0a20  , db_handler):. 
+000049f0: 2020 2023 2054 4f44 4f3a 2054 6f20 6d6f     # TODO: To mo
+00004a00: 7665 2069 6e20 6462 5f68 616e 646c 6572  ve in db_handler
+00004a10: 2c20 6361 6c6c 2062 7920 6462 5f68 616e  , call by db_han
+00004a20: 646c 6572 2e62 616c 616e 6365 5f67 6574  dler.balance_get
+00004a30: 2861 6464 7265 7373 290a 2020 2020 2320  (address).    # 
+00004a40: 7665 7269 6679 2062 616c 616e 6365 0a0a  verify balance..
+00004a50: 2020 2020 2320 6e6f 6465 2e6c 6f67 6765      # node.logge
+00004a60: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00004a70: 224d 656d 706f 6f6c 3a20 5665 7269 6679  "Mempool: Verify
+00004a80: 696e 6720 6261 6c61 6e63 6522 290a 2020  ing balance").  
+00004a90: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+00004aa0: 705f 6c6f 672e 6465 6275 6728 224e 6f64  p_log.debug("Nod
+00004ab0: 653a 2052 6563 6569 7665 6420 6164 6472  e: Received addr
+00004ac0: 6573 7320 666f 7220 6261 6c61 6e63 6567  ess for balanceg
+00004ad0: 6574 3a20 2220 2b20 7374 7228 6261 6c61  et: " + str(bala
+00004ae0: 6e63 655f 6164 6472 6573 7329 290a 0a20  nce_address)).. 
+00004af0: 2020 2062 6173 655f 6d65 6d70 6f6f 6c20     base_mempool 
+00004b00: 3d20 6d70 2e4d 454d 504f 4f4c 2e6d 705f  = mp.MEMPOOL.mp_
+00004b10: 6765 7428 6261 6c61 6e63 655f 6164 6472  get(balance_addr
+00004b20: 6573 7329 0a0a 2020 2020 2320 696e 636c  ess)..    # incl
+00004b30: 7564 6520 6d65 6d70 6f6f 6c20 6665 6573  ude mempool fees
+00004b40: 0a0a 2020 2020 6465 6269 745f 6d65 6d70  ..    debit_memp
+00004b50: 6f6f 6c20 3d20 300a 2020 2020 6966 2062  ool = 0.    if b
+00004b60: 6173 655f 6d65 6d70 6f6f 6c3a 0a20 2020  ase_mempool:.   
+00004b70: 2020 2020 2066 6f72 2078 2069 6e20 6261       for x in ba
+00004b80: 7365 5f6d 656d 706f 6f6c 3a0a 2020 2020  se_mempool:.    
+00004b90: 2020 2020 2020 2020 6465 6269 745f 7478          debit_tx
+00004ba0: 203d 2044 6563 696d 616c 2878 5b30 5d29   = Decimal(x[0])
+00004bb0: 0a20 2020 2020 2020 2020 2020 2066 6565  .            fee
+00004bc0: 203d 2065 7373 656e 7469 616c 732e 6665   = essentials.fe
+00004bd0: 655f 6361 6c63 756c 6174 6528 785b 315d  e_calculate(x[1]
+00004be0: 2c20 785b 325d 2c20 6e6f 6465 2e6c 6173  , x[2], node.las
+00004bf0: 745f 626c 6f63 6b29 0a20 2020 2020 2020  t_block).       
+00004c00: 2020 2020 2064 6562 6974 5f6d 656d 706f       debit_mempo
+00004c10: 6f6c 203d 2071 7561 6e74 697a 655f 6569  ol = quantize_ei
+00004c20: 6768 7428 6465 6269 745f 6d65 6d70 6f6f  ght(debit_mempoo
+00004c30: 6c20 2b20 6465 6269 745f 7478 202b 2066  l + debit_tx + f
+00004c40: 6565 290a 2020 2020 656c 7365 3a0a 2020  ee).    else:.  
+00004c50: 2020 2020 2020 6465 6269 745f 6d65 6d70        debit_memp
+00004c60: 6f6f 6c20 3d20 300a 2020 2020 2320 696e  ool = 0.    # in
+00004c70: 636c 7564 6520 6d65 6d70 6f6f 6c20 6665  clude mempool fe
+00004c80: 6573 0a0a 2020 2020 6372 6564 6974 5f6c  es..    credit_l
+00004c90: 6564 6765 7220 3d20 4465 6369 6d61 6c28  edger = Decimal(
+00004ca0: 2730 2729 0a0a 2020 2020 7472 793a 0a20  '0')..    try:. 
+00004cb0: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00004cc0: 722e 6578 6563 7574 655f 7061 7261 6d28  r.execute_param(
+00004cd0: 6462 5f68 616e 646c 6572 2e68 2c20 2753  db_handler.h, 'S
+00004ce0: 454c 4543 5420 616d 6f75 6e74 2046 524f  ELECT amount FRO
+00004cf0: 4d20 7472 616e 7361 6374 696f 6e73 2057  M transactions W
+00004d00: 4845 5245 2072 6563 6970 6965 6e74 203d  HERE recipient =
+00004d10: 203f 3b27 2c20 2862 616c 616e 6365 5f61   ?;', (balance_a
+00004d20: 6464 7265 7373 2c20 2929 0a20 2020 2020  ddress, )).     
+00004d30: 2020 2065 6e74 7269 6573 203d 2064 625f     entries = db_
+00004d40: 6861 6e64 6c65 722e 682e 6665 7463 6861  handler.h.fetcha
+00004d50: 6c6c 2829 0a20 2020 2065 7863 6570 743a  ll().    except:
+00004d60: 0a20 2020 2020 2020 2065 6e74 7269 6573  .        entries
+00004d70: 203d 205b 5d0a 2020 2020 2320 7072 696e   = [].    # prin
+00004d80: 7428 2772 6563 6970 6965 6e74 272c 2064  t('recipient', d
+00004d90: 6562 6974 5f6d 656d 706f 6f6c 2c20 656e  ebit_mempool, en
+00004da0: 7472 6965 7329 0a0a 2020 2020 7472 793a  tries)..    try:
+00004db0: 0a20 2020 2020 2020 2066 6f72 2065 6e74  .        for ent
+00004dc0: 7279 2069 6e20 656e 7472 6965 733a 0a20  ry in entries:. 
+00004dd0: 2020 2020 2020 2020 2020 2063 7265 6469             credi
+00004de0: 745f 6c65 6467 6572 203d 2071 7561 6e74  t_ledger = quant
+00004df0: 697a 655f 6569 6768 7428 6372 6564 6974  ize_eight(credit
+00004e00: 5f6c 6564 6765 7229 202b 2071 7561 6e74  _ledger) + quant
+00004e10: 697a 655f 6569 6768 7428 656e 7472 795b  ize_eight(entry[
+00004e20: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+00004e30: 6372 6564 6974 5f6c 6564 6765 7220 3d20  credit_ledger = 
+00004e40: 3020 6966 2063 7265 6469 745f 6c65 6467  0 if credit_ledg
+00004e50: 6572 2069 7320 4e6f 6e65 2065 6c73 6520  er is None else 
+00004e60: 6372 6564 6974 5f6c 6564 6765 720a 2020  credit_ledger.  
+00004e70: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+00004e80: 2020 6372 6564 6974 5f6c 6564 6765 7220    credit_ledger 
+00004e90: 3d20 300a 0a20 2020 2066 6565 7320 3d20  = 0..    fees = 
+00004ea0: 4465 6369 6d61 6c28 2730 2729 0a20 2020  Decimal('0').   
+00004eb0: 2064 6562 6974 5f6c 6564 6765 7220 3d20   debit_ledger = 
+00004ec0: 4465 6369 6d61 6c28 2730 2729 0a0a 2020  Decimal('0')..  
+00004ed0: 2020 7472 793a 0a20 2020 2020 2020 2064    try:.        d
+00004ee0: 625f 6861 6e64 6c65 722e 6578 6563 7574  b_handler.execut
+00004ef0: 655f 7061 7261 6d28 6462 5f68 616e 646c  e_param(db_handl
+00004f00: 6572 2e68 2c20 2753 454c 4543 5420 6665  er.h, 'SELECT fe
+00004f10: 652c 2061 6d6f 756e 7420 4652 4f4d 2074  e, amount FROM t
+00004f20: 7261 6e73 6163 7469 6f6e 7320 5748 4552  ransactions WHER
+00004f30: 4520 6164 6472 6573 7320 3d20 3f3b 272c  E address = ?;',
+00004f40: 2028 6261 6c61 6e63 655f 6164 6472 6573   (balance_addres
+00004f50: 732c 2029 290a 2020 2020 2020 2020 656e  s, )).        en
+00004f60: 7472 6965 7320 3d20 6462 5f68 616e 646c  tries = db_handl
+00004f70: 6572 2e68 2e66 6574 6368 616c 6c28 290a  er.h.fetchall().
+00004f80: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00004f90: 2020 2020 656e 7472 6965 7320 3d20 5b5d      entries = []
+00004fa0: 0a20 2020 2023 2070 7269 6e74 2827 746f  .    # print('to
+00004fb0: 2061 6464 7265 7373 272c 2065 6e74 7269   address', entri
+00004fc0: 6573 290a 0a20 2020 2074 7279 3a0a 2020  es)..    try:.  
+00004fd0: 2020 2020 2020 666f 7220 656e 7472 7920        for entry 
+00004fe0: 696e 2065 6e74 7269 6573 3a0a 2020 2020  in entries:.    
+00004ff0: 2020 2020 2020 2020 6665 6573 203d 2071          fees = q
+00005000: 7561 6e74 697a 655f 6569 6768 7428 6665  uantize_eight(fe
+00005010: 6573 2920 2b20 7175 616e 7469 7a65 5f65  es) + quantize_e
+00005020: 6967 6874 2865 6e74 7279 5b30 5d29 0a20  ight(entry[0]). 
+00005030: 2020 2020 2020 2020 2020 2066 6565 7320             fees 
+00005040: 3d20 3020 6966 2066 6565 7320 6973 204e  = 0 if fees is N
+00005050: 6f6e 6520 656c 7365 2066 6565 730a 2020  one else fees.  
+00005060: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+00005070: 2020 6665 6573 203d 2030 0a0a 2020 2020    fees = 0..    
+00005080: 7472 793a 0a20 2020 2020 2020 2066 6f72  try:.        for
+00005090: 2065 6e74 7279 2069 6e20 656e 7472 6965   entry in entrie
+000050a0: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
+000050b0: 6562 6974 5f6c 6564 6765 7220 3d20 6465  ebit_ledger = de
+000050c0: 6269 745f 6c65 6467 6572 202b 2044 6563  bit_ledger + Dec
+000050d0: 696d 616c 2865 6e74 7279 5b31 5d29 0a20  imal(entry[1]). 
+000050e0: 2020 2020 2020 2020 2020 2064 6562 6974             debit
+000050f0: 5f6c 6564 6765 7220 3d20 3020 6966 2064  _ledger = 0 if d
+00005100: 6562 6974 5f6c 6564 6765 7220 6973 204e  ebit_ledger is N
+00005110: 6f6e 6520 656c 7365 2064 6562 6974 5f6c  one else debit_l
+00005120: 6564 6765 720a 2020 2020 6578 6365 7074  edger.    except
+00005130: 3a0a 2020 2020 2020 2020 6465 6269 745f  :.        debit_
+00005140: 6c65 6467 6572 203d 2030 0a0a 2020 2020  ledger = 0..    
+00005150: 6465 6269 7420 3d20 7175 616e 7469 7a65  debit = quantize
+00005160: 5f65 6967 6874 2864 6562 6974 5f6c 6564  _eight(debit_led
+00005170: 6765 7220 2b20 6465 6269 745f 6d65 6d70  ger + debit_memp
+00005180: 6f6f 6c29 0a0a 2020 2020 7265 7761 7264  ool)..    reward
+00005190: 7320 3d20 4465 6369 6d61 6c28 2730 2729  s = Decimal('0')
+000051a0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+000051b0: 2020 2064 625f 6861 6e64 6c65 722e 6578     db_handler.ex
+000051c0: 6563 7574 655f 7061 7261 6d28 6462 5f68  ecute_param(db_h
+000051d0: 616e 646c 6572 2e68 2c20 2753 454c 4543  andler.h, 'SELEC
+000051e0: 5420 7265 7761 7264 2046 524f 4d20 7472  T reward FROM tr
+000051f0: 616e 7361 6374 696f 6e73 2057 4845 5245  ansactions WHERE
+00005200: 2072 6563 6970 6965 6e74 203d 203f 3b27   recipient = ?;'
+00005210: 2c20 2862 616c 616e 6365 5f61 6464 7265  , (balance_addre
+00005220: 7373 2c20 2929 0a20 2020 2020 2020 2065  ss, )).        e
+00005230: 6e74 7269 6573 203d 2064 625f 6861 6e64  ntries = db_hand
+00005240: 6c65 722e 682e 6665 7463 6861 6c6c 2829  ler.h.fetchall()
+00005250: 0a20 2020 2065 7863 6570 743a 0a20 2020  .    except:.   
+00005260: 2020 2020 2065 6e74 7269 6573 203d 205b       entries = [
+00005270: 5d0a 2020 2020 2320 7072 696e 7428 2772  ].    # print('r
+00005280: 6577 6172 6427 2c20 656e 7472 6965 7329  eward', entries)
+00005290: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+000052a0: 2020 2066 6f72 2065 6e74 7279 2069 6e20     for entry in 
+000052b0: 656e 7472 6965 733a 0a20 2020 2020 2020  entries:.       
+000052c0: 2020 2020 2072 6577 6172 6473 203d 2071       rewards = q
+000052d0: 7561 6e74 697a 655f 6569 6768 7428 7265  uantize_eight(re
+000052e0: 7761 7264 7329 202b 2071 7561 6e74 697a  wards) + quantiz
+000052f0: 655f 6569 6768 7428 656e 7472 795b 305d  e_eight(entry[0]
+00005300: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00005310: 7761 7264 7320 3d20 3020 6966 2073 7472  wards = 0 if str
+00005320: 2872 6577 6172 6473 2920 3d3d 2027 3045  (rewards) == '0E
+00005330: 2d38 2720 656c 7365 2072 6577 6172 6473  -8' else rewards
+00005340: 0a20 2020 2020 2020 2020 2020 2072 6577  .            rew
+00005350: 6172 6473 203d 2030 2069 6620 7265 7761  ards = 0 if rewa
+00005360: 7264 7320 6973 204e 6f6e 6520 656c 7365  rds is None else
+00005370: 2072 6577 6172 6473 0a20 2020 2065 7863   rewards.    exc
+00005380: 6570 743a 0a20 2020 2020 2020 2072 6577  ept:.        rew
+00005390: 6172 6473 203d 2030 0a0a 2020 2020 6261  ards = 0..    ba
+000053a0: 6c61 6e63 6520 3d20 7175 616e 7469 7a65  lance = quantize
+000053b0: 5f65 6967 6874 2863 7265 6469 745f 6c65  _eight(credit_le
+000053c0: 6467 6572 202d 2064 6562 6974 202d 2066  dger - debit - f
+000053d0: 6565 7320 2b20 7265 7761 7264 7329 0a20  ees + rewards). 
+000053e0: 2020 2062 616c 616e 6365 5f6e 6f5f 6d65     balance_no_me
+000053f0: 6d70 6f6f 6c20 3d20 666c 6f61 7428 6372  mpool = float(cr
+00005400: 6564 6974 5f6c 6564 6765 7229 202d 2066  edit_ledger) - f
+00005410: 6c6f 6174 2864 6562 6974 5f6c 6564 6765  loat(debit_ledge
+00005420: 7229 202d 2066 6c6f 6174 2866 6565 7329  r) - float(fees)
+00005430: 202b 2066 6c6f 6174 2872 6577 6172 6473   + float(rewards
+00005440: 290a 2020 2020 2320 6e6f 6465 2e6c 6f67  ).    # node.log
+00005450: 6765 722e 6170 705f 6c6f 672e 6465 6275  ger.app_log.debu
+00005460: 6728 224d 656d 706f 6f6c 3a20 5072 6f6a  g("Mempool: Proj
+00005470: 6563 7465 6420 7472 616e 7363 7469 6f6e  ected transction
+00005480: 2061 6464 7265 7373 2062 616c 616e 6365   address balance
+00005490: 3a20 2220 2b20 7374 7228 6261 6c61 6e63  : " + str(balanc
+000054a0: 6529 290a 2020 2020 2320 7072 696e 7428  e)).    # print(
+000054b0: 2762 616c 616e 6365 2072 6573 756c 7473  'balance results
+000054c0: 272c 2073 7472 2862 616c 616e 6365 292c  ', str(balance),
+000054d0: 2073 7472 2863 7265 6469 745f 6c65 6467   str(credit_ledg
+000054e0: 6572 292c 2073 7472 2864 6562 6974 292c  er), str(debit),
+000054f0: 2073 7472 2866 6565 7329 2c20 7374 7228   str(fees), str(
+00005500: 7265 7761 7264 7329 2c20 7374 7228 6261  rewards), str(ba
+00005510: 6c61 6e63 655f 6e6f 5f6d 656d 706f 6f6c  lance_no_mempool
+00005520: 2929 0a20 2020 2072 6574 7572 6e20 7374  )).    return st
+00005530: 7228 6261 6c61 6e63 6529 2c20 7374 7228  r(balance), str(
+00005540: 6372 6564 6974 5f6c 6564 6765 7229 2c20  credit_ledger), 
+00005550: 7374 7228 6465 6269 7429 2c20 7374 7228  str(debit), str(
+00005560: 6665 6573 292c 2073 7472 2872 6577 6172  fees), str(rewar
+00005570: 6473 292c 2073 7472 2862 616c 616e 6365  ds), str(balance
+00005580: 5f6e 6f5f 6d65 6d70 6f6f 6c29 0a0a 0a64  _no_mempool)...d
+00005590: 6566 2062 6c6f 636b 6e66 286e 6f64 652c  ef blocknf(node,
+000055a0: 2062 6c6f 636b 5f68 6173 685f 6465 6c65   block_hash_dele
+000055b0: 7465 2c20 7065 6572 5f69 702c 2064 625f  te, peer_ip, db_
+000055c0: 6861 6e64 6c65 722c 2068 7970 6572 626c  handler, hyperbl
+000055d0: 6f63 6b73 3d46 616c 7365 293a 0a20 2020  ocks=False):.   
+000055e0: 2022 2222 0a20 2020 2052 6f6c 6c73 2062   """.    Rolls b
+000055f0: 6163 6b20 6120 7369 6e67 6c65 2062 6c6f  ack a single blo
+00005600: 636b 2c20 7570 6461 7465 7320 6e6f 6465  ck, updates node
+00005610: 206f 626a 6563 7420 7661 7269 6162 6c65   object variable
+00005620: 732e 0a20 2020 2052 6f6c 6c62 6163 6b20  s..    Rollback 
+00005630: 7461 7267 6574 206d 7573 7420 6265 2061  target must be a
+00005640: 626f 7665 2063 6865 636b 706f 696e 742e  bove checkpoint.
+00005650: 0a20 2020 2048 6173 6820 746f 2072 6f6c  .    Hash to rol
+00005660: 6c62 6163 6b20 6d75 7374 206d 6174 6368  lback must match
+00005670: 2069 6e20 6361 7365 206f 7572 206c 6564   in case our led
+00005680: 6765 7220 6d6f 7665 642e 0a20 2020 204e  ger moved..    N
+00005690: 6f74 2074 7275 7374 696e 6720 6879 7065  ot trusting hype
+000056a0: 7262 6c6f 636b 206e 6f64 6573 2066 6f72  rblock nodes for
+000056b0: 206f 6c64 2062 6c6f 636b 7320 6265 6361   old blocks beca
+000056c0: 7573 6520 6f66 2074 7269 6d6d 696e 672c  use of trimming,
+000056d0: 0a20 2020 2074 6865 7920 776f 756c 646e  .    they wouldn
+000056e0: 2774 2066 696e 6420 7468 6520 6861 7368  't find the hash
+000056f0: 2061 6e64 2063 6175 7365 2072 6f6c 6c62   and cause rollb
+00005700: 6163 6b2e 0a20 2020 2022 2222 0a20 2020  ack..    """.   
+00005710: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00005720: 5f6c 6f67 2e77 6172 6e69 6e67 2866 2752  _log.warning(f'R
+00005730: 6f6c 6c62 6163 6b20 6f70 6572 6174 696f  ollback operatio
+00005740: 6e20 6f6e 207b 626c 6f63 6b5f 6861 7368  n on {block_hash
+00005750: 5f64 656c 6574 657d 2069 6e69 7469 6174  _delete} initiat
+00005760: 6564 2062 7920 7b70 6565 725f 6970 7d27  ed by {peer_ip}'
+00005770: 290a 0a20 2020 206d 795f 7469 6d65 203d  )..    my_time =
+00005780: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
+00005790: 2020 6966 206e 6f74 206e 6f64 652e 6462    if not node.db
+000057a0: 5f6c 6f63 6b2e 6c6f 636b 6564 2829 3a0a  _lock.locked():.
+000057b0: 2020 2020 2020 2020 6e6f 6465 2e64 625f          node.db_
+000057c0: 6c6f 636b 2e61 6371 7569 7265 2829 0a20  lock.acquire(). 
+000057d0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+000057e0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
+000057f0: 6e67 2866 2744 6174 6162 6173 6520 6c6f  ng(f'Database lo
+00005800: 636b 2061 6371 7569 7265 6427 290a 2020  ck acquired').  
+00005810: 2020 2020 2020 6261 636b 7570 5f64 6174        backup_dat
+00005820: 6120 3d20 4e6f 6e65 2020 2320 7573 6564  a = None  # used
+00005830: 2069 6e20 2266 696e 616c 6c79 2220 7365   in "finally" se
+00005840: 6374 696f 6e0a 2020 2020 2020 2020 736b  ction.        sk
+00005850: 6970 203d 2046 616c 7365 0a20 2020 2020  ip = False.     
+00005860: 2020 2072 6561 736f 6e20 3d20 2727 0a0a     reason = ''..
+00005870: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00005880: 2020 2020 2020 2020 2062 6c6f 636b 5f6d           block_m
+00005890: 6178 5f72 616d 203d 2064 625f 6861 6e64  ax_ram = db_hand
+000058a0: 6c65 722e 626c 6f63 6b5f 6d61 785f 7261  ler.block_max_ra
+000058b0: 6d28 290a 2020 2020 2020 2020 2020 2020  m().            
+000058c0: 6462 5f62 6c6f 636b 5f68 6569 6768 7420  db_block_height 
+000058d0: 3d20 626c 6f63 6b5f 6d61 785f 7261 6d5b  = block_max_ram[
+000058e0: 2762 6c6f 636b 5f68 6569 6768 7427 5d0a  'block_height'].
+000058f0: 2020 2020 2020 2020 2020 2020 6462 5f62              db_b
+00005900: 6c6f 636b 5f68 6173 6820 3d20 626c 6f63  lock_hash = bloc
+00005910: 6b5f 6d61 785f 7261 6d5b 2762 6c6f 636b  k_max_ram['block
+00005920: 5f68 6173 6827 5d0a 0a20 2020 2020 2020  _hash']..       
+00005930: 2020 2020 2069 7020 3d20 7b27 6970 273a       ip = {'ip':
+00005940: 2070 6565 725f 6970 7d0a 2020 2020 2020   peer_ip}.      
+00005950: 2020 2020 2020 6e6f 6465 2e70 6c75 6769        node.plugi
+00005960: 6e5f 6d61 6e61 6765 722e 6578 6563 7574  n_manager.execut
+00005970: 655f 6669 6c74 6572 5f68 6f6f 6b28 2766  e_filter_hook('f
+00005980: 696c 7465 725f 726f 6c6c 6261 636b 5f69  ilter_rollback_i
+00005990: 7027 2c20 6970 290a 2020 2020 2020 2020  p', ip).        
+000059a0: 2020 2020 6966 2069 705b 2769 7027 5d20      if ip['ip'] 
+000059b0: 3d3d 2027 6e6f 273a 0a20 2020 2020 2020  == 'no':.       
+000059c0: 2020 2020 2020 2020 2072 6561 736f 6e20           reason 
+000059d0: 3d20 2746 696c 7465 7220 626c 6f63 6b65  = 'Filter blocke
+000059e0: 6420 7468 6973 2072 6f6c 6c62 6163 6b27  d this rollback'
+000059f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005a00: 2073 6b69 7020 3d20 5472 7565 0a0a 2020   skip = True..  
+00005a10: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
+00005a20: 625f 626c 6f63 6b5f 6865 6967 6874 203c  b_block_height <
+00005a30: 206e 6f64 652e 6368 6563 6b70 6f69 6e74   node.checkpoint
+00005a40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005a50: 2020 7265 6173 6f6e 203d 2027 426c 6f63    reason = 'Bloc
+00005a60: 6b20 6973 2070 6173 7420 6368 6563 6b70  k is past checkp
+00005a70: 6f69 6e74 2c20 7769 6c6c 206e 6f74 2062  oint, will not b
+00005a80: 6520 726f 6c6c 6564 2062 6163 6b27 0a20  e rolled back'. 
+00005a90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005aa0: 6b69 7020 3d20 5472 7565 0a0a 2020 2020  kip = True..    
+00005ab0: 2020 2020 2020 2020 656c 6966 2064 625f          elif db_
+00005ac0: 626c 6f63 6b5f 6861 7368 2021 3d20 626c  block_hash != bl
+00005ad0: 6f63 6b5f 6861 7368 5f64 656c 6574 653a  ock_hash_delete:
+00005ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005af0: 2023 2070 7269 6e74 2064 625f 626c 6f63   # print db_bloc
+00005b00: 6b5f 6861 7368 0a20 2020 2020 2020 2020  k_hash.         
+00005b10: 2020 2020 2020 2023 2070 7269 6e74 2062         # print b
+00005b20: 6c6f 636b 5f68 6173 685f 6465 6c65 7465  lock_hash_delete
+00005b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005b40: 2072 6561 736f 6e20 3d20 2757 6520 6d6f   reason = 'We mo
+00005b50: 7665 6420 6177 6179 2066 726f 6d20 7468  ved away from th
+00005b60: 6520 626c 6f63 6b20 746f 2072 6f6c 6c62  e block to rollb
+00005b70: 6163 6b2c 2073 6b69 7070 696e 6727 0a20  ack, skipping'. 
+00005b80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005b90: 6b69 7020 3d20 5472 7565 0a0a 2020 2020  kip = True..    
+00005ba0: 2020 2020 2020 2020 656c 6966 2068 7970          elif hyp
+00005bb0: 6572 626c 6f63 6b73 2061 6e64 206e 6f64  erblocks and nod
+00005bc0: 652e 6c61 7374 5f62 6c6f 636b 5f61 676f  e.last_block_ago
+00005bd0: 203e 2033 3030 3030 3a20 2023 6d6f 7265   > 30000:  #more
+00005be0: 2074 6861 6e20 3530 3030 206d 696e 7574   than 5000 minut
+00005bf0: 6573 2f74 6172 6765 7420 626c 6f63 6b73  es/target blocks
+00005c00: 2061 7761 790a 2020 2020 2020 2020 2020   away.          
+00005c10: 2020 2020 2020 7265 6173 6f6e 203d 2066        reason = f
+00005c20: 277b 7065 6572 5f69 707d 2069 7320 7275  '{peer_ip} is ru
+00005c30: 6e6e 696e 6720 6f6e 2068 7970 6572 626c  nning on hyperbl
+00005c40: 6f63 6b73 2061 6e64 206f 7572 206c 6173  ocks and our las
+00005c50: 7420 626c 6f63 6b20 6973 2074 6f6f 206f  t block is too o
+00005c60: 6c64 2c20 736b 6970 7069 6e67 270a 2020  ld, skipping'.  
+00005c70: 2020 2020 2020 2020 2020 2020 2020 736b                sk
+00005c80: 6970 203d 2054 7275 650a 0a20 2020 2020  ip = True..     
+00005c90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00005ca0: 2020 2020 2020 2020 2020 2020 2062 6163               bac
+00005cb0: 6b75 705f 6461 7461 203d 2064 625f 6861  kup_data = db_ha
+00005cc0: 6e64 6c65 722e 6261 636b 7570 5f68 6967  ndler.backup_hig
+00005cd0: 6865 7228 6462 5f62 6c6f 636b 5f68 6569  her(db_block_hei
+00005ce0: 6768 7429 0a0a 2020 2020 2020 2020 2020  ght)..          
+00005cf0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00005d00: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00005d10: 6728 6622 4e6f 6465 207b 7065 6572 5f69  g(f"Node {peer_i
+00005d20: 707d 2064 6964 6e27 7420 6669 6e64 2062  p} didn't find b
+00005d30: 6c6f 636b 207b 6462 5f62 6c6f 636b 5f68  lock {db_block_h
+00005d40: 6569 6768 747d 287b 6462 5f62 6c6f 636b  eight}({db_block
+00005d50: 5f68 6173 687d 2922 290a 0a20 2020 2020  _hash})")..     
+00005d60: 2020 2020 2020 2020 2020 2023 2072 6f6c             # rol
+00005d70: 6c20 6261 636b 2068 6464 2074 6f6f 0a20  l back hdd too. 
+00005d80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00005d90: 625f 6861 6e64 6c65 722e 726f 6c6c 6261  b_handler.rollba
+00005da0: 636b 5f75 6e64 6572 2864 625f 626c 6f63  ck_under(db_bloc
+00005db0: 6b5f 6865 6967 6874 290a 2020 2020 2020  k_height).      
+00005dc0: 2020 2020 2020 2020 2020 2320 2f72 6f6c            # /rol
+00005dd0: 6c20 6261 636b 2068 6464 2074 6f6f 0a0a  l back hdd too..
+00005de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005df0: 2320 726f 6c6c 6261 636b 2069 6e64 6963  # rollback indic
+00005e00: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00005e10: 2020 2064 625f 6861 6e64 6c65 722e 746f     db_handler.to
+00005e20: 6b65 6e73 5f72 6f6c 6c62 6163 6b28 6e6f  kens_rollback(no
+00005e30: 6465 2c20 6462 5f62 6c6f 636b 5f68 6569  de, db_block_hei
+00005e40: 6768 7429 0a20 2020 2020 2020 2020 2020  ght).           
+00005e50: 2020 2020 2064 625f 6861 6e64 6c65 722e       db_handler.
+00005e60: 616c 6961 7365 735f 726f 6c6c 6261 636b  aliases_rollback
+00005e70: 286e 6f64 652c 2064 625f 626c 6f63 6b5f  (node, db_block_
+00005e80: 6865 6967 6874 290a 2020 2020 2020 2020  height).        
+00005e90: 2020 2020 2020 2020 2320 2f72 6f6c 6c62          # /rollb
+00005ea0: 6163 6b20 696e 6469 6365 730a 0a20 2020  ack indices..   
+00005eb0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00005ec0: 652e 6c61 7374 5f62 6c6f 636b 5f74 696d  e.last_block_tim
+00005ed0: 6573 7461 6d70 203d 2064 625f 6861 6e64  estamp = db_hand
+00005ee0: 6c65 722e 6c61 7374 5f62 6c6f 636b 5f74  ler.last_block_t
+00005ef0: 696d 6573 7461 6d70 2829 0a20 2020 2020  imestamp().     
+00005f00: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+00005f10: 6c61 7374 5f62 6c6f 636b 5f68 6173 6820  last_block_hash 
+00005f20: 3d20 6462 5f68 616e 646c 6572 2e6c 6173  = db_handler.las
+00005f30: 745f 626c 6f63 6b5f 6861 7368 2829 0a20  t_block_hash(). 
+00005f40: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00005f50: 6f64 652e 6c61 7374 5f62 6c6f 636b 203d  ode.last_block =
+00005f60: 2064 625f 626c 6f63 6b5f 6865 6967 6874   db_block_height
+00005f70: 202d 2031 0a20 2020 2020 2020 2020 2020   - 1.           
+00005f80: 2020 2020 206e 6f64 652e 6864 645f 6861       node.hdd_ha
+00005f90: 7368 203d 2064 625f 6861 6e64 6c65 722e  sh = db_handler.
+00005fa0: 6c61 7374 5f62 6c6f 636b 5f68 6173 6828  last_block_hash(
+00005fb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00005fc0: 2020 6e6f 6465 2e68 6464 5f62 6c6f 636b    node.hdd_block
+00005fd0: 203d 2064 625f 626c 6f63 6b5f 6865 6967   = db_block_heig
+00005fe0: 6874 202d 2031 0a20 2020 2020 2020 2020  ht - 1.         
+00005ff0: 2020 2020 2020 2074 6f6b 656e 732e 746f         tokens.to
+00006000: 6b65 6e73 5f75 7064 6174 6528 6e6f 6465  kens_update(node
+00006010: 2c20 6462 5f68 616e 646c 6572 290a 0a20  , db_handler).. 
+00006020: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00006030: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00006040: 2020 2020 2020 2020 2020 7472 6163 6562            traceb
+00006050: 6163 6b2e 7072 696e 745f 6578 6328 290a  ack.print_exc().
+00006060: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00006070: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+00006080: 7761 726e 696e 6728 6529 0a0a 2020 2020  warning(e)..    
+00006090: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+000060a0: 2020 2020 2020 2020 206e 6f64 652e 6462           node.db
+000060b0: 5f6c 6f63 6b2e 7265 6c65 6173 6528 290a  _lock.release().
+000060c0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+000060d0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+000060e0: 2e77 6172 6e69 6e67 2866 2744 6174 6162  .warning(f'Datab
+000060f0: 6173 6520 6c6f 636b 2072 656c 6561 7365  ase lock release
+00006100: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
+00006110: 2069 6620 736b 6970 3a0a 2020 2020 2020   if skip:.      
+00006120: 2020 2020 2020 2020 2020 726f 6c6c 6261            rollba
+00006130: 636b 203d 207b 2774 696d 6573 7461 6d70  ck = {'timestamp
+00006140: 273a 206d 795f 7469 6d65 2c20 2768 6569  ': my_time, 'hei
+00006150: 6768 7427 3a20 6462 5f62 6c6f 636b 5f68  ght': db_block_h
+00006160: 6569 6768 742c 2027 6970 273a 2070 6565  eight, 'ip': pee
+00006170: 725f 6970 2c20 2768 6173 6827 3a20 6462  r_ip, 'hash': db
+00006180: 5f62 6c6f 636b 5f68 6173 682c 2027 736b  _block_hash, 'sk
+00006190: 6970 7065 6427 3a20 5472 7565 2c20 2772  ipped': True, 'r
+000061a0: 6561 736f 6e27 3a20 7265 6173 6f6e 7d0a  eason': reason}.
+000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061c0: 6e6f 6465 2e70 6c75 6769 6e5f 6d61 6e61  node.plugin_mana
+000061d0: 6765 722e 6578 6563 7574 655f 6163 7469  ger.execute_acti
+000061e0: 6f6e 5f68 6f6f 6b28 2772 6f6c 6c62 6163  on_hook('rollbac
+000061f0: 6b27 2c20 726f 6c6c 6261 636b 290a 2020  k', rollback).  
+00006200: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00006210: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+00006220: 672e 6465 6275 6728 6627 536b 6970 7069  g.debug(f'Skippi
+00006230: 6e67 2072 6f6c 6c62 6163 6b3a 207b 7265  ng rollback: {re
+00006240: 6173 6f6e 7d27 290a 2020 2020 2020 2020  ason}').        
+00006250: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00006260: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00006270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006280: 2020 206e 625f 7478 203d 2030 0a20 2020     nb_tx = 0.   
+00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062a0: 2066 6f72 2074 7820 696e 2062 6163 6b75   for tx in backu
+000062b0: 705f 6461 7461 3a0a 2020 2020 2020 2020  p_data:.        
+000062c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062d0: 7478 5f73 686f 7274 203d 2066 277b 7478  tx_short = f'{tx
+000062e0: 5b31 5d7d 202d 207b 7478 5b32 5d7d 2074  [1]} - {tx[2]} t
+000062f0: 6f20 7b74 785b 335d 7d3a 207b 7478 5b34  o {tx[3]}: {tx[4
+00006300: 5d7d 2028 7b74 785b 3131 5d7d 2927 0a20  ]} ({tx[11]})'. 
+00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006320: 2020 2020 2020 2069 6620 7478 5b39 5d20         if tx[9] 
+00006330: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
 00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006350: 2020 2020 2023 2049 7427 7320 7468 6520       # It's the 
-00006360: 636f 696e 6261 7365 2074 782c 2073 6f20  coinbase tx, so 
-00006370: 7765 2067 6574 2074 6865 206d 696e 6572  we get the miner
-00006380: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+00006350: 2020 6d69 6e65 7220 3d20 7478 5b33 5d0a    miner = tx[3].
+00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006370: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00006380: 6874 203d 2074 785b 305d 0a20 2020 2020  ht = tx[0].     
 00006390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063a0: 2020 2020 206d 696e 6572 203d 2074 785b       miner = tx[
-000063b0: 335d 0a20 2020 2020 2020 2020 2020 2020  3].             
-000063c0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000063d0: 6569 6768 7420 3d20 7478 5b30 5d0a 2020  eight = tx[0].  
+000063a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063c0: 2020 2020 2020 2020 2020 2020 6e62 5f74              nb_t
+000063d0: 7820 2b3d 2031 0a20 2020 2020 2020 2020  x += 1.         
 000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063f0: 2020 726f 6c6c 6261 636b 203d 207b 2774    rollback = {'t
-00006400: 696d 6573 7461 6d70 273a 206d 795f 7469  imestamp': my_ti
-00006410: 6d65 2c20 2768 6569 6768 7427 3a20 6865  me, 'height': he
-00006420: 6967 6874 2c20 2769 7027 3a20 7065 6572  ight, 'ip': peer
-00006430: 5f69 702c 2027 6d69 6e65 7227 3a20 6d69  _ip, 'miner': mi
-00006440: 6e65 722c 2027 6861 7368 273a 2064 625f  ner, 'hash': db_
-00006450: 626c 6f63 6b5f 6861 7368 2c20 2774 785f  block_hash, 'tx_
-00006460: 636f 756e 7427 3a20 6e62 5f74 782c 2027  count': nb_tx, '
-00006470: 736b 6970 7065 6427 3a20 4661 6c73 652c  skipped': False,
-00006480: 2027 7265 6173 6f6e 273a 2027 277d 0a20   'reason': ''}. 
-00006490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064a0: 2020 206e 6f64 652e 706c 7567 696e 5f6d     node.plugin_m
-000064b0: 616e 6167 6572 2e65 7865 6375 7465 5f61  anager.execute_a
-000064c0: 6374 696f 6e5f 686f 6f6b 2827 726f 6c6c  ction_hook('roll
-000064d0: 6261 636b 272c 2072 6f6c 6c62 6163 6b29  back', rollback)
-000064e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000064f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00006500: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00006510: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00006520: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00006530: 2e77 6172 6e69 6e67 2866 2745 7272 6f72  .warning(f'Error
-00006540: 2064 7572 696e 6720 6d6f 7669 6e67 2074   during moving t
-00006550: 7873 2062 6163 6b20 746f 206d 656d 706f  xs back to mempo
-00006560: 6f6c 3a20 7b65 7d27 290a 0a20 2020 2065  ol: {e}')..    e
-00006570: 6c73 653a 0a20 2020 2020 2020 2072 6561  lse:.        rea
-00006580: 736f 6e20 3d20 2753 6b69 7070 696e 6720  son = 'Skipping 
-00006590: 726f 6c6c 6261 636b 2c20 6f74 6865 7220  rollback, other 
-000065a0: 6c65 6467 6572 206f 7065 7261 7469 6f6e  ledger operation
-000065b0: 2069 6e20 7072 6f67 7265 7373 270a 2020   in progress'.  
-000065c0: 2020 2020 2020 726f 6c6c 6261 636b 203d        rollback =
-000065d0: 207b 2774 696d 6573 7461 6d70 273a 206d   {'timestamp': m
-000065e0: 795f 7469 6d65 2c20 2769 7027 3a20 7065  y_time, 'ip': pe
-000065f0: 6572 5f69 702c 2027 736b 6970 7065 6427  er_ip, 'skipped'
-00006600: 3a20 5472 7565 2c20 2772 6561 736f 6e27  : True, 'reason'
-00006610: 3a20 7265 6173 6f6e 7d0a 2020 2020 2020  : reason}.      
-00006620: 2020 6e6f 6465 2e70 6c75 6769 6e5f 6d61    node.plugin_ma
-00006630: 6e61 6765 722e 6578 6563 7574 655f 6163  nager.execute_ac
-00006640: 7469 6f6e 5f68 6f6f 6b28 2772 6f6c 6c62  tion_hook('rollb
-00006650: 6163 6b27 2c20 726f 6c6c 6261 636b 290a  ack', rollback).
-00006660: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00006670: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-00006680: 2872 6561 736f 6e29 0a0a 0a64 6566 2073  (reason)...def s
-00006690: 6571 7565 6e63 696e 675f 6368 6563 6b28  equencing_check(
-000066a0: 6462 5f68 616e 646c 6572 293a 0a20 2020  db_handler):.   
-000066b0: 2023 2054 4f44 4f3a 2043 616e 6469 6461   # TODO: Candida
-000066c0: 7465 2066 6f72 2073 696e 676c 6520 7573  te for single us
-000066d0: 6572 206d 6f64 650a 2020 2020 7472 793a  er mode.    try:
-000066e0: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-000066f0: 656e 2827 7365 7175 656e 6369 6e67 5f6c  en('sequencing_l
-00006700: 6173 7427 2c20 2772 2729 2061 7320 6669  ast', 'r') as fi
-00006710: 6c65 6e61 6d65 3a0a 2020 2020 2020 2020  lename:.        
-00006720: 2020 2020 7365 7175 656e 6369 6e67 5f6c      sequencing_l
-00006730: 6173 7420 3d20 696e 7428 6669 6c65 6e61  ast = int(filena
-00006740: 6d65 2e72 6561 6428 2929 0a0a 2020 2020  me.read())..    
-00006750: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00006760: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00006770: 6c6f 672e 7761 726e 696e 6728 2753 6571  log.warning('Seq
-00006780: 7565 6e63 696e 6720 616e 6368 6f72 206e  uencing anchor n
-00006790: 6f74 2066 6f75 6e64 2c20 676f 696e 6720  ot found, going 
-000067a0: 7468 726f 7567 6820 7468 6520 7768 6f6c  through the whol
-000067b0: 6520 6368 6169 6e27 290a 2020 2020 2020  e chain').      
-000067c0: 2020 7365 7175 656e 6369 6e67 5f6c 6173    sequencing_las
-000067d0: 7420 3d20 300a 0a20 2020 206e 6f64 652e  t = 0..    node.
-000067e0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-000067f0: 6172 6e69 6e67 2866 2753 7461 7475 733a  arning(f'Status:
-00006800: 2054 6573 7469 6e67 2063 6861 696e 2073   Testing chain s
-00006810: 6571 7565 6e63 696e 672c 2073 7461 7274  equencing, start
-00006820: 696e 6720 7769 7468 2062 6c6f 636b 207b  ing with block {
-00006830: 7365 7175 656e 6369 6e67 5f6c 6173 747d  sequencing_last}
-00006840: 2729 0a0a 2020 2020 6368 6169 6e73 5f74  ')..    chains_t
-00006850: 6f5f 6368 6563 6b20 3d20 5b6e 6f64 652e  o_check = [node.
-00006860: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
-00006870: 652e 6879 7065 725f 7061 7468 5d0a 0a20  e.hyper_path].. 
-00006880: 2020 2066 6f72 2063 6861 696e 2069 6e20     for chain in 
-00006890: 6368 6169 6e73 5f74 6f5f 6368 6563 6b3a  chains_to_check:
-000068a0: 0a20 2020 2020 2020 2063 6f6e 6e20 3d20  .        conn = 
-000068b0: 7371 6c69 7465 332e 636f 6e6e 6563 7428  sqlite3.connect(
-000068c0: 6368 6169 6e29 0a20 2020 2020 2020 2069  chain).        i
-000068d0: 6620 6e6f 6465 2e74 7261 6365 5f64 625f  f node.trace_db_
-000068e0: 6361 6c6c 733a 0a20 2020 2020 2020 2020  calls:.         
-000068f0: 2020 2063 6f6e 6e2e 7365 745f 7472 6163     conn.set_trac
-00006900: 655f 6361 6c6c 6261 636b 2866 756e 6374  e_callback(funct
-00006910: 6f6f 6c73 2e70 6172 7469 616c 2873 716c  ools.partial(sql
-00006920: 5f74 7261 6365 5f63 616c 6c62 6163 6b2c  _trace_callback,
-00006930: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00006940: 5f6c 6f67 2c20 2753 4551 5545 4e43 452d  _log, 'SEQUENCE-
-00006950: 4348 4543 4b2d 4348 4149 4e27 2929 0a20  CHECK-CHAIN')). 
-00006960: 2020 2020 2020 2063 203d 2063 6f6e 6e2e         c = conn.
-00006970: 6375 7273 6f72 2829 0a0a 2020 2020 2020  cursor()..      
-00006980: 2020 2320 7065 7266 6f72 6d20 7465 7374    # perform test
-00006990: 206f 6e20 7472 616e 7361 6374 696f 6e20   on transaction 
-000069a0: 7461 626c 650a 2020 2020 2020 2020 7920  table.        y 
-000069b0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2023  = None.        #
-000069c0: 2045 6767 3a20 6e6f 7420 7375 7265 2062   Egg: not sure b
-000069d0: 6c6f 636b 5f68 6569 6768 7420 213d 2028  lock_height != (
-000069e0: 3020 4f52 2031 2920 2067 6976 6573 2074  0 OR 1)  gives t
-000069f0: 6865 2070 726f 7065 7220 7265 7375 6c74  he proper result
-00006a00: 2c20 3020 6f72 2031 2020 3d20 312e 206e  , 0 or 1  = 1. n
-00006a10: 6f74 2069 6e20 2830 2c20 3129 2063 6f75  ot in (0, 1) cou
-00006a20: 6c64 2062 6520 6265 7474 6572 2e0a 2020  ld be better..  
-00006a30: 2020 2020 2020 666f 7220 726f 7720 696e        for row in
-00006a40: 2063 2e65 7865 6375 7465 2827 5345 4c45   c.execute('SELE
-00006a50: 4354 2062 6c6f 636b 5f68 6569 6768 7420  CT block_height 
-00006a60: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-00006a70: 7320 5748 4552 4520 7265 7761 7264 2021  s WHERE reward !
-00006a80: 3d20 3020 414e 4420 626c 6f63 6b5f 6865  = 0 AND block_he
-00006a90: 6967 6874 203e 2031 2041 4e44 2062 6c6f  ight > 1 AND blo
-00006aa0: 636b 5f68 6569 6768 7420 3e3d 203f 204f  ck_height >= ? O
-00006ab0: 5244 4552 2042 5920 626c 6f63 6b5f 6865  RDER BY block_he
-00006ac0: 6967 6874 2041 5343 272c 2028 7365 7175  ight ASC', (sequ
-00006ad0: 656e 6369 6e67 5f6c 6173 742c 2029 293a  encing_last, )):
-00006ae0: 0a20 2020 2020 2020 2020 2020 2079 5f69  .            y_i
-00006af0: 6e69 7420 3d20 726f 775b 305d 0a0a 2020  nit = row[0]..  
-00006b00: 2020 2020 2020 2020 2020 6966 2079 2069            if y i
-00006b10: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00006b20: 2020 2020 2020 2020 7920 3d20 795f 696e          y = y_in
-00006b30: 6974 0a0a 2020 2020 2020 2020 2020 2020  it..            
-00006b40: 6966 2072 6f77 5b30 5d20 213d 2079 3a0a  if row[0] != y:.
-00006b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b60: 2066 6f72 2063 6861 696e 3220 696e 2063   for chain2 in c
-00006b70: 6861 696e 735f 746f 5f63 6865 636b 3a0a  hains_to_check:.
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2020 2020 636f 6e6e 3220 3d20 7371 6c69      conn2 = sqli
-00006ba0: 7465 332e 636f 6e6e 6563 7428 6368 6169  te3.connect(chai
-00006bb0: 6e32 290a 2020 2020 2020 2020 2020 2020  n2).            
-00006bc0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00006bd0: 7472 6163 655f 6462 5f63 616c 6c73 3a0a  trace_db_calls:.
-00006be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bf0: 2020 2020 2020 2020 636f 6e6e 322e 7365          conn2.se
-00006c00: 745f 7472 6163 655f 6361 6c6c 6261 636b  t_trace_callback
-00006c10: 2866 756e 6374 6f6f 6c73 2e70 6172 7469  (functools.parti
-00006c20: 616c 2873 716c 5f74 7261 6365 5f63 616c  al(sql_trace_cal
-00006c30: 6c62 6163 6b2c 206e 6f64 652e 6c6f 6767  lback, node.logg
-00006c40: 6572 2e61 7070 5f6c 6f67 2c20 2753 4551  er.app_log, 'SEQ
-00006c50: 5545 4e43 452d 4348 4543 4b2d 4348 4149  UENCE-CHECK-CHAI
-00006c60: 4e32 2729 290a 2020 2020 2020 2020 2020  N2')).          
-00006c70: 2020 2020 2020 2020 2020 6332 203d 2063            c2 = c
-00006c80: 6f6e 6e32 2e63 7572 736f 7228 290a 2020  onn2.cursor().  
-00006c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ca0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-00006cb0: 705f 6c6f 672e 7761 726e 696e 6728 6627  p_log.warning(f'
-00006cc0: 5374 6174 7573 3a20 4368 6169 6e20 7b63  Status: Chain {c
-00006cd0: 6861 696e 7d20 7472 616e 7361 6374 696f  hain} transactio
-00006ce0: 6e20 7365 7175 656e 6369 6e67 2065 7272  n sequencing err
-00006cf0: 6f72 2061 743a 207b 726f 775b 305d 7d2e  or at: {row[0]}.
-00006d00: 207b 726f 775b 305d 7d20 696e 7374 6561   {row[0]} instea
-00006d10: 6420 6f66 207b 797d 2729 0a20 2020 2020  d of {y}').     
-00006d20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00006d30: 322e 6578 6563 7574 6528 2744 454c 4554  2.execute('DELET
-00006d40: 4520 4652 4f4d 2074 7261 6e73 6163 7469  E FROM transacti
-00006d50: 6f6e 7320 5748 4552 4520 626c 6f63 6b5f  ons WHERE block_
-00006d60: 6865 6967 6874 203e 3d20 3f20 4f52 2062  height >= ? OR b
-00006d70: 6c6f 636b 5f68 6569 6768 7420 3c3d 203f  lock_height <= ?
-00006d80: 272c 2028 0a20 2020 2020 2020 2020 2020  ', (.           
-00006d90: 2020 2020 2020 2020 2020 2020 2072 6f77               row
-00006da0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-00006db0: 2020 2020 2020 2020 2020 2020 202d 726f               -ro
-00006dc0: 775b 305d 2c0a 2020 2020 2020 2020 2020  w[0],.          
-00006dd0: 2020 2020 2020 2020 2020 2929 0a20 2020            )).   
-00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006df0: 2063 6f6e 6e32 2e63 6f6d 6d69 7428 290a   conn2.commit().
-00006e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e10: 2020 2020 6332 2e65 7865 6375 7465 2827      c2.execute('
-00006e20: 4445 4c45 5445 2046 524f 4d20 6d69 7363  DELETE FROM misc
-00006e30: 2057 4845 5245 2062 6c6f 636b 5f68 6569   WHERE block_hei
-00006e40: 6768 7420 3e3d 203f 272c 2028 726f 775b  ght >= ?', (row[
-00006e50: 305d 2c20 2929 0a20 2020 2020 2020 2020  0], )).         
-00006e60: 2020 2020 2020 2020 2020 2063 6f6e 6e32             conn2
-00006e70: 2e63 6f6d 6d69 7428 290a 0a20 2020 2020  .commit()..     
-00006e80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006e90: 2072 6f6c 6c62 6163 6b20 696e 6469 6365   rollback indice
-00006ea0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00006eb0: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
-00006ec0: 2e74 6f6b 656e 735f 726f 6c6c 6261 636b  .tokens_rollback
-00006ed0: 286e 6f64 652c 2079 290a 2020 2020 2020  (node, y).      
-00006ee0: 2020 2020 2020 2020 2020 2020 2020 6462                db
-00006ef0: 5f68 616e 646c 6572 2e61 6c69 6173 6573  _handler.aliases
-00006f00: 5f72 6f6c 6c62 6163 6b28 6e6f 6465 2c20  _rollback(node, 
-00006f10: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
-00006f20: 2020 2020 2020 2020 2320 726f 6c6c 6261          # rollba
-00006f30: 636b 2069 6e64 6963 6573 0a0a 2020 2020  ck indices..    
-00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f50: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00006f60: 6c6f 672e 7761 726e 696e 6728 6627 5374  log.warning(f'St
-00006f70: 6174 7573 3a20 4475 6520 746f 2061 2073  atus: Due to a s
-00006f80: 6571 7565 6e63 696e 6720 6973 7375 6520  equencing issue 
-00006f90: 6174 2062 6c6f 636b 207b 797d 2c20 7b63  at block {y}, {c
-00006fa0: 6861 696e 7d20 6861 7320 6265 656e 2072  hain} has been r
-00006fb0: 6f6c 6c65 6420 6261 636b 2061 6e64 2077  olled back and w
-00006fc0: 696c 6c20 6265 2072 6573 796e 6368 726f  ill be resynchro
-00006fd0: 6e69 7a65 6427 290a 2020 2020 2020 2020  nized').        
-00006fe0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-00006ff0: 2020 2020 2020 2020 2020 2079 203d 2079             y = y
-00007000: 202b 2031 0a0a 2020 2020 2020 2020 2320   + 1..        # 
-00007010: 7065 7266 6f72 6d20 7465 7374 206f 6e20  perform test on 
-00007020: 6d69 7363 2074 6162 6c65 0a20 2020 2020  misc table.     
-00007030: 2020 2079 203d 204e 6f6e 650a 0a20 2020     y = None..   
-00007040: 2020 2020 2066 6f72 2072 6f77 2069 6e20       for row in 
-00007050: 632e 6578 6563 7574 6528 2753 454c 4543  c.execute('SELEC
-00007060: 5420 626c 6f63 6b5f 6865 6967 6874 2046  T block_height F
-00007070: 524f 4d20 6d69 7363 2057 4845 5245 2062  ROM misc WHERE b
-00007080: 6c6f 636b 5f68 6569 6768 7420 3e20 3f20  lock_height > ? 
-00007090: 4f52 4445 5220 4259 2062 6c6f 636b 5f68  ORDER BY block_h
-000070a0: 6569 6768 7420 4153 4327 2c20 2833 3030  eight ASC', (300
-000070b0: 3030 302c 2029 293a 0a20 2020 2020 2020  000, )):.       
-000070c0: 2020 2020 2079 5f69 6e69 7420 3d20 726f       y_init = ro
-000070d0: 775b 305d 0a0a 2020 2020 2020 2020 2020  w[0]..          
-000070e0: 2020 6966 2079 2069 7320 4e6f 6e65 3a0a    if y is None:.
-000070f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007100: 7920 3d20 795f 696e 6974 0a20 2020 2020  y = y_init.     
-00007110: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-00007120: 6e74 2822 6173 7369 676e 6564 2229 0a20  nt("assigned"). 
-00007130: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007140: 2070 7269 6e74 2872 6f77 5b30 5d2c 2079   print(row[0], y
-00007150: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00007160: 6620 726f 775b 305d 2021 3d20 793a 0a20  f row[0] != y:. 
-00007170: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007180: 2070 7269 6e74 2872 6f77 5b30 5d2c 2079   print(row[0], y
-00007190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000071a0: 2020 666f 7220 6368 6169 6e32 2069 6e20    for chain2 in 
-000071b0: 6368 6169 6e73 5f74 6f5f 6368 6563 6b3a  chains_to_check:
-000071c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000071d0: 2020 2020 2063 6f6e 6e32 203d 2073 716c       conn2 = sql
-000071e0: 6974 6533 2e63 6f6e 6e65 6374 2863 6861  ite3.connect(cha
-000071f0: 696e 3229 0a20 2020 2020 2020 2020 2020  in2).           
-00007200: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
-00007210: 2e74 7261 6365 5f64 625f 6361 6c6c 733a  .trace_db_calls:
-00007220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007230: 2020 2020 2020 2020 2063 6f6e 6e32 2e73           conn2.s
-00007240: 6574 5f74 7261 6365 5f63 616c 6c62 6163  et_trace_callbac
-00007250: 6b28 6675 6e63 746f 6f6c 732e 7061 7274  k(functools.part
-00007260: 6961 6c28 7371 6c5f 7472 6163 655f 6361  ial(sql_trace_ca
-00007270: 6c6c 6261 636b 2c20 6e6f 6465 2e6c 6f67  llback, node.log
-00007280: 6765 722e 6170 705f 6c6f 672c 2027 5345  ger.app_log, 'SE
-00007290: 5155 454e 4345 2d43 4845 434b 2d43 4841  QUENCE-CHECK-CHA
-000072a0: 494e 3242 2729 290a 2020 2020 2020 2020  IN2B')).        
-000072b0: 2020 2020 2020 2020 2020 2020 6332 203d              c2 =
-000072c0: 2063 6f6e 6e32 2e63 7572 736f 7228 290a   conn2.cursor().
-000072d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072e0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-000072f0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
-00007300: 6627 5374 6174 7573 3a20 4368 6169 6e20  f'Status: Chain 
-00007310: 7b63 6861 696e 7d20 6469 6666 6963 756c  {chain} difficul
-00007320: 7479 2073 6571 7565 6e63 696e 6720 6572  ty sequencing er
-00007330: 726f 7220 6174 3a20 7b72 6f77 5b30 5d7d  ror at: {row[0]}
-00007340: 2e20 7b72 6f77 5b30 5d7d 2069 6e73 7465  . {row[0]} inste
-00007350: 6164 206f 6620 7b79 7d27 290a 2020 2020  ad of {y}').    
-00007360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007370: 6332 2e65 7865 6375 7465 2827 4445 4c45  c2.execute('DELE
-00007380: 5445 2046 524f 4d20 7472 616e 7361 6374  TE FROM transact
-00007390: 696f 6e73 2057 4845 5245 2062 6c6f 636b  ions WHERE block
-000073a0: 5f68 6569 6768 7420 3e3d 203f 272c 2028  _height >= ?', (
-000073b0: 726f 775b 305d 2c20 2929 0a20 2020 2020  row[0], )).     
-000073c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000073d0: 6f6e 6e32 2e63 6f6d 6d69 7428 290a 2020  onn2.commit().  
-000073e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000073f0: 2020 6332 2e65 7865 6375 7465 2827 4445    c2.execute('DE
-00007400: 4c45 5445 2046 524f 4d20 6d69 7363 2057  LETE FROM misc W
-00007410: 4845 5245 2062 6c6f 636b 5f68 6569 6768  HERE block_heigh
-00007420: 7420 3e3d 203f 272c 2028 726f 775b 305d  t >= ?', (row[0]
-00007430: 2c20 2929 0a20 2020 2020 2020 2020 2020  , )).           
-00007440: 2020 2020 2020 2020 2063 6f6e 6e32 2e63           conn2.c
-00007450: 6f6d 6d69 7428 290a 0a20 2020 2020 2020  ommit()..       
-00007460: 2020 2020 2020 2020 2020 2020 2064 625f               db_
-00007470: 6861 6e64 6c65 722e 6578 6563 7574 655f  handler.execute_
-00007480: 7061 7261 6d28 636f 6e6e 322c 2028 2744  param(conn2, ('D
-00007490: 454c 4554 4520 4652 4f4d 2074 7261 6e73  ELETE FROM trans
-000074a0: 6163 7469 6f6e 7320 5748 4552 4520 6164  actions WHERE ad
-000074b0: 6472 6573 7320 3d20 2244 6576 656c 6f70  dress = "Develop
-000074c0: 6d65 6e74 2052 6577 6172 6422 2041 4e44  ment Reward" AND
-000074d0: 2062 6c6f 636b 5f68 6569 6768 7420 3c3d   block_height <=
-000074e0: 203f 2729 2c20 282d 726f 775b 305d 2c20   ?'), (-row[0], 
-000074f0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00007500: 2020 2020 2020 2063 6f6e 6e32 2e63 6f6d         conn2.com
-00007510: 6d69 7428 290a 0a20 2020 2020 2020 2020  mit()..         
-00007520: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
-00007530: 6e64 6c65 722e 6578 6563 7574 655f 7061  ndler.execute_pa
-00007540: 7261 6d28 636f 6e6e 322c 2028 2744 454c  ram(conn2, ('DEL
-00007550: 4554 4520 4652 4f4d 2074 7261 6e73 6163  ETE FROM transac
-00007560: 7469 6f6e 7320 5748 4552 4520 6164 6472  tions WHERE addr
-00007570: 6573 7320 3d20 2248 7970 6572 6e6f 6465  ess = "Hypernode
-00007580: 2050 6179 6f75 7473 2220 414e 4420 626c   Payouts" AND bl
-00007590: 6f63 6b5f 6865 6967 6874 203c 3d20 3f27  ock_height <= ?'
-000075a0: 292c 2028 2d72 6f77 5b30 5d2c 2029 290a  ), (-row[0], )).
-000075b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000075c0: 2020 2020 636f 6e6e 322e 636f 6d6d 6974      conn2.commit
-000075d0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000075e0: 2020 2020 2020 2063 6f6e 6e32 2e63 6c6f         conn2.clo
-000075f0: 7365 2829 0a0a 2020 2020 2020 2020 2020  se()..          
-00007600: 2020 2020 2020 2020 2020 2320 726f 6c6c            # roll
-00007610: 6261 636b 2069 6e64 6963 6573 0a20 2020  back indices.   
-00007620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007630: 2064 625f 6861 6e64 6c65 722e 746f 6b65   db_handler.toke
-00007640: 6e73 5f72 6f6c 6c62 6163 6b28 6e6f 6465  ns_rollback(node
-00007650: 2c20 7929 0a20 2020 2020 2020 2020 2020  , y).           
-00007660: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
-00007670: 6c65 722e 616c 6961 7365 735f 726f 6c6c  ler.aliases_roll
-00007680: 6261 636b 286e 6f64 652c 2079 290a 2020  back(node, y).  
-00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076a0: 2020 2320 726f 6c6c 6261 636b 2069 6e64    # rollback ind
-000076b0: 6963 6573 0a0a 2020 2020 2020 2020 2020  ices..          
-000076c0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-000076d0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-000076e0: 726e 696e 6728 6627 5374 6174 7573 3a20  rning(f'Status: 
-000076f0: 4475 6520 746f 2061 2073 6571 7565 6e63  Due to a sequenc
-00007700: 696e 6720 6973 7375 6520 6174 2062 6c6f  ing issue at blo
-00007710: 636b 207b 797d 2c20 7b63 6861 696e 7d20  ck {y}, {chain} 
-00007720: 6861 7320 6265 656e 2072 6f6c 6c65 6420  has been rolled 
-00007730: 6261 636b 2061 6e64 2077 696c 6c20 6265  back and will be
-00007740: 2072 6573 796e 6368 726f 6e69 7a65 6427   resynchronized'
-00007750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007760: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00007770: 2020 2020 2079 203d 2079 202b 2031 0a0a       y = y + 1..
-00007780: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00007790: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-000077a0: 696e 6728 6627 5374 6174 7573 3a20 4368  ing(f'Status: Ch
-000077b0: 6169 6e20 7365 7175 656e 6369 6e67 2074  ain sequencing t
-000077c0: 6573 7420 636f 6d70 6c65 7465 2066 6f72  est complete for
-000077d0: 207b 6368 6169 6e7d 2729 0a20 2020 2020   {chain}').     
-000077e0: 2020 2063 6f6e 6e2e 636c 6f73 6528 290a     conn.close().
-000077f0: 0a20 2020 2020 2020 2069 6620 793a 0a20  .        if y:. 
-00007800: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00007810: 6f70 656e 2827 7365 7175 656e 6369 6e67  open('sequencing
-00007820: 5f6c 6173 7427 2c20 2777 2729 2061 7320  _last', 'w') as 
-00007830: 6669 6c65 6e61 6d65 3a0a 2020 2020 2020  filename:.      
-00007840: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00007850: 6d65 2e77 7269 7465 2873 7472 2879 202d  me.write(str(y -
-00007860: 2031 3030 3029 2920 2023 2072 6f6f 6d20   1000))  # room 
-00007870: 666f 7220 726f 6c6c 6261 636b 730a 0a0a  for rollbacks...
-00007880: 2320 696e 6974 0a0a 0a63 6c61 7373 2054  # init...class T
-00007890: 6872 6561 6465 6454 4350 5265 7175 6573  hreadedTCPReques
-000078a0: 7448 616e 646c 6572 2873 6f63 6b65 7473  tHandler(sockets
-000078b0: 6572 7665 722e 4261 7365 5265 7175 6573  erver.BaseReques
-000078c0: 7448 616e 646c 6572 293a 0a20 2020 2064  tHandler):.    d
-000078d0: 6566 2068 616e 646c 6528 7365 6c66 293a  ef handle(self):
-000078e0: 0a20 2020 2020 2020 2023 2074 6869 7320  .        # this 
-000078f0: 6973 2061 2064 6564 6963 6174 6564 2074  is a dedicated t
-00007900: 6872 6561 6420 666f 7220 6561 6368 2063  hread for each c
-00007910: 6c69 656e 7420 286e 6f74 2069 7029 0a20  lient (not ip). 
-00007920: 2020 2020 2020 2069 6620 6e6f 6465 2e49         if node.I
-00007930: 535f 5354 4f50 5049 4e47 3a0a 2020 2020  S_STOPPING:.    
-00007940: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00007950: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-00007960: 696e 6728 2749 6e62 6f75 6e64 3a20 5265  ing('Inbound: Re
-00007970: 6a65 6374 6564 2069 6e63 6f6d 696e 6720  jected incoming 
-00007980: 636e 782c 206e 6f64 6520 6973 2073 746f  cnx, node is sto
-00007990: 7070 696e 6727 290a 2020 2020 2020 2020  pping').        
-000079a0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-000079b0: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
-000079c0: 6e73 7461 6e63 6520 3d20 6462 6861 6e64  nstance = dbhand
-000079d0: 6c65 722e 4462 4861 6e64 6c65 7228 6e6f  ler.DbHandler(no
-000079e0: 6465 2e69 6e64 6578 5f64 622c 206e 6f64  de.index_db, nod
-000079f0: 652e 6c65 6467 6572 5f70 6174 682c 206e  e.ledger_path, n
-00007a00: 6f64 652e 6879 7065 725f 7061 7468 2c20  ode.hyper_path, 
-00007a10: 6e6f 6465 2e72 616d 2c20 6e6f 6465 2e6c  node.ram, node.l
-00007a20: 6564 6765 725f 7261 6d5f 6669 6c65 2c20  edger_ram_file, 
-00007a30: 6e6f 6465 2e6c 6f67 6765 722c 2074 7261  node.logger, tra
-00007a40: 6365 5f64 625f 6361 6c6c 733d 6e6f 6465  ce_db_calls=node
-00007a50: 2e74 7261 6365 5f64 625f 6361 6c6c 7329  .trace_db_calls)
-00007a60: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-00007a70: 5f69 6e73 7461 6e63 6520 3d20 636c 6965  _instance = clie
-00007a80: 6e74 2e43 6c69 656e 7428 290a 0a20 2020  nt.Client()..   
-00007a90: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00007aa0: 2020 2020 2020 7065 6572 5f69 7020 3d20        peer_ip = 
-00007ab0: 7365 6c66 2e72 6571 7565 7374 2e67 6574  self.request.get
-00007ac0: 7065 6572 6e61 6d65 2829 5b30 5d0a 2020  peername()[0].  
-00007ad0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-00007ae0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-00007af0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-00007b00: 726e 696e 6728 2749 6e62 6f75 6e64 3a20  rning('Inbound: 
-00007b10: 5472 616e 7370 6f72 7420 656e 6470 6f69  Transport endpoi
-00007b20: 6e74 2077 6173 206e 6f74 2063 6f6e 6e65  nt was not conne
-00007b30: 6374 6564 2729 0a20 2020 2020 2020 2020  cted').         
-00007b40: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00007b50: 2020 2074 6872 6561 6469 6e67 2e63 7572     threading.cur
-00007b60: 7265 6e74 5f74 6872 6561 6428 292e 6e61  rent_thread().na
-00007b70: 6d65 203d 2066 2769 6e5f 7b70 6565 725f  me = f'in_{peer_
-00007b80: 6970 7d27 0a20 2020 2020 2020 2023 2069  ip}'.        # i
-00007b90: 6620 7468 7265 6164 696e 672e 6163 7469  f threading.acti
-00007ba0: 7665 5f63 6f75 6e74 2829 203c 206e 6f64  ve_count() < nod
-00007bb0: 652e 7468 7265 6164 5f6c 696d 6974 206f  e.thread_limit o
-00007bc0: 7220 7065 6572 5f69 7020 3d3d 2022 3132  r peer_ip == "12
-00007bd0: 372e 302e 302e 3122 3a0a 2020 2020 2020  7.0.0.1":.      
-00007be0: 2020 2320 416c 7761 7973 206b 6565 7020    # Always keep 
-00007bf0: 6120 736c 6f74 2066 6f72 2077 6869 7465  a slot for white
-00007c00: 6c69 7374 6564 2028 7761 6c6c 6574 2063  listed (wallet c
-00007c10: 6f75 6c64 2062 6520 7468 6572 6529 0a20  ould be there). 
-00007c20: 2020 2020 2020 2069 6620 7468 7265 6164         if thread
-00007c30: 696e 672e 6163 7469 7665 5f63 6f75 6e74  ing.active_count
-00007c40: 2829 203c 206e 6f64 652e 7468 7265 6164  () < node.thread
-00007c50: 5f6c 696d 6974 2f33 2a32 206f 7220 6e6f  _limit/3*2 or no
-00007c60: 6465 2e70 6565 7273 2e69 735f 7768 6974  de.peers.is_whit
-00007c70: 656c 6973 7465 6428 7065 6572 5f69 7029  elisted(peer_ip)
-00007c80: 3a20 2023 2069 6e62 6f75 6e64 0a20 2020  :  # inbound.   
-00007c90: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-00007ca0: 696e 7374 616e 6365 2e63 6f6e 6e65 6374  instance.connect
-00007cb0: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
-00007cc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00007cd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00007ce0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-00007cf0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-00007d00: 6f28 6627 4672 6565 2063 6170 6163 6974  o(f'Free capacit
-00007d10: 7920 666f 7220 7b70 6565 725f 6970 7d20  y for {peer_ip} 
-00007d20: 756e 6176 6169 6c61 626c 652c 2064 6973  unavailable, dis
-00007d30: 636f 6e6e 6563 7465 6427 290a 2020 2020  connected').    
-00007d40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007d50: 2e72 6571 7565 7374 2e63 6c6f 7365 2829  .request.close()
-00007d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007d70: 2023 2069 6620 796f 7520 7261 6973 6520   # if you raise 
-00007d80: 6865 7265 2c20 796f 7520 6b69 6c6c 2074  here, you kill t
-00007d90: 6865 2077 686f 6c65 2073 6572 7665 720a  he whole server.
-00007da0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00007db0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00007dc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00007dd0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-00007de0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
-00007df0: 277b 657d 2729 0a20 2020 2020 2020 2020  '{e}').         
-00007e00: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00007e10: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-00007e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007e30: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-00007e40: 2064 6963 745f 6970 203d 207b 2769 7027   dict_ip = {'ip'
-00007e50: 3a20 7065 6572 5f69 707d 0a20 2020 2020  : peer_ip}.     
-00007e60: 2020 206e 6f64 652e 706c 7567 696e 5f6d     node.plugin_m
-00007e70: 616e 6167 6572 2e65 7865 6375 7465 5f66  anager.execute_f
-00007e80: 696c 7465 725f 686f 6f6b 2827 7065 6572  ilter_hook('peer
-00007e90: 5f69 7027 2c20 6469 6374 5f69 7029 0a0a  _ip', dict_ip)..
-00007ea0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00007eb0: 7065 6572 732e 6973 5f62 616e 6e65 6428  peers.is_banned(
-00007ec0: 7065 6572 5f69 7029 206f 7220 6469 6374  peer_ip) or dict
-00007ed0: 5f69 705b 2769 7027 5d20 3d3d 2027 6261  _ip['ip'] == 'ba
-00007ee0: 6e6e 6564 273a 0a20 2020 2020 2020 2020  nned':.         
-00007ef0: 2020 2073 656c 662e 7265 7175 6573 742e     self.request.
-00007f00: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-00007f10: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00007f20: 6170 705f 6c6f 672e 696e 666f 2866 2749  app_log.info(f'I
-00007f30: 5020 7b70 6565 725f 6970 7d20 6261 6e6e  P {peer_ip} bann
-00007f40: 6564 2c20 6469 7363 6f6e 6e65 6374 6564  ed, disconnected
-00007f50: 2729 0a0a 2020 2020 2020 2020 2320 544f  ')..        # TO
-00007f60: 444f 3a20 4927 6420 6c69 6b65 2074 6f20  DO: I'd like to 
-00007f70: 6361 6c6c 0a20 2020 2020 2020 2022 2222  call.        """
-00007f80: 0a20 2020 2020 2020 206e 6f64 652e 7065  .        node.pe
-00007f90: 6572 732e 7065 6572 7379 6e63 287b 7065  ers.peersync({pe
-00007fa0: 6572 5f69 703a 206e 6f64 652e 706f 7274  er_ip: node.port
-00007fb0: 7d29 0a20 2020 2020 2020 2073 6f20 7765  }).        so we
-00007fc0: 2063 616e 2073 6176 6520 7468 6520 7065   can save the pe
-00007fd0: 6572 7320 7468 6174 2063 6f6e 6e65 6374  ers that connect
-00007fe0: 6564 2074 6f20 7573 2e0a 2020 2020 2020  ed to us..      
-00007ff0: 2020 4275 7420 6e6f 7420 6f6b 2069 6e20    But not ok in 
-00008000: 6375 7272 656e 7420 6172 6368 6974 6563  current architec
-00008010: 7475 7265 3a20 776f 756c 6420 6465 6c61  ture: would dela
-00008020: 7920 7468 6520 636f 6d6d 616e 642c 2061  y the command, a
-00008030: 6e64 2077 6527 7265 206e 6f74 2065 7665  nd we're not eve
-00008040: 6e20 7375 7265 2069 7420 776f 756c 6420  n sure it would 
-00008050: 6265 2073 6176 6564 2e0a 2020 2020 2020  be saved..      
-00008060: 2020 544f 444f 3a20 576f 726b 6172 6f75    TODO: Workarou
-00008070: 6e64 3a20 6d61 6b65 2073 7572 6520 6f75  nd: make sure ou
-00008080: 7220 6578 7465 726e 616c 2069 7020 616e  r external ip an
-00008090: 6420 706f 7274 2069 7320 7072 6573 656e  d port is presen
-000080a0: 7420 696e 2074 6865 2070 6565 7273 2077  t in the peers w
-000080b0: 6520 616e 6e6f 756e 6365 2c20 6f72 206e  e announce, or n
-000080c0: 6577 206e 6f64 6573 2061 7265 206c 696b  ew nodes are lik
-000080d0: 656c 7920 6e65 7665 7220 746f 2062 6520  ely never to be 
-000080e0: 616e 6e6f 756e 6365 642e 0a20 2020 2020  announced..     
-000080f0: 2020 2057 6172 6e69 6e67 3a20 6e65 6564     Warning: need
-00008100: 7320 7075 626c 6963 2069 702f 706f 7274  s public ip/port
-00008110: 2c20 6e6f 7420 6c6f 6361 6c20 6f6e 6573  , not local ones
-00008120: 210a 2020 2020 2020 2020 2222 220a 0a20  !.        """.. 
-00008130: 2020 2020 2020 2074 696d 656f 7574 5f6f         timeout_o
-00008140: 7065 7261 7469 6f6e 203d 2031 3230 2020  peration = 120  
-00008150: 2320 7469 6d65 6f75 740a 2020 2020 2020  # timeout.      
-00008160: 2020 7469 6d65 725f 6f70 6572 6174 696f    timer_operatio
-00008170: 6e20 3d20 7469 6d65 2e74 696d 6528 2920  n = time.time() 
-00008180: 2023 2073 7461 7274 2063 6f75 6e74 696e   # start countin
-00008190: 670a 2020 2020 2020 2020 7265 6365 6976  g.        receiv
-000081a0: 6564 5f62 6c6f 636b 5f68 6569 6768 7420  ed_block_height 
-000081b0: 3d20 300a 0a20 2020 2020 2020 2077 6869  = 0..        whi
-000081c0: 6c65 206e 6f74 206e 6f64 652e 7065 6572  le not node.peer
-000081d0: 732e 6973 5f62 616e 6e65 6428 7065 6572  s.is_banned(peer
-000081e0: 5f69 7029 2061 6e64 206e 6f64 652e 7065  _ip) and node.pe
-000081f0: 6572 732e 7665 7273 696f 6e5f 616c 6c6f  ers.version_allo
-00008200: 7765 6428 7065 6572 5f69 702c 206e 6f64  wed(peer_ip, nod
-00008210: 652e 7665 7273 696f 6e5f 616c 6c6f 7729  e.version_allow)
-00008220: 2061 6e64 2063 6c69 656e 745f 696e 7374   and client_inst
-00008230: 616e 6365 2e63 6f6e 6e65 6374 6564 3a0a  ance.connected:.
-00008240: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00008250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008260: 2065 7874 7261 203d 2046 616c 7365 2020   extra = False  
-00008270: 2320 466c 6167 2066 6f72 2070 6c75 6769  # Flag for plugi
-00008280: 6e20 616e 6420 7265 6774 6573 745f 2a20  n and regtest_* 
-00008290: 636f 6d6d 616e 6473 0a20 2020 2020 2020  commands.       
-000082a0: 2020 2020 2020 2020 2023 2046 6169 6c73           # Fails
-000082b0: 6166 650a 2020 2020 2020 2020 2020 2020  afe.            
-000082c0: 2020 2020 6966 2073 656c 662e 7265 7175      if self.requ
-000082d0: 6573 7420 3d3d 202d 313a 0a20 2020 2020  est == -1:.     
-000082e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000082f0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00008300: 6627 496e 626f 756e 643a 2043 6c6f 7365  f'Inbound: Close
-00008310: 6420 736f 636b 6574 2066 726f 6d20 7b70  d socket from {p
-00008320: 6565 725f 6970 7d27 290a 0a20 2020 2020  eer_ip}')..     
-00008330: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00008340: 7420 7469 6d65 2e74 696d 6528 2920 3c3d  t time.time() <=
-00008350: 2074 696d 6572 5f6f 7065 7261 7469 6f6e   timer_operation
-00008360: 202b 2074 696d 656f 7574 5f6f 7065 7261   + timeout_opera
-00008370: 7469 6f6e 3a20 2023 2072 6574 7572 6e20  tion:  # return 
-00008380: 6f6e 2074 696d 656f 7574 0a20 2020 2020  on timeout.     
-00008390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000083a0: 6620 6e6f 6465 2e70 6565 7273 2e77 6172  f node.peers.war
-000083b0: 6e69 6e67 2873 656c 662e 7265 7175 6573  ning(self.reques
-000083c0: 742c 2070 6565 725f 6970 2c20 274f 7065  t, peer_ip, 'Ope
-000083d0: 7261 7469 6f6e 2074 696d 656f 7574 272c  ration timeout',
-000083e0: 2032 293a 0a20 2020 2020 2020 2020 2020   2):.           
-000083f0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00008400: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00008410: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00008420: 7d20 6261 6e6e 6564 2729 0a20 2020 2020  } banned').     
-00008430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008440: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-00008450: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00008460: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00008470: 2749 6e62 6f75 6e64 3a20 4f70 6572 6174  'Inbound: Operat
-00008480: 696f 6e20 7469 6d65 6f75 7420 6672 6f6d  ion timeout from
-00008490: 207b 7065 6572 5f69 707d 2729 0a0a 2020   {peer_ip}')..  
-000084a0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-000084b0: 7461 203d 2072 6563 6569 7665 2873 656c  ta = receive(sel
-000084c0: 662e 7265 7175 6573 7429 0a0a 2020 2020  f.request)..    
-000084d0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000084e0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-000084f0: 696e 666f 2866 2749 6e62 6f75 6e64 3a20  info(f'Inbound: 
-00008500: 5265 6365 6976 6564 3a20 7b64 6174 617d  Received: {data}
-00008510: 2066 726f 6d20 7b70 6565 725f 6970 7d27   from {peer_ip}'
-00008520: 2920 2023 2077 696c 6c20 6164 6420 6375  )  # will add cu
-00008530: 7374 6f6d 2070 6f72 7473 206c 6174 6572  stom ports later
-00008540: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00008550: 2020 6966 2064 6174 612e 7374 6172 7473    if data.starts
-00008560: 7769 7468 2827 7265 6774 6573 745f 2729  with('regtest_')
-00008570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008580: 2020 2020 2020 6966 206e 6f74 206e 6f64        if not nod
-00008590: 652e 6973 5f72 6567 6e65 743a 0a20 2020  e.is_regnet:.   
-000085a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085b0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-000085c0: 6571 7565 7374 2c20 276e 6f74 6f6b 2729  equest, 'notok')
-000085d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000085e0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000085f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008600: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00008610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008620: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
-00008630: 7461 6e63 652e 6578 6563 7574 6528 6462  tance.execute(db
-00008640: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
-00008650: 652e 632c 2027 5345 4c45 4354 2062 6c6f  e.c, 'SELECT blo
-00008660: 636b 5f68 6173 6820 4652 4f4d 2074 7261  ck_hash FROM tra
-00008670: 6e73 6163 7469 6f6e 7320 5748 4552 4520  nsactions WHERE 
-00008680: 626c 6f63 6b5f 6865 6967 6874 3d20 2873  block_height= (s
-00008690: 656c 6563 7420 6d61 7828 626c 6f63 6b5f  elect max(block_
-000086a0: 6865 6967 6874 2920 6672 6f6d 2074 7261  height) from tra
-000086b0: 6e73 6163 7469 6f6e 7329 2729 0a20 2020  nsactions)').   
-000086c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086d0: 2020 2020 2062 6c6f 636b 5f68 6173 6820       block_hash 
-000086e0: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
-000086f0: 7461 6e63 652e 632e 6665 7463 686f 6e65  tance.c.fetchone
-00008700: 2829 5b30 5d0a 2020 2020 2020 2020 2020  ()[0].          
-00008710: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00008720: 6665 6564 2072 6567 6e65 7420 7769 7468  feed regnet with
-00008730: 2063 7572 7265 6e74 2074 6872 6561 6420   current thread 
-00008740: 6462 2068 616e 646c 652e 2072 6566 6163  db handle. refac
-00008750: 746f 7220 6e65 6564 6564 2e0a 2020 2020  tor needed..    
+000063f0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+00006400: 6572 2e61 7070 5f6c 6f67 2e64 6562 7567  er.app_log.debug
+00006410: 286d 702e 4d45 4d50 4f4f 4c2e 6d65 7267  (mp.MEMPOOL.merg
+00006420: 6528 2874 785b 315d 2c20 7478 5b32 5d2c  e((tx[1], tx[2],
+00006430: 2074 785b 335d 2c20 7478 5b34 5d2c 2074   tx[3], tx[4], t
+00006440: 785b 355d 2c20 7478 5b36 5d2c 2074 785b  x[5], tx[6], tx[
+00006450: 3130 5d2c 2074 785b 3131 5d29 2c20 7065  10], tx[11]), pe
+00006460: 6572 5f69 702c 2064 625f 6861 6e64 6c65  er_ip, db_handle
+00006470: 722e 632c 2046 616c 7365 2c20 7265 7665  r.c, False, reve
+00006480: 7274 3d54 7275 6529 2920 2023 2077 696c  rt=True))  # wil
+00006490: 6c20 6765 7420 7374 7563 6b20 6966 2079  l get stuck if y
+000064a0: 6f75 2063 6861 6e67 6520 6974 2074 6f20  ou change it to 
+000064b0: 7265 7370 6563 7420 6e6f 6465 2e64 625f  respect node.db_
+000064c0: 6c6f 636b 0a20 2020 2020 2020 2020 2020  lock.           
+000064d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064e0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+000064f0: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+00006500: 2866 274d 6f76 6564 2074 7820 6261 636b  (f'Moved tx back
+00006510: 2074 6f20 6d65 6d70 6f6f 6c3a 207b 7478   to mempool: {tx
+00006520: 5f73 686f 7274 7d27 290a 2020 2020 2020  _short}').      
+00006530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006540: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00006550: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00006560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006570: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00006580: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00006590: 2e65 7272 6f72 2866 2745 7272 6f72 2064  .error(f'Error d
+000065a0: 7572 696e 6720 6d6f 7669 6e67 2074 7820  uring moving tx 
+000065b0: 6261 636b 2074 6f20 6d65 6d70 6f6f 6c3a  back to mempool:
+000065c0: 207b 657d 2729 0a20 2020 2020 2020 2020   {e}').         
+000065d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000065e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000065f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006600: 2023 2049 7427 7320 7468 6520 636f 696e   # It's the coin
+00006610: 6261 7365 2074 782c 2073 6f20 7765 2067  base tx, so we g
+00006620: 6574 2074 6865 206d 696e 6572 2061 6464  et the miner add
+00006630: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
+00006640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006650: 206d 696e 6572 203d 2074 785b 335d 0a20   miner = tx[3]. 
+00006660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006670: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00006680: 7420 3d20 7478 5b30 5d0a 2020 2020 2020  t = tx[0].      
+00006690: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+000066a0: 6c6c 6261 636b 203d 207b 2774 696d 6573  llback = {'times
+000066b0: 7461 6d70 273a 206d 795f 7469 6d65 2c20  tamp': my_time, 
+000066c0: 2768 6569 6768 7427 3a20 6865 6967 6874  'height': height
+000066d0: 2c20 2769 7027 3a20 7065 6572 5f69 702c  , 'ip': peer_ip,
+000066e0: 2027 6d69 6e65 7227 3a20 6d69 6e65 722c   'miner': miner,
+000066f0: 2027 6861 7368 273a 2064 625f 626c 6f63   'hash': db_bloc
+00006700: 6b5f 6861 7368 2c20 2774 785f 636f 756e  k_hash, 'tx_coun
+00006710: 7427 3a20 6e62 5f74 782c 2027 736b 6970  t': nb_tx, 'skip
+00006720: 7065 6427 3a20 4661 6c73 652c 2027 7265  ped': False, 're
+00006730: 6173 6f6e 273a 2027 277d 0a20 2020 2020  ason': ''}.     
+00006740: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00006750: 6f64 652e 706c 7567 696e 5f6d 616e 6167  ode.plugin_manag
+00006760: 6572 2e65 7865 6375 7465 5f61 6374 696f  er.execute_actio
+00006770: 6e5f 686f 6f6b 2827 726f 6c6c 6261 636b  n_hook('rollback
+00006780: 272c 2072 6f6c 6c62 6163 6b29 0a0a 2020  ', rollback)..  
+00006790: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000067a0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+000067b0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+000067c0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+000067d0: 6767 6572 2e61 7070 5f6c 6f67 2e65 7272  gger.app_log.err
+000067e0: 6f72 2866 2745 7272 6f72 2064 7572 696e  or(f'Error durin
+000067f0: 6720 6d6f 7669 6e67 2074 7873 2062 6163  g moving txs bac
+00006800: 6b20 746f 206d 656d 706f 6f6c 3a20 7b65  k to mempool: {e
+00006810: 7d27 290a 0a20 2020 2065 6c73 653a 0a20  }')..    else:. 
+00006820: 2020 2020 2020 2072 6561 736f 6e20 3d20         reason = 
+00006830: 2753 6b69 7070 696e 6720 726f 6c6c 6261  'Skipping rollba
+00006840: 636b 2c20 6f74 6865 7220 6c65 6467 6572  ck, other ledger
+00006850: 206f 7065 7261 7469 6f6e 2069 6e20 7072   operation in pr
+00006860: 6f67 7265 7373 270a 2020 2020 2020 2020  ogress'.        
+00006870: 726f 6c6c 6261 636b 203d 207b 2774 696d  rollback = {'tim
+00006880: 6573 7461 6d70 273a 206d 795f 7469 6d65  estamp': my_time
+00006890: 2c20 2769 7027 3a20 7065 6572 5f69 702c  , 'ip': peer_ip,
+000068a0: 2027 736b 6970 7065 6427 3a20 5472 7565   'skipped': True
+000068b0: 2c20 2772 6561 736f 6e27 3a20 7265 6173  , 'reason': reas
+000068c0: 6f6e 7d0a 2020 2020 2020 2020 6e6f 6465  on}.        node
+000068d0: 2e70 6c75 6769 6e5f 6d61 6e61 6765 722e  .plugin_manager.
+000068e0: 6578 6563 7574 655f 6163 7469 6f6e 5f68  execute_action_h
+000068f0: 6f6f 6b28 2772 6f6c 6c62 6163 6b27 2c20  ook('rollback', 
+00006900: 726f 6c6c 6261 636b 290a 2020 2020 2020  rollback).      
+00006910: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+00006920: 705f 6c6f 672e 6465 6275 6728 7265 6173  p_log.debug(reas
+00006930: 6f6e 290a 0a0a 6465 6620 7365 7175 656e  on)...def sequen
+00006940: 6369 6e67 5f63 6865 636b 2864 625f 6861  cing_check(db_ha
+00006950: 6e64 6c65 7229 3a0a 2020 2020 2320 544f  ndler):.    # TO
+00006960: 444f 3a20 4361 6e64 6964 6174 6520 666f  DO: Candidate fo
+00006970: 7220 7369 6e67 6c65 2075 7365 7220 6d6f  r single user mo
+00006980: 6465 0a20 2020 2074 7279 3a0a 2020 2020  de.    try:.    
+00006990: 2020 2020 7769 7468 206f 7065 6e28 2773      with open('s
+000069a0: 6571 7565 6e63 696e 675f 6c61 7374 272c  equencing_last',
+000069b0: 2027 7227 2920 6173 2066 696c 656e 616d   'r') as filenam
+000069c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000069d0: 6571 7565 6e63 696e 675f 6c61 7374 203d  equencing_last =
+000069e0: 2069 6e74 2866 696c 656e 616d 652e 7265   int(filename.re
+000069f0: 6164 2829 290a 0a20 2020 2065 7863 6570  ad())..    excep
+00006a00: 743a 0a20 2020 2020 2020 206e 6f64 652e  t:.        node.
+00006a10: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+00006a20: 6172 6e69 6e67 2827 5365 7175 656e 6369  arning('Sequenci
+00006a30: 6e67 2061 6e63 686f 7220 6e6f 7420 666f  ng anchor not fo
+00006a40: 756e 642c 2067 6f69 6e67 2074 6872 6f75  und, going throu
+00006a50: 6768 2074 6865 2077 686f 6c65 2063 6861  gh the whole cha
+00006a60: 696e 2729 0a20 2020 2020 2020 2073 6571  in').        seq
+00006a70: 7565 6e63 696e 675f 6c61 7374 203d 2030  uencing_last = 0
+00006a80: 0a0a 2020 2020 6e6f 6465 2e6c 6f67 6765  ..    node.logge
+00006a90: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00006aa0: 6728 6627 5374 6174 7573 3a20 5465 7374  g(f'Status: Test
+00006ab0: 696e 6720 6368 6169 6e20 7365 7175 656e  ing chain sequen
+00006ac0: 6369 6e67 2c20 7374 6172 7469 6e67 2077  cing, starting w
+00006ad0: 6974 6820 626c 6f63 6b20 7b73 6571 7565  ith block {seque
+00006ae0: 6e63 696e 675f 6c61 7374 7d27 290a 0a20  ncing_last}').. 
+00006af0: 2020 2063 6861 696e 735f 746f 5f63 6865     chains_to_che
+00006b00: 636b 203d 205b 6e6f 6465 2e6c 6564 6765  ck = [node.ledge
+00006b10: 725f 7061 7468 2c20 6e6f 6465 2e68 7970  r_path, node.hyp
+00006b20: 6572 5f70 6174 685d 0a0a 2020 2020 666f  er_path]..    fo
+00006b30: 7220 6368 6169 6e20 696e 2063 6861 696e  r chain in chain
+00006b40: 735f 746f 5f63 6865 636b 3a0a 2020 2020  s_to_check:.    
+00006b50: 2020 2020 636f 6e6e 203d 2073 716c 6974      conn = sqlit
+00006b60: 6533 2e63 6f6e 6e65 6374 2863 6861 696e  e3.connect(chain
+00006b70: 2c20 7469 6d65 6f75 743d 3129 0a20 2020  , timeout=1).   
+00006b80: 2020 2020 2069 6620 6e6f 6465 2e74 7261       if node.tra
+00006b90: 6365 5f64 625f 6361 6c6c 733a 0a20 2020  ce_db_calls:.   
+00006ba0: 2020 2020 2020 2020 2063 6f6e 6e2e 7365           conn.se
+00006bb0: 745f 7472 6163 655f 6361 6c6c 6261 636b  t_trace_callback
+00006bc0: 2866 756e 6374 6f6f 6c73 2e70 6172 7469  (functools.parti
+00006bd0: 616c 2873 716c 5f74 7261 6365 5f63 616c  al(sql_trace_cal
+00006be0: 6c62 6163 6b2c 206e 6f64 652e 6c6f 6767  lback, node.logg
+00006bf0: 6572 2e61 7070 5f6c 6f67 2c20 2753 4551  er.app_log, 'SEQ
+00006c00: 5545 4e43 452d 4348 4543 4b2d 4348 4149  UENCE-CHECK-CHAI
+00006c10: 4e27 2929 0a20 2020 2020 2020 2063 203d  N')).        c =
+00006c20: 2063 6f6e 6e2e 6375 7273 6f72 2829 0a0a   conn.cursor()..
+00006c30: 2020 2020 2020 2020 2320 7065 7266 6f72          # perfor
+00006c40: 6d20 7465 7374 206f 6e20 7472 616e 7361  m test on transa
+00006c50: 6374 696f 6e20 7461 626c 650a 2020 2020  ction table.    
+00006c60: 2020 2020 7920 3d20 4e6f 6e65 0a20 2020      y = None.   
+00006c70: 2020 2020 2023 2045 6767 3a20 6e6f 7420       # Egg: not 
+00006c80: 7375 7265 2062 6c6f 636b 5f68 6569 6768  sure block_heigh
+00006c90: 7420 213d 2028 3020 4f52 2031 2920 2067  t != (0 OR 1)  g
+00006ca0: 6976 6573 2074 6865 2070 726f 7065 7220  ives the proper 
+00006cb0: 7265 7375 6c74 2c20 3020 6f72 2031 2020  result, 0 or 1  
+00006cc0: 3d20 312e 206e 6f74 2069 6e20 2830 2c20  = 1. not in (0, 
+00006cd0: 3129 2063 6f75 6c64 2062 6520 6265 7474  1) could be bett
+00006ce0: 6572 2e0a 2020 2020 2020 2020 666f 7220  er..        for 
+00006cf0: 726f 7720 696e 2063 2e65 7865 6375 7465  row in c.execute
+00006d00: 2827 5345 4c45 4354 2062 6c6f 636b 5f68  ('SELECT block_h
+00006d10: 6569 6768 7420 4652 4f4d 2074 7261 6e73  eight FROM trans
+00006d20: 6163 7469 6f6e 7320 5748 4552 4520 7265  actions WHERE re
+00006d30: 7761 7264 2021 3d20 3020 414e 4420 626c  ward != 0 AND bl
+00006d40: 6f63 6b5f 6865 6967 6874 203e 2031 2041  ock_height > 1 A
+00006d50: 4e44 2062 6c6f 636b 5f68 6569 6768 7420  ND block_height 
+00006d60: 3e3d 203f 204f 5244 4552 2042 5920 626c  >= ? ORDER BY bl
+00006d70: 6f63 6b5f 6865 6967 6874 2041 5343 272c  ock_height ASC',
+00006d80: 2028 7365 7175 656e 6369 6e67 5f6c 6173   (sequencing_las
+00006d90: 742c 2029 293a 0a20 2020 2020 2020 2020  t, )):.         
+00006da0: 2020 2079 5f69 6e69 7420 3d20 726f 775b     y_init = row[
+00006db0: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
+00006dc0: 6966 2079 2069 7320 4e6f 6e65 3a0a 2020  if y is None:.  
+00006dd0: 2020 2020 2020 2020 2020 2020 2020 7920                y 
+00006de0: 3d20 795f 696e 6974 0a0a 2020 2020 2020  = y_init..      
+00006df0: 2020 2020 2020 6966 2072 6f77 5b30 5d20        if row[0] 
+00006e00: 213d 2079 3a0a 0a20 2020 2020 2020 2020  != y:..         
+00006e10: 2020 2020 2020 2066 6f72 2063 6861 696e         for chain
+00006e20: 3220 696e 2063 6861 696e 735f 746f 5f63  2 in chains_to_c
+00006e30: 6865 636b 3a0a 2020 2020 2020 2020 2020  heck:.          
+00006e40: 2020 2020 2020 2020 2020 636f 6e6e 3220            conn2 
+00006e50: 3d20 7371 6c69 7465 332e 636f 6e6e 6563  = sqlite3.connec
+00006e60: 7428 6368 6169 6e32 2c20 7469 6d65 6f75  t(chain2, timeou
+00006e70: 743d 3129 0a20 2020 2020 2020 2020 2020  t=1).           
+00006e80: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+00006e90: 2e74 7261 6365 5f64 625f 6361 6c6c 733a  .trace_db_calls:
+00006ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006eb0: 2020 2020 2020 2020 2063 6f6e 6e32 2e73           conn2.s
+00006ec0: 6574 5f74 7261 6365 5f63 616c 6c62 6163  et_trace_callbac
+00006ed0: 6b28 6675 6e63 746f 6f6c 732e 7061 7274  k(functools.part
+00006ee0: 6961 6c28 7371 6c5f 7472 6163 655f 6361  ial(sql_trace_ca
+00006ef0: 6c6c 6261 636b 2c20 6e6f 6465 2e6c 6f67  llback, node.log
+00006f00: 6765 722e 6170 705f 6c6f 672c 2027 5345  ger.app_log, 'SE
+00006f10: 5155 454e 4345 2d43 4845 434b 2d43 4841  QUENCE-CHECK-CHA
+00006f20: 494e 3227 2929 0a20 2020 2020 2020 2020  IN2')).         
+00006f30: 2020 2020 2020 2020 2020 2063 3220 3d20             c2 = 
+00006f40: 636f 6e6e 322e 6375 7273 6f72 2829 0a20  conn2.cursor(). 
+00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f60: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+00006f70: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
+00006f80: 2753 7461 7475 733a 2043 6861 696e 207b  'Status: Chain {
+00006f90: 6368 6169 6e7d 2074 7261 6e73 6163 7469  chain} transacti
+00006fa0: 6f6e 2073 6571 7565 6e63 696e 6720 6572  on sequencing er
+00006fb0: 726f 7220 6174 3a20 7b72 6f77 5b30 5d7d  ror at: {row[0]}
+00006fc0: 2e20 7b72 6f77 5b30 5d7d 2069 6e73 7465  . {row[0]} inste
+00006fd0: 6164 206f 6620 7b79 7d27 290a 2020 2020  ad of {y}').    
+00006fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ff0: 6332 2e65 7865 6375 7465 2827 4445 4c45  c2.execute('DELE
+00007000: 5445 2046 524f 4d20 7472 616e 7361 6374  TE FROM transact
+00007010: 696f 6e73 2057 4845 5245 2062 6c6f 636b  ions WHERE block
+00007020: 5f68 6569 6768 7420 3e3d 203f 204f 5220  _height >= ? OR 
+00007030: 626c 6f63 6b5f 6865 6967 6874 203c 3d20  block_height <= 
+00007040: 3f27 2c20 280a 2020 2020 2020 2020 2020  ?', (.          
+00007050: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+00007060: 775b 305d 2c0a 2020 2020 2020 2020 2020  w[0],.          
+00007070: 2020 2020 2020 2020 2020 2020 2020 2d72                -r
+00007080: 6f77 5b30 5d2c 0a20 2020 2020 2020 2020  ow[0],.         
+00007090: 2020 2020 2020 2020 2020 2029 290a 2020             )).  
+000070a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070b0: 2020 636f 6e6e 322e 636f 6d6d 6974 2829    conn2.commit()
+000070c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000070d0: 2020 2020 2063 322e 6578 6563 7574 6528       c2.execute(
+000070e0: 2744 454c 4554 4520 4652 4f4d 206d 6973  'DELETE FROM mis
+000070f0: 6320 5748 4552 4520 626c 6f63 6b5f 6865  c WHERE block_he
+00007100: 6967 6874 203e 3d20 3f27 2c20 2872 6f77  ight >= ?', (row
+00007110: 5b30 5d2c 2029 290a 2020 2020 2020 2020  [0], )).        
+00007120: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
+00007130: 322e 636f 6d6d 6974 2829 0a0a 2020 2020  2.commit()..    
+00007140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007150: 2320 726f 6c6c 6261 636b 2069 6e64 6963  # rollback indic
+00007160: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00007170: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00007180: 722e 746f 6b65 6e73 5f72 6f6c 6c62 6163  r.tokens_rollbac
+00007190: 6b28 6e6f 6465 2c20 7929 0a20 2020 2020  k(node, y).     
+000071a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000071b0: 625f 6861 6e64 6c65 722e 616c 6961 7365  b_handler.aliase
+000071c0: 735f 726f 6c6c 6261 636b 286e 6f64 652c  s_rollback(node,
+000071d0: 2079 290a 0a20 2020 2020 2020 2020 2020   y)..           
+000071e0: 2020 2020 2020 2020 2023 2072 6f6c 6c62           # rollb
+000071f0: 6163 6b20 696e 6469 6365 730a 0a20 2020  ack indices..   
+00007200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007210: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00007220: 5f6c 6f67 2e77 6172 6e69 6e67 2866 2753  _log.warning(f'S
+00007230: 7461 7475 733a 2044 7565 2074 6f20 6120  tatus: Due to a 
+00007240: 7365 7175 656e 6369 6e67 2069 7373 7565  sequencing issue
+00007250: 2061 7420 626c 6f63 6b20 7b79 7d2c 207b   at block {y}, {
+00007260: 6368 6169 6e7d 2068 6173 2062 6565 6e20  chain} has been 
+00007270: 726f 6c6c 6564 2062 6163 6b20 616e 6420  rolled back and 
+00007280: 7769 6c6c 2062 6520 7265 7379 6e63 6872  will be resynchr
+00007290: 6f6e 697a 6564 2729 0a20 2020 2020 2020  onized').       
+000072a0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+000072b0: 2020 2020 2020 2020 2020 2020 7920 3d20              y = 
+000072c0: 7920 2b20 310a 0a20 2020 2020 2020 2023  y + 1..        #
+000072d0: 2070 6572 666f 726d 2074 6573 7420 6f6e   perform test on
+000072e0: 206d 6973 6320 7461 626c 650a 2020 2020   misc table.    
+000072f0: 2020 2020 7920 3d20 4e6f 6e65 0a0a 2020      y = None..  
+00007300: 2020 2020 2020 666f 7220 726f 7720 696e        for row in
+00007310: 2063 2e65 7865 6375 7465 2827 5345 4c45   c.execute('SELE
+00007320: 4354 2062 6c6f 636b 5f68 6569 6768 7420  CT block_height 
+00007330: 4652 4f4d 206d 6973 6320 5748 4552 4520  FROM misc WHERE 
+00007340: 626c 6f63 6b5f 6865 6967 6874 203e 203f  block_height > ?
+00007350: 204f 5244 4552 2042 5920 626c 6f63 6b5f   ORDER BY block_
+00007360: 6865 6967 6874 2041 5343 272c 2028 3330  height ASC', (30
+00007370: 3030 3030 2c20 2929 3a0a 2020 2020 2020  0000, )):.      
+00007380: 2020 2020 2020 795f 696e 6974 203d 2072        y_init = r
+00007390: 6f77 5b30 5d0a 0a20 2020 2020 2020 2020  ow[0]..         
+000073a0: 2020 2069 6620 7920 6973 204e 6f6e 653a     if y is None:
+000073b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000073c0: 2079 203d 2079 5f69 6e69 740a 2020 2020   y = y_init.    
+000073d0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+000073e0: 696e 7428 2261 7373 6967 6e65 6422 290a  int("assigned").
+000073f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007400: 2320 7072 696e 7428 726f 775b 305d 2c20  # print(row[0], 
+00007410: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00007420: 6966 2072 6f77 5b30 5d20 213d 2079 3a0a  if row[0] != y:.
+00007430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007440: 2320 7072 696e 7428 726f 775b 305d 2c20  # print(row[0], 
+00007450: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
+00007460: 2020 2066 6f72 2063 6861 696e 3220 696e     for chain2 in
+00007470: 2063 6861 696e 735f 746f 5f63 6865 636b   chains_to_check
+00007480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007490: 2020 2020 2020 636f 6e6e 3220 3d20 7371        conn2 = sq
+000074a0: 6c69 7465 332e 636f 6e6e 6563 7428 6368  lite3.connect(ch
+000074b0: 6169 6e32 2c20 7469 6d65 6f75 743d 3129  ain2, timeout=1)
+000074c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000074d0: 2020 2020 2069 6620 6e6f 6465 2e74 7261       if node.tra
+000074e0: 6365 5f64 625f 6361 6c6c 733a 0a20 2020  ce_db_calls:.   
+000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007500: 2020 2020 2063 6f6e 6e32 2e73 6574 5f74       conn2.set_t
+00007510: 7261 6365 5f63 616c 6c62 6163 6b28 6675  race_callback(fu
+00007520: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
+00007530: 7371 6c5f 7472 6163 655f 6361 6c6c 6261  sql_trace_callba
+00007540: 636b 2c20 6e6f 6465 2e6c 6f67 6765 722e  ck, node.logger.
+00007550: 6170 705f 6c6f 672c 2027 5345 5155 454e  app_log, 'SEQUEN
+00007560: 4345 2d43 4845 434b 2d43 4841 494e 3242  CE-CHECK-CHAIN2B
+00007570: 2729 290a 2020 2020 2020 2020 2020 2020  ')).            
+00007580: 2020 2020 2020 2020 6332 203d 2063 6f6e          c2 = con
+00007590: 6e32 2e63 7572 736f 7228 290a 2020 2020  n2.cursor().    
+000075a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075b0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+000075c0: 6c6f 672e 7761 726e 696e 6728 6627 5374  log.warning(f'St
+000075d0: 6174 7573 3a20 4368 6169 6e20 7b63 6861  atus: Chain {cha
+000075e0: 696e 7d20 6469 6666 6963 756c 7479 2073  in} difficulty s
+000075f0: 6571 7565 6e63 696e 6720 6572 726f 7220  equencing error 
+00007600: 6174 3a20 7b72 6f77 5b30 5d7d 2e20 7b72  at: {row[0]}. {r
+00007610: 6f77 5b30 5d7d 2069 6e73 7465 6164 206f  ow[0]} instead o
+00007620: 6620 7b79 7d27 290a 2020 2020 2020 2020  f {y}').        
+00007630: 2020 2020 2020 2020 2020 2020 6332 2e65              c2.e
+00007640: 7865 6375 7465 2827 4445 4c45 5445 2046  xecute('DELETE F
+00007650: 524f 4d20 7472 616e 7361 6374 696f 6e73  ROM transactions
+00007660: 2057 4845 5245 2062 6c6f 636b 5f68 6569   WHERE block_hei
+00007670: 6768 7420 3e3d 203f 272c 2028 726f 775b  ght >= ?', (row[
+00007680: 305d 2c20 2929 0a20 2020 2020 2020 2020  0], )).         
+00007690: 2020 2020 2020 2020 2020 2063 6f6e 6e32             conn2
+000076a0: 2e63 6f6d 6d69 7428 290a 2020 2020 2020  .commit().      
+000076b0: 2020 2020 2020 2020 2020 2020 2020 6332                c2
+000076c0: 2e65 7865 6375 7465 2827 4445 4c45 5445  .execute('DELETE
+000076d0: 2046 524f 4d20 6d69 7363 2057 4845 5245   FROM misc WHERE
+000076e0: 2062 6c6f 636b 5f68 6569 6768 7420 3e3d   block_height >=
+000076f0: 203f 272c 2028 726f 775b 305d 2c20 2929   ?', (row[0], ))
+00007700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007710: 2020 2020 2063 6f6e 6e32 2e63 6f6d 6d69       conn2.commi
+00007720: 7428 290a 0a20 2020 2020 2020 2020 2020  t()..           
+00007730: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+00007740: 6c65 722e 6578 6563 7574 655f 7061 7261  ler.execute_para
+00007750: 6d28 636f 6e6e 322c 2028 2744 454c 4554  m(conn2, ('DELET
+00007760: 4520 4652 4f4d 2074 7261 6e73 6163 7469  E FROM transacti
+00007770: 6f6e 7320 5748 4552 4520 6164 6472 6573  ons WHERE addres
+00007780: 7320 3d20 2244 6576 656c 6f70 6d65 6e74  s = "Development
+00007790: 2052 6577 6172 6422 2041 4e44 2062 6c6f   Reward" AND blo
+000077a0: 636b 5f68 6569 6768 7420 3c3d 203f 2729  ck_height <= ?')
+000077b0: 2c20 282d 726f 775b 305d 2c20 2929 0a20  , (-row[0], )). 
+000077c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077d0: 2020 2063 6f6e 6e32 2e63 6f6d 6d69 7428     conn2.commit(
+000077e0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000077f0: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00007800: 722e 6578 6563 7574 655f 7061 7261 6d28  r.execute_param(
+00007810: 636f 6e6e 322c 2028 2744 454c 4554 4520  conn2, ('DELETE 
+00007820: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
+00007830: 7320 5748 4552 4520 6164 6472 6573 7320  s WHERE address 
+00007840: 3d20 2248 7970 6572 6e6f 6465 2050 6179  = "Hypernode Pay
+00007850: 6f75 7473 2220 414e 4420 626c 6f63 6b5f  outs" AND block_
+00007860: 6865 6967 6874 203c 3d20 3f27 292c 2028  height <= ?'), (
+00007870: 2d72 6f77 5b30 5d2c 2029 290a 2020 2020  -row[0], )).    
+00007880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007890: 636f 6e6e 322e 636f 6d6d 6974 2829 0a20  conn2.commit(). 
+000078a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078b0: 2020 2063 6f6e 6e32 2e63 6c6f 7365 2829     conn2.close()
+000078c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000078d0: 2020 2020 2020 2320 726f 6c6c 6261 636b        # rollback
+000078e0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+000078f0: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+00007900: 6861 6e64 6c65 722e 746f 6b65 6e73 5f72  handler.tokens_r
+00007910: 6f6c 6c62 6163 6b28 6e6f 6465 2c20 7929  ollback(node, y)
+00007920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007930: 2020 2020 2064 625f 6861 6e64 6c65 722e       db_handler.
+00007940: 616c 6961 7365 735f 726f 6c6c 6261 636b  aliases_rollback
+00007950: 286e 6f64 652c 2079 290a 2020 2020 2020  (node, y).      
+00007960: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00007970: 726f 6c6c 6261 636b 2069 6e64 6963 6573  rollback indices
+00007980: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007990: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+000079a0: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+000079b0: 6728 6627 5374 6174 7573 3a20 4475 6520  g(f'Status: Due 
+000079c0: 746f 2061 2073 6571 7565 6e63 696e 6720  to a sequencing 
+000079d0: 6973 7375 6520 6174 2062 6c6f 636b 207b  issue at block {
+000079e0: 797d 2c20 7b63 6861 696e 7d20 6861 7320  y}, {chain} has 
+000079f0: 6265 656e 2072 6f6c 6c65 6420 6261 636b  been rolled back
+00007a00: 2061 6e64 2077 696c 6c20 6265 2072 6573   and will be res
+00007a10: 796e 6368 726f 6e69 7a65 6427 290a 2020  ynchronized').  
+00007a20: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00007a30: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+00007a40: 2079 203d 2079 202b 2031 0a0a 2020 2020   y = y + 1..    
+00007a50: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+00007a60: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+00007a70: 6627 5374 6174 7573 3a20 4368 6169 6e20  f'Status: Chain 
+00007a80: 7365 7175 656e 6369 6e67 2074 6573 7420  sequencing test 
+00007a90: 636f 6d70 6c65 7465 2066 6f72 207b 6368  complete for {ch
+00007aa0: 6169 6e7d 2729 0a20 2020 2020 2020 2063  ain}').        c
+00007ab0: 6f6e 6e2e 636c 6f73 6528 290a 0a20 2020  onn.close()..   
+00007ac0: 2020 2020 2069 6620 793a 0a20 2020 2020       if y:.     
+00007ad0: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00007ae0: 2827 7365 7175 656e 6369 6e67 5f6c 6173  ('sequencing_las
+00007af0: 7427 2c20 2777 2729 2061 7320 6669 6c65  t', 'w') as file
+00007b00: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
+00007b10: 2020 2020 2020 6669 6c65 6e61 6d65 2e77        filename.w
+00007b20: 7269 7465 2873 7472 2879 202d 2031 3030  rite(str(y - 100
+00007b30: 3029 2920 2023 2072 6f6f 6d20 666f 7220  0))  # room for 
+00007b40: 726f 6c6c 6261 636b 730a 0a0a 2320 696e  rollbacks...# in
+00007b50: 6974 0a0a 0a63 6c61 7373 2054 6872 6561  it...class Threa
+00007b60: 6465 6454 4350 5265 7175 6573 7448 616e  dedTCPRequestHan
+00007b70: 646c 6572 2873 6f63 6b65 7473 6572 7665  dler(socketserve
+00007b80: 722e 4261 7365 5265 7175 6573 7448 616e  r.BaseRequestHan
+00007b90: 646c 6572 293a 0a0a 2020 2020 6465 6620  dler):..    def 
+00007ba0: 6861 6e64 6c65 2873 656c 6629 3a0a 2020  handle(self):.  
+00007bb0: 2020 2020 2020 2320 7468 6973 2069 7320        # this is 
+00007bc0: 6120 6465 6469 6361 7465 6420 7468 7265  a dedicated thre
+00007bd0: 6164 2066 6f72 2065 6163 6820 636c 6965  ad for each clie
+00007be0: 6e74 2028 6e6f 7420 6970 290a 2020 2020  nt (not ip).    
+00007bf0: 2020 2020 6966 206e 6f64 652e 4953 5f53      if node.IS_S
+00007c00: 544f 5050 494e 473a 0a20 2020 2020 2020  TOPPING:.       
+00007c10: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+00007c20: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+00007c30: 2827 496e 626f 756e 643a 2052 656a 6563  ('Inbound: Rejec
+00007c40: 7465 6420 696e 636f 6d69 6e67 2063 6e78  ted incoming cnx
+00007c50: 2c20 6e6f 6465 2069 7320 7374 6f70 7069  , node is stoppi
+00007c60: 6e67 2729 0a20 2020 2020 2020 2020 2020  ng').           
+00007c70: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+00007c80: 2063 6c69 656e 745f 696e 7374 616e 6365   client_instance
+00007c90: 203d 2063 6c69 656e 742e 436c 6965 6e74   = client.Client
+00007ca0: 2829 0a0a 2020 2020 2020 2020 7472 793a  ()..        try:
+00007cb0: 0a20 2020 2020 2020 2020 2020 2070 6565  .            pee
+00007cc0: 725f 6970 5f70 6f72 7420 3d20 7365 6c66  r_ip_port = self
+00007cd0: 2e72 6571 7565 7374 2e67 6574 7065 6572  .request.getpeer
+00007ce0: 6e61 6d65 2829 0a20 2020 2020 2020 2020  name().         
+00007cf0: 2020 2070 6565 725f 6970 203d 2070 6565     peer_ip = pee
+00007d00: 725f 6970 5f70 6f72 745b 305d 0a20 2020  r_ip_port[0].   
+00007d10: 2020 2020 2020 2020 2070 6565 725f 706f           peer_po
+00007d20: 7274 203d 2070 6565 725f 6970 5f70 6f72  rt = peer_ip_por
+00007d30: 745b 315d 0a20 2020 2020 2020 2065 7863  t[1].        exc
+00007d40: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+00007d50: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00007d60: 5f6c 6f67 2e77 6172 6e69 6e67 2827 496e  _log.warning('In
+00007d70: 626f 756e 643a 2054 7261 6e73 706f 7274  bound: Transport
+00007d80: 2065 6e64 706f 696e 7420 7761 7320 6e6f   endpoint was no
+00007d90: 7420 636f 6e6e 6563 7465 6427 290a 2020  t connected').  
+00007da0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00007db0: 0a0a 2020 2020 2020 2020 7468 7265 6164  ..        thread
+00007dc0: 696e 672e 6375 7272 656e 745f 7468 7265  ing.current_thre
+00007dd0: 6164 2829 2e6e 616d 6520 3d20 6627 696e  ad().name = f'in
+00007de0: 5f7b 7065 6572 5f69 707d 5f7b 7065 6572  _{peer_ip}_{peer
+00007df0: 5f70 6f72 747d 270a 0a20 2020 2020 2020  _port}'..       
+00007e00: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00007e10: 5f6c 6f67 2e64 6562 7567 2866 2749 6e63  _log.debug(f'Inc
+00007e20: 6f6d 696e 6720 636f 6e6e 6563 7469 6f6e  oming connection
+00007e30: 3a20 7b73 656c 662e 7265 7175 6573 747d  : {self.request}
+00007e40: 2729 0a0a 2020 2020 2020 2020 2320 6462  ')..        # db
+00007e50: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+00007e60: 6520 3d20 6462 6861 6e64 6c65 722e 4462  e = dbhandler.Db
+00007e70: 4861 6e64 6c65 7228 6e6f 6465 2e69 6e64  Handler(node.ind
+00007e80: 6578 5f64 622c 206e 6f64 652e 6c65 6467  ex_db, node.ledg
+00007e90: 6572 5f70 6174 682c 206e 6f64 652e 6879  er_path, node.hy
+00007ea0: 7065 725f 7061 7468 2c20 6e6f 6465 2e72  per_path, node.r
+00007eb0: 616d 2c20 6e6f 6465 2e6c 6564 6765 725f  am, node.ledger_
+00007ec0: 7261 6d5f 6669 6c65 2c20 6e6f 6465 2e6c  ram_file, node.l
+00007ed0: 6f67 6765 722c 2074 7261 6365 5f64 625f  ogger, trace_db_
+00007ee0: 6361 6c6c 733d 6e6f 6465 2e74 7261 6365  calls=node.trace
+00007ef0: 5f64 625f 6361 6c6c 7329 0a0a 2020 2020  _db_calls)..    
+00007f00: 2020 2020 2320 6966 2074 6872 6561 6469      # if threadi
+00007f10: 6e67 2e61 6374 6976 655f 636f 756e 7428  ng.active_count(
+00007f20: 2920 3c20 6e6f 6465 2e74 6872 6561 645f  ) < node.thread_
+00007f30: 6c69 6d69 7420 6f72 2070 6565 725f 6970  limit or peer_ip
+00007f40: 203d 3d20 2231 3237 2e30 2e30 2e31 223a   == "127.0.0.1":
+00007f50: 0a20 2020 2020 2020 2023 2041 6c77 6179  .        # Alway
+00007f60: 7320 6b65 6570 2061 2073 6c6f 7420 666f  s keep a slot fo
+00007f70: 7220 7768 6974 656c 6973 7465 6420 2877  r whitelisted (w
+00007f80: 616c 6c65 7420 636f 756c 6420 6265 2074  allet could be t
+00007f90: 6865 7265 290a 2020 2020 2020 2020 6966  here).        if
+00007fa0: 2074 6872 6561 6469 6e67 2e61 6374 6976   threading.activ
+00007fb0: 655f 636f 756e 7428 2920 3c20 6e6f 6465  e_count() < node
+00007fc0: 2e74 6872 6561 645f 6c69 6d69 742f 332a  .thread_limit/3*
+00007fd0: 3220 6f72 206e 6f64 652e 7065 6572 732e  2 or node.peers.
+00007fe0: 6973 5f77 6869 7465 6c69 7374 6564 2870  is_whitelisted(p
+00007ff0: 6565 725f 6970 293a 2020 2320 696e 626f  eer_ip):  # inbo
+00008000: 756e 640a 2020 2020 2020 2020 2020 2020  und.            
+00008010: 636c 6965 6e74 5f69 6e73 7461 6e63 652e  client_instance.
+00008020: 636f 6e6e 6563 7465 6420 3d20 5472 7565  connected = True
+00008030: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00008040: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00008050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008060: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+00008070: 6c6f 672e 7761 726e 696e 6728 6627 4672  log.warning(f'Fr
+00008080: 6565 2063 6170 6163 6974 7920 666f 7220  ee capacity for 
+00008090: 7b70 6565 725f 6970 7d20 756e 6176 6169  {peer_ip} unavai
+000080a0: 6c61 626c 652c 2064 6973 636f 6e6e 6563  lable, disconnec
+000080b0: 7465 6427 290a 2020 2020 2020 2020 2020  ted').          
+000080c0: 2020 2020 2020 7365 6c66 2e72 6571 7565        self.reque
+000080d0: 7374 2e63 6c6f 7365 2829 0a20 2020 2020  st.close().     
+000080e0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+000080f0: 796f 7520 7261 6973 6520 6865 7265 2c20  you raise here, 
+00008100: 796f 7520 6b69 6c6c 2074 6865 2077 686f  you kill the who
+00008110: 6c65 2073 6572 7665 720a 2020 2020 2020  le server.      
+00008120: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00008130: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00008140: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00008150: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00008160: 2e77 6172 6e69 6e67 2866 277b 657d 2729  .warning(f'{e}')
+00008170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008180: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
+00008190: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+000081a0: 2020 2020 2020 2020 2020 2023 2064 625f             # db_
+000081b0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+000081c0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+000081d0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000081e0: 0a20 2020 2020 2020 2064 6963 745f 6970  .        dict_ip
+000081f0: 203d 207b 2769 7027 3a20 7065 6572 5f69   = {'ip': peer_i
+00008200: 707d 0a20 2020 2020 2020 206e 6f64 652e  p}.        node.
+00008210: 706c 7567 696e 5f6d 616e 6167 6572 2e65  plugin_manager.e
+00008220: 7865 6375 7465 5f66 696c 7465 725f 686f  xecute_filter_ho
+00008230: 6f6b 2827 7065 6572 5f69 7027 2c20 6469  ok('peer_ip', di
+00008240: 6374 5f69 7029 0a0a 2020 2020 2020 2020  ct_ip)..        
+00008250: 6966 206e 6f64 652e 7065 6572 732e 6973  if node.peers.is
+00008260: 5f62 616e 6e65 6428 7065 6572 5f69 7029  _banned(peer_ip)
+00008270: 206f 7220 6469 6374 5f69 705b 2769 7027   or dict_ip['ip'
+00008280: 5d20 3d3d 2027 6261 6e6e 6564 273a 0a20  ] == 'banned':. 
+00008290: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000082a0: 7265 7175 6573 742e 636c 6f73 6528 290a  request.close().
+000082b0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000082c0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+000082d0: 7761 726e 696e 6728 6627 4950 207b 7065  warning(f'IP {pe
+000082e0: 6572 5f69 707d 2062 616e 6e65 642c 2064  er_ip} banned, d
+000082f0: 6973 636f 6e6e 6563 7465 6427 290a 0a20  isconnected').. 
+00008300: 2020 2020 2020 2023 2054 4f44 4f3a 2049         # TODO: I
+00008310: 2764 206c 696b 6520 746f 2063 616c 6c0a  'd like to call.
+00008320: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00008330: 2020 2020 6e6f 6465 2e70 6565 7273 2e70      node.peers.p
+00008340: 6565 7273 796e 6328 7b70 6565 725f 6970  eersync({peer_ip
+00008350: 3a20 6e6f 6465 2e70 6f72 747d 290a 2020  : node.port}).  
+00008360: 2020 2020 2020 736f 2077 6520 6361 6e20        so we can 
+00008370: 7361 7665 2074 6865 2070 6565 7273 2074  save the peers t
+00008380: 6861 7420 636f 6e6e 6563 7465 6420 746f  hat connected to
+00008390: 2075 732e 0a20 2020 2020 2020 2042 7574   us..        But
+000083a0: 206e 6f74 206f 6b20 696e 2063 7572 7265   not ok in curre
+000083b0: 6e74 2061 7263 6869 7465 6374 7572 653a  nt architecture:
+000083c0: 2077 6f75 6c64 2064 656c 6179 2074 6865   would delay the
+000083d0: 2063 6f6d 6d61 6e64 2c20 616e 6420 7765   command, and we
+000083e0: 2772 6520 6e6f 7420 6576 656e 2073 7572  're not even sur
+000083f0: 6520 6974 2077 6f75 6c64 2062 6520 7361  e it would be sa
+00008400: 7665 642e 0a20 2020 2020 2020 2054 4f44  ved..        TOD
+00008410: 4f3a 2057 6f72 6b61 726f 756e 643a 206d  O: Workaround: m
+00008420: 616b 6520 7375 7265 206f 7572 2065 7874  ake sure our ext
+00008430: 6572 6e61 6c20 6970 2061 6e64 2070 6f72  ernal ip and por
+00008440: 7420 6973 2070 7265 7365 6e74 2069 6e20  t is present in 
+00008450: 7468 6520 7065 6572 7320 7765 2061 6e6e  the peers we ann
+00008460: 6f75 6e63 652c 206f 7220 6e65 7720 6e6f  ounce, or new no
+00008470: 6465 7320 6172 6520 6c69 6b65 6c79 206e  des are likely n
+00008480: 6576 6572 2074 6f20 6265 2061 6e6e 6f75  ever to be annou
+00008490: 6e63 6564 2e0a 2020 2020 2020 2020 5761  nced..        Wa
+000084a0: 726e 696e 673a 206e 6565 6473 2070 7562  rning: needs pub
+000084b0: 6c69 6320 6970 2f70 6f72 742c 206e 6f74  lic ip/port, not
+000084c0: 206c 6f63 616c 206f 6e65 7321 0a20 2020   local ones!.   
+000084d0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000084e0: 2020 7469 6d65 6f75 745f 6f70 6572 6174    timeout_operat
+000084f0: 696f 6e20 3d20 3132 3020 2023 2074 696d  ion = 120  # tim
+00008500: 656f 7574 0a20 2020 2020 2020 2074 696d  eout.        tim
+00008510: 6572 5f6f 7065 7261 7469 6f6e 203d 2074  er_operation = t
+00008520: 696d 652e 7469 6d65 2829 2020 2320 7374  ime.time()  # st
+00008530: 6172 7420 636f 756e 7469 6e67 0a20 2020  art counting.   
+00008540: 2020 2020 2072 6563 6569 7665 645f 626c       received_bl
+00008550: 6f63 6b5f 6865 6967 6874 203d 2030 0a0a  ock_height = 0..
+00008560: 2020 2020 2020 2020 7768 696c 6520 6e6f          while no
+00008570: 7420 6e6f 6465 2e70 6565 7273 2e69 735f  t node.peers.is_
+00008580: 6261 6e6e 6564 2870 6565 725f 6970 2920  banned(peer_ip) 
+00008590: 616e 6420 6e6f 6465 2e70 6565 7273 2e76  and node.peers.v
+000085a0: 6572 7369 6f6e 5f61 6c6c 6f77 6564 2870  ersion_allowed(p
+000085b0: 6565 725f 6970 2c20 6e6f 6465 2e76 6572  eer_ip, node.ver
+000085c0: 7369 6f6e 5f61 6c6c 6f77 2920 616e 6420  sion_allow) and 
+000085d0: 636c 6965 6e74 5f69 6e73 7461 6e63 652e  client_instance.
+000085e0: 636f 6e6e 6563 7465 643a 0a20 2020 2020  connected:.     
+000085f0: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00008600: 725f 696e 7374 616e 6365 203d 204e 6f6e  r_instance = Non
+00008610: 650a 2020 2020 2020 2020 2020 2020 7472  e.            tr
+00008620: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00008630: 2020 2065 7874 7261 203d 2046 616c 7365     extra = False
+00008640: 2020 2320 466c 6167 2066 6f72 2070 6c75    # Flag for plu
+00008650: 6769 6e20 616e 6420 7265 6774 6573 745f  gin and regtest_
+00008660: 2a20 636f 6d6d 616e 6473 0a20 2020 2020  * commands.     
+00008670: 2020 2020 2020 2020 2020 2023 2046 6169             # Fai
+00008680: 6c73 6166 650a 2020 2020 2020 2020 2020  lsafe.          
+00008690: 2020 2020 2020 6966 2073 656c 662e 7265        if self.re
+000086a0: 7175 6573 7420 3d3d 202d 313a 0a20 2020  quest == -1:.   
+000086b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000086d0: 7228 6627 496e 626f 756e 643a 2043 6c6f  r(f'Inbound: Clo
+000086e0: 7365 6420 736f 636b 6574 2066 726f 6d20  sed socket from 
+000086f0: 7b70 6565 725f 6970 7d27 290a 0a20 2020  {peer_ip}')..   
+00008700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00008710: 6e6f 7420 7469 6d65 2e74 696d 6528 2920  not time.time() 
+00008720: 3c3d 2074 696d 6572 5f6f 7065 7261 7469  <= timer_operati
+00008730: 6f6e 202b 2074 696d 656f 7574 5f6f 7065  on + timeout_ope
+00008740: 7261 7469 6f6e 3a20 2023 2072 6574 7572  ration:  # retur
+00008750: 6e20 6f6e 2074 696d 656f 7574 0a20 2020  n on timeout.   
 00008760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008770: 2020 2020 7265 676e 6574 2e63 6f6e 6e2c      regnet.conn,
-00008780: 2072 6567 6e65 742e 632c 2072 6567 6e65   regnet.c, regne
-00008790: 742e 6864 642c 2072 6567 6e65 742e 682c  t.hdd, regnet.h,
-000087a0: 2072 6567 6e65 742e 6864 6432 2c20 7265   regnet.hdd2, re
-000087b0: 676e 6574 2e68 322c 2072 6567 6e65 742e  gnet.h2, regnet.
-000087c0: 6820 3d20 6462 5f68 616e 646c 6572 5f69  h = db_handler_i
-000087d0: 6e73 7461 6e63 652e 636f 6e6e 2c20 6462  nstance.conn, db
-000087e0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
-000087f0: 652e 632c 2064 625f 6861 6e64 6c65 725f  e.c, db_handler_
-00008800: 696e 7374 616e 6365 2e68 6464 2c20 6462  instance.hdd, db
-00008810: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
-00008820: 652e 682c 2064 625f 6861 6e64 6c65 725f  e.h, db_handler_
-00008830: 696e 7374 616e 6365 2e68 6464 322c 2064  instance.hdd2, d
-00008840: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-00008850: 6365 2e68 322c 2064 625f 6861 6e64 6c65  ce.h2, db_handle
-00008860: 725f 696e 7374 616e 6365 2e68 0a20 2020  r_instance.h.   
-00008870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008880: 2020 2020 2072 6567 6e65 742e 636f 6d6d       regnet.comm
-00008890: 616e 6428 7365 6c66 2e72 6571 7565 7374  and(self.request
-000088a0: 2c20 6461 7461 2c20 626c 6f63 6b5f 6861  , data, block_ha
-000088b0: 7368 2c20 6e6f 6465 2c20 6462 5f68 616e  sh, node, db_han
-000088c0: 646c 6572 5f69 6e73 7461 6e63 6529 0a20  dler_instance). 
-000088d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088e0: 2020 2023 2053 6574 2065 7874 7261 2066     # Set extra f
-000088f0: 6c61 6720 6f72 2074 6865 2072 6567 7465  lag or the regte
-00008900: 7374 5f2a 2063 6f6d 6d61 6e64 2077 696c  st_* command wil
-00008910: 6c20 7468 726f 776e 2061 6e20 6578 6365  l thrown an exce
-00008920: 7074 696f 6e0a 2020 2020 2020 2020 2020  ption.          
-00008930: 2020 2020 2020 2020 2020 6578 7472 6120            extra 
-00008940: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-00008950: 2020 2020 2020 2020 6966 2064 6174 6120          if data 
-00008960: 3d3d 2027 7665 7273 696f 6e27 3a0a 2020  == 'version':.  
-00008970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008980: 2020 6461 7461 203d 2072 6563 6569 7665    data = receive
-00008990: 2873 656c 662e 7265 7175 6573 7429 0a20  (self.request). 
-000089a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089b0: 2020 2069 6620 6461 7461 206e 6f74 2069     if data not i
-000089c0: 6e20 6e6f 6465 2e76 6572 7369 6f6e 5f61  n node.version_a
-000089d0: 6c6c 6f77 3a0a 2020 2020 2020 2020 2020  llow:.          
-000089e0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-000089f0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00008a00: 672e 7761 726e 696e 6728 6627 5072 6f74  g.warning(f'Prot
-00008a10: 6f63 6f6c 2076 6572 7369 6f6e 206d 6973  ocol version mis
-00008a20: 6d61 7463 683a 207b 6461 7461 7d2c 2073  match: {data}, s
-00008a30: 686f 756c 6420 6265 207b 6e6f 6465 2e76  hould be {node.v
-00008a40: 6572 7369 6f6e 5f61 6c6c 6f77 7d27 290a  ersion_allow}').
-00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a60: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
-00008a70: 662e 7265 7175 6573 742c 2027 6e6f 746f  f.request, 'noto
-00008a80: 6b27 290a 2020 2020 2020 2020 2020 2020  k').            
-00008a90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00008aa0: 726e 0a20 2020 2020 2020 2020 2020 2020  rn.             
-00008ab0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00008ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ad0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-00008ae0: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
-00008af0: 2866 2749 6e62 6f75 6e64 3a20 5072 6f74  (f'Inbound: Prot
-00008b00: 6f63 6f6c 2076 6572 7369 6f6e 206d 6174  ocol version mat
-00008b10: 6368 6564 2077 6974 6820 7b70 6565 725f  ched with {peer_
-00008b20: 6970 7d3a 207b 6461 7461 7d27 290a 2020  ip}: {data}').  
-00008b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b40: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
-00008b50: 7265 7175 6573 742c 2027 6f6b 2729 0a20  request, 'ok'). 
-00008b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b70: 2020 2020 2020 206e 6f64 652e 7065 6572         node.peer
-00008b80: 732e 7374 6f72 655f 6d61 696e 6e65 7428  s.store_mainnet(
-00008b90: 7065 6572 5f69 702c 2064 6174 6129 0a0a  peer_ip, data)..
-00008ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bb0: 656c 6966 2064 6174 6120 3d3d 2027 6765  elif data == 'ge
-00008bc0: 7476 6572 7369 6f6e 273a 0a20 2020 2020  tversion':.     
-00008bd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00008be0: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-00008bf0: 2c20 6e6f 6465 2e76 6572 7369 6f6e 290a  , node.version).
-00008c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008c10: 2065 6c69 6620 6461 7461 203d 3d20 276d   elif data == 'm
-00008c20: 656d 706f 6f6c 273a 0a0a 2020 2020 2020  empool':..      
-00008c30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00008c40: 7265 6365 6976 6520 7468 6569 7273 0a20  receive theirs. 
+00008770: 2069 6620 6e6f 6465 2e70 6565 7273 2e77   if node.peers.w
+00008780: 6172 6e69 6e67 2873 656c 662e 7265 7175  arning(self.requ
+00008790: 6573 742c 2070 6565 725f 6970 2c20 274f  est, peer_ip, 'O
+000087a0: 7065 7261 7469 6f6e 2074 696d 656f 7574  peration timeout
+000087b0: 272c 2032 293a 0a20 2020 2020 2020 2020  ', 2):.         
+000087c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000087d0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+000087e0: 6f67 2e77 6172 6e69 6e67 2866 277b 7065  og.warning(f'{pe
+000087f0: 6572 5f69 707d 2062 616e 6e65 6427 290a  er_ip} banned').
+00008800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008810: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008830: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00008840: 6f72 2866 2749 6e62 6f75 6e64 3a20 4f70  or(f'Inbound: Op
+00008850: 6572 6174 696f 6e20 7469 6d65 6f75 7420  eration timeout 
+00008860: 6672 6f6d 207b 7065 6572 5f69 707d 5f7b  from {peer_ip}_{
+00008870: 7065 6572 5f70 6f72 747d 2729 0a0a 2020  peer_port}')..  
+00008880: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00008890: 7461 203d 2072 6563 6569 7665 2873 656c  ta = receive(sel
+000088a0: 662e 7265 7175 6573 7429 0a0a 2020 2020  f.request)..    
+000088b0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000088c0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+000088d0: 6465 6275 6728 6627 496e 626f 756e 643a  debug(f'Inbound:
+000088e0: 2052 6563 6569 7665 643a 207b 6461 7461   Received: {data
+000088f0: 7d20 6672 6f6d 207b 7065 6572 5f69 707d  } from {peer_ip}
+00008900: 5f7b 7065 6572 5f70 6f72 747d 2729 2020  _{peer_port}')  
+00008910: 2320 7769 6c6c 2061 6464 2063 7573 746f  # will add custo
+00008920: 6d20 706f 7274 7320 6c61 7465 720a 0a20  m ports later.. 
+00008930: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00008940: 2074 6872 6561 6469 6e67 2e63 7572 7265   threading.curre
+00008950: 6e74 5f74 6872 6561 6428 292e 6e61 6d65  nt_thread().name
+00008960: 203d 2066 2769 6e5f 7b70 6565 725f 6970   = f'in_{peer_ip
+00008970: 7d5f 7b70 6565 725f 706f 7274 7d5f 7b64  }_{peer_port}_{d
+00008980: 6174 615b 3a32 305d 7d27 0a0a 2020 2020  ata[:20]}'..    
+00008990: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+000089a0: 6174 612e 7374 6172 7473 7769 7468 2827  ata.startswith('
+000089b0: 7265 6774 6573 745f 2729 3a0a 2020 2020  regtest_'):.    
+000089c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089d0: 6966 206e 6f74 206e 6f64 652e 6973 5f72  if not node.is_r
+000089e0: 6567 6e65 743a 0a20 2020 2020 2020 2020  egnet:.         
+000089f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008a00: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
+00008a10: 2c20 276e 6f74 6f6b 2729 0a20 2020 2020  , 'notok').     
+00008a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a30: 2020 2023 2064 625f 6861 6e64 6c65 725f     # db_handler_
+00008a40: 696e 7374 616e 6365 2e63 6c6f 7365 2829  instance.close()
+00008a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008a60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00008a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008aa0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+00008ab0: 7461 6e63 6520 3d20 6462 6861 6e64 6c65  tance = dbhandle
+00008ac0: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+00008ad0: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+00008ae0: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+00008af0: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+00008b00: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+00008b10: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+00008b20: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+00008b30: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+00008b40: 7261 6365 5f64 625f 6361 6c6c 7329 0a20  race_db_calls). 
+00008b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b60: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00008b70: 725f 696e 7374 616e 6365 2e65 7865 6375  r_instance.execu
+00008b80: 7465 2864 625f 6861 6e64 6c65 725f 696e  te(db_handler_in
+00008b90: 7374 616e 6365 2e63 2c20 2753 454c 4543  stance.c, 'SELEC
+00008ba0: 5420 626c 6f63 6b5f 6861 7368 2046 524f  T block_hash FRO
+00008bb0: 4d20 7472 616e 7361 6374 696f 6e73 2057  M transactions W
+00008bc0: 4845 5245 2062 6c6f 636b 5f68 6569 6768  HERE block_heigh
+00008bd0: 743d 2028 7365 6c65 6374 206d 6178 2862  t= (select max(b
+00008be0: 6c6f 636b 5f68 6569 6768 7429 2066 726f  lock_height) fro
+00008bf0: 6d20 7472 616e 7361 6374 696f 6e73 2927  m transactions)'
+00008c00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00008c10: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00008c20: 6861 7368 203d 2064 625f 6861 6e64 6c65  hash = db_handle
+00008c30: 725f 696e 7374 616e 6365 2e63 2e66 6574  r_instance.c.fet
+00008c40: 6368 6f6e 6528 295b 305d 0a20 2020 2020  chone()[0].     
 00008c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c60: 2020 2073 6567 6d65 6e74 7320 3d20 7265     segments = re
-00008c70: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
-00008c80: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-00008c90: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00008ca0: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-00008cb0: 286d 702e 4d45 4d50 4f4f 4c2e 6d65 7267  (mp.MEMPOOL.merg
-00008cc0: 6528 7365 676d 656e 7473 2c20 7065 6572  e(segments, peer
-00008cd0: 5f69 702c 2064 625f 6861 6e64 6c65 725f  _ip, db_handler_
-00008ce0: 696e 7374 616e 6365 2e63 2c20 4661 6c73  instance.c, Fals
-00008cf0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00008d00: 2020 2020 2020 2020 2369 6d70 726f 7665          #improve
-00008d10: 6d65 6e74 2070 6f73 7369 626c 6520 2d20  ment possible - 
-00008d20: 7061 7373 2070 6565 725f 6970 2066 726f  pass peer_ip fro
-00008d30: 6d20 776f 726b 6572 0a0a 2020 2020 2020  m worker..      
-00008d40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00008d50: 7265 6365 6976 6520 7468 6569 7273 0a0a  receive theirs..
-00008d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d70: 2020 2020 2320 6578 6563 7574 655f 7061      # execute_pa
-00008d80: 7261 6d28 6d2c 2028 2753 454c 4543 5420  ram(m, ('SELECT 
-00008d90: 7469 6d65 7374 616d 702c 6164 6472 6573  timestamp,addres
-00008da0: 732c 7265 6369 7069 656e 742c 616d 6f75  s,recipient,amou
-00008db0: 6e74 2c73 6967 6e61 7475 7265 2c70 7562  nt,signature,pub
-00008dc0: 6c69 635f 6b65 792c 6f70 6572 6174 696f  lic_key,operatio
-00008dd0: 6e2c 6f70 656e 6669 656c 6420 4652 4f4d  n,openfield FROM
-00008de0: 2074 7261 6e73 6163 7469 6f6e 7320 5748   transactions WH
-00008df0: 4552 4520 7469 6d65 6f75 7420 3c20 3f20  ERE timeout < ? 
-00008e00: 4f52 4445 5220 4259 2061 6d6f 756e 7420  ORDER BY amount 
-00008e10: 4445 5343 3b27 292c 2028 696e 7428 7469  DESC;'), (int(ti
-00008e20: 6d65 2e74 696d 6528 2920 2d20 3529 2c29  me.time() - 5),)
-00008e30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008e40: 2020 2020 2020 6966 206d 702e 4d45 4d50        if mp.MEMP
-00008e50: 4f4f 4c2e 7365 6e64 6162 6c65 2870 6565  OOL.sendable(pee
-00008e60: 725f 6970 293a 0a20 2020 2020 2020 2020  r_ip):.         
-00008e70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00008e80: 204f 6e6c 7920 7365 6e64 2074 6865 2064   Only send the d
-00008e90: 6966 660a 2020 2020 2020 2020 2020 2020  iff.            
-00008ea0: 2020 2020 2020 2020 2020 2020 6d65 6d70              memp
-00008eb0: 6f6f 6c5f 7478 7320 3d20 6d70 2e4d 454d  ool_txs = mp.MEM
-00008ec0: 504f 4f4c 2e74 785f 746f 5f73 656e 6428  POOL.tx_to_send(
-00008ed0: 7065 6572 5f69 702c 2073 6567 6d65 6e74  peer_ip, segment
-00008ee0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00008ef0: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
-00008f00: 206e 6f74 6520 7468 6520 7469 6d65 0a20   note the time. 
-00008f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f20: 2020 2020 2020 206d 702e 4d45 4d50 4f4f         mp.MEMPOO
-00008f30: 4c2e 7365 6e74 2870 6565 725f 6970 290a  L.sent(peer_ip).
-00008f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00008f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f70: 2020 2320 5765 2061 6c72 6561 6479 2073    # We already s
-00008f80: 656e 7420 6e6f 7420 6c6f 6e67 2061 676f  ent not long ago
-00008f90: 2c20 7365 6e64 2065 6d70 790a 2020 2020  , send empy.    
-00008fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008fb0: 2020 2020 6d65 6d70 6f6f 6c5f 7478 7320      mempool_txs 
-00008fc0: 3d20 5b5d 0a0a 2020 2020 2020 2020 2020  = []..          
-00008fd0: 2020 2020 2020 2020 2020 2320 7365 6e64            # send
-00008fe0: 206f 776e 0a20 2020 2020 2020 2020 2020   own.           
-00008ff0: 2020 2020 2020 2020 2023 206e 6f64 652e           # node.
-00009000: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-00009010: 6e66 6f28 2249 6e62 6f75 6e64 3a20 4578  nfo("Inbound: Ex
-00009020: 7472 6163 7465 6420 6672 6f6d 2074 6865  tracted from the
-00009030: 206d 656d 706f 6f6c 3a20 2220 2b20 7374   mempool: " + st
-00009040: 7228 6d65 6d70 6f6f 6c5f 7478 7329 2920  r(mempool_txs)) 
-00009050: 2023 2069 6d70 726f 7665 3a20 7379 6e63   # improve: sync
-00009060: 2062 6173 6564 206f 6e20 7369 676e 6174   based on signat
-00009070: 7572 6573 206f 6e6c 790a 0a20 2020 2020  ures only..     
-00009080: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00009090: 2069 6620 6c65 6e28 6d65 6d70 6f6f 6c5f   if len(mempool_
-000090a0: 7478 7329 203e 2030 3a20 7361 6d65 2061  txs) > 0: same a
-000090b0: 7320 7468 6520 6f74 6865 720a 2020 2020  s the other.    
-000090c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090d0: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-000090e0: 742c 206d 656d 706f 6f6c 5f74 7873 290a  t, mempool_txs).
-000090f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009100: 2065 6c69 6620 6461 7461 203d 3d20 2768   elif data == 'h
-00009110: 656c 6c6f 273a 0a20 2020 2020 2020 2020  ello':.         
-00009120: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00009130: 6465 2e69 735f 7265 676e 6574 3a0a 2020  de.is_regnet:.  
-00009140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009150: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-00009160: 722e 6170 705f 6c6f 672e 696e 666f 2822  r.app_log.info("
-00009170: 496e 626f 756e 643a 2047 6f74 2068 656c  Inbound: Got hel
-00009180: 6c6f 2062 7574 2049 276d 2069 6e20 7265  lo but I'm in re
-00009190: 6774 6573 7420 6d6f 6465 2c20 636c 6f73  gtest mode, clos
-000091a0: 696e 672e 2229 0a20 2020 2020 2020 2020  ing.").         
-000091b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000091c0: 6574 7572 6e0a 0a20 2020 2020 2020 2020  eturn..         
-000091d0: 2020 2020 2020 2020 2020 2073 656e 6428             send(
-000091e0: 7365 6c66 2e72 6571 7565 7374 2c20 2770  self.request, 'p
-000091f0: 6565 7273 2729 0a20 2020 2020 2020 2020  eers').         
-00009200: 2020 2020 2020 2020 2020 2070 6565 7273             peers
-00009210: 5f73 656e 6420 3d20 6e6f 6465 2e70 6565  _send = node.pee
-00009220: 7273 2e70 6565 725f 6c69 7374 5f64 6973  rs.peer_list_dis
-00009230: 6b5f 666f 726d 6174 2829 0a20 2020 2020  k_format().     
-00009240: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00009250: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-00009260: 2c20 7065 6572 735f 7365 6e64 290a 0a20  , peers_send).. 
-00009270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009280: 2020 2077 6869 6c65 206e 6f64 652e 6462     while node.db
-00009290: 5f6c 6f63 6b2e 6c6f 636b 6564 2829 3a0a  _lock.locked():.
-000092a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092b0: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-000092c0: 6570 2871 7561 6e74 697a 655f 7477 6f28  ep(quantize_two(
-000092d0: 6e6f 6465 2e70 6175 7365 2929 0a20 2020  node.pause)).   
-000092e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092f0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00009300: 5f6c 6f67 2e69 6e66 6f28 2749 6e62 6f75  _log.info('Inbou
-00009310: 6e64 3a20 5365 6e64 696e 6720 7379 6e63  nd: Sending sync
-00009320: 2072 6571 7565 7374 2729 0a0a 2020 2020   request')..    
-00009330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009340: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-00009350: 742c 2027 7379 6e63 2729 0a0a 2020 2020  t, 'sync')..    
-00009360: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00009370: 2064 6174 6120 3d3d 2027 7365 6e64 7379   data == 'sendsy
-00009380: 6e63 273a 0a20 2020 2020 2020 2020 2020  nc':.           
-00009390: 2020 2020 2020 2020 2077 6869 6c65 206e           while n
-000093a0: 6f64 652e 6462 5f6c 6f63 6b2e 6c6f 636b  ode.db_lock.lock
-000093b0: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
-000093c0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-000093d0: 6d65 2e73 6c65 6570 2871 7561 6e74 697a  me.sleep(quantiz
-000093e0: 655f 7477 6f28 6e6f 6465 2e70 6175 7365  e_two(node.pause
-000093f0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00009400: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
-00009410: 6e28 6e6f 6465 2e73 796e 6369 6e67 2920  n(node.syncing) 
-00009420: 3e3d 2033 3a0a 2020 2020 2020 2020 2020  >= 3:.          
-00009430: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00009440: 6d65 2e73 6c65 6570 2869 6e74 286e 6f64  me.sleep(int(nod
-00009450: 652e 7061 7573 6529 290a 0a20 2020 2020  e.pause))..     
-00009460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00009470: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-00009480: 2c20 2773 796e 6327 290a 0a20 2020 2020  , 'sync')..     
-00009490: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000094a0: 6461 7461 203d 3d20 2762 6c6f 636b 7366  data == 'blocksf
-000094b0: 6e64 273a 0a20 2020 2020 2020 2020 2020  nd':.           
-000094c0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-000094d0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-000094e0: 6f28 6627 496e 626f 756e 643a 2043 6c69  o(f'Inbound: Cli
-000094f0: 656e 7420 7b70 6565 725f 6970 7d20 6861  ent {peer_ip} ha
-00009500: 7320 7468 6520 626c 6f63 6b28 7329 2729  s the block(s)')
-00009510: 2020 2320 6e6f 6465 2073 686f 756c 6420    # node should 
-00009520: 7374 6172 7420 7365 6e64 696e 6720 7478  start sending tx
-00009530: 7320 696e 2074 6869 7320 7374 6570 0a0a  s in this step..
-00009540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009550: 2020 2020 2320 6e6f 6465 2e6c 6f67 6765      # node.logge
-00009560: 722e 6170 705f 6c6f 672e 696e 666f 2822  r.app_log.info("
-00009570: 496e 626f 756e 643a 2043 6f6d 6269 6e65  Inbound: Combine
-00009580: 6420 7365 676d 656e 7473 3a20 2220 2b20  d segments: " + 
-00009590: 7365 676d 656e 7473 290a 2020 2020 2020  segments).      
-000095a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000095b0: 7072 696e 7420 7065 6572 5f69 700a 2020  print peer_ip.  
-000095c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095d0: 2020 6966 206e 6f64 652e 6462 5f6c 6f63    if node.db_loc
-000095e0: 6b2e 6c6f 636b 6564 2829 3a0a 2020 2020  k.locked():.    
-000095f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009600: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00009610: 6170 705f 6c6f 672e 696e 666f 2866 2753  app_log.info(f'S
-00009620: 6b69 7070 696e 6720 7379 6e63 2066 726f  kipping sync fro
-00009630: 6d20 7b70 6565 725f 6970 7d2c 2073 796e  m {peer_ip}, syn
-00009640: 6369 6e67 2061 6c72 6561 6479 2069 6e20  cing already in 
-00009650: 7072 6f67 7265 7373 2729 0a0a 2020 2020  progress')..    
-00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009670: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009680: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00009690: 6465 2e6c 6173 745f 626c 6f63 6b5f 7469  de.last_block_ti
-000096a0: 6d65 7374 616d 7020 3d20 6462 5f68 616e  mestamp = db_han
-000096b0: 646c 6572 5f69 6e73 7461 6e63 652e 6c61  dler_instance.la
-000096c0: 7374 5f62 6c6f 636b 5f74 696d 6573 7461  st_block_timesta
-000096d0: 6d70 2829 0a0a 2020 2020 2020 2020 2020  mp()..          
-000096e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000096f0: 206e 6f64 652e 6c61 7374 5f62 6c6f 636b   node.last_block
-00009700: 5f74 696d 6573 7461 6d70 203c 2074 696d  _timestamp < tim
-00009710: 652e 7469 6d65 2829 202d 2036 3030 3a0a  e.time() - 600:.
-00009720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009730: 2020 2020 2020 2020 2020 2020 2320 626c              # bl
-00009740: 6f63 6b5f 7265 7120 3d20 6d6f 7374 5f63  ock_req = most_c
-00009750: 6f6d 6d6f 6e28 636f 6e73 656e 7375 735f  ommon(consensus_
-00009760: 626c 6f63 6b68 6569 6768 745f 6c69 7374  blockheight_list
-00009770: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009780: 2020 2020 2020 2020 2020 2020 2020 626c                bl
-00009790: 6f63 6b5f 7265 7120 3d20 6e6f 6465 2e70  ock_req = node.p
-000097a0: 6565 7273 2e63 6f6e 7365 6e73 7573 5f6d  eers.consensus_m
-000097b0: 6f73 745f 636f 6d6d 6f6e 0a20 2020 2020  ost_common.     
-000097c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000097d0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-000097e0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-000097f0: 6e67 2827 4d6f 7374 2063 6f6d 6d6f 6e20  ng('Most common 
-00009800: 626c 6f63 6b20 7275 6c65 2074 7269 6767  block rule trigg
-00009810: 6572 6564 2729 0a0a 2020 2020 2020 2020  ered')..        
-00009820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009850: 2020 2320 626c 6f63 6b5f 7265 7120 3d20    # block_req = 
-00009860: 6d61 7828 636f 6e73 656e 7375 735f 626c  max(consensus_bl
-00009870: 6f63 6b68 6569 6768 745f 6c69 7374 290a  ockheight_list).
-00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009890: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-000098a0: 6b5f 7265 7120 3d20 6e6f 6465 2e70 6565  k_req = node.pee
-000098b0: 7273 2e63 6f6e 7365 6e73 7573 5f6d 6178  rs.consensus_max
-000098c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000098d0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-000098e0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-000098f0: 2e77 6172 6e69 6e67 2827 4c6f 6e67 6573  .warning('Longes
-00009900: 7420 6368 6169 6e20 7275 6c65 2074 7269  t chain rule tri
-00009910: 6767 6572 6564 2729 0a0a 2020 2020 2020  ggered')..      
-00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009930: 2020 6966 2069 6e74 2872 6563 6569 7665    if int(receive
-00009940: 645f 626c 6f63 6b5f 6865 6967 6874 2920  d_block_height) 
-00009950: 3e3d 2062 6c6f 636b 5f72 6571 2061 6e64  >= block_req and
-00009960: 2069 6e74 2872 6563 6569 7665 645f 626c   int(received_bl
-00009970: 6f63 6b5f 6865 6967 6874 2920 3e20 6e6f  ock_height) > no
-00009980: 6465 2e6c 6173 745f 626c 6f63 6b3a 0a0a  de.last_block:..
-00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099a0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000099b0: 2020 2320 7468 6579 2063 6c61 696d 2074    # they claim t
-000099c0: 6f20 6861 7665 2074 6865 206c 6f6e 6765  o have the longe
-000099d0: 7374 2063 6861 696e 2c20 7468 696e 6773  st chain, things
-000099e0: 206d 7573 7420 676f 2073 6d6f 6f74 6820   must go smooth 
-000099f0: 6f72 2062 616e 0a20 2020 2020 2020 2020  or ban.         
-00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a10: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-00009a20: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-00009a30: 6e67 2866 2743 6f6e 6669 726d 696e 6720  ng(f'Confirming 
-00009a40: 746f 2073 796e 6320 6672 6f6d 207b 7065  to sync from {pe
-00009a50: 6572 5f69 707d 2729 0a20 2020 2020 2020  er_ip}').       
-00009a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a70: 2020 2020 2020 2020 206e 6f64 652e 706c           node.pl
-00009a80: 7567 696e 5f6d 616e 6167 6572 2e65 7865  ugin_manager.exe
-00009a90: 6375 7465 5f61 6374 696f 6e5f 686f 6f6b  cute_action_hook
-00009aa0: 2827 7379 6e63 272c 207b 2777 6861 7427  ('sync', {'what'
-00009ab0: 3a20 2773 796e 6369 6e67 5f66 726f 6d27  : 'syncing_from'
-00009ac0: 2c20 2769 7027 3a20 7065 6572 5f69 707d  , 'ip': peer_ip}
-00009ad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009af0: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
-00009b00: 6573 742c 2027 626c 6f63 6b73 6366 2729  est, 'blockscf')
-00009b10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00009b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b30: 2020 7365 676d 656e 7473 203d 2072 6563    segments = rec
-00009b40: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-00009b50: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00009b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b70: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00009b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b90: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00009ba0: 7065 6572 732e 7761 726e 696e 6728 7365  peers.warning(se
-00009bb0: 6c66 2e72 6571 7565 7374 2c20 7065 6572  lf.request, peer
-00009bc0: 5f69 702c 2027 4661 696c 6564 2074 6f20  _ip, 'Failed to 
-00009bd0: 6465 6c69 7665 7220 7468 6520 6c6f 6e67  deliver the long
-00009be0: 6573 7420 6368 6169 6e27 293a 0a20 2020  est chain'):.   
+00008c60: 2020 2023 2066 6565 6420 7265 676e 6574     # feed regnet
+00008c70: 2077 6974 6820 6375 7272 656e 7420 7468   with current th
+00008c80: 7265 6164 2064 6220 6861 6e64 6c65 2e20  read db handle. 
+00008c90: 7265 6661 6374 6f72 206e 6565 6465 642e  refactor needed.
+00008ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008cb0: 2020 2020 2020 2020 2072 6567 6e65 742e           regnet.
+00008cc0: 636f 6e6e 2c20 7265 676e 6574 2e63 2c20  conn, regnet.c, 
+00008cd0: 7265 676e 6574 2e68 6464 2c20 7265 676e  regnet.hdd, regn
+00008ce0: 6574 2e68 2c20 7265 676e 6574 2e68 6464  et.h, regnet.hdd
+00008cf0: 322c 2072 6567 6e65 742e 6832 2c20 7265  2, regnet.h2, re
+00008d00: 676e 6574 2e68 203d 2064 625f 6861 6e64  gnet.h = db_hand
+00008d10: 6c65 725f 696e 7374 616e 6365 2e63 6f6e  ler_instance.con
+00008d20: 6e2c 2064 625f 6861 6e64 6c65 725f 696e  n, db_handler_in
+00008d30: 7374 616e 6365 2e63 2c20 6462 5f68 616e  stance.c, db_han
+00008d40: 646c 6572 5f69 6e73 7461 6e63 652e 6864  dler_instance.hd
+00008d50: 642c 2064 625f 6861 6e64 6c65 725f 696e  d, db_handler_in
+00008d60: 7374 616e 6365 2e68 2c20 6462 5f68 616e  stance.h, db_han
+00008d70: 646c 6572 5f69 6e73 7461 6e63 652e 6864  dler_instance.hd
+00008d80: 6432 2c20 6462 5f68 616e 646c 6572 5f69  d2, db_handler_i
+00008d90: 6e73 7461 6e63 652e 6832 2c20 6462 5f68  nstance.h2, db_h
+00008da0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+00008db0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+00008dc0: 2020 2020 2020 2020 2020 7265 676e 6574            regnet
+00008dd0: 2e63 6f6d 6d61 6e64 2873 656c 662e 7265  .command(self.re
+00008de0: 7175 6573 742c 2064 6174 612c 2062 6c6f  quest, data, blo
+00008df0: 636b 5f68 6173 682c 206e 6f64 652c 2064  ck_hash, node, d
+00008e00: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+00008e10: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
+00008e20: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+00008e30: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+00008e40: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
+00008e50: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+00008e60: 7420 6578 7472 6120 666c 6167 206f 7220  t extra flag or 
+00008e70: 7468 6520 7265 6774 6573 745f 2a20 636f  the regtest_* co
+00008e80: 6d6d 616e 6420 7769 6c6c 2074 6872 6f77  mmand will throw
+00008e90: 6e20 616e 2065 7863 6570 7469 6f6e 0a20  n an exception. 
+00008ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008eb0: 2020 2065 7874 7261 203d 2054 7275 650a     extra = True.
+00008ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ed0: 2069 6620 6461 7461 203d 3d20 2776 6572   if data == 'ver
+00008ee0: 7369 6f6e 273a 0a20 2020 2020 2020 2020  sion':.         
+00008ef0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00008f00: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
+00008f10: 6571 7565 7374 290a 2020 2020 2020 2020  equest).        
+00008f20: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00008f30: 6174 6120 6e6f 7420 696e 206e 6f64 652e  ata not in node.
+00008f40: 7665 7273 696f 6e5f 616c 6c6f 773a 0a20  version_allow:. 
+00008f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f60: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+00008f70: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
+00008f80: 6e67 2866 2750 726f 746f 636f 6c20 7665  ng(f'Protocol ve
+00008f90: 7273 696f 6e20 6d69 736d 6174 6368 3a20  rsion mismatch: 
+00008fa0: 7b64 6174 617d 2c20 7368 6f75 6c64 2062  {data}, should b
+00008fb0: 6520 7b6e 6f64 652e 7665 7273 696f 6e5f  e {node.version_
+00008fc0: 616c 6c6f 777d 2729 0a20 2020 2020 2020  allow}').       
+00008fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fe0: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+00008ff0: 7374 2c20 276e 6f74 6f6b 2729 0a20 2020  st, 'notok').   
+00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009010: 2020 2020 2023 2064 625f 6861 6e64 6c65       # db_handle
+00009020: 725f 696e 7374 616e 6365 2e63 6c6f 7365  r_instance.close
+00009030: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00009040: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00009050: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00009060: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009080: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+00009090: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+000090a0: 6627 496e 626f 756e 643a 2050 726f 746f  f'Inbound: Proto
+000090b0: 636f 6c20 7665 7273 696f 6e20 6d61 7463  col version matc
+000090c0: 6865 6420 7769 7468 207b 7065 6572 5f69  hed with {peer_i
+000090d0: 707d 3a20 7b64 6174 617d 2729 0a20 2020  p}: {data}').   
+000090e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090f0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+00009100: 6571 7565 7374 2c20 276f 6b27 290a 2020  equest, 'ok').  
+00009110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009120: 2020 2020 2020 6e6f 6465 2e70 6565 7273        node.peers
+00009130: 2e73 746f 7265 5f6d 6169 6e6e 6574 2870  .store_mainnet(p
+00009140: 6565 725f 6970 2c20 6461 7461 290a 0a20  eer_ip, data).. 
+00009150: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009160: 6c69 6620 6461 7461 203d 3d20 2767 6574  lif data == 'get
+00009170: 7665 7273 696f 6e27 3a0a 2020 2020 2020  version':.      
+00009180: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00009190: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+000091a0: 206e 6f64 652e 7665 7273 696f 6e29 0a0a   node.version)..
+000091b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091c0: 656c 6966 2064 6174 6120 3d3d 2027 6d65  elif data == 'me
+000091d0: 6d70 6f6f 6c27 3a0a 0a20 2020 2020 2020  mpool':..       
+000091e0: 2020 2020 2020 2020 2020 2020 2023 2072               # r
+000091f0: 6563 6569 7665 2074 6865 6972 730a 2020  eceive theirs.  
+00009200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009210: 2020 7365 676d 656e 7473 203d 2072 6563    segments = rec
+00009220: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
+00009230: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00009240: 2020 2020 2020 2023 206e 6f64 652e 6c6f         # node.lo
+00009250: 6767 6572 2e61 7070 5f6c 6f67 2e64 6562  gger.app_log.deb
+00009260: 7567 286d 702e 4d45 4d50 4f4f 4c2e 6d65  ug(mp.MEMPOOL.me
+00009270: 7267 6528 7365 676d 656e 7473 2c20 7065  rge(segments, pe
+00009280: 6572 5f69 702c 2064 625f 6861 6e64 6c65  er_ip, db_handle
+00009290: 725f 696e 7374 616e 6365 2e63 2c20 4661  r_instance.c, Fa
+000092a0: 6c73 6529 290a 2020 2020 2020 2020 2020  lse)).          
+000092b0: 2020 2020 2020 2020 2020 2369 6d70 726f            #impro
+000092c0: 7665 6d65 6e74 2070 6f73 7369 626c 6520  vement possible 
+000092d0: 2d20 7061 7373 2070 6565 725f 6970 2066  - pass peer_ip f
+000092e0: 726f 6d20 776f 726b 6572 0a0a 2020 2020  rom worker..    
+000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009300: 2320 7265 6365 6976 6520 7468 6569 7273  # receive theirs
+00009310: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009320: 2020 2020 2020 2320 6578 6563 7574 655f        # execute_
+00009330: 7061 7261 6d28 6d2c 2028 2753 454c 4543  param(m, ('SELEC
+00009340: 5420 7469 6d65 7374 616d 702c 6164 6472  T timestamp,addr
+00009350: 6573 732c 7265 6369 7069 656e 742c 616d  ess,recipient,am
+00009360: 6f75 6e74 2c73 6967 6e61 7475 7265 2c70  ount,signature,p
+00009370: 7562 6c69 635f 6b65 792c 6f70 6572 6174  ublic_key,operat
+00009380: 696f 6e2c 6f70 656e 6669 656c 6420 4652  ion,openfield FR
+00009390: 4f4d 2074 7261 6e73 6163 7469 6f6e 7320  OM transactions 
+000093a0: 5748 4552 4520 7469 6d65 6f75 7420 3c20  WHERE timeout < 
+000093b0: 3f20 4f52 4445 5220 4259 2061 6d6f 756e  ? ORDER BY amoun
+000093c0: 7420 4445 5343 3b27 292c 2028 696e 7428  t DESC;'), (int(
+000093d0: 7469 6d65 2e74 696d 6528 2920 2d20 3529  time.time() - 5)
+000093e0: 2c29 290a 2020 2020 2020 2020 2020 2020  ,)).            
+000093f0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00009400: 276d 656d 706f 6f6c 272c 206d 702e 4d45  'mempool', mp.ME
+00009410: 4d50 4f4f 4c2c 2069 6428 6d70 2e4d 454d  MPOOL, id(mp.MEM
+00009420: 504f 4f4c 292c 2067 6574 6174 7472 286d  POOL), getattr(m
+00009430: 702e 4d45 4d50 4f4f 4c2c 2027 7365 6e64  p.MEMPOOL, 'send
+00009440: 6162 6c65 272c 2027 3f27 2929 0a20 2020  able', '?')).   
+00009450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009460: 2069 6620 6d70 2e4d 454d 504f 4f4c 2e73   if mp.MEMPOOL.s
+00009470: 656e 6461 626c 6528 7065 6572 5f69 7029  endable(peer_ip)
+00009480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009490: 2020 2020 2020 2020 2020 2320 4f6e 6c79            # Only
+000094a0: 2073 656e 6420 7468 6520 6469 6666 0a20   send the diff. 
+000094b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094c0: 2020 2020 2020 206d 656d 706f 6f6c 5f74         mempool_t
+000094d0: 7873 203d 206d 702e 4d45 4d50 4f4f 4c2e  xs = mp.MEMPOOL.
+000094e0: 7478 5f74 6f5f 7365 6e64 2870 6565 725f  tx_to_send(peer_
+000094f0: 6970 2c20 7365 676d 656e 7473 290a 2020  ip, segments).  
+00009500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009510: 2020 2020 2020 2320 616e 6420 6e6f 7465        # and note
+00009520: 2074 6865 2074 696d 650a 2020 2020 2020   the time.      
+00009530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009540: 2020 6d70 2e4d 454d 504f 4f4c 2e73 656e    mp.MEMPOOL.sen
+00009550: 7428 7065 6572 5f69 7029 0a20 2020 2020  t(peer_ip).     
+00009560: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009570: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00009580: 2020 2020 2020 2020 2020 2020 2023 2057               # W
+00009590: 6520 616c 7265 6164 7920 7365 6e74 206e  e already sent n
+000095a0: 6f74 206c 6f6e 6720 6167 6f2c 2073 656e  ot long ago, sen
+000095b0: 6420 656d 7079 0a20 2020 2020 2020 2020  d empy.         
+000095c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000095d0: 656d 706f 6f6c 5f74 7873 203d 205b 5d0a  empool_txs = [].
+000095e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000095f0: 2020 2020 2023 2073 656e 6420 6f77 6e0a       # send own.
+00009600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009610: 2020 2020 2320 6e6f 6465 2e6c 6f67 6765      # node.logge
+00009620: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00009630: 2249 6e62 6f75 6e64 3a20 4578 7472 6163  "Inbound: Extrac
+00009640: 7465 6420 6672 6f6d 2074 6865 206d 656d  ted from the mem
+00009650: 706f 6f6c 3a20 2220 2b20 7374 7228 6d65  pool: " + str(me
+00009660: 6d70 6f6f 6c5f 7478 7329 2920 2023 2069  mpool_txs))  # i
+00009670: 6d70 726f 7665 3a20 7379 6e63 2062 6173  mprove: sync bas
+00009680: 6564 206f 6e20 7369 676e 6174 7572 6573  ed on signatures
+00009690: 206f 6e6c 790a 0a20 2020 2020 2020 2020   only..         
+000096a0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+000096b0: 6c65 6e28 6d65 6d70 6f6f 6c5f 7478 7329  len(mempool_txs)
+000096c0: 203e 2030 3a20 7361 6d65 2061 7320 7468   > 0: same as th
+000096d0: 6520 6f74 6865 720a 2020 2020 2020 2020  e other.        
+000096e0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+000096f0: 2873 656c 662e 7265 7175 6573 742c 206d  (self.request, m
+00009700: 656d 706f 6f6c 5f74 7873 290a 0a20 2020  empool_txs)..   
+00009710: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00009720: 6620 6461 7461 203d 3d20 2768 656c 6c6f  f data == 'hello
+00009730: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00009740: 2020 2020 2020 2069 6620 6e6f 6465 2e69         if node.i
+00009750: 735f 7265 676e 6574 3a0a 2020 2020 2020  s_regnet:.      
+00009760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009770: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+00009780: 705f 6c6f 672e 6465 6275 6728 2249 6e62  p_log.debug("Inb
+00009790: 6f75 6e64 3a20 476f 7420 6865 6c6c 6f20  ound: Got hello 
+000097a0: 6275 7420 4927 6d20 696e 2072 6567 7465  but I'm in regte
+000097b0: 7374 206d 6f64 652c 2063 6c6f 7369 6e67  st mode, closing
+000097c0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000097d0: 2020 2020 2020 2020 2020 2020 2320 6462              # db
+000097e0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+000097f0: 652e 636c 6f73 6528 290a 2020 2020 2020  e.close().      
+00009800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009810: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00009820: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00009830: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+00009840: 2027 7065 6572 7327 290a 2020 2020 2020   'peers').      
+00009850: 2020 2020 2020 2020 2020 2020 2020 7065                pe
+00009860: 6572 735f 7365 6e64 203d 206e 6f64 652e  ers_send = node.
+00009870: 7065 6572 732e 7065 6572 5f6c 6973 745f  peers.peer_list_
+00009880: 6469 736b 5f66 6f72 6d61 7428 290a 2020  disk_format().  
+00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098a0: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+000098b0: 6573 742c 2070 6565 7273 5f73 656e 6429  est, peers_send)
+000098c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000098d0: 2020 2020 2020 7768 696c 6520 6e6f 6465        while node
+000098e0: 2e64 625f 6c6f 636b 2e6c 6f63 6b65 6428  .db_lock.locked(
+000098f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00009900: 2020 2020 2020 2020 2020 2074 696d 652e             time.
+00009910: 736c 6565 7028 7175 616e 7469 7a65 5f74  sleep(quantize_t
+00009920: 776f 286e 6f64 652e 7061 7573 6529 290a  wo(node.pause)).
+00009930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009940: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+00009950: 6170 705f 6c6f 672e 6465 6275 6728 2749  app_log.debug('I
+00009960: 6e62 6f75 6e64 3a20 5365 6e64 696e 6720  nbound: Sending 
+00009970: 7379 6e63 2072 6571 7565 7374 2729 0a0a  sync request')..
+00009980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009990: 2020 2020 7365 6e64 2873 656c 662e 7265      send(self.re
+000099a0: 7175 6573 742c 2027 7379 6e63 2729 0a0a  quest, 'sync')..
+000099b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099c0: 656c 6966 2064 6174 6120 3d3d 2027 7365  elif data == 'se
+000099d0: 6e64 7379 6e63 273a 0a20 2020 2020 2020  ndsync':.       
+000099e0: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+000099f0: 6c65 206e 6f64 652e 6462 5f6c 6f63 6b2e  le node.db_lock.
+00009a00: 6c6f 636b 6564 2829 3a0a 2020 2020 2020  locked():.      
+00009a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a20: 2020 7469 6d65 2e73 6c65 6570 2871 7561    time.sleep(qua
+00009a30: 6e74 697a 655f 7477 6f28 6e6f 6465 2e70  ntize_two(node.p
+00009a40: 6175 7365 2929 0a0a 2020 2020 2020 2020  ause))..        
+00009a50: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00009a60: 6520 6c65 6e28 6e6f 6465 2e73 796e 6369  e len(node.synci
+00009a70: 6e67 2920 3e3d 2033 3a0a 2020 2020 2020  ng) >= 3:.      
+00009a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a90: 2020 7469 6d65 2e73 6c65 6570 2869 6e74    time.sleep(int
+00009aa0: 286e 6f64 652e 7061 7573 6529 290a 0a20  (node.pause)).. 
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ac0: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
+00009ad0: 7565 7374 2c20 2773 796e 6327 290a 0a20  uest, 'sync').. 
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009af0: 6c69 6620 6461 7461 203d 3d20 2762 6c6f  lif data == 'blo
+00009b00: 636b 7366 6e64 273a 0a20 2020 2020 2020  cksfnd':.       
+00009b10: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00009b20: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00009b30: 2e64 6562 7567 2866 2749 6e62 6f75 6e64  .debug(f'Inbound
+00009b40: 3a20 436c 6965 6e74 207b 7065 6572 5f69  : Client {peer_i
+00009b50: 707d 2068 6173 2074 6865 2062 6c6f 636b  p} has the block
+00009b60: 2873 2927 2920 2023 206e 6f64 6520 7368  (s)')  # node sh
+00009b70: 6f75 6c64 2073 7461 7274 2073 656e 6469  ould start sendi
+00009b80: 6e67 2074 7873 2069 6e20 7468 6973 2073  ng txs in this s
+00009b90: 7465 700a 0a20 2020 2020 2020 2020 2020  tep..           
+00009ba0: 2020 2020 2020 2020 2023 206e 6f64 652e           # node.
+00009bb0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e64  logger.app_log.d
+00009bc0: 6562 7567 2822 496e 626f 756e 643a 2043  ebug("Inbound: C
+00009bd0: 6f6d 6269 6e65 6420 7365 676d 656e 7473  ombined segments
+00009be0: 3a20 2220 2b20 7365 676d 656e 7473 290a  : " + segments).
 00009bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c10: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00009c20: 5f6c 6f67 2e69 6e66 6f28 6627 7b70 6565  _log.info(f'{pee
-00009c30: 725f 6970 7d20 6261 6e6e 6564 2729 0a20  r_ip} banned'). 
-00009c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c60: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ca0: 2020 2020 2020 2020 2020 2064 6967 6573             diges
-00009cb0: 745f 626c 6f63 6b28 6e6f 6465 2c20 7365  t_block(node, se
-00009cc0: 676d 656e 7473 2c20 7365 6c66 2e72 6571  gments, self.req
-00009cd0: 7565 7374 2c20 7065 6572 5f69 702c 2064  uest, peer_ip, d
-00009ce0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-00009cf0: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
-00009d00: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00009d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009d20: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00009d30: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00009d40: 672e 7761 726e 696e 6728 6627 5265 6a65  g.warning(f'Reje
-00009d50: 6374 696e 6720 746f 2073 796e 6320 6672  cting to sync fr
-00009d60: 6f6d 207b 7065 6572 5f69 707d 2729 0a20  om {peer_ip}'). 
-00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d80: 2020 2020 2020 2020 2020 2073 656e 6428             send(
-00009d90: 7365 6c66 2e72 6571 7565 7374 2c20 2762  self.request, 'b
-00009da0: 6c6f 636b 7372 6a27 290a 2020 2020 2020  locksrj').      
-00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009dc0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-00009dd0: 722e 6170 705f 6c6f 672e 696e 666f 2866  r.app_log.info(f
-00009de0: 2749 6e62 6f75 6e64 3a20 4469 7374 616e  'Inbound: Distan
-00009df0: 7420 7065 6572 207b 7065 6572 5f69 707d  t peer {peer_ip}
-00009e00: 2069 7320 6174 207b 7265 6365 6976 6564   is at {received
-00009e10: 5f62 6c6f 636b 5f68 6569 6768 747d 2c20  _block_height}, 
-00009e20: 7368 6f75 6c64 2062 6520 6174 206c 6561  should be at lea
-00009e30: 7374 207b 6d61 7828 626c 6f63 6b5f 7265  st {max(block_re
-00009e40: 712c 6e6f 6465 2e6c 6173 745f 626c 6f63  q,node.last_bloc
-00009e50: 6b2b 3129 7d27 290a 2020 2020 2020 2020  k+1)}').        
-00009e60: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-00009e70: 2873 656c 662e 7265 7175 6573 742c 2027  (self.request, '
-00009e80: 7379 6e63 2729 0a0a 2020 2020 2020 2020  sync')..        
-00009e90: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-00009ea0: 6120 3d3d 2027 626c 6f63 6b68 6569 6768  a == 'blockheigh
-00009eb0: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
-00009ec0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ee0: 2020 2020 2072 6563 6569 7665 645f 626c       received_bl
-00009ef0: 6f63 6b5f 6865 6967 6874 203d 2072 6563  ock_height = rec
-00009f00: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-00009f10: 7429 2020 2320 7265 6365 6976 6520 636c  t)  # receive cl
-00009f20: 6965 6e74 2773 206c 6173 7420 626c 6f63  ient's last bloc
-00009f30: 6b20 6865 6967 6874 0a20 2020 2020 2020  k height.       
-00009f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f50: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00009f60: 5f6c 6f67 2e69 6e66 6f28 6627 496e 626f  _log.info(f'Inbo
-00009f70: 756e 643a 2052 6563 6569 7665 6420 626c  und: Received bl
-00009f80: 6f63 6b20 6865 6967 6874 207b 7265 6365  ock height {rece
-00009f90: 6976 6564 5f62 6c6f 636b 5f68 6569 6768  ived_block_heigh
-00009fa0: 747d 2066 726f 6d20 7b70 6565 725f 6970  t} from {peer_ip
-00009fb0: 7d20 2729 0a0a 2020 2020 2020 2020 2020  } ')..          
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00009fd0: 636f 6e73 656e 7375 7320 706f 6f6c 2031  consensus pool 1
-00009fe0: 2028 636f 6e6e 6563 7469 6f6e 2066 726f   (connection fro
-00009ff0: 6d20 7468 656d 290a 2020 2020 2020 2020  m them).        
-0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a010: 636f 6e73 656e 7375 735f 626c 6f63 6b68  consensus_blockh
-0000a020: 6569 6768 7420 3d20 696e 7428 7265 6365  eight = int(rece
-0000a030: 6976 6564 5f62 6c6f 636b 5f68 6569 6768  ived_block_heigh
-0000a040: 7429 2020 2320 7374 7220 696e 7420 746f  t)  # str int to
-0000a050: 2072 656d 6f76 6520 6c65 6164 696e 6720   remove leading 
-0000a060: 7a65 726f 730a 2020 2020 2020 2020 2020  zeros.          
-0000a070: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000a080: 636f 6e73 656e 7375 735f 6164 6428 7065  consensus_add(pe
-0000a090: 6572 5f69 702c 2063 6f6e 7365 6e73 7573  er_ip, consensus
-0000a0a0: 5f62 6c6f 636b 6865 6967 6874 2c20 7365  _blockheight, se
-0000a0b0: 6c66 2e72 6571 7565 7374 290a 2020 2020  lf.request).    
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0d0: 2020 2020 6e6f 6465 2e70 6565 7273 2e63      node.peers.c
-0000a0e0: 6f6e 7365 6e73 7573 5f61 6464 2870 6565  onsensus_add(pee
-0000a0f0: 725f 6970 2c20 636f 6e73 656e 7375 735f  r_ip, consensus_
-0000a100: 626c 6f63 6b68 6569 6768 742c 2073 656c  blockheight, sel
-0000a110: 662e 7265 7175 6573 742c 206e 6f64 652e  f.request, node.
-0000a120: 6864 645f 626c 6f63 6b29 0a20 2020 2020  hdd_block).     
-0000a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a140: 2020 2023 2063 6f6e 7365 6e73 7573 2070     # consensus p
-0000a150: 6f6f 6c20 3120 2863 6f6e 6e65 6374 696f  ool 1 (connectio
-0000a160: 6e20 6672 6f6d 2074 6865 6d29 0a0a 2020  n from them)..  
-0000a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a180: 2020 2020 2020 2320 6170 7065 6e64 207a        # append z
-0000a190: 6572 6f65 7320 746f 2067 6574 2073 7461  eroes to get sta
-0000a1a0: 7469 6320 6c65 6e67 7468 0a20 2020 2020  tic length.     
-0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1c0: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
-0000a1d0: 7565 7374 2c20 6e6f 6465 2e68 6464 5f62  uest, node.hdd_b
-0000a1e0: 6c6f 636b 290a 2020 2020 2020 2020 2020  lock).          
-0000a1f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000a200: 7365 6e64 206f 776e 2062 6c6f 636b 2068  send own block h
-0000a210: 6569 6768 740a 0a20 2020 2020 2020 2020  eight..         
-0000a220: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000a230: 6620 696e 7428 7265 6365 6976 6564 5f62  f int(received_b
-0000a240: 6c6f 636b 5f68 6569 6768 7429 203e 206e  lock_height) > n
-0000a250: 6f64 652e 6864 645f 626c 6f63 6b3a 0a20  ode.hdd_block:. 
-0000a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a270: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000a280: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-0000a290: 6172 6e69 6e67 2827 496e 626f 756e 643a  arning('Inbound:
-0000a2a0: 2043 6c69 656e 7420 6861 7320 6869 6768   Client has high
-0000a2b0: 6572 2062 6c6f 636b 2729 0a0a 2020 2020  er block')..    
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-0000a2e0: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-0000a2f0: 2866 2749 6e62 6f75 6e64 3a20 626c 6f63  (f'Inbound: bloc
-0000a300: 6b5f 6861 7368 2074 6f20 7365 6e64 3a20  k_hash to send: 
-0000a310: 7b6e 6f64 652e 6864 645f 6861 7368 7d27  {node.hdd_hash}'
-0000a320: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a330: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000a340: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-0000a350: 206e 6f64 652e 6864 645f 6861 7368 290a   node.hdd_hash).
-0000a360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a370: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-0000a380: 6563 6569 7665 2074 6865 6972 206c 6174  eceive their lat
-0000a390: 6573 7420 7368 615f 6861 7368 0a20 2020  est sha_hash.   
-0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3b0: 2020 2020 2020 2020 2023 2063 6f6e 6669           # confi
-0000a3c0: 726d 2079 6f75 206b 6e6f 7720 7468 6174  rm you know that
-0000a3d0: 2073 6861 5f68 6173 6820 6f72 2063 6f6e   sha_hash or con
-0000a3e0: 7469 6e75 6520 7265 6365 6976 696e 670a  tinue receiving.
-0000a3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a400: 2020 2020 2020 2020 2065 6c69 6620 696e           elif in
-0000a410: 7428 7265 6365 6976 6564 5f62 6c6f 636b  t(received_block
-0000a420: 5f68 6569 6768 7429 203c 3d20 6e6f 6465  _height) <= node
-0000a430: 2e68 6464 5f62 6c6f 636b 3a0a 2020 2020  .hdd_block:.    
-0000a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a450: 2020 2020 2020 2020 6966 2069 6e74 2872          if int(r
-0000a460: 6563 6569 7665 645f 626c 6f63 6b5f 6865  eceived_block_he
-0000a470: 6967 6874 2920 3d3d 206e 6f64 652e 6864  ight) == node.hd
-0000a480: 645f 626c 6f63 6b3a 0a20 2020 2020 2020  d_block:.       
+00009c00: 2020 2020 2320 7072 696e 7420 7065 6572      # print peer
+00009c10: 5f69 700a 2020 2020 2020 2020 2020 2020  _ip.            
+00009c20: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+00009c30: 6462 5f6c 6f63 6b2e 6c6f 636b 6564 2829  db_lock.locked()
+00009c40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009c50: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+00009c60: 6f67 6765 722e 6170 705f 6c6f 672e 6465  ogger.app_log.de
+00009c70: 6275 6728 6627 536b 6970 7069 6e67 2073  bug(f'Skipping s
+00009c80: 796e 6320 6672 6f6d 207b 7065 6572 5f69  ync from {peer_i
+00009c90: 707d 2c20 7379 6e63 696e 6720 616c 7265  p}, syncing alre
+00009ca0: 6164 7920 696e 2070 726f 6772 6573 7327  ady in progress'
+00009cb0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00009cc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ce0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+00009cf0: 696e 7374 616e 6365 203d 2064 6268 616e  instance = dbhan
+00009d00: 646c 6572 2e44 6248 616e 646c 6572 286e  dler.DbHandler(n
+00009d10: 6f64 652e 696e 6465 785f 6462 2c20 6e6f  ode.index_db, no
+00009d20: 6465 2e6c 6564 6765 725f 7061 7468 2c20  de.ledger_path, 
+00009d30: 6e6f 6465 2e68 7970 6572 5f70 6174 682c  node.hyper_path,
+00009d40: 206e 6f64 652e 7261 6d2c 206e 6f64 652e   node.ram, node.
+00009d50: 6c65 6467 6572 5f72 616d 5f66 696c 652c  ledger_ram_file,
+00009d60: 206e 6f64 652e 6c6f 6767 6572 2c20 7472   node.logger, tr
+00009d70: 6163 655f 6462 5f63 616c 6c73 3d6e 6f64  ace_db_calls=nod
+00009d80: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
+00009d90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009da0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+00009db0: 6173 745f 626c 6f63 6b5f 7469 6d65 7374  ast_block_timest
+00009dc0: 616d 7020 3d20 6462 5f68 616e 646c 6572  amp = db_handler
+00009dd0: 5f69 6e73 7461 6e63 652e 6c61 7374 5f62  _instance.last_b
+00009de0: 6c6f 636b 5f74 696d 6573 7461 6d70 2829  lock_timestamp()
+00009df0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009e00: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
+00009e10: 652e 6c61 7374 5f62 6c6f 636b 5f74 696d  e.last_block_tim
+00009e20: 6573 7461 6d70 203c 2074 696d 652e 7469  estamp < time.ti
+00009e30: 6d65 2829 202d 2036 3030 3a0a 2020 2020  me() - 600:.    
+00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e50: 2020 2020 2020 2020 2320 626c 6f63 6b5f          # block_
+00009e60: 7265 7120 3d20 6d6f 7374 5f63 6f6d 6d6f  req = most_commo
+00009e70: 6e28 636f 6e73 656e 7375 735f 626c 6f63  n(consensus_bloc
+00009e80: 6b68 6569 6768 745f 6c69 7374 290a 2020  kheight_list).  
+00009e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ea0: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00009eb0: 7265 7120 3d20 6e6f 6465 2e70 6565 7273  req = node.peers
+00009ec0: 2e63 6f6e 7365 6e73 7573 5f6d 6f73 745f  .consensus_most_
+00009ed0: 636f 6d6d 6f6e 0a20 2020 2020 2020 2020  common.         
+00009ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ef0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+00009f00: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
+00009f10: 4d6f 7374 2063 6f6d 6d6f 6e20 626c 6f63  Most common bloc
+00009f20: 6b20 7275 6c65 2074 7269 6767 6572 6564  k rule triggered
+00009f30: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00009f40: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00009f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009f60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009f70: 626c 6f63 6b5f 7265 7120 3d20 6d61 7828  block_req = max(
+00009f80: 636f 6e73 656e 7375 735f 626c 6f63 6b68  consensus_blockh
+00009f90: 6569 6768 745f 6c69 7374 290a 2020 2020  eight_list).    
+00009fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009fb0: 2020 2020 2020 2020 626c 6f63 6b5f 7265          block_re
+00009fc0: 7120 3d20 6e6f 6465 2e70 6565 7273 2e63  q = node.peers.c
+00009fd0: 6f6e 7365 6e73 7573 5f6d 6178 0a20 2020  onsensus_max.   
+00009fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ff0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+0000a000: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
+0000a010: 6e69 6e67 2827 4c6f 6e67 6573 7420 6368  ning('Longest ch
+0000a020: 6169 6e20 7275 6c65 2074 7269 6767 6572  ain rule trigger
+0000a030: 6564 2729 0a0a 2020 2020 2020 2020 2020  ed')..          
+0000a040: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000a050: 2069 6e74 2872 6563 6569 7665 645f 626c   int(received_bl
+0000a060: 6f63 6b5f 6865 6967 6874 2920 3e3d 2062  ock_height) >= b
+0000a070: 6c6f 636b 5f72 6571 2061 6e64 2069 6e74  lock_req and int
+0000a080: 2872 6563 6569 7665 645f 626c 6f63 6b5f  (received_block_
+0000a090: 6865 6967 6874 2920 3e20 6e6f 6465 2e6c  height) > node.l
+0000a0a0: 6173 745f 626c 6f63 6b3a 0a0a 2020 2020  ast_block:..    
+0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0c0: 2020 2020 2020 2020 7472 793a 2020 2320          try:  # 
+0000a0d0: 7468 6579 2063 6c61 696d 2074 6f20 6861  they claim to ha
+0000a0e0: 7665 2074 6865 206c 6f6e 6765 7374 2063  ve the longest c
+0000a0f0: 6861 696e 2c20 7468 696e 6773 206d 7573  hain, things mus
+0000a100: 7420 676f 2073 6d6f 6f74 6820 6f72 2062  t go smooth or b
+0000a110: 616e 0a20 2020 2020 2020 2020 2020 2020  an.             
+0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a130: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000a140: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
+0000a150: 2743 6f6e 6669 726d 696e 6720 746f 2073  'Confirming to s
+0000a160: 796e 6320 6672 6f6d 207b 7065 6572 5f69  ync from {peer_i
+0000a170: 707d 2729 0a20 2020 2020 2020 2020 2020  p}').           
+0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a190: 2020 2020 206e 6f64 652e 706c 7567 696e       node.plugin
+0000a1a0: 5f6d 616e 6167 6572 2e65 7865 6375 7465  _manager.execute
+0000a1b0: 5f61 6374 696f 6e5f 686f 6f6b 2827 7379  _action_hook('sy
+0000a1c0: 6e63 272c 207b 2777 6861 7427 3a20 2773  nc', {'what': 's
+0000a1d0: 796e 6369 6e67 5f66 726f 6d27 2c20 2769  yncing_from', 'i
+0000a1e0: 7027 3a20 7065 6572 5f69 707d 290a 2020  p': peer_ip}).  
+0000a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a200: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a210: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+0000a220: 2027 626c 6f63 6b73 6366 2729 0a0a 2020   'blockscf')..  
+0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a240: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a250: 676d 656e 7473 203d 2072 6563 6569 7665  gments = receive
+0000a260: 2873 656c 662e 7265 7175 6573 7429 0a0a  (self.request)..
+0000a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a280: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000a290: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2b0: 2020 2020 6966 206e 6f64 652e 7065 6572      if node.peer
+0000a2c0: 732e 7761 726e 696e 6728 7365 6c66 2e72  s.warning(self.r
+0000a2d0: 6571 7565 7374 2c20 7065 6572 5f69 702c  equest, peer_ip,
+0000a2e0: 2027 4661 696c 6564 2074 6f20 6465 6c69   'Failed to deli
+0000a2f0: 7665 7220 7468 6520 6c6f 6e67 6573 7420  ver the longest 
+0000a300: 6368 6169 6e27 293a 0a20 2020 2020 2020  chain'):.       
+0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a320: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000a330: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000a340: 2e77 6172 6e69 6e67 2866 277b 7065 6572  .warning(f'{peer
+0000a350: 5f69 707d 2062 616e 6e65 6427 290a 2020  _ip} banned').  
+0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a380: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3c0: 2020 2020 2020 2020 2020 6469 6765 7374            digest
+0000a3d0: 5f62 6c6f 636b 286e 6f64 652c 2073 6567  _block(node, seg
+0000a3e0: 6d65 6e74 732c 2073 656c 662e 7265 7175  ments, self.requ
+0000a3f0: 6573 742c 2070 6565 725f 6970 2c20 6462  est, peer_ip, db
+0000a400: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+0000a410: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0000a420: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000a430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a440: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000a450: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000a460: 2e77 6172 6e69 6e67 2866 2752 656a 6563  .warning(f'Rejec
+0000a470: 7469 6e67 2074 6f20 7379 6e63 2066 726f  ting to sync fro
+0000a480: 6d20 7b70 6565 725f 6970 7d27 290a 2020  m {peer_ip}').  
 0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4a0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-0000a4b0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-0000a4c0: 6f28 6627 496e 626f 756e 643a 2057 6520  o(f'Inbound: We 
-0000a4d0: 6861 7665 2074 6865 2073 616d 6520 6865  have the same he
-0000a4e0: 6967 6874 2061 7320 7b70 6565 725f 6970  ight as {peer_ip
-0000a4f0: 7d20 287b 7265 6365 6976 6564 5f62 6c6f  } ({received_blo
-0000a500: 636b 5f68 6569 6768 747d 292c 2068 6173  ck_height}), has
-0000a510: 6820 7769 6c6c 2062 6520 7665 7269 6669  h will be verifi
-0000a520: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
-0000a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a540: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a560: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0000a570: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-0000a580: 6e67 2866 2749 6e62 6f75 6e64 3a20 5765  ng(f'Inbound: We
-0000a590: 2068 6176 6520 6869 6768 6572 2028 7b6e   have higher ({n
-0000a5a0: 6f64 652e 6864 645f 626c 6f63 6b7d 2920  ode.hdd_block}) 
-0000a5b0: 626c 6f63 6b20 6865 6967 6874 2074 6861  block height tha
-0000a5c0: 6e20 7b70 6565 725f 6970 7d20 287b 7265  n {peer_ip} ({re
-0000a5d0: 6365 6976 6564 5f62 6c6f 636b 5f68 6569  ceived_block_hei
-0000a5e0: 6768 747d 292c 2068 6173 6820 7769 6c6c  ght}), hash will
-0000a5f0: 2062 6520 7665 7269 6669 6564 2729 0a0a   be verified')..
-0000a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a610: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0000a620: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-0000a630: 7265 7175 6573 7429 2020 2320 7265 6365  request)  # rece
-0000a640: 6976 6520 636c 6965 6e74 2773 206c 6173  ive client's las
-0000a650: 7420 626c 6f63 6b5f 6861 7368 0a20 2020  t block_hash.   
-0000a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a670: 2020 2020 2020 2020 2023 2073 656e 6420           # send 
-0000a680: 616c 6c20 6f75 7220 666f 6c6c 6f77 7570  all our followup
-0000a690: 2068 6173 6865 730a 2020 2020 2020 2020   hashes.        
-0000a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6b0: 2020 2020 6966 2064 6174 6120 3d3d 2027      if data == '
-0000a6c0: 2a27 3a0a 2020 2020 2020 2020 2020 2020  *':.            
-0000a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6e0: 2020 2020 2320 636f 6e6e 6563 7469 6f6e      # connection
-0000a6f0: 206c 6f73 742c 206e 6f20 6e65 6564 2074   lost, no need t
-0000a700: 6f20 676f 206f 6e2c 2074 6861 7420 7761  o go on, that wa
-0000a710: 7320 6261 6e6e 696e 6720 7468 6520 6e6f  s banning the no
-0000a720: 6465 206c 696b 6520 6974 2066 6f72 6b65  de like it forke
-0000a730: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-0000a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a750: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0000a760: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
-0000a770: 2749 6e62 6f75 6e64 3a20 7b70 6565 725f  'Inbound: {peer_
-0000a780: 6970 7d20 6472 6f70 7065 6420 636f 6e6e  ip} dropped conn
-0000a790: 6563 7469 6f6e 2729 0a20 2020 2020 2020  ection').       
-0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7b0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0000a4a0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
+0000a4b0: 656c 662e 7265 7175 6573 742c 2027 626c  elf.request, 'bl
+0000a4c0: 6f63 6b73 726a 2729 0a20 2020 2020 2020  ocksrj').       
+0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4e0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+0000a4f0: 2e61 7070 5f6c 6f67 2e64 6562 7567 2866  .app_log.debug(f
+0000a500: 2749 6e62 6f75 6e64 3a20 4469 7374 616e  'Inbound: Distan
+0000a510: 7420 7065 6572 207b 7065 6572 5f69 707d  t peer {peer_ip}
+0000a520: 2069 7320 6174 207b 7265 6365 6976 6564   is at {received
+0000a530: 5f62 6c6f 636b 5f68 6569 6768 747d 2c20  _block_height}, 
+0000a540: 7368 6f75 6c64 2062 6520 6174 206c 6561  should be at lea
+0000a550: 7374 207b 6d61 7828 626c 6f63 6b5f 7265  st {max(block_re
+0000a560: 712c 6e6f 6465 2e6c 6173 745f 626c 6f63  q,node.last_bloc
+0000a570: 6b2b 3129 7d27 290a 2020 2020 2020 2020  k+1)}').        
+0000a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a590: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+0000a5a0: 6e63 652e 636c 6f73 6528 290a 0a20 2020  nce.close()..   
+0000a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5c0: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+0000a5d0: 7374 2c20 2773 796e 6327 290a 0a20 2020  st, 'sync')..   
+0000a5e0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0000a5f0: 6620 6461 7461 203d 3d20 2762 6c6f 636b  f data == 'block
+0000a600: 6865 6967 6874 273a 0a20 2020 2020 2020  height':.       
+0000a610: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000a620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a630: 2020 2020 2020 2020 2020 7265 6365 6976            receiv
+0000a640: 6564 5f62 6c6f 636b 5f68 6569 6768 7420  ed_block_height 
+0000a650: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
+0000a660: 6571 7565 7374 2920 2023 2072 6563 6569  equest)  # recei
+0000a670: 7665 2063 6c69 656e 7427 7320 6c61 7374  ve client's last
+0000a680: 2062 6c6f 636b 2068 6569 6768 740a 2020   block height.  
+0000a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6a0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+0000a6b0: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+0000a6c0: 6627 496e 626f 756e 643a 2052 6563 6569  f'Inbound: Recei
+0000a6d0: 7665 6420 626c 6f63 6b20 6865 6967 6874  ved block height
+0000a6e0: 207b 7265 6365 6976 6564 5f62 6c6f 636b   {received_block
+0000a6f0: 5f68 6569 6768 747d 2066 726f 6d20 7b70  _height} from {p
+0000a700: 6565 725f 6970 7d20 2729 0a0a 2020 2020  eer_ip} ')..    
+0000a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a720: 2020 2020 2320 636f 6e73 656e 7375 7320      # consensus 
+0000a730: 706f 6f6c 2031 2028 636f 6e6e 6563 7469  pool 1 (connecti
+0000a740: 6f6e 2066 726f 6d20 7468 656d 290a 2020  on from them).  
+0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a760: 2020 2020 2020 636f 6e73 656e 7375 735f        consensus_
+0000a770: 626c 6f63 6b68 6569 6768 7420 3d20 696e  blockheight = in
+0000a780: 7428 7265 6365 6976 6564 5f62 6c6f 636b  t(received_block
+0000a790: 5f68 6569 6768 7429 2020 2320 7374 7220  _height)  # str 
+0000a7a0: 696e 7420 746f 2072 656d 6f76 6520 6c65  int to remove le
+0000a7b0: 6164 696e 6720 7a65 726f 730a 2020 2020  ading zeros.    
 0000a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7d0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000a7e0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-0000a7f0: 6e66 6f28 6627 496e 626f 756e 643a 2057  nfo(f'Inbound: W
-0000a800: 696c 6c20 7365 656b 2074 6865 2066 6f6c  ill seek the fol
-0000a810: 6c6f 7769 6e67 2062 6c6f 636b 3a20 7b64  lowing block: {d
-0000a820: 6174 617d 2729 0a0a 2020 2020 2020 2020  ata}')..        
-0000a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a840: 2020 2020 636c 6965 6e74 5f62 6c6f 636b      client_block
-0000a850: 203d 2064 625f 6861 6e64 6c65 725f 696e   = db_handler_in
-0000a860: 7374 616e 6365 2e62 6c6f 636b 5f68 6569  stance.block_hei
-0000a870: 6768 745f 6672 6f6d 5f68 6173 6828 6461  ght_from_hash(da
-0000a880: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
-0000a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a8a0: 6966 2063 6c69 656e 745f 626c 6f63 6b20  if client_block 
-0000a8b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a8d0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-0000a8e0: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
-0000a8f0: 6e69 6e67 2866 2749 6e62 6f75 6e64 3a20  ning(f'Inbound: 
-0000a900: 426c 6f63 6b20 7b64 6174 615b 3a38 5d7d  Block {data[:8]}
-0000a910: 206f 6620 7b70 6565 725f 6970 7d20 6e6f   of {peer_ip} no
-0000a920: 7420 666f 756e 6427 290a 2020 2020 2020  t found').      
-0000a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a940: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-0000a950: 652e 6675 6c6c 5f6c 6564 6765 723a 0a20  e.full_ledger:. 
-0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7d0: 2020 2020 2320 636f 6e73 656e 7375 735f      # consensus_
+0000a7e0: 6164 6428 7065 6572 5f69 702c 2063 6f6e  add(peer_ip, con
+0000a7f0: 7365 6e73 7573 5f62 6c6f 636b 6865 6967  sensus_blockheig
+0000a800: 6874 2c20 7365 6c66 2e72 6571 7565 7374  ht, self.request
+0000a810: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a820: 2020 2020 2020 2020 2020 6e6f 6465 2e70            node.p
+0000a830: 6565 7273 2e63 6f6e 7365 6e73 7573 5f61  eers.consensus_a
+0000a840: 6464 2870 6565 725f 6970 2c20 636f 6e73  dd(peer_ip, cons
+0000a850: 656e 7375 735f 626c 6f63 6b68 6569 6768  ensus_blockheigh
+0000a860: 742c 2073 656c 662e 7265 7175 6573 742c  t, self.request,
+0000a870: 206e 6f64 652e 6864 645f 626c 6f63 6b29   node.hdd_block)
+0000a880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a890: 2020 2020 2020 2020 2023 2063 6f6e 7365           # conse
+0000a8a0: 6e73 7573 2070 6f6f 6c20 3120 2863 6f6e  nsus pool 1 (con
+0000a8b0: 6e65 6374 696f 6e20 6672 6f6d 2074 6865  nection from the
+0000a8c0: 6d29 0a0a 2020 2020 2020 2020 2020 2020  m)..            
+0000a8d0: 2020 2020 2020 2020 2020 2020 2320 6170              # ap
+0000a8e0: 7065 6e64 207a 6572 6f65 7320 746f 2067  pend zeroes to g
+0000a8f0: 6574 2073 7461 7469 6320 6c65 6e67 7468  et static length
+0000a900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a910: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+0000a920: 6c66 2e72 6571 7565 7374 2c20 6e6f 6465  lf.request, node
+0000a930: 2e68 6464 5f62 6c6f 636b 290a 2020 2020  .hdd_block).    
+0000a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a950: 2020 2020 2320 7365 6e64 206f 776e 2062      # send own b
+0000a960: 6c6f 636b 2068 6569 6768 740a 0a20 2020  lock height..   
 0000a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a980: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
-0000a990: 7565 7374 2c20 2762 6c6f 636b 6e66 2729  uest, 'blocknf')
-0000a9a0: 2020 2320 616e 6e6f 756e 6365 2062 6c6f    # announce blo
-0000a9b0: 636b 2068 6173 6820 7761 7320 6e6f 7420  ck hash was not 
-0000a9c0: 666f 756e 640a 2020 2020 2020 2020 2020  found.          
-0000a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa10: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-0000aa20: 742c 2027 626c 6f63 6b6e 6668 6227 2920  t, 'blocknfhb') 
-0000aa30: 2023 2061 6e6e 6f75 6e63 6520 7765 2061   # announce we a
-0000aa40: 7265 206f 6e20 6879 7065 7262 6c6f 636b  re on hyperblock
-0000aa50: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa70: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
-0000aa80: 6573 742c 2064 6174 6129 0a0a 2020 2020  est, data)..    
-0000aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aaa0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000aab0: 6f64 652e 7065 6572 732e 7761 726e 696e  ode.peers.warnin
-0000aac0: 6728 7365 6c66 2e72 6571 7565 7374 2c20  g(self.request, 
-0000aad0: 7065 6572 5f69 702c 2027 466f 726b 6564  peer_ip, 'Forked
-0000aae0: 272c 2032 293a 0a20 2020 2020 2020 2020  ', 2):.         
-0000aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab00: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000ab10: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-0000ab20: 6e66 6f28 6627 7b70 6565 725f 6970 7d20  nfo(f'{peer_ip} 
-0000ab30: 6261 6e6e 6564 2729 0a20 2020 2020 2020  banned').       
-0000ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab50: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0000ab60: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0000ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aba0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0000abb0: 722e 6170 705f 6c6f 672e 696e 666f 2866  r.app_log.info(f
-0000abc0: 2749 6e62 6f75 6e64 3a20 436c 6965 6e74  'Inbound: Client
-0000abd0: 2069 7320 6174 2062 6c6f 636b 207b 636c   is at block {cl
-0000abe0: 6965 6e74 5f62 6c6f 636b 7d27 2920 2023  ient_block}')  #
-0000abf0: 206e 6f77 2063 6865 636b 2069 6620 7765   now check if we
-0000ac00: 2068 6176 6520 616e 7920 6e65 7765 720a   have any newer.
-0000ac10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac30: 2069 6620 6e6f 6465 2e68 6464 5f68 6173   if node.hdd_has
-0000ac40: 6820 3d3d 2064 6174 6120 6f72 206e 6f74  h == data or not
-0000ac50: 206e 6f64 652e 6567 7265 7373 3a0a 2020   node.egress:.  
-0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac80: 2020 6966 206e 6f74 206e 6f64 652e 6567    if not node.eg
-0000ac90: 7265 7373 3a0a 2020 2020 2020 2020 2020  ress:.          
+0000a980: 2020 2020 2069 6620 696e 7428 7265 6365       if int(rece
+0000a990: 6976 6564 5f62 6c6f 636b 5f68 6569 6768  ived_block_heigh
+0000a9a0: 7429 203e 206e 6f64 652e 6864 645f 626c  t) > node.hdd_bl
+0000a9b0: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
+0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9d0: 2023 206e 6f64 652e 6c6f 6767 6572 2e61   # node.logger.a
+0000a9e0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
+0000a9f0: 496e 626f 756e 643a 2043 6c69 656e 7420  Inbound: Client 
+0000aa00: 6861 7320 6869 6768 6572 2062 6c6f 636b  has higher block
+0000aa10: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0000aa20: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000aa30: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+0000aa40: 6f67 2e64 6562 7567 2866 2749 6e62 6f75  og.debug(f'Inbou
+0000aa50: 6e64 3a20 626c 6f63 6b5f 6861 7368 2074  nd: block_hash t
+0000aa60: 6f20 7365 6e64 3a20 7b6e 6f64 652e 6864  o send: {node.hd
+0000aa70: 645f 6861 7368 7d27 290a 2020 2020 2020  d_hash}').      
+0000aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa90: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+0000aaa0: 7265 7175 6573 742c 206e 6f64 652e 6864  request, node.hd
+0000aab0: 645f 6861 7368 290a 0a20 2020 2020 2020  d_hash)..       
+0000aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aad0: 2020 2020 2023 2072 6563 6569 7665 2074       # receive t
+0000aae0: 6865 6972 206c 6174 6573 7420 7368 615f  heir latest sha_
+0000aaf0: 6861 7368 0a20 2020 2020 2020 2020 2020  hash.           
+0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab10: 2023 2063 6f6e 6669 726d 2079 6f75 206b   # confirm you k
+0000ab20: 6e6f 7720 7468 6174 2073 6861 5f68 6173  now that sha_has
+0000ab30: 6820 6f72 2063 6f6e 7469 6e75 6520 7265  h or continue re
+0000ab40: 6365 6976 696e 670a 0a20 2020 2020 2020  ceiving..       
+0000ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab60: 2065 6c69 6620 696e 7428 7265 6365 6976   elif int(receiv
+0000ab70: 6564 5f62 6c6f 636b 5f68 6569 6768 7429  ed_block_height)
+0000ab80: 203c 3d20 6e6f 6465 2e68 6464 5f62 6c6f   <= node.hdd_blo
+0000ab90: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+0000aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abb0: 6966 2069 6e74 2872 6563 6569 7665 645f  if int(received_
+0000abc0: 626c 6f63 6b5f 6865 6967 6874 2920 3d3d  block_height) ==
+0000abd0: 206e 6f64 652e 6864 645f 626c 6f63 6b3a   node.hdd_block:
+0000abe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac00: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0000ac10: 5f6c 6f67 2e64 6562 7567 2866 2749 6e62  _log.debug(f'Inb
+0000ac20: 6f75 6e64 3a20 5765 2068 6176 6520 7468  ound: We have th
+0000ac30: 6520 7361 6d65 2068 6569 6768 7420 6173  e same height as
+0000ac40: 207b 7065 6572 5f69 707d 2028 7b72 6563   {peer_ip} ({rec
+0000ac50: 6569 7665 645f 626c 6f63 6b5f 6865 6967  eived_block_heig
+0000ac60: 6874 7d29 2c20 6861 7368 2077 696c 6c20  ht}), hash will 
+0000ac70: 6265 2076 6572 6966 6965 6427 290a 2020  be verified').  
+0000ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
 0000aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acb0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0000acc0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-0000acd0: 672e 7761 726e 696e 6728 6627 496e 626f  g.warning(f'Inbo
-0000ace0: 756e 643a 2045 6772 6573 7320 6469 7361  und: Egress disa
-0000acf0: 626c 6564 2066 6f72 207b 7065 6572 5f69  bled for {peer_i
-0000ad00: 707d 2729 0a20 2020 2020 2020 2020 2020  p}').           
-0000ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad50: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0000ad60: 6572 2e61 7070 5f6c 6f67 2e69 6e66 6f28  er.app_log.info(
-0000ad70: 6627 496e 626f 756e 643a 2043 6c69 656e  f'Inbound: Clien
-0000ad80: 7420 7b70 6565 725f 6970 7d20 6861 7320  t {peer_ip} has 
-0000ad90: 7468 6520 6c61 7465 7374 2062 6c6f 636b  the latest block
-0000ada0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adc0: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-0000add0: 6570 2869 6e74 286e 6f64 652e 7061 7573  ep(int(node.paus
-0000ade0: 6529 2920 2023 2072 6564 7563 6520 4350  e))  # reduce CP
-0000adf0: 5520 7573 6167 650a 2020 2020 2020 2020  U usage.        
-0000ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae10: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-0000ae20: 2873 656c 662e 7265 7175 6573 742c 2027  (self.request, '
-0000ae30: 6e6f 6e65 7762 6c6b 2729 0a0a 2020 2020  nonewblk')..    
-0000ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000ae60: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-0000ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae80: 2020 2020 2020 2062 6c6f 636b 735f 6665         blocks_fe
-0000ae90: 7463 6865 6420 3d20 6462 5f68 616e 646c  tched = db_handl
-0000aea0: 6572 5f69 6e73 7461 6e63 652e 626c 6f63  er_instance.bloc
-0000aeb0: 6b73 796e 6328 636c 6965 6e74 5f62 6c6f  ksync(client_blo
-0000aec0: 636b 290a 0a20 2020 2020 2020 2020 2020  ck)..           
-0000aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aee0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-0000aef0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-0000af00: 6f28 6627 496e 626f 756e 643a 2053 656c  o(f'Inbound: Sel
-0000af10: 6563 7465 6420 7b62 6c6f 636b 735f 6665  ected {blocks_fe
-0000af20: 7463 6865 647d 2729 0a0a 2020 2020 2020  tched}')..      
-0000af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af40: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000af50: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-0000af60: 2027 626c 6f63 6b73 666e 6427 290a 0a20   'blocksfnd').. 
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af90: 2020 2063 6f6e 6669 726d 6174 696f 6e20     confirmation 
-0000afa0: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
-0000afb0: 6571 7565 7374 290a 0a20 2020 2020 2020  equest)..       
-0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afd0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000afe0: 636f 6e66 6972 6d61 7469 6f6e 203d 3d20  confirmation == 
-0000aff0: 2762 6c6f 636b 7363 6627 3a0a 2020 2020  'blockscf':.    
-0000b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b020: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-0000b030: 6170 705f 6c6f 672e 696e 666f 2827 496e  app_log.info('In
-0000b040: 626f 756e 643a 2043 6c69 656e 7420 636f  bound: Client co
-0000b050: 6e66 6972 6d65 6420 7468 6579 2077 616e  nfirmed they wan
-0000b060: 7420 746f 2073 796e 6320 6672 6f6d 2075  t to sync from u
-0000b070: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-0000b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b090: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-0000b0a0: 2873 656c 662e 7265 7175 6573 742c 2062  (self.request, b
-0000b0b0: 6c6f 636b 735f 6665 7463 6865 6429 0a0a  locks_fetched)..
-0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0e0: 2020 2020 656c 6966 2063 6f6e 6669 726d      elif confirm
-0000b0f0: 6174 696f 6e20 3d3d 2027 626c 6f63 6b73  ation == 'blocks
-0000b100: 726a 273a 0a20 2020 2020 2020 2020 2020  rj':.           
-0000b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b120: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-0000b130: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-0000b140: 2e69 6e66 6f28 2249 6e62 6f75 6e64 3a20  .info("Inbound: 
-0000b150: 436c 6965 6e74 2072 656a 6563 7465 6420  Client rejected 
-0000b160: 746f 2073 796e 6320 6672 6f6d 2075 7320  to sync from us 
-0000b170: 6265 6361 7573 6520 7765 2772 6520 646f  because we're do
-0000b180: 6e27 7420 6861 7665 2074 6865 206c 6174  n't have the lat
-0000b190: 6573 7420 626c 6f63 6b22 290a 0a20 2020  est block")..   
-0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1b0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0000b1c0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1e0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-0000b1f0: 6c6f 672e 7761 726e 696e 6728 6627 496e  log.warning(f'In
-0000b200: 626f 756e 643a 2053 796e 6320 6661 696c  bound: Sync fail
-0000b210: 6564 207b 657d 2729 0a0a 2020 2020 2020  ed {e}')..      
-0000b220: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
-0000b230: 6174 6120 3d3d 2027 6e6f 6e65 7762 6c6b  ata == 'nonewblk
-0000b240: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0000b250: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
-0000b260: 2e72 6571 7565 7374 2c20 2773 796e 6327  .request, 'sync'
-0000b270: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000b280: 2020 2065 6c69 6620 6461 7461 203d 3d20     elif data == 
-0000b290: 2762 6c6f 636b 6e66 273a 0a20 2020 2020  'blocknf':.     
-0000b2a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000b2b0: 6c6f 636b 5f68 6173 685f 6465 6c65 7465  lock_hash_delete
-0000b2c0: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-0000b2d0: 7265 7175 6573 7429 0a20 2020 2020 2020  request).       
-0000b2e0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0000b2f0: 7269 6e74 2070 6565 725f 6970 0a20 2020  rint peer_ip.   
-0000b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b310: 2069 6620 636f 6e73 656e 7375 735f 626c   if consensus_bl
-0000b320: 6f63 6b68 6569 6768 7420 3d3d 206e 6f64  ockheight == nod
-0000b330: 652e 7065 6572 732e 636f 6e73 656e 7375  e.peers.consensu
-0000b340: 735f 6d61 783a 0a20 2020 2020 2020 2020  s_max:.         
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000b360: 6c6f 636b 6e66 286e 6f64 652c 2062 6c6f  locknf(node, blo
-0000b370: 636b 5f68 6173 685f 6465 6c65 7465 2c20  ck_hash_delete, 
-0000b380: 7065 6572 5f69 702c 2064 625f 6861 6e64  peer_ip, db_hand
-0000b390: 6c65 725f 696e 7374 616e 6365 290a 2020  ler_instance).  
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acc0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0000acd0: 6c6f 672e 7761 726e 696e 6728 6627 496e  log.warning(f'In
+0000ace0: 626f 756e 643a 2057 6520 6861 7665 2068  bound: We have h
+0000acf0: 6967 6865 7220 287b 6e6f 6465 2e68 6464  igher ({node.hdd
+0000ad00: 5f62 6c6f 636b 7d29 2062 6c6f 636b 2068  _block}) block h
+0000ad10: 6569 6768 7420 7468 616e 207b 7065 6572  eight than {peer
+0000ad20: 5f69 707d 2028 7b72 6563 6569 7665 645f  _ip} ({received_
+0000ad30: 626c 6f63 6b5f 6865 6967 6874 7d29 2c20  block_height}), 
+0000ad40: 6861 7368 2077 696c 6c20 6265 2076 6572  hash will be ver
+0000ad50: 6966 6965 6427 290a 0a20 2020 2020 2020  ified')..       
+0000ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad70: 2020 2020 2064 6174 6120 3d20 7265 6365       data = rece
+0000ad80: 6976 6528 7365 6c66 2e72 6571 7565 7374  ive(self.request
+0000ad90: 2920 2023 2072 6563 6569 7665 2063 6c69  )  # receive cli
+0000ada0: 656e 7427 7320 6c61 7374 2062 6c6f 636b  ent's last block
+0000adb0: 5f68 6173 680a 2020 2020 2020 2020 2020  _hash.          
+0000adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000add0: 2020 2320 7365 6e64 2061 6c6c 206f 7572    # send all our
+0000ade0: 2066 6f6c 6c6f 7775 7020 6861 7368 6573   followup hashes
+0000adf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000ae10: 6461 7461 203d 3d20 272a 273a 0a20 2020  data == '*':.   
+0000ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae30: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+0000ae40: 6f6e 6e65 6374 696f 6e20 6c6f 7374 2c20  onnection lost, 
+0000ae50: 6e6f 206e 6565 6420 746f 2067 6f20 6f6e  no need to go on
+0000ae60: 2c20 7468 6174 2077 6173 2062 616e 6e69  , that was banni
+0000ae70: 6e67 2074 6865 206e 6f64 6520 6c69 6b65  ng the node like
+0000ae80: 2069 7420 666f 726b 6564 2e0a 2020 2020   it forked..    
+0000ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aea0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0000aeb0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+0000aec0: 7761 726e 696e 6728 6627 496e 626f 756e  warning(f'Inboun
+0000aed0: 643a 207b 7065 6572 5f69 707d 2064 726f  d: {peer_ip} dro
+0000aee0: 7070 6564 2063 6f6e 6e65 6374 696f 6e27  pped connection'
+0000aef0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af10: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+0000af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af30: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0000af40: 6170 705f 6c6f 672e 6465 6275 6728 6627  app_log.debug(f'
+0000af50: 496e 626f 756e 643a 2057 696c 6c20 7365  Inbound: Will se
+0000af60: 656b 2074 6865 2066 6f6c 6c6f 7769 6e67  ek the following
+0000af70: 2062 6c6f 636b 3a20 7b64 6174 617d 2729   block: {data}')
+0000af80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000af90: 2020 2020 2020 2020 2020 2020 2020 6462                db
+0000afa0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+0000afb0: 6520 3d20 6462 6861 6e64 6c65 722e 4462  e = dbhandler.Db
+0000afc0: 4861 6e64 6c65 7228 6e6f 6465 2e69 6e64  Handler(node.ind
+0000afd0: 6578 5f64 622c 206e 6f64 652e 6c65 6467  ex_db, node.ledg
+0000afe0: 6572 5f70 6174 682c 206e 6f64 652e 6879  er_path, node.hy
+0000aff0: 7065 725f 7061 7468 2c20 6e6f 6465 2e72  per_path, node.r
+0000b000: 616d 2c20 6e6f 6465 2e6c 6564 6765 725f  am, node.ledger_
+0000b010: 7261 6d5f 6669 6c65 2c20 6e6f 6465 2e6c  ram_file, node.l
+0000b020: 6f67 6765 722c 2074 7261 6365 5f64 625f  ogger, trace_db_
+0000b030: 6361 6c6c 733d 6e6f 6465 2e74 7261 6365  calls=node.trace
+0000b040: 5f64 625f 6361 6c6c 7329 0a20 2020 2020  _db_calls).     
+0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b060: 2020 2020 2020 2063 6c69 656e 745f 626c         client_bl
+0000b070: 6f63 6b20 3d20 6462 5f68 616e 646c 6572  ock = db_handler
+0000b080: 5f69 6e73 7461 6e63 652e 626c 6f63 6b5f  _instance.block_
+0000b090: 6865 6967 6874 5f66 726f 6d5f 6861 7368  height_from_hash
+0000b0a0: 2864 6174 6129 0a20 2020 2020 2020 2020  (data).         
+0000b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0c0: 2020 2069 6620 636c 6965 6e74 5f62 6c6f     if client_blo
+0000b0d0: 636b 2069 7320 4e6f 6e65 3a0a 2020 2020  ck is None:.    
+0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0f0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0000b100: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+0000b110: 7761 726e 696e 6728 6627 496e 626f 756e  warning(f'Inboun
+0000b120: 643a 2042 6c6f 636b 207b 6461 7461 5b3a  d: Block {data[:
+0000b130: 385d 7d20 6f66 207b 7065 6572 5f69 707d  8]} of {peer_ip}
+0000b140: 206e 6f74 2066 6f75 6e64 2729 0a20 2020   not found').   
+0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b160: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b170: 6e6f 6465 2e66 756c 6c5f 6c65 6467 6572  node.full_ledger
+0000b180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1a0: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+0000b1b0: 7265 7175 6573 742c 2027 626c 6f63 6b6e  request, 'blockn
+0000b1c0: 6627 2920 2023 2061 6e6e 6f75 6e63 6520  f')  # announce 
+0000b1d0: 626c 6f63 6b20 6861 7368 2077 6173 206e  block hash was n
+0000b1e0: 6f74 2066 6f75 6e64 0a20 2020 2020 2020  ot found.       
+0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b200: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
+0000b240: 7565 7374 2c20 2762 6c6f 636b 6e66 6862  uest, 'blocknfhb
+0000b250: 2729 2020 2320 616e 6e6f 756e 6365 2077  ')  # announce w
+0000b260: 6520 6172 6520 6f6e 2068 7970 6572 626c  e are on hyperbl
+0000b270: 6f63 6b73 0a20 2020 2020 2020 2020 2020  ocks.           
+0000b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b290: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+0000b2a0: 6571 7565 7374 2c20 6461 7461 290a 0a20  equest, data).. 
+0000b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b2d0: 6620 6e6f 6465 2e70 6565 7273 2e77 6172  f node.peers.war
+0000b2e0: 6e69 6e67 2873 656c 662e 7265 7175 6573  ning(self.reques
+0000b2f0: 742c 2070 6565 725f 6970 2c20 2746 6f72  t, peer_ip, 'For
+0000b300: 6b65 6427 2c20 3229 3a0a 2020 2020 2020  ked', 2):.      
+0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b320: 2020 2020 2020 2020 2020 2020 2020 6462                db
+0000b330: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+0000b340: 652e 636c 6f73 6528 290a 2020 2020 2020  e.close().      
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b360: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+0000b370: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+0000b380: 672e 7761 726e 696e 6728 6627 7b70 6565  g.warning(f'{pee
+0000b390: 725f 6970 7d20 6261 6e6e 6564 2729 0a20  r_ip} banned'). 
 0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 2020 2020 6966 206e 6f64 652e 7065        if node.pe
-0000b3c0: 6572 732e 7761 726e 696e 6728 7365 6c66  ers.warning(self
-0000b3d0: 2e72 6571 7565 7374 2c20 7065 6572 5f69  .request, peer_i
-0000b3e0: 702c 2027 526f 6c6c 6261 636b 272c 2032  p, 'Rollback', 2
-0000b3f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000b400: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000b410: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-0000b420: 6f67 2e69 6e66 6f28 6627 7b70 6565 725f  og.info(f'{peer_
-0000b430: 6970 7d20 6261 6e6e 6564 2729 0a20 2020  ip} banned').   
-0000b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b450: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-0000b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b470: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0000b480: 7070 5f6c 6f67 2e69 6e66 6f28 2749 6e62  pp_log.info('Inb
-0000b490: 6f75 6e64 3a20 4465 6c65 7469 6f6e 2063  ound: Deletion c
-0000b4a0: 6f6d 706c 6574 652c 2073 656e 6469 6e67  omplete, sending
-0000b4b0: 2073 796e 6320 7265 7175 6573 7427 290a   sync request').
-0000b4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b4d0: 2020 2020 2077 6869 6c65 206e 6f64 652e       while node.
-0000b4e0: 6462 5f6c 6f63 6b2e 6c6f 636b 6564 2829  db_lock.locked()
-0000b4f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b500: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-0000b510: 6c65 6570 286e 6f64 652e 7061 7573 6529  leep(node.pause)
-0000b520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b530: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-0000b540: 6571 7565 7374 2c20 2773 796e 6327 290a  equest, 'sync').
-0000b550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b560: 2065 6c69 6620 6461 7461 203d 3d20 2762   elif data == 'b
-0000b570: 6c6f 636b 6e66 6862 273a 2020 236e 6f64  locknfhb':  #nod
-0000b580: 6520 616e 6e6f 756e 6365 7320 6974 2773  e announces it's
-0000b590: 2072 756e 6e69 6e67 2068 7970 6572 626c   running hyperbl
-0000b5a0: 6f63 6b73 0a20 2020 2020 2020 2020 2020  ocks.           
-0000b5b0: 2020 2020 2020 2020 2062 6c6f 636b 5f68           block_h
-0000b5c0: 6173 685f 6465 6c65 7465 203d 2072 6563  ash_delete = rec
-0000b5d0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-0000b5e0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-0000b5f0: 2020 2020 2020 2023 2070 7269 6e74 2070         # print p
-0000b600: 6565 725f 6970 0a20 2020 2020 2020 2020  eer_ip.         
-0000b610: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-0000b620: 6e73 656e 7375 735f 626c 6f63 6b68 6569  nsensus_blockhei
-0000b630: 6768 7420 3d3d 206e 6f64 652e 7065 6572  ght == node.peer
-0000b640: 732e 636f 6e73 656e 7375 735f 6d61 783a  s.consensus_max:
-0000b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b660: 2020 2020 2020 2020 2062 6c6f 636b 6e66           blocknf
-0000b670: 286e 6f64 652c 2062 6c6f 636b 5f68 6173  (node, block_has
-0000b680: 685f 6465 6c65 7465 2c20 7065 6572 5f69  h_delete, peer_i
-0000b690: 702c 2064 625f 6861 6e64 6c65 725f 696e  p, db_handler_in
-0000b6a0: 7374 616e 6365 2c20 6879 7065 7262 6c6f  stance, hyperblo
-0000b6b0: 636b 733d 5472 7565 290a 2020 2020 2020  cks=True).      
-0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6d0: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
-0000b6e0: 7761 726e 696e 6728 7365 6c66 2e72 6571  warning(self.req
-0000b6f0: 7565 7374 2c20 7065 6572 5f69 702c 2027  uest, peer_ip, '
-0000b700: 526f 6c6c 6261 636b 272c 2032 293a 0a20  Rollback', 2):. 
-0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b720: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000b730: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-0000b740: 6e66 6f28 6627 7b70 6565 725f 6970 7d20  nfo(f'{peer_ip} 
-0000b750: 6261 6e6e 6564 2729 0a20 2020 2020 2020  banned').       
-0000b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b770: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-0000b780: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000b790: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-0000b7a0: 6f67 2e69 6e66 6f28 2749 6e62 6f75 6e64  og.info('Inbound
-0000b7b0: 3a20 4465 6c65 7469 6f6e 2063 6f6d 706c  : Deletion compl
-0000b7c0: 6574 652c 2073 656e 6469 6e67 2073 796e  ete, sending syn
-0000b7d0: 6320 7265 7175 6573 7427 290a 0a20 2020  c request')..   
+0000b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3c0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+0000b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b400: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0000b410: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+0000b420: 6465 6275 6728 6627 496e 626f 756e 643a  debug(f'Inbound:
+0000b430: 2043 6c69 656e 7420 6973 2061 7420 626c   Client is at bl
+0000b440: 6f63 6b20 7b63 6c69 656e 745f 626c 6f63  ock {client_bloc
+0000b450: 6b7d 2729 2020 2320 6e6f 7720 6368 6563  k}')  # now chec
+0000b460: 6b20 6966 2077 6520 6861 7665 2061 6e79  k if we have any
+0000b470: 206e 6577 6572 0a0a 2020 2020 2020 2020   newer..        
+0000b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b490: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+0000b4a0: 6864 645f 6861 7368 203d 3d20 6461 7461  hdd_hash == data
+0000b4b0: 206f 7220 6e6f 7420 6e6f 6465 2e65 6772   or not node.egr
+0000b4c0: 6573 733a 0a20 2020 2020 2020 2020 2020  ess:.           
+0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000b4f0: 6e6f 6465 2e65 6772 6573 733a 0a20 2020  node.egress:.   
+0000b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b520: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+0000b530: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+0000b540: 2866 2749 6e62 6f75 6e64 3a20 4567 7265  (f'Inbound: Egre
+0000b550: 7373 2064 6973 6162 6c65 6420 666f 7220  ss disabled for 
+0000b560: 7b70 6565 725f 6970 7d27 290a 2020 2020  {peer_ip}').    
+0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b590: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5b0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+0000b5c0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+0000b5d0: 672e 6465 6275 6728 6627 496e 626f 756e  g.debug(f'Inboun
+0000b5e0: 643a 2043 6c69 656e 7420 7b70 6565 725f  d: Client {peer_
+0000b5f0: 6970 7d20 6861 7320 7468 6520 6c61 7465  ip} has the late
+0000b600: 7374 2062 6c6f 636b 2729 0a0a 2020 2020  st block')..    
+0000b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b630: 7469 6d65 2e73 6c65 6570 2869 6e74 286e  time.sleep(int(n
+0000b640: 6f64 652e 7061 7573 6529 2920 2023 2072  ode.pause))  # r
+0000b650: 6564 7563 6520 4350 5520 7573 6167 650a  educe CPU usage.
+0000b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b680: 2020 2020 7365 6e64 2873 656c 662e 7265      send(self.re
+0000b690: 7175 6573 742c 2027 6e6f 6e65 7762 6c6b  quest, 'nonewblk
+0000b6a0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0000b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6c0: 2020 2020 656c 7365 3a0a 0a20 2020 2020      else:..     
+0000b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000b6f0: 6c6f 636b 735f 6665 7463 6865 6420 3d20  locks_fetched = 
+0000b700: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+0000b710: 6e63 652e 626c 6f63 6b73 796e 6328 636c  nce.blocksync(cl
+0000b720: 6965 6e74 5f62 6c6f 636b 290a 0a20 2020  ient_block)..   
+0000b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b750: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0000b760: 5f6c 6f67 2e64 6562 7567 2866 2749 6e62  _log.debug(f'Inb
+0000b770: 6f75 6e64 3a20 5365 6c65 6374 6564 207b  ound: Selected {
+0000b780: 626c 6f63 6b73 5f66 6574 6368 6564 7d27  blocks_fetched}'
+0000b790: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7b0: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
+0000b7c0: 2e72 6571 7565 7374 2c20 2762 6c6f 636b  .request, 'block
+0000b7d0: 7366 6e64 2729 0a0a 2020 2020 2020 2020  sfnd')..        
 0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7f0: 2077 6869 6c65 206e 6f64 652e 6462 5f6c   while node.db_l
-0000b800: 6f63 6b2e 6c6f 636b 6564 2829 3a0a 2020  ock.locked():.  
-0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b820: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
-0000b830: 286e 6f64 652e 7061 7573 6529 0a20 2020  (node.pause).   
-0000b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b850: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
-0000b860: 7374 2c20 2773 796e 6327 290a 0a20 2020  st, 'sync')..   
-0000b870: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0000b880: 6620 6461 7461 203d 3d20 2762 6c6f 636b  f data == 'block
-0000b890: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0000b8a0: 2020 2020 2020 2023 2069 6620 2870 6565         # if (pee
-0000b8b0: 725f 6970 2069 6e20 616c 6c6f 7765 6420  r_ip in allowed 
-0000b8c0: 6f72 2022 616e 7922 2069 6e20 616c 6c6f  or "any" in allo
-0000b8d0: 7765 6429 3a20 2023 2066 726f 6d20 6d69  wed):  # from mi
-0000b8e0: 6e65 720a 2020 2020 2020 2020 2020 2020  ner.            
-0000b8f0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-0000b900: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
-0000b910: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
-0000b920: 2020 2320 6672 6f6d 206d 696e 6572 0a20    # from miner. 
+0000b7f0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0000b800: 6972 6d61 7469 6f6e 203d 2072 6563 6569  irmation = recei
+0000b810: 7665 2873 656c 662e 7265 7175 6573 7429  ve(self.request)
+0000b820: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b840: 2020 2020 2020 6966 2063 6f6e 6669 726d        if confirm
+0000b850: 6174 696f 6e20 3d3d 2027 626c 6f63 6b73  ation == 'blocks
+0000b860: 6366 273a 0a20 2020 2020 2020 2020 2020  cf':.           
+0000b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b880: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000b890: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000b8a0: 2e64 6562 7567 2827 496e 626f 756e 643a  .debug('Inbound:
+0000b8b0: 2043 6c69 656e 7420 636f 6e66 6972 6d65   Client confirme
+0000b8c0: 6420 7468 6579 2077 616e 7420 746f 2073  d they want to s
+0000b8d0: 796e 6320 6672 6f6d 2075 7327 290a 2020  ync from us').  
+0000b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b900: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+0000b910: 7265 7175 6573 742c 2062 6c6f 636b 735f  request, blocks_
+0000b920: 6665 7463 6865 6429 0a0a 2020 2020 2020  fetched)..      
 0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b940: 2020 2020 2020 2023 2054 4f44 4f3a 2072         # TODO: r
-0000b950: 6967 6874 7320 6d61 6e61 6765 6d65 6e74  ights management
-0000b960: 2063 6f75 6c64 2062 6520 646f 6e65 206f   could be done o
-0000b970: 6e65 206c 6576 656c 2068 6967 6865 7220  ne level higher 
-0000b980: 696e 7374 6561 6420 6f66 2072 6570 6561  instead of repea
-0000b990: 7469 6e67 2074 6865 2073 616d 6520 6368  ting the same ch
-0000b9a0: 6563 6b20 6576 6572 7977 6865 7265 0a20  eck everywhere. 
-0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9c0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0000b9d0: 6572 2e61 7070 5f6c 6f67 2e69 6e66 6f28  er.app_log.info(
-0000b9e0: 6627 496e 626f 756e 643a 2052 6563 6569  f'Inbound: Recei
-0000b9f0: 7665 6420 6120 626c 6f63 6b20 6672 6f6d  ved a block from
-0000ba00: 206d 696e 6572 207b 7065 6572 5f69 707d   miner {peer_ip}
-0000ba10: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0000ba20: 2020 2020 2020 2020 2020 2023 2072 6563             # rec
-0000ba30: 6569 7665 2062 6c6f 636b 0a20 2020 2020  eive block.     
+0000b940: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000b950: 6966 2063 6f6e 6669 726d 6174 696f 6e20  if confirmation 
+0000b960: 3d3d 2027 626c 6f63 6b73 726a 273a 0a20  == 'blocksrj':. 
+0000b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b990: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+0000b9a0: 6572 2e61 7070 5f6c 6f67 2e64 6562 7567  er.app_log.debug
+0000b9b0: 2822 496e 626f 756e 643a 2043 6c69 656e  ("Inbound: Clien
+0000b9c0: 7420 7265 6a65 6374 6564 2074 6f20 7379  t rejected to sy
+0000b9d0: 6e63 2066 726f 6d20 7573 2062 6563 6175  nc from us becau
+0000b9e0: 7365 2077 6527 7265 2064 6f6e 2774 2068  se we're don't h
+0000b9f0: 6176 6520 7468 6520 6c61 7465 7374 2062  ave the latest b
+0000ba00: 6c6f 636b 2229 0a20 2020 2020 2020 2020  lock").         
+0000ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba20: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+0000ba30: 7374 616e 6365 2e63 6c6f 7365 2829 0a0a  stance.close()..
 0000ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba50: 2020 2073 6567 6d65 6e74 7320 3d20 7265     segments = re
-0000ba60: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
-0000ba70: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0000ba80: 2020 2020 2020 2020 2020 2020 2320 6e6f              # no
-0000ba90: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-0000baa0: 672e 696e 666f 2822 496e 626f 756e 643a  g.info("Inbound:
-0000bab0: 2043 6f6d 6269 6e65 6420 6d69 6e65 6420   Combined mined 
-0000bac0: 7365 676d 656e 7473 3a20 2220 2b20 7365  segments: " + se
-0000bad0: 676d 656e 7473 290a 2020 2020 2020 2020  gments).        
-0000bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000baf0: 6d69 6e65 6420 3d20 7b27 7469 6d65 7374  mined = {'timest
-0000bb00: 616d 7027 3a20 7469 6d65 2e74 696d 6528  amp': time.time(
-0000bb10: 292c 2027 6c61 7374 273a 206e 6f64 652e  ), 'last': node.
-0000bb20: 6c61 7374 5f62 6c6f 636b 2c20 2769 7027  last_block, 'ip'
-0000bb30: 3a20 7065 6572 5f69 702c 2027 6d69 6e65  : peer_ip, 'mine
-0000bb40: 7227 3a20 2727 2c20 2772 6573 756c 7427  r': '', 'result'
-0000bb50: 3a20 4661 6c73 652c 2027 7265 6173 6f6e  : False, 'reason
-0000bb60: 273a 2027 277d 0a20 2020 2020 2020 2020  ': ''}.         
-0000bb70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000bb80: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bba0: 6d69 6e65 645b 276d 696e 6572 275d 203d  mined['miner'] =
-0000bbb0: 2073 6567 6d65 6e74 735b 305d 5b2d 315d   segments[0][-1]
-0000bbc0: 5b31 5d20 2023 2073 656e 6465 722c 2074  [1]  # sender, t
-0000bbd0: 6f20 6265 2063 6f6e 7369 7374 656e 7420  o be consistent 
-0000bbe0: 7769 7468 2062 6c6f 636b 2065 7665 6e74  with block event
-0000bbf0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000bc00: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000bc10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bc20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000bc30: 426c 6f63 6b20 6973 2073 656e 7420 6279  Block is sent by
-0000bc40: 206d 696e 6572 732f 706f 6f6c 732c 2077   miners/pools, w
-0000bc50: 6520 6361 6e20 6472 6f70 2074 6865 2063  e can drop the c
-0000bc60: 6f6e 6e65 6374 696f 6e0a 2020 2020 2020  onnection.      
-0000bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc80: 2020 2020 2020 2320 4966 2074 6865 7265        # If there
-0000bc90: 2069 7320 6120 7265 6173 6f6e 206e 6f74   is a reason not
-0000bca0: 2074 6f2c 2075 7365 2022 636f 6e74 696e   to, use "contin
-0000bcb0: 7565 2220 6865 7265 2061 6e64 2062 656c  ue" here and bel
-0000bcc0: 6f77 2069 6e73 7465 6164 206f 6620 7265  ow instead of re
-0000bcd0: 7475 726e 732e 0a20 2020 2020 2020 2020  turns..         
-0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcf0: 2020 2072 6574 7572 6e20 2023 206d 6973     return  # mis
-0000bd00: 7369 6e67 2069 6e66 6f2c 2062 7965 0a20  sing info, bye. 
-0000bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd20: 2020 2020 2020 2069 6620 6e6f 6465 2e69         if node.i
-0000bd30: 735f 6d61 696e 6e65 743a 0a20 2020 2020  s_mainnet:.     
+0000ba50: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000ba60: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0000ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba80: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000ba90: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
+0000baa0: 2749 6e62 6f75 6e64 3a20 5379 6e63 2066  'Inbound: Sync f
+0000bab0: 6169 6c65 6420 7b65 7d27 290a 0a20 2020  ailed {e}')..   
+0000bac0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0000bad0: 6620 6461 7461 203d 3d20 276e 6f6e 6577  f data == 'nonew
+0000bae0: 626c 6b27 3a0a 2020 2020 2020 2020 2020  blk':.          
+0000baf0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
+0000bb00: 656c 662e 7265 7175 6573 742c 2027 7379  elf.request, 'sy
+0000bb10: 6e63 2729 0a0a 2020 2020 2020 2020 2020  nc')..          
+0000bb20: 2020 2020 2020 656c 6966 2064 6174 6120        elif data 
+0000bb30: 3d3d 2027 626c 6f63 6b6e 6627 3a0a 2020  == 'blocknf':.  
+0000bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb50: 2020 626c 6f63 6b5f 6861 7368 5f64 656c    block_hash_del
+0000bb60: 6574 6520 3d20 7265 6365 6976 6528 7365  ete = receive(se
+0000bb70: 6c66 2e72 6571 7565 7374 290a 2020 2020  lf.request).    
+0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb90: 2320 7072 696e 7420 7065 6572 5f69 700a  # print peer_ip.
+0000bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbb0: 2020 2020 6966 2063 6f6e 7365 6e73 7573      if consensus
+0000bbc0: 5f62 6c6f 636b 6865 6967 6874 203d 3d20  _blockheight == 
+0000bbd0: 6e6f 6465 2e70 6565 7273 2e63 6f6e 7365  node.peers.conse
+0000bbe0: 6e73 7573 5f6d 6178 3a0a 2020 2020 2020  nsus_max:.      
+0000bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc00: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+0000bc10: 7461 6e63 6520 3d20 6462 6861 6e64 6c65  tance = dbhandle
+0000bc20: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+0000bc30: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+0000bc40: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+0000bc50: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+0000bc60: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+0000bc70: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+0000bc80: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+0000bc90: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+0000bca0: 7261 6365 5f64 625f 6361 6c6c 7329 0a20  race_db_calls). 
+0000bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcc0: 2020 2020 2020 2062 6c6f 636b 6e66 286e         blocknf(n
+0000bcd0: 6f64 652c 2062 6c6f 636b 5f68 6173 685f  ode, block_hash_
+0000bce0: 6465 6c65 7465 2c20 7065 6572 5f69 702c  delete, peer_ip,
+0000bcf0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000bd00: 616e 6365 290a 2020 2020 2020 2020 2020  ance).          
+0000bd10: 2020 2020 2020 2020 2020 2020 2020 6462                db
+0000bd20: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+0000bd30: 652e 636c 6f73 6528 290a 2020 2020 2020  e.close().      
 0000bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd50: 2020 2020 2020 2069 6620 6c65 6e28 6e6f         if len(no
-0000bd60: 6465 2e70 6565 7273 2e63 6f6e 6e65 6374  de.peers.connect
-0000bd70: 696f 6e5f 706f 6f6c 2920 3c20 3520 616e  ion_pool) < 5 an
-0000bd80: 6420 6e6f 7420 6e6f 6465 2e70 6565 7273  d not node.peers
-0000bd90: 2e69 735f 7768 6974 656c 6973 7465 6428  .is_whitelisted(
-0000bda0: 7065 6572 5f69 7029 3a0a 2020 2020 2020  peer_ip):.      
-0000bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bdc0: 2020 2020 2020 2020 2020 7265 6173 6f6e            reason
-0000bdd0: 203d 2027 496e 626f 756e 643a 204d 696e   = 'Inbound: Min
-0000bde0: 6564 2062 6c6f 636b 2069 676e 6f72 6564  ed block ignored
-0000bdf0: 2c20 696e 7375 6666 6963 6965 6e74 2063  , insufficient c
-0000be00: 6f6e 6e65 6374 696f 6e73 2074 6f20 7468  onnections to th
-0000be10: 6520 6e65 7477 6f72 6b27 0a20 2020 2020  e network'.     
-0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be30: 2020 2020 2020 2020 2020 206d 696e 6564             mined
-0000be40: 5b27 7265 6173 6f6e 275d 203d 2072 6561  ['reason'] = rea
-0000be50: 736f 6e0a 2020 2020 2020 2020 2020 2020  son.            
-0000be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be70: 2020 2020 6e6f 6465 2e70 6c75 6769 6e5f      node.plugin_
-0000be80: 6d61 6e61 6765 722e 6578 6563 7574 655f  manager.execute_
-0000be90: 6163 7469 6f6e 5f68 6f6f 6b28 276d 696e  action_hook('min
-0000bea0: 6564 272c 206d 696e 6564 290a 2020 2020  ed', mined).    
-0000beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bec0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0000bed0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-0000bee0: 696e 666f 2872 6561 736f 6e29 0a20 2020  info(reason).   
-0000bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf00: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000bf10: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-0000bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf30: 656c 6966 206e 6f64 652e 6462 5f6c 6f63  elif node.db_loc
-0000bf40: 6b2e 6c6f 636b 6564 2829 3a0a 2020 2020  k.locked():.    
-0000bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf60: 2020 2020 2020 2020 2020 2020 7265 6173              reas
-0000bf70: 6f6e 203d 2027 496e 626f 756e 643a 2042  on = 'Inbound: B
-0000bf80: 6c6f 636b 2066 726f 6d20 6d69 6e65 7220  lock from miner 
-0000bf90: 736b 6970 7065 6420 6265 6361 7573 6520  skipped because 
-0000bfa0: 7765 2061 7265 2064 6967 6573 7469 6e67  we are digesting
-0000bfb0: 2061 6c72 6561 6479 270a 2020 2020 2020   already'.      
-0000bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfd0: 2020 2020 2020 2020 2020 6d69 6e65 645b            mined[
-0000bfe0: 2772 6561 736f 6e27 5d20 3d20 7265 6173  'reason'] = reas
-0000bff0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-0000c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c010: 2020 206e 6f64 652e 706c 7567 696e 5f6d     node.plugin_m
-0000c020: 616e 6167 6572 2e65 7865 6375 7465 5f61  anager.execute_a
-0000c030: 6374 696f 6e5f 686f 6f6b 2827 6d69 6e65  ction_hook('mine
-0000c040: 6427 2c20 6d69 6e65 6429 0a20 2020 2020  d', mined).     
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000c070: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-0000c080: 6172 6e69 6e67 2872 6561 736f 6e29 0a20  arning(reason). 
-0000c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c0b0: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0d0: 2020 656c 6966 206e 6f64 652e 6c61 7374    elif node.last
-0000c0e0: 5f62 6c6f 636b 203e 3d20 6e6f 6465 2e70  _block >= node.p
-0000c0f0: 6565 7273 2e63 6f6e 7365 6e73 7573 5f6d  eers.consensus_m
-0000c100: 6178 202d 2033 3a0a 2020 2020 2020 2020  ax - 3:.        
-0000c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c120: 2020 2020 2020 2020 6d69 6e65 645b 2772          mined['r
-0000c130: 6573 756c 7427 5d20 3d20 5472 7565 0a20  esult'] = True. 
-0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c150: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000c160: 6f64 652e 706c 7567 696e 5f6d 616e 6167  ode.plugin_manag
-0000c170: 6572 2e65 7865 6375 7465 5f61 6374 696f  er.execute_actio
-0000c180: 6e5f 686f 6f6b 2827 6d69 6e65 6427 2c20  n_hook('mined', 
-0000c190: 6d69 6e65 6429 0a20 2020 2020 2020 2020  mined).         
-0000c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1b0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0000c1c0: 6572 2e61 7070 5f6c 6f67 2e69 6e66 6f28  er.app_log.info(
-0000c1d0: 2749 6e62 6f75 6e64 3a20 5072 6f63 6573  'Inbound: Proces
-0000c1e0: 7369 6e67 2062 6c6f 636b 2066 726f 6d20  sing block from 
-0000c1f0: 6d69 6e65 7227 290a 2020 2020 2020 2020  miner').        
+0000bd50: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
+0000bd60: 7761 726e 696e 6728 7365 6c66 2e72 6571  warning(self.req
+0000bd70: 7565 7374 2c20 7065 6572 5f69 702c 2027  uest, peer_ip, '
+0000bd80: 526f 6c6c 6261 636b 272c 2032 293a 0a20  Rollback', 2):. 
+0000bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bda0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0000bdb0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0000bdc0: 6172 6e69 6e67 2866 277b 7065 6572 5f69  arning(f'{peer_i
+0000bdd0: 707d 2062 616e 6e65 6427 290a 2020 2020  p} banned').    
+0000bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdf0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be10: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+0000be20: 705f 6c6f 672e 6465 6275 6728 2749 6e62  p_log.debug('Inb
+0000be30: 6f75 6e64 3a20 4465 6c65 7469 6f6e 2063  ound: Deletion c
+0000be40: 6f6d 706c 6574 652c 2073 656e 6469 6e67  omplete, sending
+0000be50: 2073 796e 6320 7265 7175 6573 7427 290a   sync request').
+0000be60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000be70: 2020 2020 2077 6869 6c65 206e 6f64 652e       while node.
+0000be80: 6462 5f6c 6f63 6b2e 6c6f 636b 6564 2829  db_lock.locked()
+0000be90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bea0: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
+0000beb0: 6c65 6570 286e 6f64 652e 7061 7573 6529  leep(node.pause)
+0000bec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bed0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+0000bee0: 6571 7565 7374 2c20 2773 796e 6327 290a  equest, 'sync').
+0000bef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bf00: 2065 6c69 6620 6461 7461 203d 3d20 2762   elif data == 'b
+0000bf10: 6c6f 636b 6e66 6862 273a 2020 236e 6f64  locknfhb':  #nod
+0000bf20: 6520 616e 6e6f 756e 6365 7320 6974 2773  e announces it's
+0000bf30: 2072 756e 6e69 6e67 2068 7970 6572 626c   running hyperbl
+0000bf40: 6f63 6b73 0a20 2020 2020 2020 2020 2020  ocks.           
+0000bf50: 2020 2020 2020 2020 2062 6c6f 636b 5f68           block_h
+0000bf60: 6173 685f 6465 6c65 7465 203d 2072 6563  ash_delete = rec
+0000bf70: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
+0000bf80: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+0000bf90: 2020 2020 2020 2023 2070 7269 6e74 2070         # print p
+0000bfa0: 6565 725f 6970 0a20 2020 2020 2020 2020  eer_ip.         
+0000bfb0: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+0000bfc0: 6e73 656e 7375 735f 626c 6f63 6b68 6569  nsensus_blockhei
+0000bfd0: 6768 7420 3d3d 206e 6f64 652e 7065 6572  ght == node.peer
+0000bfe0: 732e 636f 6e73 656e 7375 735f 6d61 783a  s.consensus_max:
+0000bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c000: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+0000c010: 6c65 725f 696e 7374 616e 6365 203d 2064  ler_instance = d
+0000c020: 6268 616e 646c 6572 2e44 6248 616e 646c  bhandler.DbHandl
+0000c030: 6572 286e 6f64 652e 696e 6465 785f 6462  er(node.index_db
+0000c040: 2c20 6e6f 6465 2e6c 6564 6765 725f 7061  , node.ledger_pa
+0000c050: 7468 2c20 6e6f 6465 2e68 7970 6572 5f70  th, node.hyper_p
+0000c060: 6174 682c 206e 6f64 652e 7261 6d2c 206e  ath, node.ram, n
+0000c070: 6f64 652e 6c65 6467 6572 5f72 616d 5f66  ode.ledger_ram_f
+0000c080: 696c 652c 206e 6f64 652e 6c6f 6767 6572  ile, node.logger
+0000c090: 2c20 7472 6163 655f 6462 5f63 616c 6c73  , trace_db_calls
+0000c0a0: 3d6e 6f64 652e 7472 6163 655f 6462 5f63  =node.trace_db_c
+0000c0b0: 616c 6c73 290a 2020 2020 2020 2020 2020  alls).          
+0000c0c0: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+0000c0d0: 6f63 6b6e 6628 6e6f 6465 2c20 626c 6f63  ocknf(node, bloc
+0000c0e0: 6b5f 6861 7368 5f64 656c 6574 652c 2070  k_hash_delete, p
+0000c0f0: 6565 725f 6970 2c20 6462 5f68 616e 646c  eer_ip, db_handl
+0000c100: 6572 5f69 6e73 7461 6e63 652c 2068 7970  er_instance, hyp
+0000c110: 6572 626c 6f63 6b73 3d54 7275 6529 0a20  erblocks=True). 
+0000c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c130: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+0000c140: 725f 696e 7374 616e 6365 2e63 6c6f 7365  r_instance.close
+0000c150: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000c160: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000c170: 6465 2e70 6565 7273 2e77 6172 6e69 6e67  de.peers.warning
+0000c180: 2873 656c 662e 7265 7175 6573 742c 2070  (self.request, p
+0000c190: 6565 725f 6970 2c20 2752 6f6c 6c62 6163  eer_ip, 'Rollbac
+0000c1a0: 6b27 2c20 3229 3a0a 2020 2020 2020 2020  k', 2):.        
+0000c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1c0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0000c1d0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+0000c1e0: 6627 7b70 6565 725f 6970 7d20 6261 6e6e  f'{peer_ip} bann
+0000c1f0: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
 0000c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c210: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c240: 2064 6967 6573 745f 626c 6f63 6b28 6e6f   digest_block(no
-0000c250: 6465 2c20 7365 676d 656e 7473 2c20 7365  de, segments, se
-0000c260: 6c66 2e72 6571 7565 7374 2c20 7065 6572  lf.request, peer
-0000c270: 5f69 702c 2064 625f 6861 6e64 6c65 725f  _ip, db_handler_
-0000c280: 696e 7374 616e 6365 290a 2020 2020 2020  instance).      
-0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2a0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000c2b0: 2056 616c 7565 4572 726f 7220 6173 2065   ValueError as e
-0000c2c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2e0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0000c2f0: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
-0000c300: 6728 2749 6e62 6f75 6e64 3a20 626c 6f63  g('Inbound: bloc
-0000c310: 6b20 7b7d 272e 666f 726d 6174 2873 7472  k {}'.format(str
-0000c320: 2865 2929 290a 2020 2020 2020 2020 2020  (e))).          
+0000c210: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+0000c220: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0000c230: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e64  logger.app_log.d
+0000c240: 6562 7567 2827 496e 626f 756e 643a 2044  ebug('Inbound: D
+0000c250: 656c 6574 696f 6e20 636f 6d70 6c65 7465  eletion complete
+0000c260: 2c20 7365 6e64 696e 6720 7379 6e63 2072  , sending sync r
+0000c270: 6571 7565 7374 2729 0a0a 2020 2020 2020  equest')..      
+0000c280: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+0000c290: 696c 6520 6e6f 6465 2e64 625f 6c6f 636b  ile node.db_lock
+0000c2a0: 2e6c 6f63 6b65 6428 293a 0a20 2020 2020  .locked():.     
+0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2c0: 2020 2074 696d 652e 736c 6565 7028 6e6f     time.sleep(no
+0000c2d0: 6465 2e70 6175 7365 290a 2020 2020 2020  de.pause).      
+0000c2e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000c2f0: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+0000c300: 2027 7379 6e63 2729 0a0a 2020 2020 2020   'sync')..      
+0000c310: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
+0000c320: 6174 6120 3d3d 2027 626c 6f63 6b27 3a0a  ata == 'block':.
 0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c370: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0000c380: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0000c3b0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-0000c3c0: 6572 726f 7228 2749 6e62 6f75 6e64 3a20  error('Inbound: 
-0000c3d0: 5072 6f63 6573 7369 6e67 2062 6c6f 636b  Processing block
-0000c3e0: 2066 726f 6d20 6d69 6e65 7220 7b7d 272e   from miner {}'.
-0000c3f0: 666f 726d 6174 2865 2929 0a20 2020 2020  format(e)).     
-0000c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c410: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c420: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c440: 2020 2020 2020 2320 5468 6973 206e 6577        # This new
-0000c450: 2062 6c6f 636b 206d 6179 2063 6861 6e67   block may chang
-0000c460: 6520 7468 6520 696e 7428 6469 6666 292e  e the int(diff).
-0000c470: 2054 7269 6767 6572 2074 6865 2068 6f6f   Trigger the hoo
-0000c480: 6b20 7768 6574 6865 7220 6974 2063 6861  k whether it cha
-0000c490: 6e67 6564 206f 7220 6e6f 742e 0a20 2020  nged or not..   
-0000c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4b0: 2020 2020 2020 2020 2020 2020 2023 6e6f               #no
-0000c4c0: 6465 2e64 6966 6669 6375 6c74 7920 3d20  de.difficulty = 
-0000c4d0: 6469 6666 6963 756c 7479 286e 6f64 652c  difficulty(node,
-0000c4e0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
-0000c4f0: 616e 6365 290a 2020 2020 2020 2020 2020  ance).          
-0000c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c510: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c530: 2020 2020 2020 2020 7265 6173 6f6e 203d          reason =
-0000c540: 2066 2749 6e62 6f75 6e64 3a20 4d69 6e65   f'Inbound: Mine
-0000c550: 6420 626c 6f63 6b20 7761 7320 6f72 7068  d block was orph
-0000c560: 616e 6564 2062 6563 6175 7365 206e 6f64  aned because nod
-0000c570: 6520 7761 7320 6e6f 7420 7379 6e63 6564  e was not synced
-0000c580: 2c20 2720 5c0a 2020 2020 2020 2020 2020  , ' \.          
-0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000c5b0: 2777 6520 6172 6520 6174 2062 6c6f 636b  'we are at block
-0000c5c0: 207b 6e6f 6465 2e6c 6173 745f 626c 6f63   {node.last_bloc
-0000c5d0: 6b7d 2c20 2720 5c0a 2020 2020 2020 2020  k}, ' \.        
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c600: 2066 2773 686f 756c 6420 6265 2061 7420   f'should be at 
-0000c610: 6c65 6173 7420 7b6e 6f64 652e 7065 6572  least {node.peer
-0000c620: 732e 636f 6e73 656e 7375 735f 6d61 7820  s.consensus_max 
-0000c630: 2d20 337d 270a 2020 2020 2020 2020 2020  - 3}'.          
-0000c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c650: 2020 2020 2020 6d69 6e65 645b 2772 6561        mined['rea
-0000c660: 736f 6e27 5d20 3d20 7265 6173 6f6e 0a20  son'] = reason. 
-0000c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c680: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000c690: 6f64 652e 706c 7567 696e 5f6d 616e 6167  ode.plugin_manag
-0000c6a0: 6572 2e65 7865 6375 7465 5f61 6374 696f  er.execute_actio
-0000c6b0: 6e5f 686f 6f6b 2827 6d69 6e65 6427 2c20  n_hook('mined', 
-0000c6c0: 6d69 6e65 6429 0a20 2020 2020 2020 2020  mined).         
-0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6e0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0000c6f0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-0000c700: 6e67 2872 6561 736f 6e29 0a20 2020 2020  ng(reason).     
+0000c340: 2020 2020 2320 6966 2028 7065 6572 5f69      # if (peer_i
+0000c350: 7020 696e 2061 6c6c 6f77 6564 206f 7220  p in allowed or 
+0000c360: 2261 6e79 2220 696e 2061 6c6c 6f77 6564  "any" in allowed
+0000c370: 293a 2020 2320 6672 6f6d 206d 696e 6572  ):  # from miner
+0000c380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c390: 2020 2020 2069 6620 6e6f 6465 2e70 6565       if node.pee
+0000c3a0: 7273 2e69 735f 616c 6c6f 7765 6428 7065  rs.is_allowed(pe
+0000c3b0: 6572 5f69 702c 2064 6174 6129 3a20 2023  er_ip, data):  #
+0000c3c0: 2066 726f 6d20 6d69 6e65 720a 2020 2020   from miner.    
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3e0: 2020 2020 2320 544f 444f 3a20 7269 6768      # TODO: righ
+0000c3f0: 7473 206d 616e 6167 656d 656e 7420 636f  ts management co
+0000c400: 756c 6420 6265 2064 6f6e 6520 6f6e 6520  uld be done one 
+0000c410: 6c65 7665 6c20 6869 6768 6572 2069 6e73  level higher ins
+0000c420: 7465 6164 206f 6620 7265 7065 6174 696e  tead of repeatin
+0000c430: 6720 7468 6520 7361 6d65 2063 6865 636b  g the same check
+0000c440: 2065 7665 7279 7768 6572 650a 2020 2020   everywhere.    
+0000c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c460: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0000c470: 6170 705f 6c6f 672e 6465 6275 6728 6627  app_log.debug(f'
+0000c480: 496e 626f 756e 643a 2052 6563 6569 7665  Inbound: Receive
+0000c490: 6420 6120 626c 6f63 6b20 6672 6f6d 206d  d a block from m
+0000c4a0: 696e 6572 207b 7065 6572 5f69 707d 2729  iner {peer_ip}')
+0000c4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c4c0: 2020 2020 2020 2020 2023 2072 6563 6569           # recei
+0000c4d0: 7665 2062 6c6f 636b 0a20 2020 2020 2020  ve block.       
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4f0: 2073 6567 6d65 6e74 7320 3d20 7265 6365   segments = rece
+0000c500: 6976 6528 7365 6c66 2e72 6571 7565 7374  ive(self.request
+0000c510: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c520: 2020 2020 2020 2020 2020 2320 6e6f 6465            # node
+0000c530: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+0000c540: 6465 6275 6728 2249 6e62 6f75 6e64 3a20  debug("Inbound: 
+0000c550: 436f 6d62 696e 6564 206d 696e 6564 2073  Combined mined s
+0000c560: 6567 6d65 6e74 733a 2022 202b 2073 6567  egments: " + seg
+0000c570: 6d65 6e74 7329 0a20 2020 2020 2020 2020  ments).         
+0000c580: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000c590: 696e 6564 203d 207b 2774 696d 6573 7461  ined = {'timesta
+0000c5a0: 6d70 273a 2074 696d 652e 7469 6d65 2829  mp': time.time()
+0000c5b0: 2c20 276c 6173 7427 3a20 6e6f 6465 2e6c  , 'last': node.l
+0000c5c0: 6173 745f 626c 6f63 6b2c 2027 6970 273a  ast_block, 'ip':
+0000c5d0: 2070 6565 725f 6970 2c20 276d 696e 6572   peer_ip, 'miner
+0000c5e0: 273a 2027 272c 2027 7265 7375 6c74 273a  ': '', 'result':
+0000c5f0: 2046 616c 7365 2c20 2772 6561 736f 6e27   False, 'reason'
+0000c600: 3a20 2727 7d0a 2020 2020 2020 2020 2020  : ''}.          
+0000c610: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000c620: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000c630: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000c640: 696e 6564 5b27 6d69 6e65 7227 5d20 3d20  ined['miner'] = 
+0000c650: 7365 676d 656e 7473 5b30 5d5b 2d31 5d5b  segments[0][-1][
+0000c660: 315d 2020 2320 7365 6e64 6572 2c20 746f  1]  # sender, to
+0000c670: 2062 6520 636f 6e73 6973 7465 6e74 2077   be consistent w
+0000c680: 6974 6820 626c 6f63 6b20 6576 656e 742e  ith block event.
+0000c690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c6a0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
+0000c6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c6c0: 2020 2020 2020 2020 2020 2020 2023 2042               # B
+0000c6d0: 6c6f 636b 2069 7320 7365 6e74 2062 7920  lock is sent by 
+0000c6e0: 6d69 6e65 7273 2f70 6f6f 6c73 2c20 7765  miners/pools, we
+0000c6f0: 2063 616e 2064 726f 7020 7468 6520 636f   can drop the co
+0000c700: 6e6e 6563 7469 6f6e 0a20 2020 2020 2020  nnection.       
 0000c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c720: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c740: 2020 2020 2023 204e 6f74 206d 6169 6e6e       # Not mainn
-0000c750: 6574 0a20 2020 2020 2020 2020 2020 2020  et.             
-0000c760: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000c770: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000c720: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
+0000c730: 6973 2061 2072 6561 736f 6e20 6e6f 7420  is a reason not 
+0000c740: 746f 2c20 7573 6520 2263 6f6e 7469 6e75  to, use "continu
+0000c750: 6522 2068 6572 6520 616e 6420 6265 6c6f  e" here and belo
+0000c760: 7720 696e 7374 6561 6420 6f66 2072 6574  w instead of ret
+0000c770: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
 0000c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c790: 2020 2020 6469 6765 7374 5f62 6c6f 636b      digest_block
-0000c7a0: 286e 6f64 652c 2073 6567 6d65 6e74 732c  (node, segments,
-0000c7b0: 2073 656c 662e 7265 7175 6573 742c 2070   self.request, p
-0000c7c0: 6565 725f 6970 2c20 6462 5f68 616e 646c  eer_ip, db_handl
-0000c7d0: 6572 5f69 6e73 7461 6e63 6529 0a20 2020  er_instance).   
-0000c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7f0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000c800: 5661 6c75 6545 7272 6f72 2061 7320 653a  ValueError as e:
-0000c810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c790: 2020 2320 6462 5f68 616e 646c 6572 5f69    # db_handler_i
+0000c7a0: 6e73 7461 6e63 652e 636c 6f73 6528 290a  nstance.close().
+0000c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000c7d0: 726e 2020 2320 6d69 7373 696e 6720 696e  rn  # missing in
+0000c7e0: 666f 2c20 6279 650a 2020 2020 2020 2020  fo, bye.        
+0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c800: 6966 206e 6f64 652e 6973 5f6d 6169 6e6e  if node.is_mainn
+0000c810: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
 0000c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c830: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-0000c840: 5f6c 6f67 2e77 6172 6e69 6e67 2827 496e  _log.warning('In
-0000c850: 626f 756e 643a 2062 6c6f 636b 207b 7d27  bound: block {}'
-0000c860: 2e66 6f72 6d61 7428 7374 7228 6529 2929  .format(str(e)))
-0000c870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c890: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0000c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8b0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0000c8c0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8e0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000c8f0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e65  logger.app_log.e
-0000c900: 7272 6f72 2827 496e 626f 756e 643a 2050  rror('Inbound: P
-0000c910: 726f 6365 7373 696e 6720 626c 6f63 6b20  rocessing block 
-0000c920: 6672 6f6d 206d 696e 6572 207b 7d27 2e66  from miner {}'.f
-0000c930: 6f72 6d61 7428 6529 290a 2020 2020 2020  ormat(e)).      
-0000c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c950: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c970: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c990: 2020 2072 6563 6569 7665 2873 656c 662e     receive(self.
-0000c9a0: 7265 7175 6573 7429 2020 2320 7265 6365  request)  # rece
-0000c9b0: 6976 6520 626c 6f63 6b2c 2062 7574 2064  ive block, but d
-0000c9c0: 6f20 6e6f 7468 696e 6720 6162 6f75 7420  o nothing about 
-0000c9d0: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
-0000c9e0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000c9f0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-0000ca00: 6e66 6f28 6627 7b70 6565 725f 6970 7d20  nfo(f'{peer_ip} 
-0000ca10: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
-0000ca20: 666f 7220 626c 6f63 6b20 636f 6d6d 616e  for block comman
-0000ca30: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
-0000ca40: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
-0000ca50: 3d20 2762 6c6f 636b 6c61 7374 273a 0a20  = 'blocklast':. 
-0000ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca70: 2020 2023 2069 6620 2870 6565 725f 6970     # if (peer_ip
-0000ca80: 2069 6e20 616c 6c6f 7765 6420 6f72 2022   in allowed or "
-0000ca90: 616e 7922 2069 6e20 616c 6c6f 7765 6429  any" in allowed)
-0000caa0: 3a20 2023 206f 6e6c 7920 7365 6e64 7320  :  # only sends 
-0000cab0: 7468 6520 6d69 6e65 7220 7061 7274 206f  the miner part o
-0000cac0: 6620 7468 6520 626c 6f63 6b21 0a20 2020  f the block!.   
-0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cae0: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
-0000caf0: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
-0000cb00: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
+0000c830: 6966 206c 656e 286e 6f64 652e 7065 6572  if len(node.peer
+0000c840: 732e 636f 6e6e 6563 7469 6f6e 5f70 6f6f  s.connection_poo
+0000c850: 6c29 203c 2035 2061 6e64 206e 6f74 206e  l) < 5 and not n
+0000c860: 6f64 652e 7065 6572 732e 6973 5f77 6869  ode.peers.is_whi
+0000c870: 7465 6c69 7374 6564 2870 6565 725f 6970  telisted(peer_ip
+0000c880: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8a0: 2020 2072 6561 736f 6e20 3d20 2749 6e62     reason = 'Inb
+0000c8b0: 6f75 6e64 3a20 4d69 6e65 6420 626c 6f63  ound: Mined bloc
+0000c8c0: 6b20 6967 6e6f 7265 642c 2069 6e73 7566  k ignored, insuf
+0000c8d0: 6669 6369 656e 7420 636f 6e6e 6563 7469  ficient connecti
+0000c8e0: 6f6e 7320 746f 2074 6865 206e 6574 776f  ons to the netwo
+0000c8f0: 726b 270a 2020 2020 2020 2020 2020 2020  rk'.            
+0000c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c910: 2020 2020 6d69 6e65 645b 2772 6561 736f      mined['reaso
+0000c920: 6e27 5d20 3d20 7265 6173 6f6e 0a20 2020  n'] = reason.   
+0000c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c940: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000c950: 652e 706c 7567 696e 5f6d 616e 6167 6572  e.plugin_manager
+0000c960: 2e65 7865 6375 7465 5f61 6374 696f 6e5f  .execute_action_
+0000c970: 686f 6f6b 2827 6d69 6e65 6427 2c20 6d69  hook('mined', mi
+0000c980: 6e65 6429 0a20 2020 2020 2020 2020 2020  ned).           
+0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9a0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+0000c9b0: 2e61 7070 5f6c 6f67 2e64 6562 7567 2872  .app_log.debug(r
+0000c9c0: 6561 736f 6e29 0a20 2020 2020 2020 2020  eason).         
+0000c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9e0: 2020 2020 2020 2023 2064 625f 6861 6e64         # db_hand
+0000c9f0: 6c65 725f 696e 7374 616e 6365 2e63 6c6f  ler_instance.clo
+0000ca00: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+0000ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca20: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca40: 2020 2020 2020 2020 656c 6966 206e 6f64          elif nod
+0000ca50: 652e 6462 5f6c 6f63 6b2e 6c6f 636b 6564  e.db_lock.locked
+0000ca60: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca80: 2020 2020 7265 6173 6f6e 203d 2027 496e      reason = 'In
+0000ca90: 626f 756e 643a 2042 6c6f 636b 2066 726f  bound: Block fro
+0000caa0: 6d20 6d69 6e65 7220 736b 6970 7065 6420  m miner skipped 
+0000cab0: 6265 6361 7573 6520 7765 2061 7265 2064  because we are d
+0000cac0: 6967 6573 7469 6e67 2061 6c72 6561 6479  igesting already
+0000cad0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caf0: 2020 6d69 6e65 645b 2772 6561 736f 6e27    mined['reason'
+0000cb00: 5d20 3d20 7265 6173 6f6e 0a20 2020 2020  ] = reason.     
 0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb20: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
-0000cb30: 7461 6e63 652e 6578 6563 7574 6528 0a20  tance.execute(. 
-0000cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb50: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
-0000cb60: 6e64 6c65 725f 696e 7374 616e 6365 2e63  ndler_instance.c
-0000cb70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cb80: 2020 2020 2020 2020 2020 2020 2020 2753                'S
-0000cb90: 454c 4543 5420 2a20 4652 4f4d 2074 7261  ELECT * FROM tra
-0000cba0: 6e73 6163 7469 6f6e 7320 270a 2020 2020  nsactions '.    
+0000cb20: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0000cb30: 706c 7567 696e 5f6d 616e 6167 6572 2e65  plugin_manager.e
+0000cb40: 7865 6375 7465 5f61 6374 696f 6e5f 686f  xecute_action_ho
+0000cb50: 6f6b 2827 6d69 6e65 6427 2c20 6d69 6e65  ok('mined', mine
+0000cb60: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb80: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000cb90: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2872  pp_log.warning(r
+0000cba0: 6561 736f 6e29 0a20 2020 2020 2020 2020  eason).         
 0000cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbc0: 2020 2020 2020 2020 2757 4845 5245 2072          'WHERE r
-0000cbd0: 6577 6172 6420 213d 2030 2027 0a20 2020  eward != 0 '.   
-0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbf0: 2020 2020 2020 2020 2027 4f52 4445 5220           'ORDER 
-0000cc00: 4259 2062 6c6f 636b 5f68 6569 6768 7420  BY block_height 
-0000cc10: 4445 5343 204c 494d 4954 2031 3b27 2c0a  DESC LIMIT 1;',.
-0000cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc50: 2020 626c 6f63 6b5f 6c61 7374 203d 2064    block_last = d
-0000cc60: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-0000cc70: 6365 2e63 2e66 6574 6368 616c 6c28 295b  ce.c.fetchall()[
-0000cc80: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
-0000cc90: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-0000cca0: 2873 656c 662e 7265 7175 6573 742c 2062  (self.request, b
-0000ccb0: 6c6f 636b 5f6c 6173 7429 0a20 2020 2020  lock_last).     
-0000ccc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000ccd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000cce0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-0000ccf0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-0000cd00: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-0000cd10: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-0000cd20: 6420 666f 7220 626c 6f63 6b6c 6173 7420  d for blocklast 
-0000cd30: 636f 6d6d 616e 6427 290a 0a20 2020 2020  command')..     
-0000cd40: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000cd50: 6461 7461 203d 3d20 2762 6c6f 636b 6c61  data == 'blockla
-0000cd60: 7374 6a73 6f6e 273a 0a20 2020 2020 2020  stjson':.       
-0000cd70: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-0000cd80: 6620 2870 6565 725f 6970 2069 6e20 616c  f (peer_ip in al
-0000cd90: 6c6f 7765 6420 6f72 2022 616e 7922 2069  lowed or "any" i
-0000cda0: 6e20 616c 6c6f 7765 6429 3a20 2023 206f  n allowed):  # o
-0000cdb0: 6e6c 7920 7365 6e64 7320 7468 6520 6d69  nly sends the mi
-0000cdc0: 6e65 7220 7061 7274 206f 6620 7468 6520  ner part of the 
-0000cdd0: 626c 6f63 6b21 0a20 2020 2020 2020 2020  block!.         
-0000cde0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000cdf0: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
-0000ce00: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
-0000ce10: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
-0000ce20: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
-0000ce30: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-0000ce40: 6578 6563 7574 6528 6462 5f68 616e 646c  execute(db_handl
-0000ce50: 6572 5f69 6e73 7461 6e63 652e 632c 2027  er_instance.c, '
-0000ce60: 5345 4c45 4354 202a 2046 524f 4d20 7472  SELECT * FROM tr
-0000ce70: 616e 7361 6374 696f 6e73 2057 4845 5245  ansactions WHERE
-0000ce80: 2072 6577 6172 6420 213d 2030 204f 5244   reward != 0 ORD
-0000ce90: 4552 2042 5920 626c 6f63 6b5f 6865 6967  ER BY block_heig
-0000cea0: 6874 2044 4553 4320 4c49 4d49 5420 313b  ht DESC LIMIT 1;
-0000ceb0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0000cec0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-0000ced0: 5f6c 6173 7420 3d20 6462 5f68 616e 646c  _last = db_handl
-0000cee0: 6572 5f69 6e73 7461 6e63 652e 632e 6665  er_instance.c.fe
-0000cef0: 7463 6861 6c6c 2829 5b30 5d0a 0a20 2020  tchall()[0]..   
-0000cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf10: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-0000cf20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0000cf30: 2020 2020 2020 2020 2020 2020 2020 2762                'b
-0000cf40: 6c6f 636b 5f68 6569 6768 7427 3a20 626c  lock_height': bl
-0000cf50: 6f63 6b5f 6c61 7374 5b30 5d2c 0a20 2020  ock_last[0],.   
-0000cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf70: 2020 2020 2020 2020 2027 7469 6d65 7374           'timest
-0000cf80: 616d 7027 3a20 626c 6f63 6b5f 6c61 7374  amp': block_last
-0000cf90: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-0000cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfb0: 2027 6164 6472 6573 7327 3a20 626c 6f63   'address': bloc
-0000cfc0: 6b5f 6c61 7374 5b32 5d2c 0a20 2020 2020  k_last[2],.     
-0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfe0: 2020 2020 2020 2027 7265 6369 7069 656e         'recipien
-0000cff0: 7427 3a20 626c 6f63 6b5f 6c61 7374 5b33  t': block_last[3
-0000d000: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000d010: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000d020: 616d 6f75 6e74 273a 2062 6c6f 636b 5f6c  amount': block_l
-0000d030: 6173 745b 345d 2c0a 2020 2020 2020 2020  ast[4],.        
-0000d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d050: 2020 2020 2773 6967 6e61 7475 7265 273a      'signature':
-0000d060: 2062 6c6f 636b 5f6c 6173 745b 355d 2c0a   block_last[5],.
-0000d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d080: 2020 2020 2020 2020 2020 2020 2770 7562              'pub
-0000d090: 6c69 635f 6b65 7927 3a20 626c 6f63 6b5f  lic_key': block_
-0000d0a0: 6c61 7374 5b36 5d2c 0a20 2020 2020 2020  last[6],.       
-0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0c0: 2020 2020 2027 626c 6f63 6b5f 6861 7368       'block_hash
-0000d0d0: 273a 2062 6c6f 636b 5f6c 6173 745b 375d  ': block_last[7]
-0000d0e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2766                'f
-0000d100: 6565 273a 2062 6c6f 636b 5f6c 6173 745b  ee': block_last[
-0000d110: 385d 2c0a 2020 2020 2020 2020 2020 2020  8],.            
-0000d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d130: 2772 6577 6172 6427 3a20 626c 6f63 6b5f  'reward': block_
-0000d140: 6c61 7374 5b39 5d2c 0a20 2020 2020 2020  last[9],.       
-0000d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d160: 2020 2020 2027 6f70 6572 6174 696f 6e27       'operation'
-0000d170: 3a20 626c 6f63 6b5f 6c61 7374 5b31 305d  : block_last[10]
-0000d180: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d190: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-0000d1a0: 6f6e 6365 273a 2062 6c6f 636b 5f6c 6173  once': block_las
-0000d1b0: 745b 3131 5d2c 0a20 2020 2020 2020 2020  t[11],.         
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0000d1d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000d1e0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
-0000d1f0: 656c 662e 7265 7175 6573 742c 2072 6573  elf.request, res
-0000d200: 706f 6e73 6529 0a20 2020 2020 2020 2020  ponse).         
-0000d210: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000d220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d230: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-0000d240: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-0000d250: 6f28 6627 7b70 6565 725f 6970 7d20 6e6f  o(f'{peer_ip} no
-0000d260: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
-0000d270: 7220 626c 6f63 6b6c 6173 746a 736f 6e20  r blocklastjson 
-0000d280: 636f 6d6d 616e 6427 290a 0a20 2020 2020  command')..     
-0000d290: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000d2a0: 6461 7461 203d 3d20 2762 6c6f 636b 6765  data == 'blockge
-0000d2b0: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
-0000d2c0: 2020 2020 2020 2020 2320 6966 2028 7065          # if (pe
-0000d2d0: 6572 5f69 7020 696e 2061 6c6c 6f77 6564  er_ip in allowed
-0000d2e0: 206f 7220 2261 6e79 2220 696e 2061 6c6c   or "any" in all
-0000d2f0: 6f77 6564 293a 0a20 2020 2020 2020 2020  owed):.         
-0000d300: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000d310: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
-0000d320: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
-0000d330: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
-0000d340: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-0000d350: 6b5f 6465 7369 7265 6420 3d20 7265 6365  k_desired = rece
-0000d360: 6976 6528 7365 6c66 2e72 6571 7565 7374  ive(self.request
-0000d370: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000d380: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
-0000d390: 6e64 6c65 725f 696e 7374 616e 6365 2e65  ndler_instance.e
-0000d3a0: 7865 6375 7465 5f70 6172 616d 2864 625f  xecute_param(db_
-0000d3b0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
-0000d3c0: 2e68 2c20 2753 454c 4543 5420 2a20 4652  .h, 'SELECT * FR
-0000d3d0: 4f4d 2074 7261 6e73 6163 7469 6f6e 7320  OM transactions 
-0000d3e0: 5748 4552 4520 626c 6f63 6b5f 6865 6967  WHERE block_heig
-0000d3f0: 6874 203d 203f 3b27 2c20 2862 6c6f 636b  ht = ?;', (block
-0000d400: 5f64 6573 6972 6564 2c20 2929 0a20 2020  _desired, )).   
+0000cbc0: 2020 2020 2020 2023 2064 625f 6861 6e64         # db_hand
+0000cbd0: 6c65 725f 696e 7374 616e 6365 2e63 6c6f  ler_instance.clo
+0000cbe0: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+0000cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc00: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000cc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc20: 2020 2020 2020 2020 656c 6966 206e 6f64          elif nod
+0000cc30: 652e 6c61 7374 5f62 6c6f 636b 203e 3d20  e.last_block >= 
+0000cc40: 6e6f 6465 2e70 6565 7273 2e63 6f6e 7365  node.peers.conse
+0000cc50: 6e73 7573 5f6d 6178 202d 2033 3a0a 2020  nsus_max - 3:.  
+0000cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc70: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0000cc80: 6e65 645b 2772 6573 756c 7427 5d20 3d20  ned['result'] = 
+0000cc90: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0000cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccb0: 2020 2020 206e 6f64 652e 706c 7567 696e       node.plugin
+0000ccc0: 5f6d 616e 6167 6572 2e65 7865 6375 7465  _manager.execute
+0000ccd0: 5f61 6374 696f 6e5f 686f 6f6b 2827 6d69  _action_hook('mi
+0000cce0: 6e65 6427 2c20 6d69 6e65 6429 0a20 2020  ned', mined).   
+0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd00: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000cd10: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000cd20: 2e77 6172 6e69 6e67 2866 2749 6e62 6f75  .warning(f'Inbou
+0000cd30: 6e64 3a20 5072 6f63 6573 7369 6e67 2062  nd: Processing b
+0000cd40: 6c6f 636b 2066 726f 6d20 6d69 6e65 7220  lock from miner 
+0000cd50: 696e 207b 7468 7265 6164 696e 672e 6375  in {threading.cu
+0000cd60: 7272 656e 745f 7468 7265 6164 2829 7d27  rrent_thread()}'
+0000cd70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd90: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+0000cda0: 7461 6e63 6520 3d20 6462 6861 6e64 6c65  tance = dbhandle
+0000cdb0: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+0000cdc0: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+0000cdd0: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+0000cde0: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+0000cdf0: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+0000ce00: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+0000ce10: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+0000ce20: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+0000ce30: 7261 6365 5f64 625f 6361 6c6c 7329 0a20  race_db_calls). 
+0000ce40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000ce60: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce80: 2020 2020 2020 2020 6469 6765 7374 5f62          digest_b
+0000ce90: 6c6f 636b 286e 6f64 652c 2073 6567 6d65  lock(node, segme
+0000cea0: 6e74 732c 2073 656c 662e 7265 7175 6573  nts, self.reques
+0000ceb0: 742c 2070 6565 725f 6970 2c20 6462 5f68  t, peer_ip, db_h
+0000cec0: 616e 646c 6572 5f69 6e73 7461 6e63 6529  andler_instance)
+0000ced0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cef0: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+0000cf00: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+0000cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf20: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000cf30: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000cf40: 2e77 6172 6e69 6e67 2827 496e 626f 756e  .warning('Inboun
+0000cf50: 643a 2062 6c6f 636b 207b 7d27 2e66 6f72  d: block {}'.for
+0000cf60: 6d61 7428 7374 7228 6529 2929 0a20 2020  mat(str(e))).   
+0000cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf90: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000cfa0: 616e 6365 2e63 6c6f 7365 2829 0a20 2020  ance.close().   
+0000cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfd0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cff0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000d000: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d030: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000d040: 7070 5f6c 6f67 2e65 7272 6f72 2827 496e  pp_log.error('In
+0000d050: 626f 756e 643a 2050 726f 6365 7373 696e  bound: Processin
+0000d060: 6720 626c 6f63 6b20 6672 6f6d 206d 696e  g block from min
+0000d070: 6572 207b 7d27 2e66 6f72 6d61 7428 6529  er {}'.format(e)
+0000d080: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0a0: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
+0000d0b0: 5f69 6e73 7461 6e63 652e 636c 6f73 6528  _instance.close(
+0000d0c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0e0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d100: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+0000d110: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+0000d120: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+0000d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d140: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+0000d150: 6e65 7720 626c 6f63 6b20 6d61 7920 6368  new block may ch
+0000d160: 616e 6765 2074 6865 2069 6e74 2864 6966  ange the int(dif
+0000d170: 6629 2e20 5472 6967 6765 7220 7468 6520  f). Trigger the 
+0000d180: 686f 6f6b 2077 6865 7468 6572 2069 7420  hook whether it 
+0000d190: 6368 616e 6765 6420 6f72 206e 6f74 2e0a  changed or not..
+0000d1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1c0: 236e 6f64 652e 6469 6666 6963 756c 7479  #node.difficulty
+0000d1d0: 203d 2064 6966 6669 6375 6c74 7928 6e6f   = difficulty(no
+0000d1e0: 6465 2c20 6462 5f68 616e 646c 6572 5f69  de, db_handler_i
+0000d1f0: 6e73 7461 6e63 6529 0a20 2020 2020 2020  nstance).       
+0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d210: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d230: 2020 2020 2020 2020 2020 2072 6561 736f             reaso
+0000d240: 6e20 3d20 6627 496e 626f 756e 643a 204d  n = f'Inbound: M
+0000d250: 696e 6564 2062 6c6f 636b 2077 6173 206f  ined block was o
+0000d260: 7270 6861 6e65 6420 6265 6361 7573 6520  rphaned because 
+0000d270: 6e6f 6465 2077 6173 206e 6f74 2073 796e  node was not syn
+0000d280: 6365 642c 2027 205c 0a20 2020 2020 2020  ced, ' \.       
+0000d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2b0: 2020 6627 7765 2061 7265 2061 7420 626c    f'we are at bl
+0000d2c0: 6f63 6b20 7b6e 6f64 652e 6c61 7374 5f62  ock {node.last_b
+0000d2d0: 6c6f 636b 7d2c 2027 205c 0a20 2020 2020  lock}, ' \.     
+0000d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d300: 2020 2020 6627 7368 6f75 6c64 2062 6520      f'should be 
+0000d310: 6174 206c 6561 7374 207b 6e6f 6465 2e70  at least {node.p
+0000d320: 6565 7273 2e63 6f6e 7365 6e73 7573 5f6d  eers.consensus_m
+0000d330: 6178 202d 2033 7d27 0a20 2020 2020 2020  ax - 3}'.       
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d350: 2020 2020 2020 2020 206d 696e 6564 5b27           mined['
+0000d360: 7265 6173 6f6e 275d 203d 2072 6561 736f  reason'] = reaso
+0000d370: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d390: 2020 6e6f 6465 2e70 6c75 6769 6e5f 6d61    node.plugin_ma
+0000d3a0: 6e61 6765 722e 6578 6563 7574 655f 6163  nager.execute_ac
+0000d3b0: 7469 6f6e 5f68 6f6f 6b28 276d 696e 6564  tion_hook('mined
+0000d3c0: 272c 206d 696e 6564 290a 2020 2020 2020  ', mined).      
+0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3e0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+0000d3f0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+0000d400: 726e 696e 6728 7265 6173 6f6e 290a 2020  rning(reason).  
 0000d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d420: 2020 2020 2062 6c6f 636b 5f64 6573 6972       block_desir
-0000d430: 6564 5f72 6573 756c 7420 3d20 6462 5f68  ed_result = db_h
-0000d440: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-0000d450: 682e 6665 7463 6861 6c6c 2829 0a0a 2020  h.fetchall()..  
+0000d420: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d440: 2020 2020 2020 2020 2320 4e6f 7420 6d61          # Not ma
+0000d450: 696e 6e65 740a 2020 2020 2020 2020 2020  innet.          
 0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d470: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
-0000d480: 7265 7175 6573 742c 2062 6c6f 636b 5f64  request, block_d
-0000d490: 6573 6972 6564 5f72 6573 756c 7429 0a20  esired_result). 
-0000d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4d0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-0000d4e0: 5f6c 6f67 2e69 6e66 6f28 6627 7b70 6565  _log.info(f'{pee
-0000d4f0: 725f 6970 7d20 6e6f 7420 7768 6974 656c  r_ip} not whitel
-0000d500: 6973 7465 6420 666f 7220 626c 6f63 6b67  isted for blockg
-0000d510: 6574 2063 6f6d 6d61 6e64 2729 0a0a 2020  et command')..  
-0000d520: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000d530: 6966 2064 6174 6120 3d3d 2027 626c 6f63  if data == 'bloc
-0000d540: 6b67 6574 6a73 6f6e 273a 0a20 2020 2020  kgetjson':.     
-0000d550: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000d560: 2069 6620 2870 6565 725f 6970 2069 6e20   if (peer_ip in 
-0000d570: 616c 6c6f 7765 6420 6f72 2022 616e 7922  allowed or "any"
-0000d580: 2069 6e20 616c 6c6f 7765 6429 3a0a 2020   in allowed):.  
-0000d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5a0: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
-0000d5b0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
-0000d5c0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
-0000d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5e0: 2020 2062 6c6f 636b 5f64 6573 6972 6564     block_desired
-0000d5f0: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-0000d600: 7265 7175 6573 7429 0a0a 2020 2020 2020  request)..      
-0000d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d620: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
-0000d630: 7461 6e63 652e 6578 6563 7574 655f 7061  tance.execute_pa
-0000d640: 7261 6d28 6462 5f68 616e 646c 6572 5f69  ram(db_handler_i
-0000d650: 6e73 7461 6e63 652e 682c 2027 5345 4c45  nstance.h, 'SELE
-0000d660: 4354 202a 2046 524f 4d20 7472 616e 7361  CT * FROM transa
-0000d670: 6374 696f 6e73 2057 4845 5245 2062 6c6f  ctions WHERE blo
-0000d680: 636b 5f68 6569 6768 7420 3d20 3f3b 272c  ck_height = ?;',
-0000d690: 2028 626c 6f63 6b5f 6465 7369 7265 642c   (block_desired,
-0000d6a0: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
-0000d6b0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-0000d6c0: 6b5f 6465 7369 7265 645f 7265 7375 6c74  k_desired_result
-0000d6d0: 203d 2064 625f 6861 6e64 6c65 725f 696e   = db_handler_in
-0000d6e0: 7374 616e 6365 2e68 2e66 6574 6368 616c  stance.h.fetchal
-0000d6f0: 6c28 290a 0a20 2020 2020 2020 2020 2020  l()..           
-0000d700: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0000d710: 706f 6e73 655f 6c69 7374 203d 205b 5d0a  ponse_list = [].
-0000d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d730: 2020 2020 2020 2020 666f 7220 7472 616e          for tran
-0000d740: 7361 6374 696f 6e20 696e 2062 6c6f 636b  saction in block
-0000d750: 5f64 6573 6972 6564 5f72 6573 756c 743a  _desired_result:
-0000d760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d770: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0000d780: 706f 6e73 6520 3d20 7b0a 2020 2020 2020  ponse = {.      
-0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7a0: 2020 2020 2020 2020 2020 2762 6c6f 636b            'block
-0000d7b0: 5f68 6569 6768 7427 3a20 7472 616e 7361  _height': transa
-0000d7c0: 6374 696f 6e5b 305d 2c0a 2020 2020 2020  ction[0],.      
-0000d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7e0: 2020 2020 2020 2020 2020 2774 696d 6573            'times
-0000d7f0: 7461 6d70 273a 2074 7261 6e73 6163 7469  tamp': transacti
-0000d800: 6f6e 5b31 5d2c 0a20 2020 2020 2020 2020  on[1],.         
-0000d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d820: 2020 2020 2020 2027 6164 6472 6573 7327         'address'
-0000d830: 3a20 7472 616e 7361 6374 696f 6e5b 325d  : transaction[2]
-0000d840: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d470: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+0000d480: 7461 6e63 6520 3d20 6462 6861 6e64 6c65  tance = dbhandle
+0000d490: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+0000d4a0: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+0000d4b0: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+0000d4c0: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+0000d4d0: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+0000d4e0: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+0000d4f0: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+0000d500: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+0000d510: 7261 6365 5f64 625f 6361 6c6c 7329 0a20  race_db_calls). 
+0000d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d530: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d560: 6469 6765 7374 5f62 6c6f 636b 286e 6f64  digest_block(nod
+0000d570: 652c 2073 6567 6d65 6e74 732c 2073 656c  e, segments, sel
+0000d580: 662e 7265 7175 6573 742c 2070 6565 725f  f.request, peer_
+0000d590: 6970 2c20 6462 5f68 616e 646c 6572 5f69  ip, db_handler_i
+0000d5a0: 6e73 7461 6e63 6529 0a20 2020 2020 2020  nstance).       
+0000d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5c0: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+0000d5d0: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
+0000d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5f0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000d600: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000d610: 2e77 6172 6e69 6e67 2827 496e 626f 756e  .warning('Inboun
+0000d620: 643a 2062 6c6f 636b 207b 7d27 2e66 6f72  d: block {}'.for
+0000d630: 6d61 7428 7374 7228 6529 2929 0a20 2020  mat(str(e))).   
+0000d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d650: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+0000d660: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+0000d670: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+0000d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d690: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000d6c0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0000d6d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6f0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000d700: 7070 5f6c 6f67 2e65 7272 6f72 2827 496e  pp_log.error('In
+0000d710: 626f 756e 643a 2050 726f 6365 7373 696e  bound: Processin
+0000d720: 6720 626c 6f63 6b20 6672 6f6d 206d 696e  g block from min
+0000d730: 6572 207b 7d27 2e66 6f72 6d61 7428 6529  er {}'.format(e)
+0000d740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d760: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+0000d770: 7461 6e63 652e 636c 6f73 6528 290a 2020  tance.close().  
+0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d790: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000d7a0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0000d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7c0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000d7d0: 616e 6365 2e63 6c6f 7365 2829 0a20 2020  ance.close().   
+0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000d800: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000d810: 6563 6569 7665 2873 656c 662e 7265 7175  eceive(self.requ
+0000d820: 6573 7429 2020 2320 7265 6365 6976 6520  est)  # receive 
+0000d830: 626c 6f63 6b2c 2062 7574 2064 6f20 6e6f  block, but do no
+0000d840: 7468 696e 6720 6162 6f75 7420 6974 0a20  thing about it. 
 0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d860: 2020 2772 6563 6970 6965 6e74 273a 2074    'recipient': t
-0000d870: 7261 6e73 6163 7469 6f6e 5b33 5d2c 0a20  ransaction[3],. 
-0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d890: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000d8a0: 616d 6f75 6e74 273a 2074 7261 6e73 6163  amount': transac
-0000d8b0: 7469 6f6e 5b34 5d2c 0a20 2020 2020 2020  tion[4],.       
-0000d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8d0: 2020 2020 2020 2020 2027 7369 676e 6174           'signat
-0000d8e0: 7572 6527 3a20 7472 616e 7361 6374 696f  ure': transactio
-0000d8f0: 6e5b 355d 2c0a 2020 2020 2020 2020 2020  n[5],.          
-0000d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d910: 2020 2020 2020 2770 7562 6c69 635f 6b65        'public_ke
-0000d920: 7927 3a20 7472 616e 7361 6374 696f 6e5b  y': transaction[
-0000d930: 365d 2c0a 2020 2020 2020 2020 2020 2020  6],.            
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 2020 2020 2762 6c6f 636b 5f68 6173 6827      'block_hash'
-0000d960: 3a20 7472 616e 7361 6374 696f 6e5b 375d  : transaction[7]
-0000d970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2766 6565 273a 2074 7261 6e73 6163    'fee': transac
-0000d9a0: 7469 6f6e 5b38 5d2c 0a20 2020 2020 2020  tion[8],.       
-0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9c0: 2020 2020 2020 2020 2027 7265 7761 7264           'reward
-0000d9d0: 273a 2074 7261 6e73 6163 7469 6f6e 5b39  ': transaction[9
-0000d9e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da00: 2020 2027 6f70 6572 6174 696f 6e27 3a20     'operation': 
-0000da10: 7472 616e 7361 6374 696f 6e5b 3130 5d2c  transaction[10],
-0000da20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da40: 2027 6f70 656e 6669 656c 6427 3a20 7472   'openfield': tr
-0000da50: 616e 7361 6374 696f 6e5b 3131 5d2c 0a20  ansaction[11],. 
-0000da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da70: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0000da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da90: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-0000daa0: 7365 5f6c 6973 742e 6170 7065 6e64 2872  se_list.append(r
-0000dab0: 6573 706f 6e73 6529 0a0a 2020 2020 2020  esponse)..      
+0000d860: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+0000d870: 6572 2e61 7070 5f6c 6f67 2e64 6562 7567  er.app_log.debug
+0000d880: 2866 277b 7065 6572 5f69 707d 206e 6f74  (f'{peer_ip} not
+0000d890: 2077 6869 7465 6c69 7374 6564 2066 6f72   whitelisted for
+0000d8a0: 2062 6c6f 636b 2063 6f6d 6d61 6e64 2729   block command')
+0000d8b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d8c0: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
+0000d8d0: 626c 6f63 6b6c 6173 7427 3a0a 2020 2020  blocklast':.    
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8f0: 2320 6966 2028 7065 6572 5f69 7020 696e  # if (peer_ip in
+0000d900: 2061 6c6c 6f77 6564 206f 7220 2261 6e79   allowed or "any
+0000d910: 2220 696e 2061 6c6c 6f77 6564 293a 2020  " in allowed):  
+0000d920: 2320 6f6e 6c79 2073 656e 6473 2074 6865  # only sends the
+0000d930: 206d 696e 6572 2070 6172 7420 6f66 2074   miner part of t
+0000d940: 6865 2062 6c6f 636b 210a 2020 2020 2020  he block!.      
+0000d950: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000d960: 206e 6f64 652e 7065 6572 732e 6973 5f61   node.peers.is_a
+0000d970: 6c6c 6f77 6564 2870 6565 725f 6970 2c20  llowed(peer_ip, 
+0000d980: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
+0000d990: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000d9a0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+0000d9b0: 6365 203d 2064 6268 616e 646c 6572 2e44  ce = dbhandler.D
+0000d9c0: 6248 616e 646c 6572 286e 6f64 652e 696e  bHandler(node.in
+0000d9d0: 6465 785f 6462 2c20 6e6f 6465 2e6c 6564  dex_db, node.led
+0000d9e0: 6765 725f 7061 7468 2c20 6e6f 6465 2e68  ger_path, node.h
+0000d9f0: 7970 6572 5f70 6174 682c 206e 6f64 652e  yper_path, node.
+0000da00: 7261 6d2c 206e 6f64 652e 6c65 6467 6572  ram, node.ledger
+0000da10: 5f72 616d 5f66 696c 652c 206e 6f64 652e  _ram_file, node.
+0000da20: 6c6f 6767 6572 2c20 7472 6163 655f 6462  logger, trace_db
+0000da30: 5f63 616c 6c73 3d6e 6f64 652e 7472 6163  _calls=node.trac
+0000da40: 655f 6462 5f63 616c 6c73 290a 2020 2020  e_db_calls).    
+0000da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da60: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+0000da70: 6e73 7461 6e63 652e 6578 6563 7574 6528  nstance.execute(
+0000da80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000da90: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+0000daa0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+0000dab0: 2e63 2c0a 2020 2020 2020 2020 2020 2020  .c,.            
 0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dad0: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
-0000dae0: 6573 742c 2072 6573 706f 6e73 655f 6c69  est, response_li
-0000daf0: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0000db00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db20: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0000db30: 722e 6170 705f 6c6f 672e 696e 666f 2866  r.app_log.info(f
-0000db40: 277b 7065 6572 5f69 707d 206e 6f74 2077  '{peer_ip} not w
-0000db50: 6869 7465 6c69 7374 6564 2066 6f72 2062  hitelisted for b
-0000db60: 6c6f 636b 6765 7420 636f 6d6d 616e 6427  lockget command'
-0000db70: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000db80: 2020 2065 6c69 6620 6461 7461 203d 3d20     elif data == 
-0000db90: 276d 7069 6e73 6572 7427 3a0a 2020 2020  'mpinsert':.    
-0000dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbb0: 2320 6966 2028 7065 6572 5f69 7020 696e  # if (peer_ip in
-0000dbc0: 2061 6c6c 6f77 6564 206f 7220 2261 6e79   allowed or "any
-0000dbd0: 2220 696e 2061 6c6c 6f77 6564 293a 0a20  " in allowed):. 
-0000dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbf0: 2020 2069 6620 6e6f 6465 2e70 6565 7273     if node.peers
-0000dc00: 2e69 735f 616c 6c6f 7765 6428 7065 6572  .is_allowed(peer
-0000dc10: 5f69 702c 2064 6174 6129 3a0a 2020 2020  _ip, data):.    
-0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc30: 2020 2020 6d65 6d70 6f6f 6c5f 696e 7365      mempool_inse
-0000dc40: 7274 203d 2072 6563 6569 7665 2873 656c  rt = receive(sel
-0000dc50: 662e 7265 7175 6573 7429 0a20 2020 2020  f.request).     
-0000dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc70: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0000dc80: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
-0000dc90: 6d70 696e 7365 7274 2063 6f6d 6d61 6e64  mpinsert command
-0000dca0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0000dcb0: 2020 2020 2020 2020 2020 206d 7069 6e73             mpins
-0000dcc0: 6572 745f 7265 7375 6c74 203d 206d 702e  ert_result = mp.
-0000dcd0: 4d45 4d50 4f4f 4c2e 6d65 7267 6528 6d65  MEMPOOL.merge(me
-0000dce0: 6d70 6f6f 6c5f 696e 7365 7274 2c20 7065  mpool_insert, pe
-0000dcf0: 6572 5f69 702c 2064 625f 6861 6e64 6c65  er_ip, db_handle
-0000dd00: 725f 696e 7374 616e 6365 2e63 2c20 5472  r_instance.c, Tr
-0000dd10: 7565 2c20 5472 7565 290a 2020 2020 2020  ue, True).      
-0000dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd30: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-0000dd40: 705f 6c6f 672e 7761 726e 696e 6728 6627  p_log.warning(f'
-0000dd50: 6d70 696e 7365 7274 2072 6573 756c 743a  mpinsert result:
-0000dd60: 207b 6d70 696e 7365 7274 5f72 6573 756c   {mpinsert_resul
-0000dd70: 747d 2729 0a20 2020 2020 2020 2020 2020  t}').           
-0000dd80: 2020 2020 2020 2020 2020 2020 2073 656e               sen
-0000dd90: 6428 7365 6c66 2e72 6571 7565 7374 2c20  d(self.request, 
-0000dda0: 6d70 696e 7365 7274 5f72 6573 756c 7429  mpinsert_result)
-0000ddb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ddc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dde0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0000ddf0: 7070 5f6c 6f67 2e69 6e66 6f28 6627 7b70  pp_log.info(f'{p
-0000de00: 6565 725f 6970 7d20 6e6f 7420 7768 6974  eer_ip} not whit
-0000de10: 656c 6973 7465 6420 666f 7220 6d70 696e  elisted for mpin
-0000de20: 7365 7274 2063 6f6d 6d61 6e64 2729 0a0a  sert command')..
-0000de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de40: 656c 6966 2064 6174 6120 3d3d 2027 6261  elif data == 'ba
-0000de50: 6c61 6e63 6567 6574 273a 0a20 2020 2020  lanceget':.     
-0000de60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000de70: 2069 6620 2870 6565 725f 6970 2069 6e20   if (peer_ip in 
-0000de80: 616c 6c6f 7765 6420 6f72 2022 616e 7922  allowed or "any"
-0000de90: 2069 6e20 616c 6c6f 7765 6429 3a0a 2020   in allowed):.  
-0000dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000deb0: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
-0000dec0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
-0000ded0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
-0000dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000def0: 2020 2062 616c 616e 6365 5f61 6464 7265     balance_addre
-0000df00: 7373 203d 2072 6563 6569 7665 2873 656c  ss = receive(sel
-0000df10: 662e 7265 7175 6573 7429 2020 2320 666f  f.request)  # fo
-0000df20: 7220 7768 6963 6820 6164 6472 6573 730a  r which address.
-0000df30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000df40: 2020 2020 2020 2020 2062 616c 616e 6365           balance
-0000df50: 6765 745f 7265 7375 6c74 203d 2062 616c  get_result = bal
-0000df60: 616e 6365 6765 7428 6261 6c61 6e63 655f  anceget(balance_
-0000df70: 6164 6472 6573 732c 2064 625f 6861 6e64  address, db_hand
-0000df80: 6c65 725f 696e 7374 616e 6365 290a 0a20  ler_instance).. 
-0000df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfa0: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
-0000dfb0: 2e72 6571 7565 7374 2c20 6261 6c61 6e63  .request, balanc
-0000dfc0: 6567 6574 5f72 6573 756c 7429 2020 2320  eget_result)  # 
-0000dfd0: 7265 7475 726e 2062 616c 616e 6365 206f  return balance o
-0000dfe0: 6620 7468 6520 6164 6472 6573 7320 746f  f the address to
-0000dff0: 2074 6865 2063 6c69 656e 742c 2069 6e63   the client, inc
-0000e000: 6c75 6469 6e67 206d 656d 706f 6f6c 0a20  luding mempool. 
+0000dad0: 2753 454c 4543 5420 2a20 4652 4f4d 2074  'SELECT * FROM t
+0000dae0: 7261 6e73 6163 7469 6f6e 7320 270a 2020  ransactions '.  
+0000daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db00: 2020 2020 2020 2020 2020 2757 4845 5245            'WHERE
+0000db10: 2072 6577 6172 6420 213d 2030 2027 0a20   reward != 0 '. 
+0000db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db30: 2020 2020 2020 2020 2020 2027 4f52 4445             'ORDE
+0000db40: 5220 4259 2062 6c6f 636b 5f68 6569 6768  R BY block_heigh
+0000db50: 7420 4445 5343 204c 494d 4954 2031 3b27  t DESC LIMIT 1;'
+0000db60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000db70: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db90: 2020 2020 626c 6f63 6b5f 6c61 7374 203d      block_last =
+0000dba0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000dbb0: 616e 6365 2e63 2e66 6574 6368 616c 6c28  ance.c.fetchall(
+0000dbc0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0000dbd0: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+0000dbe0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+0000dbf0: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
+0000dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc10: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+0000dc20: 6573 742c 2062 6c6f 636b 5f6c 6173 7429  est, block_last)
+0000dc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc60: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0000dc70: 7070 5f6c 6f67 2e64 6562 7567 2866 277b  pp_log.debug(f'{
+0000dc80: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
+0000dc90: 7465 6c69 7374 6564 2066 6f72 2062 6c6f  telisted for blo
+0000dca0: 636b 6c61 7374 2063 6f6d 6d61 6e64 2729  cklast command')
+0000dcb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000dcc0: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
+0000dcd0: 626c 6f63 6b6c 6173 746a 736f 6e27 3a0a  blocklastjson':.
+0000dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dcf0: 2020 2020 2320 6966 2028 7065 6572 5f69      # if (peer_i
+0000dd00: 7020 696e 2061 6c6c 6f77 6564 206f 7220  p in allowed or 
+0000dd10: 2261 6e79 2220 696e 2061 6c6c 6f77 6564  "any" in allowed
+0000dd20: 293a 2020 2320 6f6e 6c79 2073 656e 6473  ):  # only sends
+0000dd30: 2074 6865 206d 696e 6572 2070 6172 7420   the miner part 
+0000dd40: 6f66 2074 6865 2062 6c6f 636b 210a 2020  of the block!.  
+0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd60: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
+0000dd70: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
+0000dd80: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
+0000dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dda0: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+0000ddb0: 7374 616e 6365 203d 2064 6268 616e 646c  stance = dbhandl
+0000ddc0: 6572 2e44 6248 616e 646c 6572 286e 6f64  er.DbHandler(nod
+0000ddd0: 652e 696e 6465 785f 6462 2c20 6e6f 6465  e.index_db, node
+0000dde0: 2e6c 6564 6765 725f 7061 7468 2c20 6e6f  .ledger_path, no
+0000ddf0: 6465 2e68 7970 6572 5f70 6174 682c 206e  de.hyper_path, n
+0000de00: 6f64 652e 7261 6d2c 206e 6f64 652e 6c65  ode.ram, node.le
+0000de10: 6467 6572 5f72 616d 5f66 696c 652c 206e  dger_ram_file, n
+0000de20: 6f64 652e 6c6f 6767 6572 2c20 7472 6163  ode.logger, trac
+0000de30: 655f 6462 5f63 616c 6c73 3d6e 6f64 652e  e_db_calls=node.
+0000de40: 7472 6163 655f 6462 5f63 616c 6c73 290a  trace_db_calls).
+0000de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de60: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
+0000de70: 6572 5f69 6e73 7461 6e63 652e 6578 6563  er_instance.exec
+0000de80: 7574 6528 6462 5f68 616e 646c 6572 5f69  ute(db_handler_i
+0000de90: 6e73 7461 6e63 652e 632c 2027 5345 4c45  nstance.c, 'SELE
+0000dea0: 4354 202a 2046 524f 4d20 7472 616e 7361  CT * FROM transa
+0000deb0: 6374 696f 6e73 2057 4845 5245 2072 6577  ctions WHERE rew
+0000dec0: 6172 6420 213d 2030 204f 5244 4552 2042  ard != 0 ORDER B
+0000ded0: 5920 626c 6f63 6b5f 6865 6967 6874 2044  Y block_height D
+0000dee0: 4553 4320 4c49 4d49 5420 313b 2729 0a20  ESC LIMIT 1;'). 
+0000def0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df00: 2020 2020 2020 2062 6c6f 636b 5f6c 6173         block_las
+0000df10: 7420 3d20 6462 5f68 616e 646c 6572 5f69  t = db_handler_i
+0000df20: 6e73 7461 6e63 652e 632e 6665 7463 6861  nstance.c.fetcha
+0000df30: 6c6c 2829 5b30 5d0a 2020 2020 2020 2020  ll()[0].        
+0000df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df50: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+0000df60: 6e63 652e 636c 6f73 6528 290a 0a20 2020  nce.close()..   
+0000df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df80: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+0000df90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000dfa0: 2020 2020 2020 2020 2020 2020 2020 2762                'b
+0000dfb0: 6c6f 636b 5f68 6569 6768 7427 3a20 626c  lock_height': bl
+0000dfc0: 6f63 6b5f 6c61 7374 5b30 5d2c 0a20 2020  ock_last[0],.   
+0000dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfe0: 2020 2020 2020 2020 2027 7469 6d65 7374           'timest
+0000dff0: 616d 7027 3a20 626c 6f63 6b5f 6c61 7374  amp': block_last
+0000e000: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
 0000e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e020: 2020 2020 2020 2023 2073 656e 6428 7365         # send(se
-0000e030: 6c66 2e72 6571 7565 7374 2c20 6261 6c61  lf.request, bala
-0000e040: 6e63 655f 7072 6529 2020 2320 7265 7475  nce_pre)  # retu
-0000e050: 726e 2062 616c 616e 6365 206f 6620 7468  rn balance of th
-0000e060: 6520 6164 6472 6573 7320 746f 2074 6865  e address to the
-0000e070: 2063 6c69 656e 742c 206e 6f20 6d65 6d70   client, no memp
-0000e080: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
-0000e090: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0b0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0000e0c0: 722e 6170 705f 6c6f 672e 696e 666f 2827  r.app_log.info('
-0000e0d0: 7b70 6565 725f 6970 7d20 6e6f 7420 7768  {peer_ip} not wh
-0000e0e0: 6974 656c 6973 7465 6420 666f 7220 6261  itelisted for ba
-0000e0f0: 6c61 6e63 6567 6574 2063 6f6d 6d61 6e64  lanceget command
-0000e100: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0000e110: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
-0000e120: 2027 6261 6c61 6e63 6567 6574 6a73 6f6e   'balancegetjson
-0000e130: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0000e140: 2020 2020 2020 2023 2069 6620 2870 6565         # if (pee
-0000e150: 725f 6970 2069 6e20 616c 6c6f 7765 6420  r_ip in allowed 
-0000e160: 6f72 2022 616e 7922 2069 6e20 616c 6c6f  or "any" in allo
-0000e170: 7765 6429 3a0a 2020 2020 2020 2020 2020  wed):.          
-0000e180: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-0000e190: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-0000e1a0: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
-0000e1b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e1c0: 2020 2020 2020 2020 2020 2062 616c 616e             balan
-0000e1d0: 6365 5f61 6464 7265 7373 203d 2072 6563  ce_address = rec
-0000e1e0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-0000e1f0: 7429 2020 2320 666f 7220 7768 6963 6820  t)  # for which 
-0000e200: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
-0000e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e220: 2062 616c 616e 6365 6765 745f 7265 7375   balanceget_resu
-0000e230: 6c74 203d 2062 616c 616e 6365 6765 7428  lt = balanceget(
-0000e240: 6261 6c61 6e63 655f 6164 6472 6573 732c  balance_address,
-0000e250: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
-0000e260: 616e 6365 290a 2020 2020 2020 2020 2020  ance).          
-0000e270: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000e280: 7370 6f6e 7365 203d 207b 2762 616c 616e  sponse = {'balan
-0000e290: 6365 273a 2062 616c 616e 6365 6765 745f  ce': balanceget_
-0000e2a0: 7265 7375 6c74 5b30 5d2c 2027 6372 6564  result[0], 'cred
-0000e2b0: 6974 273a 2062 616c 616e 6365 6765 745f  it': balanceget_
-0000e2c0: 7265 7375 6c74 5b31 5d2c 2027 6465 6269  result[1], 'debi
-0000e2d0: 7427 3a20 6261 6c61 6e63 6567 6574 5f72  t': balanceget_r
-0000e2e0: 6573 756c 745b 325d 2c20 2766 6565 7327  esult[2], 'fees'
-0000e2f0: 3a20 6261 6c61 6e63 6567 6574 5f72 6573  : balanceget_res
-0000e300: 756c 745b 335d 2c20 2772 6577 6172 6473  ult[3], 'rewards
-0000e310: 273a 2062 616c 616e 6365 6765 745f 7265  ': balanceget_re
-0000e320: 7375 6c74 5b34 5d2c 2027 6261 6c61 6e63  sult[4], 'balanc
-0000e330: 655f 6e6f 5f6d 656d 706f 6f6c 273a 2062  e_no_mempool': b
-0000e340: 616c 616e 6365 6765 745f 7265 7375 6c74  alanceget_result
-0000e350: 5b35 5d7d 0a0a 2020 2020 2020 2020 2020  [5]}..          
-0000e360: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000e370: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-0000e380: 2072 6573 706f 6e73 6529 2020 2320 7265   response)  # re
-0000e390: 7475 726e 2062 616c 616e 6365 206f 6620  turn balance of 
-0000e3a0: 7468 6520 6164 6472 6573 7320 746f 2074  the address to t
-0000e3b0: 6865 2063 6c69 656e 742c 2069 6e63 6c75  he client, inclu
-0000e3c0: 6469 6e67 206d 656d 706f 6f6c 0a20 2020  ding mempool.   
-0000e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3e0: 2020 2020 2023 2073 656e 6428 7365 6c66       # send(self
-0000e3f0: 2e72 6571 7565 7374 2c20 6261 6c61 6e63  .request, balanc
-0000e400: 655f 7072 6529 2020 2320 7265 7475 726e  e_pre)  # return
-0000e410: 2062 616c 616e 6365 206f 6620 7468 6520   balance of the 
-0000e420: 6164 6472 6573 7320 746f 2074 6865 2063  address to the c
-0000e430: 6c69 656e 742c 206e 6f20 6d65 6d70 6f6f  lient, no mempoo
-0000e440: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-0000e450: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e470: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-0000e480: 6170 705f 6c6f 672e 696e 666f 2866 277b  app_log.info(f'{
-0000e490: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
-0000e4a0: 7465 6c69 7374 6564 2066 6f72 2062 616c  telisted for bal
-0000e4b0: 616e 6365 6765 746a 736f 6e20 636f 6d6d  ancegetjson comm
-0000e4c0: 616e 6427 290a 0a20 2020 2020 2020 2020  and')..         
-0000e4d0: 2020 2020 2020 2065 6c69 6620 6461 7461         elif data
-0000e4e0: 203d 3d20 2762 616c 616e 6365 6765 7468   == 'balancegeth
-0000e4f0: 7970 6572 273a 0a20 2020 2020 2020 2020  yper':.         
-0000e500: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-0000e510: 2870 6565 725f 6970 2069 6e20 616c 6c6f  (peer_ip in allo
-0000e520: 7765 6420 6f72 2022 616e 7922 2069 6e20  wed or "any" in 
-0000e530: 616c 6c6f 7765 6429 3a0a 2020 2020 2020  allowed):.      
-0000e540: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e550: 206e 6f64 652e 7065 6572 732e 6973 5f61   node.peers.is_a
-0000e560: 6c6c 6f77 6564 2870 6565 725f 6970 2c20  llowed(peer_ip, 
-0000e570: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
-0000e580: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000e590: 616c 616e 6365 5f61 6464 7265 7373 203d  alance_address =
-0000e5a0: 2072 6563 6569 7665 2873 656c 662e 7265   receive(self.re
-0000e5b0: 7175 6573 7429 2020 2320 666f 7220 7768  quest)  # for wh
-0000e5c0: 6963 6820 6164 6472 6573 730a 0a20 2020  ich address..   
+0000e020: 2027 6164 6472 6573 7327 3a20 626c 6f63   'address': bloc
+0000e030: 6b5f 6c61 7374 5b32 5d2c 0a20 2020 2020  k_last[2],.     
+0000e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e050: 2020 2020 2020 2027 7265 6369 7069 656e         'recipien
+0000e060: 7427 3a20 626c 6f63 6b5f 6c61 7374 5b33  t': block_last[3
+0000e070: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000e080: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e090: 616d 6f75 6e74 273a 2062 6c6f 636b 5f6c  amount': block_l
+0000e0a0: 6173 745b 345d 2c0a 2020 2020 2020 2020  ast[4],.        
+0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0c0: 2020 2020 2773 6967 6e61 7475 7265 273a      'signature':
+0000e0d0: 2062 6c6f 636b 5f6c 6173 745b 355d 2c0a   block_last[5],.
+0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0f0: 2020 2020 2020 2020 2020 2020 2770 7562              'pub
+0000e100: 6c69 635f 6b65 7927 3a20 626c 6f63 6b5f  lic_key': block_
+0000e110: 6c61 7374 5b36 5d2c 0a20 2020 2020 2020  last[6],.       
+0000e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e130: 2020 2020 2027 626c 6f63 6b5f 6861 7368       'block_hash
+0000e140: 273a 2062 6c6f 636b 5f6c 6173 745b 375d  ': block_last[7]
+0000e150: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e160: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+0000e170: 6565 273a 2062 6c6f 636b 5f6c 6173 745b  ee': block_last[
+0000e180: 385d 2c0a 2020 2020 2020 2020 2020 2020  8],.            
+0000e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1a0: 2772 6577 6172 6427 3a20 626c 6f63 6b5f  'reward': block_
+0000e1b0: 6c61 7374 5b39 5d2c 0a20 2020 2020 2020  last[9],.       
+0000e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1d0: 2020 2020 2027 6f70 6572 6174 696f 6e27       'operation'
+0000e1e0: 3a20 626c 6f63 6b5f 6c61 7374 5b31 305d  : block_last[10]
+0000e1f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e200: 2020 2020 2020 2020 2020 2020 2020 276e                'n
+0000e210: 6f6e 6365 273a 2062 6c6f 636b 5f6c 6173  once': block_las
+0000e220: 745b 3131 5d2c 0a20 2020 2020 2020 2020  t[11],.         
+0000e230: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0000e240: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e250: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
+0000e260: 656c 662e 7265 7175 6573 742c 2072 6573  elf.request, res
+0000e270: 706f 6e73 6529 0a20 2020 2020 2020 2020  ponse).         
+0000e280: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000e290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e2a0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+0000e2b0: 6767 6572 2e61 7070 5f6c 6f67 2e64 6562  gger.app_log.deb
+0000e2c0: 7567 2866 277b 7065 6572 5f69 707d 206e  ug(f'{peer_ip} n
+0000e2d0: 6f74 2077 6869 7465 6c69 7374 6564 2066  ot whitelisted f
+0000e2e0: 6f72 2062 6c6f 636b 6c61 7374 6a73 6f6e  or blocklastjson
+0000e2f0: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
+0000e300: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000e310: 2064 6174 6120 3d3d 2027 626c 6f63 6b67   data == 'blockg
+0000e320: 6574 273a 0a20 2020 2020 2020 2020 2020  et':.           
+0000e330: 2020 2020 2020 2020 2023 2069 6620 2870           # if (p
+0000e340: 6565 725f 6970 2069 6e20 616c 6c6f 7765  eer_ip in allowe
+0000e350: 6420 6f72 2022 616e 7922 2069 6e20 616c  d or "any" in al
+0000e360: 6c6f 7765 6429 3a0a 2020 2020 2020 2020  lowed):.        
+0000e370: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000e380: 6f64 652e 7065 6572 732e 6973 5f61 6c6c  ode.peers.is_all
+0000e390: 6f77 6564 2870 6565 725f 6970 2c20 6461  owed(peer_ip, da
+0000e3a0: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+0000e3b0: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
+0000e3c0: 636b 5f64 6573 6972 6564 203d 2072 6563  ck_desired = rec
+0000e3d0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
+0000e3e0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0000e3f0: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+0000e400: 616e 646c 6572 5f69 6e73 7461 6e63 6520  andler_instance 
+0000e410: 3d20 6462 6861 6e64 6c65 722e 4462 4861  = dbhandler.DbHa
+0000e420: 6e64 6c65 7228 6e6f 6465 2e69 6e64 6578  ndler(node.index
+0000e430: 5f64 622c 206e 6f64 652e 6c65 6467 6572  _db, node.ledger
+0000e440: 5f70 6174 682c 206e 6f64 652e 6879 7065  _path, node.hype
+0000e450: 725f 7061 7468 2c20 6e6f 6465 2e72 616d  r_path, node.ram
+0000e460: 2c20 6e6f 6465 2e6c 6564 6765 725f 7261  , node.ledger_ra
+0000e470: 6d5f 6669 6c65 2c20 6e6f 6465 2e6c 6f67  m_file, node.log
+0000e480: 6765 722c 2074 7261 6365 5f64 625f 6361  ger, trace_db_ca
+0000e490: 6c6c 733d 6e6f 6465 2e74 7261 6365 5f64  lls=node.trace_d
+0000e4a0: 625f 6361 6c6c 7329 0a20 2020 2020 2020  b_calls).       
+0000e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4c0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000e4d0: 616e 6365 2e65 7865 6375 7465 5f70 6172  ance.execute_par
+0000e4e0: 616d 2864 625f 6861 6e64 6c65 725f 696e  am(db_handler_in
+0000e4f0: 7374 616e 6365 2e68 2c20 2753 454c 4543  stance.h, 'SELEC
+0000e500: 5420 2a20 4652 4f4d 2074 7261 6e73 6163  T * FROM transac
+0000e510: 7469 6f6e 7320 5748 4552 4520 626c 6f63  tions WHERE bloc
+0000e520: 6b5f 6865 6967 6874 203d 203f 3b27 2c20  k_height = ?;', 
+0000e530: 2862 6c6f 636b 5f64 6573 6972 6564 2c20  (block_desired, 
+0000e540: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000e550: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+0000e560: 5f64 6573 6972 6564 5f72 6573 756c 7420  _desired_result 
+0000e570: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
+0000e580: 7461 6e63 652e 682e 6665 7463 6861 6c6c  tance.h.fetchall
+0000e590: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000e5a0: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+0000e5b0: 6e64 6c65 725f 696e 7374 616e 6365 2e63  ndler_instance.c
+0000e5c0: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
 0000e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5e0: 2020 2020 2062 616c 616e 6365 6765 745f       balanceget_
-0000e5f0: 7265 7375 6c74 203d 2062 616c 616e 6365  result = balance
-0000e600: 6765 7428 6261 6c61 6e63 655f 6164 6472  get(balance_addr
-0000e610: 6573 732c 2064 625f 6861 6e64 6c65 725f  ess, db_handler_
-0000e620: 696e 7374 616e 6365 295b 305d 0a0a 2020  instance)[0]..  
-0000e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e640: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
-0000e650: 7265 7175 6573 742c 2062 616c 616e 6365  request, balance
-0000e660: 6765 745f 7265 7375 6c74 2920 2023 2072  get_result)  # r
-0000e670: 6574 7572 6e20 6261 6c61 6e63 6520 6f66  eturn balance of
-0000e680: 2074 6865 2061 6464 7265 7373 2074 6f20   the address to 
-0000e690: 7468 6520 636c 6965 6e74 2c20 696e 636c  the client, incl
-0000e6a0: 7564 696e 6720 6d65 6d70 6f6f 6c0a 2020  uding mempool.  
-0000e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6c0: 2020 2020 2020 2320 7365 6e64 2873 656c        # send(sel
-0000e6d0: 662e 7265 7175 6573 742c 2062 616c 616e  f.request, balan
-0000e6e0: 6365 5f70 7265 2920 2023 2072 6574 7572  ce_pre)  # retur
-0000e6f0: 6e20 6261 6c61 6e63 6520 6f66 2074 6865  n balance of the
-0000e700: 2061 6464 7265 7373 2074 6f20 7468 6520   address to the 
-0000e710: 636c 6965 6e74 2c20 6e6f 206d 656d 706f  client, no mempo
-0000e720: 6f6c 0a20 2020 2020 2020 2020 2020 2020  ol.             
-0000e730: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e750: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-0000e760: 2e61 7070 5f6c 6f67 2e69 6e66 6f28 6627  .app_log.info(f'
-0000e770: 7b70 6565 725f 6970 7d20 6e6f 7420 7768  {peer_ip} not wh
-0000e780: 6974 656c 6973 7465 6420 666f 7220 6261  itelisted for ba
-0000e790: 6c61 6e63 6567 6574 6a73 6f6e 2063 6f6d  lancegetjson com
-0000e7a0: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-0000e7b0: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-0000e7c0: 6120 3d3d 2027 6261 6c61 6e63 6567 6574  a == 'balanceget
-0000e7d0: 6879 7065 726a 736f 6e27 3a0a 2020 2020  hyperjson':.    
-0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7f0: 6966 206e 6f64 652e 7065 6572 732e 6973  if node.peers.is
-0000e800: 5f61 6c6c 6f77 6564 2870 6565 725f 6970  _allowed(peer_ip
-0000e810: 2c20 6461 7461 293a 0a20 2020 2020 2020  , data):.       
-0000e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e830: 2062 616c 616e 6365 5f61 6464 7265 7373   balance_address
-0000e840: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-0000e850: 7265 7175 6573 7429 2020 2320 666f 7220  request)  # for 
-0000e860: 7768 6963 6820 6164 6472 6573 730a 0a20  which address.. 
-0000e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e880: 2020 2020 2020 2062 616c 616e 6365 6765         balancege
-0000e890: 745f 7265 7375 6c74 203d 2062 616c 616e  t_result = balan
-0000e8a0: 6365 6765 7428 6261 6c61 6e63 655f 6164  ceget(balance_ad
-0000e8b0: 6472 6573 732c 2064 625f 6861 6e64 6c65  dress, db_handle
-0000e8c0: 725f 696e 7374 616e 6365 290a 2020 2020  r_instance).    
-0000e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8e0: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
-0000e8f0: 2762 616c 616e 6365 273a 2062 616c 616e  'balance': balan
-0000e900: 6365 6765 745f 7265 7375 6c74 5b30 5d7d  ceget_result[0]}
-0000e910: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000e920: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
-0000e930: 656c 662e 7265 7175 6573 742c 2072 6573  elf.request, res
-0000e940: 706f 6e73 6529 2020 2320 7265 7475 726e  ponse)  # return
-0000e950: 2062 616c 616e 6365 206f 6620 7468 6520   balance of the 
-0000e960: 6164 6472 6573 7320 746f 2074 6865 2063  address to the c
-0000e970: 6c69 656e 742c 2069 6e63 6c75 6469 6e67  lient, including
-0000e980: 206d 656d 706f 6f6c 0a20 2020 2020 2020   mempool.       
-0000e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9a0: 2023 2073 656e 6428 7365 6c66 2e72 6571   # send(self.req
-0000e9b0: 7565 7374 2c20 6261 6c61 6e63 655f 7072  uest, balance_pr
-0000e9c0: 6529 2020 2320 7265 7475 726e 2062 616c  e)  # return bal
-0000e9d0: 616e 6365 206f 6620 7468 6520 6164 6472  ance of the addr
-0000e9e0: 6573 7320 746f 2074 6865 2063 6c69 656e  ess to the clien
-0000e9f0: 742c 206e 6f20 6d65 6d70 6f6f 6c0a 2020  t, no mempool.  
-0000ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea30: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-0000ea40: 6c6f 672e 696e 666f 2866 277b 7065 6572  log.info(f'{peer
-0000ea50: 5f69 707d 206e 6f74 2077 6869 7465 6c69  _ip} not whiteli
-0000ea60: 7374 6564 2066 6f72 2062 616c 616e 6365  sted for balance
-0000ea70: 6765 7468 7970 6572 6a73 6f6e 2063 6f6d  gethyperjson com
-0000ea80: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-0000ea90: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-0000eaa0: 6120 3d3d 2027 6d70 6765 746a 736f 6e27  a == 'mpgetjson'
-0000eab0: 2061 6e64 206e 6f64 652e 7065 6572 732e   and node.peers.
-0000eac0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
-0000ead0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
-0000eae0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000eaf0: 656d 706f 6f6c 5f74 7873 203d 206d 702e  empool_txs = mp.
-0000eb00: 4d45 4d50 4f4f 4c2e 6665 7463 6861 6c6c  MEMPOOL.fetchall
-0000eb10: 286d 702e 5351 4c5f 5345 4c45 4354 5f54  (mp.SQL_SELECT_T
-0000eb20: 585f 544f 5f53 454e 4429 0a0a 2020 2020  X_TO_SEND)..    
-0000eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb40: 7265 7370 6f6e 7365 5f6c 6973 7420 3d20  response_list = 
-0000eb50: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-0000eb60: 2020 2020 2020 2066 6f72 2074 7261 6e73         for trans
-0000eb70: 6163 7469 6f6e 2069 6e20 6d65 6d70 6f6f  action in mempoo
-0000eb80: 6c5f 7478 733a 0a20 2020 2020 2020 2020  l_txs:.         
-0000eb90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000eba0: 6573 706f 6e73 6520 3d20 7b0a 2020 2020  esponse = {.    
-0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebc0: 2020 2020 2020 2020 2774 696d 6573 7461          'timesta
-0000ebd0: 6d70 273a 2074 7261 6e73 6163 7469 6f6e  mp': transaction
-0000ebe0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec00: 2027 6164 6472 6573 7327 3a20 7472 616e   'address': tran
-0000ec10: 7361 6374 696f 6e5b 315d 2c0a 2020 2020  saction[1],.    
-0000ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec30: 2020 2020 2020 2020 2772 6563 6970 6965          'recipie
-0000ec40: 6e74 273a 2074 7261 6e73 6163 7469 6f6e  nt': transaction
-0000ec50: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
-0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec70: 2027 616d 6f75 6e74 273a 2074 7261 6e73   'amount': trans
-0000ec80: 6163 7469 6f6e 5b33 5d2c 0a20 2020 2020  action[3],.     
+0000e5e0: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
+0000e5f0: 742c 2062 6c6f 636b 5f64 6573 6972 6564  t, block_desired
+0000e600: 5f72 6573 756c 7429 0a20 2020 2020 2020  _result).       
+0000e610: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000e620: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e630: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0000e640: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e64  logger.app_log.d
+0000e650: 6562 7567 2866 277b 7065 6572 5f69 707d  ebug(f'{peer_ip}
+0000e660: 206e 6f74 2077 6869 7465 6c69 7374 6564   not whitelisted
+0000e670: 2066 6f72 2062 6c6f 636b 6765 7420 636f   for blockget co
+0000e680: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
+0000e690: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
+0000e6a0: 7461 203d 3d20 2762 6c6f 636b 6765 746a  ta == 'blockgetj
+0000e6b0: 736f 6e27 3a0a 2020 2020 2020 2020 2020  son':.          
+0000e6c0: 2020 2020 2020 2020 2020 2320 6966 2028            # if (
+0000e6d0: 7065 6572 5f69 7020 696e 2061 6c6c 6f77  peer_ip in allow
+0000e6e0: 6564 206f 7220 2261 6e79 2220 696e 2061  ed or "any" in a
+0000e6f0: 6c6c 6f77 6564 293a 0a20 2020 2020 2020  llowed):.       
+0000e700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000e710: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
+0000e720: 6c6f 7765 6428 7065 6572 5f69 702c 2064  lowed(peer_ip, d
+0000e730: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+0000e740: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+0000e750: 6f63 6b5f 6465 7369 7265 6420 3d20 7265  ock_desired = re
+0000e760: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
+0000e770: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
+0000e780: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+0000e790: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+0000e7a0: 203d 2064 6268 616e 646c 6572 2e44 6248   = dbhandler.DbH
+0000e7b0: 616e 646c 6572 286e 6f64 652e 696e 6465  andler(node.inde
+0000e7c0: 785f 6462 2c20 6e6f 6465 2e6c 6564 6765  x_db, node.ledge
+0000e7d0: 725f 7061 7468 2c20 6e6f 6465 2e68 7970  r_path, node.hyp
+0000e7e0: 6572 5f70 6174 682c 206e 6f64 652e 7261  er_path, node.ra
+0000e7f0: 6d2c 206e 6f64 652e 6c65 6467 6572 5f72  m, node.ledger_r
+0000e800: 616d 5f66 696c 652c 206e 6f64 652e 6c6f  am_file, node.lo
+0000e810: 6767 6572 2c20 7472 6163 655f 6462 5f63  gger, trace_db_c
+0000e820: 616c 6c73 3d6e 6f64 652e 7472 6163 655f  alls=node.trace_
+0000e830: 6462 5f63 616c 6c73 290a 2020 2020 2020  db_calls).      
+0000e840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e850: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+0000e860: 7461 6e63 652e 6578 6563 7574 655f 7061  tance.execute_pa
+0000e870: 7261 6d28 6462 5f68 616e 646c 6572 5f69  ram(db_handler_i
+0000e880: 6e73 7461 6e63 652e 682c 2027 5345 4c45  nstance.h, 'SELE
+0000e890: 4354 202a 2046 524f 4d20 7472 616e 7361  CT * FROM transa
+0000e8a0: 6374 696f 6e73 2057 4845 5245 2062 6c6f  ctions WHERE blo
+0000e8b0: 636b 5f68 6569 6768 7420 3d20 3f3b 272c  ck_height = ?;',
+0000e8c0: 2028 626c 6f63 6b5f 6465 7369 7265 642c   (block_desired,
+0000e8d0: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
+0000e8e0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+0000e8f0: 6b5f 6465 7369 7265 645f 7265 7375 6c74  k_desired_result
+0000e900: 203d 2064 625f 6861 6e64 6c65 725f 696e   = db_handler_in
+0000e910: 7374 616e 6365 2e68 2e66 6574 6368 616c  stance.h.fetchal
+0000e920: 6c28 290a 2020 2020 2020 2020 2020 2020  l().            
+0000e930: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+0000e940: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+0000e950: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+0000e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e970: 2072 6573 706f 6e73 655f 6c69 7374 203d   response_list =
+0000e980: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0000e990: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000e9a0: 7472 616e 7361 6374 696f 6e20 696e 2062  transaction in b
+0000e9b0: 6c6f 636b 5f64 6573 6972 6564 5f72 6573  lock_desired_res
+0000e9c0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9e0: 2072 6573 706f 6e73 6520 3d20 7b0a 2020   response = {.  
+0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 2762                'b
+0000ea10: 6c6f 636b 5f68 6569 6768 7427 3a20 7472  lock_height': tr
+0000ea20: 616e 7361 6374 696f 6e5b 305d 2c0a 2020  ansaction[0],.  
+0000ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea40: 2020 2020 2020 2020 2020 2020 2020 2774                't
+0000ea50: 696d 6573 7461 6d70 273a 2074 7261 6e73  imestamp': trans
+0000ea60: 6163 7469 6f6e 5b31 5d2c 0a20 2020 2020  action[1],.     
+0000ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea80: 2020 2020 2020 2020 2020 2027 6164 6472             'addr
+0000ea90: 6573 7327 3a20 7472 616e 7361 6374 696f  ess': transactio
+0000eaa0: 6e5b 325d 2c0a 2020 2020 2020 2020 2020  n[2],.          
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eac0: 2020 2020 2020 2772 6563 6970 6965 6e74        'recipient
+0000ead0: 273a 2074 7261 6e73 6163 7469 6f6e 5b33  ': transaction[3
+0000eae0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb00: 2020 2027 616d 6f75 6e74 273a 2074 7261     'amount': tra
+0000eb10: 6e73 6163 7469 6f6e 5b34 5d2c 0a20 2020  nsaction[4],.   
+0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb30: 2020 2020 2020 2020 2020 2020 2027 7369               'si
+0000eb40: 676e 6174 7572 6527 3a20 7472 616e 7361  gnature': transa
+0000eb50: 6374 696f 6e5b 355d 2c0a 2020 2020 2020  ction[5],.      
+0000eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb70: 2020 2020 2020 2020 2020 2770 7562 6c69            'publi
+0000eb80: 635f 6b65 7927 3a20 7472 616e 7361 6374  c_key': transact
+0000eb90: 696f 6e5b 365d 2c0a 2020 2020 2020 2020  ion[6],.        
+0000eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebb0: 2020 2020 2020 2020 2762 6c6f 636b 5f68          'block_h
+0000ebc0: 6173 6827 3a20 7472 616e 7361 6374 696f  ash': transactio
+0000ebd0: 6e5b 375d 2c0a 2020 2020 2020 2020 2020  n[7],.          
+0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebf0: 2020 2020 2020 2766 6565 273a 2074 7261        'fee': tra
+0000ec00: 6e73 6163 7469 6f6e 5b38 5d2c 0a20 2020  nsaction[8],.   
+0000ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec20: 2020 2020 2020 2020 2020 2020 2027 7265               're
+0000ec30: 7761 7264 273a 2074 7261 6e73 6163 7469  ward': transacti
+0000ec40: 6f6e 5b39 5d2c 0a20 2020 2020 2020 2020  on[9],.         
+0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec60: 2020 2020 2020 2027 6f70 6572 6174 696f         'operatio
+0000ec70: 6e27 3a20 7472 616e 7361 6374 696f 6e5b  n': transaction[
+0000ec80: 3130 5d2c 0a20 2020 2020 2020 2020 2020  10],.           
 0000ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eca0: 2020 2020 2020 2027 7369 676e 6174 7572         'signatur
-0000ecb0: 6527 3a20 7472 616e 7361 6374 696f 6e5b  e': transaction[
-0000ecc0: 345d 2c0a 2020 2020 2020 2020 2020 2020  4],.            
-0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ece0: 2770 7562 6c69 635f 6b65 7927 3a20 7472  'public_key': tr
-0000ecf0: 616e 7361 6374 696f 6e5b 355d 2c0a 2020  ansaction[5],.  
-0000ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed10: 2020 2020 2020 2020 2020 276f 7065 7261            'opera
-0000ed20: 7469 6f6e 273a 2074 7261 6e73 6163 7469  tion': transacti
-0000ed30: 6f6e 5b36 5d2c 0a20 2020 2020 2020 2020  on[6],.         
-0000ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed50: 2020 2027 6f70 656e 6669 656c 6427 3a20     'openfield': 
-0000ed60: 7472 616e 7361 6374 696f 6e5b 375d 2c0a  transaction[7],.
-0000ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed80: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0000ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eda0: 2020 2072 6573 706f 6e73 655f 6c69 7374     response_list
-0000edb0: 2e61 7070 656e 6428 7265 7370 6f6e 7365  .append(response
-0000edc0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000edd0: 2020 2020 2020 2023 206e 6f64 652e 6c6f         # node.lo
-0000ede0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-0000edf0: 6f28 2249 6e62 6f75 6e64 3a20 4578 7472  o("Inbound: Extr
-0000ee00: 6163 7465 6420 6672 6f6d 2074 6865 206d  acted from the m
-0000ee10: 656d 706f 6f6c 3a20 2220 2b20 7374 7228  empool: " + str(
-0000ee20: 6d65 6d70 6f6f 6c5f 7478 7329 2920 2023  mempool_txs))  #
-0000ee30: 2069 6d70 726f 7665 3a20 7379 6e63 2062   improve: sync b
-0000ee40: 6173 6564 206f 6e20 7369 676e 6174 7572  ased on signatur
-0000ee50: 6573 206f 6e6c 790a 0a20 2020 2020 2020  es only..       
-0000ee60: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-0000ee70: 6620 6c65 6e28 6d65 6d70 6f6f 6c5f 7478  f len(mempool_tx
-0000ee80: 7329 203e 2030 3a20 2377 6f6e 7420 7379  s) > 0: #wont sy
-0000ee90: 6e63 206d 656d 706f 6f6c 2075 6e74 696c  nc mempool until
-0000eea0: 2077 6520 7365 6e64 2073 6f6d 6574 6869   we send somethi
-0000eeb0: 6e67 2c20 7768 6963 6820 6973 2062 6164  ng, which is bad
-0000eec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eed0: 2020 2020 2023 2073 656e 6420 6f77 6e0a       # send own.
-0000eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eef0: 2020 2020 7365 6e64 2873 656c 662e 7265      send(self.re
-0000ef00: 7175 6573 742c 2072 6573 706f 6e73 655f  quest, response_
-0000ef10: 6c69 7374 290a 0a20 2020 2020 2020 2020  list)..         
-0000ef20: 2020 2020 2020 2065 6c69 6620 6461 7461         elif data
-0000ef30: 203d 3d20 276d 7067 6574 2720 616e 6420   == 'mpget' and 
-0000ef40: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
-0000ef50: 6c6f 7765 6428 7065 6572 5f69 702c 2064  lowed(peer_ip, d
-0000ef60: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
-0000ef70: 2020 2020 2020 2020 2020 6d65 6d70 6f6f            mempoo
-0000ef80: 6c5f 7478 7320 3d20 6d70 2e4d 454d 504f  l_txs = mp.MEMPO
-0000ef90: 4f4c 2e66 6574 6368 616c 6c28 6d70 2e53  OL.fetchall(mp.S
-0000efa0: 514c 5f53 454c 4543 545f 5458 5f54 4f5f  QL_SELECT_TX_TO_
-0000efb0: 5345 4e44 290a 0a20 2020 2020 2020 2020  SEND)..         
-0000efc0: 2020 2020 2020 2020 2020 2023 206e 6f64             # nod
-0000efd0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-0000efe0: 2e69 6e66 6f28 2249 6e62 6f75 6e64 3a20  .info("Inbound: 
-0000eff0: 4578 7472 6163 7465 6420 6672 6f6d 2074  Extracted from t
-0000f000: 6865 206d 656d 706f 6f6c 3a20 2220 2b20  he mempool: " + 
-0000f010: 7374 7228 6d65 6d70 6f6f 6c5f 7478 7329  str(mempool_txs)
-0000f020: 2920 2023 2069 6d70 726f 7665 3a20 7379  )  # improve: sy
-0000f030: 6e63 2062 6173 6564 206f 6e20 7369 676e  nc based on sign
-0000f040: 6174 7572 6573 206f 6e6c 790a 0a20 2020  atures only..   
-0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f060: 2023 2069 6620 6c65 6e28 6d65 6d70 6f6f   # if len(mempoo
-0000f070: 6c5f 7478 7329 203e 2030 3a20 2377 6f6e  l_txs) > 0: #won
-0000f080: 7420 7379 6e63 206d 656d 706f 6f6c 2075  t sync mempool u
-0000f090: 6e74 696c 2077 6520 7365 6e64 2073 6f6d  ntil we send som
-0000f0a0: 6574 6869 6e67 2c20 7768 6963 6820 6973  ething, which is
-0000f0b0: 2062 6164 0a20 2020 2020 2020 2020 2020   bad.           
-0000f0c0: 2020 2020 2020 2020 2023 2073 656e 6420           # send 
-0000f0d0: 6f77 6e0a 2020 2020 2020 2020 2020 2020  own.            
-0000f0e0: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
-0000f0f0: 662e 7265 7175 6573 742c 206d 656d 706f  f.request, mempo
-0000f100: 6f6c 5f74 7873 290a 0a20 2020 2020 2020  ol_txs)..       
-0000f110: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
-0000f120: 7461 203d 3d20 276d 7063 6c65 6172 2720  ta == 'mpclear' 
-0000f130: 616e 6420 7065 6572 5f69 7020 3d3d 2027  and peer_ip == '
-0000f140: 3132 372e 302e 302e 3127 3a20 2023 2072  127.0.0.1':  # r
-0000f150: 6573 6572 7665 6420 666f 7220 6c6f 6361  eserved for loca
-0000f160: 6c68 6f73 740a 2020 2020 2020 2020 2020  lhost.          
-0000f170: 2020 2020 2020 2020 2020 6d70 2e4d 454d            mp.MEM
-0000f180: 504f 4f4c 2e63 6c65 6172 2829 0a0a 2020  POOL.clear()..  
-0000f190: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000f1a0: 6966 2064 6174 6120 3d3d 2027 6b65 7967  if data == 'keyg
-0000f1b0: 656e 273a 0a20 2020 2020 2020 2020 2020  en':.           
-0000f1c0: 2020 2020 2020 2020 2023 2069 6620 2870           # if (p
-0000f1d0: 6565 725f 6970 2069 6e20 616c 6c6f 7765  eer_ip in allowe
-0000f1e0: 6420 6f72 2022 616e 7922 2069 6e20 616c  d or "any" in al
-0000f1f0: 6c6f 7765 6429 3a0a 2020 2020 2020 2020  lowed):.        
-0000f200: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000f210: 6f64 652e 7065 6572 732e 6973 5f61 6c6c  ode.peers.is_all
-0000f220: 6f77 6564 2870 6565 725f 6970 2c20 6461  owed(peer_ip, da
-0000f230: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-0000f240: 2020 2020 2020 2020 2020 2020 2028 6765               (ge
-0000f250: 6e5f 7072 6976 6174 655f 6b65 795f 7265  n_private_key_re
-0000f260: 6164 6162 6c65 2c20 6765 6e5f 7075 626c  adable, gen_publ
-0000f270: 6963 5f6b 6579 5f72 6561 6461 626c 652c  ic_key_readable,
-0000f280: 2067 656e 5f61 6464 7265 7373 2920 3d20   gen_address) = 
-0000f290: 7761 6c6c 6574 5f6b 6579 732e 6765 6e65  wallet_keys.gene
-0000f2a0: 7261 7465 2829 0a20 2020 2020 2020 2020  rate().         
-0000f2b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f2c0: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-0000f2d0: 2c20 2867 656e 5f70 7269 7661 7465 5f6b  , (gen_private_k
-0000f2e0: 6579 5f72 6561 6461 626c 652c 2067 656e  ey_readable, gen
-0000f2f0: 5f70 7562 6c69 635f 6b65 795f 7265 6164  _public_key_read
-0000f300: 6162 6c65 2c20 6765 6e5f 6164 6472 6573  able, gen_addres
-0000f310: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0000f320: 2020 2020 2020 2020 2020 2020 2867 656e              (gen
-0000f330: 5f70 7269 7661 7465 5f6b 6579 5f72 6561  _private_key_rea
-0000f340: 6461 626c 652c 2067 656e 5f70 7562 6c69  dable, gen_publi
-0000f350: 635f 6b65 795f 7265 6164 6162 6c65 2c20  c_key_readable, 
-0000f360: 6765 6e5f 6164 6472 6573 7329 203d 2028  gen_address) = (
-0000f370: 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f 6e65  None, None, None
-0000f380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f390: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3b0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-0000f3c0: 6170 705f 6c6f 672e 696e 666f 2866 277b  app_log.info(f'{
-0000f3d0: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
-0000f3e0: 7465 6c69 7374 6564 2066 6f72 206b 6579  telisted for key
-0000f3f0: 6765 6e20 636f 6d6d 616e 6427 290a 0a20  gen command').. 
-0000f400: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f410: 6c69 6620 6461 7461 203d 3d20 276b 6579  lif data == 'key
-0000f420: 6765 6e6a 736f 6e27 3a0a 2020 2020 2020  genjson':.      
-0000f430: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000f440: 6966 2028 7065 6572 5f69 7020 696e 2061  if (peer_ip in a
-0000f450: 6c6c 6f77 6564 206f 7220 2261 6e79 2220  llowed or "any" 
-0000f460: 696e 2061 6c6c 6f77 6564 293a 0a20 2020  in allowed):.   
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
-0000f490: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
-0000f4a0: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
-0000f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4c0: 2020 2867 656e 5f70 7269 7661 7465 5f6b    (gen_private_k
-0000f4d0: 6579 5f72 6561 6461 626c 652c 2067 656e  ey_readable, gen
-0000f4e0: 5f70 7562 6c69 635f 6b65 795f 7265 6164  _public_key_read
-0000f4f0: 6162 6c65 2c20 6765 6e5f 6164 6472 6573  able, gen_addres
-0000f500: 7329 203d 2077 616c 6c65 745f 6b65 7973  s) = wallet_keys
-0000f510: 2e67 656e 6572 6174 6528 290a 2020 2020  .generate().    
-0000f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f530: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
-0000f540: 2770 7269 7661 7465 5f6b 6579 273a 2067  'private_key': g
-0000f550: 656e 5f70 7269 7661 7465 5f6b 6579 5f72  en_private_key_r
-0000f560: 6561 6461 626c 652c 2027 7075 626c 6963  eadable, 'public
-0000f570: 5f6b 6579 273a 2067 656e 5f70 7562 6c69  _key': gen_publi
-0000f580: 635f 6b65 795f 7265 6164 6162 6c65 2c20  c_key_readable, 
-0000f590: 2761 6464 7265 7373 273a 2067 656e 5f61  'address': gen_a
-0000f5a0: 6464 7265 7373 7d0a 0a20 2020 2020 2020  ddress}..       
-0000f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5c0: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
-0000f5d0: 7374 2c20 7265 7370 6f6e 7365 290a 2020  st, response).  
-0000f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5f0: 2020 2020 2020 2867 656e 5f70 7269 7661        (gen_priva
-0000f600: 7465 5f6b 6579 5f72 6561 6461 626c 652c  te_key_readable,
-0000f610: 2067 656e 5f70 7562 6c69 635f 6b65 795f   gen_public_key_
-0000f620: 7265 6164 6162 6c65 2c20 6765 6e5f 6164  readable, gen_ad
-0000f630: 6472 6573 7329 203d 2028 4e6f 6e65 2c20  dress) = (None, 
-0000f640: 4e6f 6e65 2c20 4e6f 6e65 290a 2020 2020  None, None).    
-0000f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f660: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f670: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0000f680: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-0000f690: 672e 696e 666f 2866 277b 7065 6572 5f69  g.info(f'{peer_i
-0000f6a0: 707d 206e 6f74 2077 6869 7465 6c69 7374  p} not whitelist
-0000f6b0: 6564 2066 6f72 206b 6579 6765 6e20 636f  ed for keygen co
-0000f6c0: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
-0000f6d0: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
-0000f6e0: 7461 203d 3d20 2761 6464 6c69 7374 273a  ta == 'addlist':
-0000f6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f700: 2020 2020 2023 2069 6620 2870 6565 725f       # if (peer_
-0000f710: 6970 2069 6e20 616c 6c6f 7765 6420 6f72  ip in allowed or
-0000f720: 2022 616e 7922 2069 6e20 616c 6c6f 7765   "any" in allowe
-0000f730: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
-0000f740: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-0000f750: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
-0000f760: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
-0000f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f780: 2020 2020 2020 2020 2061 6464 7265 7373           address
-0000f790: 5f74 785f 6c69 7374 203d 2072 6563 6569  _tx_list = recei
-0000f7a0: 7665 2873 656c 662e 7265 7175 6573 7429  ve(self.request)
-0000f7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f7c0: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
-0000f7d0: 6c65 725f 696e 7374 616e 6365 2e65 7865  ler_instance.exe
-0000f7e0: 6375 7465 5f70 6172 616d 280a 2020 2020  cute_param(.    
-0000f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f800: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
-0000f810: 6572 5f69 6e73 7461 6e63 652e 682c 0a20  er_instance.h,. 
-0000f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f830: 2020 2020 2020 2020 2020 2028 2753 454c             ('SEL
-0000f840: 4543 5420 2a20 4652 4f4d 2074 7261 6e73  ECT * FROM trans
-0000f850: 6163 7469 6f6e 7320 5748 4552 4520 2861  actions WHERE (a
-0000f860: 6464 7265 7373 203d 203f 204f 5220 7265  ddress = ? OR re
-0000f870: 6369 7069 656e 7420 3d20 3f29 204f 5244  cipient = ?) ORD
-0000f880: 4552 2042 5920 626c 6f63 6b5f 6865 6967  ER BY block_heig
-0000f890: 6874 2044 4553 4327 292c 0a20 2020 2020  ht DESC'),.     
-0000f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8b0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-0000f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8d0: 2020 2020 2020 2020 2061 6464 7265 7373           address
-0000f8e0: 5f74 785f 6c69 7374 2c0a 2020 2020 2020  _tx_list,.      
-0000f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f900: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-0000f910: 735f 7478 5f6c 6973 742c 0a20 2020 2020  s_tx_list,.     
-0000f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f930: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f950: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000f960: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0000f970: 6c74 203d 2064 625f 6861 6e64 6c65 725f  lt = db_handler_
-0000f980: 696e 7374 616e 6365 2e68 2e66 6574 6368  instance.h.fetch
-0000f990: 616c 6c28 290a 2020 2020 2020 2020 2020  all().          
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000f9b0: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-0000f9c0: 2072 6573 756c 7429 0a20 2020 2020 2020   result).       
-0000f9d0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000f9e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000f9f0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0000fa00: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-0000fa10: 6e66 6f28 6627 7b70 6565 725f 6970 7d20  nfo(f'{peer_ip} 
-0000fa20: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
-0000fa30: 666f 7220 6164 646c 6973 7420 636f 6d6d  for addlist comm
-0000fa40: 616e 6427 290a 0a20 2020 2020 2020 2020  and')..         
-0000fa50: 2020 2020 2020 2065 6c69 6620 6461 7461         elif data
-0000fa60: 203d 3d20 276c 6973 746c 696d 6a73 6f6e   == 'listlimjson
-0000fa70: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0000fa80: 2020 2020 2020 2023 2069 6620 2870 6565         # if (pee
-0000fa90: 725f 6970 2069 6e20 616c 6c6f 7765 6420  r_ip in allowed 
-0000faa0: 6f72 2022 616e 7922 2069 6e20 616c 6c6f  or "any" in allo
-0000fab0: 7765 6429 3a0a 2020 2020 2020 2020 2020  wed):.          
-0000fac0: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-0000fad0: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-0000fae0: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
-0000faf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000fb00: 2020 2020 2020 2020 2020 206c 6973 745f             list_
-0000fb10: 6c69 6d69 7420 3d20 7265 6365 6976 6528  limit = receive(
-0000fb20: 7365 6c66 2e72 6571 7565 7374 290a 2020  self.request).  
-0000fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb40: 2020 2020 2020 2320 7072 696e 7428 6164        # print(ad
-0000fb50: 6472 6573 735f 7478 5f6c 6973 745f 6c69  dress_tx_list_li
-0000fb60: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
-0000fb70: 2020 2020 2020 2020 2020 2020 2064 625f               db_
-0000fb80: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
-0000fb90: 2e65 7865 6375 7465 5f70 6172 616d 2864  .execute_param(d
-0000fba0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-0000fbb0: 6365 2e68 2c20 2753 454c 4543 5420 2a20  ce.h, 'SELECT * 
-0000fbc0: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-0000fbd0: 7320 4f52 4445 5220 4259 2062 6c6f 636b  s ORDER BY block
-0000fbe0: 5f68 6569 6768 7420 4445 5343 204c 494d  _height DESC LIM
-0000fbf0: 4954 203f 272c 2028 6c69 7374 5f6c 696d  IT ?', (list_lim
-0000fc00: 6974 2c20 2929 0a20 2020 2020 2020 2020  it, )).         
-0000fc10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000fc20: 6573 756c 7420 3d20 6462 5f68 616e 646c  esult = db_handl
-0000fc30: 6572 5f69 6e73 7461 6e63 652e 682e 6665  er_instance.h.fe
-0000fc40: 7463 6861 6c6c 2829 0a0a 2020 2020 2020  tchall()..      
-0000fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc60: 2020 7265 7370 6f6e 7365 5f6c 6973 7420    response_list 
-0000fc70: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-0000fc80: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000fc90: 2074 7261 6e73 6163 7469 6f6e 2069 6e20   transaction in 
-0000fca0: 7265 7375 6c74 3a0a 2020 2020 2020 2020  result:.        
-0000fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcc0: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
-0000fcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcf0: 2027 626c 6f63 6b5f 6865 6967 6874 273a   'block_height':
-0000fd00: 2074 7261 6e73 6163 7469 6f6e 5b30 5d2c   transaction[0],
-0000fd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd30: 2027 7469 6d65 7374 616d 7027 3a20 7472   'timestamp': tr
-0000fd40: 616e 7361 6374 696f 6e5b 315d 2c0a 2020  ansaction[1],.  
-0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd60: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-0000fd70: 6464 7265 7373 273a 2074 7261 6e73 6163  ddress': transac
-0000fd80: 7469 6f6e 5b32 5d2c 0a20 2020 2020 2020  tion[2],.       
-0000fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fda0: 2020 2020 2020 2020 2027 7265 6369 7069           'recipi
-0000fdb0: 656e 7427 3a20 7472 616e 7361 6374 696f  ent': transactio
-0000fdc0: 6e5b 335d 2c0a 2020 2020 2020 2020 2020  n[3],.          
-0000fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fde0: 2020 2020 2020 2761 6d6f 756e 7427 3a20        'amount': 
-0000fdf0: 7472 616e 7361 6374 696f 6e5b 345d 2c0a  transaction[4],.
-0000fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe20: 2773 6967 6e61 7475 7265 273a 2074 7261  'signature': tra
-0000fe30: 6e73 6163 7469 6f6e 5b35 5d2c 0a20 2020  nsaction[5],.   
-0000fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe50: 2020 2020 2020 2020 2020 2020 2027 7075               'pu
-0000fe60: 626c 6963 5f6b 6579 273a 2074 7261 6e73  blic_key': trans
-0000fe70: 6163 7469 6f6e 5b36 5d2c 0a20 2020 2020  action[6],.     
-0000fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe90: 2020 2020 2020 2020 2020 2027 626c 6f63             'bloc
-0000fea0: 6b5f 6861 7368 273a 2074 7261 6e73 6163  k_hash': transac
-0000feb0: 7469 6f6e 5b37 5d2c 0a20 2020 2020 2020  tion[7],.       
-0000fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fed0: 2020 2020 2020 2020 2027 6665 6527 3a20           'fee': 
-0000fee0: 7472 616e 7361 6374 696f 6e5b 385d 2c0a  transaction[8],.
+0000eca0: 2020 2020 2027 6f70 656e 6669 656c 6427       'openfield'
+0000ecb0: 3a20 7472 616e 7361 6374 696f 6e5b 3131  : transaction[11
+0000ecc0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0000ece0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000ecf0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000ed00: 7370 6f6e 7365 5f6c 6973 742e 6170 7065  sponse_list.appe
+0000ed10: 6e64 2872 6573 706f 6e73 6529 0a0a 2020  nd(response)..  
+0000ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed30: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+0000ed40: 7265 7175 6573 742c 2072 6573 706f 6e73  request, respons
+0000ed50: 655f 6c69 7374 290a 2020 2020 2020 2020  e_list).        
+0000ed60: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000ed70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ed80: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+0000ed90: 6f67 6765 722e 6170 705f 6c6f 672e 6465  ogger.app_log.de
+0000eda0: 6275 6728 6627 7b70 6565 725f 6970 7d20  bug(f'{peer_ip} 
+0000edb0: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
+0000edc0: 666f 7220 626c 6f63 6b67 6574 2063 6f6d  for blockget com
+0000edd0: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
+0000ede0: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
+0000edf0: 6120 3d3d 2027 6d70 696e 7365 7274 273a  a == 'mpinsert':
+0000ee00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ee10: 2020 2020 2023 2069 6620 2870 6565 725f       # if (peer_
+0000ee20: 6970 2069 6e20 616c 6c6f 7765 6420 6f72  ip in allowed or
+0000ee30: 2022 616e 7922 2069 6e20 616c 6c6f 7765   "any" in allowe
+0000ee40: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
+0000ee50: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+0000ee60: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
+0000ee70: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
+0000ee80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ee90: 2020 2020 2020 2020 206d 656d 706f 6f6c           mempool
+0000eea0: 5f69 6e73 6572 7420 3d20 7265 6365 6976  _insert = receiv
+0000eeb0: 6528 7365 6c66 2e72 6571 7565 7374 290a  e(self.request).
+0000eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eed0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+0000eee0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
+0000eef0: 696e 6728 276d 7069 6e73 6572 7420 636f  ing('mpinsert co
+0000ef00: 6d6d 616e 6427 290a 2020 2020 2020 2020  mmand').        
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+0000ef30: 6e63 6520 3d20 6462 6861 6e64 6c65 722e  nce = dbhandler.
+0000ef40: 4462 4861 6e64 6c65 7228 6e6f 6465 2e69  DbHandler(node.i
+0000ef50: 6e64 6578 5f64 622c 206e 6f64 652e 6c65  ndex_db, node.le
+0000ef60: 6467 6572 5f70 6174 682c 206e 6f64 652e  dger_path, node.
+0000ef70: 6879 7065 725f 7061 7468 2c20 6e6f 6465  hyper_path, node
+0000ef80: 2e72 616d 2c20 6e6f 6465 2e6c 6564 6765  .ram, node.ledge
+0000ef90: 725f 7261 6d5f 6669 6c65 2c20 6e6f 6465  r_ram_file, node
+0000efa0: 2e6c 6f67 6765 722c 2074 7261 6365 5f64  .logger, trace_d
+0000efb0: 625f 6361 6c6c 733d 6e6f 6465 2e74 7261  b_calls=node.tra
+0000efc0: 6365 5f64 625f 6361 6c6c 7329 0a20 2020  ce_db_calls).   
+0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efe0: 2020 2020 206d 7069 6e73 6572 745f 7265       mpinsert_re
+0000eff0: 7375 6c74 203d 206d 702e 4d45 4d50 4f4f  sult = mp.MEMPOO
+0000f000: 4c2e 6d65 7267 6528 6d65 6d70 6f6f 6c5f  L.merge(mempool_
+0000f010: 696e 7365 7274 2c20 7065 6572 5f69 702c  insert, peer_ip,
+0000f020: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000f030: 616e 6365 2e63 2c20 5472 7565 2c20 5472  ance.c, True, Tr
+0000f040: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0000f050: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+0000f060: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+0000f070: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
+0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f090: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0000f0a0: 6c6f 672e 7761 726e 696e 6728 6627 6d70  log.warning(f'mp
+0000f0b0: 696e 7365 7274 2072 6573 756c 743a 207b  insert result: {
+0000f0c0: 6d70 696e 7365 7274 5f72 6573 756c 747d  mpinsert_result}
+0000f0d0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0000f0e0: 2020 2020 2020 2020 2020 2073 656e 6428             send(
+0000f0f0: 7365 6c66 2e72 6571 7565 7374 2c20 6d70  self.request, mp
+0000f100: 696e 7365 7274 5f72 6573 756c 7429 0a20  insert_result). 
+0000f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f120: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f140: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0000f150: 5f6c 6f67 2e64 6562 7567 2866 277b 7065  _log.debug(f'{pe
+0000f160: 6572 5f69 707d 206e 6f74 2077 6869 7465  er_ip} not white
+0000f170: 6c69 7374 6564 2066 6f72 206d 7069 6e73  listed for mpins
+0000f180: 6572 7420 636f 6d6d 616e 6427 290a 0a20  ert command').. 
+0000f190: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000f1a0: 6c69 6620 6461 7461 203d 3d20 2762 616c  lif data == 'bal
+0000f1b0: 616e 6365 6765 7427 3a0a 2020 2020 2020  anceget':.      
+0000f1c0: 2020 2020 2020 2020 2020 2020 2020 232d                #-
+0000f1d0: 2d2d 2068 616e 646c 6520 6261 6c61 6e63  -- handle balanc
+0000f1e0: 6567 6574 0a20 2020 2020 2020 2020 2020  eget.           
+0000f1f0: 2020 2020 2020 2020 2023 2069 6620 2870           # if (p
+0000f200: 6565 725f 6970 2069 6e20 616c 6c6f 7765  eer_ip in allowe
+0000f210: 6420 6f72 2022 616e 7922 2069 6e20 616c  d or "any" in al
+0000f220: 6c6f 7765 6429 3a0a 2020 2020 2020 2020  lowed):.        
+0000f230: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000f240: 6f64 652e 7065 6572 732e 6973 5f61 6c6c  ode.peers.is_all
+0000f250: 6f77 6564 2870 6565 725f 6970 2c20 6461  owed(peer_ip, da
+0000f260: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+0000f270: 2020 2020 2020 2020 2020 2020 2062 616c               bal
+0000f280: 616e 6365 5f61 6464 7265 7373 203d 2072  ance_address = r
+0000f290: 6563 6569 7665 2873 656c 662e 7265 7175  eceive(self.requ
+0000f2a0: 6573 7429 2020 2320 666f 7220 7768 6963  est)  # for whic
+0000f2b0: 6820 6164 6472 6573 730a 0a20 2020 2020  h address..     
+0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2d0: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+0000f2e0: 7374 616e 6365 203d 2064 6268 616e 646c  stance = dbhandl
+0000f2f0: 6572 2e44 6248 616e 646c 6572 286e 6f64  er.DbHandler(nod
+0000f300: 652e 696e 6465 785f 6462 2c20 6e6f 6465  e.index_db, node
+0000f310: 2e6c 6564 6765 725f 7061 7468 2c20 6e6f  .ledger_path, no
+0000f320: 6465 2e68 7970 6572 5f70 6174 682c 206e  de.hyper_path, n
+0000f330: 6f64 652e 7261 6d2c 206e 6f64 652e 6c65  ode.ram, node.le
+0000f340: 6467 6572 5f72 616d 5f66 696c 652c 206e  dger_ram_file, n
+0000f350: 6f64 652e 6c6f 6767 6572 2c20 7472 6163  ode.logger, trac
+0000f360: 655f 6462 5f63 616c 6c73 3d6e 6f64 652e  e_db_calls=node.
+0000f370: 7472 6163 655f 6462 5f63 616c 6c73 290a  trace_db_calls).
+0000f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f390: 2020 2020 2020 2020 6261 6c61 6e63 6567          balanceg
+0000f3a0: 6574 5f72 6573 756c 7420 3d20 6261 6c61  et_result = bala
+0000f3b0: 6e63 6567 6574 2862 616c 616e 6365 5f61  nceget(balance_a
+0000f3c0: 6464 7265 7373 2c20 6462 5f68 616e 646c  ddress, db_handl
+0000f3d0: 6572 5f69 6e73 7461 6e63 6529 0a20 2020  er_instance).   
+0000f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3f0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+0000f400: 696e 7374 616e 6365 2e63 6c6f 7365 2829  instance.close()
+0000f410: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000f420: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
+0000f430: 656c 662e 7265 7175 6573 742c 2062 616c  elf.request, bal
+0000f440: 616e 6365 6765 745f 7265 7375 6c74 2920  anceget_result) 
+0000f450: 2023 2072 6574 7572 6e20 6261 6c61 6e63   # return balanc
+0000f460: 6520 6f66 2074 6865 2061 6464 7265 7373  e of the address
+0000f470: 2074 6f20 7468 6520 636c 6965 6e74 2c20   to the client, 
+0000f480: 696e 636c 7564 696e 6720 6d65 6d70 6f6f  including mempoo
+0000f490: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+0000f4a0: 2020 2020 2020 2020 2020 2320 7365 6e64            # send
+0000f4b0: 2873 656c 662e 7265 7175 6573 742c 2062  (self.request, b
+0000f4c0: 616c 616e 6365 5f70 7265 2920 2023 2072  alance_pre)  # r
+0000f4d0: 6574 7572 6e20 6261 6c61 6e63 6520 6f66  eturn balance of
+0000f4e0: 2074 6865 2061 6464 7265 7373 2074 6f20   the address to 
+0000f4f0: 7468 6520 636c 6965 6e74 2c20 6e6f 206d  the client, no m
+0000f500: 656d 706f 6f6c 0a20 2020 2020 2020 2020  empool.         
+0000f510: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000f520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f530: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+0000f540: 6767 6572 2e61 7070 5f6c 6f67 2e64 6562  gger.app_log.deb
+0000f550: 7567 2866 277b 7065 6572 5f69 707d 206e  ug(f'{peer_ip} n
+0000f560: 6f74 2077 6869 7465 6c69 7374 6564 2066  ot whitelisted f
+0000f570: 6f72 2062 616c 616e 6365 6765 7420 636f  or balanceget co
+0000f580: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
+0000f590: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
+0000f5a0: 7461 203d 3d20 2762 616c 616e 6365 6765  ta == 'balancege
+0000f5b0: 746a 736f 6e27 3a0a 2020 2020 2020 2020  tjson':.        
+0000f5c0: 2020 2020 2020 2020 2020 2020 2320 6966              # if
+0000f5d0: 2028 7065 6572 5f69 7020 696e 2061 6c6c   (peer_ip in all
+0000f5e0: 6f77 6564 206f 7220 2261 6e79 2220 696e  owed or "any" in
+0000f5f0: 2061 6c6c 6f77 6564 293a 0a20 2020 2020   allowed):.     
+0000f600: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f610: 6620 6e6f 6465 2e70 6565 7273 2e69 735f  f node.peers.is_
+0000f620: 616c 6c6f 7765 6428 7065 6572 5f69 702c  allowed(peer_ip,
+0000f630: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
+0000f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f650: 6261 6c61 6e63 655f 6164 6472 6573 7320  balance_address 
+0000f660: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
+0000f670: 6571 7565 7374 2920 2023 2066 6f72 2077  equest)  # for w
+0000f680: 6869 6368 2061 6464 7265 7373 0a0a 2020  hich address..  
+0000f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6a0: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
+0000f6b0: 5f69 6e73 7461 6e63 6520 3d20 6462 6861  _instance = dbha
+0000f6c0: 6e64 6c65 722e 4462 4861 6e64 6c65 7228  ndler.DbHandler(
+0000f6d0: 6e6f 6465 2e69 6e64 6578 5f64 622c 206e  node.index_db, n
+0000f6e0: 6f64 652e 6c65 6467 6572 5f70 6174 682c  ode.ledger_path,
+0000f6f0: 206e 6f64 652e 6879 7065 725f 7061 7468   node.hyper_path
+0000f700: 2c20 6e6f 6465 2e72 616d 2c20 6e6f 6465  , node.ram, node
+0000f710: 2e6c 6564 6765 725f 7261 6d5f 6669 6c65  .ledger_ram_file
+0000f720: 2c20 6e6f 6465 2e6c 6f67 6765 722c 2074  , node.logger, t
+0000f730: 7261 6365 5f64 625f 6361 6c6c 733d 6e6f  race_db_calls=no
+0000f740: 6465 2e74 7261 6365 5f64 625f 6361 6c6c  de.trace_db_call
+0000f750: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000f760: 2020 2020 2020 2020 2020 2062 616c 616e             balan
+0000f770: 6365 6765 745f 7265 7375 6c74 203d 2062  ceget_result = b
+0000f780: 616c 616e 6365 6765 7428 6261 6c61 6e63  alanceget(balanc
+0000f790: 655f 6164 6472 6573 732c 2064 625f 6861  e_address, db_ha
+0000f7a0: 6e64 6c65 725f 696e 7374 616e 6365 290a  ndler_instance).
+0000f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7c0: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
+0000f7d0: 6572 5f69 6e73 7461 6e63 652e 636c 6f73  er_instance.clos
+0000f7e0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000f7f0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0000f800: 6f6e 7365 203d 207b 2762 616c 616e 6365  onse = {'balance
+0000f810: 273a 2062 616c 616e 6365 6765 745f 7265  ': balanceget_re
+0000f820: 7375 6c74 5b30 5d2c 2027 6372 6564 6974  sult[0], 'credit
+0000f830: 273a 2062 616c 616e 6365 6765 745f 7265  ': balanceget_re
+0000f840: 7375 6c74 5b31 5d2c 2027 6465 6269 7427  sult[1], 'debit'
+0000f850: 3a20 6261 6c61 6e63 6567 6574 5f72 6573  : balanceget_res
+0000f860: 756c 745b 325d 2c20 2766 6565 7327 3a20  ult[2], 'fees': 
+0000f870: 6261 6c61 6e63 6567 6574 5f72 6573 756c  balanceget_resul
+0000f880: 745b 335d 2c20 2772 6577 6172 6473 273a  t[3], 'rewards':
+0000f890: 2062 616c 616e 6365 6765 745f 7265 7375   balanceget_resu
+0000f8a0: 6c74 5b34 5d2c 2027 6261 6c61 6e63 655f  lt[4], 'balance_
+0000f8b0: 6e6f 5f6d 656d 706f 6f6c 273a 2062 616c  no_mempool': bal
+0000f8c0: 616e 6365 6765 745f 7265 7375 6c74 5b35  anceget_result[5
+0000f8d0: 5d7d 0a0a 2020 2020 2020 2020 2020 2020  ]}..            
+0000f8e0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+0000f8f0: 2873 656c 662e 7265 7175 6573 742c 2072  (self.request, r
+0000f900: 6573 706f 6e73 6529 2020 2320 7265 7475  esponse)  # retu
+0000f910: 726e 2062 616c 616e 6365 206f 6620 7468  rn balance of th
+0000f920: 6520 6164 6472 6573 7320 746f 2074 6865  e address to the
+0000f930: 2063 6c69 656e 742c 2069 6e63 6c75 6469   client, includi
+0000f940: 6e67 206d 656d 706f 6f6c 0a20 2020 2020  ng mempool.     
+0000f950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f960: 2020 2023 2073 656e 6428 7365 6c66 2e72     # send(self.r
+0000f970: 6571 7565 7374 2c20 6261 6c61 6e63 655f  equest, balance_
+0000f980: 7072 6529 2020 2320 7265 7475 726e 2062  pre)  # return b
+0000f990: 616c 616e 6365 206f 6620 7468 6520 6164  alance of the ad
+0000f9a0: 6472 6573 7320 746f 2074 6865 2063 6c69  dress to the cli
+0000f9b0: 656e 742c 206e 6f20 6d65 6d70 6f6f 6c0a  ent, no mempool.
+0000f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9f0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+0000fa00: 705f 6c6f 672e 6465 6275 6728 6627 7b70  p_log.debug(f'{p
+0000fa10: 6565 725f 6970 7d20 6e6f 7420 7768 6974  eer_ip} not whit
+0000fa20: 656c 6973 7465 6420 666f 7220 6261 6c61  elisted for bala
+0000fa30: 6e63 6567 6574 6a73 6f6e 2063 6f6d 6d61  ncegetjson comma
+0000fa40: 6e64 2729 0a0a 2020 2020 2020 2020 2020  nd')..          
+0000fa50: 2020 2020 2020 656c 6966 2064 6174 6120        elif data 
+0000fa60: 3d3d 2027 6261 6c61 6e63 6567 6574 6879  == 'balancegethy
+0000fa70: 7065 7227 3a0a 2020 2020 2020 2020 2020  per':.          
+0000fa80: 2020 2020 2020 2020 2020 2320 6966 2028            # if (
+0000fa90: 7065 6572 5f69 7020 696e 2061 6c6c 6f77  peer_ip in allow
+0000faa0: 6564 206f 7220 2261 6e79 2220 696e 2061  ed or "any" in a
+0000fab0: 6c6c 6f77 6564 293a 0a20 2020 2020 2020  llowed):.       
+0000fac0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000fad0: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
+0000fae0: 6c6f 7765 6428 7065 6572 5f69 702c 2064  lowed(peer_ip, d
+0000faf0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+0000fb00: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+0000fb10: 6c61 6e63 655f 6164 6472 6573 7320 3d20  lance_address = 
+0000fb20: 7265 6365 6976 6528 7365 6c66 2e72 6571  receive(self.req
+0000fb30: 7565 7374 2920 2023 2066 6f72 2077 6869  uest)  # for whi
+0000fb40: 6368 2061 6464 7265 7373 0a0a 2020 2020  ch address..    
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+0000fb70: 6e73 7461 6e63 6520 3d20 6462 6861 6e64  nstance = dbhand
+0000fb80: 6c65 722e 4462 4861 6e64 6c65 7228 6e6f  ler.DbHandler(no
+0000fb90: 6465 2e69 6e64 6578 5f64 622c 206e 6f64  de.index_db, nod
+0000fba0: 652e 6c65 6467 6572 5f70 6174 682c 206e  e.ledger_path, n
+0000fbb0: 6f64 652e 6879 7065 725f 7061 7468 2c20  ode.hyper_path, 
+0000fbc0: 6e6f 6465 2e72 616d 2c20 6e6f 6465 2e6c  node.ram, node.l
+0000fbd0: 6564 6765 725f 7261 6d5f 6669 6c65 2c20  edger_ram_file, 
+0000fbe0: 6e6f 6465 2e6c 6f67 6765 722c 2074 7261  node.logger, tra
+0000fbf0: 6365 5f64 625f 6361 6c6c 733d 6e6f 6465  ce_db_calls=node
+0000fc00: 2e74 7261 6365 5f64 625f 6361 6c6c 7329  .trace_db_calls)
+0000fc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc20: 2020 2020 2020 2020 2062 616c 616e 6365           balance
+0000fc30: 6765 745f 7265 7375 6c74 203d 2062 616c  get_result = bal
+0000fc40: 616e 6365 6765 7428 6261 6c61 6e63 655f  anceget(balance_
+0000fc50: 6164 6472 6573 732c 2064 625f 6861 6e64  address, db_hand
+0000fc60: 6c65 725f 696e 7374 616e 6365 295b 305d  ler_instance)[0]
+0000fc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc80: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+0000fc90: 6c65 725f 696e 7374 616e 6365 2e63 6c6f  ler_instance.clo
+0000fca0: 7365 2829 0a0a 2020 2020 2020 2020 2020  se()..          
+0000fcb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000fcc0: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+0000fcd0: 2062 616c 616e 6365 6765 745f 7265 7375   balanceget_resu
+0000fce0: 6c74 2920 2023 2072 6574 7572 6e20 6261  lt)  # return ba
+0000fcf0: 6c61 6e63 6520 6f66 2074 6865 2061 6464  lance of the add
+0000fd00: 7265 7373 2074 6f20 7468 6520 636c 6965  ress to the clie
+0000fd10: 6e74 2c20 696e 636c 7564 696e 6720 6d65  nt, including me
+0000fd20: 6d70 6f6f 6c0a 2020 2020 2020 2020 2020  mpool.          
+0000fd30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000fd40: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
+0000fd50: 742c 2062 616c 616e 6365 5f70 7265 2920  t, balance_pre) 
+0000fd60: 2023 2072 6574 7572 6e20 6261 6c61 6e63   # return balanc
+0000fd70: 6520 6f66 2074 6865 2061 6464 7265 7373  e of the address
+0000fd80: 2074 6f20 7468 6520 636c 6965 6e74 2c20   to the client, 
+0000fd90: 6e6f 206d 656d 706f 6f6c 0a20 2020 2020  no mempool.     
+0000fda0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000fdb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000fdc0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+0000fdd0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0000fde0: 2e64 6562 7567 2866 277b 7065 6572 5f69  .debug(f'{peer_i
+0000fdf0: 707d 206e 6f74 2077 6869 7465 6c69 7374  p} not whitelist
+0000fe00: 6564 2066 6f72 2062 616c 616e 6365 6765  ed for balancege
+0000fe10: 7468 7970 6572 2063 6f6d 6d61 6e64 2729  thyper command')
+0000fe20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000fe30: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
+0000fe40: 6261 6c61 6e63 6567 6574 6879 7065 726a  balancegethyperj
+0000fe50: 736f 6e27 3a0a 2020 2020 2020 2020 2020  son':.          
+0000fe60: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
+0000fe70: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
+0000fe80: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
+0000fe90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000fea0: 2020 2020 2020 2020 2020 2062 616c 616e             balan
+0000feb0: 6365 5f61 6464 7265 7373 203d 2072 6563  ce_address = rec
+0000fec0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
+0000fed0: 7429 2020 2320 666f 7220 7768 6963 6820  t)  # for which 
+0000fee0: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
 0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff10: 2772 6577 6172 6427 3a20 7472 616e 7361  'reward': transa
-0000ff20: 6374 696f 6e5b 395d 2c0a 2020 2020 2020  ction[9],.      
-0000ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff40: 2020 2020 2020 2020 2020 276f 7065 7261            'opera
-0000ff50: 7469 6f6e 273a 2074 7261 6e73 6163 7469  tion': transacti
-0000ff60: 6f6e 5b31 305d 2c0a 2020 2020 2020 2020  on[10],.        
-0000ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff80: 2020 2020 2020 2020 276f 7065 6e66 6965          'openfie
-0000ff90: 6c64 273a 2074 7261 6e73 6163 7469 6f6e  ld': transaction
-0000ffa0: 5b31 315d 2c0a 2020 2020 2020 2020 2020  [11],.          
+0000ff00: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+0000ff10: 616e 6365 203d 2064 6268 616e 646c 6572  ance = dbhandler
+0000ff20: 2e44 6248 616e 646c 6572 286e 6f64 652e  .DbHandler(node.
+0000ff30: 696e 6465 785f 6462 2c20 6e6f 6465 2e6c  index_db, node.l
+0000ff40: 6564 6765 725f 7061 7468 2c20 6e6f 6465  edger_path, node
+0000ff50: 2e68 7970 6572 5f70 6174 682c 206e 6f64  .hyper_path, nod
+0000ff60: 652e 7261 6d2c 206e 6f64 652e 6c65 6467  e.ram, node.ledg
+0000ff70: 6572 5f72 616d 5f66 696c 652c 206e 6f64  er_ram_file, nod
+0000ff80: 652e 6c6f 6767 6572 2c20 7472 6163 655f  e.logger, trace_
+0000ff90: 6462 5f63 616c 6c73 3d6e 6f64 652e 7472  db_calls=node.tr
+0000ffa0: 6163 655f 6462 5f63 616c 6c73 290a 2020  ace_db_calls).  
 0000ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffc0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0000ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffe0: 2072 6573 706f 6e73 655f 6c69 7374 2e61   response_list.a
-0000fff0: 7070 656e 6428 7265 7370 6f6e 7365 290a  ppend(response).
-00010000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010010: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
-00010020: 6c66 2e72 6571 7565 7374 2c20 7265 7370  lf.request, resp
-00010030: 6f6e 7365 5f6c 6973 7429 0a20 2020 2020  onse_list).     
-00010040: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00010050: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00010060: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00010070: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00010080: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00010090: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-000100a0: 6420 666f 7220 6c69 7374 6c69 6d6a 736f  d for listlimjso
-000100b0: 6e20 636f 6d6d 616e 6427 290a 0a20 2020  n command')..   
-000100c0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-000100d0: 6620 6461 7461 203d 3d20 276c 6973 746c  f data == 'listl
-000100e0: 696d 273a 0a20 2020 2020 2020 2020 2020  im':.           
-000100f0: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
-00010100: 2e70 6565 7273 2e69 735f 616c 6c6f 7765  .peers.is_allowe
-00010110: 6428 7065 6572 5f69 702c 2064 6174 6129  d(peer_ip, data)
-00010120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010130: 2020 2020 2020 2020 2020 6c69 7374 5f6c            list_l
-00010140: 696d 6974 203d 2072 6563 6569 7665 2873  imit = receive(s
-00010150: 656c 662e 7265 7175 6573 7429 0a20 2020  elf.request).   
-00010160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010170: 2020 2020 2023 2070 7269 6e74 2861 6464       # print(add
-00010180: 7265 7373 5f74 785f 6c69 7374 5f6c 696d  ress_tx_list_lim
-00010190: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
-000101a0: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
-000101b0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-000101c0: 6578 6563 7574 655f 7061 7261 6d28 6462  execute_param(db
-000101d0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
-000101e0: 652e 682c 2027 5345 4c45 4354 202a 2046  e.h, 'SELECT * F
-000101f0: 524f 4d20 7472 616e 7361 6374 696f 6e73  ROM transactions
-00010200: 204f 5244 4552 2042 5920 626c 6f63 6b5f   ORDER BY block_
-00010210: 6865 6967 6874 2044 4553 4320 4c49 4d49  height DESC LIMI
-00010220: 5420 3f27 2c20 286c 6973 745f 6c69 6d69  T ?', (list_limi
-00010230: 742c 2029 290a 2020 2020 2020 2020 2020  t, )).          
-00010240: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010250: 7375 6c74 203d 2064 625f 6861 6e64 6c65  sult = db_handle
-00010260: 725f 696e 7374 616e 6365 2e68 2e66 6574  r_instance.h.fet
-00010270: 6368 616c 6c28 290a 2020 2020 2020 2020  chall().        
-00010280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010290: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-000102a0: 742c 2072 6573 756c 7429 0a20 2020 2020  t, result).     
-000102b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000102c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000102d0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-000102e0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-000102f0: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00010300: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-00010310: 6420 666f 7220 6c69 7374 6c69 6d20 636f  d for listlim co
-00010320: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
-00010330: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
-00010340: 7461 203d 3d20 2761 6464 6c69 7374 6c69  ta == 'addlistli
-00010350: 6d27 3a0a 2020 2020 2020 2020 2020 2020  m':.            
-00010360: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00010370: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
-00010380: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
-00010390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103a0: 2020 2020 2020 2020 2061 6464 7265 7373           address
-000103b0: 5f74 785f 6c69 7374 203d 2072 6563 6569  _tx_list = recei
-000103c0: 7665 2873 656c 662e 7265 7175 6573 7429  ve(self.request)
-000103d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103e0: 2020 2020 2020 2020 2061 6464 7265 7373           address
-000103f0: 5f74 785f 6c69 7374 5f6c 696d 6974 203d  _tx_list_limit =
-00010400: 2072 6563 6569 7665 2873 656c 662e 7265   receive(self.re
-00010410: 7175 6573 7429 0a0a 2020 2020 2020 2020  quest)..        
-00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010430: 2320 7072 696e 7428 6164 6472 6573 735f  # print(address_
-00010440: 7478 5f6c 6973 745f 6c69 6d69 7429 0a20  tx_list_limit). 
-00010450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010460: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
-00010470: 725f 696e 7374 616e 6365 2e65 7865 6375  r_instance.execu
-00010480: 7465 5f70 6172 616d 280a 2020 2020 2020  te_param(.      
-00010490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104a0: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
-000104b0: 5f69 6e73 7461 6e63 652e 682c 0a20 2020  _instance.h,.   
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104d0: 2020 2020 2020 2020 2028 2753 454c 4543           ('SELEC
-000104e0: 5420 2a20 4652 4f4d 2074 7261 6e73 6163  T * FROM transac
-000104f0: 7469 6f6e 7320 5748 4552 4520 2861 6464  tions WHERE (add
-00010500: 7265 7373 203d 203f 204f 5220 7265 6369  ress = ? OR reci
-00010510: 7069 656e 7420 3d20 3f29 204f 5244 4552  pient = ?) ORDER
-00010520: 2042 5920 626c 6f63 6b5f 6865 6967 6874   BY block_height
-00010530: 2044 4553 4320 4c49 4d49 5420 3f27 292c   DESC LIMIT ?'),
-00010540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010550: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
-00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010570: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010580: 6464 7265 7373 5f74 785f 6c69 7374 2c0a  ddress_tx_list,.
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105b0: 6164 6472 6573 735f 7478 5f6c 6973 742c  address_tx_list,
-000105c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ffc0: 2020 2020 2020 6261 6c61 6e63 6567 6574        balanceget
+0000ffd0: 5f72 6573 756c 7420 3d20 6261 6c61 6e63  _result = balanc
+0000ffe0: 6567 6574 2862 616c 616e 6365 5f61 6464  eget(balance_add
+0000fff0: 7265 7373 2c20 6462 5f68 616e 646c 6572  ress, db_handler
+00010000: 5f69 6e73 7461 6e63 6529 0a20 2020 2020  _instance).     
+00010010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010020: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+00010030: 7374 616e 6365 2e63 6c6f 7365 2829 0a20  stance.close(). 
+00010040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010050: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00010060: 3d20 7b27 6261 6c61 6e63 6527 3a20 6261  = {'balance': ba
+00010070: 6c61 6e63 6567 6574 5f72 6573 756c 745b  lanceget_result[
+00010080: 305d 7d0a 0a20 2020 2020 2020 2020 2020  0]}..           
+00010090: 2020 2020 2020 2020 2020 2020 2073 656e               sen
+000100a0: 6428 7365 6c66 2e72 6571 7565 7374 2c20  d(self.request, 
+000100b0: 7265 7370 6f6e 7365 2920 2023 2072 6574  response)  # ret
+000100c0: 7572 6e20 6261 6c61 6e63 6520 6f66 2074  urn balance of t
+000100d0: 6865 2061 6464 7265 7373 2074 6f20 7468  he address to th
+000100e0: 6520 636c 6965 6e74 2c20 696e 636c 7564  e client, includ
+000100f0: 696e 6720 6d65 6d70 6f6f 6c0a 2020 2020  ing mempool.    
+00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010110: 2020 2020 2320 7365 6e64 2873 656c 662e      # send(self.
+00010120: 7265 7175 6573 742c 2062 616c 616e 6365  request, balance
+00010130: 5f70 7265 2920 2023 2072 6574 7572 6e20  _pre)  # return 
+00010140: 6261 6c61 6e63 6520 6f66 2074 6865 2061  balance of the a
+00010150: 6464 7265 7373 2074 6f20 7468 6520 636c  ddress to the cl
+00010160: 6965 6e74 2c20 6e6f 206d 656d 706f 6f6c  ient, no mempool
+00010170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010180: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00010190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101a0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+000101b0: 7070 5f6c 6f67 2e64 6562 7567 2866 277b  pp_log.debug(f'{
+000101c0: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
+000101d0: 7465 6c69 7374 6564 2066 6f72 2062 616c  telisted for bal
+000101e0: 616e 6365 6765 7468 7970 6572 6a73 6f6e  ancegethyperjson
+000101f0: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
+00010200: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00010210: 2064 6174 6120 3d3d 2027 6d70 6765 746a   data == 'mpgetj
+00010220: 736f 6e27 2061 6e64 206e 6f64 652e 7065  son' and node.pe
+00010230: 6572 732e 6973 5f61 6c6c 6f77 6564 2870  ers.is_allowed(p
+00010240: 6565 725f 6970 2c20 6461 7461 293a 0a20  eer_ip, data):. 
+00010250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010260: 2020 206d 656d 706f 6f6c 5f74 7873 203d     mempool_txs =
+00010270: 206d 702e 4d45 4d50 4f4f 4c2e 6665 7463   mp.MEMPOOL.fetc
+00010280: 6861 6c6c 286d 702e 5351 4c5f 5345 4c45  hall(mp.SQL_SELE
+00010290: 4354 5f54 585f 544f 5f53 454e 4429 0a0a  CT_TX_TO_SEND)..
+000102a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102b0: 2020 2020 7265 7370 6f6e 7365 5f6c 6973      response_lis
+000102c0: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
+000102d0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+000102e0: 7261 6e73 6163 7469 6f6e 2069 6e20 6d65  ransaction in me
+000102f0: 6d70 6f6f 6c5f 7478 733a 0a20 2020 2020  mpool_txs:.     
+00010300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010310: 2020 2072 6573 706f 6e73 6520 3d20 7b0a     response = {.
+00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010330: 2020 2020 2020 2020 2020 2020 2774 696d              'tim
+00010340: 6573 7461 6d70 273a 2074 7261 6e73 6163  estamp': transac
+00010350: 7469 6f6e 5b30 5d2c 0a20 2020 2020 2020  tion[0],.       
+00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010370: 2020 2020 2027 6164 6472 6573 7327 3a20       'address': 
+00010380: 7472 616e 7361 6374 696f 6e5b 315d 2c0a  transaction[1],.
+00010390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103a0: 2020 2020 2020 2020 2020 2020 2772 6563              'rec
+000103b0: 6970 6965 6e74 273a 2074 7261 6e73 6163  ipient': transac
+000103c0: 7469 6f6e 5b32 5d2c 0a20 2020 2020 2020  tion[2],.       
+000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103e0: 2020 2020 2027 616d 6f75 6e74 273a 2074       'amount': t
+000103f0: 7261 6e73 6163 7469 6f6e 5b33 5d2c 0a20  ransaction[3],. 
+00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010410: 2020 2020 2020 2020 2020 2027 7369 676e             'sign
+00010420: 6174 7572 6527 3a20 7472 616e 7361 6374  ature': transact
+00010430: 696f 6e5b 345d 2c0a 2020 2020 2020 2020  ion[4],.        
+00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010450: 2020 2020 2770 7562 6c69 635f 6b65 7927      'public_key'
+00010460: 3a20 7472 616e 7361 6374 696f 6e5b 355d  : transaction[5]
+00010470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010480: 2020 2020 2020 2020 2020 2020 2020 276f                'o
+00010490: 7065 7261 7469 6f6e 273a 2074 7261 6e73  peration': trans
+000104a0: 6163 7469 6f6e 5b36 5d2c 0a20 2020 2020  action[6],.     
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104c0: 2020 2020 2020 2027 6f70 656e 6669 656c         'openfiel
+000104d0: 6427 3a20 7472 616e 7361 6374 696f 6e5b  d': transaction[
+000104e0: 375d 2c0a 2020 2020 2020 2020 2020 2020  7],.            
+000104f0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 2020 2020 2020 2072 6573 706f 6e73 655f         response_
+00010520: 6c69 7374 2e61 7070 656e 6428 7265 7370  list.append(resp
+00010530: 6f6e 7365 290a 0a20 2020 2020 2020 2020  onse)..         
+00010540: 2020 2020 2020 2020 2020 2023 206e 6f64             # nod
+00010550: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00010560: 2e64 6562 7567 2822 496e 626f 756e 643a  .debug("Inbound:
+00010570: 2045 7874 7261 6374 6564 2066 726f 6d20   Extracted from 
+00010580: 7468 6520 6d65 6d70 6f6f 6c3a 2022 202b  the mempool: " +
+00010590: 2073 7472 286d 656d 706f 6f6c 5f74 7873   str(mempool_txs
+000105a0: 2929 2020 2320 696d 7072 6f76 653a 2073  ))  # improve: s
+000105b0: 796e 6320 6261 7365 6420 6f6e 2073 6967  ync based on sig
+000105c0: 6e61 7475 7265 7320 6f6e 6c79 0a0a 2020  natures only..  
 000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2061 6464 7265 7373 5f74 785f 6c69 7374   address_tx_list
-000105f0: 5f6c 696d 6974 2c0a 2020 2020 2020 2020  _limit,.        
-00010600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010610: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00010620: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00010630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010640: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00010650: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
-00010660: 7461 6e63 652e 682e 6665 7463 6861 6c6c  tance.h.fetchall
-00010670: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00010680: 2020 2020 2020 2020 2020 2073 656e 6428             send(
-00010690: 7365 6c66 2e72 6571 7565 7374 2c20 7265  self.request, re
-000106a0: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-000106b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106d0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-000106e0: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-000106f0: 2866 277b 7065 6572 5f69 707d 206e 6f74  (f'{peer_ip} not
-00010700: 2077 6869 7465 6c69 7374 6564 2066 6f72   whitelisted for
-00010710: 2061 6464 6c69 7374 6c69 6d20 636f 6d6d   addlistlim comm
-00010720: 616e 6427 290a 0a20 2020 2020 2020 2020  and')..         
-00010730: 2020 2020 2020 2065 6c69 6620 6461 7461         elif data
-00010740: 203d 3d20 2761 6464 6c69 7374 6c69 6d6a   == 'addlistlimj
-00010750: 736f 6e27 3a0a 2020 2020 2020 2020 2020  son':.          
-00010760: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-00010770: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-00010780: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
-00010790: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000107a0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000107b0: 7373 5f74 785f 6c69 7374 203d 2072 6563  ss_tx_list = rec
-000107c0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-000107d0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-000107e0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000107f0: 7373 5f74 785f 6c69 7374 5f6c 696d 6974  ss_tx_list_limit
-00010800: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-00010810: 7265 7175 6573 7429 0a0a 2020 2020 2020  request)..      
-00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010830: 2020 2320 7072 696e 7428 6164 6472 6573    # print(addres
-00010840: 735f 7478 5f6c 6973 745f 6c69 6d69 7429  s_tx_list_limit)
-00010850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010860: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
-00010870: 6c65 725f 696e 7374 616e 6365 2e65 7865  ler_instance.exe
-00010880: 6375 7465 5f70 6172 616d 280a 2020 2020  cute_param(.    
-00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108a0: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
-000108b0: 6572 5f69 6e73 7461 6e63 652e 682c 0a20  er_instance.h,. 
-000108c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108d0: 2020 2020 2020 2020 2020 2028 2753 454c             ('SEL
-000108e0: 4543 5420 2a20 4652 4f4d 2074 7261 6e73  ECT * FROM trans
-000108f0: 6163 7469 6f6e 7320 5748 4552 4520 2861  actions WHERE (a
-00010900: 6464 7265 7373 203d 203f 204f 5220 7265  ddress = ? OR re
-00010910: 6369 7069 656e 7420 3d20 3f29 204f 5244  cipient = ?) ORD
-00010920: 4552 2042 5920 626c 6f63 6b5f 6865 6967  ER BY block_heig
-00010930: 6874 2044 4553 4320 4c49 4d49 5420 3f27  ht DESC LIMIT ?'
-00010940: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00010950: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00010960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000105e0: 2020 2320 6966 206c 656e 286d 656d 706f    # if len(mempo
+000105f0: 6f6c 5f74 7873 2920 3e20 303a 2023 776f  ol_txs) > 0: #wo
+00010600: 6e74 2073 796e 6320 6d65 6d70 6f6f 6c20  nt sync mempool 
+00010610: 756e 7469 6c20 7765 2073 656e 6420 736f  until we send so
+00010620: 6d65 7468 696e 672c 2077 6869 6368 2069  mething, which i
+00010630: 7320 6261 640a 2020 2020 2020 2020 2020  s bad.          
+00010640: 2020 2020 2020 2020 2020 2320 7365 6e64            # send
+00010650: 206f 776e 0a20 2020 2020 2020 2020 2020   own.           
+00010660: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+00010670: 6c66 2e72 6571 7565 7374 2c20 7265 7370  lf.request, resp
+00010680: 6f6e 7365 5f6c 6973 7429 0a0a 2020 2020  onse_list)..    
+00010690: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+000106a0: 2064 6174 6120 3d3d 2027 6d70 6765 7427   data == 'mpget'
+000106b0: 2061 6e64 206e 6f64 652e 7065 6572 732e   and node.peers.
+000106c0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
+000106d0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
+000106e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000106f0: 656d 706f 6f6c 5f74 7873 203d 206d 702e  empool_txs = mp.
+00010700: 4d45 4d50 4f4f 4c2e 6665 7463 6861 6c6c  MEMPOOL.fetchall
+00010710: 286d 702e 5351 4c5f 5345 4c45 4354 5f54  (mp.SQL_SELECT_T
+00010720: 585f 544f 5f53 454e 4429 0a0a 2020 2020  X_TO_SEND)..    
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2320 6e6f 6465 2e6c 6f67 6765 722e 6170  # node.logger.ap
+00010750: 705f 6c6f 672e 6465 6275 6728 2249 6e62  p_log.debug("Inb
+00010760: 6f75 6e64 3a20 4578 7472 6163 7465 6420  ound: Extracted 
+00010770: 6672 6f6d 2074 6865 206d 656d 706f 6f6c  from the mempool
+00010780: 3a20 2220 2b20 7374 7228 6d65 6d70 6f6f  : " + str(mempoo
+00010790: 6c5f 7478 7329 2920 2023 2069 6d70 726f  l_txs))  # impro
+000107a0: 7665 3a20 7379 6e63 2062 6173 6564 206f  ve: sync based o
+000107b0: 6e20 7369 676e 6174 7572 6573 206f 6e6c  n signatures onl
+000107c0: 790a 0a20 2020 2020 2020 2020 2020 2020  y..             
+000107d0: 2020 2020 2020 2023 2069 6620 6c65 6e28         # if len(
+000107e0: 6d65 6d70 6f6f 6c5f 7478 7329 203e 2030  mempool_txs) > 0
+000107f0: 3a20 2377 6f6e 7420 7379 6e63 206d 656d  : #wont sync mem
+00010800: 706f 6f6c 2075 6e74 696c 2077 6520 7365  pool until we se
+00010810: 6e64 2073 6f6d 6574 6869 6e67 2c20 7768  nd something, wh
+00010820: 6963 6820 6973 2062 6164 0a20 2020 2020  ich is bad.     
+00010830: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010840: 2073 656e 6420 6f77 6e0a 2020 2020 2020   send own.      
+00010850: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00010860: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+00010870: 206d 656d 706f 6f6c 5f74 7873 290a 0a20   mempool_txs).. 
+00010880: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00010890: 6c69 6620 6461 7461 203d 3d20 276d 7063  lif data == 'mpc
+000108a0: 6c65 6172 2720 616e 6420 7065 6572 5f69  lear' and peer_i
+000108b0: 7020 3d3d 2027 3132 372e 302e 302e 3127  p == '127.0.0.1'
+000108c0: 3a20 2023 2072 6573 6572 7665 6420 666f  :  # reserved fo
+000108d0: 7220 6c6f 6361 6c68 6f73 740a 2020 2020  r localhost.    
+000108e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108f0: 6d70 2e4d 454d 504f 4f4c 2e63 6c65 6172  mp.MEMPOOL.clear
+00010900: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+00010910: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
+00010920: 2027 6b65 7967 656e 273a 0a20 2020 2020   'keygen':.     
+00010930: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010940: 2069 6620 2870 6565 725f 6970 2069 6e20   if (peer_ip in 
+00010950: 616c 6c6f 7765 6420 6f72 2022 616e 7922  allowed or "any"
+00010960: 2069 6e20 616c 6c6f 7765 6429 3a0a 2020   in allowed):.  
 00010970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010980: 2061 6464 7265 7373 5f74 785f 6c69 7374   address_tx_list
-00010990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000109a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109b0: 2020 6164 6472 6573 735f 7478 5f6c 6973    address_tx_lis
-000109c0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000109d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109e0: 2020 2061 6464 7265 7373 5f74 785f 6c69     address_tx_li
-000109f0: 7374 5f6c 696d 6974 2c0a 2020 2020 2020  st_limit,.      
-00010a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a10: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00010980: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
+00010990: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
+000109a0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
+000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109c0: 2020 2028 6765 6e5f 7072 6976 6174 655f     (gen_private_
+000109d0: 6b65 795f 7265 6164 6162 6c65 2c20 6765  key_readable, ge
+000109e0: 6e5f 7075 626c 6963 5f6b 6579 5f72 6561  n_public_key_rea
+000109f0: 6461 626c 652c 2067 656e 5f61 6464 7265  dable, gen_addre
+00010a00: 7373 2920 3d20 7761 6c6c 6574 5f6b 6579  ss) = wallet_key
+00010a10: 732e 6765 6e65 7261 7465 2829 0a20 2020  s.generate().   
 00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a30: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00010a40: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00010a50: 7420 3d20 6462 5f68 616e 646c 6572 5f69  t = db_handler_i
-00010a60: 6e73 7461 6e63 652e 682e 6665 7463 6861  nstance.h.fetcha
-00010a70: 6c6c 2829 0a0a 2020 2020 2020 2020 2020  ll()..          
-00010a80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010a90: 7370 6f6e 7365 5f6c 6973 7420 3d20 5b5d  sponse_list = []
-00010aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ab0: 2020 2020 2020 2020 2066 6f72 2074 7261           for tra
-00010ac0: 6e73 6163 7469 6f6e 2069 6e20 7265 7375  nsaction in resu
-00010ad0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-00010ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010af0: 7265 7370 6f6e 7365 203d 207b 0a20 2020  response = {.   
-00010b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b10: 2020 2020 2020 2020 2020 2020 2027 626c               'bl
-00010b20: 6f63 6b5f 6865 6967 6874 273a 2074 7261  ock_height': tra
-00010b30: 6e73 6163 7469 6f6e 5b30 5d2c 0a20 2020  nsaction[0],.   
-00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b50: 2020 2020 2020 2020 2020 2020 2027 7469               'ti
-00010b60: 6d65 7374 616d 7027 3a20 7472 616e 7361  mestamp': transa
-00010b70: 6374 696f 6e5b 315d 2c0a 2020 2020 2020  ction[1],.      
-00010b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b90: 2020 2020 2020 2020 2020 2761 6464 7265            'addre
-00010ba0: 7373 273a 2074 7261 6e73 6163 7469 6f6e  ss': transaction
-00010bb0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
-00010bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bd0: 2020 2020 2027 7265 6369 7069 656e 7427       'recipient'
-00010be0: 3a20 7472 616e 7361 6374 696f 6e5b 335d  : transaction[3]
-00010bf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c10: 2020 2761 6d6f 756e 7427 3a20 7472 616e    'amount': tran
-00010c20: 7361 6374 696f 6e5b 345d 2c0a 2020 2020  saction[4],.    
-00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c40: 2020 2020 2020 2020 2020 2020 2773 6967              'sig
-00010c50: 6e61 7475 7265 273a 2074 7261 6e73 6163  nature': transac
-00010c60: 7469 6f6e 5b35 5d2c 0a20 2020 2020 2020  tion[5],.       
-00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c80: 2020 2020 2020 2020 2027 7075 626c 6963           'public
-00010c90: 5f6b 6579 273a 2074 7261 6e73 6163 7469  _key': transacti
-00010ca0: 6f6e 5b36 5d2c 0a20 2020 2020 2020 2020  on[6],.         
-00010cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cc0: 2020 2020 2020 2027 626c 6f63 6b5f 6861         'block_ha
-00010cd0: 7368 273a 2074 7261 6e73 6163 7469 6f6e  sh': transaction
-00010ce0: 5b37 5d2c 0a20 2020 2020 2020 2020 2020  [7],.           
-00010cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d00: 2020 2020 2027 6665 6527 3a20 7472 616e       'fee': tran
-00010d10: 7361 6374 696f 6e5b 385d 2c0a 2020 2020  saction[8],.    
+00010a30: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+00010a40: 6571 7565 7374 2c20 2867 656e 5f70 7269  equest, (gen_pri
+00010a50: 7661 7465 5f6b 6579 5f72 6561 6461 626c  vate_key_readabl
+00010a60: 652c 2067 656e 5f70 7562 6c69 635f 6b65  e, gen_public_ke
+00010a70: 795f 7265 6164 6162 6c65 2c20 6765 6e5f  y_readable, gen_
+00010a80: 6164 6472 6573 7329 290a 2020 2020 2020  address)).      
+00010a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010aa0: 2020 2867 656e 5f70 7269 7661 7465 5f6b    (gen_private_k
+00010ab0: 6579 5f72 6561 6461 626c 652c 2067 656e  ey_readable, gen
+00010ac0: 5f70 7562 6c69 635f 6b65 795f 7265 6164  _public_key_read
+00010ad0: 6162 6c65 2c20 6765 6e5f 6164 6472 6573  able, gen_addres
+00010ae0: 7329 203d 2028 4e6f 6e65 2c20 4e6f 6e65  s) = (None, None
+00010af0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+00010b00: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00010b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010b20: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+00010b30: 6f67 6765 722e 6170 705f 6c6f 672e 6465  ogger.app_log.de
+00010b40: 6275 6728 6627 7b70 6565 725f 6970 7d20  bug(f'{peer_ip} 
+00010b50: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
+00010b60: 666f 7220 6b65 7967 656e 2063 6f6d 6d61  for keygen comma
+00010b70: 6e64 2729 0a0a 2020 2020 2020 2020 2020  nd')..          
+00010b80: 2020 2020 2020 656c 6966 2064 6174 6120        elif data 
+00010b90: 3d3d 2027 6b65 7967 656e 6a73 6f6e 273a  == 'keygenjson':
+00010ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010bb0: 2020 2020 2023 2069 6620 2870 6565 725f       # if (peer_
+00010bc0: 6970 2069 6e20 616c 6c6f 7765 6420 6f72  ip in allowed or
+00010bd0: 2022 616e 7922 2069 6e20 616c 6c6f 7765   "any" in allowe
+00010be0: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
+00010bf0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+00010c00: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
+00010c10: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
+00010c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c30: 2020 2020 2020 2020 2028 6765 6e5f 7072           (gen_pr
+00010c40: 6976 6174 655f 6b65 795f 7265 6164 6162  ivate_key_readab
+00010c50: 6c65 2c20 6765 6e5f 7075 626c 6963 5f6b  le, gen_public_k
+00010c60: 6579 5f72 6561 6461 626c 652c 2067 656e  ey_readable, gen
+00010c70: 5f61 6464 7265 7373 2920 3d20 7761 6c6c  _address) = wall
+00010c80: 6574 5f6b 6579 732e 6765 6e65 7261 7465  et_keys.generate
+00010c90: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00010ca0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+00010cb0: 6e73 6520 3d20 7b27 7072 6976 6174 655f  nse = {'private_
+00010cc0: 6b65 7927 3a20 6765 6e5f 7072 6976 6174  key': gen_privat
+00010cd0: 655f 6b65 795f 7265 6164 6162 6c65 2c20  e_key_readable, 
+00010ce0: 2770 7562 6c69 635f 6b65 7927 3a20 6765  'public_key': ge
+00010cf0: 6e5f 7075 626c 6963 5f6b 6579 5f72 6561  n_public_key_rea
+00010d00: 6461 626c 652c 2027 6164 6472 6573 7327  dable, 'address'
+00010d10: 3a20 6765 6e5f 6164 6472 6573 737d 0a0a  : gen_address}..
 00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d30: 2020 2020 2020 2020 2020 2020 2772 6577              'rew
-00010d40: 6172 6427 3a20 7472 616e 7361 6374 696f  ard': transactio
-00010d50: 6e5b 395d 2c0a 2020 2020 2020 2020 2020  n[9],.          
-00010d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d70: 2020 2020 2020 276f 7065 7261 7469 6f6e        'operation
-00010d80: 273a 2074 7261 6e73 6163 7469 6f6e 5b31  ': transaction[1
-00010d90: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-00010da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010db0: 2020 2020 276f 7065 6e66 6965 6c64 273a      'openfield':
-00010dc0: 2074 7261 6e73 6163 7469 6f6e 5b31 315d   transaction[11]
-00010dd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010de0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00010df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e00: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00010e10: 706f 6e73 655f 6c69 7374 2e61 7070 656e  ponse_list.appen
-00010e20: 6428 7265 7370 6f6e 7365 290a 0a20 2020  d(response)..   
-00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e40: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-00010e50: 6571 7565 7374 2c20 7265 7370 6f6e 7365  equest, response
-00010e60: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
-00010e70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00010e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e90: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-00010ea0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-00010eb0: 6f28 6627 7b70 6565 725f 6970 7d20 6e6f  o(f'{peer_ip} no
-00010ec0: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
-00010ed0: 7220 6164 646c 6973 746c 696d 6a73 6f6e  r addlistlimjson
-00010ee0: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
-00010ef0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00010f00: 2064 6174 6120 3d3d 2027 6164 646c 6973   data == 'addlis
-00010f10: 746c 696d 6d69 7227 3a0a 2020 2020 2020  tlimmir':.      
-00010f20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00010f30: 206e 6f64 652e 7065 6572 732e 6973 5f61   node.peers.is_a
-00010f40: 6c6c 6f77 6564 2870 6565 725f 6970 2c20  llowed(peer_ip, 
-00010f50: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
-00010f60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010f70: 6464 7265 7373 5f74 785f 6c69 7374 203d  ddress_tx_list =
-00010f80: 2072 6563 6569 7665 2873 656c 662e 7265   receive(self.re
-00010f90: 7175 6573 7429 0a20 2020 2020 2020 2020  quest).         
-00010fa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010fb0: 6464 7265 7373 5f74 785f 6c69 7374 5f6c  ddress_tx_list_l
-00010fc0: 696d 6974 203d 2072 6563 6569 7665 2873  imit = receive(s
-00010fd0: 656c 662e 7265 7175 6573 7429 0a0a 2020  elf.request)..  
-00010fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ff0: 2020 2020 2020 2320 7072 696e 7428 6164        # print(ad
-00011000: 6472 6573 735f 7478 5f6c 6973 745f 6c69  dress_tx_list_li
-00011010: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
-00011020: 2020 2020 2020 2020 2020 2020 2064 625f               db_
-00011030: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
-00011040: 2e65 7865 6375 7465 5f70 6172 616d 280a  .execute_param(.
-00011050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011060: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
-00011070: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-00011080: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00011090: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000110a0: 2753 454c 4543 5420 2a20 4652 4f4d 2074  'SELECT * FROM t
-000110b0: 7261 6e73 6163 7469 6f6e 7320 5748 4552  ransactions WHER
-000110c0: 4520 2861 6464 7265 7373 203d 203f 204f  E (address = ? O
-000110d0: 5220 7265 6369 7069 656e 7420 3d20 3f29  R recipient = ?)
-000110e0: 2041 4e44 2062 6c6f 636b 5f68 6569 6768   AND block_heigh
-000110f0: 7420 3c20 3120 4f52 4445 5220 4259 2062  t < 1 ORDER BY b
-00011100: 6c6f 636b 5f68 6569 6768 7420 4153 4320  lock_height ASC 
-00011110: 4c49 4d49 5420 3f27 292c 0a20 2020 2020  LIMIT ?'),.     
-00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011130: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00011140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011150: 2020 2020 2020 2020 2061 6464 7265 7373           address
-00011160: 5f74 785f 6c69 7374 2c0a 2020 2020 2020  _tx_list,.      
-00011170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011180: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00011190: 735f 7478 5f6c 6973 742c 0a20 2020 2020  s_tx_list,.     
-000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111b0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000111c0: 7373 5f74 785f 6c69 7374 5f6c 696d 6974  ss_tx_list_limit
-000111d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000111e0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-000111f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011200: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00010d30: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
+00010d40: 662e 7265 7175 6573 742c 2072 6573 706f  f.request, respo
+00010d50: 6e73 6529 0a20 2020 2020 2020 2020 2020  nse).           
+00010d60: 2020 2020 2020 2020 2020 2020 2028 6765               (ge
+00010d70: 6e5f 7072 6976 6174 655f 6b65 795f 7265  n_private_key_re
+00010d80: 6164 6162 6c65 2c20 6765 6e5f 7075 626c  adable, gen_publ
+00010d90: 6963 5f6b 6579 5f72 6561 6461 626c 652c  ic_key_readable,
+00010da0: 2067 656e 5f61 6464 7265 7373 2920 3d20   gen_address) = 
+00010db0: 284e 6f6e 652c 204e 6f6e 652c 204e 6f6e  (None, None, Non
+00010dc0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00010dd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010df0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+00010e00: 2e61 7070 5f6c 6f67 2e64 6562 7567 2866  .app_log.debug(f
+00010e10: 277b 7065 6572 5f69 707d 206e 6f74 2077  '{peer_ip} not w
+00010e20: 6869 7465 6c69 7374 6564 2066 6f72 206b  hitelisted for k
+00010e30: 6579 6765 6e6a 736f 6e20 636f 6d6d 616e  eygenjson comman
+00010e40: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
+00010e50: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
+00010e60: 3d20 2761 6464 6c69 7374 273a 0a20 2020  = 'addlist':.   
+00010e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e80: 2023 2069 6620 2870 6565 725f 6970 2069   # if (peer_ip i
+00010e90: 6e20 616c 6c6f 7765 6420 6f72 2022 616e  n allowed or "an
+00010ea0: 7922 2069 6e20 616c 6c6f 7765 6429 3a0a  y" in allowed):.
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ec0: 2020 2020 6966 206e 6f64 652e 7065 6572      if node.peer
+00010ed0: 732e 6973 5f61 6c6c 6f77 6564 2870 6565  s.is_allowed(pee
+00010ee0: 725f 6970 2c20 6461 7461 293a 0a20 2020  r_ip, data):.   
+00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f00: 2020 2020 2061 6464 7265 7373 5f74 785f       address_tx_
+00010f10: 6c69 7374 203d 2072 6563 6569 7665 2873  list = receive(s
+00010f20: 656c 662e 7265 7175 6573 7429 0a20 2020  elf.request).   
+00010f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f40: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+00010f50: 696e 7374 616e 6365 203d 2064 6268 616e  instance = dbhan
+00010f60: 646c 6572 2e44 6248 616e 646c 6572 286e  dler.DbHandler(n
+00010f70: 6f64 652e 696e 6465 785f 6462 2c20 6e6f  ode.index_db, no
+00010f80: 6465 2e6c 6564 6765 725f 7061 7468 2c20  de.ledger_path, 
+00010f90: 6e6f 6465 2e68 7970 6572 5f70 6174 682c  node.hyper_path,
+00010fa0: 206e 6f64 652e 7261 6d2c 206e 6f64 652e   node.ram, node.
+00010fb0: 6c65 6467 6572 5f72 616d 5f66 696c 652c  ledger_ram_file,
+00010fc0: 206e 6f64 652e 6c6f 6767 6572 2c20 7472   node.logger, tr
+00010fd0: 6163 655f 6462 5f63 616c 6c73 3d6e 6f64  ace_db_calls=nod
+00010fe0: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
+00010ff0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011000: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+00011010: 646c 6572 5f69 6e73 7461 6e63 652e 6578  dler_instance.ex
+00011020: 6563 7574 655f 7061 7261 6d28 0a20 2020  ecute_param(.   
+00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011040: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+00011050: 6c65 725f 696e 7374 616e 6365 2e68 2c0a  ler_instance.h,.
+00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011070: 2020 2020 2020 2020 2020 2020 2827 5345              ('SE
+00011080: 4c45 4354 202a 2046 524f 4d20 7472 616e  LECT * FROM tran
+00011090: 7361 6374 696f 6e73 2057 4845 5245 2028  sactions WHERE (
+000110a0: 6164 6472 6573 7320 3d20 3f20 4f52 2072  address = ? OR r
+000110b0: 6563 6970 6965 6e74 203d 203f 2920 4f52  ecipient = ?) OR
+000110c0: 4445 5220 4259 2062 6c6f 636b 5f68 6569  DER BY block_hei
+000110d0: 6768 7420 4445 5343 2729 2c0a 2020 2020  ght DESC'),.    
+000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110f0: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+00011100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011110: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00011120: 735f 7478 5f6c 6973 742c 0a20 2020 2020  s_tx_list,.     
+00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011140: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00011150: 7373 5f74 785f 6c69 7374 2c0a 2020 2020  ss_tx_list,.    
+00011160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011170: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011190: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000111a0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+000111b0: 756c 7420 3d20 6462 5f68 616e 646c 6572  ult = db_handler
+000111c0: 5f69 6e73 7461 6e63 652e 682e 6665 7463  _instance.h.fetc
+000111d0: 6861 6c6c 2829 0a20 2020 2020 2020 2020  hall().         
+000111e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000111f0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+00011200: 6365 2e63 6c6f 7365 2829 0a0a 2020 2020  ce.close()..    
 00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011220: 2020 2072 6573 756c 7420 3d20 6462 5f68     result = db_h
-00011230: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-00011240: 682e 6665 7463 6861 6c6c 2829 0a20 2020  h.fetchall().   
-00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011260: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-00011270: 6571 7565 7374 2c20 7265 7375 6c74 290a  equest, result).
-00011280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011290: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112b0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-000112c0: 705f 6c6f 672e 696e 666f 2866 277b 7065  p_log.info(f'{pe
-000112d0: 6572 5f69 707d 206e 6f74 2077 6869 7465  er_ip} not white
-000112e0: 6c69 7374 6564 2066 6f72 2061 6464 6c69  listed for addli
-000112f0: 7374 6c69 6d6d 6972 2063 6f6d 6d61 6e64  stlimmir command
-00011300: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-00011310: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
-00011320: 2027 6164 646c 6973 746c 696d 6d69 726a   'addlistlimmirj
-00011330: 736f 6e27 3a0a 2020 2020 2020 2020 2020  son':.          
-00011340: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-00011350: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-00011360: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
-00011370: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00011380: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00011390: 7373 5f74 785f 6c69 7374 203d 2072 6563  ss_tx_list = rec
-000113a0: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
-000113b0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-000113c0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000113d0: 7373 5f74 785f 6c69 7374 5f6c 696d 6974  ss_tx_list_limit
-000113e0: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-000113f0: 7265 7175 6573 7429 0a0a 2020 2020 2020  request)..      
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011410: 2020 2320 7072 696e 7428 6164 6472 6573    # print(addres
-00011420: 735f 7478 5f6c 6973 745f 6c69 6d69 7429  s_tx_list_limit)
-00011430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011440: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
-00011450: 6c65 725f 696e 7374 616e 6365 2e65 7865  ler_instance.exe
-00011460: 6375 7465 5f70 6172 616d 280a 2020 2020  cute_param(.    
-00011470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011480: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
-00011490: 6572 5f69 6e73 7461 6e63 652e 682c 0a20  er_instance.h,. 
-000114a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114b0: 2020 2020 2020 2020 2020 2028 2753 454c             ('SEL
-000114c0: 4543 5420 2a20 4652 4f4d 2074 7261 6e73  ECT * FROM trans
-000114d0: 6163 7469 6f6e 7320 5748 4552 4520 2861  actions WHERE (a
-000114e0: 6464 7265 7373 203d 203f 204f 5220 7265  ddress = ? OR re
-000114f0: 6369 7069 656e 7420 3d20 3f29 2041 4e44  cipient = ?) AND
-00011500: 2062 6c6f 636b 5f68 6569 6768 7420 3c20   block_height < 
-00011510: 3120 4f52 4445 5220 4259 2062 6c6f 636b  1 ORDER BY block
-00011520: 5f68 6569 6768 7420 4153 4320 4c49 4d49  _height ASC LIMI
-00011530: 5420 3f27 292c 0a20 2020 2020 2020 2020  T ?'),.         
-00011540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011550: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00011560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011570: 2020 2020 2061 6464 7265 7373 5f74 785f       address_tx_
-00011580: 6c69 7374 2c0a 2020 2020 2020 2020 2020  list,.          
-00011590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115a0: 2020 2020 2020 6164 6472 6573 735f 7478        address_tx
-000115b0: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
+00011220: 2020 2020 7365 6e64 2873 656c 662e 7265      send(self.re
+00011230: 7175 6573 742c 2072 6573 756c 7429 0a20  quest, result). 
+00011240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011250: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00011260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011270: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00011280: 5f6c 6f67 2e64 6562 7567 2866 277b 7065  _log.debug(f'{pe
+00011290: 6572 5f69 707d 206e 6f74 2077 6869 7465  er_ip} not white
+000112a0: 6c69 7374 6564 2066 6f72 2061 6464 6c69  listed for addli
+000112b0: 7374 2063 6f6d 6d61 6e64 2729 0a0a 2020  st command')..  
+000112c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000112d0: 6966 2064 6174 6120 3d3d 2027 6c69 7374  if data == 'list
+000112e0: 6c69 6d6a 736f 6e27 3a0a 2020 2020 2020  limjson':.      
+000112f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00011300: 6966 2028 7065 6572 5f69 7020 696e 2061  if (peer_ip in a
+00011310: 6c6c 6f77 6564 206f 7220 2261 6e79 2220  llowed or "any" 
+00011320: 696e 2061 6c6c 6f77 6564 293a 0a20 2020  in allowed):.   
+00011330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011340: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
+00011350: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
+00011360: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
+00011370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011380: 2020 6c69 7374 5f6c 696d 6974 203d 2072    list_limit = r
+00011390: 6563 6569 7665 2873 656c 662e 7265 7175  eceive(self.requ
+000113a0: 6573 7429 0a20 2020 2020 2020 2020 2020  est).           
+000113b0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+000113c0: 7269 6e74 2861 6464 7265 7373 5f74 785f  rint(address_tx_
+000113d0: 6c69 7374 5f6c 696d 6974 290a 2020 2020  list_limit).    
+000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113f0: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+00011400: 6e73 7461 6e63 6520 3d20 6462 6861 6e64  nstance = dbhand
+00011410: 6c65 722e 4462 4861 6e64 6c65 7228 6e6f  ler.DbHandler(no
+00011420: 6465 2e69 6e64 6578 5f64 622c 206e 6f64  de.index_db, nod
+00011430: 652e 6c65 6467 6572 5f70 6174 682c 206e  e.ledger_path, n
+00011440: 6f64 652e 6879 7065 725f 7061 7468 2c20  ode.hyper_path, 
+00011450: 6e6f 6465 2e72 616d 2c20 6e6f 6465 2e6c  node.ram, node.l
+00011460: 6564 6765 725f 7261 6d5f 6669 6c65 2c20  edger_ram_file, 
+00011470: 6e6f 6465 2e6c 6f67 6765 722c 2074 7261  node.logger, tra
+00011480: 6365 5f64 625f 6361 6c6c 733d 6e6f 6465  ce_db_calls=node
+00011490: 2e74 7261 6365 5f64 625f 6361 6c6c 7329  .trace_db_calls)
+000114a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000114b0: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+000114c0: 6c65 725f 696e 7374 616e 6365 2e65 7865  ler_instance.exe
+000114d0: 6375 7465 5f70 6172 616d 2864 625f 6861  cute_param(db_ha
+000114e0: 6e64 6c65 725f 696e 7374 616e 6365 2e68  ndler_instance.h
+000114f0: 2c20 2753 454c 4543 5420 2a20 4652 4f4d  , 'SELECT * FROM
+00011500: 2074 7261 6e73 6163 7469 6f6e 7320 4f52   transactions OR
+00011510: 4445 5220 4259 2062 6c6f 636b 5f68 6569  DER BY block_hei
+00011520: 6768 7420 4445 5343 204c 494d 4954 203f  ght DESC LIMIT ?
+00011530: 272c 2028 6c69 7374 5f6c 696d 6974 2c20  ', (list_limit, 
+00011540: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00011550: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00011560: 7420 3d20 6462 5f68 616e 646c 6572 5f69  t = db_handler_i
+00011570: 6e73 7461 6e63 652e 682e 6665 7463 6861  nstance.h.fetcha
+00011580: 6c6c 2829 0a20 2020 2020 2020 2020 2020  ll().           
+00011590: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+000115a0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+000115b0: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
 000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115d0: 2020 2020 2020 2061 6464 7265 7373 5f74         address_t
-000115e0: 785f 6c69 7374 5f6c 696d 6974 2c0a 2020  x_list_limit,.  
-000115f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011600: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00011610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011620: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00011630: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011640: 6573 756c 7420 3d20 6462 5f68 616e 646c  esult = db_handl
-00011650: 6572 5f69 6e73 7461 6e63 652e 682e 6665  er_instance.h.fe
-00011660: 7463 6861 6c6c 2829 0a0a 2020 2020 2020  tchall()..      
-00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011680: 2020 7265 7370 6f6e 7365 5f6c 6973 7420    response_list 
-00011690: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-000116a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000116b0: 2074 7261 6e73 6163 7469 6f6e 2069 6e20   transaction in 
-000116c0: 7265 7375 6c74 3a0a 2020 2020 2020 2020  result:.        
-000116d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116e0: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
-000116f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000115d0: 2020 7265 7370 6f6e 7365 5f6c 6973 7420    response_list 
+000115e0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+000115f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00011600: 2074 7261 6e73 6163 7469 6f6e 2069 6e20   transaction in 
+00011610: 7265 7375 6c74 3a0a 2020 2020 2020 2020  result:.        
+00011620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011630: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
+00011640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011660: 2027 626c 6f63 6b5f 6865 6967 6874 273a   'block_height':
+00011670: 2074 7261 6e73 6163 7469 6f6e 5b30 5d2c   transaction[0],
+00011680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116a0: 2027 7469 6d65 7374 616d 7027 3a20 7472   'timestamp': tr
+000116b0: 616e 7361 6374 696f 6e5b 315d 2c0a 2020  ansaction[1],.  
+000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116d0: 2020 2020 2020 2020 2020 2020 2020 2761                'a
+000116e0: 6464 7265 7373 273a 2074 7261 6e73 6163  ddress': transac
+000116f0: 7469 6f6e 5b32 5d2c 0a20 2020 2020 2020  tion[2],.       
 00011700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011710: 2027 626c 6f63 6b5f 6865 6967 6874 273a   'block_height':
-00011720: 2074 7261 6e73 6163 7469 6f6e 5b30 5d2c   transaction[0],
-00011730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011710: 2020 2020 2020 2020 2027 7265 6369 7069           'recipi
+00011720: 656e 7427 3a20 7472 616e 7361 6374 696f  ent': transactio
+00011730: 6e5b 335d 2c0a 2020 2020 2020 2020 2020  n[3],.          
 00011740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011750: 2027 7469 6d65 7374 616d 7027 3a20 7472   'timestamp': tr
-00011760: 616e 7361 6374 696f 6e5b 315d 2c0a 2020  ansaction[1],.  
+00011750: 2020 2020 2020 2761 6d6f 756e 7427 3a20        'amount': 
+00011760: 7472 616e 7361 6374 696f 6e5b 345d 2c0a  transaction[4],.
 00011770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011780: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-00011790: 6464 7265 7373 273a 2074 7261 6e73 6163  ddress': transac
-000117a0: 7469 6f6e 5b32 5d2c 0a20 2020 2020 2020  tion[2],.       
+00011780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011790: 2773 6967 6e61 7475 7265 273a 2074 7261  'signature': tra
+000117a0: 6e73 6163 7469 6f6e 5b35 5d2c 0a20 2020  nsaction[5],.   
 000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117c0: 2020 2020 2020 2020 2027 7265 6369 7069           'recipi
-000117d0: 656e 7427 3a20 7472 616e 7361 6374 696f  ent': transactio
-000117e0: 6e5b 335d 2c0a 2020 2020 2020 2020 2020  n[3],.          
+000117c0: 2020 2020 2020 2020 2020 2020 2027 7075               'pu
+000117d0: 626c 6963 5f6b 6579 273a 2074 7261 6e73  blic_key': trans
+000117e0: 6163 7469 6f6e 5b36 5d2c 0a20 2020 2020  action[6],.     
 000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011800: 2020 2020 2020 2761 6d6f 756e 7427 3a20        'amount': 
-00011810: 7472 616e 7361 6374 696f 6e5b 345d 2c0a  transaction[4],.
-00011820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011800: 2020 2020 2020 2020 2020 2027 626c 6f63             'bloc
+00011810: 6b5f 6861 7368 273a 2074 7261 6e73 6163  k_hash': transac
+00011820: 7469 6f6e 5b37 5d2c 0a20 2020 2020 2020  tion[7],.       
 00011830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011840: 2773 6967 6e61 7475 7265 273a 2074 7261  'signature': tra
-00011850: 6e73 6163 7469 6f6e 5b35 5d2c 0a20 2020  nsaction[5],.   
+00011840: 2020 2020 2020 2020 2027 6665 6527 3a20           'fee': 
+00011850: 7472 616e 7361 6374 696f 6e5b 385d 2c0a  transaction[8],.
 00011860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011870: 2020 2020 2020 2020 2020 2020 2027 7075               'pu
-00011880: 626c 6963 5f6b 6579 273a 2074 7261 6e73  blic_key': trans
-00011890: 6163 7469 6f6e 5b36 5d2c 0a20 2020 2020  action[6],.     
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 2772 6577 6172 6427 3a20 7472 616e 7361  'reward': transa
+00011890: 6374 696f 6e5b 395d 2c0a 2020 2020 2020  ction[9],.      
 000118a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118b0: 2020 2020 2020 2020 2020 2027 626c 6f63             'bloc
-000118c0: 6b5f 6861 7368 273a 2074 7261 6e73 6163  k_hash': transac
-000118d0: 7469 6f6e 5b37 5d2c 0a20 2020 2020 2020  tion[7],.       
+000118b0: 2020 2020 2020 2020 2020 276f 7065 7261            'opera
+000118c0: 7469 6f6e 273a 2074 7261 6e73 6163 7469  tion': transacti
+000118d0: 6f6e 5b31 305d 2c0a 2020 2020 2020 2020  on[10],.        
 000118e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118f0: 2020 2020 2020 2020 2027 6665 6527 3a20           'fee': 
-00011900: 7472 616e 7361 6374 696f 6e5b 385d 2c0a  transaction[8],.
-00011910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118f0: 2020 2020 2020 2020 276f 7065 6e66 6965          'openfie
+00011900: 6c64 273a 2074 7261 6e73 6163 7469 6f6e  ld': transaction
+00011910: 5b31 315d 2c0a 2020 2020 2020 2020 2020  [11],.          
 00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011930: 2772 6577 6172 6427 3a20 7472 616e 7361  'reward': transa
-00011940: 6374 696f 6e5b 395d 2c0a 2020 2020 2020  ction[9],.      
-00011950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011960: 2020 2020 2020 2020 2020 276f 7065 7261            'opera
-00011970: 7469 6f6e 273a 2074 7261 6e73 6163 7469  tion': transacti
-00011980: 6f6e 5b31 305d 2c0a 2020 2020 2020 2020  on[10],.        
-00011990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119a0: 2020 2020 2020 2020 276f 7065 6e66 6965          'openfie
-000119b0: 6c64 273a 2074 7261 6e73 6163 7469 6f6e  ld': transaction
-000119c0: 5b31 315d 2c0a 2020 2020 2020 2020 2020  [11],.          
-000119d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-000119f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a00: 2072 6573 706f 6e73 655f 6c69 7374 2e61   response_list.a
-00011a10: 7070 656e 6428 7265 7370 6f6e 7365 290a  ppend(response).
-00011a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011a30: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
-00011a40: 6c66 2e72 6571 7565 7374 2c20 7265 7370  lf.request, resp
-00011a50: 6f6e 7365 5f6c 6973 7429 0a20 2020 2020  onse_list).     
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a70: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
-00011a80: 7565 7374 2c20 7265 7375 6c74 290a 2020  uest, result).  
-00011a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011aa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ac0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00011ad0: 6c6f 672e 696e 666f 2866 277b 7065 6572  log.info(f'{peer
-00011ae0: 5f69 707d 206e 6f74 2077 6869 7465 6c69  _ip} not whiteli
-00011af0: 7374 6564 2066 6f72 2061 6464 6c69 7374  sted for addlist
-00011b00: 6c69 6d6d 6972 2063 6f6d 6d61 6e64 2729  limmir command')
-00011b10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011b20: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
-00011b30: 616c 6961 7367 6574 273a 2020 2320 616c  aliasget':  # al
-00011b40: 6c20 666f 7220 6120 7369 6e67 6c65 2061  l for a single a
-00011b50: 6464 7265 7373 2c20 6e6f 2070 726f 7465  ddress, no prote
-00011b60: 6374 696f 6e20 6167 6169 6e73 7420 6f76  ction against ov
-00011b70: 6572 6c61 7070 696e 670a 2020 2020 2020  erlapping.      
-00011b80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00011b90: 206e 6f64 652e 7065 6572 732e 6973 5f61   node.peers.is_a
-00011ba0: 6c6c 6f77 6564 2870 6565 725f 6970 2c20  llowed(peer_ip, 
-00011bb0: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
-00011bc0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00011bd0: 6c69 6173 6573 2e61 6c69 6173 6573 5f75  liases.aliases_u
-00011be0: 7064 6174 6528 6e6f 6465 2c20 6462 5f68  pdate(node, db_h
-00011bf0: 616e 646c 6572 5f69 6e73 7461 6e63 6529  andler_instance)
-00011c00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011c10: 2020 2020 2020 2020 2020 616c 6961 735f            alias_
-00011c20: 6164 6472 6573 7320 3d20 7265 6365 6976  address = receiv
-00011c30: 6528 7365 6c66 2e72 6571 7565 7374 290a  e(self.request).
-00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c50: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00011c60: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
-00011c70: 616e 6365 2e61 6c69 6173 6765 7428 616c  ance.aliasget(al
-00011c80: 6961 735f 6164 6472 6573 7329 0a0a 2020  ias_address)..  
-00011c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ca0: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
-00011cb0: 7265 7175 6573 742c 2072 6573 756c 7429  request, result)
-00011cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011cd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00011ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011cf0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-00011d00: 7070 5f6c 6f67 2e69 6e66 6f28 6627 7b70  pp_log.info(f'{p
-00011d10: 6565 725f 6970 7d20 6e6f 7420 7768 6974  eer_ip} not whit
-00011d20: 656c 6973 7465 6420 666f 7220 616c 6961  elisted for alia
-00011d30: 7367 6574 2063 6f6d 6d61 6e64 2729 0a0a  sget command')..
-00011d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d50: 656c 6966 2064 6174 6120 3d3d 2027 616c  elif data == 'al
-00011d60: 6961 7365 7367 6574 273a 2020 2320 6f6e  iasesget':  # on
-00011d70: 6c79 2067 6574 7320 7468 6520 6669 7273  ly gets the firs
-00011d80: 7420 6f6e 652c 2066 6f72 206d 756c 7469  t one, for multi
-00011d90: 706c 6520 6164 6472 6573 7365 730a 2020  ple addresses.  
-00011da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011db0: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
-00011dc0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
-00011dd0: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
-00011de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011df0: 2020 2061 6c69 6173 6573 2e61 6c69 6173     aliases.alias
-00011e00: 6573 5f75 7064 6174 6528 6e6f 6465 2c20  es_update(node, 
-00011e10: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
-00011e20: 6e63 6529 0a20 2020 2020 2020 2020 2020  nce).           
-00011e30: 2020 2020 2020 2020 2020 2020 2061 6c69               ali
-00011e40: 6173 6573 5f72 6571 7565 7374 203d 2072  ases_request = r
-00011e50: 6563 6569 7665 2873 656c 662e 7265 7175  eceive(self.requ
-00011e60: 6573 7429 0a20 2020 2020 2020 2020 2020  est).           
-00011e70: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00011e80: 756c 7473 203d 2064 625f 6861 6e64 6c65  ults = db_handle
-00011e90: 725f 696e 7374 616e 6365 2e61 6c69 6173  r_instance.alias
-00011ea0: 6573 6765 7428 616c 6961 7365 735f 7265  esget(aliases_re
-00011eb0: 7175 6573 7429 0a20 2020 2020 2020 2020  quest).         
-00011ec0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00011ed0: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-00011ee0: 2c20 7265 7375 6c74 7329 0a20 2020 2020  , results).     
-00011ef0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011f00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00011f10: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00011f20: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00011f30: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00011f40: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-00011f50: 6420 666f 7220 616c 6961 7365 7367 6574  d for aliasesget
-00011f60: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
-00011f70: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00011f80: 7420 6d61 6e64 6174 6f72 792c 2062 7574  t mandatory, but
-00011f90: 206d 6179 2068 656c 7020 746f 2072 6569   may help to rei
-00011fa0: 6e64 6578 2077 6974 6820 6d69 6e69 6d61  ndex with minima
-00011fb0: 6c20 7371 6c20 7175 6572 6965 730a 0a20  l sql queries.. 
-00011fc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011fd0: 6c69 6620 6461 7461 203d 3d20 2774 6f6b  lif data == 'tok
-00011fe0: 656e 7367 6574 273a 0a20 2020 2020 2020  ensget':.       
-00011ff0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-00012000: 4f44 4f3a 2074 6f20 6265 2068 616e 646c  ODO: to be handl
-00012010: 6564 2062 7920 746f 6b65 6e20 6d6f 6475  ed by token modu
-00012020: 6c65 732c 2077 6974 6820 6e6f 2073 716c  les, with no sql
-00012030: 2068 6572 6520 696e 206e 6f64 652e 0a20   here in node.. 
-00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012050: 2020 2069 6620 6e6f 6465 2e70 6565 7273     if node.peers
-00012060: 2e69 735f 616c 6c6f 7765 6428 7065 6572  .is_allowed(peer
-00012070: 5f69 702c 2064 6174 6129 3a0a 0a20 2020  _ip, data):..   
-00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012090: 2020 2020 2074 6f6b 656e 735f 6164 6472       tokens_addr
-000120a0: 6573 7320 3d20 7265 6365 6976 6528 7365  ess = receive(se
-000120b0: 6c66 2e72 6571 7565 7374 290a 2020 2020  lf.request).    
-000120c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120d0: 2020 2020 746f 6b65 6e73 5f75 7365 7220      tokens_user 
-000120e0: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
-000120f0: 7461 6e63 652e 746f 6b65 6e73 5f75 7365  tance.tokens_use
-00012100: 7228 746f 6b65 6e73 5f61 6464 7265 7373  r(tokens_address
-00012110: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00012120: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-00012130: 735f 6c69 7374 203d 205b 5d0a 2020 2020  s_list = [].    
-00012140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012150: 2020 2020 666f 7220 746f 6b65 6e20 696e      for token in
-00012160: 2074 6f6b 656e 735f 7573 6572 3a0a 2020   tokens_user:.  
-00012170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012180: 2020 2020 2020 2020 2020 746f 6b65 6e20            token 
-00012190: 3d20 746f 6b65 6e5b 305d 0a20 2020 2020  = token[0].     
-000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121b0: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
-000121c0: 725f 696e 7374 616e 6365 2e65 7865 6375  r_instance.execu
-000121d0: 7465 5f70 6172 616d 2864 625f 6861 6e64  te_param(db_hand
-000121e0: 6c65 725f 696e 7374 616e 6365 2e69 6e64  ler_instance.ind
-000121f0: 6578 5f63 7572 736f 722c 2027 5345 4c45  ex_cursor, 'SELE
-00012200: 4354 2073 756d 2861 6d6f 756e 7429 2046  CT sum(amount) F
-00012210: 524f 4d20 746f 6b65 6e73 2057 4845 5245  ROM tokens WHERE
-00012220: 2072 6563 6970 6965 6e74 203d 203f 2041   recipient = ? A
-00012230: 4e44 2074 6f6b 656e 203d 203f 3b27 2c20  ND token = ?;', 
-00012240: 2874 6f6b 656e 735f 6164 6472 6573 732c  (tokens_address,
-00012250: 2029 202b 2028 746f 6b65 6e2c 2029 290a   ) + (token, )).
+00011930: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00011940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011950: 2072 6573 706f 6e73 655f 6c69 7374 2e61   response_list.a
+00011960: 7070 656e 6428 7265 7370 6f6e 7365 290a  ppend(response).
+00011970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011980: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+00011990: 6c66 2e72 6571 7565 7374 2c20 7265 7370  lf.request, resp
+000119a0: 6f6e 7365 5f6c 6973 7429 0a20 2020 2020  onse_list).     
+000119b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000119c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000119d0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+000119e0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+000119f0: 2e64 6562 7567 2866 277b 7065 6572 5f69  .debug(f'{peer_i
+00011a00: 707d 206e 6f74 2077 6869 7465 6c69 7374  p} not whitelist
+00011a10: 6564 2066 6f72 206c 6973 746c 696d 6a73  ed for listlimjs
+00011a20: 6f6e 2063 6f6d 6d61 6e64 2729 0a0a 2020  on command')..  
+00011a30: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00011a40: 6966 2064 6174 6120 3d3d 2027 6c69 7374  if data == 'list
+00011a50: 6c69 6d27 3a0a 2020 2020 2020 2020 2020  lim':.          
+00011a60: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
+00011a70: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
+00011a80: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
+00011a90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00011aa0: 2020 2020 2020 2020 2020 206c 6973 745f             list_
+00011ab0: 6c69 6d69 7420 3d20 7265 6365 6976 6528  limit = receive(
+00011ac0: 7365 6c66 2e72 6571 7565 7374 290a 2020  self.request).  
+00011ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ae0: 2020 2020 2020 2320 7072 696e 7428 6164        # print(ad
+00011af0: 6472 6573 735f 7478 5f6c 6973 745f 6c69  dress_tx_list_li
+00011b00: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
+00011b10: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+00011b20: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00011b30: 203d 2064 6268 616e 646c 6572 2e44 6248   = dbhandler.DbH
+00011b40: 616e 646c 6572 286e 6f64 652e 696e 6465  andler(node.inde
+00011b50: 785f 6462 2c20 6e6f 6465 2e6c 6564 6765  x_db, node.ledge
+00011b60: 725f 7061 7468 2c20 6e6f 6465 2e68 7970  r_path, node.hyp
+00011b70: 6572 5f70 6174 682c 206e 6f64 652e 7261  er_path, node.ra
+00011b80: 6d2c 206e 6f64 652e 6c65 6467 6572 5f72  m, node.ledger_r
+00011b90: 616d 5f66 696c 652c 206e 6f64 652e 6c6f  am_file, node.lo
+00011ba0: 6767 6572 2c20 7472 6163 655f 6462 5f63  gger, trace_db_c
+00011bb0: 616c 6c73 3d6e 6f64 652e 7472 6163 655f  alls=node.trace_
+00011bc0: 6462 5f63 616c 6c73 290a 2020 2020 2020  db_calls).      
+00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011be0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+00011bf0: 7461 6e63 652e 6578 6563 7574 655f 7061  tance.execute_pa
+00011c00: 7261 6d28 6462 5f68 616e 646c 6572 5f69  ram(db_handler_i
+00011c10: 6e73 7461 6e63 652e 682c 2027 5345 4c45  nstance.h, 'SELE
+00011c20: 4354 202a 2046 524f 4d20 7472 616e 7361  CT * FROM transa
+00011c30: 6374 696f 6e73 204f 5244 4552 2042 5920  ctions ORDER BY 
+00011c40: 626c 6f63 6b5f 6865 6967 6874 2044 4553  block_height DES
+00011c50: 4320 4c49 4d49 5420 3f27 2c20 286c 6973  C LIMIT ?', (lis
+00011c60: 745f 6c69 6d69 742c 2029 290a 2020 2020  t_limit, )).    
+00011c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c80: 2020 2020 7265 7375 6c74 203d 2064 625f      result = db_
+00011c90: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00011ca0: 2e68 2e66 6574 6368 616c 6c28 290a 2020  .h.fetchall().  
+00011cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cc0: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
+00011cd0: 5f69 6e73 7461 6e63 652e 636c 6f73 6528  _instance.close(
+00011ce0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011cf0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d10: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
+00011d20: 7565 7374 2c20 7265 7375 6c74 290a 2020  uest, result).  
+00011d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d60: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+00011d70: 6c6f 672e 6465 6275 6728 6627 7b70 6565  log.debug(f'{pee
+00011d80: 725f 6970 7d20 6e6f 7420 7768 6974 656c  r_ip} not whitel
+00011d90: 6973 7465 6420 666f 7220 6c69 7374 6c69  isted for listli
+00011da0: 6d20 636f 6d6d 616e 6427 290a 0a20 2020  m command')..   
+00011db0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00011dc0: 6620 6461 7461 203d 3d20 276c 6973 7472  f data == 'listr
+00011dd0: 6577 6172 6427 3a0a 2020 2020 2020 2020  eward':.        
+00011de0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00011df0: 6f64 652e 7065 6572 732e 6973 5f61 6c6c  ode.peers.is_all
+00011e00: 6f77 6564 2870 6565 725f 6970 2c20 6461  owed(peer_ip, da
+00011e10: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+00011e20: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+00011e30: 6765 745f 6164 6472 6573 7320 3d20 7265  get_address = re
+00011e40: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
+00011e50: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
+00011e60: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+00011e70: 6b5f 7468 7265 7368 6f6c 6420 3d20 666c  k_threshold = fl
+00011e80: 6f61 7428 7265 6365 6976 6528 7365 6c66  oat(receive(self
+00011e90: 2e72 6571 7565 7374 2929 0a20 2020 2020  .request)).     
+00011ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011eb0: 2020 2023 2070 7269 6e74 2861 6464 7265     # print(addre
+00011ec0: 7373 5f74 785f 6c69 7374 5f6c 696d 6974  ss_tx_list_limit
+00011ed0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011ee0: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+00011ef0: 646c 6572 5f69 6e73 7461 6e63 6520 3d20  dler_instance = 
+00011f00: 6462 6861 6e64 6c65 722e 4462 4861 6e64  dbhandler.DbHand
+00011f10: 6c65 7228 6e6f 6465 2e69 6e64 6578 5f64  ler(node.index_d
+00011f20: 622c 206e 6f64 652e 6c65 6467 6572 5f70  b, node.ledger_p
+00011f30: 6174 682c 206e 6f64 652e 6879 7065 725f  ath, node.hyper_
+00011f40: 7061 7468 2c20 6e6f 6465 2e72 616d 2c20  path, node.ram, 
+00011f50: 6e6f 6465 2e6c 6564 6765 725f 7261 6d5f  node.ledger_ram_
+00011f60: 6669 6c65 2c20 6e6f 6465 2e6c 6f67 6765  file, node.logge
+00011f70: 722c 2074 7261 6365 5f64 625f 6361 6c6c  r, trace_db_call
+00011f80: 733d 6e6f 6465 2e74 7261 6365 5f64 625f  s=node.trace_db_
+00011f90: 6361 6c6c 7329 0a20 2020 2020 2020 2020  calls).         
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011fb0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+00011fc0: 6365 2e65 7865 6375 7465 5f70 6172 616d  ce.execute_param
+00011fd0: 2864 625f 6861 6e64 6c65 725f 696e 7374  (db_handler_inst
+00011fe0: 616e 6365 2e68 2c20 2753 454c 4543 5420  ance.h, 'SELECT 
+00011ff0: 2a20 4652 4f4d 2074 7261 6e73 6163 7469  * FROM transacti
+00012000: 6f6e 7320 5748 4552 4520 6164 6472 6573  ons WHERE addres
+00012010: 7320 3d20 3f20 414e 4420 4341 5354 2874  s = ? AND CAST(t
+00012020: 696d 6573 7461 6d70 2041 5320 494e 5445  imestamp AS INTE
+00012030: 4745 5229 203e 3d20 3f20 414e 4420 7265  GER) >= ? AND re
+00012040: 7761 7264 2021 3d20 3027 2c20 2874 6172  ward != 0', (tar
+00012050: 6765 745f 6164 6472 6573 732c 2062 6c6f  get_address, blo
+00012060: 636b 5f74 6872 6573 686f 6c64 2c20 2929  ck_threshold, ))
+00012070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012080: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00012090: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
+000120a0: 7461 6e63 652e 682e 6665 7463 6861 6c6c  tance.h.fetchall
+000120b0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000120c0: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+000120d0: 6e64 6c65 725f 696e 7374 616e 6365 2e63  ndler_instance.c
+000120e0: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
+000120f0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00012100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012110: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
+00012120: 662e 7265 7175 6573 742c 2072 6573 756c  f.request, resul
+00012130: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00012140: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012160: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+00012170: 2e61 7070 5f6c 6f67 2e64 6562 7567 2866  .app_log.debug(f
+00012180: 277b 7065 6572 5f69 707d 206e 6f74 2077  '{peer_ip} not w
+00012190: 6869 7465 6c69 7374 6564 2066 6f72 206c  hitelisted for l
+000121a0: 6973 7472 6577 6172 6420 636f 6d6d 616e  istreward comman
+000121b0: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
+000121c0: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
+000121d0: 3d20 2761 6464 6c69 7374 6c69 6d27 3a0a  = 'addlistlim':.
+000121e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121f0: 2020 2020 6966 206e 6f64 652e 7065 6572      if node.peer
+00012200: 732e 6973 5f61 6c6c 6f77 6564 2870 6565  s.is_allowed(pee
+00012210: 725f 6970 2c20 6461 7461 293a 0a20 2020  r_ip, data):.   
+00012220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012230: 2020 2020 2061 6464 7265 7373 5f74 785f       address_tx_
+00012240: 6c69 7374 203d 2072 6563 6569 7665 2873  list = receive(s
+00012250: 656c 662e 7265 7175 6573 7429 0a20 2020  elf.request).   
 00012260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012270: 2020 2020 2020 2020 2020 2020 6372 6564              cred
-00012280: 6974 203d 2064 625f 6861 6e64 6c65 725f  it = db_handler_
-00012290: 696e 7374 616e 6365 2e69 6e64 6578 5f63  instance.index_c
-000122a0: 7572 736f 722e 6665 7463 686f 6e65 2829  ursor.fetchone()
-000122b0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-000122c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122d0: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
-000122e0: 6e63 652e 6578 6563 7574 655f 7061 7261  nce.execute_para
-000122f0: 6d28 6462 5f68 616e 646c 6572 5f69 6e73  m(db_handler_ins
-00012300: 7461 6e63 652e 696e 6465 785f 6375 7273  tance.index_curs
-00012310: 6f72 2c20 2753 454c 4543 5420 7375 6d28  or, 'SELECT sum(
-00012320: 616d 6f75 6e74 2920 4652 4f4d 2074 6f6b  amount) FROM tok
-00012330: 656e 7320 5748 4552 4520 6164 6472 6573  ens WHERE addres
-00012340: 7320 3d20 3f20 414e 4420 746f 6b65 6e20  s = ? AND token 
-00012350: 3d20 3f3b 272c 2028 746f 6b65 6e73 5f61  = ?;', (tokens_a
-00012360: 6464 7265 7373 2c20 2920 2b20 2874 6f6b  ddress, ) + (tok
-00012370: 656e 2c20 2929 0a20 2020 2020 2020 2020  en, )).         
-00012380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012390: 2020 2064 6562 6974 203d 2064 625f 6861     debit = db_ha
-000123a0: 6e64 6c65 725f 696e 7374 616e 6365 2e69  ndler_instance.i
-000123b0: 6e64 6578 5f63 7572 736f 722e 6665 7463  ndex_cursor.fetc
-000123c0: 686f 6e65 2829 5b30 5d0a 0a20 2020 2020  hone()[0]..     
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 2020 2020 2020 2064 6562 6974 203d 2030         debit = 0
-000123f0: 2069 6620 6465 6269 7420 6973 204e 6f6e   if debit is Non
-00012400: 6520 656c 7365 2064 6562 6974 0a20 2020  e else debit.   
+00012270: 2020 2020 2061 6464 7265 7373 5f74 785f       address_tx_
+00012280: 6c69 7374 5f6c 696d 6974 203d 2072 6563  list_limit = rec
+00012290: 6569 7665 2873 656c 662e 7265 7175 6573  eive(self.reques
+000122a0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+000122b0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+000122c0: 696e 7428 6164 6472 6573 735f 7478 5f6c  int(address_tx_l
+000122d0: 6973 745f 6c69 6d69 7429 0a20 2020 2020  ist_limit).     
+000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122f0: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+00012300: 7374 616e 6365 203d 2064 6268 616e 646c  stance = dbhandl
+00012310: 6572 2e44 6248 616e 646c 6572 286e 6f64  er.DbHandler(nod
+00012320: 652e 696e 6465 785f 6462 2c20 6e6f 6465  e.index_db, node
+00012330: 2e6c 6564 6765 725f 7061 7468 2c20 6e6f  .ledger_path, no
+00012340: 6465 2e68 7970 6572 5f70 6174 682c 206e  de.hyper_path, n
+00012350: 6f64 652e 7261 6d2c 206e 6f64 652e 6c65  ode.ram, node.le
+00012360: 6467 6572 5f72 616d 5f66 696c 652c 206e  dger_ram_file, n
+00012370: 6f64 652e 6c6f 6767 6572 2c20 7472 6163  ode.logger, trac
+00012380: 655f 6462 5f63 616c 6c73 3d6e 6f64 652e  e_db_calls=node.
+00012390: 7472 6163 655f 6462 5f63 616c 6c73 290a  trace_db_calls).
+000123a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123b0: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
+000123c0: 6572 5f69 6e73 7461 6e63 652e 6578 6563  er_instance.exec
+000123d0: 7574 655f 7061 7261 6d28 0a20 2020 2020  ute_param(.     
+000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123f0: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00012400: 725f 696e 7374 616e 6365 2e68 2c0a 2020  r_instance.h,.  
 00012410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012420: 2020 2020 2020 2020 2063 7265 6469 7420           credit 
-00012430: 3d20 3020 6966 2063 7265 6469 7420 6973  = 0 if credit is
-00012440: 204e 6f6e 6520 656c 7365 2063 7265 6469   None else credi
-00012450: 740a 0a20 2020 2020 2020 2020 2020 2020  t..             
-00012460: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00012470: 616c 616e 6365 203d 2073 7472 2844 6563  alance = str(Dec
-00012480: 696d 616c 2863 7265 6469 7429 202d 2044  imal(credit) - D
-00012490: 6563 696d 616c 2864 6562 6974 2929 0a0a  ecimal(debit))..
-000124a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124b0: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-000124c0: 6e73 5f6c 6973 742e 6170 7065 6e64 2828  ns_list.append((
-000124d0: 746f 6b65 6e2c 2062 616c 616e 6365 2929  token, balance))
-000124e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000124f0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
-00012500: 656c 662e 7265 7175 6573 742c 2074 6f6b  elf.request, tok
-00012510: 656e 735f 6c69 7374 290a 2020 2020 2020  ens_list).      
-00012520: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00012530: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012540: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00012550: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-00012560: 696e 666f 2866 277b 7065 6572 5f69 707d  info(f'{peer_ip}
-00012570: 206e 6f74 2077 6869 7465 6c69 7374 6564   not whitelisted
-00012580: 2066 6f72 2074 6f6b 656e 7367 6574 2063   for tokensget c
-00012590: 6f6d 6d61 6e64 2729 0a0a 2020 2020 2020  ommand')..      
-000125a0: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
-000125b0: 6174 6120 3d3d 2027 6164 6466 726f 6d61  ata == 'addfroma
-000125c0: 6c69 6173 273a 0a20 2020 2020 2020 2020  lias':.         
-000125d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000125e0: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
-000125f0: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
-00012600: 6129 3a0a 0a20 2020 2020 2020 2020 2020  a):..           
-00012610: 2020 2020 2020 2020 2020 2020 2061 6c69               ali
-00012620: 6173 6573 2e61 6c69 6173 6573 5f75 7064  ases.aliases_upd
-00012630: 6174 6528 6e6f 6465 2c20 6462 5f68 616e  ate(node, db_han
-00012640: 646c 6572 5f69 6e73 7461 6e63 6529 0a0a  dler_instance)..
-00012650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012660: 2020 2020 2020 2020 616c 6961 735f 6164          alias_ad
-00012670: 6472 6573 7320 3d20 7265 6365 6976 6528  dress = receive(
-00012680: 7365 6c66 2e72 6571 7565 7374 290a 2020  self.request).  
-00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126a0: 2020 2020 2020 6164 6472 6573 735f 6665        address_fe
-000126b0: 7463 6820 3d20 6462 5f68 616e 646c 6572  tch = db_handler
-000126c0: 5f69 6e73 7461 6e63 652e 6164 6466 726f  _instance.addfro
-000126d0: 6d61 6c69 6173 2861 6c69 6173 5f61 6464  malias(alias_add
-000126e0: 7265 7373 290a 2020 2020 2020 2020 2020  ress).          
-000126f0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00012700: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00012710: 672e 7761 726e 696e 6728 6627 4665 7463  g.warning(f'Fetc
-00012720: 6865 6420 7468 6520 666f 6c6c 6f77 696e  hed the followin
-00012730: 6720 616c 6961 7320 6164 6472 6573 733a  g alias address:
-00012740: 207b 6164 6472 6573 735f 6665 7463 687d   {address_fetch}
-00012750: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00012760: 2020 2020 2020 2020 2020 2073 656e 6428             send(
-00012770: 7365 6c66 2e72 6571 7565 7374 2c20 6164  self.request, ad
-00012780: 6472 6573 735f 6665 7463 6829 0a0a 2020  dress_fetch)..  
-00012790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-000127d0: 6c6f 672e 696e 666f 2866 277b 7065 6572  log.info(f'{peer
-000127e0: 5f69 707d 206e 6f74 2077 6869 7465 6c69  _ip} not whiteli
-000127f0: 7374 6564 2066 6f72 2061 6464 6672 6f6d  sted for addfrom
-00012800: 616c 6961 7320 636f 6d6d 616e 6427 290a  alias command').
-00012810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012820: 2065 6c69 6620 6461 7461 203d 3d20 2770   elif data == 'p
-00012830: 7562 6b65 7967 6574 273a 0a20 2020 2020  ubkeyget':.     
-00012840: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012850: 6620 6e6f 6465 2e70 6565 7273 2e69 735f  f node.peers.is_
-00012860: 616c 6c6f 7765 6428 7065 6572 5f69 702c  allowed(peer_ip,
-00012870: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
-00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012890: 7075 625f 6b65 795f 6164 6472 6573 7320  pub_key_address 
-000128a0: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
-000128b0: 6571 7565 7374 290a 2020 2020 2020 2020  equest).        
-000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128d0: 7461 7267 6574 5f70 7562 6c69 635f 6b65  target_public_ke
-000128e0: 795f 6236 3465 6e63 6f64 6564 203d 2064  y_b64encoded = d
-000128f0: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-00012900: 6365 2e70 7562 6b65 7967 6574 2870 7562  ce.pubkeyget(pub
-00012910: 5f6b 6579 5f61 6464 7265 7373 290a 2020  _key_address).  
-00012920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012930: 2020 2020 2020 2320 7265 7475 726e 7320        # returns 
-00012940: 6173 2073 746f 7265 6420 696e 2074 6865  as stored in the
-00012950: 2044 422c 2074 6861 7420 6973 2062 3634   DB, that is b64
-00012960: 2065 6e63 6f64 6564 2c20 6578 6365 7074   encoded, except
-00012970: 2066 6f72 2052 5341 2077 6865 7265 2069   for RSA where i
-00012980: 7427 7320 6236 3420 656e 636f 6465 6420  t's b64 encoded 
-00012990: 7477 6963 652e 0a20 2020 2020 2020 2020  twice..         
-000129a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000129b0: 656e 6428 7365 6c66 2e72 6571 7565 7374  end(self.request
-000129c0: 2c20 7461 7267 6574 5f70 7562 6c69 635f  , target_public_
-000129d0: 6b65 795f 6236 3465 6e63 6f64 6564 290a  key_b64encoded).
-000129e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000129f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a10: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-00012a20: 7070 5f6c 6f67 2e69 6e66 6f28 6627 7b70  pp_log.info(f'{p
-00012a30: 6565 725f 6970 7d20 6e6f 7420 7768 6974  eer_ip} not whit
-00012a40: 656c 6973 7465 6420 666f 7220 7075 626b  elisted for pubk
-00012a50: 6579 6765 7420 636f 6d6d 616e 6427 290a  eyget command').
-00012a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012a70: 2065 6c69 6620 6461 7461 203d 3d20 2761   elif data == 'a
-00012a80: 6c69 6173 6368 6563 6b27 3a0a 2020 2020  liascheck':.    
-00012a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012aa0: 6966 206e 6f64 652e 7065 6572 732e 6973  if node.peers.is
-00012ab0: 5f61 6c6c 6f77 6564 2870 6565 725f 6970  _allowed(peer_ip
-00012ac0: 2c20 6461 7461 293a 0a20 2020 2020 2020  , data):.       
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ae0: 2072 6567 5f73 7472 696e 6720 3d20 7265   reg_string = re
-00012af0: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
-00012b00: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
-00012b10: 2020 2020 2020 2020 2020 2020 2072 6567               reg
-00012b20: 6973 7465 7265 645f 7065 6e64 696e 6720  istered_pending 
-00012b30: 3d20 6d70 2e4d 454d 504f 4f4c 2e66 6574  = mp.MEMPOOL.fet
-00012b40: 6368 6f6e 6528 2753 454c 4543 5420 7469  chone('SELECT ti
-00012b50: 6d65 7374 616d 7020 4652 4f4d 2074 7261  mestamp FROM tra
-00012b60: 6e73 6163 7469 6f6e 7320 5748 4552 4520  nsactions WHERE 
-00012b70: 6f70 656e 6669 656c 6420 3d20 3f3b 272c  openfield = ?;',
-00012b80: 2028 2761 6c69 6173 3d27 202b 2072 6567   ('alias=' + reg
-00012b90: 5f73 7472 696e 672c 2029 290a 0a20 2020  _string, ))..   
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bb0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
-00012bc0: 696e 7374 616e 6365 2e65 7865 6375 7465  instance.execute
-00012bd0: 5f70 6172 616d 2864 625f 6861 6e64 6c65  _param(db_handle
-00012be0: 725f 696e 7374 616e 6365 2e68 2c20 2753  r_instance.h, 'S
-00012bf0: 454c 4543 5420 7469 6d65 7374 616d 7020  ELECT timestamp 
-00012c00: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-00012c10: 7320 5748 4552 4520 6f70 656e 6669 656c  s WHERE openfiel
-00012c20: 6420 3d20 3f3b 272c 2028 2761 6c69 6173  d = ?;', ('alias
-00012c30: 3d27 202b 2072 6567 5f73 7472 696e 672c  =' + reg_string,
-00012c40: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
-00012c50: 2020 2020 2020 2020 2020 2020 7265 6769              regi
-00012c60: 7374 6572 6564 5f61 6c72 6561 6479 203d  stered_already =
-00012c70: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
-00012c80: 616e 6365 2e68 2e66 6574 6368 6f6e 6528  ance.h.fetchone(
-00012c90: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00012ca0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-00012cb0: 6769 7374 6572 6564 5f61 6c72 6561 6479  gistered_already
-00012cc0: 2069 7320 4e6f 6e65 2061 6e64 2072 6567   is None and reg
-00012cd0: 6973 7465 7265 645f 7065 6e64 696e 6720  istered_pending 
-00012ce0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00012420: 2020 2020 2020 2020 2020 2827 5345 4c45            ('SELE
+00012430: 4354 202a 2046 524f 4d20 7472 616e 7361  CT * FROM transa
+00012440: 6374 696f 6e73 2057 4845 5245 2028 6164  ctions WHERE (ad
+00012450: 6472 6573 7320 3d20 3f20 4f52 2072 6563  dress = ? OR rec
+00012460: 6970 6965 6e74 203d 203f 2920 4f52 4445  ipient = ?) ORDE
+00012470: 5220 4259 2062 6c6f 636b 5f68 6569 6768  R BY block_heigh
+00012480: 7420 4445 5343 204c 494d 4954 203f 2729  t DESC LIMIT ?')
+00012490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000124a0: 2020 2020 2020 2020 2020 2020 2020 280a                (.
+000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124d0: 6164 6472 6573 735f 7478 5f6c 6973 742c  address_tx_list,
+000124e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012500: 2061 6464 7265 7373 5f74 785f 6c69 7374   address_tx_list
+00012510: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012530: 2020 6164 6472 6573 735f 7478 5f6c 6973    address_tx_lis
+00012540: 745f 6c69 6d69 742c 0a20 2020 2020 2020  t_limit,.       
+00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012560: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012590: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000125a0: 203d 2064 625f 6861 6e64 6c65 725f 696e   = db_handler_in
+000125b0: 7374 616e 6365 2e68 2e66 6574 6368 616c  stance.h.fetchal
+000125c0: 6c28 290a 2020 2020 2020 2020 2020 2020  l().            
+000125d0: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+000125e0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+000125f0: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+00012600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012610: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+00012620: 7374 2c20 7265 7375 6c74 290a 2020 2020  st, result).    
+00012630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012640: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012650: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00012660: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+00012670: 672e 6465 6275 6728 6627 7b70 6565 725f  g.debug(f'{peer_
+00012680: 6970 7d20 6e6f 7420 7768 6974 656c 6973  ip} not whitelis
+00012690: 7465 6420 666f 7220 6164 646c 6973 746c  ted for addlistl
+000126a0: 696d 2063 6f6d 6d61 6e64 2729 0a0a 2020  im command')..  
+000126b0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000126c0: 6966 2064 6174 6120 3d3d 2027 6164 646c  if data == 'addl
+000126d0: 6973 746c 696d 6a73 6f6e 273a 0a20 2020  istlimjson':.   
+000126e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126f0: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
+00012700: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
+00012710: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
+00012720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012730: 2020 6164 6472 6573 735f 7478 5f6c 6973    address_tx_lis
+00012740: 7420 3d20 7265 6365 6976 6528 7365 6c66  t = receive(self
+00012750: 2e72 6571 7565 7374 290a 2020 2020 2020  .request).      
+00012760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012770: 2020 6164 6472 6573 735f 7478 5f6c 6973    address_tx_lis
+00012780: 745f 6c69 6d69 7420 3d20 7265 6365 6976  t_limit = receiv
+00012790: 6528 7365 6c66 2e72 6571 7565 7374 290a  e(self.request).
+000127a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000127b0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+000127c0: 2861 6464 7265 7373 5f74 785f 6c69 7374  (address_tx_list
+000127d0: 5f6c 696d 6974 290a 2020 2020 2020 2020  _limit).        
+000127e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127f0: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00012800: 6e63 6520 3d20 6462 6861 6e64 6c65 722e  nce = dbhandler.
+00012810: 4462 4861 6e64 6c65 7228 6e6f 6465 2e69  DbHandler(node.i
+00012820: 6e64 6578 5f64 622c 206e 6f64 652e 6c65  ndex_db, node.le
+00012830: 6467 6572 5f70 6174 682c 206e 6f64 652e  dger_path, node.
+00012840: 6879 7065 725f 7061 7468 2c20 6e6f 6465  hyper_path, node
+00012850: 2e72 616d 2c20 6e6f 6465 2e6c 6564 6765  .ram, node.ledge
+00012860: 725f 7261 6d5f 6669 6c65 2c20 6e6f 6465  r_ram_file, node
+00012870: 2e6c 6f67 6765 722c 2074 7261 6365 5f64  .logger, trace_d
+00012880: 625f 6361 6c6c 733d 6e6f 6465 2e74 7261  b_calls=node.tra
+00012890: 6365 5f64 625f 6361 6c6c 7329 0a20 2020  ce_db_calls).   
+000128a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128b0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+000128c0: 696e 7374 616e 6365 2e65 7865 6375 7465  instance.execute
+000128d0: 5f70 6172 616d 280a 2020 2020 2020 2020  _param(.        
+000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128f0: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+00012900: 6e73 7461 6e63 652e 682c 0a20 2020 2020  nstance.h,.     
+00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012920: 2020 2020 2020 2028 2753 454c 4543 5420         ('SELECT 
+00012930: 2a20 4652 4f4d 2074 7261 6e73 6163 7469  * FROM transacti
+00012940: 6f6e 7320 5748 4552 4520 2861 6464 7265  ons WHERE (addre
+00012950: 7373 203d 203f 204f 5220 7265 6369 7069  ss = ? OR recipi
+00012960: 656e 7420 3d20 3f29 204f 5244 4552 2042  ent = ?) ORDER B
+00012970: 5920 626c 6f63 6b5f 6865 6967 6874 2044  Y block_height D
+00012980: 4553 4320 4c49 4d49 5420 3f27 292c 0a20  ESC LIMIT ?'),. 
+00012990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129a0: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+000129b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129c0: 2020 2020 2020 2020 2020 2020 2061 6464               add
+000129d0: 7265 7373 5f74 785f 6c69 7374 2c0a 2020  ress_tx_list,.  
+000129e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129f0: 2020 2020 2020 2020 2020 2020 2020 6164                ad
+00012a00: 6472 6573 735f 7478 5f6c 6973 742c 0a20  dress_tx_list,. 
+00012a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00012a30: 6464 7265 7373 5f74 785f 6c69 7374 5f6c  ddress_tx_list_l
+00012a40: 696d 6974 2c0a 2020 2020 2020 2020 2020  imit,.          
+00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a60: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00012a70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00012a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a90: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00012aa0: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00012ab0: 6e63 652e 682e 6665 7463 6861 6c6c 2829  nce.h.fetchall()
+00012ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012ad0: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+00012ae0: 6c65 725f 696e 7374 616e 6365 2e63 6c6f  ler_instance.clo
+00012af0: 7365 2829 0a0a 2020 2020 2020 2020 2020  se()..          
+00012b00: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00012b10: 7370 6f6e 7365 5f6c 6973 7420 3d20 5b5d  sponse_list = []
+00012b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012b30: 2020 2020 2020 2020 2066 6f72 2074 7261           for tra
+00012b40: 6e73 6163 7469 6f6e 2069 6e20 7265 7375  nsaction in resu
+00012b50: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+00012b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b70: 7265 7370 6f6e 7365 203d 207b 0a20 2020  response = {.   
+00012b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b90: 2020 2020 2020 2020 2020 2020 2027 626c               'bl
+00012ba0: 6f63 6b5f 6865 6967 6874 273a 2074 7261  ock_height': tra
+00012bb0: 6e73 6163 7469 6f6e 5b30 5d2c 0a20 2020  nsaction[0],.   
+00012bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012bd0: 2020 2020 2020 2020 2020 2020 2027 7469               'ti
+00012be0: 6d65 7374 616d 7027 3a20 7472 616e 7361  mestamp': transa
+00012bf0: 6374 696f 6e5b 315d 2c0a 2020 2020 2020  ction[1],.      
+00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c10: 2020 2020 2020 2020 2020 2761 6464 7265            'addre
+00012c20: 7373 273a 2074 7261 6e73 6163 7469 6f6e  ss': transaction
+00012c30: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+00012c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c50: 2020 2020 2027 7265 6369 7069 656e 7427       'recipient'
+00012c60: 3a20 7472 616e 7361 6374 696f 6e5b 335d  : transaction[3]
+00012c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c90: 2020 2761 6d6f 756e 7427 3a20 7472 616e    'amount': tran
+00012ca0: 7361 6374 696f 6e5b 345d 2c0a 2020 2020  saction[4],.    
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 2020 2020 2020 2020 2020 2020 2773 6967              'sig
+00012cd0: 6e61 7475 7265 273a 2074 7261 6e73 6163  nature': transac
+00012ce0: 7469 6f6e 5b35 5d2c 0a20 2020 2020 2020  tion[5],.       
 00012cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d00: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-00012d10: 6571 7565 7374 2c20 2741 6c69 6173 2066  equest, 'Alias f
-00012d20: 7265 6527 290a 2020 2020 2020 2020 2020  ree').          
-00012d30: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00012d40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d60: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-00012d70: 742c 2027 416c 6961 7320 7265 6769 7374  t, 'Alias regist
-00012d80: 6572 6564 2729 0a20 2020 2020 2020 2020  ered').         
-00012d90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00012da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012db0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-00012dc0: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-00012dd0: 6f28 6627 7b70 6565 725f 6970 7d20 6e6f  o(f'{peer_ip} no
-00012de0: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
-00012df0: 7220 616c 6961 7363 6865 636b 2063 6f6d  r aliascheck com
-00012e00: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-00012e10: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-00012e20: 6120 3d3d 2027 7478 7365 6e64 273a 0a20  a == 'txsend':. 
-00012e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e40: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
-00012e50: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-00012e60: 6973 206d 6f73 7420 756e 7361 6665 2061  is most unsafe a
-00012e70: 6e64 2073 686f 756c 6420 6e65 7665 7220  nd should never 
-00012e80: 6265 2075 7365 642e 0a20 2020 2020 2020  be used..       
-00012e90: 2020 2020 2020 2020 2020 2020 202d 206e               - n
-00012ea0: 6f64 6520 6765 7473 2074 6865 2070 7269  ode gets the pri
-00012eb0: 766b 6579 0a20 2020 2020 2020 2020 2020  vkey.           
-00012ec0: 2020 2020 2020 2020 202d 2064 7570 2063           - dup c
-00012ed0: 6f64 6520 666f 7220 6173 7365 6d62 6c69  ode for assembli
-00012ee0: 6e67 2061 6e64 2073 6967 6e69 6e67 2074  ng and signing t
-00012ef0: 6865 2054 580a 2020 2020 2020 2020 2020  he TX.          
-00012f00: 2020 2020 2020 2020 2020 544f 444f 3a20            TODO: 
-00012f10: 4445 5052 4543 4154 4544 0a20 2020 2020  DEPRECATED.     
-00012f20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00012f30: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-00012f40: 2020 2020 2020 2069 6620 6e6f 6465 2e70         if node.p
-00012f50: 6565 7273 2e69 735f 616c 6c6f 7765 6428  eers.is_allowed(
-00012f60: 7065 6572 5f69 702c 2064 6174 6129 3a0a  peer_ip, data):.
-00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f80: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00012f90: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-00012fa0: 696e 6728 2274 7873 656e 6420 6973 2075  ing("txsend is u
-00012fb0: 6e73 6166 6520 616e 6420 6465 7072 6563  nsafe and deprec
-00012fc0: 6174 6564 2c20 706c 6561 7365 2064 6f6e  ated, please don
-00012fd0: 2774 2075 7365 2e22 290a 2020 2020 2020  't use.").      
+00012d00: 2020 2020 2020 2020 2027 7075 626c 6963           'public
+00012d10: 5f6b 6579 273a 2074 7261 6e73 6163 7469  _key': transacti
+00012d20: 6f6e 5b36 5d2c 0a20 2020 2020 2020 2020  on[6],.         
+00012d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d40: 2020 2020 2020 2027 626c 6f63 6b5f 6861         'block_ha
+00012d50: 7368 273a 2074 7261 6e73 6163 7469 6f6e  sh': transaction
+00012d60: 5b37 5d2c 0a20 2020 2020 2020 2020 2020  [7],.           
+00012d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d80: 2020 2020 2027 6665 6527 3a20 7472 616e       'fee': tran
+00012d90: 7361 6374 696f 6e5b 385d 2c0a 2020 2020  saction[8],.    
+00012da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012db0: 2020 2020 2020 2020 2020 2020 2772 6577              'rew
+00012dc0: 6172 6427 3a20 7472 616e 7361 6374 696f  ard': transactio
+00012dd0: 6e5b 395d 2c0a 2020 2020 2020 2020 2020  n[9],.          
+00012de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012df0: 2020 2020 2020 276f 7065 7261 7469 6f6e        'operation
+00012e00: 273a 2074 7261 6e73 6163 7469 6f6e 5b31  ': transaction[1
+00012e10: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00012e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e30: 2020 2020 276f 7065 6e66 6965 6c64 273a      'openfield':
+00012e40: 2074 7261 6e73 6163 7469 6f6e 5b31 315d   transaction[11]
+00012e50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012e60: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00012e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012e80: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00012e90: 706f 6e73 655f 6c69 7374 2e61 7070 656e  ponse_list.appen
+00012ea0: 6428 7265 7370 6f6e 7365 290a 0a20 2020  d(response)..   
+00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ec0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+00012ed0: 6571 7565 7374 2c20 7265 7370 6f6e 7365  equest, response
+00012ee0: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
+00012ef0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00012f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f10: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+00012f20: 6767 6572 2e61 7070 5f6c 6f67 2e64 6562  gger.app_log.deb
+00012f30: 7567 2866 277b 7065 6572 5f69 707d 206e  ug(f'{peer_ip} n
+00012f40: 6f74 2077 6869 7465 6c69 7374 6564 2066  ot whitelisted f
+00012f50: 6f72 2061 6464 6c69 7374 6c69 6d6a 736f  or addlistlimjso
+00012f60: 6e20 636f 6d6d 616e 6427 290a 0a20 2020  n command')..   
+00012f70: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00012f80: 6620 6461 7461 203d 3d20 2761 6464 6c69  f data == 'addli
+00012f90: 7374 6c69 6d6d 6972 273a 0a20 2020 2020  stlimmir':.     
+00012fa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012fb0: 6620 6e6f 6465 2e70 6565 7273 2e69 735f  f node.peers.is_
+00012fc0: 616c 6c6f 7765 6428 7065 6572 5f69 702c  allowed(peer_ip,
+00012fd0: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
 00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ff0: 2020 7478 5f72 656d 6f74 6520 3d20 7265    tx_remote = re
-00013000: 6365 6976 6528 7365 6c66 2e72 6571 7565  ceive(self.reque
-00013010: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
-00013020: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-00013030: 6563 6569 7665 2064 6174 6120 6e65 6365  eceive data nece
-00013040: 7373 6172 7920 666f 7220 7265 6d6f 7465  ssary for remote
-00013050: 2074 7820 636f 6e73 7472 7563 7469 6f6e   tx construction
-00013060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013070: 2020 2020 2020 2020 2072 656d 6f74 655f           remote_
-00013080: 7478 5f74 696d 6573 7461 6d70 203d 2074  tx_timestamp = t
-00013090: 785f 7265 6d6f 7465 5b30 5d0a 2020 2020  x_remote[0].    
-000130a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130b0: 2020 2020 7265 6d6f 7465 5f74 785f 7072      remote_tx_pr
-000130c0: 6976 6b65 7920 3d20 7478 5f72 656d 6f74  ivkey = tx_remot
-000130d0: 655b 315d 0a20 2020 2020 2020 2020 2020  e[1].           
-000130e0: 2020 2020 2020 2020 2020 2020 2072 656d               rem
-000130f0: 6f74 655f 7478 5f72 6563 6970 6965 6e74  ote_tx_recipient
-00013100: 203d 2074 785f 7265 6d6f 7465 5b32 5d0a   = tx_remote[2].
-00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013120: 2020 2020 2020 2020 7265 6d6f 7465 5f74          remote_t
-00013130: 785f 616d 6f75 6e74 203d 2074 785f 7265  x_amount = tx_re
-00013140: 6d6f 7465 5b33 5d0a 2020 2020 2020 2020  mote[3].        
-00013150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013160: 7265 6d6f 7465 5f74 785f 6f70 6572 6174  remote_tx_operat
-00013170: 696f 6e20 3d20 7478 5f72 656d 6f74 655b  ion = tx_remote[
-00013180: 345d 0a20 2020 2020 2020 2020 2020 2020  4].             
-00013190: 2020 2020 2020 2020 2020 2072 656d 6f74             remot
-000131a0: 655f 7478 5f6f 7065 6e66 6965 6c64 203d  e_tx_openfield =
-000131b0: 2074 785f 7265 6d6f 7465 5b35 5d0a 2020   tx_remote[5].  
-000131c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131d0: 2020 2020 2020 2320 7265 6365 6976 6520        # receive 
-000131e0: 6461 7461 206e 6563 6573 7361 7279 2066  data necessary f
-000131f0: 6f72 2072 656d 6f74 6520 7478 2063 6f6e  or remote tx con
-00013200: 7374 7275 6374 696f 6e0a 0a20 2020 2020  struction..     
-00013210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013220: 2020 2023 2064 6572 6976 6520 7265 6d61     # derive rema
-00013230: 696e 696e 6720 6461 7461 0a20 2020 2020  ining data.     
-00013240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013250: 2020 2074 785f 7265 6d6f 7465 5f6b 6579     tx_remote_key
-00013260: 203d 2052 5341 2e69 6d70 6f72 744b 6579   = RSA.importKey
-00013270: 2872 656d 6f74 655f 7478 5f70 7269 766b  (remote_tx_privk
-00013280: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-00013290: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
-000132a0: 7465 5f74 785f 7075 626b 6579 203d 2074  te_tx_pubkey = t
-000132b0: 785f 7265 6d6f 7465 5f6b 6579 2e70 7562  x_remote_key.pub
-000132c0: 6c69 636b 6579 2829 2e65 7870 6f72 744b  lickey().exportK
-000132d0: 6579 2829 2e64 6563 6f64 6528 2775 7466  ey().decode('utf
-000132e0: 2d38 2729 0a0a 2020 2020 2020 2020 2020  -8')..          
-000132f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013300: 6d6f 7465 5f74 785f 7075 626b 6579 5f62  mote_tx_pubkey_b
-00013310: 3634 656e 636f 6465 6420 3d20 6261 7365  64encoded = base
-00013320: 3634 2e62 3634 656e 636f 6465 2872 656d  64.b64encode(rem
-00013330: 6f74 655f 7478 5f70 7562 6b65 792e 656e  ote_tx_pubkey.en
-00013340: 636f 6465 2827 7574 662d 3827 2929 2e64  code('utf-8')).d
-00013350: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
-00013360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013370: 2020 2020 2020 2020 7265 6d6f 7465 5f74          remote_t
-00013380: 785f 6164 6472 6573 7320 3d20 6861 7368  x_address = hash
-00013390: 6c69 622e 7368 6132 3234 2872 656d 6f74  lib.sha224(remot
-000133a0: 655f 7478 5f70 7562 6b65 792e 656e 636f  e_tx_pubkey.enco
-000133b0: 6465 2827 7574 662d 3827 2929 2e68 6578  de('utf-8')).hex
-000133c0: 6469 6765 7374 2829 0a20 2020 2020 2020  digest().       
+00012ff0: 6164 6472 6573 735f 7478 5f6c 6973 7420  address_tx_list 
+00013000: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
+00013010: 6571 7565 7374 290a 2020 2020 2020 2020  equest).        
+00013020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013030: 6164 6472 6573 735f 7478 5f6c 6973 745f  address_tx_list_
+00013040: 6c69 6d69 7420 3d20 7265 6365 6976 6528  limit = receive(
+00013050: 7365 6c66 2e72 6571 7565 7374 290a 0a20  self.request).. 
+00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013070: 2020 2020 2020 2023 2070 7269 6e74 2861         # print(a
+00013080: 6464 7265 7373 5f74 785f 6c69 7374 5f6c  ddress_tx_list_l
+00013090: 696d 6974 290a 2020 2020 2020 2020 2020  imit).          
+000130a0: 2020 2020 2020 2020 2020 2020 2020 6462                db
+000130b0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+000130c0: 6520 3d20 6462 6861 6e64 6c65 722e 4462  e = dbhandler.Db
+000130d0: 4861 6e64 6c65 7228 6e6f 6465 2e69 6e64  Handler(node.ind
+000130e0: 6578 5f64 622c 206e 6f64 652e 6c65 6467  ex_db, node.ledg
+000130f0: 6572 5f70 6174 682c 206e 6f64 652e 6879  er_path, node.hy
+00013100: 7065 725f 7061 7468 2c20 6e6f 6465 2e72  per_path, node.r
+00013110: 616d 2c20 6e6f 6465 2e6c 6564 6765 725f  am, node.ledger_
+00013120: 7261 6d5f 6669 6c65 2c20 6e6f 6465 2e6c  ram_file, node.l
+00013130: 6f67 6765 722c 2074 7261 6365 5f64 625f  ogger, trace_db_
+00013140: 6361 6c6c 733d 6e6f 6465 2e74 7261 6365  calls=node.trace
+00013150: 5f64 625f 6361 6c6c 7329 0a20 2020 2020  _db_calls).     
+00013160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013170: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+00013180: 7374 616e 6365 2e65 7865 6375 7465 5f70  stance.execute_p
+00013190: 6172 616d 280a 2020 2020 2020 2020 2020  aram(.          
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+000131c0: 7461 6e63 652e 682c 0a20 2020 2020 2020  tance.h,.       
+000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131e0: 2020 2020 2028 2753 454c 4543 5420 2a20       ('SELECT * 
+000131f0: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
+00013200: 7320 5748 4552 4520 2861 6464 7265 7373  s WHERE (address
+00013210: 203d 203f 204f 5220 7265 6369 7069 656e   = ? OR recipien
+00013220: 7420 3d20 3f29 2041 4e44 2062 6c6f 636b  t = ?) AND block
+00013230: 5f68 6569 6768 7420 3c20 3120 4f52 4445  _height < 1 ORDE
+00013240: 5220 4259 2062 6c6f 636b 5f68 6569 6768  R BY block_heigh
+00013250: 7420 4153 4320 4c49 4d49 5420 3f27 292c  t ASC LIMIT ?'),
+00013260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013270: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
+00013280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013290: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000132a0: 6464 7265 7373 5f74 785f 6c69 7374 2c0a  ddress_tx_list,.
+000132b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132d0: 6164 6472 6573 735f 7478 5f6c 6973 742c  address_tx_list,
+000132e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000132f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013300: 2061 6464 7265 7373 5f74 785f 6c69 7374   address_tx_list
+00013310: 5f6c 696d 6974 2c0a 2020 2020 2020 2020  _limit,.        
+00013320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013330: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00013340: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00013350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013360: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00013370: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
+00013380: 7461 6e63 652e 682e 6665 7463 6861 6c6c  tance.h.fetchall
+00013390: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000133a0: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+000133b0: 6e64 6c65 725f 696e 7374 616e 6365 2e63  ndler_instance.c
+000133c0: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
 000133d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133e0: 2023 2064 6572 6976 6520 7265 6d61 696e   # derive remain
-000133f0: 696e 6720 6461 7461 0a0a 2020 2020 2020  ing data..      
-00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013410: 2020 2320 636f 6e73 7472 7563 7420 7478    # construct tx
-00013420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013430: 2020 2020 2020 2020 2072 656d 6f74 655f           remote_
-00013440: 7478 203d 2028 7374 7228 7265 6d6f 7465  tx = (str(remote
-00013450: 5f74 785f 7469 6d65 7374 616d 7029 2c20  _tx_timestamp), 
-00013460: 7374 7228 7265 6d6f 7465 5f74 785f 6164  str(remote_tx_ad
-00013470: 6472 6573 7329 2c20 7374 7228 7265 6d6f  dress), str(remo
-00013480: 7465 5f74 785f 7265 6369 7069 656e 7429  te_tx_recipient)
-00013490: 2c20 2725 2e38 6627 2025 2071 7561 6e74  , '%.8f' % quant
-000134a0: 697a 655f 6569 6768 7428 7265 6d6f 7465  ize_eight(remote
-000134b0: 5f74 785f 616d 6f75 6e74 292c 2073 7472  _tx_amount), str
-000134c0: 2872 656d 6f74 655f 7478 5f6f 7065 7261  (remote_tx_opera
-000134d0: 7469 6f6e 292c 2073 7472 2872 656d 6f74  tion), str(remot
-000134e0: 655f 7478 5f6f 7065 6e66 6965 6c64 2929  e_tx_openfield))
-000134f0: 2020 2320 7468 6973 2069 7320 7369 676e    # this is sign
-00013500: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
-00013510: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
-00013520: 7465 5f68 6173 6820 3d20 5348 412e 6e65  te_hash = SHA.ne
-00013530: 7728 7374 7228 7265 6d6f 7465 5f74 7829  w(str(remote_tx)
-00013540: 2e65 6e63 6f64 6528 2775 7466 2d38 2729  .encode('utf-8')
-00013550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013560: 2020 2020 2020 2020 2020 7265 6d6f 7465            remote
-00013570: 5f73 6967 6e65 7220 3d20 504b 4353 315f  _signer = PKCS1_
-00013580: 7631 5f35 2e6e 6577 2874 785f 7265 6d6f  v1_5.new(tx_remo
-00013590: 7465 5f6b 6579 290a 2020 2020 2020 2020  te_key).        
-000135a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135b0: 7265 6d6f 7465 5f73 6967 6e61 7475 7265  remote_signature
-000135c0: 203d 2072 656d 6f74 655f 7369 676e 6572   = remote_signer
-000135d0: 2e73 6967 6e28 7265 6d6f 7465 5f68 6173  .sign(remote_has
-000135e0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-000135f0: 2020 2020 2020 2020 2020 2072 656d 6f74             remot
-00013600: 655f 7369 676e 6174 7572 655f 656e 6320  e_signature_enc 
-00013610: 3d20 6261 7365 3634 2e62 3634 656e 636f  = base64.b64enco
-00013620: 6465 2872 656d 6f74 655f 7369 676e 6174  de(remote_signat
-00013630: 7572 6529 2e64 6563 6f64 6528 2775 7466  ure).decode('utf
-00013640: 2d38 2729 0a20 2020 2020 2020 2020 2020  -8').           
-00013650: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-00013660: 6f6e 7374 7275 6374 2074 780a 0a20 2020  onstruct tx..   
-00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013680: 2020 2020 2023 2069 6e73 6572 7420 746f       # insert to
-00013690: 206d 656d 706f 6f6c 2c20 7768 6572 6520   mempool, where 
-000136a0: 6576 6572 7974 6869 6e67 2077 696c 6c20  everything will 
-000136b0: 6265 2076 6572 6966 6965 640a 2020 2020  be verified.    
-000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136d0: 2020 2020 6d65 6d70 6f6f 6c5f 6461 7461      mempool_data
-000136e0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000136f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013700: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00013710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013720: 2020 2073 7472 2872 656d 6f74 655f 7478     str(remote_tx
-00013730: 5f74 696d 6573 7461 6d70 292c 0a20 2020  _timestamp),.   
-00013740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013750: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00013760: 2872 656d 6f74 655f 7478 5f61 6464 7265  (remote_tx_addre
-00013770: 7373 292c 0a20 2020 2020 2020 2020 2020  ss),.           
+000133e0: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
+000133f0: 742c 2072 6573 756c 7429 0a20 2020 2020  t, result).     
+00013400: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00013410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00013420: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00013430: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00013440: 2e64 6562 7567 2866 277b 7065 6572 5f69  .debug(f'{peer_i
+00013450: 707d 206e 6f74 2077 6869 7465 6c69 7374  p} not whitelist
+00013460: 6564 2066 6f72 2061 6464 6c69 7374 6c69  ed for addlistli
+00013470: 6d6d 6972 2063 6f6d 6d61 6e64 2729 0a0a  mmir command')..
+00013480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013490: 656c 6966 2064 6174 6120 3d3d 2027 6164  elif data == 'ad
+000134a0: 646c 6973 746c 696d 6d69 726a 736f 6e27  dlistlimmirjson'
+000134b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000134c0: 2020 2020 2020 6966 206e 6f64 652e 7065        if node.pe
+000134d0: 6572 732e 6973 5f61 6c6c 6f77 6564 2870  ers.is_allowed(p
+000134e0: 6565 725f 6970 2c20 6461 7461 293a 0a20  eer_ip, data):. 
+000134f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013500: 2020 2020 2020 2061 6464 7265 7373 5f74         address_t
+00013510: 785f 6c69 7374 203d 2072 6563 6569 7665  x_list = receive
+00013520: 2873 656c 662e 7265 7175 6573 7429 0a20  (self.request). 
+00013530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013540: 2020 2020 2020 2061 6464 7265 7373 5f74         address_t
+00013550: 785f 6c69 7374 5f6c 696d 6974 203d 2072  x_list_limit = r
+00013560: 6563 6569 7665 2873 656c 662e 7265 7175  eceive(self.requ
+00013570: 6573 7429 0a0a 2020 2020 2020 2020 2020  est)..          
+00013580: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013590: 7072 696e 7428 6164 6472 6573 735f 7478  print(address_tx
+000135a0: 5f6c 6973 745f 6c69 6d69 7429 0a20 2020  _list_limit).   
+000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135c0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+000135d0: 696e 7374 616e 6365 203d 2064 6268 616e  instance = dbhan
+000135e0: 646c 6572 2e44 6248 616e 646c 6572 286e  dler.DbHandler(n
+000135f0: 6f64 652e 696e 6465 785f 6462 2c20 6e6f  ode.index_db, no
+00013600: 6465 2e6c 6564 6765 725f 7061 7468 2c20  de.ledger_path, 
+00013610: 6e6f 6465 2e68 7970 6572 5f70 6174 682c  node.hyper_path,
+00013620: 206e 6f64 652e 7261 6d2c 206e 6f64 652e   node.ram, node.
+00013630: 6c65 6467 6572 5f72 616d 5f66 696c 652c  ledger_ram_file,
+00013640: 206e 6f64 652e 6c6f 6767 6572 2c20 7472   node.logger, tr
+00013650: 6163 655f 6462 5f63 616c 6c73 3d6e 6f64  ace_db_calls=nod
+00013660: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
+00013670: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013680: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+00013690: 646c 6572 5f69 6e73 7461 6e63 652e 6578  dler_instance.ex
+000136a0: 6563 7574 655f 7061 7261 6d28 0a20 2020  ecute_param(.   
+000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136c0: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+000136d0: 6c65 725f 696e 7374 616e 6365 2e68 2c0a  ler_instance.h,.
+000136e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136f0: 2020 2020 2020 2020 2020 2020 2827 5345              ('SE
+00013700: 4c45 4354 202a 2046 524f 4d20 7472 616e  LECT * FROM tran
+00013710: 7361 6374 696f 6e73 2057 4845 5245 2028  sactions WHERE (
+00013720: 6164 6472 6573 7320 3d20 3f20 4f52 2072  address = ? OR r
+00013730: 6563 6970 6965 6e74 203d 203f 2920 414e  ecipient = ?) AN
+00013740: 4420 626c 6f63 6b5f 6865 6967 6874 203c  D block_height <
+00013750: 2031 204f 5244 4552 2042 5920 626c 6f63   1 ORDER BY bloc
+00013760: 6b5f 6865 6967 6874 2041 5343 204c 494d  k_height ASC LIM
+00013770: 4954 203f 2729 2c0a 2020 2020 2020 2020  IT ?'),.        
 00013780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013790: 2020 2020 2073 7472 2872 656d 6f74 655f       str(remote_
-000137a0: 7478 5f72 6563 6970 6965 6e74 292c 0a20  tx_recipient),. 
-000137b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000137d0: 252e 3866 2720 2520 7175 616e 7469 7a65  %.8f' % quantize
-000137e0: 5f65 6967 6874 2872 656d 6f74 655f 7478  _eight(remote_tx
-000137f0: 5f61 6d6f 756e 7429 2c0a 2020 2020 2020  _amount),.      
+00013790: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+000137a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137b0: 2020 2020 2020 6164 6472 6573 735f 7478        address_tx
+000137c0: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
+000137d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137e0: 2020 2020 2020 2061 6464 7265 7373 5f74         address_t
+000137f0: 785f 6c69 7374 2c0a 2020 2020 2020 2020  x_list,.        
 00013800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013810: 2020 2020 2020 2020 2020 7374 7228 7265            str(re
-00013820: 6d6f 7465 5f73 6967 6e61 7475 7265 5f65  mote_signature_e
-00013830: 6e63 292c 0a20 2020 2020 2020 2020 2020  nc),.           
-00013840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013850: 2020 2020 2073 7472 2872 656d 6f74 655f       str(remote_
-00013860: 7478 5f70 7562 6b65 795f 6236 3465 6e63  tx_pubkey_b64enc
-00013870: 6f64 6564 292c 0a20 2020 2020 2020 2020  oded),.         
-00013880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013890: 2020 2020 2020 2073 7472 2872 656d 6f74         str(remot
-000138a0: 655f 7478 5f6f 7065 7261 7469 6f6e 292c  e_tx_operation),
-000138b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138d0: 2073 7472 2872 656d 6f74 655f 7478 5f6f   str(remote_tx_o
-000138e0: 7065 6e66 6965 6c64 292c 0a20 2020 2020  penfield),.     
-000138f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013900: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013810: 2020 2020 2020 2020 6164 6472 6573 735f          address_
+00013820: 7478 5f6c 6973 745f 6c69 6d69 742c 0a20  tx_list_limit,. 
+00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013840: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+00013850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013860: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013880: 7265 7375 6c74 203d 2064 625f 6861 6e64  result = db_hand
+00013890: 6c65 725f 696e 7374 616e 6365 2e68 2e66  ler_instance.h.f
+000138a0: 6574 6368 616c 6c28 290a 2020 2020 2020  etchall().      
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138c0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+000138d0: 7461 6e63 652e 636c 6f73 6528 290a 0a20  tance.close().. 
+000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138f0: 2020 2020 2020 2072 6573 706f 6e73 655f         response_
+00013900: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
 00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013920: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00013930: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00013940: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-00013950: 696e 666f 286d 702e 4d45 4d50 4f4f 4c2e  info(mp.MEMPOOL.
-00013960: 6d65 7267 6528 6d65 6d70 6f6f 6c5f 6461  merge(mempool_da
-00013970: 7461 2c20 7065 6572 5f69 702c 2064 625f  ta, peer_ip, db_
-00013980: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
-00013990: 2e63 2c20 5472 7565 2c20 5472 7565 2929  .c, True, True))
-000139a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000139b0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
-000139c0: 656c 662e 7265 7175 6573 742c 2073 7472  elf.request, str
-000139d0: 2872 656d 6f74 655f 7369 676e 6174 7572  (remote_signatur
-000139e0: 655f 656e 6329 290a 2020 2020 2020 2020  e_enc)).        
+00013920: 2020 666f 7220 7472 616e 7361 6374 696f    for transactio
+00013930: 6e20 696e 2072 6573 756c 743a 0a20 2020  n in result:.   
+00013940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013950: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00013960: 6520 3d20 7b0a 2020 2020 2020 2020 2020  e = {.          
+00013970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013980: 2020 2020 2020 2762 6c6f 636b 5f68 6569        'block_hei
+00013990: 6768 7427 3a20 7472 616e 7361 6374 696f  ght': transactio
+000139a0: 6e5b 305d 2c0a 2020 2020 2020 2020 2020  n[0],.          
+000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139c0: 2020 2020 2020 2774 696d 6573 7461 6d70        'timestamp
+000139d0: 273a 2074 7261 6e73 6163 7469 6f6e 5b31  ': transaction[1
+000139e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 000139f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a00: 2320 7769 7065 2076 6172 6961 626c 6573  # wipe variables
-00013a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013a20: 2020 2020 2020 2020 2028 7478 5f72 656d           (tx_rem
-00013a30: 6f74 652c 2072 656d 6f74 655f 7478 5f70  ote, remote_tx_p
-00013a40: 7269 766b 6579 2c20 7478 5f72 656d 6f74  rivkey, tx_remot
-00013a50: 655f 6b65 7929 203d 2028 4e6f 6e65 2c20  e_key) = (None, 
-00013a60: 4e6f 6e65 2c20 4e6f 6e65 290a 2020 2020  None, None).    
-00013a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00013a90: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00013aa0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00013ab0: 672e 696e 666f 2866 277b 7065 6572 5f69  g.info(f'{peer_i
-00013ac0: 707d 206e 6f74 2077 6869 7465 6c69 7374  p} not whitelist
-00013ad0: 6564 2066 6f72 2074 7873 656e 6420 636f  ed for txsend co
-00013ae0: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
-00013af0: 2020 2020 2020 2020 2023 206c 6573 7320           # less 
-00013b00: 696d 706f 7274 616e 7420 6d65 7468 6f64  important method
-00013b10: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00013b20: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
-00013b30: 6164 6476 616c 6964 6174 6527 3a0a 2020  addvalidate':.  
-00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b50: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
-00013b60: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
-00013b70: 6970 2c20 6461 7461 293a 0a0a 2020 2020  ip, data):..    
-00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b90: 2020 2020 6164 6472 6573 735f 746f 5f76      address_to_v
-00013ba0: 616c 6964 6174 6520 3d20 7265 6365 6976  alidate = receiv
-00013bb0: 6528 7365 6c66 2e72 6571 7565 7374 290a  e(self.request).
+00013a00: 2020 2027 6164 6472 6573 7327 3a20 7472     'address': tr
+00013a10: 616e 7361 6374 696f 6e5b 325d 2c0a 2020  ansaction[2],.  
+00013a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00013a40: 6563 6970 6965 6e74 273a 2074 7261 6e73  ecipient': trans
+00013a50: 6163 7469 6f6e 5b33 5d2c 0a20 2020 2020  action[3],.     
+00013a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a70: 2020 2020 2020 2020 2020 2027 616d 6f75             'amou
+00013a80: 6e74 273a 2074 7261 6e73 6163 7469 6f6e  nt': transaction
+00013a90: 5b34 5d2c 0a20 2020 2020 2020 2020 2020  [4],.           
+00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ab0: 2020 2020 2027 7369 676e 6174 7572 6527       'signature'
+00013ac0: 3a20 7472 616e 7361 6374 696f 6e5b 355d  : transaction[5]
+00013ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013af0: 2020 2770 7562 6c69 635f 6b65 7927 3a20    'public_key': 
+00013b00: 7472 616e 7361 6374 696f 6e5b 365d 2c0a  transaction[6],.
+00013b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b30: 2762 6c6f 636b 5f68 6173 6827 3a20 7472  'block_hash': tr
+00013b40: 616e 7361 6374 696f 6e5b 375d 2c0a 2020  ansaction[7],.  
+00013b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b60: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00013b70: 6565 273a 2074 7261 6e73 6163 7469 6f6e  ee': transaction
+00013b80: 5b38 5d2c 0a20 2020 2020 2020 2020 2020  [8],.           
+00013b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ba0: 2020 2020 2027 7265 7761 7264 273a 2074       'reward': t
+00013bb0: 7261 6e73 6163 7469 6f6e 5b39 5d2c 0a20  ransaction[9],. 
 00013bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013bd0: 2020 2020 2020 2020 6966 2065 7373 656e          if essen
-00013be0: 7469 616c 732e 6164 6472 6573 735f 7661  tials.address_va
-00013bf0: 6c69 6461 7465 2861 6464 7265 7373 5f74  lidate(address_t
-00013c00: 6f5f 7661 6c69 6461 7465 293a 0a20 2020  o_validate):.   
-00013c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c20: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00013c30: 3d20 2776 616c 6964 270a 2020 2020 2020  = 'valid'.      
+00013bd0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00013be0: 6f70 6572 6174 696f 6e27 3a20 7472 616e  operation': tran
+00013bf0: 7361 6374 696f 6e5b 3130 5d2c 0a20 2020  saction[10],.   
+00013c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c10: 2020 2020 2020 2020 2020 2020 2027 6f70               'op
+00013c20: 656e 6669 656c 6427 3a20 7472 616e 7361  enfield': transa
+00013c30: 6374 696f 6e5b 3131 5d2c 0a20 2020 2020  ction[11],.     
 00013c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013c50: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
 00013c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c70: 2020 2020 7265 7375 6c74 203d 2027 696e      result = 'in
-00013c80: 7661 6c69 6427 0a0a 2020 2020 2020 2020  valid'..        
-00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ca0: 7365 6e64 2873 656c 662e 7265 7175 6573  send(self.reques
-00013cb0: 742c 2072 6573 756c 7429 0a20 2020 2020  t, result).     
-00013cc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00013cd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00013ce0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00013cf0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00013d00: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00013d10: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-00013d20: 6420 666f 7220 6164 6476 616c 6964 6174  d for addvalidat
-00013d30: 6520 636f 6d6d 616e 6427 290a 0a20 2020  e command')..   
-00013d40: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00013d50: 6620 6461 7461 203d 3d20 2761 6e6e 6765  f data == 'annge
-00013d60: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
-00013d70: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00013d80: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
-00013d90: 2870 6565 725f 6970 293a 0a0a 2020 2020  (peer_ip):..    
-00013da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013db0: 2020 2020 2320 7769 7468 206f 7065 6e28      # with open(
-00013dc0: 7065 6572 6c69 7374 2c20 2272 2229 2061  peerlist, "r") a
-00013dd0: 7320 7065 6572 5f6c 6973 743a 0a20 2020  s peer_list:.   
-00013de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013df0: 2020 2020 2023 2020 2020 7065 6572 735f       #    peers_
-00013e00: 6669 6c65 203d 2070 6565 725f 6c69 7374  file = peer_list
-00013e10: 2e72 6561 6428 290a 0a20 2020 2020 2020  .read()..       
-00013e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e30: 2072 6573 756c 7420 3d20 6462 5f68 616e   result = db_han
-00013e40: 646c 6572 5f69 6e73 7461 6e63 652e 616e  dler_instance.an
-00013e50: 6e67 6574 286e 6f64 6529 0a0a 2020 2020  nget(node)..    
-00013e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e70: 2020 2020 7365 6e64 2873 656c 662e 7265      send(self.re
-00013e80: 7175 6573 742c 2072 6573 756c 7429 0a20  quest, result). 
-00013e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ea0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ec0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00013ed0: 5f6c 6f67 2e69 6e66 6f28 6627 7b70 6565  _log.info(f'{pee
-00013ee0: 725f 6970 7d20 6e6f 7420 7768 6974 656c  r_ip} not whitel
-00013ef0: 6973 7465 6420 666f 7220 616e 6e67 6574  isted for annget
-00013f00: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
-00013f10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00013f20: 2064 6174 6120 3d3d 2027 616e 6e76 6572   data == 'annver
-00013f30: 6765 7427 3a0a 2020 2020 2020 2020 2020  get':.          
-00013f40: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-00013f50: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-00013f60: 6564 2870 6565 725f 6970 293a 0a20 2020  ed(peer_ip):.   
-00013f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f80: 2020 2020 2072 6573 756c 7420 3d20 6462       result = db
-00013f90: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
-00013fa0: 652e 616e 6e76 6572 6765 7428 6e6f 6465  e.annverget(node
-00013fb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013fc0: 2020 2020 2020 2020 2020 7365 6e64 2873            send(s
-00013fd0: 656c 662e 7265 7175 6573 742c 2072 6573  elf.request, res
-00013fe0: 756c 7429 0a0a 2020 2020 2020 2020 2020  ult)..          
-00013ff0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00013c70: 2020 2020 2020 7265 7370 6f6e 7365 5f6c        response_l
+00013c80: 6973 742e 6170 7065 6e64 2872 6573 706f  ist.append(respo
+00013c90: 6e73 6529 0a0a 2020 2020 2020 2020 2020  nse)..          
+00013ca0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00013cb0: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+00013cc0: 2072 6573 706f 6e73 655f 6c69 7374 290a   response_list).
+00013cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ce0: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
+00013cf0: 662e 7265 7175 6573 742c 2072 6573 756c  f.request, resul
+00013d00: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00013d10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d30: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+00013d40: 2e61 7070 5f6c 6f67 2e64 6562 7567 2866  .app_log.debug(f
+00013d50: 277b 7065 6572 5f69 707d 206e 6f74 2077  '{peer_ip} not w
+00013d60: 6869 7465 6c69 7374 6564 2066 6f72 2061  hitelisted for a
+00013d70: 6464 6c69 7374 6c69 6d6d 6972 2063 6f6d  ddlistlimmir com
+00013d80: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
+00013d90: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
+00013da0: 6120 3d3d 2027 616c 6961 7367 6574 273a  a == 'aliasget':
+00013db0: 2020 2320 616c 6c20 666f 7220 6120 7369    # all for a si
+00013dc0: 6e67 6c65 2061 6464 7265 7373 2c20 6e6f  ngle address, no
+00013dd0: 2070 726f 7465 6374 696f 6e20 6167 6169   protection agai
+00013de0: 6e73 7420 6f76 6572 6c61 7070 696e 670a  nst overlapping.
+00013df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e00: 2020 2020 6966 206e 6f64 652e 7065 6572      if node.peer
+00013e10: 732e 6973 5f61 6c6c 6f77 6564 2870 6565  s.is_allowed(pee
+00013e20: 725f 6970 2c20 6461 7461 293a 0a20 2020  r_ip, data):.   
+00013e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e40: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
+00013e50: 696e 7374 616e 6365 203d 2064 6268 616e  instance = dbhan
+00013e60: 646c 6572 2e44 6248 616e 646c 6572 286e  dler.DbHandler(n
+00013e70: 6f64 652e 696e 6465 785f 6462 2c20 6e6f  ode.index_db, no
+00013e80: 6465 2e6c 6564 6765 725f 7061 7468 2c20  de.ledger_path, 
+00013e90: 6e6f 6465 2e68 7970 6572 5f70 6174 682c  node.hyper_path,
+00013ea0: 206e 6f64 652e 7261 6d2c 206e 6f64 652e   node.ram, node.
+00013eb0: 6c65 6467 6572 5f72 616d 5f66 696c 652c  ledger_ram_file,
+00013ec0: 206e 6f64 652e 6c6f 6767 6572 2c20 7472   node.logger, tr
+00013ed0: 6163 655f 6462 5f63 616c 6c73 3d6e 6f64  ace_db_calls=nod
+00013ee0: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
+00013ef0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013f00: 2020 2020 2020 2020 2020 616c 6961 7365            aliase
+00013f10: 732e 616c 6961 7365 735f 7570 6461 7465  s.aliases_update
+00013f20: 286e 6f64 652c 2064 625f 6861 6e64 6c65  (node, db_handle
+00013f30: 725f 696e 7374 616e 6365 290a 0a20 2020  r_instance)..   
+00013f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f50: 2020 2020 2061 6c69 6173 5f61 6464 7265       alias_addre
+00013f60: 7373 203d 2072 6563 6569 7665 2873 656c  ss = receive(sel
+00013f70: 662e 7265 7175 6573 7429 0a20 2020 2020  f.request).     
+00013f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f90: 2020 2072 6573 756c 7420 3d20 6462 5f68     result = db_h
+00013fa0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+00013fb0: 616c 6961 7367 6574 2861 6c69 6173 5f61  aliasget(alias_a
+00013fc0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00013fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fe0: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00013ff0: 6e63 652e 636c 6f73 6528 290a 0a20 2020  nce.close()..   
 00014000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014010: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00014020: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-00014030: 2866 277b 7065 6572 5f69 707d 206e 6f74  (f'{peer_ip} not
-00014040: 2077 6869 7465 6c69 7374 6564 2066 6f72   whitelisted for
-00014050: 2061 6e6e 6765 7420 636f 6d6d 616e 6427   annget command'
-00014060: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00014070: 2020 2065 6c69 6620 6461 7461 203d 3d20     elif data == 
-00014080: 2770 6565 7273 6765 7427 3a0a 2020 2020  'peersget':.    
-00014090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140a0: 6966 206e 6f64 652e 7065 6572 732e 6973  if node.peers.is
-000140b0: 5f61 6c6c 6f77 6564 2870 6565 725f 6970  _allowed(peer_ip
-000140c0: 2c20 6461 7461 293a 0a20 2020 2020 2020  , data):.       
-000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140e0: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
-000140f0: 7374 2c20 6e6f 6465 2e70 6565 7273 2e70  st, node.peers.p
-00014100: 6565 725f 6c69 7374 5f64 6973 6b5f 666f  eer_list_disk_fo
-00014110: 726d 6174 2829 290a 0a20 2020 2020 2020  rmat())..       
-00014120: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00014130: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00014140: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-00014150: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e69  logger.app_log.i
-00014160: 6e66 6f28 6627 7b70 6565 725f 6970 7d20  nfo(f'{peer_ip} 
-00014170: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
-00014180: 666f 7220 7065 6572 7367 6574 2063 6f6d  for peersget com
-00014190: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-000141a0: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-000141b0: 6120 3d3d 2027 7374 6174 7573 6765 7427  a == 'statusget'
-000141c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000141d0: 2020 2020 2020 6966 206e 6f64 652e 7065        if node.pe
-000141e0: 6572 732e 6973 5f61 6c6c 6f77 6564 2870  ers.is_allowed(p
-000141f0: 6565 725f 6970 2c20 6461 7461 293a 0a20  eer_ip, data):. 
-00014200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014210: 2020 2020 2020 206e 6f64 6573 5f63 6f75         nodes_cou
-00014220: 6e74 203d 206e 6f64 652e 7065 6572 732e  nt = node.peers.
-00014230: 636f 6e73 656e 7375 735f 7369 7a65 0a20  consensus_size. 
-00014240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014250: 2020 2020 2020 206e 6f64 6573 5f6c 6973         nodes_lis
-00014260: 7420 3d20 6e6f 6465 2e70 6565 7273 2e70  t = node.peers.p
-00014270: 6565 725f 6f70 696e 696f 6e5f 6469 6374  eer_opinion_dict
-00014280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014290: 2020 2020 2020 2020 2074 6872 6561 6473           threads
-000142a0: 5f63 6f75 6e74 203d 2074 6872 6561 6469  _count = threadi
-000142b0: 6e67 2e61 6374 6976 655f 636f 756e 7428  ng.active_count(
-000142c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000142d0: 2020 2020 2020 2020 2020 7570 7469 6d65            uptime
-000142e0: 203d 2069 6e74 2874 696d 652e 7469 6d65   = int(time.time
-000142f0: 2829 202d 206e 6f64 652e 7374 6172 7475  () - node.startu
-00014300: 705f 7469 6d65 290a 2020 2020 2020 2020  p_time).        
-00014310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014320: 6469 6666 203d 206e 6f64 652e 6469 6666  diff = node.diff
-00014330: 6963 756c 7479 0a20 2020 2020 2020 2020  iculty.         
-00014340: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014350: 6572 7665 725f 7469 6d65 7374 616d 7020  erver_timestamp 
-00014360: 3d20 2725 2e32 6627 2025 2074 696d 652e  = '%.2f' % time.
-00014370: 7469 6d65 2829 0a20 2020 2020 2020 2020  time().         
-00014380: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014390: 6620 6e6f 6465 2e72 6576 6561 6c5f 6164  f node.reveal_ad
-000143a0: 6472 6573 733a 0a20 2020 2020 2020 2020  dress:.         
-000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 2020 2072 6576 6561 6c65 645f 6164 6472     revealed_addr
-000143d0: 6573 7320 3d20 6e6f 6465 2e6b 6579 732e  ess = node.keys.
-000143e0: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
-000143f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014400: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014420: 2020 7265 7665 616c 6564 5f61 6464 7265    revealed_addre
-00014430: 7373 203d 2027 7072 6976 6174 6527 0a20  ss = 'private'. 
-00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014450: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
-00014460: 2e72 6571 7565 7374 2c20 2872 6576 6561  .request, (revea
-00014470: 6c65 645f 6164 6472 6573 732c 206e 6f64  led_address, nod
-00014480: 6573 5f63 6f75 6e74 2c20 6e6f 6465 735f  es_count, nodes_
-00014490: 6c69 7374 2c20 7468 7265 6164 735f 636f  list, threads_co
-000144a0: 756e 742c 2075 7074 696d 652c 206e 6f64  unt, uptime, nod
-000144b0: 652e 7065 6572 732e 636f 6e73 656e 7375  e.peers.consensu
-000144c0: 732c 206e 6f64 652e 7065 6572 732e 636f  s, node.peers.co
-000144d0: 6e73 656e 7375 735f 7065 7263 656e 7461  nsensus_percenta
-000144e0: 6765 2c20 5645 5253 494f 4e2c 2064 6966  ge, VERSION, dif
-000144f0: 662c 2073 6572 7665 725f 7469 6d65 7374  f, server_timest
-00014500: 616d 7029 290a 2020 2020 2020 2020 2020  amp)).          
-00014510: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00014520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014530: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00014540: 6765 722e 6170 705f 6c6f 672e 696e 666f  ger.app_log.info
-00014550: 2866 277b 7065 6572 5f69 707d 206e 6f74  (f'{peer_ip} not
-00014560: 2077 6869 7465 6c69 7374 6564 2066 6f72   whitelisted for
-00014570: 2073 7461 7475 7367 6574 2063 6f6d 6d61   statusget comma
-00014580: 6e64 2729 0a0a 2020 2020 2020 2020 2020  nd')..          
-00014590: 2020 2020 2020 656c 6966 2064 6174 6120        elif data 
-000145a0: 3d3d 2027 7374 6174 7573 6a73 6f6e 273a  == 'statusjson':
-000145b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000145c0: 2020 2020 2023 206e 6f74 206f 6e6c 7920       # not only 
-000145d0: 7365 6e64 7320 6173 2061 6e20 6578 706c  sends as an expl
-000145e0: 6963 6974 2064 6963 742c 2062 7574 2061  icit dict, but a
-000145f0: 6c73 6f20 656d 6265 6473 2065 7874 7261  lso embeds extra
-00014600: 2069 6e66 6f0a 2020 2020 2020 2020 2020   info.          
-00014610: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-00014620: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
-00014630: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
-00014640: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00014650: 2020 2020 2020 2020 2020 2075 7074 696d             uptim
-00014660: 6520 3d20 696e 7428 7469 6d65 2e74 696d  e = int(time.tim
-00014670: 6528 2920 2d20 6e6f 6465 2e73 7461 7274  e() - node.start
-00014680: 7570 5f74 696d 6529 0a20 2020 2020 2020  up_time).       
-00014690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146a0: 2074 656d 7064 6966 6620 3d20 6e6f 6465   tempdiff = node
-000146b0: 2e64 6966 6669 6375 6c74 790a 2020 2020  .difficulty.    
+00014010: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
+00014020: 6571 7565 7374 2c20 7265 7375 6c74 290a  equest, result).
+00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014040: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014060: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+00014070: 705f 6c6f 672e 6465 6275 6728 6627 7b70  p_log.debug(f'{p
+00014080: 6565 725f 6970 7d20 6e6f 7420 7768 6974  eer_ip} not whit
+00014090: 656c 6973 7465 6420 666f 7220 616c 6961  elisted for alia
+000140a0: 7367 6574 2063 6f6d 6d61 6e64 2729 0a0a  sget command')..
+000140b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140c0: 656c 6966 2064 6174 6120 3d3d 2027 616c  elif data == 'al
+000140d0: 6961 7365 7367 6574 273a 2020 2320 6f6e  iasesget':  # on
+000140e0: 6c79 2067 6574 7320 7468 6520 6669 7273  ly gets the firs
+000140f0: 7420 6f6e 652c 2066 6f72 206d 756c 7469  t one, for multi
+00014100: 706c 6520 6164 6472 6573 7365 730a 2020  ple addresses.  
+00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014120: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
+00014130: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
+00014140: 6970 2c20 6461 7461 293a 0a20 2020 2020  ip, data):.     
+00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014160: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+00014170: 7374 616e 6365 203d 2064 6268 616e 646c  stance = dbhandl
+00014180: 6572 2e44 6248 616e 646c 6572 286e 6f64  er.DbHandler(nod
+00014190: 652e 696e 6465 785f 6462 2c20 6e6f 6465  e.index_db, node
+000141a0: 2e6c 6564 6765 725f 7061 7468 2c20 6e6f  .ledger_path, no
+000141b0: 6465 2e68 7970 6572 5f70 6174 682c 206e  de.hyper_path, n
+000141c0: 6f64 652e 7261 6d2c 206e 6f64 652e 6c65  ode.ram, node.le
+000141d0: 6467 6572 5f72 616d 5f66 696c 652c 206e  dger_ram_file, n
+000141e0: 6f64 652e 6c6f 6767 6572 2c20 7472 6163  ode.logger, trac
+000141f0: 655f 6462 5f63 616c 6c73 3d6e 6f64 652e  e_db_calls=node.
+00014200: 7472 6163 655f 6462 5f63 616c 6c73 290a  trace_db_calls).
+00014210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014220: 2020 2020 2020 2020 616c 6961 7365 732e          aliases.
+00014230: 616c 6961 7365 735f 7570 6461 7465 286e  aliases_update(n
+00014240: 6f64 652c 2064 625f 6861 6e64 6c65 725f  ode, db_handler_
+00014250: 696e 7374 616e 6365 290a 2020 2020 2020  instance).      
+00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014270: 2020 616c 6961 7365 735f 7265 7175 6573    aliases_reques
+00014280: 7420 3d20 7265 6365 6976 6528 7365 6c66  t = receive(self
+00014290: 2e72 6571 7565 7374 290a 2020 2020 2020  .request).      
+000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142b0: 2020 7265 7375 6c74 7320 3d20 6462 5f68    results = db_h
+000142c0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+000142d0: 616c 6961 7365 7367 6574 2861 6c69 6173  aliasesget(alias
+000142e0: 6573 5f72 6571 7565 7374 290a 2020 2020  es_request).    
+000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014300: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+00014310: 6e73 7461 6e63 652e 636c 6f73 6528 290a  nstance.close().
+00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014330: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00014340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014350: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+00014360: 7374 2c20 7265 7375 6c74 7329 0a20 2020  st, results).   
+00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014380: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014390: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000143a0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+000143b0: 6f67 2e64 6562 7567 2866 277b 7065 6572  og.debug(f'{peer
+000143c0: 5f69 707d 206e 6f74 2077 6869 7465 6c69  _ip} not whiteli
+000143d0: 7374 6564 2066 6f72 2061 6c69 6173 6573  sted for aliases
+000143e0: 6765 7420 636f 6d6d 616e 6427 290a 0a20  get command').. 
+000143f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014400: 204e 6f74 206d 616e 6461 746f 7279 2c20   Not mandatory, 
+00014410: 6275 7420 6d61 7920 6865 6c70 2074 6f20  but may help to 
+00014420: 7265 696e 6465 7820 7769 7468 206d 696e  reindex with min
+00014430: 696d 616c 2073 716c 2071 7565 7269 6573  imal sql queries
+00014440: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00014450: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
+00014460: 746f 6b65 6e73 6765 7427 3a0a 2020 2020  tokensget':.    
+00014470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014480: 2320 544f 444f 3a20 746f 2062 6520 6861  # TODO: to be ha
+00014490: 6e64 6c65 6420 6279 2074 6f6b 656e 206d  ndled by token m
+000144a0: 6f64 756c 6573 2c20 7769 7468 206e 6f20  odules, with no 
+000144b0: 7371 6c20 6865 7265 2069 6e20 6e6f 6465  sql here in node
+000144c0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000144d0: 2020 2020 2020 6966 206e 6f64 652e 7065        if node.pe
+000144e0: 6572 732e 6973 5f61 6c6c 6f77 6564 2870  ers.is_allowed(p
+000144f0: 6565 725f 6970 2c20 6461 7461 293a 0a0a  eer_ip, data):..
+00014500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014510: 2020 2020 2020 2020 746f 6b65 6e73 5f61          tokens_a
+00014520: 6464 7265 7373 203d 2072 6563 6569 7665  ddress = receive
+00014530: 2873 656c 662e 7265 7175 6573 7429 0a20  (self.request). 
+00014540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014550: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00014560: 725f 696e 7374 616e 6365 203d 2064 6268  r_instance = dbh
+00014570: 616e 646c 6572 2e44 6248 616e 646c 6572  andler.DbHandler
+00014580: 286e 6f64 652e 696e 6465 785f 6462 2c20  (node.index_db, 
+00014590: 6e6f 6465 2e6c 6564 6765 725f 7061 7468  node.ledger_path
+000145a0: 2c20 6e6f 6465 2e68 7970 6572 5f70 6174  , node.hyper_pat
+000145b0: 682c 206e 6f64 652e 7261 6d2c 206e 6f64  h, node.ram, nod
+000145c0: 652e 6c65 6467 6572 5f72 616d 5f66 696c  e.ledger_ram_fil
+000145d0: 652c 206e 6f64 652e 6c6f 6767 6572 2c20  e, node.logger, 
+000145e0: 7472 6163 655f 6462 5f63 616c 6c73 3d6e  trace_db_calls=n
+000145f0: 6f64 652e 7472 6163 655f 6462 5f63 616c  ode.trace_db_cal
+00014600: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
+00014610: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
+00014620: 6e73 5f75 7365 7220 3d20 6462 5f68 616e  ns_user = db_han
+00014630: 646c 6572 5f69 6e73 7461 6e63 652e 746f  dler_instance.to
+00014640: 6b65 6e73 5f75 7365 7228 746f 6b65 6e73  kens_user(tokens
+00014650: 5f61 6464 7265 7373 290a 0a20 2020 2020  _address)..     
+00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014670: 2020 2074 6f6b 656e 735f 6c69 7374 203d     tokens_list =
+00014680: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00014690: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000146a0: 746f 6b65 6e20 696e 2074 6f6b 656e 735f  token in tokens_
+000146b0: 7573 6572 3a0a 2020 2020 2020 2020 2020  user:.          
 000146c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146d0: 2020 2020 6966 206e 6f64 652e 7265 7665      if node.reve
-000146e0: 616c 5f61 6464 7265 7373 3a0a 2020 2020  al_address:.    
-000146f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014700: 2020 2020 2020 2020 7265 7665 616c 6564          revealed
-00014710: 5f61 6464 7265 7373 203d 206e 6f64 652e  _address = node.
-00014720: 6b65 7973 2e61 6464 7265 7373 0a20 2020  keys.address.   
-00014730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014740: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014760: 2020 2020 2020 2072 6576 6561 6c65 645f         revealed_
-00014770: 6164 6472 6573 7320 3d20 2770 7269 7661  address = 'priva
-00014780: 7465 270a 2020 2020 2020 2020 2020 2020  te'.            
-00014790: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000147a0: 7573 203d 207b 0a20 2020 2020 2020 2020  us = {.         
+000146d0: 2020 746f 6b65 6e20 3d20 746f 6b65 6e5b    token = token[
+000146e0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+000146f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00014700: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+00014710: 6365 2e65 7865 6375 7465 5f70 6172 616d  ce.execute_param
+00014720: 2864 625f 6861 6e64 6c65 725f 696e 7374  (db_handler_inst
+00014730: 616e 6365 2e69 6e64 6578 5f63 7572 736f  ance.index_curso
+00014740: 722c 2027 5345 4c45 4354 2073 756d 2861  r, 'SELECT sum(a
+00014750: 6d6f 756e 7429 2046 524f 4d20 746f 6b65  mount) FROM toke
+00014760: 6e73 2057 4845 5245 2072 6563 6970 6965  ns WHERE recipie
+00014770: 6e74 203d 203f 2041 4e44 2074 6f6b 656e  nt = ? AND token
+00014780: 203d 203f 3b27 2c20 2874 6f6b 656e 735f   = ?;', (tokens_
+00014790: 6164 6472 6573 732c 2029 202b 2028 746f  address, ) + (to
+000147a0: 6b65 6e2c 2029 290a 2020 2020 2020 2020  ken, )).        
 000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147c0: 2020 2027 7072 6f74 6f63 6f6c 7665 7273     'protocolvers
-000147d0: 696f 6e27 3a20 6e6f 6465 2e76 6572 7369  ion': node.versi
-000147e0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-000147f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014800: 2761 6464 7265 7373 273a 2072 6576 6561  'address': revea
-00014810: 6c65 645f 6164 6472 6573 732c 0a20 2020  led_address,.   
-00014820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014830: 2020 2020 2020 2020 2027 7761 6c6c 6574           'wallet
-00014840: 7665 7273 696f 6e27 3a20 5645 5253 494f  version': VERSIO
-00014850: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
-00014860: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00014870: 7465 7374 6e65 7427 3a20 6e6f 6465 2e69  testnet': node.i
-00014880: 735f 7465 7374 6e65 742c 0a20 2020 2020  s_testnet,.     
-00014890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148a0: 2020 2020 2020 2027 626c 6f63 6b73 273a         'blocks':
-000148b0: 206e 6f64 652e 6864 645f 626c 6f63 6b2c   node.hdd_block,
-000148c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000148d0: 2020 2020 2020 2020 2020 2020 2027 7469               'ti
-000148e0: 6d65 6f66 6673 6574 273a 2030 2c0a 2020  meoffset': 0,.  
-000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 2020 2020 2020 2020 2020 2763 6f6e 6e65            'conne
-00014910: 6374 696f 6e73 273a 206e 6f64 652e 7065  ctions': node.pe
-00014920: 6572 732e 636f 6e73 656e 7375 735f 7369  ers.consensus_si
-00014930: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
-00014940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014950: 2763 6f6e 6e65 6374 696f 6e73 5f6c 6973  'connections_lis
-00014960: 7427 3a20 6e6f 6465 2e70 6565 7273 2e70  t': node.peers.p
-00014970: 6565 725f 6f70 696e 696f 6e5f 6469 6374  eer_opinion_dict
-00014980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014990: 2020 2020 2020 2020 2020 2020 2020 2764                'd
-000149a0: 6966 6669 6375 6c74 7927 3a20 7465 6d70  ifficulty': temp
-000149b0: 6469 6666 5b30 5d2c 0a20 2020 2020 2020  diff[0],.       
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 2020 2020 2027 7468 7265 6164 7327 3a20       'threads': 
-000149e0: 7468 7265 6164 696e 672e 6163 7469 7665  threading.active
-000149f0: 5f63 6f75 6e74 2829 2c0a 2020 2020 2020  _count(),.      
-00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a10: 2020 2020 2020 2775 7074 696d 6527 3a20        'uptime': 
-00014a20: 7570 7469 6d65 2c0a 2020 2020 2020 2020  uptime,.        
+000147c0: 2020 2020 6372 6564 6974 203d 2064 625f      credit = db_
+000147d0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+000147e0: 2e69 6e64 6578 5f63 7572 736f 722e 6665  .index_cursor.fe
+000147f0: 7463 686f 6e65 2829 5b30 5d0a 2020 2020  tchone()[0].    
+00014800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014810: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
+00014820: 6572 5f69 6e73 7461 6e63 652e 6578 6563  er_instance.exec
+00014830: 7574 655f 7061 7261 6d28 6462 5f68 616e  ute_param(db_han
+00014840: 646c 6572 5f69 6e73 7461 6e63 652e 696e  dler_instance.in
+00014850: 6465 785f 6375 7273 6f72 2c20 2753 454c  dex_cursor, 'SEL
+00014860: 4543 5420 7375 6d28 616d 6f75 6e74 2920  ECT sum(amount) 
+00014870: 4652 4f4d 2074 6f6b 656e 7320 5748 4552  FROM tokens WHER
+00014880: 4520 6164 6472 6573 7320 3d20 3f20 414e  E address = ? AN
+00014890: 4420 746f 6b65 6e20 3d20 3f3b 272c 2028  D token = ?;', (
+000148a0: 746f 6b65 6e73 5f61 6464 7265 7373 2c20  tokens_address, 
+000148b0: 2920 2b20 2874 6f6b 656e 2c20 2929 0a20  ) + (token, )). 
+000148c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148d0: 2020 2020 2020 2020 2020 2064 6562 6974             debit
+000148e0: 203d 2064 625f 6861 6e64 6c65 725f 696e   = db_handler_in
+000148f0: 7374 616e 6365 2e69 6e64 6578 5f63 7572  stance.index_cur
+00014900: 736f 722e 6665 7463 686f 6e65 2829 5b30  sor.fetchone()[0
+00014910: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00014920: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00014930: 6562 6974 203d 2030 2069 6620 6465 6269  ebit = 0 if debi
+00014940: 7420 6973 204e 6f6e 6520 656c 7365 2064  t is None else d
+00014950: 6562 6974 0a20 2020 2020 2020 2020 2020  ebit.           
+00014960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014970: 2063 7265 6469 7420 3d20 3020 6966 2063   credit = 0 if c
+00014980: 7265 6469 7420 6973 204e 6f6e 6520 656c  redit is None el
+00014990: 7365 2063 7265 6469 740a 0a20 2020 2020  se credit..     
+000149a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149b0: 2020 2020 2020 2062 616c 616e 6365 203d         balance =
+000149c0: 2073 7472 2844 6563 696d 616c 2863 7265   str(Decimal(cre
+000149d0: 6469 7429 202d 2044 6563 696d 616c 2864  dit) - Decimal(d
+000149e0: 6562 6974 2929 0a0a 2020 2020 2020 2020  ebit))..        
+000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a00: 2020 2020 746f 6b65 6e73 5f6c 6973 742e      tokens_list.
+00014a10: 6170 7065 6e64 2828 746f 6b65 6e2c 2062  append((token, b
+00014a20: 616c 616e 6365 2929 0a0a 2020 2020 2020  alance))..      
 00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a40: 2020 2020 2763 6f6e 7365 6e73 7573 273a      'consensus':
-00014a50: 206e 6f64 652e 7065 6572 732e 636f 6e73   node.peers.cons
-00014a60: 656e 7375 732c 0a20 2020 2020 2020 2020  ensus,.         
-00014a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a80: 2020 2027 636f 6e73 656e 7375 735f 7065     'consensus_pe
-00014a90: 7263 656e 7427 3a20 6e6f 6465 2e70 6565  rcent': node.pee
-00014aa0: 7273 2e63 6f6e 7365 6e73 7573 5f70 6572  rs.consensus_per
-00014ab0: 6365 6e74 6167 652c 0a20 2020 2020 2020  centage,.       
-00014ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ad0: 2020 2020 2027 7079 7468 6f6e 5f76 6572       'python_ver
-00014ae0: 7369 6f6e 273a 2073 7472 2876 6572 7369  sion': str(versi
-00014af0: 6f6e 5f69 6e66 6f5b 3a33 5d29 2c0a 2020  on_info[:3]),.  
-00014b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b10: 2020 2020 2020 2020 2020 276c 6173 745f            'last_
-00014b20: 626c 6f63 6b5f 6167 6f27 3a20 6e6f 6465  block_ago': node
-00014b30: 2e6c 6173 745f 626c 6f63 6b5f 6167 6f2c  .last_block_ago,
-00014b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014b50: 2020 2020 2020 2020 2020 2020 2027 7365               'se
-00014b60: 7276 6572 5f74 696d 6573 7461 6d70 273a  rver_timestamp':
-00014b70: 2027 252e 3266 2720 2520 7469 6d65 2e74   '%.2f' % time.t
-00014b80: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
-00014b90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00014ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014bb0: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
-00014bc0: 2e69 735f 7265 676e 6574 3a0a 2020 2020  .is_regnet:.    
-00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014be0: 2020 2020 2020 2020 7374 6174 7573 5b27          status['
-00014bf0: 7265 676e 6574 275d 203d 2054 7275 650a  regnet'] = True.
-00014c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c10: 2020 2020 2020 2020 7365 6e64 2873 656c          send(sel
-00014c20: 662e 7265 7175 6573 742c 2073 7461 7475  f.request, statu
-00014c30: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00014c40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00014a40: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+00014a50: 7461 6e63 652e 636c 6f73 6528 290a 0a20  tance.close().. 
+00014a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a70: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
+00014a80: 2e72 6571 7565 7374 2c20 746f 6b65 6e73  .request, tokens
+00014a90: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
+00014aa0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00014ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ac0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+00014ad0: 6767 6572 2e61 7070 5f6c 6f67 2e64 6562  gger.app_log.deb
+00014ae0: 7567 2866 277b 7065 6572 5f69 707d 206e  ug(f'{peer_ip} n
+00014af0: 6f74 2077 6869 7465 6c69 7374 6564 2066  ot whitelisted f
+00014b00: 6f72 2074 6f6b 656e 7367 6574 2063 6f6d  or tokensget com
+00014b10: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
+00014b20: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
+00014b30: 6120 3d3d 2027 6164 6466 726f 6d61 6c69  a == 'addfromali
+00014b40: 6173 273a 0a20 2020 2020 2020 2020 2020  as':.           
+00014b50: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+00014b60: 2e70 6565 7273 2e69 735f 616c 6c6f 7765  .peers.is_allowe
+00014b70: 6428 7065 6572 5f69 702c 2064 6174 6129  d(peer_ip, data)
+00014b80: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
+00014b90: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+00014ba0: 6e64 6c65 725f 696e 7374 616e 6365 203d  ndler_instance =
+00014bb0: 2064 6268 616e 646c 6572 2e44 6248 616e   dbhandler.DbHan
+00014bc0: 646c 6572 286e 6f64 652e 696e 6465 785f  dler(node.index_
+00014bd0: 6462 2c20 6e6f 6465 2e6c 6564 6765 725f  db, node.ledger_
+00014be0: 7061 7468 2c20 6e6f 6465 2e68 7970 6572  path, node.hyper
+00014bf0: 5f70 6174 682c 206e 6f64 652e 7261 6d2c  _path, node.ram,
+00014c00: 206e 6f64 652e 6c65 6467 6572 5f72 616d   node.ledger_ram
+00014c10: 5f66 696c 652c 206e 6f64 652e 6c6f 6767  _file, node.logg
+00014c20: 6572 2c20 7472 6163 655f 6462 5f63 616c  er, trace_db_cal
+00014c30: 6c73 3d6e 6f64 652e 7472 6163 655f 6462  ls=node.trace_db
+00014c40: 5f63 616c 6c73 290a 2020 2020 2020 2020  _calls).        
 00014c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c60: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-00014c70: 2e61 7070 5f6c 6f67 2e69 6e66 6f28 6627  .app_log.info(f'
-00014c80: 7b70 6565 725f 6970 7d20 6e6f 7420 7768  {peer_ip} not wh
-00014c90: 6974 656c 6973 7465 6420 666f 7220 7374  itelisted for st
-00014ca0: 6174 7573 6a73 6f6e 2063 6f6d 6d61 6e64  atusjson command
-00014cb0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00014cc0: 2020 2065 6c69 6620 6461 7461 5b3a 345d     elif data[:4]
-00014cd0: 203d 3d20 2761 7069 5f27 3a0a 2020 2020   == 'api_':.    
-00014ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014cf0: 6966 206e 6f64 652e 7065 6572 732e 6973  if node.peers.is
-00014d00: 5f61 6c6c 6f77 6564 2870 6565 725f 6970  _allowed(peer_ip
-00014d10: 2c20 6461 7461 293a 0a20 2020 2020 2020  , data):.       
-00014d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d30: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00014d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d50: 2020 6e6f 6465 2e61 7069 6861 6e64 6c65    node.apihandle
-00014d60: 722e 6469 7370 6174 6368 2864 6174 612c  r.dispatch(data,
-00014d70: 2073 656c 662e 7265 7175 6573 742c 2064   self.request, d
-00014d80: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
-00014d90: 6365 2c20 6e6f 6465 2e70 6565 7273 290a  ce, node.peers).
-00014da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014db0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00014dc0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+00014c60: 616c 6961 7365 732e 616c 6961 7365 735f  aliases.aliases_
+00014c70: 7570 6461 7465 286e 6f64 652c 2064 625f  update(node, db_
+00014c80: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00014c90: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00014ca0: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+00014cb0: 5f61 6464 7265 7373 203d 2072 6563 6569  _address = recei
+00014cc0: 7665 2873 656c 662e 7265 7175 6573 7429  ve(self.request)
+00014cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ce0: 2020 2020 2020 2020 2061 6464 7265 7373           address
+00014cf0: 5f66 6574 6368 203d 2064 625f 6861 6e64  _fetch = db_hand
+00014d00: 6c65 725f 696e 7374 616e 6365 2e61 6464  ler_instance.add
+00014d10: 6672 6f6d 616c 6961 7328 616c 6961 735f  fromalias(alias_
+00014d20: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+00014d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d40: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+00014d50: 616e 6365 2e63 6c6f 7365 2829 0a0a 2020  ance.close()..  
+00014d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d70: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00014d80: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00014d90: 6728 6627 4665 7463 6865 6420 7468 6520  g(f'Fetched the 
+00014da0: 666f 6c6c 6f77 696e 6720 616c 6961 7320  following alias 
+00014db0: 6164 6472 6573 733a 207b 6164 6472 6573  address: {addres
+00014dc0: 735f 6665 7463 687d 2729 0a20 2020 2020  s_fetch}').     
 00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014de0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014df0: 6465 2e64 6562 7567 3a0a 2020 2020 2020  de.debug:.      
-00014e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e10: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00014de0: 2020 2073 656e 6428 7365 6c66 2e72 6571     send(self.req
+00014df0: 7565 7374 2c20 6164 6472 6573 735f 6665  uest, address_fe
+00014e00: 7463 6829 0a0a 2020 2020 2020 2020 2020  tch)..          
+00014e10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
 00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e30: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00014e40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e60: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-00014e70: 705f 6c6f 672e 7761 726e 696e 6728 6529  p_log.warning(e)
-00014e80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00014e90: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
-00014ea0: 6469 6666 6765 7427 3a0a 2020 2020 2020  diffget':.      
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014ec0: 206e 6f64 652e 7065 6572 732e 6973 5f61   node.peers.is_a
-00014ed0: 6c6c 6f77 6564 2870 6565 725f 6970 2c20  llowed(peer_ip, 
-00014ee0: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
-00014ef0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00014f00: 6966 6620 3d20 6e6f 6465 2e64 6966 6669  iff = node.diffi
-00014f10: 6375 6c74 790a 2020 2020 2020 2020 2020  culty.          
-00014f20: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00014f30: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-00014f40: 2064 6966 6629 0a20 2020 2020 2020 2020   diff).         
-00014f50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00014f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014f70: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-00014f80: 6767 6572 2e61 7070 5f6c 6f67 2e69 6e66  gger.app_log.inf
-00014f90: 6f28 6627 7b70 6565 725f 6970 7d20 6e6f  o(f'{peer_ip} no
-00014fa0: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
-00014fb0: 7220 6469 6666 6765 7420 636f 6d6d 616e  r diffget comman
-00014fc0: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
-00014fd0: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
-00014fe0: 3d20 2770 6f72 7467 6574 273a 0a20 2020  = 'portget':.   
-00014ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015000: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
-00015010: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
-00015020: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
-00015030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015040: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
-00015050: 6573 742c 207b 2770 6f72 7427 3a20 6e6f  est, {'port': no
-00015060: 6465 2e70 6f72 747d 290a 2020 2020 2020  de.port}).      
-00015070: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00015080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00015090: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000150a0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-000150b0: 696e 666f 2866 277b 7065 6572 5f69 707d  info(f'{peer_ip}
-000150c0: 206e 6f74 2077 6869 7465 6c69 7374 6564   not whitelisted
-000150d0: 2066 6f72 2070 6f72 7467 6574 2063 6f6d   for portget com
-000150e0: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
-000150f0: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
-00015100: 6120 3d3d 2027 6469 6666 6765 746a 736f  a == 'diffgetjso
-00015110: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
-00015120: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
-00015130: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
-00015140: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
-00015150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015160: 2020 2020 2020 2020 2064 6966 6620 3d20           diff = 
-00015170: 6e6f 6465 2e64 6966 6669 6375 6c74 790a  node.difficulty.
-00015180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015190: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000151a0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151c0: 2027 6469 6666 6963 756c 7479 273a 2064   'difficulty': d
-000151d0: 6966 665b 305d 2c0a 2020 2020 2020 2020  iff[0],.        
-000151e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151f0: 2020 2020 2764 6966 665f 6472 6f70 7065      'diff_droppe
-00015200: 6427 3a20 6469 6666 5b31 5d2c 0a20 2020  d': diff[1],.   
-00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015220: 2020 2020 2020 2020 2027 7469 6d65 5f74           'time_t
-00015230: 6f5f 6765 6e65 7261 7465 273a 2064 6966  o_generate': dif
-00015240: 665b 325d 2c0a 2020 2020 2020 2020 2020  f[2],.          
-00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015260: 2020 2764 6966 665f 626c 6f63 6b5f 7072    'diff_block_pr
-00015270: 6576 696f 7573 273a 2064 6966 665b 335d  evious': diff[3]
-00015280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015290: 2020 2020 2020 2020 2020 2020 2020 2762                'b
-000152a0: 6c6f 636b 5f74 696d 6527 3a20 6469 6666  lock_time': diff
-000152b0: 5b34 5d2c 0a20 2020 2020 2020 2020 2020  [4],.           
-000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152d0: 2027 6861 7368 7261 7465 273a 2064 6966   'hashrate': dif
-000152e0: 665b 355d 2c0a 2020 2020 2020 2020 2020  f[5],.          
-000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015300: 2020 2764 6966 665f 6164 6a75 7374 6d65    'diff_adjustme
-00015310: 6e74 273a 2064 6966 665b 365d 2c0a 2020  nt': diff[6],.  
-00015320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015330: 2020 2020 2020 2020 2020 2762 6c6f 636b            'block
-00015340: 5f68 6569 6768 7427 3a20 6469 6666 5b37  _height': diff[7
-00015350: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00015360: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00015370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015380: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-00015390: 6571 7565 7374 2c20 7265 7370 6f6e 7365  equest, response
-000153a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000153b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000153c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000153d0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-000153e0: 6170 705f 6c6f 672e 696e 666f 2866 277b  app_log.info(f'{
-000153f0: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
-00015400: 7465 6c69 7374 6564 2066 6f72 2064 6966  telisted for dif
-00015410: 6667 6574 6a73 6f6e 2063 6f6d 6d61 6e64  fgetjson command
-00015420: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-00015430: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
-00015440: 2027 6469 6666 6c61 7374 273a 0a20 2020   'difflast':.   
-00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015460: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
-00015470: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
-00015480: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
-00015490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154a0: 2020 6469 6666 6c61 7374 203d 2064 625f    difflast = db_
-000154b0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
-000154c0: 2e64 6966 666c 6173 7428 290a 0a20 2020  .difflast()..   
+00014e30: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+00014e40: 6765 722e 6170 705f 6c6f 672e 6465 6275  ger.app_log.debu
+00014e50: 6728 6627 7b70 6565 725f 6970 7d20 6e6f  g(f'{peer_ip} no
+00014e60: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
+00014e70: 7220 6164 6466 726f 6d61 6c69 6173 2063  r addfromalias c
+00014e80: 6f6d 6d61 6e64 2729 0a0a 2020 2020 2020  ommand')..      
+00014e90: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
+00014ea0: 6174 6120 3d3d 2027 7075 626b 6579 6765  ata == 'pubkeyge
+00014eb0: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
+00014ec0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+00014ed0: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
+00014ee0: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
+00014ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014f00: 2020 2020 2020 2020 2070 7562 5f6b 6579           pub_key
+00014f10: 5f61 6464 7265 7373 203d 2072 6563 6569  _address = recei
+00014f20: 7665 2873 656c 662e 7265 7175 6573 7429  ve(self.request)
+00014f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014f40: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+00014f50: 6c65 725f 696e 7374 616e 6365 203d 2064  ler_instance = d
+00014f60: 6268 616e 646c 6572 2e44 6248 616e 646c  bhandler.DbHandl
+00014f70: 6572 286e 6f64 652e 696e 6465 785f 6462  er(node.index_db
+00014f80: 2c20 6e6f 6465 2e6c 6564 6765 725f 7061  , node.ledger_pa
+00014f90: 7468 2c20 6e6f 6465 2e68 7970 6572 5f70  th, node.hyper_p
+00014fa0: 6174 682c 206e 6f64 652e 7261 6d2c 206e  ath, node.ram, n
+00014fb0: 6f64 652e 6c65 6467 6572 5f72 616d 5f66  ode.ledger_ram_f
+00014fc0: 696c 652c 206e 6f64 652e 6c6f 6767 6572  ile, node.logger
+00014fd0: 2c20 7472 6163 655f 6462 5f63 616c 6c73  , trace_db_calls
+00014fe0: 3d6e 6f64 652e 7472 6163 655f 6462 5f63  =node.trace_db_c
+00014ff0: 616c 6c73 290a 2020 2020 2020 2020 2020  alls).          
+00015000: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00015010: 7267 6574 5f70 7562 6c69 635f 6b65 795f  rget_public_key_
+00015020: 6236 3465 6e63 6f64 6564 203d 2064 625f  b64encoded = db_
+00015030: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00015040: 2e70 7562 6b65 7967 6574 2870 7562 5f6b  .pubkeyget(pub_k
+00015050: 6579 5f61 6464 7265 7373 290a 2020 2020  ey_address).    
+00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015070: 2020 2020 6462 5f68 616e 646c 6572 5f69      db_handler_i
+00015080: 6e73 7461 6e63 652e 636c 6f73 6528 290a  nstance.close().
+00015090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000150a0: 2020 2020 2020 2020 2023 2072 6574 7572           # retur
+000150b0: 6e73 2061 7320 7374 6f72 6564 2069 6e20  ns as stored in 
+000150c0: 7468 6520 4442 2c20 7468 6174 2069 7320  the DB, that is 
+000150d0: 6236 3420 656e 636f 6465 642c 2065 7863  b64 encoded, exc
+000150e0: 6570 7420 666f 7220 5253 4120 7768 6572  ept for RSA wher
+000150f0: 6520 6974 2773 2062 3634 2065 6e63 6f64  e it's b64 encod
+00015100: 6564 2074 7769 6365 2e0a 2020 2020 2020  ed twice..      
+00015110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015120: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+00015130: 6573 742c 2074 6172 6765 745f 7075 626c  est, target_publ
+00015140: 6963 5f6b 6579 5f62 3634 656e 636f 6465  ic_key_b64encode
+00015150: 6429 0a0a 2020 2020 2020 2020 2020 2020  d)..            
+00015160: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00015170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015180: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00015190: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+000151a0: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
+000151b0: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
+000151c0: 7075 626b 6579 6765 7420 636f 6d6d 616e  pubkeyget comman
+000151d0: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
+000151e0: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
+000151f0: 3d20 2761 6c69 6173 6368 6563 6b27 3a0a  = 'aliascheck':.
+00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015210: 2020 2020 6966 206e 6f64 652e 7065 6572      if node.peer
+00015220: 732e 6973 5f61 6c6c 6f77 6564 2870 6565  s.is_allowed(pee
+00015230: 725f 6970 2c20 6461 7461 293a 0a20 2020  r_ip, data):.   
+00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015250: 2020 2020 2072 6567 5f73 7472 696e 6720       reg_string 
+00015260: 3d20 7265 6365 6976 6528 7365 6c66 2e72  = receive(self.r
+00015270: 6571 7565 7374 290a 0a20 2020 2020 2020  equest)..       
+00015280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015290: 2072 6567 6973 7465 7265 645f 7065 6e64   registered_pend
+000152a0: 696e 6720 3d20 6d70 2e4d 454d 504f 4f4c  ing = mp.MEMPOOL
+000152b0: 2e66 6574 6368 6f6e 6528 2753 454c 4543  .fetchone('SELEC
+000152c0: 5420 7469 6d65 7374 616d 7020 4652 4f4d  T timestamp FROM
+000152d0: 2074 7261 6e73 6163 7469 6f6e 7320 5748   transactions WH
+000152e0: 4552 4520 6f70 656e 6669 656c 6420 3d20  ERE openfield = 
+000152f0: 3f3b 272c 2028 2761 6c69 6173 3d27 202b  ?;', ('alias=' +
+00015300: 2072 6567 5f73 7472 696e 672c 2029 290a   reg_string, )).
+00015310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015320: 2020 2020 2020 2020 2064 625f 6861 6e64           db_hand
+00015330: 6c65 725f 696e 7374 616e 6365 203d 2064  ler_instance = d
+00015340: 6268 616e 646c 6572 2e44 6248 616e 646c  bhandler.DbHandl
+00015350: 6572 286e 6f64 652e 696e 6465 785f 6462  er(node.index_db
+00015360: 2c20 6e6f 6465 2e6c 6564 6765 725f 7061  , node.ledger_pa
+00015370: 7468 2c20 6e6f 6465 2e68 7970 6572 5f70  th, node.hyper_p
+00015380: 6174 682c 206e 6f64 652e 7261 6d2c 206e  ath, node.ram, n
+00015390: 6f64 652e 6c65 6467 6572 5f72 616d 5f66  ode.ledger_ram_f
+000153a0: 696c 652c 206e 6f64 652e 6c6f 6767 6572  ile, node.logger
+000153b0: 2c20 7472 6163 655f 6462 5f63 616c 6c73  , trace_db_calls
+000153c0: 3d6e 6f64 652e 7472 6163 655f 6462 5f63  =node.trace_db_c
+000153d0: 616c 6c73 290a 2020 2020 2020 2020 2020  alls).          
+000153e0: 2020 2020 2020 2020 2020 2020 2020 6462                db
+000153f0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+00015400: 652e 6578 6563 7574 655f 7061 7261 6d28  e.execute_param(
+00015410: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00015420: 6e63 652e 682c 2027 5345 4c45 4354 2074  nce.h, 'SELECT t
+00015430: 696d 6573 7461 6d70 2046 524f 4d20 7472  imestamp FROM tr
+00015440: 616e 7361 6374 696f 6e73 2057 4845 5245  ansactions WHERE
+00015450: 206f 7065 6e66 6965 6c64 203d 203f 3b27   openfield = ?;'
+00015460: 2c20 2827 616c 6961 733d 2720 2b20 7265  , ('alias=' + re
+00015470: 675f 7374 7269 6e67 2c20 2929 0a20 2020  g_string, )).   
+00015480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015490: 2020 2020 2072 6567 6973 7465 7265 645f       registered_
+000154a0: 616c 7265 6164 7920 3d20 6462 5f68 616e  already = db_han
+000154b0: 646c 6572 5f69 6e73 7461 6e63 652e 682e  dler_instance.h.
+000154c0: 6665 7463 686f 6e65 2829 0a20 2020 2020  fetchone().     
 000154d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154e0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-000154f0: 6571 7565 7374 2c20 6469 6666 6c61 7374  equest, difflast
-00015500: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015510: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00015540: 6170 705f 6c6f 672e 696e 666f 2827 667b  app_log.info('f{
-00015550: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
-00015560: 7465 6c69 7374 6564 2066 6f72 2064 6966  telisted for dif
-00015570: 666c 6173 7467 6574 2063 6f6d 6d61 6e64  flastget command
-00015580: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-00015590: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
-000155a0: 2027 6469 6666 6c61 7374 6a73 6f6e 273a   'difflastjson':
+000154e0: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+000154f0: 7374 616e 6365 2e63 6c6f 7365 2829 0a0a  stance.close()..
+00015500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015510: 2020 2020 2020 2020 6966 2072 6567 6973          if regis
+00015520: 7465 7265 645f 616c 7265 6164 7920 6973  tered_already is
+00015530: 204e 6f6e 6520 616e 6420 7265 6769 7374   None and regist
+00015540: 6572 6564 5f70 656e 6469 6e67 2069 7320  ered_pending is 
+00015550: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00015560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015570: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+00015580: 6573 742c 2027 416c 6961 7320 6672 6565  est, 'Alias free
+00015590: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000155a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
 000155b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000155c0: 2020 2020 2069 6620 6e6f 6465 2e70 6565       if node.pee
-000155d0: 7273 2e69 735f 616c 6c6f 7765 6428 7065  rs.is_allowed(pe
-000155e0: 6572 5f69 702c 2064 6174 6129 3a0a 0a20  er_ip, data):.. 
-000155f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015600: 2020 2020 2020 2064 6966 666c 6173 7420         difflast 
-00015610: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
-00015620: 7461 6e63 652e 6469 6666 6c61 7374 2829  tance.difflast()
-00015630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015640: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-00015650: 6520 3d20 7b27 626c 6f63 6b27 3a20 6469  e = {'block': di
-00015660: 6666 6c61 7374 5b30 5d2c 2027 6469 6666  fflast[0], 'diff
-00015670: 6963 756c 7479 273a 2064 6966 666c 6173  iculty': difflas
-00015680: 745b 315d 7d0a 2020 2020 2020 2020 2020  t[1]}.          
-00015690: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000156a0: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
-000156b0: 2072 6573 706f 6e73 6529 0a20 2020 2020   response).     
-000156c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000156d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000156e0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-000156f0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00015700: 2e69 6e66 6f28 6627 7b70 6565 725f 6970  .info(f'{peer_ip
-00015710: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
-00015720: 6420 666f 7220 6469 6666 6c61 7374 6a73  d for difflastjs
-00015730: 6f6e 2063 6f6d 6d61 6e64 2729 0a0a 2020  on command')..  
-00015740: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00015750: 6966 2064 6174 6120 3d3d 2027 7374 6f70  if data == 'stop
-00015760: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00015770: 2020 2020 2020 2069 6620 6e6f 6465 2e70         if node.p
-00015780: 6565 7273 2e69 735f 616c 6c6f 7765 6428  eers.is_allowed(
-00015790: 7065 6572 5f69 702c 2064 6174 6129 3a0a  peer_ip, data):.
-000157a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157b0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-000157c0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-000157d0: 696e 6728 6627 5265 6365 6976 6564 2073  ing(f'Received s
-000157e0: 746f 7020 6672 6f6d 207b 7065 6572 5f69  top from {peer_i
-000157f0: 707d 2729 0a20 2020 2020 2020 2020 2020  p}').           
-00015800: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00015810: 652e 4953 5f53 544f 5050 494e 4720 3d20  e.IS_STOPPING = 
-00015820: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00015830: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015850: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-00015860: 6572 2e61 7070 5f6c 6f67 2e69 6e66 6f28  er.app_log.info(
-00015870: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
-00015880: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
-00015890: 7374 6f70 2063 6f6d 6d61 6e64 2729 0a0a  stop command')..
-000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158b0: 656c 6966 2064 6174 6120 3d3d 2027 626c  elif data == 'bl
-000158c0: 6f63 6b5f 6865 6967 6874 5f66 726f 6d5f  ock_height_from_
-000158d0: 6861 7368 273a 0a20 2020 2020 2020 2020  hash':.         
-000158e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000158f0: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
-00015900: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
-00015910: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
-00015920: 2020 2020 2020 2020 2020 2020 6861 7368              hash
-00015930: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
-00015940: 7265 7175 6573 7429 0a20 2020 2020 2020  request).       
-00015950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015960: 2072 6573 706f 6e73 6520 3d20 6462 5f68   response = db_h
-00015970: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
-00015980: 626c 6f63 6b5f 6865 6967 6874 5f66 726f  block_height_fro
-00015990: 6d5f 6861 7368 2868 6173 6829 0a20 2020  m_hash(hash).   
-000159a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159b0: 2020 2020 2073 656e 6428 7365 6c66 2e72       send(self.r
-000159c0: 6571 7565 7374 2c20 7265 7370 6f6e 7365  equest, response
-000159d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000159e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000159f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a00: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00015a10: 6170 705f 6c6f 672e 696e 666f 2866 277b  app_log.info(f'{
-00015a20: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
-00015a30: 7465 6c69 7374 6564 2066 6f72 2062 6c6f  telisted for blo
-00015a40: 636b 5f68 6569 6768 745f 6672 6f6d 5f68  ck_height_from_h
-00015a50: 6173 6820 636f 6d6d 616e 6427 290a 0a20  ash command').. 
-00015a60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00015a70: 6c69 6620 6461 7461 203d 3d20 2761 6464  lif data == 'add
-00015a80: 7065 6572 7327 3a0a 2020 2020 2020 2020  peers':.        
-00015a90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00015aa0: 6f64 652e 7065 6572 732e 6973 5f61 6c6c  ode.peers.is_all
-00015ab0: 6f77 6564 2870 6565 725f 6970 2c20 6461  owed(peer_ip, da
-00015ac0: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-00015ad0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00015ae0: 6120 3d20 7265 6365 6976 6528 7365 6c66  a = receive(self
-00015af0: 2e72 6571 7565 7374 290a 2020 2020 2020  .request).      
-00015b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b10: 2020 2320 7065 6572 7379 6e63 2065 7870    # peersync exp
-00015b20: 6563 7473 2061 2064 6963 7420 656e 636f  ects a dict enco
-00015b30: 6465 6420 6173 206a 736f 6e20 7374 7269  ded as json stri
-00015b40: 6e67 2c20 6e6f 7420 6120 7374 7261 6967  ng, not a straig
-00015b50: 6874 2064 6963 740a 2020 2020 2020 2020  ht dict.        
-00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00015b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b90: 2072 6573 203d 206e 6f64 652e 7065 6572   res = node.peer
-00015ba0: 732e 7065 6572 7379 6e63 2864 6174 6129  s.peersync(data)
-00015bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015bc0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-00015bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015be0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00015bf0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00015c00: 2e77 6172 6e69 6e67 2866 277b 7065 6572  .warning(f'{peer
-00015c10: 5f69 707d 2073 656e 7420 696e 7661 6c69  _ip} sent invali
-00015c20: 6420 7065 6572 7320 6c69 7374 2729 0a20  d peers list'). 
-00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00015c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015c60: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
-00015c70: 6c66 2e72 6571 7565 7374 2c20 7b27 6164  lf.request, {'ad
-00015c80: 6465 6427 3a20 7265 737d 290a 2020 2020  ded': res}).    
+000155c0: 2020 2020 2020 2020 2020 2020 2073 656e               sen
+000155d0: 6428 7365 6c66 2e72 6571 7565 7374 2c20  d(self.request, 
+000155e0: 2741 6c69 6173 2072 6567 6973 7465 7265  'Alias registere
+000155f0: 6427 290a 2020 2020 2020 2020 2020 2020  d').            
+00015600: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00015610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015620: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00015630: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00015640: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
+00015650: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
+00015660: 616c 6961 7363 6865 636b 2063 6f6d 6d61  aliascheck comma
+00015670: 6e64 2729 0a0a 2020 2020 2020 2020 2020  nd')..          
+00015680: 2020 2020 2020 656c 6966 2064 6174 6120        elif data 
+00015690: 3d3d 2027 7478 7365 6e64 273a 0a20 2020  == 'txsend':.   
+000156a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156b0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+000156c0: 2020 2020 2020 2020 2054 6869 7320 6973           This is
+000156d0: 206d 6f73 7420 756e 7361 6665 2061 6e64   most unsafe and
+000156e0: 2073 686f 756c 6420 6e65 7665 7220 6265   should never be
+000156f0: 2075 7365 642e 0a20 2020 2020 2020 2020   used..         
+00015700: 2020 2020 2020 2020 2020 202d 206e 6f64             - nod
+00015710: 6520 6765 7473 2074 6865 2070 7269 766b  e gets the privk
+00015720: 6579 0a20 2020 2020 2020 2020 2020 2020  ey.             
+00015730: 2020 2020 2020 202d 2064 7570 2063 6f64         - dup cod
+00015740: 6520 666f 7220 6173 7365 6d62 6c69 6e67  e for assembling
+00015750: 2061 6e64 2073 6967 6e69 6e67 2074 6865   and signing the
+00015760: 2054 580a 2020 2020 2020 2020 2020 2020   TX.            
+00015770: 2020 2020 2020 2020 544f 444f 3a20 4445          TODO: DE
+00015780: 5052 4543 4154 4544 0a20 2020 2020 2020  PRECATED.       
+00015790: 2020 2020 2020 2020 2020 2020 2022 2222               """
+000157a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000157b0: 2020 2020 2069 6620 6e6f 6465 2e70 6565       if node.pee
+000157c0: 7273 2e69 735f 616c 6c6f 7765 6428 7065  rs.is_allowed(pe
+000157d0: 6572 5f69 702c 2064 6174 6129 3a0a 2020  er_ip, data):.  
+000157e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157f0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00015800: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+00015810: 6728 2274 7873 656e 6420 6973 2075 6e73  g("txsend is uns
+00015820: 6166 6520 616e 6420 6465 7072 6563 6174  afe and deprecat
+00015830: 6564 2c20 706c 6561 7365 2064 6f6e 2774  ed, please don't
+00015840: 2075 7365 2e22 290a 2020 2020 2020 2020   use.").        
+00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 7478 5f72 656d 6f74 6520 3d20 7265 6365  tx_remote = rece
+00015870: 6976 6528 7365 6c66 2e72 6571 7565 7374  ive(self.request
+00015880: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00015890: 2020 2020 2020 2020 2020 2023 2072 6563             # rec
+000158a0: 6569 7665 2064 6174 6120 6e65 6365 7373  eive data necess
+000158b0: 6172 7920 666f 7220 7265 6d6f 7465 2074  ary for remote t
+000158c0: 7820 636f 6e73 7472 7563 7469 6f6e 0a20  x construction. 
+000158d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158e0: 2020 2020 2020 2072 656d 6f74 655f 7478         remote_tx
+000158f0: 5f74 696d 6573 7461 6d70 203d 2074 785f  _timestamp = tx_
+00015900: 7265 6d6f 7465 5b30 5d0a 2020 2020 2020  remote[0].      
+00015910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015920: 2020 7265 6d6f 7465 5f74 785f 7072 6976    remote_tx_priv
+00015930: 6b65 7920 3d20 7478 5f72 656d 6f74 655b  key = tx_remote[
+00015940: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+00015950: 2020 2020 2020 2020 2020 2072 656d 6f74             remot
+00015960: 655f 7478 5f72 6563 6970 6965 6e74 203d  e_tx_recipient =
+00015970: 2074 785f 7265 6d6f 7465 5b32 5d0a 2020   tx_remote[2].  
+00015980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015990: 2020 2020 2020 7265 6d6f 7465 5f74 785f        remote_tx_
+000159a0: 616d 6f75 6e74 203d 2074 785f 7265 6d6f  amount = tx_remo
+000159b0: 7465 5b33 5d0a 2020 2020 2020 2020 2020  te[3].          
+000159c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000159d0: 6d6f 7465 5f74 785f 6f70 6572 6174 696f  mote_tx_operatio
+000159e0: 6e20 3d20 7478 5f72 656d 6f74 655b 345d  n = tx_remote[4]
+000159f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015a00: 2020 2020 2020 2020 2072 656d 6f74 655f           remote_
+00015a10: 7478 5f6f 7065 6e66 6965 6c64 203d 2074  tx_openfield = t
+00015a20: 785f 7265 6d6f 7465 5b35 5d0a 2020 2020  x_remote[5].    
+00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a40: 2020 2020 2320 7265 6365 6976 6520 6461      # receive da
+00015a50: 7461 206e 6563 6573 7361 7279 2066 6f72  ta necessary for
+00015a60: 2072 656d 6f74 6520 7478 2063 6f6e 7374   remote tx const
+00015a70: 7275 6374 696f 6e0a 0a20 2020 2020 2020  ruction..       
+00015a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a90: 2023 2064 6572 6976 6520 7265 6d61 696e   # derive remain
+00015aa0: 696e 6720 6461 7461 0a20 2020 2020 2020  ing data.       
+00015ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ac0: 2074 785f 7265 6d6f 7465 5f6b 6579 203d   tx_remote_key =
+00015ad0: 2052 5341 2e69 6d70 6f72 744b 6579 2872   RSA.importKey(r
+00015ae0: 656d 6f74 655f 7478 5f70 7269 766b 6579  emote_tx_privkey
+00015af0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015b00: 2020 2020 2020 2020 2020 7265 6d6f 7465            remote
+00015b10: 5f74 785f 7075 626b 6579 203d 2074 785f  _tx_pubkey = tx_
+00015b20: 7265 6d6f 7465 5f6b 6579 2e70 7562 6c69  remote_key.publi
+00015b30: 636b 6579 2829 2e65 7870 6f72 744b 6579  ckey().exportKey
+00015b40: 2829 2e64 6563 6f64 6528 2775 7466 2d38  ().decode('utf-8
+00015b50: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00015b60: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
+00015b70: 7465 5f74 785f 7075 626b 6579 5f62 3634  te_tx_pubkey_b64
+00015b80: 656e 636f 6465 6420 3d20 6261 7365 3634  encoded = base64
+00015b90: 2e62 3634 656e 636f 6465 2872 656d 6f74  .b64encode(remot
+00015ba0: 655f 7478 5f70 7562 6b65 792e 656e 636f  e_tx_pubkey.enco
+00015bb0: 6465 2827 7574 662d 3827 2929 2e64 6563  de('utf-8')).dec
+00015bc0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
+00015bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015be0: 2020 2020 2020 7265 6d6f 7465 5f74 785f        remote_tx_
+00015bf0: 6164 6472 6573 7320 3d20 6861 7368 6c69  address = hashli
+00015c00: 622e 7368 6132 3234 2872 656d 6f74 655f  b.sha224(remote_
+00015c10: 7478 5f70 7562 6b65 792e 656e 636f 6465  tx_pubkey.encode
+00015c20: 2827 7574 662d 3827 2929 2e68 6578 6469  ('utf-8')).hexdi
+00015c30: 6765 7374 2829 0a20 2020 2020 2020 2020  gest().         
+00015c40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015c50: 2064 6572 6976 6520 7265 6d61 696e 696e   derive remainin
+00015c60: 6720 6461 7461 0a0a 2020 2020 2020 2020  g data..        
+00015c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c80: 2320 636f 6e73 7472 7563 7420 7478 0a20  # construct tx. 
 00015c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ca0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00015cb0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
-00015cc0: 6627 7b72 6573 7d20 7065 6572 7320 6164  f'{res} peers ad
-00015cd0: 6465 6427 290a 2020 2020 2020 2020 2020  ded').          
-00015ce0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00015cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d00: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
-00015d10: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-00015d20: 696e 6728 6627 7b70 6565 725f 6970 7d20  ing(f'{peer_ip} 
-00015d30: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
-00015d40: 666f 7220 6164 6470 6565 7273 2729 0a0a  for addpeers')..
-00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00015d70: 2020 2020 2020 2020 2020 6966 2064 6174            if dat
-00015d80: 6120 3d3d 2027 2a27 3a0a 2020 2020 2020  a == '*':.      
-00015d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015da0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00015db0: 6f72 2827 4272 6f6b 656e 2070 6970 6527  or('Broken pipe'
-00015dc0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00015dd0: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
-00015de0: 2074 6865 2065 6e74 7279 2070 6f69 6e74   the entry point
-00015df0: 2066 6f72 2061 6c6c 2065 7874 7261 2063   for all extra c
-00015e00: 6f6d 6d61 6e64 7320 6672 6f6d 2070 6c75  ommands from plu
-00015e10: 6769 6e73 0a20 2020 2020 2020 2020 2020  gins.           
-00015e20: 2020 2020 2020 2020 2066 6f72 2070 7265           for pre
-00015e30: 6669 782c 2063 616c 6c62 6163 6b20 696e  fix, callback in
-00015e40: 2065 7874 7261 5f63 6f6d 6d61 6e64 732e   extra_commands.
-00015e50: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00015e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e70: 2069 6620 6461 7461 2e73 7461 7274 7377   if data.startsw
-00015e80: 6974 6828 7072 6566 6978 293a 0a20 2020  ith(prefix):.   
-00015e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ea0: 2020 2020 2020 2020 2065 7874 7261 203d           extra =
-00015eb0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00015ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ed0: 2020 6361 6c6c 6261 636b 2864 6174 612c    callback(data,
-00015ee0: 2073 656c 662e 7265 7175 6573 7429 0a0a   self.request)..
-00015ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f00: 2020 2020 6966 206e 6f74 2065 7874 7261      if not extra
-00015f10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015f20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00015f30: 5661 6c75 6545 7272 6f72 2827 556e 6578  ValueError('Unex
-00015f40: 7065 6374 6564 2065 7272 6f72 2c20 7265  pected error, re
-00015f50: 6365 6976 6564 3a20 2720 2b20 7374 7228  ceived: ' + str(
-00015f60: 6461 7461 295b 3a33 325d 202b 2027 202e  data)[:32] + ' .
-00015f70: 2e2e 2729 0a0a 2020 2020 2020 2020 2020  ..')..          
-00015f80: 2020 2020 2020 6966 206e 6f74 2074 696d        if not tim
-00015f90: 652e 7469 6d65 2829 203c 3d20 7469 6d65  e.time() <= time
-00015fa0: 725f 6f70 6572 6174 696f 6e20 2b20 7469  r_operation + ti
-00015fb0: 6d65 6f75 745f 6f70 6572 6174 696f 6e3a  meout_operation:
-00015fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015fd0: 2020 2020 2074 696d 6572 5f6f 7065 7261       timer_opera
-00015fe0: 7469 6f6e 203d 2074 696d 652e 7469 6d65  tion = time.time
-00015ff0: 2829 2020 2320 7265 7365 7420 7469 6d65  ()  # reset time
-00016000: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00016010: 2020 2320 7469 6d65 2e73 6c65 6570 2866    # time.sleep(f
-00016020: 6c6f 6174 286e 6f64 652e 7061 7573 6529  loat(node.pause)
-00016030: 2920 2023 2070 7265 7665 6e74 2063 7075  )  # prevent cpu
-00016040: 206f 7665 726c 6f61 640a 2020 2020 2020   overload.      
-00016050: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-00016060: 6f67 6765 722e 6170 705f 6c6f 672e 696e  ogger.app_log.in
-00016070: 666f 2866 2753 6572 7665 7220 6c6f 6f70  fo(f'Server loop
-00016080: 2066 696e 6973 6865 6420 666f 7220 7b70   finished for {p
-00016090: 6565 725f 6970 7d27 290a 0a20 2020 2020  eer_ip}')..     
-000160a0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-000160b0: 6365 7074 696f 6e20 6173 2065 3a0a 0a20  ception as e:.. 
-000160c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000160d0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-000160e0: 6f67 2e69 6e66 6f28 6627 496e 626f 756e  og.info(f'Inboun
-000160f0: 643a 204c 6f73 7420 636f 6e6e 6563 7469  d: Lost connecti
-00016100: 6f6e 2074 6f20 7b70 6565 725f 6970 7d27  on to {peer_ip}'
-00016110: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016120: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-00016130: 705f 6c6f 672e 696e 666f 2866 2749 6e62  p_log.info(f'Inb
-00016140: 6f75 6e64 3a20 7b65 7d27 290a 0a20 2020  ound: {e}')..   
-00016150: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-00016160: 656d 6f76 6520 6672 6f6d 2063 6f6e 7365  emove from conse
-00016170: 6e73 7573 2028 636f 6e6e 6563 7469 6f6e  nsus (connection
-00016180: 2066 726f 6d20 7468 656d 290a 2020 2020   from them).    
-00016190: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000161a0: 2e70 6565 7273 2e63 6f6e 7365 6e73 7573  .peers.consensus
-000161b0: 5f72 656d 6f76 6528 7065 6572 5f69 7029  _remove(peer_ip)
-000161c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000161d0: 2023 2072 656d 6f76 6520 6672 6f6d 2063   # remove from c
-000161e0: 6f6e 7365 6e73 7573 2028 636f 6e6e 6563  onsensus (connec
-000161f0: 7469 6f6e 2066 726f 6d20 7468 656d 290a  tion from them).
-00016200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016210: 7365 6c66 2e72 6571 7565 7374 2e63 6c6f  self.request.clo
-00016220: 7365 2829 0a0a 2020 2020 2020 2020 2020  se()..          
-00016230: 2020 2020 2020 6966 206e 6f64 652e 6465        if node.de
-00016240: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-00016250: 2020 2020 2020 2020 2072 6169 7365 2020           raise  
-00016260: 2320 6d61 6a6f 7220 6465 6275 6720 636c  # major debug cl
-00016270: 6965 6e74 0a20 2020 2020 2020 2020 2020  ient.           
-00016280: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00016290: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000162a0: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-000162b0: 6620 6e6f 7420 6e6f 6465 2e70 6565 7273  f not node.peers
-000162c0: 2e76 6572 7369 6f6e 5f61 6c6c 6f77 6564  .version_allowed
-000162d0: 2870 6565 725f 6970 2c20 6e6f 6465 2e76  (peer_ip, node.v
-000162e0: 6572 7369 6f6e 5f61 6c6c 6f77 293a 0a20  ersion_allow):. 
-000162f0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-00016300: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-00016310: 6172 6e69 6e67 2866 2749 6e62 6f75 6e64  arning(f'Inbound
-00016320: 3a20 436c 6f73 696e 6720 636f 6e6e 6563  : Closing connec
-00016330: 7469 6f6e 2074 6f20 6f6c 6420 7b70 6565  tion to old {pee
-00016340: 725f 6970 7d20 6e6f 6465 3a20 7b6e 6f64  r_ip} node: {nod
-00016350: 652e 7065 6572 732e 6970 5f74 6f5f 6d61  e.peers.ip_to_ma
-00016360: 696e 6e65 745b 7065 6572 5f69 705d 7d27  innet[peer_ip]}'
-00016370: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00016380: 0a0a 0a63 6c61 7373 2054 6872 6561 6465  ...class Threade
-00016390: 6454 4350 5365 7276 6572 2873 6f63 6b65  dTCPServer(socke
-000163a0: 7473 6572 7665 722e 5468 7265 6164 696e  tserver.Threadin
-000163b0: 674d 6978 496e 2c20 736f 636b 6574 7365  gMixIn, socketse
-000163c0: 7276 6572 2e54 4350 5365 7276 6572 293a  rver.TCPServer):
-000163d0: 0a20 2020 2070 6173 730a 0a0a 6465 6620  .    pass...def 
-000163e0: 6a75 7374 5f69 6e74 5f66 726f 6d28 7329  just_int_from(s)
-000163f0: 3a0a 2020 2020 23c2 a054 4f44 4f3a 206d  :.    #..TODO: m
-00016400: 6f76 6520 746f 2065 7373 656e 7469 616c  ove to essential
-00016410: 732e 7079 0a20 2020 2072 6574 7572 6e20  s.py.    return 
-00016420: 696e 7428 2727 2e6a 6f69 6e28 6920 666f  int(''.join(i fo
-00016430: 7220 6920 696e 2073 2069 6620 692e 6973  r i in s if i.is
-00016440: 6469 6769 7428 2929 290a 0a0a 6465 6620  digit()))...def 
-00016450: 7365 7475 705f 6e65 745f 7479 7065 2829  setup_net_type()
-00016460: 3a0a 2020 2020 2222 220a 2020 2020 4164  :.    """.    Ad
-00016470: 6a75 7374 2067 6c6f 6261 6c73 2064 6570  just globals dep
-00016480: 656e 6469 6e67 206f 6e20 6d61 696e 6e65  ending on mainne
-00016490: 742c 2074 6573 746e 6574 206f 7220 7265  t, testnet or re
-000164a0: 676e 6574 0a20 2020 2022 2222 0a20 2020  gnet.    """.   
-000164b0: 2023 2054 4f44 4f3a 206f 6e6c 7920 6465   # TODO: only de
-000164c0: 616c 7320 7769 7468 2027 6e6f 6465 2720  als with 'node' 
-000164d0: 7374 7275 6374 7572 652c 2063 616e 6469  structure, candi
-000164e0: 6461 7465 2066 6f72 2073 696e 676c 6520  date for single 
-000164f0: 7573 6572 206d 6f64 652e 0a20 2020 2023  user mode..    #
-00016500: 2044 6566 6175 6c74 7320 7661 6c75 652c   Defaults value,
-00016510: 2064 7570 2764 2068 6572 6520 666f 7220   dup'd here for 
-00016520: 636c 6172 6974 7920 7361 6b65 2e0a 2020  clarity sake..  
-00016530: 2020 6e6f 6465 2e69 735f 6d61 696e 6e65    node.is_mainne
-00016540: 7420 3d20 5472 7565 0a20 2020 206e 6f64  t = True.    nod
-00016550: 652e 6973 5f74 6573 746e 6574 203d 2046  e.is_testnet = F
-00016560: 616c 7365 0a20 2020 206e 6f64 652e 6973  alse.    node.is
-00016570: 5f72 6567 6e65 7420 3d20 4661 6c73 650a  _regnet = False.
-00016580: 0a20 2020 2069 6620 2774 6573 746e 6574  .    if 'testnet
-00016590: 2720 696e 206e 6f64 652e 7665 7273 696f  ' in node.versio
-000165a0: 6e20 6f72 206e 6f64 652e 6973 5f74 6573  n or node.is_tes
-000165b0: 746e 6574 3a0a 2020 2020 2020 2020 6e6f  tnet:.        no
-000165c0: 6465 2e69 735f 7465 7374 6e65 7420 3d20  de.is_testnet = 
-000165d0: 5472 7565 0a20 2020 2020 2020 206e 6f64  True.        nod
-000165e0: 652e 6973 5f6d 6169 6e6e 6574 203d 2046  e.is_mainnet = F
-000165f0: 616c 7365 0a20 2020 2020 2020 206e 6f64  alse.        nod
-00016600: 652e 7665 7273 696f 6e5f 616c 6c6f 7720  e.version_allow 
-00016610: 3d20 2774 6573 746e 6574 270a 0a20 2020  = 'testnet'..   
-00016620: 2069 6620 2772 6567 6e65 7427 2069 6e20   if 'regnet' in 
-00016630: 6e6f 6465 2e76 6572 7369 6f6e 206f 7220  node.version or 
-00016640: 6e6f 6465 2e69 735f 7265 676e 6574 3a0a  node.is_regnet:.
-00016650: 2020 2020 2020 2020 6e6f 6465 2e69 735f          node.is_
-00016660: 7265 676e 6574 203d 2054 7275 650a 2020  regnet = True.  
-00016670: 2020 2020 2020 6e6f 6465 2e69 735f 7465        node.is_te
-00016680: 7374 6e65 7420 3d20 4661 6c73 650a 2020  stnet = False.  
-00016690: 2020 2020 2020 6e6f 6465 2e69 735f 6d61        node.is_ma
-000166a0: 696e 6e65 7420 3d20 4661 6c73 650a 0a20  innet = False.. 
-000166b0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-000166c0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
-000166d0: 2754 6573 746e 6574 3a20 7b6e 6f64 652e  'Testnet: {node.
-000166e0: 6973 5f74 6573 746e 6574 7d27 290a 2020  is_testnet}').  
-000166f0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-00016700: 705f 6c6f 672e 7761 726e 696e 6728 6627  p_log.warning(f'
-00016710: 5265 676e 6574 203a 207b 6e6f 6465 2e69  Regnet : {node.i
-00016720: 735f 7265 676e 6574 7d27 290a 0a20 2020  s_regnet}')..   
-00016730: 2023 2064 6566 6175 6c74 206d 6169 6e6e   # default mainn
-00016740: 6574 2063 6f6e 6669 670a 2020 2020 6e6f  et config.    no
-00016750: 6465 2e70 6565 7266 696c 6520 3d20 2770  de.peerfile = 'p
-00016760: 6565 7273 2e74 7874 270a 2020 2020 6e6f  eers.txt'.    no
-00016770: 6465 2e6c 6564 6765 725f 7261 6d5f 6669  de.ledger_ram_fi
-00016780: 6c65 203d 2027 6669 6c65 3a6c 6564 6765  le = 'file:ledge
-00016790: 723f 6d6f 6465 3d6d 656d 6f72 7926 6361  r?mode=memory&ca
-000167a0: 6368 653d 7368 6172 6564 270a 2020 2020  che=shared'.    
-000167b0: 6e6f 6465 2e69 6e64 6578 5f64 6220 3d20  node.index_db = 
-000167c0: 2773 7461 7469 632f 696e 6465 782e 6462  'static/index.db
-000167d0: 270a 0a20 2020 2069 6620 6e6f 6465 2e69  '..    if node.i
-000167e0: 735f 6d61 696e 6e65 743a 0a20 2020 2020  s_mainnet:.     
-000167f0: 2020 2023 2041 6c6c 6f77 206f 6e6c 7920     # Allow only 
-00016800: 3231 2061 6e64 2075 700a 2020 2020 2020  21 and up.      
-00016810: 2020 6966 206e 6f64 652e 7665 7273 696f    if node.versio
-00016820: 6e20 213d 2027 6d61 696e 6e65 7430 3032  n != 'mainnet002
-00016830: 3127 3a0a 2020 2020 2020 2020 2020 2020  1':.            
-00016840: 6e6f 6465 2e76 6572 7369 6f6e 203d 2027  node.version = '
-00016850: 6d61 696e 6e65 7430 3032 3127 2020 2320  mainnet0021'  # 
-00016860: 466f 7263 6520 696e 2063 6f64 652e 0a20  Force in code.. 
-00016870: 2020 2020 2020 2069 6620 276d 6169 6e6e         if 'mainn
-00016880: 6574 3030 3231 2720 6e6f 7420 696e 206e  et0021' not in n
-00016890: 6f64 652e 7665 7273 696f 6e5f 616c 6c6f  ode.version_allo
-000168a0: 773a 0a20 2020 2020 2020 2020 2020 206e  w:.            n
-000168b0: 6f64 652e 7665 7273 696f 6e5f 616c 6c6f  ode.version_allo
-000168c0: 7720 3d20 5b27 6d61 696e 6e65 7430 3032  w = ['mainnet002
-000168d0: 3127 2c20 276d 6169 6e6e 6574 3030 3232  1', 'mainnet0022
-000168e0: 275d 0a20 2020 2020 2020 2023 2044 6f20  '].        # Do 
-000168f0: 6e6f 7420 616c 6c6f 7720 6261 6420 636f  not allow bad co
-00016900: 6e66 6967 732e 0a20 2020 2020 2020 2069  nfigs..        i
-00016910: 6620 6e6f 7420 276d 6169 6e6e 6574 2720  f not 'mainnet' 
-00016920: 696e 206e 6f64 652e 7665 7273 696f 6e3a  in node.version:
-00016930: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00016940: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00016950: 2e65 7272 6f72 2827 4261 6420 6d61 696e  .error('Bad main
-00016960: 6e65 7420 7665 7273 696f 6e2c 2063 6865  net version, che
-00016970: 636b 2063 6f6e 6669 672e 7478 7427 290a  ck config.txt').
-00016980: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-00016990: 6578 6974 2829 0a20 2020 2020 2020 206e  exit().        n
-000169a0: 756d 5f76 6572 203d 206a 7573 745f 696e  um_ver = just_in
-000169b0: 745f 6672 6f6d 286e 6f64 652e 7665 7273  t_from(node.vers
-000169c0: 696f 6e29 0a20 2020 2020 2020 2069 6620  ion).        if 
-000169d0: 6e75 6d5f 7665 7220 3c20 3231 3a0a 2020  num_ver < 21:.  
-000169e0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-000169f0: 6f67 6765 722e 6170 705f 6c6f 672e 6572  ogger.app_log.er
-00016a00: 726f 7228 2754 6f6f 206c 6f77 206d 6169  ror('Too low mai
-00016a10: 6e6e 6574 2076 6572 7369 6f6e 2c20 6368  nnet version, ch
-00016a20: 6563 6b20 636f 6e66 6967 2e74 7874 2729  eck config.txt')
-00016a30: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
-00016a40: 2e65 7869 7428 290a 2020 2020 2020 2020  .exit().        
-00016a50: 666f 7220 616c 6c6f 7765 6420 696e 206e  for allowed in n
-00016a60: 6f64 652e 7665 7273 696f 6e5f 616c 6c6f  ode.version_allo
-00016a70: 773a 0a20 2020 2020 2020 2020 2020 206e  w:.            n
-00016a80: 756d 5f76 6572 203d 206a 7573 745f 696e  um_ver = just_in
-00016a90: 745f 6672 6f6d 2861 6c6c 6f77 6564 290a  t_from(allowed).
-00016aa0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00016ab0: 756d 5f76 6572 203c 2032 303a 0a20 2020  um_ver < 20:.   
-00016ac0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00016ad0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00016ae0: 2e65 7272 6f72 2827 546f 6f20 6c6f 7720  .error('Too low 
-00016af0: 616c 6c6f 7765 6420 7665 7273 696f 6e2c  allowed version,
-00016b00: 2063 6865 636b 2063 6f6e 6669 672e 7478   check config.tx
-00016b10: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
-00016b20: 2020 2020 7379 732e 6578 6974 2829 0a0a      sys.exit()..
-00016b30: 2020 2020 6966 2027 7465 7374 6e65 7427      if 'testnet'
-00016b40: 2069 6e20 6e6f 6465 2e76 6572 7369 6f6e   in node.version
-00016b50: 206f 7220 6e6f 6465 2e69 735f 7465 7374   or node.is_test
-00016b60: 6e65 743a 0a20 2020 2020 2020 206e 6f64  net:.        nod
-00016b70: 652e 706f 7274 203d 2032 3832 390a 2020  e.port = 2829.  
-00016b80: 2020 2020 2020 6e6f 6465 2e68 7970 6572        node.hyper
-00016b90: 5f70 6174 6820 3d20 2773 7461 7469 632f  _path = 'static/
-00016ba0: 6879 7065 725f 7465 7374 2e64 6227 0a20  hyper_test.db'. 
-00016bb0: 2020 2020 2020 206e 6f64 652e 6c65 6467         node.ledg
-00016bc0: 6572 5f70 6174 6820 3d20 2773 7461 7469  er_path = 'stati
-00016bd0: 632f 6c65 6467 6572 5f74 6573 742e 6462  c/ledger_test.db
-00016be0: 270a 0a20 2020 2020 2020 206e 6f64 652e  '..        node.
-00016bf0: 6c65 6467 6572 5f72 616d 5f66 696c 6520  ledger_ram_file 
-00016c00: 3d20 2766 696c 653a 6c65 6467 6572 5f74  = 'file:ledger_t
-00016c10: 6573 746e 6574 3f6d 6f64 653d 6d65 6d6f  estnet?mode=memo
-00016c20: 7279 2663 6163 6865 3d73 6861 7265 6427  ry&cache=shared'
-00016c30: 0a20 2020 2020 2020 2023 6e6f 6465 2e68  .        #node.h
-00016c40: 7970 6572 5f72 6563 6f6d 7072 6573 7320  yper_recompress 
-00016c50: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00016c60: 6e6f 6465 2e70 6565 7266 696c 6520 3d20  node.peerfile = 
-00016c70: 2770 6565 7273 5f74 6573 742e 7478 7427  'peers_test.txt'
-00016c80: 0a20 2020 2020 2020 206e 6f64 652e 696e  .        node.in
-00016c90: 6465 785f 6462 203d 2027 7374 6174 6963  dex_db = 'static
-00016ca0: 2f69 6e64 6578 5f74 6573 742e 6462 270a  /index_test.db'.
-00016cb0: 2020 2020 2020 2020 6966 206e 6f74 2027          if not '
-00016cc0: 7465 7374 6e65 7427 2069 6e20 6e6f 6465  testnet' in node
-00016cd0: 2e76 6572 7369 6f6e 3a0a 2020 2020 2020  .version:.      
-00016ce0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-00016cf0: 722e 6170 705f 6c6f 672e 6572 726f 7228  r.app_log.error(
-00016d00: 2742 6164 2074 6573 746e 6574 2076 6572  'Bad testnet ver
-00016d10: 7369 6f6e 2c20 6368 6563 6b20 636f 6e66  sion, check conf
-00016d20: 6967 2e74 7874 2729 0a20 2020 2020 2020  ig.txt').       
-00016d30: 2020 2020 2073 7973 2e65 7869 7428 290a       sys.exit().
-00016d40: 0a20 2020 2020 2020 2072 6564 6f77 6e6c  .        redownl
-00016d50: 6f61 645f 7465 7374 203d 2069 6e70 7574  oad_test = input
-00016d60: 2827 5374 6174 7573 3a20 5765 6c63 6f6d  ('Status: Welcom
-00016d70: 6520 746f 2074 6865 2074 6573 746e 6574  e to the testnet
-00016d80: 2e20 5265 646f 776e 6c6f 6164 2074 6573  . Redownload tes
-00016d90: 7420 6c65 6467 6572 3f20 792f 6e27 290a  t ledger? y/n').
-00016da0: 2020 2020 2020 2020 6966 2072 6564 6f77          if redow
-00016db0: 6e6c 6f61 645f 7465 7374 203d 3d20 2779  nload_test == 'y
-00016dc0: 273a 0a20 2020 2020 2020 2020 2020 2074  ':.            t
-00016dd0: 7970 6573 203d 205b 2773 7461 7469 632f  ypes = ['static/
-00016de0: 6c65 6467 6572 5f74 6573 742e 6462 2d77  ledger_test.db-w
-00016df0: 616c 272c 2027 7374 6174 6963 2f6c 6564  al', 'static/led
-00016e00: 6765 725f 7465 7374 2e64 622d 7368 6d27  ger_test.db-shm'
-00016e10: 2c20 2773 7461 7469 632f 696e 6465 785f  , 'static/index_
-00016e20: 7465 7374 2e64 6227 2c20 2773 7461 7469  test.db', 'stati
-00016e30: 632f 6879 7065 725f 7465 7374 2e64 622d  c/hyper_test.db-
-00016e40: 7761 6c27 2c20 2773 7461 7469 632f 6879  wal', 'static/hy
-00016e50: 7065 725f 7465 7374 2e64 622d 7368 6d27  per_test.db-shm'
-00016e60: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00016e70: 7220 7479 7065 2069 6e20 7479 7065 733a  r type in types:
-00016e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016e90: 2066 6f72 2066 696c 6520 696e 2067 6c6f   for file in glo
-00016ea0: 622e 676c 6f62 2874 7970 6529 3a0a 2020  b.glob(type):.  
-00016eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ec0: 2020 6f73 2e72 656d 6f76 6528 6669 6c65    os.remove(file
-00016ed0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016ee0: 2020 2020 2020 7072 696e 7428 6669 6c65        print(file
-00016ef0: 2c20 2764 656c 6574 6564 2729 0a20 2020  , 'deleted').   
-00016f00: 2020 2020 2020 2020 2064 6f77 6e6c 6f61           downloa
-00016f10: 645f 6669 6c65 2827 6874 7470 733a 2f2f  d_file('https://
-00016f20: 6269 736d 7574 682e 637a 2f74 6573 742e  bismuth.cz/test.
-00016f30: 7461 722e 677a 272c 2027 7374 6174 6963  tar.gz', 'static
-00016f40: 2f74 6573 742e 7461 722e 677a 2729 0a20  /test.tar.gz'). 
-00016f50: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00016f60: 7461 7266 696c 652e 6f70 656e 2827 7374  tarfile.open('st
-00016f70: 6174 6963 2f74 6573 742e 7461 722e 677a  atic/test.tar.gz
-00016f80: 2729 2061 7320 7461 723a 0a20 2020 2020  ') as tar:.     
-00016f90: 2020 2020 2020 2020 2020 2074 6172 2e65             tar.e
-00016fa0: 7874 7261 6374 616c 6c28 2773 7461 7469  xtractall('stati
-00016fb0: 632f 2729 2020 2320 4e4f 5420 434f 4d50  c/')  # NOT COMP
-00016fc0: 4154 4942 4c45 2057 4954 4820 4355 5354  ATIBLE WITH CUST
-00016fd0: 4f4d 2050 4154 4820 434f 4e46 530a 2020  OM PATH CONFS.  
-00016fe0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00016ff0: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
-00017000: 6f74 2072 6564 6f77 6e6c 6f61 6469 6e67  ot redownloading
-00017010: 2074 6573 7420 6462 2729 0a0a 2020 2020   test db')..    
-00017020: 6966 2027 7265 676e 6574 2720 696e 206e  if 'regnet' in n
-00017030: 6f64 652e 7665 7273 696f 6e20 6f72 206e  ode.version or n
-00017040: 6f64 652e 6973 5f72 6567 6e65 743a 0a20  ode.is_regnet:. 
-00017050: 2020 2020 2020 206e 6f64 652e 706f 7274         node.port
-00017060: 203d 2072 6567 6e65 742e 5245 474e 4554   = regnet.REGNET
-00017070: 5f50 4f52 540a 2020 2020 2020 2020 6e6f  _PORT.        no
-00017080: 6465 2e68 7970 6572 5f70 6174 6820 3d20  de.hyper_path = 
-00017090: 7265 676e 6574 2e52 4547 4e45 545f 4442  regnet.REGNET_DB
-000170a0: 0a20 2020 2020 2020 206e 6f64 652e 6c65  .        node.le
-000170b0: 6467 6572 5f70 6174 6820 3d20 7265 676e  dger_path = regn
-000170c0: 6574 2e52 4547 4e45 545f 4442 0a20 2020  et.REGNET_DB.   
-000170d0: 2020 2020 206e 6f64 652e 6c65 6467 6572       node.ledger
-000170e0: 5f72 616d 5f66 696c 6520 3d20 2766 696c  _ram_file = 'fil
-000170f0: 653a 6c65 6467 6572 5f72 6567 6e65 743f  e:ledger_regnet?
-00017100: 6d6f 6465 3d6d 656d 6f72 7926 6361 6368  mode=memory&cach
-00017110: 653d 7368 6172 6564 270a 2020 2020 2020  e=shared'.      
-00017120: 2020 6e6f 6465 2e68 7970 6572 5f72 6563    node.hyper_rec
-00017130: 6f6d 7072 6573 7320 3d20 4661 6c73 650a  ompress = False.
-00017140: 2020 2020 2020 2020 6e6f 6465 2e70 6565          node.pee
-00017150: 7266 696c 6520 3d20 7265 676e 6574 2e52  rfile = regnet.R
-00017160: 4547 4e45 545f 5045 4552 530a 2020 2020  EGNET_PEERS.    
-00017170: 2020 2020 6e6f 6465 2e69 6e64 6578 5f64      node.index_d
-00017180: 6220 3d20 7265 676e 6574 2e52 4547 4e45  b = regnet.REGNE
-00017190: 545f 494e 4445 580a 2020 2020 2020 2020  T_INDEX.        
-000171a0: 6966 206e 6f74 2027 7265 676e 6574 2720  if not 'regnet' 
-000171b0: 696e 206e 6f64 652e 7665 7273 696f 6e3a  in node.version:
-000171c0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-000171d0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-000171e0: 2e65 7272 6f72 2827 4261 6420 7265 676e  .error('Bad regn
-000171f0: 6574 2076 6572 7369 6f6e 2c20 6368 6563  et version, chec
-00017200: 6b20 636f 6e66 6967 2e74 7874 2729 0a20  k config.txt'). 
-00017210: 2020 2020 2020 2020 2020 2073 7973 2e65             sys.e
-00017220: 7869 7428 290a 2020 2020 2020 2020 6966  xit().        if
-00017230: 206e 6f74 206e 6f64 652e 6865 6176 793a   not node.heavy:
-00017240: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00017250: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-00017260: 2e77 6172 6e69 6e67 2827 5265 676e 6574  .warning('Regnet
-00017270: 2077 6974 6820 6e6f 2068 6561 7679 2066   with no heavy f
-00017280: 696c 652e 2e2e 2729 0a20 2020 2020 2020  ile...').       
-00017290: 2020 2020 206d 696e 696e 675f 6865 6176       mining_heav
-000172a0: 7933 2e68 6561 7679 203d 2046 616c 7365  y3.heavy = False
-000172b0: 0a20 2020 2020 2020 206e 6f64 652e 6c6f  .        node.lo
-000172c0: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
-000172d0: 6e69 6e67 2827 5265 676e 6574 2069 6e69  ning('Regnet ini
-000172e0: 742e 2e2e 2729 0a20 2020 2020 2020 2072  t...').        r
-000172f0: 6567 6e65 742e 696e 6974 286e 6f64 652e  egnet.init(node.
-00017300: 6c6f 6767 6572 2e61 7070 5f6c 6f67 290a  logger.app_log).
-00017310: 2020 2020 2020 2020 7265 676e 6574 2e44          regnet.D
-00017320: 4947 4553 545f 424c 4f43 4b20 3d20 6469  IGEST_BLOCK = di
-00017330: 6765 7374 5f62 6c6f 636b 0a20 2020 2020  gest_block.     
-00017340: 2020 206d 696e 696e 675f 6865 6176 7933     mining_heavy3
-00017350: 2e69 735f 7265 676e 6574 203d 2054 7275  .is_regnet = Tru
-00017360: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-00017370: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-00017380: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
-00017390: 6728 2252 6567 6e65 7420 7374 696c 6c20  g("Regnet still 
-000173a0: 6973 2057 4950 2061 746d 2e22 290a 2020  is WIP atm.").  
-000173b0: 2020 2020 2020 7379 732e 6578 6974 2829        sys.exit()
-000173c0: 0a20 2020 2020 2020 2022 2222 0a0a 0a64  .        """...d
-000173d0: 6566 206e 6f64 655f 626c 6f63 6b5f 696e  ef node_block_in
-000173e0: 6974 2864 6174 6162 6173 6529 3a0a 2020  it(database):.  
-000173f0: 2020 2320 544f 444f 3a20 6361 6e64 6964    # TODO: candid
-00017400: 6174 6520 666f 7220 7369 6e67 6c65 2075  ate for single u
-00017410: 7365 7220 6d6f 6465 0a20 2020 206e 6f64  ser mode.    nod
-00017420: 652e 6864 645f 626c 6f63 6b20 3d20 6461  e.hdd_block = da
-00017430: 7461 6261 7365 2e62 6c6f 636b 5f68 6569  tabase.block_hei
-00017440: 6768 745f 6d61 7828 290a 2020 2020 6e6f  ght_max().    no
-00017450: 6465 2e64 6966 6669 6375 6c74 7920 3d20  de.difficulty = 
-00017460: 6469 6666 6963 756c 7479 286e 6f64 652c  difficulty(node,
-00017470: 2064 625f 6861 6e64 6c65 725f 696e 6974   db_handler_init
-00017480: 6961 6c29 2020 2320 6368 6563 6b20 6469  ial)  # check di
-00017490: 6666 2066 6f72 206d 696e 6572 0a0a 2020  ff for miner..  
-000174a0: 2020 6e6f 6465 2e6c 6173 745f 626c 6f63    node.last_bloc
-000174b0: 6b20 3d20 6e6f 6465 2e68 6464 5f62 6c6f  k = node.hdd_blo
-000174c0: 636b 2020 2320 7261 6d20 6571 7561 6c73  ck  # ram equals
-000174d0: 2064 7269 7665 2061 7420 7468 6973 2070   drive at this p
-000174e0: 6f69 6e74 0a0a 2020 2020 6e6f 6465 2e6c  oint..    node.l
-000174f0: 6173 745f 626c 6f63 6b5f 6861 7368 203d  ast_block_hash =
-00017500: 2064 6174 6162 6173 652e 6c61 7374 5f62   database.last_b
-00017510: 6c6f 636b 5f68 6173 6828 290a 2020 2020  lock_hash().    
-00017520: 6e6f 6465 2e68 6464 5f68 6173 6820 3d20  node.hdd_hash = 
-00017530: 6e6f 6465 2e6c 6173 745f 626c 6f63 6b5f  node.last_block_
-00017540: 6861 7368 2020 2320 7261 6d20 6571 7561  hash  # ram equa
-00017550: 6c73 2064 7269 7665 2061 7420 7468 6973  ls drive at this
-00017560: 2070 6f69 6e74 0a0a 2020 2020 6e6f 6465   point..    node
-00017570: 2e6c 6173 745f 626c 6f63 6b5f 7469 6d65  .last_block_time
-00017580: 7374 616d 7020 3d20 6461 7461 6261 7365  stamp = database
-00017590: 2e6c 6173 745f 626c 6f63 6b5f 7469 6d65  .last_block_time
-000175a0: 7374 616d 7028 290a 0a20 2020 2063 6865  stamp()..    che
-000175b0: 636b 706f 696e 745f 7365 7428 6e6f 6465  ckpoint_set(node
-000175c0: 290a 0a20 2020 206e 6f64 652e 6c6f 6767  )..    node.logg
-000175d0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-000175e0: 6e67 2827 5374 6174 7573 3a20 496e 6465  ng('Status: Inde
-000175f0: 7869 6e67 2061 6c69 6173 6573 2729 0a0a  xing aliases')..
-00017600: 2020 2020 616c 6961 7365 732e 616c 6961      aliases.alia
-00017610: 7365 735f 7570 6461 7465 286e 6f64 652c  ses_update(node,
-00017620: 2064 6174 6162 6173 6529 0a0a 0a64 6566   database)...def
-00017630: 2072 616d 5f69 6e69 7428 6461 7461 6261   ram_init(databa
-00017640: 7365 293a 0a20 2020 2023 2054 4f44 4f3a  se):.    # TODO:
-00017650: 2063 616e 6469 6461 7465 2066 6f72 2073   candidate for s
-00017660: 696e 676c 6520 7573 6572 206d 6f64 650a  ingle user mode.
-00017670: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00017680: 2069 6620 6e6f 6465 2e72 616d 3a0a 2020   if node.ram:.  
-00017690: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-000176a0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-000176b0: 726e 696e 6728 2753 7461 7475 733a 204d  rning('Status: M
-000176c0: 6f76 696e 6720 6461 7461 6261 7365 2074  oving database t
-000176d0: 6f20 5241 4d27 290a 0a20 2020 2020 2020  o RAM')..       
-000176e0: 2020 2020 2069 6620 6e6f 6465 2e70 795f       if node.py_
-000176f0: 7665 7273 696f 6e20 3e3d 2033 3730 3a0a  version >= 370:.
-00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017710: 7465 6d70 5f74 6172 6765 7420 3d20 7371  temp_target = sq
-00017720: 6c69 7465 332e 636f 6e6e 6563 7428 6e6f  lite3.connect(no
-00017730: 6465 2e6c 6564 6765 725f 7261 6d5f 6669  de.ledger_ram_fi
-00017740: 6c65 2c20 7572 693d 5472 7565 2c20 6973  le, uri=True, is
-00017750: 6f6c 6174 696f 6e5f 6c65 7665 6c3d 4e6f  olation_level=No
-00017760: 6e65 2c20 7469 6d65 6f75 743d 3129 0a20  ne, timeout=1). 
-00017770: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00017780: 6620 6e6f 6465 2e74 7261 6365 5f64 625f  f node.trace_db_
-00017790: 6361 6c6c 733a 0a20 2020 2020 2020 2020  calls:.         
-000177a0: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-000177b0: 7461 7267 6574 2e73 6574 5f74 7261 6365  target.set_trace
-000177c0: 5f63 616c 6c62 6163 6b28 6675 6e63 746f  _callback(functo
-000177d0: 6f6c 732e 7061 7274 6961 6c28 7371 6c5f  ols.partial(sql_
-000177e0: 7472 6163 655f 6361 6c6c 6261 636b 2c20  trace_callback, 
-000177f0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00017800: 6c6f 672c 2027 5445 4d50 2d54 4152 4745  log, 'TEMP-TARGE
-00017810: 5427 2929 0a0a 2020 2020 2020 2020 2020  T'))..          
-00017820: 2020 2020 2020 7465 6d70 5f73 6f75 7263        temp_sourc
-00017830: 6520 3d20 7371 6c69 7465 332e 636f 6e6e  e = sqlite3.conn
-00017840: 6563 7428 6e6f 6465 2e68 7970 6572 5f70  ect(node.hyper_p
-00017850: 6174 682c 2075 7269 3d54 7275 652c 2069  ath, uri=True, i
-00017860: 736f 6c61 7469 6f6e 5f6c 6576 656c 3d4e  solation_level=N
-00017870: 6f6e 652c 2074 696d 656f 7574 3d31 290a  one, timeout=1).
+00015ca0: 2020 2020 2020 2072 656d 6f74 655f 7478         remote_tx
+00015cb0: 203d 2028 7374 7228 7265 6d6f 7465 5f74   = (str(remote_t
+00015cc0: 785f 7469 6d65 7374 616d 7029 2c20 7374  x_timestamp), st
+00015cd0: 7228 7265 6d6f 7465 5f74 785f 6164 6472  r(remote_tx_addr
+00015ce0: 6573 7329 2c20 7374 7228 7265 6d6f 7465  ess), str(remote
+00015cf0: 5f74 785f 7265 6369 7069 656e 7429 2c20  _tx_recipient), 
+00015d00: 2725 2e38 6627 2025 2071 7561 6e74 697a  '%.8f' % quantiz
+00015d10: 655f 6569 6768 7428 7265 6d6f 7465 5f74  e_eight(remote_t
+00015d20: 785f 616d 6f75 6e74 292c 2073 7472 2872  x_amount), str(r
+00015d30: 656d 6f74 655f 7478 5f6f 7065 7261 7469  emote_tx_operati
+00015d40: 6f6e 292c 2073 7472 2872 656d 6f74 655f  on), str(remote_
+00015d50: 7478 5f6f 7065 6e66 6965 6c64 2929 2020  tx_openfield))  
+00015d60: 2320 7468 6973 2069 7320 7369 676e 6564  # this is signed
+00015d70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015d80: 2020 2020 2020 2020 2020 7265 6d6f 7465            remote
+00015d90: 5f68 6173 6820 3d20 5348 412e 6e65 7728  _hash = SHA.new(
+00015da0: 7374 7228 7265 6d6f 7465 5f74 7829 2e65  str(remote_tx).e
+00015db0: 6e63 6f64 6528 2775 7466 2d38 2729 290a  ncode('utf-8')).
+00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dd0: 2020 2020 2020 2020 7265 6d6f 7465 5f73          remote_s
+00015de0: 6967 6e65 7220 3d20 504b 4353 315f 7631  igner = PKCS1_v1
+00015df0: 5f35 2e6e 6577 2874 785f 7265 6d6f 7465  _5.new(tx_remote
+00015e00: 5f6b 6579 290a 2020 2020 2020 2020 2020  _key).          
+00015e10: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00015e20: 6d6f 7465 5f73 6967 6e61 7475 7265 203d  mote_signature =
+00015e30: 2072 656d 6f74 655f 7369 676e 6572 2e73   remote_signer.s
+00015e40: 6967 6e28 7265 6d6f 7465 5f68 6173 6829  ign(remote_hash)
+00015e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015e60: 2020 2020 2020 2020 2072 656d 6f74 655f           remote_
+00015e70: 7369 676e 6174 7572 655f 656e 6320 3d20  signature_enc = 
+00015e80: 6261 7365 3634 2e62 3634 656e 636f 6465  base64.b64encode
+00015e90: 2872 656d 6f74 655f 7369 676e 6174 7572  (remote_signatur
+00015ea0: 6529 2e64 6563 6f64 6528 2775 7466 2d38  e).decode('utf-8
+00015eb0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00015ec0: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
+00015ed0: 7374 7275 6374 2074 780a 0a20 2020 2020  struct tx..     
+00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ef0: 2020 2023 2069 6e73 6572 7420 746f 206d     # insert to m
+00015f00: 656d 706f 6f6c 2c20 7768 6572 6520 6576  empool, where ev
+00015f10: 6572 7974 6869 6e67 2077 696c 6c20 6265  erything will be
+00015f20: 2076 6572 6966 6965 640a 2020 2020 2020   verified.      
+00015f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f40: 2020 6d65 6d70 6f6f 6c5f 6461 7461 203d    mempool_data =
+00015f50: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00015f60: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00015f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f90: 2073 7472 2872 656d 6f74 655f 7478 5f74   str(remote_tx_t
+00015fa0: 696d 6573 7461 6d70 292c 0a20 2020 2020  imestamp),.     
+00015fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fc0: 2020 2020 2020 2020 2020 2073 7472 2872             str(r
+00015fd0: 656d 6f74 655f 7478 5f61 6464 7265 7373  emote_tx_address
+00015fe0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016000: 2020 2073 7472 2872 656d 6f74 655f 7478     str(remote_tx
+00016010: 5f72 6563 6970 6965 6e74 292c 0a20 2020  _recipient),.   
+00016020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016030: 2020 2020 2020 2020 2020 2020 2027 252e               '%.
+00016040: 3866 2720 2520 7175 616e 7469 7a65 5f65  8f' % quantize_e
+00016050: 6967 6874 2872 656d 6f74 655f 7478 5f61  ight(remote_tx_a
+00016060: 6d6f 756e 7429 2c0a 2020 2020 2020 2020  mount),.        
+00016070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016080: 2020 2020 2020 2020 7374 7228 7265 6d6f          str(remo
+00016090: 7465 5f73 6967 6e61 7475 7265 5f65 6e63  te_signature_enc
+000160a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000160b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160c0: 2020 2073 7472 2872 656d 6f74 655f 7478     str(remote_tx
+000160d0: 5f70 7562 6b65 795f 6236 3465 6e63 6f64  _pubkey_b64encod
+000160e0: 6564 292c 0a20 2020 2020 2020 2020 2020  ed),.           
+000160f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016100: 2020 2020 2073 7472 2872 656d 6f74 655f       str(remote_
+00016110: 7478 5f6f 7065 7261 7469 6f6e 292c 0a20  tx_operation),. 
+00016120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016130: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016140: 7472 2872 656d 6f74 655f 7478 5f6f 7065  tr(remote_tx_ope
+00016150: 6e66 6965 6c64 292c 0a20 2020 2020 2020  nfield),.       
+00016160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016170: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016180: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00016190: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000161a0: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+000161b0: 646c 6572 5f69 6e73 7461 6e63 6520 3d20  dler_instance = 
+000161c0: 6462 6861 6e64 6c65 722e 4462 4861 6e64  dbhandler.DbHand
+000161d0: 6c65 7228 6e6f 6465 2e69 6e64 6578 5f64  ler(node.index_d
+000161e0: 622c 206e 6f64 652e 6c65 6467 6572 5f70  b, node.ledger_p
+000161f0: 6174 682c 206e 6f64 652e 6879 7065 725f  ath, node.hyper_
+00016200: 7061 7468 2c20 6e6f 6465 2e72 616d 2c20  path, node.ram, 
+00016210: 6e6f 6465 2e6c 6564 6765 725f 7261 6d5f  node.ledger_ram_
+00016220: 6669 6c65 2c20 6e6f 6465 2e6c 6f67 6765  file, node.logge
+00016230: 722c 2074 7261 6365 5f64 625f 6361 6c6c  r, trace_db_call
+00016240: 733d 6e6f 6465 2e74 7261 6365 5f64 625f  s=node.trace_db_
+00016250: 6361 6c6c 7329 0a20 2020 2020 2020 2020  calls).         
+00016260: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00016270: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+00016280: 6f67 2e64 6562 7567 286d 702e 4d45 4d50  og.debug(mp.MEMP
+00016290: 4f4f 4c2e 6d65 7267 6528 6d65 6d70 6f6f  OOL.merge(mempoo
+000162a0: 6c5f 6461 7461 2c20 7065 6572 5f69 702c  l_data, peer_ip,
+000162b0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+000162c0: 616e 6365 2e63 2c20 5472 7565 2c20 5472  ance.c, True, Tr
+000162d0: 7565 2929 0a20 2020 2020 2020 2020 2020  ue)).           
+000162e0: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+000162f0: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00016300: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
+00016310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016320: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+00016330: 6573 742c 2073 7472 2872 656d 6f74 655f  est, str(remote_
+00016340: 7369 676e 6174 7572 655f 656e 6329 290a  signature_enc)).
+00016350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016360: 2020 2020 2020 2020 2320 7769 7065 2076          # wipe v
+00016370: 6172 6961 626c 6573 0a20 2020 2020 2020  ariables.       
+00016380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016390: 2028 7478 5f72 656d 6f74 652c 2072 656d   (tx_remote, rem
+000163a0: 6f74 655f 7478 5f70 7269 766b 6579 2c20  ote_tx_privkey, 
+000163b0: 7478 5f72 656d 6f74 655f 6b65 7929 203d  tx_remote_key) =
+000163c0: 2028 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f   (None, None, No
+000163d0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+000163e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016400: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00016410: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00016420: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
+00016430: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
+00016440: 7478 7365 6e64 2063 6f6d 6d61 6e64 2729  txsend command')
+00016450: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00016460: 2020 2320 6c65 7373 2069 6d70 6f72 7461    # less importa
+00016470: 6e74 206d 6574 686f 6473 0a20 2020 2020  nt methods.     
+00016480: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00016490: 6461 7461 203d 3d20 2761 6464 7661 6c69  data == 'addvali
+000164a0: 6461 7465 273a 0a20 2020 2020 2020 2020  date':.         
+000164b0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000164c0: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
+000164d0: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
+000164e0: 6129 3a0a 0a20 2020 2020 2020 2020 2020  a):..           
+000164f0: 2020 2020 2020 2020 2020 2020 2061 6464               add
+00016500: 7265 7373 5f74 6f5f 7661 6c69 6461 7465  ress_to_validate
+00016510: 203d 2072 6563 6569 7665 2873 656c 662e   = receive(self.
+00016520: 7265 7175 6573 7429 0a20 2020 2020 2020  request).       
+00016530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016540: 2069 6620 6573 7365 6e74 6961 6c73 2e61   if essentials.a
+00016550: 6464 7265 7373 5f76 616c 6964 6174 6528  ddress_validate(
+00016560: 6164 6472 6573 735f 746f 5f76 616c 6964  address_to_valid
+00016570: 6174 6529 3a0a 2020 2020 2020 2020 2020  ate):.          
+00016580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016590: 2020 7265 7375 6c74 203d 2027 7661 6c69    result = 'vali
+000165a0: 6427 0a20 2020 2020 2020 2020 2020 2020  d'.             
+000165b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000165c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000165d0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+000165e0: 756c 7420 3d20 2769 6e76 616c 6964 270a  ult = 'invalid'.
+000165f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016600: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+00016610: 6c66 2e72 6571 7565 7374 2c20 7265 7375  lf.request, resu
+00016620: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+00016630: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00016640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016650: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00016660: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00016670: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
+00016680: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
+00016690: 6164 6476 616c 6964 6174 6520 636f 6d6d  addvalidate comm
+000166a0: 616e 6427 290a 0a20 2020 2020 2020 2020  and')..         
+000166b0: 2020 2020 2020 2065 6c69 6620 6461 7461         elif data
+000166c0: 203d 3d20 2761 6e6e 6765 7427 3a0a 2020   == 'annget':.  
+000166d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166e0: 2020 6966 206e 6f64 652e 7065 6572 732e    if node.peers.
+000166f0: 6973 5f61 6c6c 6f77 6564 2870 6565 725f  is_allowed(peer_
+00016700: 6970 293a 0a0a 2020 2020 2020 2020 2020  ip):..          
+00016710: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016720: 7769 7468 206f 7065 6e28 7065 6572 6c69  with open(peerli
+00016730: 7374 2c20 2272 2229 2061 7320 7065 6572  st, "r") as peer
+00016740: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
+00016750: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00016760: 2020 2020 7065 6572 735f 6669 6c65 203d      peers_file =
+00016770: 2070 6565 725f 6c69 7374 2e72 6561 6428   peer_list.read(
+00016780: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016790: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+000167a0: 646c 6572 5f69 6e73 7461 6e63 6520 3d20  dler_instance = 
+000167b0: 6462 6861 6e64 6c65 722e 4462 4861 6e64  dbhandler.DbHand
+000167c0: 6c65 7228 6e6f 6465 2e69 6e64 6578 5f64  ler(node.index_d
+000167d0: 622c 206e 6f64 652e 6c65 6467 6572 5f70  b, node.ledger_p
+000167e0: 6174 682c 206e 6f64 652e 6879 7065 725f  ath, node.hyper_
+000167f0: 7061 7468 2c20 6e6f 6465 2e72 616d 2c20  path, node.ram, 
+00016800: 6e6f 6465 2e6c 6564 6765 725f 7261 6d5f  node.ledger_ram_
+00016810: 6669 6c65 2c20 6e6f 6465 2e6c 6f67 6765  file, node.logge
+00016820: 722c 2074 7261 6365 5f64 625f 6361 6c6c  r, trace_db_call
+00016830: 733d 6e6f 6465 2e74 7261 6365 5f64 625f  s=node.trace_db_
+00016840: 6361 6c6c 7329 0a20 2020 2020 2020 2020  calls).         
+00016850: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00016860: 6573 756c 7420 3d20 6462 5f68 616e 646c  esult = db_handl
+00016870: 6572 5f69 6e73 7461 6e63 652e 616e 6e67  er_instance.anng
+00016880: 6574 286e 6f64 6529 0a20 2020 2020 2020  et(node).       
+00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168a0: 2064 625f 6861 6e64 6c65 725f 696e 7374   db_handler_inst
+000168b0: 616e 6365 2e63 6c6f 7365 2829 0a0a 2020  ance.close()..  
+000168c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168d0: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+000168e0: 7265 7175 6573 742c 2072 6573 756c 7429  request, result)
+000168f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016900: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016920: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+00016930: 7070 5f6c 6f67 2e64 6562 7567 2866 277b  pp_log.debug(f'{
+00016940: 7065 6572 5f69 707d 206e 6f74 2077 6869  peer_ip} not whi
+00016950: 7465 6c69 7374 6564 2066 6f72 2061 6e6e  telisted for ann
+00016960: 6765 7420 636f 6d6d 616e 6427 290a 0a20  get command').. 
+00016970: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00016980: 6c69 6620 6461 7461 203d 3d20 2761 6e6e  lif data == 'ann
+00016990: 7665 7267 6574 273a 0a20 2020 2020 2020  verget':.       
+000169a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000169b0: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
+000169c0: 6c6f 7765 6428 7065 6572 5f69 7029 3a0a  lowed(peer_ip):.
+000169d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169e0: 2020 2020 2020 2020 6462 5f68 616e 646c          db_handl
+000169f0: 6572 5f69 6e73 7461 6e63 6520 3d20 6462  er_instance = db
+00016a00: 6861 6e64 6c65 722e 4462 4861 6e64 6c65  handler.DbHandle
+00016a10: 7228 6e6f 6465 2e69 6e64 6578 5f64 622c  r(node.index_db,
+00016a20: 206e 6f64 652e 6c65 6467 6572 5f70 6174   node.ledger_pat
+00016a30: 682c 206e 6f64 652e 6879 7065 725f 7061  h, node.hyper_pa
+00016a40: 7468 2c20 6e6f 6465 2e72 616d 2c20 6e6f  th, node.ram, no
+00016a50: 6465 2e6c 6564 6765 725f 7261 6d5f 6669  de.ledger_ram_fi
+00016a60: 6c65 2c20 6e6f 6465 2e6c 6f67 6765 722c  le, node.logger,
+00016a70: 2074 7261 6365 5f64 625f 6361 6c6c 733d   trace_db_calls=
+00016a80: 6e6f 6465 2e74 7261 6365 5f64 625f 6361  node.trace_db_ca
+00016a90: 6c6c 7329 0a20 2020 2020 2020 2020 2020  lls).           
+00016aa0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00016ab0: 756c 7420 3d20 6462 5f68 616e 646c 6572  ult = db_handler
+00016ac0: 5f69 6e73 7461 6e63 652e 616e 6e76 6572  _instance.annver
+00016ad0: 6765 7428 6e6f 6465 290a 2020 2020 2020  get(node).      
+00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016af0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+00016b00: 7461 6e63 652e 636c 6f73 6528 290a 0a20  tance.close().. 
+00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b20: 2020 2020 2020 2073 656e 6428 7365 6c66         send(self
+00016b30: 2e72 6571 7565 7374 2c20 7265 7375 6c74  .request, result
+00016b40: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00016b50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00016b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b70: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+00016b80: 2e61 7070 5f6c 6f67 2e64 6562 7567 2866  .app_log.debug(f
+00016b90: 277b 7065 6572 5f69 707d 206e 6f74 2077  '{peer_ip} not w
+00016ba0: 6869 7465 6c69 7374 6564 2066 6f72 2061  hitelisted for a
+00016bb0: 6e6e 7665 7267 6574 2063 6f6d 6d61 6e64  nnverget command
+00016bc0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00016bd0: 2020 2020 656c 6966 2064 6174 6120 3d3d      elif data ==
+00016be0: 2027 7065 6572 7367 6574 273a 0a20 2020   'peersget':.   
+00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c00: 2069 6620 6e6f 6465 2e70 6565 7273 2e69   if node.peers.i
+00016c10: 735f 616c 6c6f 7765 6428 7065 6572 5f69  s_allowed(peer_i
+00016c20: 702c 2064 6174 6129 3a0a 2020 2020 2020  p, data):.      
+00016c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c40: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+00016c50: 6573 742c 206e 6f64 652e 7065 6572 732e  est, node.peers.
+00016c60: 7065 6572 5f6c 6973 745f 6469 736b 5f66  peer_list_disk_f
+00016c70: 6f72 6d61 7428 2929 0a0a 2020 2020 2020  ormat())..      
+00016c80: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00016c90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00016ca0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00016cb0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+00016cc0: 6465 6275 6728 6627 7b70 6565 725f 6970  debug(f'{peer_ip
+00016cd0: 7d20 6e6f 7420 7768 6974 656c 6973 7465  } not whiteliste
+00016ce0: 6420 666f 7220 7065 6572 7367 6574 2063  d for peersget c
+00016cf0: 6f6d 6d61 6e64 2729 0a0a 2020 2020 2020  ommand')..      
+00016d00: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
+00016d10: 6174 6120 3d3d 2027 7374 6174 7573 6765  ata == 'statusge
+00016d20: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
+00016d30: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+00016d40: 7065 6572 732e 6973 5f61 6c6c 6f77 6564  peers.is_allowed
+00016d50: 2870 6565 725f 6970 2c20 6461 7461 293a  (peer_ip, data):
+00016d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016d70: 2020 2020 2020 2020 206e 6f64 6573 5f63           nodes_c
+00016d80: 6f75 6e74 203d 206e 6f64 652e 7065 6572  ount = node.peer
+00016d90: 732e 636f 6e73 656e 7375 735f 7369 7a65  s.consensus_size
+00016da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016db0: 2020 2020 2020 2020 206e 6f64 6573 5f6c           nodes_l
+00016dc0: 6973 7420 3d20 6e6f 6465 2e70 6565 7273  ist = node.peers
+00016dd0: 2e70 6565 725f 6f70 696e 696f 6e5f 6469  .peer_opinion_di
+00016de0: 6374 0a20 2020 2020 2020 2020 2020 2020  ct.             
+00016df0: 2020 2020 2020 2020 2020 2074 6872 6561             threa
+00016e00: 6473 5f63 6f75 6e74 203d 2074 6872 6561  ds_count = threa
+00016e10: 6469 6e67 2e61 6374 6976 655f 636f 756e  ding.active_coun
+00016e20: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00016e30: 2020 2020 2020 2020 2020 2020 7570 7469              upti
+00016e40: 6d65 203d 2069 6e74 2874 696d 652e 7469  me = int(time.ti
+00016e50: 6d65 2829 202d 206e 6f64 652e 7374 6172  me() - node.star
+00016e60: 7475 705f 7469 6d65 290a 2020 2020 2020  tup_time).      
+00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e80: 2020 6469 6666 203d 206e 6f64 652e 6469    diff = node.di
+00016e90: 6666 6963 756c 7479 0a20 2020 2020 2020  fficulty.       
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016eb0: 2073 6572 7665 725f 7469 6d65 7374 616d   server_timestam
+00016ec0: 7020 3d20 2725 2e32 6627 2025 2074 696d  p = '%.2f' % tim
+00016ed0: 652e 7469 6d65 2829 0a20 2020 2020 2020  e.time().       
+00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ef0: 2069 6620 6e6f 6465 2e72 6576 6561 6c5f   if node.reveal_
+00016f00: 6164 6472 6573 733a 0a20 2020 2020 2020  address:.       
+00016f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f20: 2020 2020 2072 6576 6561 6c65 645f 6164       revealed_ad
+00016f30: 6472 6573 7320 3d20 6e6f 6465 2e6b 6579  dress = node.key
+00016f40: 732e 6164 6472 6573 730a 2020 2020 2020  s.address.      
+00016f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00016f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f80: 2020 2020 7265 7665 616c 6564 5f61 6464      revealed_add
+00016f90: 7265 7373 203d 2027 7072 6976 6174 6527  ress = 'private'
+00016fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fb0: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+00016fc0: 6c66 2e72 6571 7565 7374 2c20 2872 6576  lf.request, (rev
+00016fd0: 6561 6c65 645f 6164 6472 6573 732c 206e  ealed_address, n
+00016fe0: 6f64 6573 5f63 6f75 6e74 2c20 6e6f 6465  odes_count, node
+00016ff0: 735f 6c69 7374 2c20 7468 7265 6164 735f  s_list, threads_
+00017000: 636f 756e 742c 2075 7074 696d 652c 206e  count, uptime, n
+00017010: 6f64 652e 7065 6572 732e 636f 6e73 656e  ode.peers.consen
+00017020: 7375 732c 206e 6f64 652e 7065 6572 732e  sus, node.peers.
+00017030: 636f 6e73 656e 7375 735f 7065 7263 656e  consensus_percen
+00017040: 7461 6765 2c20 5645 5253 494f 4e2c 2064  tage, VERSION, d
+00017050: 6966 662c 2073 6572 7665 725f 7469 6d65  iff, server_time
+00017060: 7374 616d 7029 290a 2020 2020 2020 2020  stamp)).        
+00017070: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00017080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017090: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+000170a0: 6f67 6765 722e 6170 705f 6c6f 672e 6465  ogger.app_log.de
+000170b0: 6275 6728 6627 7b70 6565 725f 6970 7d20  bug(f'{peer_ip} 
+000170c0: 6e6f 7420 7768 6974 656c 6973 7465 6420  not whitelisted 
+000170d0: 666f 7220 7374 6174 7573 6765 7420 636f  for statusget co
+000170e0: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
+000170f0: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
+00017100: 7461 203d 3d20 2773 7461 7475 736a 736f  ta == 'statusjso
+00017110: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
+00017120: 2020 2020 2020 2020 2320 6e6f 7420 6f6e          # not on
+00017130: 6c79 2073 656e 6473 2061 7320 616e 2065  ly sends as an e
+00017140: 7870 6c69 6369 7420 6469 6374 2c20 6275  xplicit dict, bu
+00017150: 7420 616c 736f 2065 6d62 6564 7320 6578  t also embeds ex
+00017160: 7472 6120 696e 666f 0a20 2020 2020 2020  tra info.       
+00017170: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00017180: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
+00017190: 6c6f 7765 6428 7065 6572 5f69 702c 2064  lowed(peer_ip, d
+000171a0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+000171b0: 2020 2020 2020 2020 2020 2020 2020 7570                up
+000171c0: 7469 6d65 203d 2069 6e74 2874 696d 652e  time = int(time.
+000171d0: 7469 6d65 2829 202d 206e 6f64 652e 7374  time() - node.st
+000171e0: 6172 7475 705f 7469 6d65 290a 2020 2020  artup_time).    
+000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017200: 2020 2020 7465 6d70 6469 6666 203d 206e      tempdiff = n
+00017210: 6f64 652e 6469 6666 6963 756c 7479 0a20  ode.difficulty. 
+00017220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017230: 2020 2020 2020 2069 6620 6e6f 6465 2e72         if node.r
+00017240: 6576 6561 6c5f 6164 6472 6573 733a 0a20  eveal_address:. 
+00017250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017260: 2020 2020 2020 2020 2020 2072 6576 6561             revea
+00017270: 6c65 645f 6164 6472 6573 7320 3d20 6e6f  led_address = no
+00017280: 6465 2e6b 6579 732e 6164 6472 6573 730a  de.keys.address.
+00017290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172c0: 2020 2020 2020 2020 2020 7265 7665 616c            reveal
+000172d0: 6564 5f61 6464 7265 7373 203d 2027 7072  ed_address = 'pr
+000172e0: 6976 6174 6527 0a20 2020 2020 2020 2020  ivate'.         
+000172f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017300: 7461 7475 7320 3d20 7b0a 2020 2020 2020  tatus = {.      
+00017310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017320: 2020 2020 2020 2770 726f 746f 636f 6c76        'protocolv
+00017330: 6572 7369 6f6e 273a 206e 6f64 652e 7665  ersion': node.ve
+00017340: 7273 696f 6e2c 0a20 2020 2020 2020 2020  rsion,.         
+00017350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017360: 2020 2027 6164 6472 6573 7327 3a20 7265     'address': re
+00017370: 7665 616c 6564 5f61 6464 7265 7373 2c0a  vealed_address,.
+00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017390: 2020 2020 2020 2020 2020 2020 2777 616c              'wal
+000173a0: 6c65 7476 6572 7369 6f6e 273a 2056 4552  letversion': VER
+000173b0: 5349 4f4e 2c0a 2020 2020 2020 2020 2020  SION,.          
+000173c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173d0: 2020 2774 6573 746e 6574 273a 206e 6f64    'testnet': nod
+000173e0: 652e 6973 5f74 6573 746e 6574 2c0a 2020  e.is_testnet,.  
+000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017400: 2020 2020 2020 2020 2020 2762 6c6f 636b            'block
+00017410: 7327 3a20 6e6f 6465 2e68 6464 5f62 6c6f  s': node.hdd_blo
+00017420: 636b 2c0a 2020 2020 2020 2020 2020 2020  ck,.            
+00017430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017440: 2774 696d 656f 6666 7365 7427 3a20 302c  'timeoffset': 0,
+00017450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017460: 2020 2020 2020 2020 2020 2020 2027 636f               'co
+00017470: 6e6e 6563 7469 6f6e 7327 3a20 6e6f 6465  nnections': node
+00017480: 2e70 6565 7273 2e63 6f6e 7365 6e73 7573  .peers.consensus
+00017490: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
+000174a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174b0: 2020 2027 636f 6e6e 6563 7469 6f6e 735f     'connections_
+000174c0: 6c69 7374 273a 206e 6f64 652e 7065 6572  list': node.peer
+000174d0: 732e 7065 6572 5f6f 7069 6e69 6f6e 5f64  s.peer_opinion_d
+000174e0: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
+000174f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017500: 2027 6469 6666 6963 756c 7479 273a 2074   'difficulty': t
+00017510: 656d 7064 6966 665b 305d 2c0a 2020 2020  empdiff[0],.    
+00017520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017530: 2020 2020 2020 2020 2774 6872 6561 6473          'threads
+00017540: 273a 2074 6872 6561 6469 6e67 2e61 6374  ': threading.act
+00017550: 6976 655f 636f 756e 7428 292c 0a20 2020  ive_count(),.   
+00017560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017570: 2020 2020 2020 2020 2027 7570 7469 6d65           'uptime
+00017580: 273a 2075 7074 696d 652c 0a20 2020 2020  ': uptime,.     
+00017590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175a0: 2020 2020 2020 2027 636f 6e73 656e 7375         'consensu
+000175b0: 7327 3a20 6e6f 6465 2e70 6565 7273 2e63  s': node.peers.c
+000175c0: 6f6e 7365 6e73 7573 2c0a 2020 2020 2020  onsensus,.      
+000175d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175e0: 2020 2020 2020 2763 6f6e 7365 6e73 7573        'consensus
+000175f0: 5f70 6572 6365 6e74 273a 206e 6f64 652e  _percent': node.
+00017600: 7065 6572 732e 636f 6e73 656e 7375 735f  peers.consensus_
+00017610: 7065 7263 656e 7461 6765 2c0a 2020 2020  percentage,.    
+00017620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017630: 2020 2020 2020 2020 2770 7974 686f 6e5f          'python_
+00017640: 7665 7273 696f 6e27 3a20 7374 7228 7665  version': str(ve
+00017650: 7273 696f 6e5f 696e 666f 5b3a 335d 292c  rsion_info[:3]),
+00017660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017670: 2020 2020 2020 2020 2020 2020 2027 6c61               'la
+00017680: 7374 5f62 6c6f 636b 5f61 676f 273a 206e  st_block_ago': n
+00017690: 6f64 652e 6c61 7374 5f62 6c6f 636b 5f61  ode.last_block_a
+000176a0: 676f 2c0a 2020 2020 2020 2020 2020 2020  go,.            
+000176b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176c0: 2773 6572 7665 725f 7469 6d65 7374 616d  'server_timestam
+000176d0: 7027 3a20 2725 2e32 6627 2025 2074 696d  p': '%.2f' % tim
+000176e0: 652e 7469 6d65 2829 2c0a 2020 2020 2020  e.time(),.      
+000176f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017700: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00017710: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00017720: 6f64 652e 6973 5f72 6567 6e65 743a 0a20  ode.is_regnet:. 
+00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017740: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+00017750: 735b 2772 6567 6e65 7427 5d20 3d20 5472  s['regnet'] = Tr
+00017760: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00017770: 2020 2020 2020 2020 2020 2073 656e 6428             send(
+00017780: 7365 6c66 2e72 6571 7565 7374 2c20 7374  self.request, st
+00017790: 6174 7573 290a 2020 2020 2020 2020 2020  atus).          
+000177a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000177b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177c0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+000177d0: 6765 722e 6170 705f 6c6f 672e 6465 6275  ger.app_log.debu
+000177e0: 6728 6627 7b70 6565 725f 6970 7d20 6e6f  g(f'{peer_ip} no
+000177f0: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
+00017800: 7220 7374 6174 7573 6a73 6f6e 2063 6f6d  r statusjson com
+00017810: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
+00017820: 2020 2020 2020 2020 656c 6966 2064 6174          elif dat
+00017830: 6120 3d3d 2027 7478 7365 6172 6368 273a  a == 'txsearch':
+00017840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017850: 2020 2020 2069 6620 6e6f 6465 2e70 6565       if node.pee
+00017860: 7273 2e69 735f 616c 6c6f 7765 6428 7065  rs.is_allowed(pe
+00017870: 6572 5f69 702c 2064 6174 6129 3a0a 2020  er_ip, data):.  
 00017880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017890: 6966 206e 6f64 652e 7472 6163 655f 6462  if node.trace_db
-000178a0: 5f63 616c 6c73 3a0a 2020 2020 2020 2020  _calls:.        
-000178b0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-000178c0: 5f73 6f75 7263 652e 7365 745f 7472 6163  _source.set_trac
-000178d0: 655f 6361 6c6c 6261 636b 2866 756e 6374  e_callback(funct
-000178e0: 6f6f 6c73 2e70 6172 7469 616c 2873 716c  ools.partial(sql
-000178f0: 5f74 7261 6365 5f63 616c 6c62 6163 6b2c  _trace_callback,
-00017900: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-00017910: 5f6c 6f67 2c20 2754 454d 502d 534f 5552  _log, 'TEMP-SOUR
-00017920: 4345 2729 290a 2020 2020 2020 2020 2020  CE')).          
-00017930: 2020 2020 2020 7465 6d70 5f73 6f75 7263        temp_sourc
-00017940: 652e 6261 636b 7570 2874 656d 705f 7461  e.backup(temp_ta
-00017950: 7267 6574 290a 2020 2020 2020 2020 2020  rget).          
-00017960: 2020 2020 2020 7465 6d70 5f73 6f75 7263        temp_sourc
-00017970: 652e 636c 6f73 6528 290a 0a20 2020 2020  e.close()..     
-00017980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00017990: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
-000179a0: 7263 655f 6462 203d 2073 716c 6974 6533  rce_db = sqlite3
-000179b0: 2e63 6f6e 6e65 6374 286e 6f64 652e 6879  .connect(node.hy
-000179c0: 7065 725f 7061 7468 2c20 7469 6d65 6f75  per_path, timeou
-000179d0: 743d 3129 0a20 2020 2020 2020 2020 2020  t=1).           
-000179e0: 2020 2020 2069 6620 6e6f 6465 2e74 7261       if node.tra
-000179f0: 6365 5f64 625f 6361 6c6c 733a 0a20 2020  ce_db_calls:.   
-00017a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a10: 2073 6f75 7263 655f 6462 2e73 6574 5f74   source_db.set_t
-00017a20: 7261 6365 5f63 616c 6c62 6163 6b28 6675  race_callback(fu
-00017a30: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
-00017a40: 7371 6c5f 7472 6163 655f 6361 6c6c 6261  sql_trace_callba
-00017a50: 636b 2c20 6e6f 6465 2e6c 6f67 6765 722e  ck, node.logger.
-00017a60: 6170 705f 6c6f 672c 2027 534f 5552 4345  app_log, 'SOURCE
-00017a70: 2d44 4227 2929 0a20 2020 2020 2020 2020  -DB')).         
-00017a80: 2020 2020 2020 2064 6174 6162 6173 652e         database.
-00017a90: 746f 5f72 616d 203d 2073 716c 6974 6533  to_ram = sqlite3
-00017aa0: 2e63 6f6e 6e65 6374 286e 6f64 652e 6c65  .connect(node.le
-00017ab0: 6467 6572 5f72 616d 5f66 696c 652c 2075  dger_ram_file, u
-00017ac0: 7269 3d54 7275 652c 2074 696d 656f 7574  ri=True, timeout
-00017ad0: 3d31 2c20 6973 6f6c 6174 696f 6e5f 6c65  =1, isolation_le
-00017ae0: 7665 6c3d 4e6f 6e65 290a 2020 2020 2020  vel=None).      
-00017af0: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-00017b00: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
-00017b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017b20: 2020 2020 2020 6461 7461 6261 7365 2e74        database.t
-00017b30: 6f5f 7261 6d2e 7365 745f 7472 6163 655f  o_ram.set_trace_
-00017b40: 6361 6c6c 6261 636b 2866 756e 6374 6f6f  callback(functoo
-00017b50: 6c73 2e70 6172 7469 616c 2873 716c 5f74  ls.partial(sql_t
-00017b60: 7261 6365 5f63 616c 6c62 6163 6b2c 206e  race_callback, n
-00017b70: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-00017b80: 6f67 2c20 2744 4154 4142 4153 452d 544f  og, 'DATABASE-TO
-00017b90: 2d52 414d 2729 290a 2020 2020 2020 2020  -RAM')).        
-00017ba0: 2020 2020 2020 2020 6461 7461 6261 7365          database
-00017bb0: 2e74 6f5f 7261 6d2e 7465 7874 5f66 6163  .to_ram.text_fac
-00017bc0: 746f 7279 203d 2073 7472 0a20 2020 2020  tory = str.     
-00017bd0: 2020 2020 2020 2020 2020 2064 6174 6162             datab
-00017be0: 6173 652e 7472 203d 2064 6174 6162 6173  ase.tr = databas
-00017bf0: 652e 746f 5f72 616d 2e63 7572 736f 7228  e.to_ram.cursor(
-00017c00: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00017c10: 2020 2071 7565 7279 203d 2027 272e 6a6f     query = ''.jo
-00017c20: 696e 286c 696e 6520 666f 7220 6c69 6e65  in(line for line
-00017c30: 2069 6e20 736f 7572 6365 5f64 622e 6974   in source_db.it
-00017c40: 6572 6475 6d70 2829 290a 2020 2020 2020  erdump()).      
-00017c50: 2020 2020 2020 2020 2020 6461 7461 6261            databa
-00017c60: 7365 2e74 6f5f 7261 6d2e 6578 6563 7574  se.to_ram.execut
-00017c70: 6573 6372 6970 7428 7175 6572 7929 0a20  escript(query). 
-00017c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00017c90: 6f75 7263 655f 6462 2e63 6c6f 7365 2829  ource_db.close()
-00017ca0: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
+00017890: 2020 2020 2020 7365 676d 656e 7473 203d        segments =
+000178a0: 2072 6563 6569 7665 2873 656c 662e 7265   receive(self.re
+000178b0: 7175 6573 7429 0a20 2020 2020 2020 2020  quest).         
+000178c0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000178d0: 6c6f 636b 5f68 6569 6768 745f 6672 6f6d  lock_height_from
+000178e0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000178f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017900: 6966 206c 656e 2873 6567 6d65 6e74 7329  if len(segments)
+00017910: 203d 3d20 363a 0a20 2020 2020 2020 2020   == 6:.         
+00017920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017930: 2020 2061 6464 7265 7373 2c20 7265 6369     address, reci
+00017940: 7069 656e 742c 206f 7065 7261 7469 6f6e  pient, operation
+00017950: 2c20 6f70 656e 6669 656c 642c 206c 696d  , openfield, lim
+00017960: 6974 2c20 6f66 6673 6574 203d 2073 6567  it, offset = seg
+00017970: 6d65 6e74 730a 2020 2020 2020 2020 2020  ments.          
+00017980: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00017990: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000179a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179b0: 6164 6472 6573 732c 2072 6563 6970 6965  address, recipie
+000179c0: 6e74 2c20 6f70 6572 6174 696f 6e2c 206f  nt, operation, o
+000179d0: 7065 6e66 6965 6c64 2c20 6c69 6d69 742c  penfield, limit,
+000179e0: 206f 6666 7365 742c 2062 6c6f 636b 5f68   offset, block_h
+000179f0: 6569 6768 745f 6672 6f6d 203d 2073 6567  eight_from = seg
+00017a00: 6d65 6e74 730a 2020 2020 2020 2020 2020  ments.          
+00017a10: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+00017a20: 696c 6520 6e6f 6465 2e64 625f 6c6f 636b  ile node.db_lock
+00017a30: 2e6c 6f63 6b65 6428 293a 0a20 2020 2020  .locked():.     
+00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a50: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+00017a60: 7028 6e6f 6465 2e70 6175 7365 290a 2020  p(node.pause).  
+00017a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a80: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+00017a90: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+00017aa0: 726e 696e 6728 2757 6169 7420 4442 206c  rning('Wait DB l
+00017ab0: 6f63 6b20 746f 2072 756e 2074 7873 6561  ock to run txsea
+00017ac0: 7263 6827 290a 2020 2020 2020 2020 2020  rch').          
+00017ad0: 2020 2020 2020 2020 2020 2020 2020 6462                db
+00017ae0: 5f68 616e 646c 6572 5f69 6e73 7461 6e63  _handler_instanc
+00017af0: 6520 3d20 6462 6861 6e64 6c65 722e 4462  e = dbhandler.Db
+00017b00: 4861 6e64 6c65 7228 6e6f 6465 2e69 6e64  Handler(node.ind
+00017b10: 6578 5f64 622c 206e 6f64 652e 6c65 6467  ex_db, node.ledg
+00017b20: 6572 5f70 6174 682c 206e 6f64 652e 6879  er_path, node.hy
+00017b30: 7065 725f 7061 7468 2c20 6e6f 6465 2e72  per_path, node.r
+00017b40: 616d 2c20 6e6f 6465 2e6c 6564 6765 725f  am, node.ledger_
+00017b50: 7261 6d5f 6669 6c65 2c20 6e6f 6465 2e6c  ram_file, node.l
+00017b60: 6f67 6765 722c 2074 7261 6365 5f64 625f  ogger, trace_db_
+00017b70: 6361 6c6c 733d 6e6f 6465 2e74 7261 6365  calls=node.trace
+00017b80: 5f64 625f 6361 6c6c 7329 0a20 2020 2020  _db_calls).     
+00017b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ba0: 2020 2072 6573 756c 7420 3d20 6462 5f68     result = db_h
+00017bb0: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+00017bc0: 7478 7365 6172 6368 2861 6464 7265 7373  txsearch(address
+00017bd0: 2c20 7265 6369 7069 656e 742c 206f 7065  , recipient, ope
+00017be0: 7261 7469 6f6e 2c20 6f70 656e 6669 656c  ration, openfiel
+00017bf0: 642c 206c 696d 6974 2c20 6f66 6673 6574  d, limit, offset
+00017c00: 2c20 626c 6f63 6b5f 6865 6967 6874 5f66  , block_height_f
+00017c10: 726f 6d29 0a20 2020 2020 2020 2020 2020  rom).           
+00017c20: 2020 2020 2020 2020 2020 2020 2064 625f               db_
+00017c30: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00017c40: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+00017c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c60: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+00017c70: 7374 2c20 7265 7375 6c74 290a 2020 2020  st, result).    
+00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017ca0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
 00017cb0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-00017cc0: 672e 7761 726e 696e 6728 2753 7461 7475  g.warning('Statu
-00017cd0: 733a 2048 7970 6572 626c 6f63 6b20 6c65  s: Hyperblock le
-00017ce0: 6467 6572 206d 6f76 6564 2074 6f20 5241  dger moved to RA
-00017cf0: 4d27 290a 0a20 2020 2020 2020 2020 2020  M')..           
-00017d00: 2023 736f 7572 6365 203d 2073 716c 6974   #source = sqlit
-00017d10: 6533 2e63 6f6e 6e65 6374 2827 6578 6973  e3.connect('exis
-00017d20: 7469 6e67 5f64 622e 6462 2729 0a20 2020  ting_db.db').   
-00017d30: 2020 2020 2020 2020 2023 6465 7374 203d           #dest =
-00017d40: 2073 716c 6974 6533 2e63 6f6e 6e65 6374   sqlite3.connect
-00017d50: 2827 3a6d 656d 6f72 793a 2729 0a20 2020  (':memory:').   
-00017d60: 2020 2020 2020 2020 2023 736f 7572 6365           #source
-00017d70: 2e62 6163 6b75 7028 6465 7374 290a 0a20  .backup(dest).. 
-00017d80: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00017d90: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00017da0: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-00017db0: 705f 6c6f 672e 7761 726e 696e 6728 6529  p_log.warning(e)
-00017dc0: 0a20 2020 2020 2020 2072 6169 7365 0a0a  .        raise..
-00017dd0: 0a64 6566 2069 6e69 7469 616c 5f64 625f  .def initial_db_
-00017de0: 6368 6563 6b28 293a 0a20 2020 2022 2222  check():.    """
-00017df0: 0a20 2020 2049 6e69 7469 616c 2062 6f6f  .    Initial boo
-00017e00: 7473 7472 6170 2063 6865 636b 2061 6e64  tstrap check and
-00017e10: 2063 6861 696e 2076 616c 6964 6974 7920   chain validity 
-00017e20: 636f 6e74 726f 6c0a 2020 2020 2222 220a  control.    """.
-00017e30: 2020 2020 2320 544f 444f 3a20 6361 6e64      # TODO: cand
-00017e40: 6964 6174 6520 666f 7220 7369 6e67 6c65  idate for single
-00017e50: 2075 7365 7220 6d6f 6465 0a20 2020 2023   user mode.    #
-00017e60: 2066 6f72 6365 2062 6f6f 7473 7472 6170   force bootstrap
-00017e70: 2076 6961 2061 6464 696e 6720 616e 2065   via adding an e
-00017e80: 6d70 7479 2022 6672 6573 685f 7379 6e63  mpty "fresh_sync
-00017e90: 2220 6669 6c65 2069 6e20 7468 6520 6469  " file in the di
-00017ea0: 722e 0a20 2020 2069 6620 6f73 2e70 6174  r..    if os.pat
-00017eb0: 682e 6578 6973 7473 2827 6672 6573 685f  h.exists('fresh_
-00017ec0: 7379 6e63 2729 2061 6e64 206e 6f64 652e  sync') and node.
-00017ed0: 6973 5f6d 6169 6e6e 6574 3a0a 2020 2020  is_mainnet:.    
-00017ee0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
-00017ef0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
-00017f00: 2753 7461 7475 733a 2046 7265 7368 2073  'Status: Fresh s
-00017f10: 796e 6320 7265 7175 6972 6564 2c20 626f  ync required, bo
-00017f20: 6f74 7374 7261 7070 696e 6720 6672 6f6d  otstrapping from
-00017f30: 2074 6865 2077 6562 7369 7465 2729 0a20   the website'). 
-00017f40: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
-00017f50: 2827 6672 6573 685f 7379 6e63 2729 0a20  ('fresh_sync'). 
-00017f60: 2020 2020 2020 2062 6f6f 7473 7472 6170         bootstrap
-00017f70: 2829 0a20 2020 2023 2055 5044 4154 4520  ().    # UPDATE 
-00017f80: 6d61 696e 6e65 7420 4442 2069 6620 7265  mainnet DB if re
-00017f90: 7175 6972 6564 0a20 2020 2069 6620 6e6f  quired.    if no
-00017fa0: 6465 2e69 735f 6d61 696e 6e65 743a 0a20  de.is_mainnet:. 
-00017fb0: 2020 2020 2020 2075 7067 7261 6465 203d         upgrade =
-00017fc0: 2073 716c 6974 6533 2e63 6f6e 6e65 6374   sqlite3.connect
-00017fd0: 286e 6f64 652e 6c65 6467 6572 5f70 6174  (node.ledger_pat
-00017fe0: 6829 0a20 2020 2020 2020 2069 6620 6e6f  h).        if no
-00017ff0: 6465 2e74 7261 6365 5f64 625f 6361 6c6c  de.trace_db_call
-00018000: 733a 0a20 2020 2020 2020 2020 2020 2075  s:.            u
-00018010: 7067 7261 6465 2e73 6574 5f74 7261 6365  pgrade.set_trace
-00018020: 5f63 616c 6c62 6163 6b28 6675 6e63 746f  _callback(functo
-00018030: 6f6c 732e 7061 7274 6961 6c28 7371 6c5f  ols.partial(sql_
-00018040: 7472 6163 655f 6361 6c6c 6261 636b 2c20  trace_callback, 
-00018050: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00018060: 6c6f 672c 2027 494e 4954 4941 4c5f 4442  log, 'INITIAL_DB
-00018070: 5f43 4845 434b 2729 290a 2020 2020 2020  _CHECK')).      
-00018080: 2020 7520 3d20 7570 6772 6164 652e 6375    u = upgrade.cu
-00018090: 7273 6f72 2829 0a20 2020 2020 2020 2074  rsor().        t
-000180a0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000180b0: 752e 6578 6563 7574 6528 2750 5241 474d  u.execute('PRAGM
-000180c0: 4120 7461 626c 655f 696e 666f 2874 7261  A table_info(tra
-000180d0: 6e73 6163 7469 6f6e 7329 3b27 290a 2020  nsactions);').  
-000180e0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-000180f0: 203d 2075 2e66 6574 6368 616c 6c28 295b   = u.fetchall()[
-00018100: 3130 5d5b 325d 0a20 2020 2020 2020 2020  10][2].         
-00018110: 2020 2069 6620 7265 7375 6c74 2021 3d20     if result != 
-00018120: 2754 4558 5427 3a0a 2020 2020 2020 2020  'TEXT':.        
-00018130: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00018140: 6c75 6545 7272 6f72 2827 4461 7461 6261  lueError('Databa
-00018150: 7365 2063 6f6c 756d 6e20 7479 7065 206f  se column type o
-00018160: 7574 6461 7465 6420 666f 7220 436f 6d6d  utdated for Comm
-00018170: 616e 6420 6669 656c 6427 290a 2020 2020  and field').    
-00018180: 2020 2020 2020 2020 7570 6772 6164 652e          upgrade.
-00018190: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-000181a0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000181b0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000181c0: 2020 2070 7269 6e74 2865 290a 2020 2020     print(e).    
-000181d0: 2020 2020 2020 2020 7570 6772 6164 652e          upgrade.
-000181e0: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-000181f0: 2020 2020 7072 696e 7428 2744 6174 6162      print('Datab
-00018200: 6173 6520 6e65 6564 7320 7570 6772 6164  ase needs upgrad
-00018210: 696e 672c 2062 6f6f 7473 7472 6170 7069  ing, bootstrappi
-00018220: 6e67 2e2e 2e27 290a 2020 2020 2020 2020  ng...').        
-00018230: 2020 2020 626f 6f74 7374 7261 7028 290a      bootstrap().
-00018240: 0a0a 6465 6620 6c6f 6164 5f6b 6579 7328  ..def load_keys(
-00018250: 293a 0a20 2020 2022 2222 496e 6974 6961  ):.    """Initia
-00018260: 6c20 6c6f 6164 696e 6720 6f66 2063 7279  l loading of cry
-00018270: 7074 6f20 6b65 7973 2222 220a 2020 2020  pto keys""".    
-00018280: 2320 544f 444f 3a20 6361 6e64 6964 6174  # TODO: candidat
-00018290: 6520 666f 7220 7369 6e67 6c65 2075 7365  e for single use
-000182a0: 7220 6d6f 6465 0a20 2020 2065 7373 656e  r mode.    essen
-000182b0: 7469 616c 732e 6b65 7973 5f63 6865 636b  tials.keys_check
-000182c0: 286e 6f64 652e 6c6f 6767 6572 2e61 7070  (node.logger.app
-000182d0: 5f6c 6f67 2c20 2777 616c 6c65 742e 6465  _log, 'wallet.de
-000182e0: 7227 290a 0a20 2020 206e 6f64 652e 6b65  r')..    node.ke
-000182f0: 7973 2e6b 6579 2c20 6e6f 6465 2e6b 6579  ys.key, node.key
-00018300: 732e 7075 626c 6963 5f6b 6579 5f72 6561  s.public_key_rea
-00018310: 6461 626c 652c 206e 6f64 652e 6b65 7973  dable, node.keys
-00018320: 2e70 7269 7661 7465 5f6b 6579 5f72 6561  .private_key_rea
-00018330: 6461 626c 652c 205f 2c20 5f2c 206e 6f64  dable, _, _, nod
-00018340: 652e 6b65 7973 2e70 7562 6c69 635f 6b65  e.keys.public_ke
-00018350: 795f 6236 3465 6e63 6f64 6564 2c20 6e6f  y_b64encoded, no
-00018360: 6465 2e6b 6579 732e 6164 6472 6573 732c  de.keys.address,
-00018370: 206e 6f64 652e 6b65 7973 2e6b 6579 6669   node.keys.keyfi
-00018380: 6c65 203d 2065 7373 656e 7469 616c 732e  le = essentials.
-00018390: 6b65 7973 5f6c 6f61 6428 2770 7269 766b  keys_load('privk
-000183a0: 6579 2e64 6572 272c 2027 7075 626b 6579  ey.der', 'pubkey
-000183b0: 2e64 6572 2729 0a0a 2020 2020 6966 206e  .der')..    if n
-000183c0: 6f64 652e 6973 5f72 6567 6e65 743a 0a20  ode.is_regnet:. 
-000183d0: 2020 2020 2020 2072 6567 6e65 742e 5052         regnet.PR
-000183e0: 4956 4154 455f 4b45 595f 5245 4144 4142  IVATE_KEY_READAB
-000183f0: 4c45 203d 206e 6f64 652e 6b65 7973 2e70  LE = node.keys.p
-00018400: 7269 7661 7465 5f6b 6579 5f72 6561 6461  rivate_key_reada
-00018410: 626c 650a 2020 2020 2020 2020 7265 676e  ble.        regn
-00018420: 6574 2e50 5542 4c49 435f 4b45 595f 4236  et.PUBLIC_KEY_B6
-00018430: 3445 4e43 4f44 4544 203d 206e 6f64 652e  4ENCODED = node.
-00018440: 6b65 7973 2e70 7562 6c69 635f 6b65 795f  keys.public_key_
-00018450: 6236 3465 6e63 6f64 6564 0a20 2020 2020  b64encoded.     
-00018460: 2020 2072 6567 6e65 742e 4144 4452 4553     regnet.ADDRES
-00018470: 5320 3d20 6e6f 6465 2e6b 6579 732e 6164  S = node.keys.ad
-00018480: 6472 6573 730a 2020 2020 2020 2020 7265  dress.        re
-00018490: 676e 6574 2e4b 4559 203d 206e 6f64 652e  gnet.KEY = node.
-000184a0: 6b65 7973 2e6b 6579 0a0a 2020 2020 6e6f  keys.key..    no
-000184b0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-000184c0: 672e 7761 726e 696e 6728 6627 5374 6174  g.warning(f'Stat
-000184d0: 7573 3a20 4c6f 6361 6c20 6164 6472 6573  us: Local addres
-000184e0: 733a 207b 6e6f 6465 2e6b 6579 732e 6164  s: {node.keys.ad
-000184f0: 6472 6573 737d 2729 0a0a 0a64 6566 2076  dress}')...def v
-00018500: 6572 6966 7928 6462 5f68 616e 646c 6572  erify(db_handler
-00018510: 293a 0a20 2020 2023 2054 4f44 4f3a 2063  ):.    # TODO: c
-00018520: 616e 6469 6461 7465 2066 6f72 2073 696e  andidate for sin
-00018530: 676c 6520 7573 6572 206d 6f64 650a 2020  gle user mode.  
-00018540: 2020 7472 793a 0a20 2020 2020 2020 206e    try:.        n
-00018550: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-00018560: 6f67 2e77 6172 6e69 6e67 2827 426c 6f63  og.warning('Bloc
-00018570: 6b63 6861 696e 2076 6572 6966 6963 6174  kchain verificat
-00018580: 696f 6e20 7374 6172 7465 642e 2e2e 2729  ion started...')
-00018590: 0a20 2020 2020 2020 2023 2076 6572 6966  .        # verif
-000185a0: 7920 626c 6f63 6b63 6861 696e 0a20 2020  y blockchain.   
-000185b0: 2020 2020 2064 625f 6861 6e64 6c65 722e       db_handler.
-000185c0: 6578 6563 7574 6528 6462 5f68 616e 646c  execute(db_handl
-000185d0: 6572 2e68 2c20 2753 454c 4543 5420 436f  er.h, 'SELECT Co
-000185e0: 756e 7428 2a29 2046 524f 4d20 7472 616e  unt(*) FROM tran
-000185f0: 7361 6374 696f 6e73 2729 0a20 2020 2020  sactions').     
-00018600: 2020 2064 625f 726f 7773 203d 2064 625f     db_rows = db_
-00018610: 6861 6e64 6c65 722e 682e 6665 7463 686f  handler.h.fetcho
-00018620: 6e65 2829 5b30 5d0a 2020 2020 2020 2020  ne()[0].        
-00018630: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-00018640: 6c6f 672e 7761 726e 696e 6728 2754 6f74  log.warning('Tot
-00018650: 616c 2073 7465 7073 3a20 7b7d 272e 666f  al steps: {}'.fo
-00018660: 726d 6174 2864 625f 726f 7773 2929 0a0a  rmat(db_rows))..
-00018670: 2020 2020 2020 2020 2320 7665 7269 6679          # verify
-00018680: 2067 656e 6573 6973 0a20 2020 2020 2020   genesis.       
-00018690: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000186a0: 2020 6462 5f68 616e 646c 6572 2e65 7865    db_handler.exe
-000186b0: 6375 7465 2864 625f 6861 6e64 6c65 722e  cute(db_handler.
-000186c0: 682c 2027 5345 4c45 4354 2062 6c6f 636b  h, 'SELECT block
-000186d0: 5f68 6569 6768 742c 2072 6563 6970 6965  _height, recipie
-000186e0: 6e74 2046 524f 4d20 7472 616e 7361 6374  nt FROM transact
-000186f0: 696f 6e73 2057 4845 5245 2062 6c6f 636b  ions WHERE block
-00018700: 5f68 6569 6768 7420 3d20 3127 290a 2020  _height = 1').  
-00018710: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00018720: 203d 2064 625f 6861 6e64 6c65 722e 682e   = db_handler.h.
-00018730: 6665 7463 6861 6c6c 2829 5b30 5d0a 2020  fetchall()[0].  
-00018740: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
-00018750: 6865 6967 6874 203d 2072 6573 756c 745b  height = result[
-00018760: 305d 0a20 2020 2020 2020 2020 2020 2067  0].            g
-00018770: 656e 6573 6973 203d 2072 6573 756c 745b  enesis = result[
-00018780: 315d 0a20 2020 2020 2020 2020 2020 206e  1].            n
-00018790: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
-000187a0: 6f67 2e77 6172 6e69 6e67 2866 2747 656e  og.warning(f'Gen
-000187b0: 6573 6973 3a20 7b67 656e 6573 6973 7d27  esis: {genesis}'
-000187c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000187d0: 2073 7472 2867 656e 6573 6973 2920 213d   str(genesis) !=
-000187e0: 206e 6f64 652e 6765 6e65 7369 7320 616e   node.genesis an
-000187f0: 6420 696e 7428 626c 6f63 6b5f 6865 6967  d int(block_heig
-00018800: 6874 2920 3d3d 2030 3a0a 2020 2020 2020  ht) == 0:.      
-00018810: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-00018820: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-00018830: 726e 696e 6728 2749 6e76 616c 6964 2067  rning('Invalid g
-00018840: 656e 6573 6973 2061 6464 7265 7373 2729  enesis address')
-00018850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018860: 2073 7973 2e65 7869 7428 3129 0a20 2020   sys.exit(1).   
-00018870: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00018880: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
-00018890: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
-000188a0: 6e69 6e67 2827 4879 7065 7262 6c6f 636b  ning('Hyperblock
-000188b0: 206d 6f64 6520 696e 2075 7365 2729 0a20   mode in use'). 
-000188c0: 2020 2020 2020 2023 2076 6572 6966 7920         # verify 
-000188d0: 6765 6e65 7369 730a 0a20 2020 2020 2020  genesis..       
-000188e0: 2064 625f 6861 7368 6573 203d 207b 0a20   db_hashes = {. 
-000188f0: 2020 2020 2020 2020 2020 2027 3237 3235             '2725
-00018900: 382d 3134 3933 3735 3533 3735 2e32 3327  8-1493755375.23'
-00018910: 3a20 2761 6364 3630 3434 3539 3163 3562  : 'acd6044591c5b
-00018920: 6166 3132 3165 3538 3132 3235 3732 3466  af121e581225724f
-00018930: 6331 3334 3030 3934 3163 3727 2c0a 2020  c13400941c7',.  
-00018940: 2020 2020 2020 2020 2020 2732 3732 3938            '27298
-00018950: 2d31 3439 3337 3535 3833 302e 3538 273a  -1493755830.58':
-00018960: 2027 3438 3165 6338 3536 6235 3061 3561   '481ec856b50a5a
-00018970: 6534 6635 6239 3664 6536 3061 3865 6461  e4f5b96de60a8eda
-00018980: 3735 6563 6364 3231 3633 272c 0a20 2020  75eccd2163',.   
-00018990: 2020 2020 2020 2020 2027 3330 3434 302d           '30440-
-000189a0: 3134 3933 3736 3831 3233 2e30 3827 3a20  1493768123.08': 
-000189b0: 2765 6431 3162 3234 3533 3064 6263 6338  'ed11b24530dbcc8
-000189c0: 3636 6365 3962 6537 3733 6266 6164 3134  66ce9be773bfad14
-000189d0: 3936 3761 3065 3365 6227 2c0a 2020 2020  967a0e3eb',.    
-000189e0: 2020 2020 2020 2020 2733 3231 3237 2d31          '32127-1
-000189f0: 3439 3337 3735 3135 312e 3932 273a 2027  493775151.92': '
-00018a00: 6535 3934 6430 3461 6439 6535 3534 6263  e594d04ad9e554bc
-00018a10: 6536 3335 3933 6238 3166 3934 3434 3035  e63593b81f944405
-00018a20: 3664 6431 3730 3564 272c 0a20 2020 2020  6dd1705d',.     
-00018a30: 2020 2020 2020 2027 3332 3132 382d 3134         '32128-14
-00018a40: 3933 3737 3531 3730 2e31 3727 3a20 2730  93775170.17': '0
-00018a50: 3761 3863 3439 6430 3065 3730 3366 3165  7a8c49d00e703f1e
-00018a60: 3935 3138 6337 6436 6661 3131 6439 3138  9518c7d6fa11d918
-00018a70: 6435 6139 3033 3627 2c0a 2020 2020 2020  d5a9036',.      
-00018a80: 2020 2020 2020 2733 3737 3332 2d31 3439        '37732-149
-00018a90: 3337 3939 3033 372e 3630 273a 2027 3433  3799037.60': '43
-00018aa0: 6330 3634 3330 3965 6666 3362 3366 3036  c064309eff3b3f06
-00018ab0: 3534 3134 6437 3735 3266 3233 6531 6465  5414d7752f23e1de
-00018ac0: 3165 3730 6364 272c 0a20 2020 2020 2020  1e70cd',.       
-00018ad0: 2020 2020 2027 3337 3839 382d 3134 3933       '37898-1493
-00018ae0: 3739 3933 3137 2e34 3027 3a20 2732 6538  799317.40': '2e8
-00018af0: 3562 3563 3435 3133 6635 6538 6633 6338  5b5c4513f5e8f3c8
-00018b00: 3361 3438 3061 6561 3032 6439 3738 3734  3a480aea02d97874
-00018b10: 3936 6237 6127 2c0a 2020 2020 2020 2020  96b7a',.        
-00018b20: 2020 2020 2733 3738 3938 2d31 3439 3337      '37898-14937
-00018b30: 3939 3737 342e 3436 273a 2027 3465 6138  99774.46': '4ea8
-00018b40: 3939 6233 6264 6439 3433 6139 6631 3634  99b3bdd943a9f164
-00018b50: 3236 3564 3531 6239 3432 3766 3133 3136  265d51b9427f1316
-00018b60: 6365 3339 272c 0a20 2020 2020 2020 2020  ce39',.         
-00018b70: 2020 2027 3338 3038 332d 3134 3933 3830     '38083-149380
-00018b80: 3036 3530 2e36 3727 3a20 2736 3565 3933  0650.67': '65e93
-00018b90: 6161 6231 3439 6337 6537 3765 3338 3365  aab149c7e77e383e
-00018ba0: 3066 3965 6231 6537 6639 6130 3231 3733  0f9eb1e7f9a02173
-00018bb0: 3261 3027 2c0a 2020 2020 2020 2020 2020  2a0',.          
-00018bc0: 2020 2735 3232 3333 2d31 3439 3338 3736    '52233-1493876
-00018bd0: 3930 312e 3733 273a 2027 3239 3635 3366  901.73': '29653f
-00018be0: 6465 6663 3663 6139 3861 6164 6561 6233  defc6ca98aadeab3
-00018bf0: 3738 3834 3338 3366 6564 6639 6530 3331  7884383fedf9e031
-00018c00: 6233 272c 0a20 2020 2020 2020 2020 2020  b3',.           
-00018c10: 2027 3532 3233 392d 3134 3933 3837 3639   '52239-14938769
-00018c20: 3633 2e37 3127 3a20 2734 6330 6532 3632  63.71': '4c0e262
-00018c30: 6465 3634 6135 6537 3932 3630 3139 3337  de64a5e792601937
-00018c40: 6133 3333 6361 3262 6636 6436 3638 3166  a333ca2bf6d6681f
-00018c50: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00018c60: 2735 3232 3832 2d31 3439 3338 3737 3136  '52282-149387716
-00018c70: 392e 3239 273a 2027 3830 3866 3930 3533  9.29': '808f9053
-00018c80: 3465 3762 6136 3865 6536 3062 6232 6561  4e7ba68ee60bb2ea
-00018c90: 3435 3330 6635 6666 3762 3964 3864 6561  4530f5ff7b9d8dea
-00018ca0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00018cb0: 3532 3330 382d 3134 3933 3837 3732 3537  52308-1493877257
-00018cc0: 2e38 3527 3a20 2738 3931 3935 3438 6664  .85': '8919548fd
-00018cd0: 6263 3530 3933 6136 6539 3332 3038 3138  bc5093a6e9320818
-00018ce0: 6130 6361 3035 3834 3439 6532 3963 3227  a0ca058449e29c2'
-00018cf0: 2c0a 2020 2020 2020 2020 2020 2020 2735  ,.            '5
-00018d00: 3233 3933 2d31 3439 3338 3737 3436 332e  2393-1493877463.
-00018d10: 3937 273a 2027 3065 6261 3736 3233 6134  97': '0eba7623a4
-00018d20: 3434 3431 6432 3533 3565 6166 6561 3436  4441d2535eafea46
-00018d30: 3535 6538 6566 3532 3466 3337 3139 272c  55e8ef524f3719',
-00018d40: 0a20 2020 2020 2020 2020 2020 2027 3632  .            '62
-00018d50: 3530 372d 3134 3933 3934 3633 3732 2e35  507-1493946372.5
-00018d60: 3027 3a20 2738 3163 3963 6131 3735 6430  0': '81c9ca175d0
-00018d70: 3966 3437 3439 3761 3537 6566 6562 3531  9f47497a57efeb51
-00018d80: 6431 3665 6537 3864 6463 3233 3227 2c0a  d16ee78ddc232',.
-00018d90: 2020 2020 2020 2020 2020 2020 2737 3030              '700
-00018da0: 3934 2d31 3439 3430 3332 3933 332e 3134  94-1494032933.14
-00018db0: 273a 2027 3263 6134 3430 3333 3837 6538  ': '2ca4403387e8
-00018dc0: 3462 3935 6564 3535 3865 3763 3933 3530  4b95ed558e7c9350
-00018dd0: 6334 3365 6666 6638 3232 3563 272c 0a20  c43efff8225c',. 
-00018de0: 2020 2020 2020 2020 2020 2027 3130 3735             '1075
-00018df0: 3739 2d31 3439 3534 3939 3338 352e 3535  79-1495499385.55
-00018e00: 273a 2027 3463 3031 6434 3931 6233 3535  ': '4c01d491b355
-00018e10: 3833 6536 6138 3830 6130 3136 6264 3038  83e6a880a016bd08
-00018e20: 6163 3939 3262 3235 6539 3436 272c 0a20  ac992b25e946',. 
-00018e30: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018e40: 3332 2d31 3439 3535 3831 3933 342e 3731  32-1495581934.71
-00018e50: 273a 2027 6538 3163 6161 3438 6634 6530  ': 'e81caa48f4e0
-00018e60: 3432 3732 6237 3634 6263 3538 6130 6136  4272b764bc58a0a6
-00018e70: 3865 3037 6534 3465 3530 6265 272c 0a20  8e07e44e50be',. 
-00018e80: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018e90: 3332 2d31 3439 3535 3831 3936 382e 3335  32-1495581968.35
-00018ea0: 273a 2027 3236 3431 3933 3531 6263 3563  ': '26419351bc5c
-00018eb0: 6561 3738 3161 6334 6234 3163 3661 3565  ea781ac4b41c6a5e
-00018ec0: 6137 3537 3538 3564 6462 6534 272c 0a20  a757585ddbe4',. 
-00018ed0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018ee0: 3332 2d31 3439 3535 3831 3939 372e 3734  32-1495581997.74
-00018ef0: 273a 2027 6164 3633 3461 3233 6236 3962  ': 'ad634a23b69b
-00018f00: 3664 3563 6638 3531 3464 3665 3361 3564  6d5cf8514d6e3a5d
-00018f10: 3863 3733 3131 3234 3062 3538 272c 0a20  8c7311240b58',. 
-00018f20: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018f30: 3332 2d31 3439 3535 3832 3035 322e 3339  32-1495582052.39
-00018f40: 273a 2027 3961 3538 3135 6531 6161 6135  ': '9a5815e1aaa5
-00018f50: 3063 3132 3966 6164 3035 6439 3530 3262  0c129fad05d9502b
-00018f60: 3262 3833 3531 3861 6230 6336 272c 0a20  2b83518ab0c6',. 
-00018f70: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018f80: 3332 2d31 3439 3535 3832 3037 332e 3830  32-1495582073.80
-00018f90: 273a 2027 6333 6563 6263 3431 3265 6438  ': 'c3ecbc412ed8
-00018fa0: 3235 3339 6638 3636 6435 6365 3935 6134  2539f866d5ce95a4
-00018fb0: 3664 6638 6631 6262 6339 3932 272c 0a20  6df8f1bbc992',. 
-00018fc0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00018fd0: 3332 2d31 3439 3535 3832 3039 332e 3835  32-1495582093.85
-00018fe0: 273a 2027 6566 6636 3433 3537 6430 3332  ': 'eff64357d032
-00018ff0: 3063 3737 6337 3737 3462 6466 6662 6630  0c77c7774bdffbf0
-00019000: 3033 3262 6662 6263 6634 3061 272c 0a20  032bfbbcf40a',. 
-00019010: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019020: 3332 2d31 3439 3535 3832 3133 372e 3438  32-1495582137.48
-00019030: 273a 2027 6533 6633 3463 3362 3036 3038  ': 'e3f34c3b0608
-00019040: 6132 3237 3663 3364 3137 3966 6532 3039  a2276c3d179fe209
-00019050: 3161 6533 6235 6233 3334 3538 272c 0a20  1ae3b5b33458',. 
-00019060: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019070: 3332 2d31 3439 3535 3832 3136 372e 3831  32-1495582167.81
-00019080: 273a 2027 6464 3963 6632 3433 3636 3732  ': 'dd9cf2436672
-00019090: 6332 6232 6235 6136 6363 3233 3066 6530  c2b2b5a6cc230fe0
-000190a0: 6266 3534 3864 3338 3536 6339 272c 0a20  bf548d3856c9',. 
-000190b0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000190c0: 3332 2d31 3439 3535 3832 3138 382e 3136  32-1495582188.16
-000190d0: 273a 2027 3937 3866 3765 3432 6139 3864  ': '978f7e42a98d
-000190e0: 3030 6464 3062 3532 3066 6133 3330 6165  00dd0b520fa330ae
-000190f0: 6331 3336 3937 3666 3262 3130 272c 0a20  c136976f2b10',. 
-00019100: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019110: 3332 2d31 3439 3535 3832 3231 322e 3439  32-1495582212.49
-00019120: 273a 2027 3739 3931 6432 6566 6564 3663  ': '7991d2efed6c
-00019130: 3231 3530 3964 3130 3463 3462 6239 6134  21509d104c4bb9a4
-00019140: 3164 6238 3733 6131 3836 6266 272c 0a20  1db873a186bf',. 
-00019150: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019160: 3332 2d31 3439 3535 3832 3236 312e 3939  32-1495582261.99
-00019170: 273a 2027 3439 3634 3931 6138 3234 3366  ': '496491a8243f
-00019180: 3932 6566 3231 3662 3330 3861 3462 3865  92ef216b308a4b8e
-00019190: 3136 3066 3961 6338 3930 3266 272c 0a20  160f9ac8902f',. 
-000191a0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000191b0: 3332 2d31 3439 3535 3832 3238 312e 3932  32-1495582281.92
-000191c0: 273a 2027 6333 6562 3735 6630 3939 3534  ': 'c3eb75f09954
-000191d0: 3663 6431 6166 6563 3035 3131 3934 6134  6cd1afec051194a4
-000191e0: 6630 6365 3732 3830 3838 3131 272c 0a20  f0ce72808811',. 
-000191f0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019200: 3332 2d31 3439 3535 3832 3332 362e 3439  32-1495582326.49
-00019210: 273a 2027 6636 6132 6431 3563 3138 3639  ': 'f6a2d15c1869
-00019220: 3263 3135 3037 6132 6630 6633 3166 6239  2c1507a2f0f31fb9
-00019230: 3865 6431 3236 6636 3238 3564 272c 0a20  8ed126f6285d',. 
-00019240: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019250: 3332 2d31 3439 3535 3832 3334 352e 3636  32-1495582345.66
-00019260: 273a 2027 6336 3162 3330 3733 6165 3333  ': 'c61b3073ae33
-00019270: 3435 3134 3635 3839 6566 3331 6135 3635  45146589ef31a565
-00019280: 3837 3466 3335 3036 6161 3362 272c 0a20  874f3506aa3b',. 
-00019290: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000192a0: 3332 2d31 3439 3535 3832 3336 322e 3239  32-1495582362.29
-000192b0: 273a 2027 3931 6630 6332 6562 3763 3764  ': '91f0c2eb7c7d
-000192c0: 3862 6164 6632 3739 3133 3066 3964 3838  8badf279130f9d88
-000192d0: 3130 6333 3162 6361 3037 3338 272c 0a20  10c31bca0738',. 
-000192e0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000192f0: 3332 2d31 3439 3535 3832 3339 312e 3237  32-1495582391.27
-00019300: 273a 2027 3836 6261 3232 6133 3661 6431  ': '86ba22a36ad1
-00019310: 3630 3466 6362 6563 6362 3762 3533 6134  604fcbeccb7b53a4
-00019320: 6631 3837 3865 3432 6537 6338 272c 0a20  f1878e42e7c8',. 
-00019330: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019340: 3332 2d31 3439 3535 3832 3431 342e 3438  32-1495582414.48
-00019350: 273a 2027 3663 3766 6239 3638 6336 6466  ': '6c7fb968c6df
-00019360: 3035 6536 6334 3161 3262 3537 3431 3732  05e6c41a2b574172
-00019370: 3635 6663 6432 3163 6630 3439 272c 0a20  65fcd21cf049',. 
-00019380: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019390: 3332 2d31 3439 3535 3832 3433 312e 3537  32-1495582431.57
-000193a0: 273a 2027 3835 6238 3436 3437 3966 6366  ': '85b846479fcf
-000193b0: 3635 6530 6230 3430 3761 6535 6136 3261  65e0b0407ae5a62a
-000193c0: 3433 6535 3438 6130 3562 3066 272c 0a20  43e548a05b0f',. 
-000193d0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000193e0: 3332 2d31 3439 3535 3832 3435 322e 3930  32-1495582452.90
-000193f0: 273a 2027 6265 3539 3835 3934 3961 3966  ': 'be5985949a9f
-00019400: 3963 3035 6531 3038 3763 3337 3331 3739  9c05e1087c373179
-00019410: 6634 3639 3963 3961 3238 3562 272c 0a20  f4699c9a285b',. 
-00019420: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019430: 3332 2d31 3439 3535 3832 3437 342e 3330  32-1495582474.30
-00019440: 273a 2027 3566 3866 3333 6363 6433 3836  ': '5f8f33ccd386
-00019450: 3164 6261 6633 6139 6465 3637 3962 3263  1dbaf3a9de679b2c
-00019460: 3537 6262 3464 6336 6161 3965 272c 0a20  57bb4dc6aa9e',. 
-00019470: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019480: 3332 2d31 3439 3535 3832 3439 312e 3333  32-1495582491.33
-00019490: 273a 2027 6262 6361 3463 3263 6662 3362  ': 'bbca4c2cfb3b
-000194a0: 3037 3364 6332 3665 3238 3832 6130 6336  073dc26e2882a0c6
-000194b0: 3335 6234 6635 3435 6337 3936 272c 0a20  35b4f545c796',. 
-000194c0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000194d0: 3332 2d31 3439 3535 3832 3531 392e 3636  32-1495582519.66
-000194e0: 273a 2027 6538 6163 6166 3463 3332 3461  ': 'e8acaf4c324a
-000194f0: 6436 3338 3065 3935 6630 3562 3534 3838  d6380e95f05b5488
-00019500: 3530 3763 3166 3637 3766 3064 272c 0a20  507c1f677f0d',. 
-00019510: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019520: 3332 2d31 3439 3535 3832 3535 322e 3333  32-1495582552.33
-00019530: 273a 2027 3164 3139 6566 6265 3734 6631  ': '1d19efbe74f1
-00019540: 6463 6330 6633 6565 6363 3937 6535 3736  dcc0f3eecc97e576
-00019550: 3032 6138 3534 6365 6538 3063 272c 0a20  02a854cee80c',. 
-00019560: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019570: 3332 2d31 3439 3535 3832 3536 362e 3839  32-1495582566.89
-00019580: 273a 2027 3666 3835 3535 3137 6135 6131  ': '6f855517a5a1
-00019590: 3537 3634 3237 3562 3662 3437 3364 6633  5764275b6b473df3
-000195a0: 6438 6230 3432 3465 3134 6361 272c 0a20  d8b0424e14ca',. 
-000195b0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000195c0: 3332 2d31 3439 3535 3832 3537 382e 3036  32-1495582578.06
-000195d0: 273a 2027 3535 6434 6166 3734 3961 6639  ': '55d4af749af9
-000195e0: 3136 6134 6166 3431 3930 3130 3631 3333  16a4af4190106133
-000195f0: 6334 6264 3631 3866 6363 6438 272c 0a20  c4bd618fccd8',. 
-00019600: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019610: 3332 2d31 3439 3535 3832 3539 302e 3237  32-1495582590.27
-00019620: 273a 2027 3331 3230 3039 6566 6137 6438  ': '312009efa7d8
-00019630: 6662 6633 6264 3738 3837 3034 6239 6634  fbf3bd788704b9f4
-00019640: 6639 6634 6363 6132 6266 3662 272c 0a20  f9f4cca2bf6b',. 
-00019650: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019660: 3332 2d31 3439 3535 3832 3630 352e 3738  32-1495582605.78
-00019670: 273a 2027 3932 6464 3135 6139 3365 3566  ': '92dd15a93e5f
-00019680: 6463 3664 3431 3965 3430 6537 3363 3733  dc6d419e40e73c73
-00019690: 3836 3138 3833 3037 3738 6266 272c 0a20  8618830778bf',. 
-000196a0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000196b0: 3332 2d31 3439 3535 3832 3632 392e 3732  32-1495582629.72
-000196c0: 273a 2027 6339 3061 3262 6165 6566 6662  ': 'c90a2baeeffb
-000196d0: 3832 3833 6137 3831 3738 3761 6631 6239  8283a781787af1b9
-000196e0: 6132 6434 6537 3339 3037 3638 272c 0a20  a2d4e7390768',. 
-000196f0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019700: 3332 2d31 3439 3535 3832 3635 302e 3636  32-1495582650.66
-00019710: 273a 2027 3736 3931 3936 3136 6233 6232  ': '76919616b3b2
-00019720: 3661 3133 6662 6663 6364 6231 6636 6137  6a13fbfccdb1f6a7
-00019730: 3034 3738 6563 6339 3966 3562 272c 0a20  0478ecc99f5b',. 
-00019740: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019750: 3332 2d31 3439 3535 3832 3637 332e 3639  32-1495582673.69
-00019760: 273a 2027 3832 3238 6132 3965 6334 3666  ': '8228a29ec46f
-00019770: 3463 3031 3763 3938 3330 3733 6534 6266  4c017c983073e4bf
-00019780: 3532 3330 3664 3330 6132 3065 272c 0a20  52306d30a20e',. 
-00019790: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000197a0: 3332 2d31 3439 3535 3832 3639 322e 3736  32-1495582692.76
-000197b0: 273a 2027 6437 6638 3363 3963 6461 3732  ': 'd7f83c9cda72
-000197c0: 3338 3037 3438 6339 6536 3937 6538 3634  380748c9e697e864
-000197d0: 6536 3466 3337 3162 3063 3837 272c 0a20  e64f371b0c87',. 
-000197e0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000197f0: 3332 2d31 3439 3535 3832 3730 352e 3832  32-1495582705.82
-00019800: 273a 2027 6438 3766 3734 6561 6138 3264  ': 'd87f74eaa82d
-00019810: 3235 3636 3132 3964 3435 6630 3034 3063  2566129d45f0040c
-00019820: 3661 3739 3665 3663 3030 6436 272c 0a20  6a796e6c00d6',. 
-00019830: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019840: 3332 2d31 3439 3535 3832 3731 382e 3735  32-1495582718.75
-00019850: 273a 2027 3431 6534 6236 3539 3565 6363  ': '41e4b6595ecc
-00019860: 3030 3837 6237 6133 3730 6330 3862 3965  0087b7a370c08b9e
-00019870: 3931 3164 6466 3730 3632 3165 272c 0a20  911ddf70621e',. 
-00019880: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019890: 3332 2d31 3439 3535 3832 3733 312e 3233  32-1495582731.23
-000198a0: 273a 2027 3131 6239 3565 3766 3231 3065  ': '11b95e7f210e
-000198b0: 3631 3661 3339 6631 6633 6663 3637 3035  616a39f1f3fc6705
-000198c0: 3566 6564 3334 6430 3664 3538 272c 0a20  5fed34d06d58',. 
-000198d0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000198e0: 3332 2d31 3439 3535 3832 3734 332e 3932  32-1495582743.92
-000198f0: 273a 2027 3131 3862 6361 6632 6134 3036  ': '118bcaf2a406
-00019900: 3462 3634 6431 6634 3861 6161 6532 3338  4b64d1f48aaae238
-00019910: 3261 6439 3530 3530 3237 6134 272c 0a20  2ad9505027a4',. 
-00019920: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019930: 3332 2d31 3439 3535 3832 3735 362e 3932  32-1495582756.92
-00019940: 273a 2027 3637 6138 3165 3034 3065 6266  ': '67a81e040ebf
-00019950: 3235 3730 3234 6235 3662 6639 3964 6535  257024b56bf99de5
-00019960: 3736 3330 3739 6439 6333 3862 272c 0a20  763079d9c38b',. 
-00019970: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019980: 3332 2d31 3439 3535 3832 3736 382e 3037  32-1495582768.07
-00019990: 273a 2027 3061 6662 6364 3131 3162 6564  ': '0afbcd111bed
-000199a0: 6636 3166 3637 6565 3565 6166 6332 6532  f61f67ee5eafc2e2
-000199b0: 3739 3239 3931 3235 3466 3333 272c 0a20  792991254f33',. 
-000199c0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-000199d0: 3332 2d31 3439 3535 3832 3738 302e 3538  32-1495582780.58
-000199e0: 273a 2027 6437 3335 3161 6538 6132 3965  ': 'd7351ae8a29e
-000199f0: 3237 3332 3766 6330 3935 3263 6532 3734  27327fc0952ce274
-00019a00: 3035 6265 3438 3764 3464 6366 272c 0a20  05be487d4dcf',. 
-00019a10: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019a20: 3332 2d31 3439 3535 3832 3739 332e 3736  32-1495582793.76
-00019a30: 273a 2027 3536 6563 6133 3230 3237 3935  ': '56eca3202795
-00019a40: 3434 3336 3639 6233 3561 6631 3863 3331  443669b35af18c31
-00019a50: 3661 3062 6463 3031 3636 6162 272c 0a20  6a0bdc0166ab',. 
-00019a60: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019a70: 3332 2d31 3439 3535 3832 3831 302e 3234  32-1495582810.24
-00019a80: 273a 2027 3438 3431 6633 6630 3163 6439  ': '4841f3f01cd9
-00019a90: 3836 3836 3331 3130 6663 3965 3631 3632  86863110fc9e6162
-00019aa0: 3263 3335 3938 6437 6636 6334 272c 0a20  2c3598d7f6c4',. 
-00019ab0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019ac0: 3332 2d31 3439 3535 3832 3832 332e 3232  32-1495582823.22
-00019ad0: 273a 2027 3761 3432 3434 6530 3534 3966  ': '7a4244e0549f
-00019ae0: 6332 6461 3966 6131 3533 3238 3530 3666  c2da9fa15328506f
-00019af0: 3561 6665 6237 6663 3336 6634 272c 0a20  5afeb7fc36f4',. 
-00019b00: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019b10: 3332 2d31 3439 3535 3832 3833 332e 3839  32-1495582833.89
-00019b20: 273a 2027 3761 6639 6663 3436 6232 6437  ': '7af9fc46b2d7
-00019b30: 3063 3530 3730 3733 3763 3061 3165 6361  0c5070737c0a1eca
-00019b40: 6363 6163 3131 6634 3230 6464 272c 0a20  ccac11f420dd',. 
-00019b50: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019b60: 3332 2d31 3439 3535 3832 3836 302e 3535  32-1495582860.55
-00019b70: 273a 2027 6562 3837 3432 6165 3165 6336  ': 'eb8742ae1ec6
-00019b80: 3439 6530 3162 3563 6135 3036 3464 6135  49e01b5ca5064da5
-00019b90: 3262 3862 6537 3561 3062 6531 272c 0a20  2b8be75a0be1',. 
-00019ba0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019bb0: 3334 2d31 3439 3535 3832 3839 322e 3739  34-1495582892.79
-00019bc0: 273a 2027 6566 3030 3531 3662 3966 3732  ': 'ef00516b9f72
-00019bd0: 3366 6537 6565 6564 3938 3436 3561 3235  3fe7eeed98465a25
-00019be0: 3231 6631 6431 3931 3031 3839 272c 0a20  21f1d1910189',. 
-00019bf0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019c00: 3334 2d31 3439 3535 3832 3930 342e 3035  34-1495582904.05
-00019c10: 273a 2027 3536 3137 3262 3636 3235 6131  ': '56172b6625a1
-00019c20: 3633 6364 3165 3930 6537 3637 3662 3333  63cd1e90e7676b33
-00019c30: 3737 3462 3330 6462 6539 6136 272c 0a20  774b30dbe9a6',. 
-00019c40: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019c50: 3334 2d31 3439 3535 3832 3931 352e 3338  34-1495582915.38
-00019c60: 273a 2027 3930 3239 3064 3533 6666 3866  ': '90290d53ff8f
-00019c70: 3136 6666 6139 6366 3863 6135 6164 6431  16ffa9cf8ca5add1
-00019c80: 6631 3535 3631 3264 6265 6665 272c 0a20  f155612dbefe',. 
-00019c90: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019ca0: 3335 2d31 3439 3535 3832 3932 362e 3938  35-1495582926.98
-00019cb0: 273a 2027 3863 3566 6339 3865 3233 3934  ': '8c5fc98e2394
-00019cc0: 3864 6635 3665 3963 3035 6163 6337 3365  8df56e9c05acc73e
-00019cd0: 3066 3866 3138 6466 3137 3665 272c 0a20  0f8f18df176e',. 
-00019ce0: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019cf0: 3335 2d31 3439 3535 3832 3934 332e 3533  35-1495582943.53
-00019d00: 273a 2027 3863 3665 6365 6363 3038 3362  ': '8c6ececc083b
-00019d10: 3466 6361 6461 6332 3032 3266 3831 3534  4fcadac2022f8154
-00019d20: 3037 6336 3835 6137 6663 6166 272c 0a20  07c685a7fcaf',. 
-00019d30: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019d40: 3335 2d31 3439 3535 3832 3937 362e 3635  35-1495582976.65
-00019d50: 273a 2027 3463 6634 6434 3564 3063 3938  ': '4cf4d45d0c98
-00019d60: 6265 3366 3161 3835 3533 6635 6666 3264  be3f1a8553f5ff2d
-00019d70: 3138 3337 3730 6563 3164 3237 272c 0a20  183770ec1d27',. 
-00019d80: 2020 2020 2020 2020 2020 2027 3130 3930             '1090
-00019d90: 3335 2d31 3439 3535 3833 3332 322e 3134  35-1495583322.14
-00019da0: 273a 2027 3864 3163 3439 6135 6333 6530  ': '8d1c49a5c3e0
-00019db0: 3239 6133 6334 3230 6135 3336 3166 3365  29a3c420a5361f3e
-00019dc0: 6430 6566 3632 3961 3365 3931 272c 0a20  d0ef629a3e91',. 
-00019dd0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00019de0: 2069 6e76 616c 6964 203d 2030 0a0a 2020   invalid = 0..  
-00019df0: 2020 2020 2020 666f 7220 726f 7720 696e        for row in
-00019e00: 2064 625f 6861 6e64 6c65 722e 682e 6578   db_handler.h.ex
-00019e10: 6563 7574 6528 2753 454c 4543 5420 2a20  ecute('SELECT * 
-00019e20: 4652 4f4d 2074 7261 6e73 6163 7469 6f6e  FROM transaction
-00019e30: 7320 5748 4552 4520 626c 6f63 6b5f 6865  s WHERE block_he
-00019e40: 6967 6874 203e 2030 2061 6e64 2072 6577  ight > 0 and rew
-00019e50: 6172 6420 3d20 3020 4f52 4445 5220 4259  ard = 0 ORDER BY
-00019e60: 2062 6c6f 636b 5f68 6569 6768 7427 293a   block_height'):
-00019e70: 2020 2320 6e61 7469 7665 2073 716c 2066    # native sql f
-00019e80: 7820 746f 206b 6565 7020 636f 6d70 6174  x to keep compat
-00019e90: 6962 696c 6974 790a 0a20 2020 2020 2020  ibility..       
-00019ea0: 2020 2020 2064 625f 626c 6f63 6b5f 6865       db_block_he
-00019eb0: 6967 6874 203d 2073 7472 2872 6f77 5b30  ight = str(row[0
-00019ec0: 5d29 0a20 2020 2020 2020 2020 2020 2064  ]).            d
-00019ed0: 625f 7469 6d65 7374 616d 7020 3d20 2725  b_timestamp = '%
-00019ee0: 2e32 6627 2025 2028 7175 616e 7469 7a65  .2f' % (quantize
-00019ef0: 5f74 776f 2872 6f77 5b31 5d29 290a 2020  _two(row[1])).  
-00019f00: 2020 2020 2020 2020 2020 6462 5f61 6464            db_add
-00019f10: 7265 7373 203d 2073 7472 2872 6f77 5b32  ress = str(row[2
-00019f20: 5d29 5b3a 3536 5d0a 2020 2020 2020 2020  ])[:56].        
-00019f30: 2020 2020 6462 5f72 6563 6970 6965 6e74      db_recipient
-00019f40: 203d 2073 7472 2872 6f77 5b33 5d29 5b3a   = str(row[3])[:
-00019f50: 3536 5d0a 2020 2020 2020 2020 2020 2020  56].            
-00019f60: 6462 5f61 6d6f 756e 7420 3d20 2725 2e38  db_amount = '%.8
-00019f70: 6627 2025 2028 7175 616e 7469 7a65 5f65  f' % (quantize_e
-00019f80: 6967 6874 2872 6f77 5b34 5d29 290a 2020  ight(row[4])).  
-00019f90: 2020 2020 2020 2020 2020 6462 5f73 6967            db_sig
-00019fa0: 6e61 7475 7265 5f65 6e63 203d 2073 7472  nature_enc = str
-00019fb0: 2872 6f77 5b35 5d29 5b3a 3638 345d 0a20  (row[5])[:684]. 
-00019fc0: 2020 2020 2020 2020 2020 2064 625f 7075             db_pu
-00019fd0: 626c 6963 5f6b 6579 5f62 3634 656e 636f  blic_key_b64enco
-00019fe0: 6465 6420 3d20 7374 7228 726f 775b 365d  ded = str(row[6]
-00019ff0: 295b 3a31 3036 385d 0a20 2020 2020 2020  )[:1068].       
-0001a000: 2020 2020 2064 625f 6f70 6572 6174 696f       db_operatio
-0001a010: 6e20 3d20 7374 7228 726f 775b 3130 5d29  n = str(row[10])
-0001a020: 5b3a 3330 5d0a 2020 2020 2020 2020 2020  [:30].          
-0001a030: 2020 6462 5f6f 7065 6e66 6965 6c64 203d    db_openfield =
-0001a040: 2073 7472 2872 6f77 5b31 315d 2920 2023   str(row[11])  #
-0001a050: 206e 6f20 6c69 6d69 7420 666f 7220 6261   no limit for ba
-0001a060: 636b 7761 7264 2063 6f6d 7061 7469 6269  ckward compatibi
-0001a070: 6c69 7479 0a20 2020 2020 2020 2020 2020  lity.           
-0001a080: 2064 625f 7472 616e 7361 6374 696f 6e20   db_transaction 
-0001a090: 3d20 7374 7228 2864 625f 7469 6d65 7374  = str((db_timest
-0001a0a0: 616d 702c 2064 625f 6164 6472 6573 732c  amp, db_address,
-0001a0b0: 2064 625f 7265 6369 7069 656e 742c 2064   db_recipient, d
-0001a0c0: 625f 616d 6f75 6e74 2c20 6462 5f6f 7065  b_amount, db_ope
-0001a0d0: 7261 7469 6f6e 2c20 6462 5f6f 7065 6e66  ration, db_openf
-0001a0e0: 6965 6c64 2929 2e65 6e63 6f64 6528 2775  ield)).encode('u
-0001a0f0: 7466 2d38 2729 0a0a 2020 2020 2020 2020  tf-8')..        
-0001a100: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001a110: 2020 2020 2020 2020 2023 2053 6967 6e65           # Signe
-0001a120: 7220 6661 6374 6f72 7920 6973 2061 7761  r factory is awa
-0001a130: 7265 206f 6620 7468 6520 6469 6666 6572  re of the differ
-0001a140: 656e 7420 7478 2073 6368 656d 6573 2c20  ent tx schemes, 
-0001a150: 616e 6420 7769 6c6c 2062 3634 2064 6563  and will b64 dec
-0001a160: 6f64 6520 7075 626c 6963 5f6b 6579 206f  ode public_key o
-0001a170: 6e63 6520 6f72 2074 7769 6365 2061 7320  nce or twice as 
-0001a180: 6e65 6564 6564 2e0a 2020 2020 2020 2020  needed..        
-0001a190: 2020 2020 2020 2020 5369 676e 6572 4661          SignerFa
-0001a1a0: 6374 6f72 792e 7665 7269 6679 5f62 6973  ctory.verify_bis
-0001a1b0: 5f73 6967 6e61 7475 7265 2864 625f 7369  _signature(db_si
-0001a1c0: 676e 6174 7572 655f 656e 632c 2064 625f  gnature_enc, db_
-0001a1d0: 7075 626c 6963 5f6b 6579 5f62 3634 656e  public_key_b64en
-0001a1e0: 636f 6465 642c 2064 625f 7472 616e 7361  coded, db_transa
-0001a1f0: 6374 696f 6e2c 2064 625f 6164 6472 6573  ction, db_addres
-0001a200: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-0001a210: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0001a220: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0001a230: 2020 2020 2020 7368 615f 6861 7368 203d        sha_hash =
-0001a240: 2053 4841 2e6e 6577 2864 625f 7472 616e   SHA.new(db_tran
-0001a250: 7361 6374 696f 6e29 0a20 2020 2020 2020  saction).       
-0001a260: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00017cc0: 672e 6465 6275 6728 6627 7b70 6565 725f  g.debug(f'{peer_
+00017cd0: 6970 7d20 6e6f 7420 7768 6974 656c 6973  ip} not whitelis
+00017ce0: 7465 6420 666f 7220 7478 7365 6172 6368  ted for txsearch
+00017cf0: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
+00017d00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00017d10: 2064 6174 615b 3a34 5d20 3d3d 2027 6170   data[:4] == 'ap
+00017d20: 695f 273a 0a20 2020 2020 2020 2020 2020  i_':.           
+00017d30: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+00017d40: 2e70 6565 7273 2e69 735f 616c 6c6f 7765  .peers.is_allowe
+00017d50: 6428 7065 6572 5f69 702c 2064 6174 6129  d(peer_ip, data)
+00017d60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017d70: 2020 2020 2020 2020 2020 6462 5f68 616e            db_han
+00017d80: 646c 6572 5f69 6e73 7461 6e63 6520 3d20  dler_instance = 
+00017d90: 6462 6861 6e64 6c65 722e 4462 4861 6e64  dbhandler.DbHand
+00017da0: 6c65 7228 6e6f 6465 2e69 6e64 6578 5f64  ler(node.index_d
+00017db0: 622c 206e 6f64 652e 6c65 6467 6572 5f70  b, node.ledger_p
+00017dc0: 6174 682c 206e 6f64 652e 6879 7065 725f  ath, node.hyper_
+00017dd0: 7061 7468 2c20 6e6f 6465 2e72 616d 2c20  path, node.ram, 
+00017de0: 6e6f 6465 2e6c 6564 6765 725f 7261 6d5f  node.ledger_ram_
+00017df0: 6669 6c65 2c20 6e6f 6465 2e6c 6f67 6765  file, node.logge
+00017e00: 722c 2074 7261 6365 5f64 625f 6361 6c6c  r, trace_db_call
+00017e10: 733d 6e6f 6465 2e74 7261 6365 5f64 625f  s=node.trace_db_
+00017e20: 6361 6c6c 7329 0a20 2020 2020 2020 2020  calls).         
+00017e30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00017e40: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00017e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e60: 6e6f 6465 2e61 7069 6861 6e64 6c65 722e  node.apihandler.
+00017e70: 6469 7370 6174 6368 2864 6174 612c 2073  dispatch(data, s
+00017e80: 656c 662e 7265 7175 6573 742c 2064 625f  elf.request, db_
+00017e90: 6861 6e64 6c65 725f 696e 7374 616e 6365  handler_instance
+00017ea0: 2c20 6e6f 6465 2e70 6565 7273 290a 2020  , node.peers).  
+00017eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ec0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00017ed0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00017ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ef0: 2020 2020 2020 2020 206e 6f64 652e 6c6f           node.lo
+00017f00: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
+00017f10: 6e69 6e67 2865 290a 2020 2020 2020 2020  ning(e).        
+00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f30: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00017f40: 6e63 652e 636c 6f73 6528 290a 0a20 2020  nce.close()..   
+00017f50: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00017f60: 6620 6461 7461 203d 3d20 2764 6966 6667  f data == 'diffg
+00017f70: 6574 273a 0a20 2020 2020 2020 2020 2020  et':.           
+00017f80: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+00017f90: 2e70 6565 7273 2e69 735f 616c 6c6f 7765  .peers.is_allowe
+00017fa0: 6428 7065 6572 5f69 702c 2064 6174 6129  d(peer_ip, data)
+00017fb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017fc0: 2020 2020 2020 2020 2020 6469 6666 203d            diff =
+00017fd0: 206e 6f64 652e 6469 6666 6963 756c 7479   node.difficulty
+00017fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017ff0: 2020 2020 2020 2020 2073 656e 6428 7365           send(se
+00018000: 6c66 2e72 6571 7565 7374 2c20 6469 6666  lf.request, diff
+00018010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018020: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00018030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018040: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+00018050: 6170 705f 6c6f 672e 6465 6275 6728 6627  app_log.debug(f'
+00018060: 7b70 6565 725f 6970 7d20 6e6f 7420 7768  {peer_ip} not wh
+00018070: 6974 656c 6973 7465 6420 666f 7220 6469  itelisted for di
+00018080: 6666 6765 7420 636f 6d6d 616e 6427 290a  ffget command').
+00018090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000180a0: 2065 6c69 6620 6461 7461 203d 3d20 2770   elif data == 'p
+000180b0: 6f72 7467 6574 273a 0a20 2020 2020 2020  ortget':.       
+000180c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000180d0: 6e6f 6465 2e70 6565 7273 2e69 735f 616c  node.peers.is_al
+000180e0: 6c6f 7765 6428 7065 6572 5f69 702c 2064  lowed(peer_ip, d
+000180f0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+00018100: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00018110: 6e64 2873 656c 662e 7265 7175 6573 742c  nd(self.request,
+00018120: 207b 2770 6f72 7427 3a20 6e6f 6465 2e70   {'port': node.p
+00018130: 6f72 747d 290a 2020 2020 2020 2020 2020  ort}).          
+00018140: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00018150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018160: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+00018170: 6765 722e 6170 705f 6c6f 672e 6465 6275  ger.app_log.debu
+00018180: 6728 6627 7b70 6565 725f 6970 7d20 6e6f  g(f'{peer_ip} no
+00018190: 7420 7768 6974 656c 6973 7465 6420 666f  t whitelisted fo
+000181a0: 7220 706f 7274 6765 7420 636f 6d6d 616e  r portget comman
+000181b0: 6427 290a 0a20 2020 2020 2020 2020 2020  d')..           
+000181c0: 2020 2020 2065 6c69 6620 6461 7461 203d       elif data =
+000181d0: 3d20 2764 6966 6667 6574 6a73 6f6e 273a  = 'diffgetjson':
+000181e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000181f0: 2020 2020 2069 6620 6e6f 6465 2e70 6565       if node.pee
+00018200: 7273 2e69 735f 616c 6c6f 7765 6428 7065  rs.is_allowed(pe
+00018210: 6572 5f69 702c 2064 6174 6129 3a0a 2020  er_ip, data):.  
+00018220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018230: 2020 2020 2020 6469 6666 203d 206e 6f64        diff = nod
+00018240: 652e 6469 6666 6963 756c 7479 0a20 2020  e.difficulty.   
+00018250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018260: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00018270: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00018280: 2020 2020 2020 2020 2020 2020 2020 2764                'd
+00018290: 6966 6669 6375 6c74 7927 3a20 6469 6666  ifficulty': diff
+000182a0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+000182b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182c0: 2027 6469 6666 5f64 726f 7070 6564 273a   'diff_dropped':
+000182d0: 2064 6966 665b 315d 2c0a 2020 2020 2020   diff[1],.      
+000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182f0: 2020 2020 2020 2774 696d 655f 746f 5f67        'time_to_g
+00018300: 656e 6572 6174 6527 3a20 6469 6666 5b32  enerate': diff[2
+00018310: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00018320: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00018330: 6469 6666 5f62 6c6f 636b 5f70 7265 7669  diff_block_previ
+00018340: 6f75 7327 3a20 6469 6666 5b33 5d2c 0a20  ous': diff[3],. 
+00018350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018360: 2020 2020 2020 2020 2020 2027 626c 6f63             'bloc
+00018370: 6b5f 7469 6d65 273a 2064 6966 665b 345d  k_time': diff[4]
+00018380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018390: 2020 2020 2020 2020 2020 2020 2020 2768                'h
+000183a0: 6173 6872 6174 6527 3a20 6469 6666 5b35  ashrate': diff[5
+000183b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000183c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000183d0: 6469 6666 5f61 646a 7573 746d 656e 7427  diff_adjustment'
+000183e0: 3a20 6469 6666 5b36 5d2c 0a20 2020 2020  : diff[6],.     
+000183f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018400: 2020 2020 2020 2027 626c 6f63 6b5f 6865         'block_he
+00018410: 6967 6874 273a 2064 6966 665b 375d 0a20  ight': diff[7]. 
+00018420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018430: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018450: 2020 7365 6e64 2873 656c 662e 7265 7175    send(self.requ
+00018460: 6573 742c 2072 6573 706f 6e73 6529 0a20  est, response). 
+00018470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018480: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184a0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+000184b0: 5f6c 6f67 2e64 6562 7567 2866 277b 7065  _log.debug(f'{pe
+000184c0: 6572 5f69 707d 206e 6f74 2077 6869 7465  er_ip} not white
+000184d0: 6c69 7374 6564 2066 6f72 2064 6966 6667  listed for diffg
+000184e0: 6574 6a73 6f6e 2063 6f6d 6d61 6e64 2729  etjson command')
+000184f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018500: 2020 656c 6966 2064 6174 6120 3d3d 2027    elif data == '
+00018510: 6469 6666 6c61 7374 273a 0a20 2020 2020  difflast':.     
+00018520: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018530: 6620 6e6f 6465 2e70 6565 7273 2e69 735f  f node.peers.is_
+00018540: 616c 6c6f 7765 6428 7065 6572 5f69 702c  allowed(peer_ip,
+00018550: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
+00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018570: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00018580: 6e63 6520 3d20 6462 6861 6e64 6c65 722e  nce = dbhandler.
+00018590: 4462 4861 6e64 6c65 7228 6e6f 6465 2e69  DbHandler(node.i
+000185a0: 6e64 6578 5f64 622c 206e 6f64 652e 6c65  ndex_db, node.le
+000185b0: 6467 6572 5f70 6174 682c 206e 6f64 652e  dger_path, node.
+000185c0: 6879 7065 725f 7061 7468 2c20 6e6f 6465  hyper_path, node
+000185d0: 2e72 616d 2c20 6e6f 6465 2e6c 6564 6765  .ram, node.ledge
+000185e0: 725f 7261 6d5f 6669 6c65 2c20 6e6f 6465  r_ram_file, node
+000185f0: 2e6c 6f67 6765 722c 2074 7261 6365 5f64  .logger, trace_d
+00018600: 625f 6361 6c6c 733d 6e6f 6465 2e74 7261  b_calls=node.tra
+00018610: 6365 5f64 625f 6361 6c6c 7329 0a20 2020  ce_db_calls).   
+00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018630: 2020 2020 2064 6966 666c 6173 7420 3d20       difflast = 
+00018640: 6462 5f68 616e 646c 6572 5f69 6e73 7461  db_handler_insta
+00018650: 6e63 652e 6469 6666 6c61 7374 2829 0a20  nce.difflast(). 
+00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018670: 2020 2020 2020 2064 625f 6861 6e64 6c65         db_handle
+00018680: 725f 696e 7374 616e 6365 2e63 6c6f 7365  r_instance.close
+00018690: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+000186a0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+000186b0: 2873 656c 662e 7265 7175 6573 742c 2064  (self.request, d
+000186c0: 6966 666c 6173 7429 0a20 2020 2020 2020  ifflast).       
+000186d0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000186e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000186f0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+00018700: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e64  logger.app_log.d
+00018710: 6562 7567 2827 667b 7065 6572 5f69 707d  ebug('f{peer_ip}
+00018720: 206e 6f74 2077 6869 7465 6c69 7374 6564   not whitelisted
+00018730: 2066 6f72 2064 6966 666c 6173 7420 636f   for difflast co
+00018740: 6d6d 616e 6427 290a 0a20 2020 2020 2020  mmand')..       
+00018750: 2020 2020 2020 2020 2065 6c69 6620 6461           elif da
+00018760: 7461 203d 3d20 2764 6966 666c 6173 746a  ta == 'difflastj
+00018770: 736f 6e27 3a0a 2020 2020 2020 2020 2020  son':.          
+00018780: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
+00018790: 652e 7065 6572 732e 6973 5f61 6c6c 6f77  e.peers.is_allow
+000187a0: 6564 2870 6565 725f 6970 2c20 6461 7461  ed(peer_ip, data
+000187b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000187c0: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+000187d0: 6e64 6c65 725f 696e 7374 616e 6365 203d  ndler_instance =
+000187e0: 2064 6268 616e 646c 6572 2e44 6248 616e   dbhandler.DbHan
+000187f0: 646c 6572 286e 6f64 652e 696e 6465 785f  dler(node.index_
+00018800: 6462 2c20 6e6f 6465 2e6c 6564 6765 725f  db, node.ledger_
+00018810: 7061 7468 2c20 6e6f 6465 2e68 7970 6572  path, node.hyper
+00018820: 5f70 6174 682c 206e 6f64 652e 7261 6d2c  _path, node.ram,
+00018830: 206e 6f64 652e 6c65 6467 6572 5f72 616d   node.ledger_ram
+00018840: 5f66 696c 652c 206e 6f64 652e 6c6f 6767  _file, node.logg
+00018850: 6572 2c20 7472 6163 655f 6462 5f63 616c  er, trace_db_cal
+00018860: 6c73 3d6e 6f64 652e 7472 6163 655f 6462  ls=node.trace_db
+00018870: 5f63 616c 6c73 290a 2020 2020 2020 2020  _calls).        
+00018880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018890: 6469 6666 6c61 7374 203d 2064 625f 6861  difflast = db_ha
+000188a0: 6e64 6c65 725f 696e 7374 616e 6365 2e64  ndler_instance.d
+000188b0: 6966 666c 6173 7428 290a 2020 2020 2020  ifflast().      
+000188c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188d0: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+000188e0: 7461 6e63 652e 636c 6f73 6528 290a 2020  tance.close().  
+000188f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018900: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00018910: 207b 2762 6c6f 636b 273a 2064 6966 666c   {'block': diffl
+00018920: 6173 745b 305d 2c20 2764 6966 6669 6375  ast[0], 'difficu
+00018930: 6c74 7927 3a20 6469 6666 6c61 7374 5b31  lty': difflast[1
+00018940: 5d7d 0a0a 2020 2020 2020 2020 2020 2020  ]}..            
+00018950: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+00018960: 2873 656c 662e 7265 7175 6573 742c 2072  (self.request, r
+00018970: 6573 706f 6e73 6529 0a20 2020 2020 2020  esponse).       
+00018980: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00018990: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000189a0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+000189b0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e64  logger.app_log.d
+000189c0: 6562 7567 2866 277b 7065 6572 5f69 707d  ebug(f'{peer_ip}
+000189d0: 206e 6f74 2077 6869 7465 6c69 7374 6564   not whitelisted
+000189e0: 2066 6f72 2064 6966 666c 6173 746a 736f   for difflastjso
+000189f0: 6e20 636f 6d6d 616e 6427 290a 0a20 2020  n command')..   
+00018a00: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00018a10: 6620 6461 7461 203d 3d20 2773 746f 7027  f data == 'stop'
+00018a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018a30: 2020 2020 2020 6966 206e 6f64 652e 7065        if node.pe
+00018a40: 6572 732e 6973 5f61 6c6c 6f77 6564 2870  ers.is_allowed(p
+00018a50: 6565 725f 6970 2c20 6461 7461 293a 0a20  eer_ip, data):. 
+00018a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a70: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+00018a80: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
+00018a90: 6e67 2866 2752 6563 6569 7665 6420 7374  ng(f'Received st
+00018aa0: 6f70 2066 726f 6d20 7b70 6565 725f 6970  op from {peer_ip
+00018ab0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00018ac0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00018ad0: 2e49 535f 5354 4f50 5049 4e47 203d 2054  .IS_STOPPING = T
+00018ae0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00018af0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00018b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b10: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+00018b20: 722e 6170 705f 6c6f 672e 6465 6275 6728  r.app_log.debug(
+00018b30: 6627 7b70 6565 725f 6970 7d20 6e6f 7420  f'{peer_ip} not 
+00018b40: 7768 6974 656c 6973 7465 6420 666f 7220  whitelisted for 
+00018b50: 7374 6f70 2063 6f6d 6d61 6e64 2729 0a0a  stop command')..
+00018b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b70: 656c 6966 2064 6174 6120 3d3d 2027 626c  elif data == 'bl
+00018b80: 6f63 6b5f 6865 6967 6874 5f66 726f 6d5f  ock_height_from_
+00018b90: 6861 7368 273a 0a20 2020 2020 2020 2020  hash':.         
+00018ba0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00018bb0: 6465 2e70 6565 7273 2e69 735f 616c 6c6f  de.peers.is_allo
+00018bc0: 7765 6428 7065 6572 5f69 702c 2064 6174  wed(peer_ip, dat
+00018bd0: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
+00018be0: 2020 2020 2020 2020 2020 2020 5f68 6173              _has
+00018bf0: 6820 3d20 7265 6365 6976 6528 7365 6c66  h = receive(self
+00018c00: 2e72 6571 7565 7374 290a 2020 2020 2020  .request).      
+00018c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c20: 2020 6462 5f68 616e 646c 6572 5f69 6e73    db_handler_ins
+00018c30: 7461 6e63 6520 3d20 6462 6861 6e64 6c65  tance = dbhandle
+00018c40: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+00018c50: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+00018c60: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+00018c70: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+00018c80: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+00018c90: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+00018ca0: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+00018cb0: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+00018cc0: 7261 6365 5f64 625f 6361 6c6c 7329 0a20  race_db_calls). 
+00018cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ce0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00018cf0: 3d20 6462 5f68 616e 646c 6572 5f69 6e73  = db_handler_ins
+00018d00: 7461 6e63 652e 626c 6f63 6b5f 6865 6967  tance.block_heig
+00018d10: 6874 5f66 726f 6d5f 6861 7368 285f 6861  ht_from_hash(_ha
+00018d20: 7368 290a 2020 2020 2020 2020 2020 2020  sh).            
+00018d30: 2020 2020 2020 2020 2020 2020 6462 5f68              db_h
+00018d40: 616e 646c 6572 5f69 6e73 7461 6e63 652e  andler_instance.
+00018d50: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d70: 2073 656e 6428 7365 6c66 2e72 6571 7565   send(self.reque
+00018d80: 7374 2c20 7265 7370 6f6e 7365 290a 2020  st, response).  
+00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018da0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018dc0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+00018dd0: 6c6f 672e 6465 6275 6728 6627 7b70 6565  log.debug(f'{pee
+00018de0: 725f 6970 7d20 6e6f 7420 7768 6974 656c  r_ip} not whitel
+00018df0: 6973 7465 6420 666f 7220 626c 6f63 6b5f  isted for block_
+00018e00: 6865 6967 6874 5f66 726f 6d5f 6861 7368  height_from_hash
+00018e10: 2063 6f6d 6d61 6e64 2729 0a0a 2020 2020   command')..    
+00018e20: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00018e30: 2064 6174 6120 3d3d 2027 6164 6470 6565   data == 'addpee
+00018e40: 7273 273a 0a20 2020 2020 2020 2020 2020  rs':.           
+00018e50: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+00018e60: 2e70 6565 7273 2e69 735f 616c 6c6f 7765  .peers.is_allowe
+00018e70: 6428 7065 6572 5f69 702c 2064 6174 6129  d(peer_ip, data)
+00018e80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018e90: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00018ea0: 2072 6563 6569 7665 2873 656c 662e 7265   receive(self.re
+00018eb0: 7175 6573 7429 0a20 2020 2020 2020 2020  quest).         
+00018ec0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018ed0: 2070 6565 7273 796e 6320 6578 7065 6374   peersync expect
+00018ee0: 7320 6120 6469 6374 2065 6e63 6f64 6564  s a dict encoded
+00018ef0: 2061 7320 6a73 6f6e 2073 7472 696e 672c   as json string,
+00018f00: 206e 6f74 2061 2073 7472 6169 6768 7420   not a straight 
+00018f10: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
+00018f20: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00018f30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018f40: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00018f50: 7320 3d20 6e6f 6465 2e70 6565 7273 2e70  s = node.peers.p
+00018f60: 6565 7273 796e 6328 6461 7461 290a 2020  eersync(data).  
+00018f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f80: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+00018f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018fa0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+00018fb0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+00018fc0: 726e 696e 6728 6627 7b70 6565 725f 6970  rning(f'{peer_ip
+00018fd0: 7d20 7365 6e74 2069 6e76 616c 6964 2070  } sent invalid p
+00018fe0: 6565 7273 206c 6973 7427 290a 2020 2020  eers list').    
+00018ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019000: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+00019010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019020: 2020 2020 2020 7365 6e64 2873 656c 662e        send(self.
+00019030: 7265 7175 6573 742c 207b 2761 6464 6564  request, {'added
+00019040: 273a 2072 6573 7d29 0a20 2020 2020 2020  ': res}).       
+00019050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019060: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+00019070: 5f6c 6f67 2e77 6172 6e69 6e67 2866 277b  _log.warning(f'{
+00019080: 7265 737d 2070 6565 7273 2061 6464 6564  res} peers added
+00019090: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000190a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000190b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190c0: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
+000190d0: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+000190e0: 2866 277b 7065 6572 5f69 707d 206e 6f74  (f'{peer_ip} not
+000190f0: 2077 6869 7465 6c69 7374 6564 2066 6f72   whitelisted for
+00019100: 2061 6464 7065 6572 7327 290a 0a20 2020   addpeers')..   
+00019110: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00019120: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00019130: 2020 2020 2020 2069 6620 6461 7461 203d         if data =
+00019140: 3d20 272a 273a 0a20 2020 2020 2020 2020  = '*':.         
+00019150: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00019160: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00019170: 2742 726f 6b65 6e20 7069 7065 2729 0a0a  'Broken pipe')..
+00019180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019190: 2020 2020 2320 5468 6973 2069 7320 7468      # This is th
+000191a0: 6520 656e 7472 7920 706f 696e 7420 666f  e entry point fo
+000191b0: 7220 616c 6c20 6578 7472 6120 636f 6d6d  r all extra comm
+000191c0: 616e 6473 2066 726f 6d20 706c 7567 696e  ands from plugin
+000191d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000191e0: 2020 2020 2020 666f 7220 7072 6566 6978        for prefix
+000191f0: 2c20 6361 6c6c 6261 636b 2069 6e20 6578  , callback in ex
+00019200: 7472 615f 636f 6d6d 616e 6473 2e69 7465  tra_commands.ite
+00019210: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00019220: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019230: 2064 6174 612e 7374 6172 7473 7769 7468   data.startswith
+00019240: 2870 7265 6669 7829 3a0a 2020 2020 2020  (prefix):.      
+00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019260: 2020 2020 2020 6578 7472 6120 3d20 5472        extra = Tr
+00019270: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00019280: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019290: 616c 6c62 6163 6b28 6461 7461 2c20 7365  allback(data, se
+000192a0: 6c66 2e72 6571 7565 7374 290a 0a20 2020  lf.request)..   
+000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192c0: 2069 6620 6e6f 7420 6578 7472 613a 0a20   if not extra:. 
+000192d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000192f0: 7565 4572 726f 7228 2755 6e65 7870 6563  ueError('Unexpec
+00019300: 7465 6420 6572 726f 722c 2072 6563 6569  ted error, recei
+00019310: 7665 643a 2027 202b 2073 7472 2864 6174  ved: ' + str(dat
+00019320: 6129 5b3a 3332 5d20 2b20 2720 2e2e 2e27  a)[:32] + ' ...'
+00019330: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00019340: 2020 2069 6620 6e6f 7420 7469 6d65 2e74     if not time.t
+00019350: 696d 6528 2920 3c3d 2074 696d 6572 5f6f  ime() <= timer_o
+00019360: 7065 7261 7469 6f6e 202b 2074 696d 656f  peration + timeo
+00019370: 7574 5f6f 7065 7261 7469 6f6e 3a0a 2020  ut_operation:.  
+00019380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019390: 2020 7469 6d65 725f 6f70 6572 6174 696f    timer_operatio
+000193a0: 6e20 3d20 7469 6d65 2e74 696d 6528 2920  n = time.time() 
+000193b0: 2023 2072 6573 6574 2074 696d 6572 0a20   # reset timer. 
+000193c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000193d0: 2074 696d 652e 736c 6565 7028 666c 6f61   time.sleep(floa
+000193e0: 7428 6e6f 6465 2e70 6175 7365 2929 2020  t(node.pause))  
+000193f0: 2320 7072 6576 656e 7420 6370 7520 6f76  # prevent cpu ov
+00019400: 6572 6c6f 6164 0a20 2020 2020 2020 2020  erload.         
+00019410: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+00019420: 6572 2e61 7070 5f6c 6f67 2e64 6562 7567  er.app_log.debug
+00019430: 2866 2753 6572 7665 7220 6c6f 6f70 2066  (f'Server loop f
+00019440: 696e 6973 6865 6420 666f 7220 7b70 6565  inished for {pee
+00019450: 725f 6970 7d27 290a 0a20 2020 2020 2020  r_ip}')..       
+00019460: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00019470: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00019480: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00019490: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+000194a0: 6465 6275 6728 6627 496e 626f 756e 643a  debug(f'Inbound:
+000194b0: 204c 6f73 7420 636f 6e6e 6563 7469 6f6e   Lost connection
+000194c0: 2074 6f20 7b70 6565 725f 6970 7d20 6265   to {peer_ip} be
+000194d0: 6361 7573 6520 6f66 207b 657d 2729 0a20  cause of {e}'). 
+000194e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000194f0: 6620 6462 5f68 616e 646c 6572 5f69 6e73  f db_handler_ins
+00019500: 7461 6e63 653a 0a20 2020 2020 2020 2020  tance:.         
+00019510: 2020 2020 2020 2020 2020 2064 625f 6861             db_ha
+00019520: 6e64 6c65 725f 696e 7374 616e 6365 2e63  ndler_instance.c
+00019530: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
+00019540: 2020 2020 2020 2020 2320 7265 6d6f 7665          # remove
+00019550: 2066 726f 6d20 636f 6e73 656e 7375 7320   from consensus 
+00019560: 2863 6f6e 6e65 6374 696f 6e20 6672 6f6d  (connection from
+00019570: 2074 6865 6d29 0a20 2020 2020 2020 2020   them).         
+00019580: 2020 2020 2020 206e 6f64 652e 7065 6572         node.peer
+00019590: 732e 636f 6e73 656e 7375 735f 7265 6d6f  s.consensus_remo
+000195a0: 7665 2870 6565 725f 6970 290a 2020 2020  ve(peer_ip).    
+000195b0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+000195c0: 6d6f 7665 2066 726f 6d20 636f 6e73 656e  move from consen
+000195d0: 7375 7320 2863 6f6e 6e65 6374 696f 6e20  sus (connection 
+000195e0: 6672 6f6d 2074 6865 6d29 0a20 2020 2020  from them).     
+000195f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019600: 7265 7175 6573 742e 636c 6f73 6528 290a  request.close().
+00019610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019620: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+00019630: 2069 6620 6e6f 7420 6e6f 6465 2e70 6565   if not node.pee
+00019640: 7273 2e76 6572 7369 6f6e 5f61 6c6c 6f77  rs.version_allow
+00019650: 6564 2870 6565 725f 6970 2c20 6e6f 6465  ed(peer_ip, node
+00019660: 2e76 6572 7369 6f6e 5f61 6c6c 6f77 293a  .version_allow):
+00019670: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00019680: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+00019690: 2e77 6172 6e69 6e67 2866 2749 6e62 6f75  .warning(f'Inbou
+000196a0: 6e64 3a20 436c 6f73 696e 6720 636f 6e6e  nd: Closing conn
+000196b0: 6563 7469 6f6e 2074 6f20 6f6c 6420 7b70  ection to old {p
+000196c0: 6565 725f 6970 7d20 6e6f 6465 3a20 7b6e  eer_ip} node: {n
+000196d0: 6f64 652e 7065 6572 732e 6970 5f74 6f5f  ode.peers.ip_to_
+000196e0: 6d61 696e 6e65 745b 7065 6572 5f69 705d  mainnet[peer_ip]
+000196f0: 7d27 290a 0a20 2020 2020 2020 2023 2064  }')..        # d
+00019700: 625f 6861 6e64 6c65 725f 696e 7374 616e  b_handler_instan
+00019710: 6365 2e63 6c6f 7365 2829 0a0a 2020 2020  ce.close()..    
+00019720: 2020 2020 232d 2d2d 2068 616e 646c 6520      #--- handle 
+00019730: 656e 640a 2020 2020 2020 2020 7265 7475  end.        retu
+00019740: 726e 0a0a 0a63 6c61 7373 2054 6872 6561  rn...class Threa
+00019750: 6465 6454 4350 5365 7276 6572 2873 6f63  dedTCPServer(soc
+00019760: 6b65 7473 6572 7665 722e 5468 7265 6164  ketserver.Thread
+00019770: 696e 674d 6978 496e 2c20 736f 636b 6574  ingMixIn, socket
+00019780: 7365 7276 6572 2e54 4350 5365 7276 6572  server.TCPServer
+00019790: 293a 0a20 2020 2070 6173 730a 0a0a 6465  ):.    pass...de
+000197a0: 6620 6a75 7374 5f69 6e74 5f66 726f 6d28  f just_int_from(
+000197b0: 7329 3a0a 2020 2020 23c2 a054 4f44 4f3a  s):.    #..TODO:
+000197c0: 206d 6f76 6520 746f 2065 7373 656e 7469   move to essenti
+000197d0: 616c 732e 7079 0a20 2020 2072 6574 7572  als.py.    retur
+000197e0: 6e20 696e 7428 2727 2e6a 6f69 6e28 6920  n int(''.join(i 
+000197f0: 666f 7220 6920 696e 2073 2069 6620 692e  for i in s if i.
+00019800: 6973 6469 6769 7428 2929 290a 0a0a 6465  isdigit()))...de
+00019810: 6620 7365 7475 705f 6e65 745f 7479 7065  f setup_net_type
+00019820: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
+00019830: 4164 6a75 7374 2067 6c6f 6261 6c73 2064  Adjust globals d
+00019840: 6570 656e 6469 6e67 206f 6e20 6d61 696e  epending on main
+00019850: 6e65 742c 2074 6573 746e 6574 206f 7220  net, testnet or 
+00019860: 7265 676e 6574 0a20 2020 2022 2222 0a20  regnet.    """. 
+00019870: 2020 2023 2054 4f44 4f3a 206f 6e6c 7920     # TODO: only 
+00019880: 6465 616c 7320 7769 7468 2027 6e6f 6465  deals with 'node
+00019890: 2720 7374 7275 6374 7572 652c 2063 616e  ' structure, can
+000198a0: 6469 6461 7465 2066 6f72 2073 696e 676c  didate for singl
+000198b0: 6520 7573 6572 206d 6f64 652e 0a20 2020  e user mode..   
+000198c0: 2023 2044 6566 6175 6c74 7320 7661 6c75   # Defaults valu
+000198d0: 652c 2064 7570 2764 2068 6572 6520 666f  e, dup'd here fo
+000198e0: 7220 636c 6172 6974 7920 7361 6b65 2e0a  r clarity sake..
+000198f0: 2020 2020 6e6f 6465 2e69 735f 6d61 696e      node.is_main
+00019900: 6e65 7420 3d20 5472 7565 0a20 2020 206e  net = True.    n
+00019910: 6f64 652e 6973 5f74 6573 746e 6574 203d  ode.is_testnet =
+00019920: 2046 616c 7365 0a20 2020 206e 6f64 652e   False.    node.
+00019930: 6973 5f72 6567 6e65 7420 3d20 4661 6c73  is_regnet = Fals
+00019940: 650a 0a20 2020 2069 6620 2774 6573 746e  e..    if 'testn
+00019950: 6574 2720 696e 206e 6f64 652e 7665 7273  et' in node.vers
+00019960: 696f 6e20 6f72 206e 6f64 652e 6973 5f74  ion or node.is_t
+00019970: 6573 746e 6574 3a0a 2020 2020 2020 2020  estnet:.        
+00019980: 6e6f 6465 2e69 735f 7465 7374 6e65 7420  node.is_testnet 
+00019990: 3d20 5472 7565 0a20 2020 2020 2020 206e  = True.        n
+000199a0: 6f64 652e 6973 5f6d 6169 6e6e 6574 203d  ode.is_mainnet =
+000199b0: 2046 616c 7365 0a20 2020 2020 2020 206e   False.        n
+000199c0: 6f64 652e 7665 7273 696f 6e5f 616c 6c6f  ode.version_allo
+000199d0: 7720 3d20 2774 6573 746e 6574 270a 0a20  w = 'testnet'.. 
+000199e0: 2020 2069 6620 2772 6567 6e65 7427 2069     if 'regnet' i
+000199f0: 6e20 6e6f 6465 2e76 6572 7369 6f6e 206f  n node.version o
+00019a00: 7220 6e6f 6465 2e69 735f 7265 676e 6574  r node.is_regnet
+00019a10: 3a0a 2020 2020 2020 2020 6e6f 6465 2e69  :.        node.i
+00019a20: 735f 7265 676e 6574 203d 2054 7275 650a  s_regnet = True.
+00019a30: 2020 2020 2020 2020 6e6f 6465 2e69 735f          node.is_
+00019a40: 7465 7374 6e65 7420 3d20 4661 6c73 650a  testnet = False.
+00019a50: 2020 2020 2020 2020 6e6f 6465 2e69 735f          node.is_
+00019a60: 6d61 696e 6e65 7420 3d20 4661 6c73 650a  mainnet = False.
+00019a70: 0a20 2020 206e 6f64 652e 6c6f 6767 6572  .    node.logger
+00019a80: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+00019a90: 2866 2754 6573 746e 6574 3a20 7b6e 6f64  (f'Testnet: {nod
+00019aa0: 652e 6973 5f74 6573 746e 6574 7d27 290a  e.is_testnet}').
+00019ab0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+00019ac0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+00019ad0: 6627 5265 676e 6574 203a 207b 6e6f 6465  f'Regnet : {node
+00019ae0: 2e69 735f 7265 676e 6574 7d27 290a 0a20  .is_regnet}').. 
+00019af0: 2020 2023 2064 6566 6175 6c74 206d 6169     # default mai
+00019b00: 6e6e 6574 2063 6f6e 6669 670a 2020 2020  nnet config.    
+00019b10: 6e6f 6465 2e70 6565 7266 696c 6520 3d20  node.peerfile = 
+00019b20: 2770 6565 7273 2e74 7874 270a 2020 2020  'peers.txt'.    
+00019b30: 6e6f 6465 2e6c 6564 6765 725f 7261 6d5f  node.ledger_ram_
+00019b40: 6669 6c65 203d 2027 6669 6c65 3a6c 6564  file = 'file:led
+00019b50: 6765 723f 6d6f 6465 3d6d 656d 6f72 7926  ger?mode=memory&
+00019b60: 6361 6368 653d 7368 6172 6564 270a 2020  cache=shared'.  
+00019b70: 2020 6e6f 6465 2e69 6e64 6578 5f64 6220    node.index_db 
+00019b80: 3d20 2773 7461 7469 632f 696e 6465 782e  = 'static/index.
+00019b90: 6462 270a 0a20 2020 2069 6620 6e6f 6465  db'..    if node
+00019ba0: 2e69 735f 6d61 696e 6e65 743a 0a20 2020  .is_mainnet:.   
+00019bb0: 2020 2020 2023 2041 6c6c 6f77 206f 6e6c       # Allow onl
+00019bc0: 7920 3231 2061 6e64 2075 700a 2020 2020  y 21 and up.    
+00019bd0: 2020 2020 6966 206e 6f64 652e 7665 7273      if node.vers
+00019be0: 696f 6e20 213d 2027 6d61 696e 6e65 7430  ion != 'mainnet0
+00019bf0: 3032 3127 3a0a 2020 2020 2020 2020 2020  021':.          
+00019c00: 2020 6e6f 6465 2e76 6572 7369 6f6e 203d    node.version =
+00019c10: 2027 6d61 696e 6e65 7430 3032 3127 2020   'mainnet0021'  
+00019c20: 2320 466f 7263 6520 696e 2063 6f64 652e  # Force in code.
+00019c30: 0a20 2020 2020 2020 2069 6620 276d 6169  .        if 'mai
+00019c40: 6e6e 6574 3030 3231 2720 6e6f 7420 696e  nnet0021' not in
+00019c50: 206e 6f64 652e 7665 7273 696f 6e5f 616c   node.version_al
+00019c60: 6c6f 773a 0a20 2020 2020 2020 2020 2020  low:.           
+00019c70: 206e 6f64 652e 7665 7273 696f 6e5f 616c   node.version_al
+00019c80: 6c6f 7720 3d20 5b27 6d61 696e 6e65 7430  low = ['mainnet0
+00019c90: 3032 3127 2c20 276d 6169 6e6e 6574 3030  021', 'mainnet00
+00019ca0: 3232 275d 0a20 2020 2020 2020 2023 2044  22'].        # D
+00019cb0: 6f20 6e6f 7420 616c 6c6f 7720 6261 6420  o not allow bad 
+00019cc0: 636f 6e66 6967 732e 0a20 2020 2020 2020  configs..       
+00019cd0: 2069 6620 6e6f 7420 276d 6169 6e6e 6574   if not 'mainnet
+00019ce0: 2720 696e 206e 6f64 652e 7665 7273 696f  ' in node.versio
+00019cf0: 6e3a 0a20 2020 2020 2020 2020 2020 206e  n:.            n
+00019d00: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+00019d10: 6f67 2e65 7272 6f72 2827 4261 6420 6d61  og.error('Bad ma
+00019d20: 696e 6e65 7420 7665 7273 696f 6e2c 2063  innet version, c
+00019d30: 6865 636b 2063 6f6e 6669 672e 7478 7427  heck config.txt'
+00019d40: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
+00019d50: 732e 6578 6974 2829 0a20 2020 2020 2020  s.exit().       
+00019d60: 206e 756d 5f76 6572 203d 206a 7573 745f   num_ver = just_
+00019d70: 696e 745f 6672 6f6d 286e 6f64 652e 7665  int_from(node.ve
+00019d80: 7273 696f 6e29 0a20 2020 2020 2020 2069  rsion).        i
+00019d90: 6620 6e75 6d5f 7665 7220 3c20 3231 3a0a  f num_ver < 21:.
+00019da0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00019db0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
+00019dc0: 6572 726f 7228 2754 6f6f 206c 6f77 206d  error('Too low m
+00019dd0: 6169 6e6e 6574 2076 6572 7369 6f6e 2c20  ainnet version, 
+00019de0: 6368 6563 6b20 636f 6e66 6967 2e74 7874  check config.txt
+00019df0: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+00019e00: 7973 2e65 7869 7428 290a 2020 2020 2020  ys.exit().      
+00019e10: 2020 666f 7220 616c 6c6f 7765 6420 696e    for allowed in
+00019e20: 206e 6f64 652e 7665 7273 696f 6e5f 616c   node.version_al
+00019e30: 6c6f 773a 0a20 2020 2020 2020 2020 2020  low:.           
+00019e40: 206e 756d 5f76 6572 203d 206a 7573 745f   num_ver = just_
+00019e50: 696e 745f 6672 6f6d 2861 6c6c 6f77 6564  int_from(allowed
+00019e60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00019e70: 206e 756d 5f76 6572 203c 2032 303a 0a20   num_ver < 20:. 
+00019e80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00019e90: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+00019ea0: 6f67 2e65 7272 6f72 2827 546f 6f20 6c6f  og.error('Too lo
+00019eb0: 7720 616c 6c6f 7765 6420 7665 7273 696f  w allowed versio
+00019ec0: 6e2c 2063 6865 636b 2063 6f6e 6669 672e  n, check config.
+00019ed0: 7478 7427 290a 2020 2020 2020 2020 2020  txt').          
+00019ee0: 2020 2020 2020 7379 732e 6578 6974 2829        sys.exit()
+00019ef0: 0a0a 2020 2020 6966 2027 7465 7374 6e65  ..    if 'testne
+00019f00: 7427 2069 6e20 6e6f 6465 2e76 6572 7369  t' in node.versi
+00019f10: 6f6e 206f 7220 6e6f 6465 2e69 735f 7465  on or node.is_te
+00019f20: 7374 6e65 743a 0a20 2020 2020 2020 206e  stnet:.        n
+00019f30: 6f64 652e 706f 7274 203d 2032 3832 390a  ode.port = 2829.
+00019f40: 2020 2020 2020 2020 6e6f 6465 2e68 7970          node.hyp
+00019f50: 6572 5f70 6174 6820 3d20 2773 7461 7469  er_path = 'stati
+00019f60: 632f 6879 7065 725f 7465 7374 2e64 6227  c/hyper_test.db'
+00019f70: 0a20 2020 2020 2020 206e 6f64 652e 6c65  .        node.le
+00019f80: 6467 6572 5f70 6174 6820 3d20 2773 7461  dger_path = 'sta
+00019f90: 7469 632f 6c65 6467 6572 5f74 6573 742e  tic/ledger_test.
+00019fa0: 6462 270a 0a20 2020 2020 2020 206e 6f64  db'..        nod
+00019fb0: 652e 6c65 6467 6572 5f72 616d 5f66 696c  e.ledger_ram_fil
+00019fc0: 6520 3d20 2766 696c 653a 6c65 6467 6572  e = 'file:ledger
+00019fd0: 5f74 6573 746e 6574 3f6d 6f64 653d 6d65  _testnet?mode=me
+00019fe0: 6d6f 7279 2663 6163 6865 3d73 6861 7265  mory&cache=share
+00019ff0: 6427 0a20 2020 2020 2020 2023 6e6f 6465  d'.        #node
+0001a000: 2e68 7970 6572 5f72 6563 6f6d 7072 6573  .hyper_recompres
+0001a010: 7320 3d20 4661 6c73 650a 2020 2020 2020  s = False.      
+0001a020: 2020 6e6f 6465 2e70 6565 7266 696c 6520    node.peerfile 
+0001a030: 3d20 2770 6565 7273 5f74 6573 742e 7478  = 'peers_test.tx
+0001a040: 7427 0a20 2020 2020 2020 206e 6f64 652e  t'.        node.
+0001a050: 696e 6465 785f 6462 203d 2027 7374 6174  index_db = 'stat
+0001a060: 6963 2f69 6e64 6578 5f74 6573 742e 6462  ic/index_test.db
+0001a070: 270a 2020 2020 2020 2020 6966 206e 6f74  '.        if not
+0001a080: 2027 7465 7374 6e65 7427 2069 6e20 6e6f   'testnet' in no
+0001a090: 6465 2e76 6572 7369 6f6e 3a0a 2020 2020  de.version:.    
+0001a0a0: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+0001a0b0: 6765 722e 6170 705f 6c6f 672e 6572 726f  ger.app_log.erro
+0001a0c0: 7228 2742 6164 2074 6573 746e 6574 2076  r('Bad testnet v
+0001a0d0: 6572 7369 6f6e 2c20 6368 6563 6b20 636f  ersion, check co
+0001a0e0: 6e66 6967 2e74 7874 2729 0a20 2020 2020  nfig.txt').     
+0001a0f0: 2020 2020 2020 2073 7973 2e65 7869 7428         sys.exit(
+0001a100: 290a 0a20 2020 2020 2020 2072 6564 6f77  )..        redow
+0001a110: 6e6c 6f61 645f 7465 7374 203d 2069 6e70  nload_test = inp
+0001a120: 7574 2827 5374 6174 7573 3a20 5765 6c63  ut('Status: Welc
+0001a130: 6f6d 6520 746f 2074 6865 2074 6573 746e  ome to the testn
+0001a140: 6574 2e20 5265 646f 776e 6c6f 6164 2074  et. Redownload t
+0001a150: 6573 7420 6c65 6467 6572 3f20 792f 6e27  est ledger? y/n'
+0001a160: 290a 2020 2020 2020 2020 6966 2072 6564  ).        if red
+0001a170: 6f77 6e6c 6f61 645f 7465 7374 203d 3d20  ownload_test == 
+0001a180: 2779 273a 0a20 2020 2020 2020 2020 2020  'y':.           
+0001a190: 2074 7970 6573 203d 205b 2773 7461 7469   types = ['stati
+0001a1a0: 632f 6c65 6467 6572 5f74 6573 742e 6462  c/ledger_test.db
+0001a1b0: 2d77 616c 272c 2027 7374 6174 6963 2f6c  -wal', 'static/l
+0001a1c0: 6564 6765 725f 7465 7374 2e64 622d 7368  edger_test.db-sh
+0001a1d0: 6d27 2c20 2773 7461 7469 632f 696e 6465  m', 'static/inde
+0001a1e0: 785f 7465 7374 2e64 6227 2c20 2773 7461  x_test.db', 'sta
+0001a1f0: 7469 632f 6879 7065 725f 7465 7374 2e64  tic/hyper_test.d
+0001a200: 622d 7761 6c27 2c20 2773 7461 7469 632f  b-wal', 'static/
+0001a210: 6879 7065 725f 7465 7374 2e64 622d 7368  hyper_test.db-sh
+0001a220: 6d27 5d0a 2020 2020 2020 2020 2020 2020  m'].            
+0001a230: 666f 7220 7479 7065 2069 6e20 7479 7065  for type in type
+0001a240: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001a250: 2020 2066 6f72 2066 696c 6520 696e 2067     for file in g
+0001a260: 6c6f 622e 676c 6f62 2874 7970 6529 3a0a  lob.glob(type):.
 0001a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a280: 2020 6966 2073 6861 5f68 6173 682e 6865    if sha_hash.he
-0001a290: 7864 6967 6573 7428 2920 213d 2064 625f  xdigest() != db_
-0001a2a0: 6861 7368 6573 5b64 625f 626c 6f63 6b5f  hashes[db_block_
-0001a2b0: 6865 6967 6874 202b 2027 2d27 202b 2064  height + '-' + d
-0001a2c0: 625f 7469 6d65 7374 616d 705d 3a0a 2020  b_timestamp]:.  
-0001a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2e0: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0001a2f0: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
-0001a300: 6728 2753 6967 6e61 7475 7265 2076 616c  g('Signature val
-0001a310: 6964 6174 696f 6e20 7072 6f62 6c65 6d3a  idation problem:
-0001a320: 207b 7d20 7b7d 272e 666f 726d 6174 2864   {} {}'.format(d
-0001a330: 625f 626c 6f63 6b5f 6865 6967 6874 2c20  b_block_height, 
-0001a340: 6462 5f74 7261 6e73 6163 7469 6f6e 2929  db_transaction))
-0001a350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a360: 2020 2020 2020 2020 2069 6e76 616c 6964           invalid
-0001a370: 203d 2069 6e76 616c 6964 202b 2031 0a20   = invalid + 1. 
-0001a380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001a390: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0001a3a0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0001a3b0: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-0001a3c0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-0001a3d0: 726e 696e 6728 2753 6967 6e61 7475 7265  rning('Signature
-0001a3e0: 2076 616c 6964 6174 696f 6e20 7072 6f62   validation prob
-0001a3f0: 6c65 6d3a 207b 7d20 7b7d 272e 666f 726d  lem: {} {}'.form
-0001a400: 6174 2864 625f 626c 6f63 6b5f 6865 6967  at(db_block_heig
-0001a410: 6874 2c20 6462 5f74 7261 6e73 6163 7469  ht, db_transacti
-0001a420: 6f6e 2929 0a20 2020 2020 2020 2020 2020  on)).           
-0001a430: 2020 2020 2020 2020 2069 6e76 616c 6964           invalid
-0001a440: 203d 2069 6e76 616c 6964 202b 2031 0a0a   = invalid + 1..
-0001a450: 2020 2020 2020 2020 6966 2069 6e76 616c          if inval
-0001a460: 6964 203d 3d20 303a 0a20 2020 2020 2020  id == 0:.       
-0001a470: 2020 2020 206e 6f64 652e 6c6f 6767 6572       node.logger
-0001a480: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
-0001a490: 2827 416c 6c20 7472 616e 7361 6369 746f  ('All transacito
-0001a4a0: 6e73 2069 6e20 7468 6520 6c6f 6361 6c20  ns in the local 
-0001a4b0: 6c65 6467 6572 2061 7265 2076 616c 6964  ledger are valid
-0001a4c0: 2729 0a0a 2020 2020 6578 6365 7074 2045  ')..    except E
-0001a4d0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-0001a4e0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
-0001a4f0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-0001a500: 6e67 2827 4572 726f 723a 207b 7d27 2e66  ng('Error: {}'.f
-0001a510: 6f72 6d61 7428 6529 290a 2020 2020 2020  ormat(e)).      
-0001a520: 2020 7261 6973 650a 0a0a 6465 6620 6164    raise...def ad
-0001a530: 645f 696e 6469 6365 7328 6462 5f68 616e  d_indices(db_han
-0001a540: 646c 6572 3a20 6462 6861 6e64 6c65 722e  dler: dbhandler.
-0001a550: 4462 4861 6e64 6c65 7229 3a0a 2020 2020  DbHandler):.    
-0001a560: 4352 4541 5445 5f54 5849 4434 5f49 4e44  CREATE_TXID4_IND
-0001a570: 4558 5f49 465f 4e4f 545f 4558 4953 5453  EX_IF_NOT_EXISTS
-0001a580: 203d 2027 4352 4541 5445 2049 4e44 4558   = 'CREATE INDEX
-0001a590: 2049 4620 4e4f 5420 4558 4953 5453 2054   IF NOT EXISTS T
-0001a5a0: 5849 4434 5f49 6e64 6578 204f 4e20 7472  XID4_Index ON tr
-0001a5b0: 616e 7361 6374 696f 6e73 2873 7562 7374  ansactions(subst
-0001a5c0: 7228 7369 676e 6174 7572 652c 312c 3429  r(signature,1,4)
-0001a5d0: 2927 0a20 2020 2043 5245 4154 455f 4d49  )'.    CREATE_MI
-0001a5e0: 5343 5f42 4c4f 434b 5f48 4549 4748 545f  SC_BLOCK_HEIGHT_
-0001a5f0: 494e 4445 585f 4946 5f4e 4f54 5f45 5849  INDEX_IF_NOT_EXI
-0001a600: 5354 5320 3d20 2243 5245 4154 4520 494e  STS = "CREATE IN
-0001a610: 4445 5820 4946 204e 4f54 2045 5849 5354  DEX IF NOT EXIST
-0001a620: 5320 274d 6973 6320 426c 6f63 6b20 4865  S 'Misc Block He
-0001a630: 6967 6874 2049 6e64 6578 2720 6f6e 206d  ight Index' on m
-0001a640: 6973 6328 626c 6f63 6b5f 6865 6967 6874  isc(block_height
-0001a650: 2922 0a0a 2020 2020 6e6f 6465 2e6c 6f67  )"..    node.log
-0001a660: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-0001a670: 696e 6728 2743 7265 6174 696e 6720 696e  ing('Creating in
-0001a680: 6469 6365 7327 290a 0a20 2020 2023 206c  dices')..    # l
-0001a690: 6564 6765 722e 6462 0a20 2020 2069 6620  edger.db.    if 
-0001a6a0: 6e6f 7420 6e6f 6465 2e6f 6c64 5f73 716c  not node.old_sql
-0001a6b0: 6974 653a 0a20 2020 2020 2020 2064 625f  ite:.        db_
-0001a6c0: 6861 6e64 6c65 722e 6578 6563 7574 6528  handler.execute(
-0001a6d0: 6462 5f68 616e 646c 6572 2e68 2c20 4352  db_handler.h, CR
-0001a6e0: 4541 5445 5f54 5849 4434 5f49 4e44 4558  EATE_TXID4_INDEX
-0001a6f0: 5f49 465f 4e4f 545f 4558 4953 5453 290a  _IF_NOT_EXISTS).
-0001a700: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a710: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
-0001a720: 705f 6c6f 672e 7761 726e 696e 6728 2753  p_log.warning('S
-0001a730: 6574 7469 6e67 206f 6c64 5f73 716c 6974  etting old_sqlit
-0001a740: 6520 6973 2054 7275 652c 206c 6f6f 6b75  e is True, looku
-0001a750: 7073 2077 696c 6c20 6265 2073 6c6f 7765  ps will be slowe
-0001a760: 722e 2729 0a20 2020 2064 625f 6861 6e64  r.').    db_hand
-0001a770: 6c65 722e 6578 6563 7574 6528 6462 5f68  ler.execute(db_h
-0001a780: 616e 646c 6572 2e68 2c20 4352 4541 5445  andler.h, CREATE
-0001a790: 5f4d 4953 435f 424c 4f43 4b5f 4845 4947  _MISC_BLOCK_HEIG
-0001a7a0: 4854 5f49 4e44 4558 5f49 465f 4e4f 545f  HT_INDEX_IF_NOT_
-0001a7b0: 4558 4953 5453 290a 0a20 2020 2023 2068  EXISTS)..    # h
-0001a7c0: 7970 6572 2e64 620a 2020 2020 6966 206e  yper.db.    if n
-0001a7d0: 6f74 206e 6f64 652e 6f6c 645f 7371 6c69  ot node.old_sqli
-0001a7e0: 7465 3a0a 2020 2020 2020 2020 6462 5f68  te:.        db_h
-0001a7f0: 616e 646c 6572 2e65 7865 6375 7465 2864  andler.execute(d
-0001a800: 625f 6861 6e64 6c65 722e 6832 2c20 4352  b_handler.h2, CR
-0001a810: 4541 5445 5f54 5849 4434 5f49 4e44 4558  EATE_TXID4_INDEX
-0001a820: 5f49 465f 4e4f 545f 4558 4953 5453 290a  _IF_NOT_EXISTS).
-0001a830: 2020 2020 6462 5f68 616e 646c 6572 2e65      db_handler.e
-0001a840: 7865 6375 7465 2864 625f 6861 6e64 6c65  xecute(db_handle
-0001a850: 722e 6832 2c20 4352 4541 5445 5f4d 4953  r.h2, CREATE_MIS
-0001a860: 435f 424c 4f43 4b5f 4845 4947 4854 5f49  C_BLOCK_HEIGHT_I
-0001a870: 4e44 4558 5f49 465f 4e4f 545f 4558 4953  NDEX_IF_NOT_EXIS
-0001a880: 5453 290a 0a20 2020 2023 2052 414d 206f  TS)..    # RAM o
-0001a890: 7220 6879 7065 722e 6462 0a20 2020 2069  r hyper.db.    i
-0001a8a0: 6620 6e6f 7420 6e6f 6465 2e6f 6c64 5f73  f not node.old_s
-0001a8b0: 716c 6974 653a 0a20 2020 2020 2020 2064  qlite:.        d
-0001a8c0: 625f 6861 6e64 6c65 722e 6578 6563 7574  b_handler.execut
-0001a8d0: 6528 6462 5f68 616e 646c 6572 2e63 2c20  e(db_handler.c, 
-0001a8e0: 4352 4541 5445 5f54 5849 4434 5f49 4e44  CREATE_TXID4_IND
-0001a8f0: 4558 5f49 465f 4e4f 545f 4558 4953 5453  EX_IF_NOT_EXISTS
-0001a900: 290a 2020 2020 6462 5f68 616e 646c 6572  ).    db_handler
-0001a910: 2e65 7865 6375 7465 2864 625f 6861 6e64  .execute(db_hand
-0001a920: 6c65 722e 632c 2043 5245 4154 455f 4d49  ler.c, CREATE_MI
-0001a930: 5343 5f42 4c4f 434b 5f48 4549 4748 545f  SC_BLOCK_HEIGHT_
-0001a940: 494e 4445 585f 4946 5f4e 4f54 5f45 5849  INDEX_IF_NOT_EXI
-0001a950: 5354 5329 0a0a 2020 2020 6e6f 6465 2e6c  STS)..    node.l
-0001a960: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-0001a970: 726e 696e 6728 2746 696e 6973 6865 6420  rning('Finished 
-0001a980: 6372 6561 7469 6e67 2069 6e64 6963 6573  creating indices
-0001a990: 2729 0a0a 0a69 6620 5f5f 6e61 6d65 5f5f  ')...if __name__
-0001a9a0: 203d 3d20 275f 5f6d 6169 6e5f 5f27 3a0a   == '__main__':.
-0001a9b0: 2020 2020 2320 636c 6173 7365 730a 2020      # classes.  
-0001a9c0: 2020 6e6f 6465 203d 205f 6e6f 6465 2e4e    node = _node.N
-0001a9d0: 6f64 6528 290a 2020 2020 6e6f 6465 2e6c  ode().    node.l
-0001a9e0: 6f67 6765 7220 3d20 6c6f 6767 6572 2e4c  ogger = logger.L
-0001a9f0: 6f67 6765 7228 290a 2020 2020 6e6f 6465  ogger().    node
-0001aa00: 2e6b 6579 7320 3d20 6b65 7973 2e4b 6579  .keys = keys.Key
-0001aa10: 7328 290a 0a20 2020 206e 6f64 652e 6973  s()..    node.is
-0001aa20: 5f74 6573 746e 6574 203d 2046 616c 7365  _testnet = False
-0001aa30: 0a20 2020 2023 2072 6567 6e65 7420 7461  .    # regnet ta
-0001aa40: 6b65 7320 6f76 6572 2074 6573 746e 6574  kes over testnet
-0001aa50: 0a20 2020 206e 6f64 652e 6973 5f72 6567  .    node.is_reg
-0001aa60: 6e65 7420 3d20 4661 6c73 650a 2020 2020  net = False.    
-0001aa70: 2320 6966 2069 7427 7320 6e6f 7420 7465  # if it's not te
-0001aa80: 7374 6e65 742c 206e 6f72 2072 6567 6e65  stnet, nor regne
-0001aa90: 742c 2069 7427 7320 6d61 696e 6e65 740a  t, it's mainnet.
-0001aaa0: 2020 2020 6e6f 6465 2e69 735f 6d61 696e      node.is_main
-0001aab0: 6e65 7420 3d20 5472 7565 0a0a 2020 2020  net = True..    
-0001aac0: 636f 6e66 6967 203d 206f 7074 696f 6e73  config = options
-0001aad0: 2e47 6574 2829 0a20 2020 2063 6f6e 6669  .Get().    confi
-0001aae0: 672e 7265 6164 2829 0a20 2020 2023 2063  g.read().    # c
-0001aaf0: 6c61 7373 6573 0a0a 2020 2020 6e6f 6465  lasses..    node
-0001ab00: 2e61 7070 5f76 6572 7369 6f6e 203d 2056  .app_version = V
-0001ab10: 4552 5349 4f4e 0a20 2020 2023 2054 4f44  ERSION.    # TOD
-0001ab20: 4f3a 2077 6520 636f 756c 6420 6a75 7374  O: we could just
-0001ab30: 206c 6f6f 7020 6f76 6572 2063 6f6e 6669   loop over confi
-0001ab40: 6720 6974 656d 732c 2061 6e64 2061 7373  g items, and ass
-0001ab50: 6967 6e20 7468 656d 2074 6f20 6e6f 6465  ign them to node
-0001ab60: 2e0a 2020 2020 2320 6f72 206a 7573 7420  ..    # or just 
-0001ab70: 646f 206e 6f64 652e 636f 6e66 6967 203d  do node.config =
-0001ab80: 2063 6f6e 6669 670a 2020 2020 2320 616e   config.    # an
-0001ab90: 6420 7573 6520 6e6f 6465 2e63 6f6e 6669  d use node.confi
-0001aba0: 672e 706f 7274 2e2e 2e20 6173 6f0a 0a20  g.port... aso.. 
-0001abb0: 2020 2023 2054 4f44 4f3a 2053 696d 706c     # TODO: Simpl
-0001abc0: 6966 792e 204a 7573 7420 646f 206e 6f64  ify. Just do nod
-0001abd0: 652e 636f 6e66 6967 203d 2063 6f6e 6669  e.config = confi
-0001abe0: 672c 2074 6865 6e20 7573 6520 6e6f 6465  g, then use node
-0001abf0: 2e63 6f6e 6669 672e 7265 7175 6972 6564  .config.required
-0001ac00: 5f6f 7074 696f 6e0a 2020 2020 6e6f 6465  _option.    node
-0001ac10: 2e76 6572 7369 6f6e 203d 2063 6f6e 6669  .version = confi
-0001ac20: 672e 7665 7273 696f 6e0a 2020 2020 6e6f  g.version.    no
-0001ac30: 6465 2e64 6562 7567 5f6c 6576 656c 203d  de.debug_level =
-0001ac40: 2063 6f6e 6669 672e 6465 6275 675f 6c65   config.debug_le
-0001ac50: 7665 6c0a 2020 2020 6e6f 6465 2e70 6f72  vel.    node.por
-0001ac60: 7420 3d20 636f 6e66 6967 2e70 6f72 740a  t = config.port.
-0001ac70: 2020 2020 6e6f 6465 2e76 6572 6966 7920      node.verify 
-0001ac80: 3d20 636f 6e66 6967 2e76 6572 6966 790a  = config.verify.
-0001ac90: 2020 2020 6e6f 6465 2e74 6872 6561 645f      node.thread_
-0001aca0: 6c69 6d69 7420 3d20 636f 6e66 6967 2e74  limit = config.t
-0001acb0: 6872 6561 645f 6c69 6d69 740a 2020 2020  hread_limit.    
-0001acc0: 6e6f 6465 2e72 6562 7569 6c64 5f64 6220  node.rebuild_db 
-0001acd0: 3d20 636f 6e66 6967 2e72 6562 7569 6c64  = config.rebuild
-0001ace0: 5f64 620a 2020 2020 6e6f 6465 2e64 6562  _db.    node.deb
-0001acf0: 7567 203d 2063 6f6e 6669 672e 6465 6275  ug = config.debu
-0001ad00: 670a 2020 2020 6e6f 6465 2e64 6562 7567  g.    node.debug
-0001ad10: 5f6c 6576 656c 203d 2063 6f6e 6669 672e  _level = config.
-0001ad20: 6465 6275 675f 6c65 7665 6c0a 2020 2020  debug_level.    
-0001ad30: 6e6f 6465 2e70 6175 7365 203d 2063 6f6e  node.pause = con
-0001ad40: 6669 672e 7061 7573 650a 2020 2020 6e6f  fig.pause.    no
-0001ad50: 6465 2e6c 6564 6765 725f 7061 7468 203d  de.ledger_path =
-0001ad60: 2063 6f6e 6669 672e 6c65 6467 6572 5f70   config.ledger_p
-0001ad70: 6174 680a 2020 2020 6e6f 6465 2e68 7970  ath.    node.hyp
-0001ad80: 6572 5f70 6174 6820 3d20 636f 6e66 6967  er_path = config
-0001ad90: 2e68 7970 6572 5f70 6174 680a 2020 2020  .hyper_path.    
-0001ada0: 6e6f 6465 2e68 7970 6572 5f72 6563 6f6d  node.hyper_recom
-0001adb0: 7072 6573 7320 3d20 636f 6e66 6967 2e68  press = config.h
-0001adc0: 7970 6572 5f72 6563 6f6d 7072 6573 730a  yper_recompress.
-0001add0: 2020 2020 6e6f 6465 2e74 6f72 203d 2063      node.tor = c
-0001ade0: 6f6e 6669 672e 746f 720a 2020 2020 6e6f  onfig.tor.    no
-0001adf0: 6465 2e72 616d 203d 2063 6f6e 6669 672e  de.ram = config.
-0001ae00: 7261 6d0a 2020 2020 6e6f 6465 2e76 6572  ram.    node.ver
-0001ae10: 7369 6f6e 5f61 6c6c 6f77 203d 2063 6f6e  sion_allow = con
-0001ae20: 6669 672e 7665 7273 696f 6e5f 616c 6c6f  fig.version_allo
-0001ae30: 770a 2020 2020 6e6f 6465 2e72 6576 6561  w.    node.revea
-0001ae40: 6c5f 6164 6472 6573 7320 3d20 636f 6e66  l_address = conf
-0001ae50: 6967 2e72 6576 6561 6c5f 6164 6472 6573  ig.reveal_addres
-0001ae60: 730a 2020 2020 6e6f 6465 2e74 6572 6d69  s.    node.termi
-0001ae70: 6e61 6c5f 6f75 7470 7574 203d 2063 6f6e  nal_output = con
-0001ae80: 6669 672e 7465 726d 696e 616c 5f6f 7574  fig.terminal_out
-0001ae90: 7075 740a 2020 2020 6e6f 6465 2e65 6772  put.    node.egr
-0001aea0: 6573 7320 3d20 636f 6e66 6967 2e65 6772  ess = config.egr
-0001aeb0: 6573 730a 2020 2020 6e6f 6465 2e67 656e  ess.    node.gen
-0001aec0: 6573 6973 203d 2063 6f6e 6669 672e 6765  esis = config.ge
-0001aed0: 6e65 7369 730a 2020 2020 6e6f 6465 2e61  nesis.    node.a
-0001aee0: 6363 6570 745f 7065 6572 7320 3d20 636f  ccept_peers = co
-0001aef0: 6e66 6967 2e61 6363 6570 745f 7065 6572  nfig.accept_peer
-0001af00: 730a 2020 2020 6e6f 6465 2e66 756c 6c5f  s.    node.full_
-0001af10: 6c65 6467 6572 203d 2063 6f6e 6669 672e  ledger = config.
-0001af20: 6675 6c6c 5f6c 6564 6765 720a 2020 2020  full_ledger.    
-0001af30: 6e6f 6465 2e74 7261 6365 5f64 625f 6361  node.trace_db_ca
-0001af40: 6c6c 7320 3d20 636f 6e66 6967 2e74 7261  lls = config.tra
-0001af50: 6365 5f64 625f 6361 6c6c 730a 2020 2020  ce_db_calls.    
-0001af60: 6e6f 6465 2e68 6561 7679 335f 7061 7468  node.heavy3_path
-0001af70: 203d 2063 6f6e 6669 672e 6865 6176 7933   = config.heavy3
-0001af80: 5f70 6174 680a 2020 2020 6e6f 6465 2e6f  _path.    node.o
-0001af90: 6c64 5f73 716c 6974 6520 3d20 636f 6e66  ld_sqlite = conf
-0001afa0: 6967 2e6f 6c64 5f73 716c 6974 650a 2020  ig.old_sqlite.  
-0001afb0: 2020 6e6f 6465 2e68 6561 7679 203d 2063    node.heavy = c
-0001afc0: 6f6e 6669 672e 6865 6176 790a 0a20 2020  onfig.heavy..   
-0001afd0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
-0001afe0: 5f6c 6f67 203d 206c 6f67 2e6c 6f67 2827  _log = log.log('
-0001aff0: 6e6f 6465 2e6c 6f67 272c 206e 6f64 652e  node.log', node.
-0001b000: 6465 6275 675f 6c65 7665 6c2c 206e 6f64  debug_level, nod
-0001b010: 652e 7465 726d 696e 616c 5f6f 7574 7075  e.terminal_outpu
-0001b020: 7429 0a20 2020 206e 6f64 652e 6c6f 6767  t).    node.logg
-0001b030: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
-0001b040: 6e67 2827 436f 6e66 6967 7572 6174 696f  ng('Configuratio
-0001b050: 6e20 7365 7474 696e 6773 206c 6f61 6465  n settings loade
-0001b060: 6427 290a 2020 2020 6e6f 6465 2e6c 6f67  d').    node.log
-0001b070: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
-0001b080: 696e 6728 6627 5079 7468 6f6e 2076 6572  ing(f'Python ver
-0001b090: 7369 6f6e 3a20 7b6e 6f64 652e 7079 5f76  sion: {node.py_v
-0001b0a0: 6572 7369 6f6e 7d27 290a 0a20 2020 2023  ersion}')..    #
-0001b0b0: 2075 7067 7261 6465 2077 616c 6c65 7420   upgrade wallet 
-0001b0c0: 6c6f 6361 7469 6f6e 2061 6674 6572 206e  location after n
-0001b0d0: 7569 746b 612d 7265 7175 6972 6564 2022  uitka-required "
-0001b0e0: 6669 6c65 7322 2066 6f6c 6465 7220 696e  files" folder in
-0001b0f0: 7472 6f64 7563 7469 6f6e 0a20 2020 2069  troduction.    i
-0001b100: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
-0001b110: 2827 2e2e 2f77 616c 6c65 742e 6465 7227  ('../wallet.der'
-0001b120: 2920 616e 6420 6e6f 7420 6f73 2e70 6174  ) and not os.pat
-0001b130: 682e 6578 6973 7473 2827 7761 6c6c 6574  h.exists('wallet
-0001b140: 2e64 6572 2729 2061 6e64 2027 5769 6e64  .der') and 'Wind
-0001b150: 6f77 7327 2069 6e20 706c 6174 666f 726d  ows' in platform
-0001b160: 2e73 7973 7465 6d28 293a 0a20 2020 2020  .system():.     
-0001b170: 2020 2070 7269 6e74 2827 5570 6772 6164     print('Upgrad
-0001b180: 696e 6720 7761 6c6c 6574 206c 6f63 6174  ing wallet locat
-0001b190: 696f 6e27 290a 2020 2020 2020 2020 6f73  ion').        os
-0001b1a0: 2e72 656e 616d 6528 272e 2e2f 7761 6c6c  .rename('../wall
-0001b1b0: 6574 2e64 6572 272c 2027 7761 6c6c 6574  et.der', 'wallet
-0001b1c0: 2e64 6572 2729 0a20 2020 2023 2075 7067  .der').    # upg
-0001b1d0: 7261 6465 2077 616c 6c65 7420 6c6f 6361  rade wallet loca
-0001b1e0: 7469 6f6e 2061 6674 6572 206e 7569 746b  tion after nuitk
-0001b1f0: 612d 7265 7175 6972 6564 2022 6669 6c65  a-required "file
-0001b200: 7322 2066 6f6c 6465 7220 696e 7472 6f64  s" folder introd
-0001b210: 7563 7469 6f6e 0a0a 2020 2020 6966 206e  uction..    if n
-0001b220: 6f74 206e 6f64 652e 6675 6c6c 5f6c 6564  ot node.full_led
-0001b230: 6765 7220 616e 6420 6f73 2e70 6174 682e  ger and os.path.
-0001b240: 6578 6973 7473 286e 6f64 652e 6c65 6467  exists(node.ledg
-0001b250: 6572 5f70 6174 6829 2061 6e64 206e 6f64  er_path) and nod
-0001b260: 652e 6973 5f6d 6169 6e6e 6574 3a0a 2020  e.is_mainnet:.  
-0001b270: 2020 2020 2020 6f73 2e72 656d 6f76 6528        os.remove(
-0001b280: 6e6f 6465 2e6c 6564 6765 725f 7061 7468  node.ledger_path
-0001b290: 290a 2020 2020 2020 2020 6e6f 6465 2e6c  ).        node.l
-0001b2a0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-0001b2b0: 726e 696e 6728 2752 656d 6f76 6564 2066  rning('Removed f
-0001b2c0: 756c 6c20 6c65 6467 6572 2066 6f72 2068  ull ledger for h
-0001b2d0: 7970 6572 626c 6f63 6b20 6d6f 6465 2729  yperblock mode')
-0001b2e0: 0a20 2020 2069 6620 6e6f 7420 6e6f 6465  .    if not node
-0001b2f0: 2e66 756c 6c5f 6c65 6467 6572 3a0a 2020  .full_ledger:.  
-0001b300: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
-0001b310: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
-0001b320: 6728 2743 6c6f 6e69 6e67 2068 7970 6572  g('Cloning hyper
-0001b330: 626c 6f63 6b73 2074 6f20 6c65 6467 6572  blocks to ledger
-0001b340: 2066 696c 6527 290a 2020 2020 2020 2020   file').        
-0001b350: 7368 7574 696c 2e63 6f70 7928 6e6f 6465  shutil.copy(node
-0001b360: 2e68 7970 6572 5f70 6174 682c 206e 6f64  .hyper_path, nod
-0001b370: 652e 6c65 6467 6572 5f70 6174 6829 2020  e.ledger_path)  
-0001b380: 2320 6861 636b 6564 2074 6f20 7265 6d6f  # hacked to remo
-0001b390: 7665 2061 6c6c 2074 6865 2065 6e64 6c65  ve all the endle
-0001b3a0: 7373 2063 6865 636b 730a 2020 2020 7472  ss checks.    tr
-0001b3b0: 793a 0a20 2020 2020 2020 2023 2063 7265  y:.        # cre
-0001b3c0: 6174 6520 6120 706c 7567 696e 206d 616e  ate a plugin man
-0001b3d0: 6167 6572 2c20 6c6f 6164 2061 6c6c 2070  ager, load all p
-0001b3e0: 6c75 6769 6e20 6d6f 6475 6c65 7320 616e  lugin modules an
-0001b3f0: 6420 696e 6974 0a20 2020 2020 2020 206e  d init.        n
-0001b400: 6f64 652e 706c 7567 696e 5f6d 616e 6167  ode.plugin_manag
-0001b410: 6572 203d 2070 6c75 6769 6e73 2e50 6c75  er = plugins.Plu
-0001b420: 6769 6e4d 616e 6167 6572 2861 7070 5f6c  ginManager(app_l
-0001b430: 6f67 3d6e 6f64 652e 6c6f 6767 6572 2e61  og=node.logger.a
-0001b440: 7070 5f6c 6f67 2c20 636f 6e66 6967 3d63  pp_log, config=c
-0001b450: 6f6e 6669 672c 2069 6e69 743d 5472 7565  onfig, init=True
-0001b460: 290a 2020 2020 2020 2020 2320 6765 7420  ).        # get 
-0001b470: 7468 6520 706f 7465 6e74 6961 6c20 6578  the potential ex
-0001b480: 7472 6120 636f 6d6d 616e 6420 7072 6566  tra command pref
-0001b490: 6978 6573 2066 726f 6d20 706c 7567 696e  ixes from plugin
-0001b4a0: 0a20 2020 2020 2020 2065 7874 7261 5f63  .        extra_c
-0001b4b0: 6f6d 6d61 6e64 7320 3d20 7b7d 2020 2320  ommands = {}  # 
-0001b4c0: 676c 6f62 616c 2076 6172 2c20 7573 6564  global var, used
-0001b4d0: 2062 7920 7468 6520 7365 7276 6572 2070   by the server p
-0001b4e0: 6172 742e 0a20 2020 2020 2020 2065 7874  art..        ext
-0001b4f0: 7261 5f63 6f6d 6d61 6e64 7320 3d20 6e6f  ra_commands = no
-0001b500: 6465 2e70 6c75 6769 6e5f 6d61 6e61 6765  de.plugin_manage
-0001b510: 722e 6578 6563 7574 655f 6669 6c74 6572  r.execute_filter
-0001b520: 5f68 6f6f 6b28 2765 7874 7261 5f63 6f6d  _hook('extra_com
-0001b530: 6d61 6e64 735f 7072 6566 6978 6573 272c  mands_prefixes',
-0001b540: 2065 7874 7261 5f63 6f6d 6d61 6e64 7329   extra_commands)
-0001b550: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-0001b560: 4578 7472 6120 7072 6566 6978 6573 3a20  Extra prefixes: 
-0001b570: 272c 2027 2c27 2e6a 6f69 6e28 6578 7472  ', ','.join(extr
-0001b580: 615f 636f 6d6d 616e 6473 2e6b 6579 7328  a_commands.keys(
-0001b590: 2929 290a 0a20 2020 2020 2020 2073 6574  )))..        set
-0001b5a0: 7570 5f6e 6574 5f74 7970 6528 290a 2020  up_net_type().  
-0001b5b0: 2020 2020 2020 6c6f 6164 5f6b 6579 7328        load_keys(
-0001b5c0: 290a 0a20 2020 2020 2020 2023 206e 6565  )..        # nee
-0001b5d0: 6465 6420 666f 7220 646f 636b 6572 206c  ded for docker l
-0001b5e0: 6f67 730a 2020 2020 2020 2020 6e6f 6465  ogs.        node
-0001b5f0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-0001b600: 7761 726e 696e 6728 6627 4368 6563 6b69  warning(f'Checki
-0001b610: 6e67 2048 6561 7679 3320 6669 6c65 2c20  ng Heavy3 file, 
-0001b620: 6361 6e20 7461 6b65 2075 7020 746f 2035  can take up to 5
-0001b630: 206d 696e 7574 6573 2e2e 2e27 290a 2020   minutes...').  
-0001b640: 2020 2020 2020 6d69 6e69 6e67 5f68 6561        mining_hea
-0001b650: 7679 332e 6d69 6e69 6e67 5f6f 7065 6e28  vy3.mining_open(
-0001b660: 6e6f 6465 2e68 6561 7679 335f 7061 7468  node.heavy3_path
-0001b670: 290a 2020 2020 2020 2020 6e6f 6465 2e6c  ).        node.l
-0001b680: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
-0001b690: 726e 696e 6728 6627 4865 6176 7933 2066  rning(f'Heavy3 f
-0001b6a0: 696c 6520 4f6b 2127 290a 0a20 2020 2020  ile Ok!')..     
-0001b6b0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0001b6c0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2866  pp_log.warning(f
-0001b6d0: 2753 7461 7475 733a 2053 7461 7274 696e  'Status: Startin
-0001b6e0: 6720 6e6f 6465 2076 6572 7369 6f6e 207b  g node version {
-0001b6f0: 5645 5253 494f 4e7d 2729 0a20 2020 2020  VERSION}').     
-0001b700: 2020 206e 6f64 652e 7374 6172 7475 705f     node.startup_
-0001b710: 7469 6d65 203d 2074 696d 652e 7469 6d65  time = time.time
-0001b720: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
-0001b730: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-0001b740: 652e 7065 6572 7320 3d20 7065 6572 7368  e.peers = peersh
-0001b750: 616e 646c 6572 2e50 6565 7273 286e 6f64  andler.Peers(nod
-0001b760: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-0001b770: 2c20 636f 6e66 6967 3d63 6f6e 6669 672c  , config=config,
-0001b780: 206e 6f64 653d 6e6f 6465 290a 0a20 2020   node=node)..   
-0001b790: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0001b7a0: 2870 6565 7273 2e70 6565 725f 6c69 7374  (peers.peer_list
-0001b7b0: 5f6f 6c64 5f66 6f72 6d61 7428 2929 0a20  _old_format()). 
-0001b7c0: 2020 2020 2020 2020 2020 2023 2073 7973             # sys
-0001b7d0: 2e65 7869 7428 290a 0a20 2020 2020 2020  .exit()..       
-0001b7e0: 2020 2020 206e 6f64 652e 6170 6968 616e       node.apihan
-0001b7f0: 646c 6572 203d 2061 7069 6861 6e64 6c65  dler = apihandle
-0001b800: 722e 4170 6948 616e 646c 6572 286e 6f64  r.ApiHandler(nod
-0001b810: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
-0001b820: 2c20 636f 6e66 6967 290a 2020 2020 2020  , config).      
-0001b830: 2020 2020 2020 6d70 2e4d 454d 504f 4f4c        mp.MEMPOOL
-0001b840: 203d 206d 702e 4d65 6d70 6f6f 6c28 6e6f   = mp.Mempool(no
-0001b850: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-0001b860: 672c 2063 6f6e 6669 672c 206e 6f64 652e  g, config, node.
-0001b870: 6462 5f6c 6f63 6b2c 206e 6f64 652e 6973  db_lock, node.is
-0001b880: 5f74 6573 746e 6574 2c20 7472 6163 655f  _testnet, trace_
-0001b890: 6462 5f63 616c 6c73 3d6e 6f64 652e 7472  db_calls=node.tr
-0001b8a0: 6163 655f 6462 5f63 616c 6c73 290a 0a20  ace_db_calls).. 
-0001b8b0: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0001b8c0: 5f69 6e74 6567 7269 7479 286e 6f64 652e  _integrity(node.
-0001b8d0: 6879 7065 725f 7061 7468 290a 2020 2020  hyper_path).    
-0001b8e0: 2020 2020 2020 2020 2350 4c41 4345 484f          #PLACEHO
-0001b8f0: 4c44 4552 2046 4f52 2046 5245 5348 2048  LDER FOR FRESH H
-0001b900: 5950 4552 424c 4f43 4b20 4255 494c 4445  YPERBLOCK BUILDE
-0001b910: 520a 0a20 2020 2020 2020 2020 2020 2023  R..            #
-0001b920: 2069 6620 6e6f 6465 2e72 6562 7569 6c64   if node.rebuild
-0001b930: 5f64 623a 2023 646f 6573 206e 6f74 6869  _db: #does nothi
-0001b940: 6e67 0a20 2020 2020 2020 2020 2020 2023  ng.            #
-0001b950: 2020 2020 6462 5f6d 6169 6e74 656e 616e      db_maintenan
-0001b960: 6365 2869 6e69 745f 6461 7461 6261 7365  ce(init_database
-0001b970: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0001b980: 2064 625f 6d61 6e61 6765 7220 3d20 6462   db_manager = db
-0001b990: 5f6c 6f6f 7065 722e 4462 4d61 6e61 6765  _looper.DbManage
-0001b9a0: 7228 6e6f 6465 2e6c 6f67 6765 722e 6170  r(node.logger.ap
-0001b9b0: 705f 6c6f 6729 0a20 2020 2020 2020 2020  p_log).         
-0001b9c0: 2020 2023 2064 625f 6d61 6e61 6765 722e     # db_manager.
-0001b9d0: 7374 6172 7428 290a 0a20 2020 2020 2020  start()..       
-0001b9e0: 2020 2020 2064 625f 6861 6e64 6c65 725f       db_handler_
-0001b9f0: 696e 6974 6961 6c20 3d20 6462 6861 6e64  initial = dbhand
-0001ba00: 6c65 722e 4462 4861 6e64 6c65 7228 6e6f  ler.DbHandler(no
-0001ba10: 6465 2e69 6e64 6578 5f64 622c 206e 6f64  de.index_db, nod
-0001ba20: 652e 6c65 6467 6572 5f70 6174 682c 206e  e.ledger_path, n
-0001ba30: 6f64 652e 6879 7065 725f 7061 7468 2c20  ode.hyper_path, 
-0001ba40: 6e6f 6465 2e72 616d 2c20 6e6f 6465 2e6c  node.ram, node.l
-0001ba50: 6564 6765 725f 7261 6d5f 6669 6c65 2c20  edger_ram_file, 
-0001ba60: 6e6f 6465 2e6c 6f67 6765 722c 2074 7261  node.logger, tra
-0001ba70: 6365 5f64 625f 6361 6c6c 733d 6e6f 6465  ce_db_calls=node
-0001ba80: 2e74 7261 6365 5f64 625f 6361 6c6c 7329  .trace_db_calls)
-0001ba90: 0a0a 2020 2020 2020 2020 2020 2020 6c65  ..            le
-0001baa0: 6467 6572 5f63 6865 636b 5f68 6569 6768  dger_check_heigh
-0001bab0: 7473 286e 6f64 652c 2064 625f 6861 6e64  ts(node, db_hand
-0001bac0: 6c65 725f 696e 6974 6961 6c29 0a0a 2020  ler_initial)..  
-0001bad0: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
-0001bae0: 652e 7265 636f 6d70 7265 7373 3a0a 2020  e.recompress:.  
-0001baf0: 2020 2020 2020 2020 2020 2020 2020 2374                #t
-0001bb00: 6f64 6f3a 2064 6f20 6e6f 7420 636c 6f73  odo: do not clos
-0001bb10: 6520 6461 7461 6261 7365 2061 6e64 206d  e database and m
-0001bb20: 6f76 6520 6669 6c65 732c 2073 7761 7020  ove files, swap 
-0001bb30: 7461 626c 6573 2069 6e73 7465 6164 0a20  tables instead. 
-0001bb40: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001bb50: 625f 6861 6e64 6c65 725f 696e 6974 6961  b_handler_initia
-0001bb60: 6c2e 636c 6f73 6528 290a 2020 2020 2020  l.close().      
-0001bb70: 2020 2020 2020 2020 2020 7265 636f 6d70            recomp
-0001bb80: 7265 7373 5f6c 6564 6765 7228 6e6f 6465  ress_ledger(node
-0001bb90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001bba0: 2020 6462 5f68 616e 646c 6572 5f69 6e69    db_handler_ini
-0001bbb0: 7469 616c 203d 2064 6268 616e 646c 6572  tial = dbhandler
-0001bbc0: 2e44 6248 616e 646c 6572 286e 6f64 652e  .DbHandler(node.
-0001bbd0: 696e 6465 785f 6462 2c20 6e6f 6465 2e6c  index_db, node.l
-0001bbe0: 6564 6765 725f 7061 7468 2c20 6e6f 6465  edger_path, node
-0001bbf0: 2e68 7970 6572 5f70 6174 682c 206e 6f64  .hyper_path, nod
-0001bc00: 652e 7261 6d2c 206e 6f64 652e 6c65 6467  e.ram, node.ledg
-0001bc10: 6572 5f72 616d 5f66 696c 652c 206e 6f64  er_ram_file, nod
-0001bc20: 652e 6c6f 6767 6572 2c20 7472 6163 655f  e.logger, trace_
-0001bc30: 6462 5f63 616c 6c73 3d6e 6f64 652e 7472  db_calls=node.tr
-0001bc40: 6163 655f 6462 5f63 616c 6c73 290a 0a20  ace_db_calls).. 
-0001bc50: 2020 2020 2020 2020 2020 2072 616d 5f69             ram_i
-0001bc60: 6e69 7428 6462 5f68 616e 646c 6572 5f69  nit(db_handler_i
-0001bc70: 6e69 7469 616c 290a 2020 2020 2020 2020  nitial).        
-0001bc80: 2020 2020 6e6f 6465 5f62 6c6f 636b 5f69      node_block_i
-0001bc90: 6e69 7428 6462 5f68 616e 646c 6572 5f69  nit(db_handler_i
-0001bca0: 6e69 7469 616c 290a 2020 2020 2020 2020  nitial).        
-0001bcb0: 2020 2020 696e 6974 6961 6c5f 6462 5f63      initial_db_c
-0001bcc0: 6865 636b 2829 0a0a 2020 2020 2020 2020  heck()..        
-0001bcd0: 2020 2020 6966 206e 6f74 206e 6f64 652e      if not node.
-0001bce0: 6973 5f72 6567 6e65 743a 0a20 2020 2020  is_regnet:.     
-0001bcf0: 2020 2020 2020 2020 2020 2073 6571 7565             seque
-0001bd00: 6e63 696e 675f 6368 6563 6b28 6462 5f68  ncing_check(db_h
-0001bd10: 616e 646c 6572 5f69 6e69 7469 616c 290a  andler_initial).
-0001bd20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001bd30: 6e6f 6465 2e76 6572 6966 793a 0a20 2020  node.verify:.   
-0001bd40: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-0001bd50: 6966 7928 6462 5f68 616e 646c 6572 5f69  ify(db_handler_i
-0001bd60: 6e69 7469 616c 290a 0a20 2020 2020 2020  nitial)..       
-0001bd70: 2020 2020 2061 6464 5f69 6e64 6963 6573       add_indices
-0001bd80: 2864 625f 6861 6e64 6c65 725f 696e 6974  (db_handler_init
-0001bd90: 6961 6c29 0a0a 2020 2020 2020 2020 2020  ial)..          
-0001bda0: 2020 2320 544f 444f 3a20 756e 7469 6c20    # TODO: until 
-0001bdb0: 6865 7265 2c20 7765 2061 7265 2069 6e20  here, we are in 
-0001bdc0: 7369 6e67 6c65 2075 7365 7220 6d6f 6465  single user mode
-0001bdd0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0001bde0: 416c 6c20 7468 6520 6162 6f76 6520 676f  All the above go
-0001bdf0: 6573 2069 6e74 6f20 6120 2262 6f6f 7475  es into a "bootu
-0001be00: 7022 2066 756e 6374 696f 6e2c 2077 6974  p" function, wit
-0001be10: 6820 6d65 7468 6f64 7320 6672 6f6d 2073  h methods from s
-0001be20: 696e 676c 655f 7573 6572 206d 6f64 756c  ingle_user modul
-0001be30: 6520 6f6e 6c79 2e0a 0a20 2020 2020 2020  e only...       
-0001be40: 2020 2020 2069 6620 6e6f 7420 6e6f 6465       if not node
-0001be50: 2e74 6f72 3a0a 2020 2020 2020 2020 2020  .tor:.          
-0001be60: 2020 2020 2020 2320 506f 7274 2030 206d        # Port 0 m
-0001be70: 6561 6e73 2074 6f20 7365 6c65 6374 2061  eans to select a
-0001be80: 6e20 6172 6269 7472 6172 7920 756e 7573  n arbitrary unus
-0001be90: 6564 2070 6f72 740a 2020 2020 2020 2020  ed port.        
-0001bea0: 2020 2020 2020 2020 686f 7374 2c20 706f          host, po
-0001beb0: 7274 203d 2027 302e 302e 302e 3027 2c20  rt = '0.0.0.0', 
-0001bec0: 696e 7428 6e6f 6465 2e70 6f72 7429 0a0a  int(node.port)..
-0001bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bee0: 5468 7265 6164 6564 5443 5053 6572 7665  ThreadedTCPServe
-0001bef0: 722e 616c 6c6f 775f 7265 7573 655f 6164  r.allow_reuse_ad
-0001bf00: 6472 6573 7320 3d20 5472 7565 0a20 2020  dress = True.   
-0001bf10: 2020 2020 2020 2020 2020 2020 2054 6872               Thr
-0001bf20: 6561 6465 6454 4350 5365 7276 6572 2e64  eadedTCPServer.d
-0001bf30: 6165 6d6f 6e5f 7468 7265 6164 7320 3d20  aemon_threads = 
-0001bf40: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001bf50: 2020 2020 2054 6872 6561 6465 6454 4350       ThreadedTCP
-0001bf60: 5365 7276 6572 2e74 696d 656f 7574 203d  Server.timeout =
-0001bf70: 2036 300a 2020 2020 2020 2020 2020 2020   60.            
-0001bf80: 2020 2020 5468 7265 6164 6564 5443 5053      ThreadedTCPS
-0001bf90: 6572 7665 722e 7265 7175 6573 745f 7175  erver.request_qu
-0001bfa0: 6575 655f 7369 7a65 203d 2031 3030 0a0a  eue_size = 100..
-0001bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfc0: 7365 7276 6572 203d 2054 6872 6561 6465  server = Threade
-0001bfd0: 6454 4350 5365 7276 6572 2828 686f 7374  dTCPServer((host
-0001bfe0: 2c20 706f 7274 292c 2054 6872 6561 6465  , port), Threade
-0001bff0: 6454 4350 5265 7175 6573 7448 616e 646c  dTCPRequestHandl
-0001c000: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-0001c010: 2020 2020 6970 2c20 6e6f 6465 2e70 6f72      ip, node.por
-0001c020: 7420 3d20 7365 7276 6572 2e73 6572 7665  t = server.serve
-0001c030: 725f 6164 6472 6573 730a 0a20 2020 2020  r_address..     
-0001c040: 2020 2020 2020 2020 2020 2023 2053 7461             # Sta
-0001c050: 7274 2061 2074 6872 6561 6420 7769 7468  rt a thread with
-0001c060: 2074 6865 2073 6572 7665 7220 2d2d 2074   the server -- t
-0001c070: 6861 7420 7468 7265 6164 2077 696c 6c20  hat thread will 
-0001c080: 7468 656e 2073 7461 7274 206f 6e65 0a20  then start one. 
-0001c090: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001c0a0: 206d 6f72 6520 7468 7265 6164 2066 6f72   more thread for
-0001c0b0: 2065 6163 6820 7265 7175 6573 740a 0a20   each request.. 
-0001c0c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c0d0: 6572 7665 725f 7468 7265 6164 203d 2074  erver_thread = t
-0001c0e0: 6872 6561 6469 6e67 2e54 6872 6561 6428  hreading.Thread(
-0001c0f0: 7461 7267 6574 3d73 6572 7665 722e 7365  target=server.se
-0001c100: 7276 655f 666f 7265 7665 7229 0a20 2020  rve_forever).   
-0001c110: 2020 2020 2020 2020 2020 2020 2073 6572               ser
-0001c120: 7665 725f 7468 7265 6164 2e64 6165 6d6f  ver_thread.daemo
-0001c130: 6e20 3d20 5472 7565 0a20 2020 2020 2020  n = True.       
-0001c140: 2020 2020 2020 2020 2073 6572 7665 725f           server_
-0001c150: 7468 7265 6164 2e73 7461 7274 2829 0a0a  thread.start()..
-0001c160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c170: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
-0001c180: 6c6f 672e 7761 726e 696e 6728 6627 5374  log.warning(f'St
-0001c190: 6174 7573 3a20 5365 7276 6572 206c 6f6f  atus: Server loo
-0001c1a0: 7020 7275 6e6e 696e 6720 6f6e 207b 6970  p running on {ip
-0001c1b0: 7d3a 7b6e 6f64 652e 706f 7274 7d27 290a  }:{node.port}').
-0001c1c0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001c1d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001c1e0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
-0001c1f0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
-0001c200: 5374 6174 7573 3a20 4e6f 7420 7374 6172  Status: Not star
-0001c210: 7469 6e67 2061 206c 6f63 616c 2073 6572  ting a local ser
-0001c220: 7665 7220 746f 2063 6f6e 6365 616c 2069  ver to conceal i
-0001c230: 6465 6e74 6974 7920 6f6e 2054 6f72 206e  dentity on Tor n
-0001c240: 6574 776f 726b 2729 0a0a 2020 2020 2020  etwork')..      
-0001c250: 2020 2020 2020 2320 7374 6172 7420 636f        # start co
-0001c260: 6e6e 6563 7469 6f6e 206d 616e 6167 6572  nnection manager
-0001c270: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0001c280: 6e65 6374 696f 6e5f 6d61 6e61 6765 7220  nection_manager 
-0001c290: 3d20 636f 6e6e 6563 7469 6f6e 6d61 6e61  = connectionmana
-0001c2a0: 6765 722e 436f 6e6e 6563 7469 6f6e 4d61  ger.ConnectionMa
-0001c2b0: 6e61 6765 7228 6e6f 6465 2c20 6d70 290a  nager(node, mp).
-0001c2c0: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
-0001c2d0: 6563 7469 6f6e 5f6d 616e 6167 6572 2e73  ection_manager.s
-0001c2e0: 7461 7274 2829 0a20 2020 2020 2020 2020  tart().         
-0001c2f0: 2020 2023 2073 7461 7274 2063 6f6e 6e65     # start conne
-0001c300: 6374 696f 6e20 6d61 6e61 6765 720a 0a20  ction manager.. 
-0001c310: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0001c320: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0001c330: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
-0001c340: 6f67 6765 722e 6170 705f 6c6f 672e 696e  ogger.app_log.in
-0001c350: 666f 2865 290a 2020 2020 2020 2020 2020  fo(e).          
-0001c360: 2020 7261 6973 650a 0a20 2020 2065 7863    raise..    exc
-0001c370: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0001c380: 2065 3a0a 2020 2020 2020 2020 6e6f 6465   e:.        node
-0001c390: 2e6c 6f67 6765 722e 6170 705f 6c6f 672e  .logger.app_log.
-0001c3a0: 696e 666f 2865 290a 2020 2020 2020 2020  info(e).        
-0001c3b0: 7261 6973 650a 0a20 2020 206e 6f64 652e  raise..    node.
-0001c3c0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-0001c3d0: 6172 6e69 6e67 2827 5374 6174 7573 3a20  arning('Status: 
-0001c3e0: 4269 736d 7574 6820 6c6f 6f70 2072 756e  Bismuth loop run
-0001c3f0: 6e69 6e67 2e27 290a 0a20 2020 2077 6869  ning.')..    whi
-0001c400: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
-0001c410: 2069 6620 6e6f 6465 2e49 535f 5354 4f50   if node.IS_STOP
-0001c420: 5049 4e47 3a0a 2020 2020 2020 2020 2020  PING:.          
-0001c430: 2020 6966 206e 6f64 652e 6462 5f6c 6f63    if node.db_loc
-0001c440: 6b2e 6c6f 636b 6564 2829 3a0a 2020 2020  k.locked():.    
-0001c450: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0001c460: 2e73 6c65 6570 2830 2e35 290a 2020 2020  .sleep(0.5).    
-0001c470: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001c480: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0001c490: 6e69 6e67 5f68 6561 7679 332e 6d69 6e69  ning_heavy3.mini
-0001c4a0: 6e67 5f63 6c6f 7365 2829 0a20 2020 2020  ng_close().     
-0001c4b0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
-0001c4c0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
-0001c4d0: 6172 6e69 6e67 2827 5374 6174 7573 3a20  arning('Status: 
-0001c4e0: 5365 6375 7265 6c79 2064 6973 636f 6e6e  Securely disconn
-0001c4f0: 6563 7465 6420 6d61 696e 2070 726f 6365  ected main proce
-0001c500: 7373 6573 2c20 7375 6270 726f 6365 7373  sses, subprocess
-0001c510: 2074 6572 6d69 6e61 7469 6f6e 2069 6e20   termination in 
-0001c520: 7072 6f67 7265 7373 2e27 290a 2020 2020  progress.').    
-0001c530: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0001c540: 6b0a 2020 2020 2020 2020 7469 6d65 2e73  k.        time.s
-0001c550: 6c65 6570 2830 2e31 290a 2020 2020 6e6f  leep(0.1).    no
-0001c560: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
-0001c570: 672e 7761 726e 696e 6728 2753 7461 7475  g.warning('Statu
-0001c580: 733a 2043 6c65 616e 2053 746f 7027 290a  s: Clean Stop').
+0001a280: 2020 2020 6f73 2e72 656d 6f76 6528 6669      os.remove(fi
+0001a290: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+0001a2a0: 2020 2020 2020 2020 7072 696e 7428 6669          print(fi
+0001a2b0: 6c65 2c20 2764 656c 6574 6564 2729 0a20  le, 'deleted'). 
+0001a2c0: 2020 2020 2020 2020 2020 2065 7373 656e             essen
+0001a2d0: 7469 616c 732e 646f 776e 6c6f 6164 5f66  tials.download_f
+0001a2e0: 696c 6528 2768 7474 7073 3a2f 2f62 6973  ile('https://bis
+0001a2f0: 6d75 7468 2e63 7a2f 7465 7374 2e74 6172  muth.cz/test.tar
+0001a300: 2e67 7a27 2c20 2773 7461 7469 632f 7465  .gz', 'static/te
+0001a310: 7374 2e74 6172 2e67 7a27 290a 2020 2020  st.tar.gz').    
+0001a320: 2020 2020 2020 2020 7769 7468 2074 6172          with tar
+0001a330: 6669 6c65 2e6f 7065 6e28 2773 7461 7469  file.open('stati
+0001a340: 632f 7465 7374 2e74 6172 2e67 7a27 2920  c/test.tar.gz') 
+0001a350: 6173 2074 6172 3a0a 2020 2020 2020 2020  as tar:.        
+0001a360: 2020 2020 2020 2020 7461 722e 6578 7472          tar.extr
+0001a370: 6163 7461 6c6c 2827 7374 6174 6963 2f27  actall('static/'
+0001a380: 2920 2023 204e 4f54 2043 4f4d 5041 5449  )  # NOT COMPATI
+0001a390: 424c 4520 5749 5448 2043 5553 544f 4d20  BLE WITH CUSTOM 
+0001a3a0: 5041 5448 2043 4f4e 4653 0a20 2020 2020  PATH CONFS.     
+0001a3b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001a3c0: 2020 2020 2070 7269 6e74 2827 4e6f 7420       print('Not 
+0001a3d0: 7265 646f 776e 6c6f 6164 696e 6720 7465  redownloading te
+0001a3e0: 7374 2064 6227 290a 0a20 2020 2069 6620  st db')..    if 
+0001a3f0: 2772 6567 6e65 7427 2069 6e20 6e6f 6465  'regnet' in node
+0001a400: 2e76 6572 7369 6f6e 206f 7220 6e6f 6465  .version or node
+0001a410: 2e69 735f 7265 676e 6574 3a0a 2020 2020  .is_regnet:.    
+0001a420: 2020 2020 6e6f 6465 2e70 6f72 7420 3d20      node.port = 
+0001a430: 7265 676e 6574 2e52 4547 4e45 545f 504f  regnet.REGNET_PO
+0001a440: 5254 0a20 2020 2020 2020 206e 6f64 652e  RT.        node.
+0001a450: 6879 7065 725f 7061 7468 203d 2072 6567  hyper_path = reg
+0001a460: 6e65 742e 5245 474e 4554 5f44 420a 2020  net.REGNET_DB.  
+0001a470: 2020 2020 2020 6e6f 6465 2e6c 6564 6765        node.ledge
+0001a480: 725f 7061 7468 203d 2072 6567 6e65 742e  r_path = regnet.
+0001a490: 5245 474e 4554 5f44 420a 2020 2020 2020  REGNET_DB.      
+0001a4a0: 2020 6e6f 6465 2e6c 6564 6765 725f 7261    node.ledger_ra
+0001a4b0: 6d5f 6669 6c65 203d 2027 6669 6c65 3a6c  m_file = 'file:l
+0001a4c0: 6564 6765 725f 7265 676e 6574 3f6d 6f64  edger_regnet?mod
+0001a4d0: 653d 6d65 6d6f 7279 2663 6163 6865 3d73  e=memory&cache=s
+0001a4e0: 6861 7265 6427 0a20 2020 2020 2020 206e  hared'.        n
+0001a4f0: 6f64 652e 6879 7065 725f 7265 636f 6d70  ode.hyper_recomp
+0001a500: 7265 7373 203d 2046 616c 7365 0a20 2020  ress = False.   
+0001a510: 2020 2020 206e 6f64 652e 7065 6572 6669       node.peerfi
+0001a520: 6c65 203d 2072 6567 6e65 742e 5245 474e  le = regnet.REGN
+0001a530: 4554 5f50 4545 5253 0a20 2020 2020 2020  ET_PEERS.       
+0001a540: 206e 6f64 652e 696e 6465 785f 6462 203d   node.index_db =
+0001a550: 2072 6567 6e65 742e 5245 474e 4554 5f49   regnet.REGNET_I
+0001a560: 4e44 4558 0a20 2020 2020 2020 2069 6620  NDEX.        if 
+0001a570: 6e6f 7420 2772 6567 6e65 7427 2069 6e20  not 'regnet' in 
+0001a580: 6e6f 6465 2e76 6572 7369 6f6e 3a0a 2020  node.version:.  
+0001a590: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+0001a5a0: 6f67 6765 722e 6170 705f 6c6f 672e 6572  ogger.app_log.er
+0001a5b0: 726f 7228 2742 6164 2072 6567 6e65 7420  ror('Bad regnet 
+0001a5c0: 7665 7273 696f 6e2c 2063 6865 636b 2063  version, check c
+0001a5d0: 6f6e 6669 672e 7478 7427 290a 2020 2020  onfig.txt').    
+0001a5e0: 2020 2020 2020 2020 7379 732e 6578 6974          sys.exit
+0001a5f0: 2829 0a20 2020 2020 2020 2069 6620 6e6f  ().        if no
+0001a600: 7420 6e6f 6465 2e68 6561 7679 3a0a 2020  t node.heavy:.  
+0001a610: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+0001a620: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+0001a630: 726e 696e 6728 2752 6567 6e65 7420 7769  rning('Regnet wi
+0001a640: 7468 206e 6f20 6865 6176 7920 6669 6c65  th no heavy file
+0001a650: 2e2e 2e27 290a 2020 2020 2020 2020 2020  ...').          
+0001a660: 2020 6d69 6e69 6e67 5f68 6561 7679 332e    mining_heavy3.
+0001a670: 6865 6176 7920 3d20 4661 6c73 650a 2020  heavy = False.  
+0001a680: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+0001a690: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+0001a6a0: 6728 2752 6567 6e65 7420 696e 6974 2e2e  g('Regnet init..
+0001a6b0: 2e27 290a 2020 2020 2020 2020 7265 676e  .').        regn
+0001a6c0: 6574 2e69 6e69 7428 6e6f 6465 2e6c 6f67  et.init(node.log
+0001a6d0: 6765 722e 6170 705f 6c6f 6729 0a20 2020  ger.app_log).   
+0001a6e0: 2020 2020 2072 6567 6e65 742e 4449 4745       regnet.DIGE
+0001a6f0: 5354 5f42 4c4f 434b 203d 2064 6967 6573  ST_BLOCK = diges
+0001a700: 745f 626c 6f63 6b0a 2020 2020 2020 2020  t_block.        
+0001a710: 6d69 6e69 6e67 5f68 6561 7679 332e 6973  mining_heavy3.is
+0001a720: 5f72 6567 6e65 7420 3d20 5472 7565 0a20  _regnet = True. 
+0001a730: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001a740: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0001a750: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2822  pp_log.warning("
+0001a760: 5265 676e 6574 2073 7469 6c6c 2069 7320  Regnet still is 
+0001a770: 5749 5020 6174 6d2e 2229 0a20 2020 2020  WIP atm.").     
+0001a780: 2020 2073 7973 2e65 7869 7428 290a 2020     sys.exit().  
+0001a790: 2020 2020 2020 2222 220a 0a0a 6465 6620        """...def 
+0001a7a0: 6e6f 6465 5f62 6c6f 636b 5f69 6e69 7428  node_block_init(
+0001a7b0: 6461 7461 6261 7365 293a 0a20 2020 2067  database):.    g
+0001a7c0: 6c6f 6261 6c20 6462 5f68 616e 646c 6572  lobal db_handler
+0001a7d0: 5f69 6e69 7469 616c 0a20 2020 2023 2054  _initial.    # T
+0001a7e0: 4f44 4f3a 2063 616e 6469 6461 7465 2066  ODO: candidate f
+0001a7f0: 6f72 2073 696e 676c 6520 7573 6572 206d  or single user m
+0001a800: 6f64 650a 2020 2020 6e6f 6465 2e68 6464  ode.    node.hdd
+0001a810: 5f62 6c6f 636b 203d 2064 6174 6162 6173  _block = databas
+0001a820: 652e 626c 6f63 6b5f 6865 6967 6874 5f6d  e.block_height_m
+0001a830: 6178 2829 0a20 2020 206e 6f64 652e 6469  ax().    node.di
+0001a840: 6666 6963 756c 7479 203d 2064 6966 6669  fficulty = diffi
+0001a850: 6375 6c74 7928 6e6f 6465 2c20 6462 5f68  culty(node, db_h
+0001a860: 616e 646c 6572 5f69 6e69 7469 616c 2920  andler_initial) 
+0001a870: 2023 2063 6865 636b 2064 6966 6620 666f   # check diff fo
+0001a880: 7220 6d69 6e65 720a 0a20 2020 206e 6f64  r miner..    nod
+0001a890: 652e 6c61 7374 5f62 6c6f 636b 203d 206e  e.last_block = n
+0001a8a0: 6f64 652e 6864 645f 626c 6f63 6b20 2023  ode.hdd_block  #
+0001a8b0: 2072 616d 2065 7175 616c 7320 6472 6976   ram equals driv
+0001a8c0: 6520 6174 2074 6869 7320 706f 696e 740a  e at this point.
+0001a8d0: 0a20 2020 206e 6f64 652e 6c61 7374 5f62  .    node.last_b
+0001a8e0: 6c6f 636b 5f68 6173 6820 3d20 6461 7461  lock_hash = data
+0001a8f0: 6261 7365 2e6c 6173 745f 626c 6f63 6b5f  base.last_block_
+0001a900: 6861 7368 2829 0a20 2020 206e 6f64 652e  hash().    node.
+0001a910: 6864 645f 6861 7368 203d 206e 6f64 652e  hdd_hash = node.
+0001a920: 6c61 7374 5f62 6c6f 636b 5f68 6173 6820  last_block_hash 
+0001a930: 2023 2072 616d 2065 7175 616c 7320 6472   # ram equals dr
+0001a940: 6976 6520 6174 2074 6869 7320 706f 696e  ive at this poin
+0001a950: 740a 0a20 2020 206e 6f64 652e 6c61 7374  t..    node.last
+0001a960: 5f62 6c6f 636b 5f74 696d 6573 7461 6d70  _block_timestamp
+0001a970: 203d 2064 6174 6162 6173 652e 6c61 7374   = database.last
+0001a980: 5f62 6c6f 636b 5f74 696d 6573 7461 6d70  _block_timestamp
+0001a990: 2829 0a0a 2020 2020 6573 7365 6e74 6961  ()..    essentia
+0001a9a0: 6c73 2e63 6865 636b 706f 696e 745f 7365  ls.checkpoint_se
+0001a9b0: 7428 6e6f 6465 290a 0a20 2020 206e 6f64  t(node)..    nod
+0001a9c0: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0001a9d0: 2e77 6172 6e69 6e67 2827 5374 6174 7573  .warning('Status
+0001a9e0: 3a20 496e 6465 7869 6e67 2061 6c69 6173  : Indexing alias
+0001a9f0: 6573 2729 0a0a 2020 2020 616c 6961 7365  es')..    aliase
+0001aa00: 732e 616c 6961 7365 735f 7570 6461 7465  s.aliases_update
+0001aa10: 286e 6f64 652c 2064 6174 6162 6173 6529  (node, database)
+0001aa20: 0a0a 0a64 6566 2072 616d 5f69 6e69 7428  ...def ram_init(
+0001aa30: 6461 7461 6261 7365 293a 0a20 2020 2023  database):.    #
+0001aa40: 2054 4f44 4f3a 2063 616e 6469 6461 7465   TODO: candidate
+0001aa50: 2066 6f72 2073 696e 676c 6520 7573 6572   for single user
+0001aa60: 206d 6f64 650a 2020 2020 7472 793a 0a20   mode.    try:. 
+0001aa70: 2020 2020 2020 2069 6620 6e6f 6465 2e72         if node.r
+0001aa80: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
+0001aa90: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0001aaa0: 6c6f 672e 7761 726e 696e 6728 2753 7461  log.warning('Sta
+0001aab0: 7475 733a 204d 6f76 696e 6720 6461 7461  tus: Moving data
+0001aac0: 6261 7365 2074 6f20 5241 4d27 290a 0a20  base to RAM').. 
+0001aad0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001aae0: 6465 2e70 795f 7665 7273 696f 6e20 3e3d  de.py_version >=
+0001aaf0: 2033 3730 3a0a 2020 2020 2020 2020 2020   370:.          
+0001ab00: 2020 2020 2020 7465 6d70 5f74 6172 6765        temp_targe
+0001ab10: 7420 3d20 7371 6c69 7465 332e 636f 6e6e  t = sqlite3.conn
+0001ab20: 6563 7428 6e6f 6465 2e6c 6564 6765 725f  ect(node.ledger_
+0001ab30: 7261 6d5f 6669 6c65 2c20 7572 693d 5472  ram_file, uri=Tr
+0001ab40: 7565 2c20 6973 6f6c 6174 696f 6e5f 6c65  ue, isolation_le
+0001ab50: 7665 6c3d 4e6f 6e65 2c20 7469 6d65 6f75  vel=None, timeou
+0001ab60: 743d 3129 0a20 2020 2020 2020 2020 2020  t=1).           
+0001ab70: 2020 2020 2069 6620 6e6f 6465 2e74 7261       if node.tra
+0001ab80: 6365 5f64 625f 6361 6c6c 733a 0a20 2020  ce_db_calls:.   
+0001ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aba0: 2074 656d 705f 7461 7267 6574 2e73 6574   temp_target.set
+0001abb0: 5f74 7261 6365 5f63 616c 6c62 6163 6b28  _trace_callback(
+0001abc0: 6675 6e63 746f 6f6c 732e 7061 7274 6961  functools.partia
+0001abd0: 6c28 7371 6c5f 7472 6163 655f 6361 6c6c  l(sql_trace_call
+0001abe0: 6261 636b 2c20 6e6f 6465 2e6c 6f67 6765  back, node.logge
+0001abf0: 722e 6170 705f 6c6f 672c 2027 5445 4d50  r.app_log, 'TEMP
+0001ac00: 2d54 4152 4745 5427 2929 0a0a 2020 2020  -TARGET'))..    
+0001ac10: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0001ac20: 5f73 6f75 7263 6520 3d20 7371 6c69 7465  _source = sqlite
+0001ac30: 332e 636f 6e6e 6563 7428 6e6f 6465 2e68  3.connect(node.h
+0001ac40: 7970 6572 5f70 6174 682c 2075 7269 3d54  yper_path, uri=T
+0001ac50: 7275 652c 2069 736f 6c61 7469 6f6e 5f6c  rue, isolation_l
+0001ac60: 6576 656c 3d4e 6f6e 652c 2074 696d 656f  evel=None, timeo
+0001ac70: 7574 3d31 290a 2020 2020 2020 2020 2020  ut=1).          
+0001ac80: 2020 2020 2020 6966 206e 6f64 652e 7472        if node.tr
+0001ac90: 6163 655f 6462 5f63 616c 6c73 3a0a 2020  ace_db_calls:.  
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acb0: 2020 7465 6d70 5f73 6f75 7263 652e 7365    temp_source.se
+0001acc0: 745f 7472 6163 655f 6361 6c6c 6261 636b  t_trace_callback
+0001acd0: 2866 756e 6374 6f6f 6c73 2e70 6172 7469  (functools.parti
+0001ace0: 616c 2873 716c 5f74 7261 6365 5f63 616c  al(sql_trace_cal
+0001acf0: 6c62 6163 6b2c 206e 6f64 652e 6c6f 6767  lback, node.logg
+0001ad00: 6572 2e61 7070 5f6c 6f67 2c20 2754 454d  er.app_log, 'TEM
+0001ad10: 502d 534f 5552 4345 2729 290a 2020 2020  P-SOURCE')).    
+0001ad20: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0001ad30: 5f73 6f75 7263 652e 6261 636b 7570 2874  _source.backup(t
+0001ad40: 656d 705f 7461 7267 6574 290a 2020 2020  emp_target).    
+0001ad50: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0001ad60: 5f73 6f75 7263 652e 636c 6f73 6528 290a  _source.close().
+0001ad70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001ad80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001ad90: 2020 2073 6f75 7263 655f 6462 203d 2073     source_db = s
+0001ada0: 716c 6974 6533 2e63 6f6e 6e65 6374 286e  qlite3.connect(n
+0001adb0: 6f64 652e 6879 7065 725f 7061 7468 2c20  ode.hyper_path, 
+0001adc0: 7469 6d65 6f75 743d 3129 0a20 2020 2020  timeout=1).     
+0001add0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001ade0: 6465 2e74 7261 6365 5f64 625f 6361 6c6c  de.trace_db_call
+0001adf0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001ae00: 2020 2020 2020 2073 6f75 7263 655f 6462         source_db
+0001ae10: 2e73 6574 5f74 7261 6365 5f63 616c 6c62  .set_trace_callb
+0001ae20: 6163 6b28 6675 6e63 746f 6f6c 732e 7061  ack(functools.pa
+0001ae30: 7274 6961 6c28 7371 6c5f 7472 6163 655f  rtial(sql_trace_
+0001ae40: 6361 6c6c 6261 636b 2c20 6e6f 6465 2e6c  callback, node.l
+0001ae50: 6f67 6765 722e 6170 705f 6c6f 672c 2027  ogger.app_log, '
+0001ae60: 534f 5552 4345 2d44 4227 2929 0a20 2020  SOURCE-DB')).   
+0001ae70: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0001ae80: 6162 6173 652e 746f 5f72 616d 203d 2073  abase.to_ram = s
+0001ae90: 716c 6974 6533 2e63 6f6e 6e65 6374 286e  qlite3.connect(n
+0001aea0: 6f64 652e 6c65 6467 6572 5f72 616d 5f66  ode.ledger_ram_f
+0001aeb0: 696c 652c 2075 7269 3d54 7275 652c 2074  ile, uri=True, t
+0001aec0: 696d 656f 7574 3d31 2c20 6973 6f6c 6174  imeout=1, isolat
+0001aed0: 696f 6e5f 6c65 7665 6c3d 4e6f 6e65 290a  ion_level=None).
+0001aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aef0: 6966 206e 6f64 652e 7472 6163 655f 6462  if node.trace_db
+0001af00: 5f63 616c 6c73 3a0a 2020 2020 2020 2020  _calls:.        
+0001af10: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0001af20: 6261 7365 2e74 6f5f 7261 6d2e 7365 745f  base.to_ram.set_
+0001af30: 7472 6163 655f 6361 6c6c 6261 636b 2866  trace_callback(f
+0001af40: 756e 6374 6f6f 6c73 2e70 6172 7469 616c  unctools.partial
+0001af50: 2873 716c 5f74 7261 6365 5f63 616c 6c62  (sql_trace_callb
+0001af60: 6163 6b2c 206e 6f64 652e 6c6f 6767 6572  ack, node.logger
+0001af70: 2e61 7070 5f6c 6f67 2c20 2744 4154 4142  .app_log, 'DATAB
+0001af80: 4153 452d 544f 2d52 414d 2729 290a 2020  ASE-TO-RAM')).  
+0001af90: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0001afa0: 7461 6261 7365 2e74 6f5f 7261 6d2e 7465  tabase.to_ram.te
+0001afb0: 7874 5f66 6163 746f 7279 203d 2073 7472  xt_factory = str
+0001afc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001afd0: 2064 6174 6162 6173 652e 7472 203d 2064   database.tr = d
+0001afe0: 6174 6162 6173 652e 746f 5f72 616d 2e63  atabase.to_ram.c
+0001aff0: 7572 736f 7228 290a 0a20 2020 2020 2020  ursor()..       
+0001b000: 2020 2020 2020 2020 2071 7565 7279 203d           query =
+0001b010: 2027 272e 6a6f 696e 286c 696e 6520 666f   ''.join(line fo
+0001b020: 7220 6c69 6e65 2069 6e20 736f 7572 6365  r line in source
+0001b030: 5f64 622e 6974 6572 6475 6d70 2829 290a  _db.iterdump()).
+0001b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b050: 6461 7461 6261 7365 2e74 6f5f 7261 6d2e  database.to_ram.
+0001b060: 6578 6563 7574 6573 6372 6970 7428 7175  executescript(qu
+0001b070: 6572 7929 0a20 2020 2020 2020 2020 2020  ery).           
+0001b080: 2020 2020 2073 6f75 7263 655f 6462 2e63       source_db.c
+0001b090: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
+0001b0a0: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0001b0b0: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+0001b0c0: 2753 7461 7475 733a 2048 7970 6572 626c  'Status: Hyperbl
+0001b0d0: 6f63 6b20 6c65 6467 6572 206d 6f76 6564  ock ledger moved
+0001b0e0: 2074 6f20 5241 4d27 290a 0a20 2020 2020   to RAM')..     
+0001b0f0: 2020 2020 2020 2023 736f 7572 6365 203d         #source =
+0001b100: 2073 716c 6974 6533 2e63 6f6e 6e65 6374   sqlite3.connect
+0001b110: 2827 6578 6973 7469 6e67 5f64 622e 6462  ('existing_db.db
+0001b120: 2729 0a20 2020 2020 2020 2020 2020 2023  ').            #
+0001b130: 6465 7374 203d 2073 716c 6974 6533 2e63  dest = sqlite3.c
+0001b140: 6f6e 6e65 6374 2827 3a6d 656d 6f72 793a  onnect(':memory:
+0001b150: 2729 0a20 2020 2020 2020 2020 2020 2023  ').            #
+0001b160: 736f 7572 6365 2e62 6163 6b75 7028 6465  source.backup(de
+0001b170: 7374 290a 0a20 2020 2065 7863 6570 7420  st)..    except 
+0001b180: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0001b190: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+0001b1a0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
+0001b1b0: 696e 6728 6529 0a20 2020 2020 2020 2072  ing(e).        r
+0001b1c0: 6169 7365 0a0a 0a64 6566 2069 6e69 7469  aise...def initi
+0001b1d0: 616c 5f64 625f 6368 6563 6b28 293a 0a20  al_db_check():. 
+0001b1e0: 2020 2022 2222 0a20 2020 2049 6e69 7469     """.    Initi
+0001b1f0: 616c 2062 6f6f 7473 7472 6170 2063 6865  al bootstrap che
+0001b200: 636b 2061 6e64 2063 6861 696e 2076 616c  ck and chain val
+0001b210: 6964 6974 7920 636f 6e74 726f 6c0a 2020  idity control.  
+0001b220: 2020 2222 220a 2020 2020 2320 544f 444f    """.    # TODO
+0001b230: 3a20 6361 6e64 6964 6174 6520 666f 7220  : candidate for 
+0001b240: 7369 6e67 6c65 2075 7365 7220 6d6f 6465  single user mode
+0001b250: 0a20 2020 2023 2066 6f72 6365 2062 6f6f  .    # force boo
+0001b260: 7473 7472 6170 2076 6961 2061 6464 696e  tstrap via addin
+0001b270: 6720 616e 2065 6d70 7479 2022 6672 6573  g an empty "fres
+0001b280: 685f 7379 6e63 2220 6669 6c65 2069 6e20  h_sync" file in 
+0001b290: 7468 6520 6469 722e 0a20 2020 2069 6620  the dir..    if 
+0001b2a0: 6f73 2e70 6174 682e 6578 6973 7473 2827  os.path.exists('
+0001b2b0: 6672 6573 685f 7379 6e63 2729 2061 6e64  fresh_sync') and
+0001b2c0: 206e 6f64 652e 6973 5f6d 6169 6e6e 6574   node.is_mainnet
+0001b2d0: 3a0a 2020 2020 2020 2020 6e6f 6465 2e6c  :.        node.l
+0001b2e0: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+0001b2f0: 726e 696e 6728 2753 7461 7475 733a 2046  rning('Status: F
+0001b300: 7265 7368 2073 796e 6320 7265 7175 6972  resh sync requir
+0001b310: 6564 2c20 626f 6f74 7374 7261 7070 696e  ed, bootstrappin
+0001b320: 6720 6672 6f6d 2074 6865 2077 6562 7369  g from the websi
+0001b330: 7465 2729 0a20 2020 2020 2020 206f 732e  te').        os.
+0001b340: 7265 6d6f 7665 2827 6672 6573 685f 7379  remove('fresh_sy
+0001b350: 6e63 2729 0a20 2020 2020 2020 2062 6f6f  nc').        boo
+0001b360: 7473 7472 6170 2829 0a20 2020 2023 2055  tstrap().    # U
+0001b370: 5044 4154 4520 6d61 696e 6e65 7420 4442  PDATE mainnet DB
+0001b380: 2069 6620 7265 7175 6972 6564 0a20 2020   if required.   
+0001b390: 2069 6620 6e6f 6465 2e69 735f 6d61 696e   if node.is_main
+0001b3a0: 6e65 743a 0a20 2020 2020 2020 2075 7067  net:.        upg
+0001b3b0: 7261 6465 203d 2073 716c 6974 6533 2e63  rade = sqlite3.c
+0001b3c0: 6f6e 6e65 6374 286e 6f64 652e 6c65 6467  onnect(node.ledg
+0001b3d0: 6572 5f70 6174 682c 2074 696d 656f 7574  er_path, timeout
+0001b3e0: 3d31 290a 2020 2020 2020 2020 6966 206e  =1).        if n
+0001b3f0: 6f64 652e 7472 6163 655f 6462 5f63 616c  ode.trace_db_cal
+0001b400: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0001b410: 7570 6772 6164 652e 7365 745f 7472 6163  upgrade.set_trac
+0001b420: 655f 6361 6c6c 6261 636b 2866 756e 6374  e_callback(funct
+0001b430: 6f6f 6c73 2e70 6172 7469 616c 2873 716c  ools.partial(sql
+0001b440: 5f74 7261 6365 5f63 616c 6c62 6163 6b2c  _trace_callback,
+0001b450: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0001b460: 5f6c 6f67 2c20 2749 4e49 5449 414c 5f44  _log, 'INITIAL_D
+0001b470: 425f 4348 4543 4b27 2929 0a20 2020 2020  B_CHECK')).     
+0001b480: 2020 2075 203d 2075 7067 7261 6465 2e63     u = upgrade.c
+0001b490: 7572 736f 7228 290a 2020 2020 2020 2020  ursor().        
+0001b4a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001b4b0: 2075 2e65 7865 6375 7465 2827 5052 4147   u.execute('PRAG
+0001b4c0: 4d41 2074 6162 6c65 5f69 6e66 6f28 7472  MA table_info(tr
+0001b4d0: 616e 7361 6374 696f 6e73 293b 2729 0a20  ansactions);'). 
+0001b4e0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0001b4f0: 7420 3d20 752e 6665 7463 6861 6c6c 2829  t = u.fetchall()
+0001b500: 5b31 305d 5b32 5d0a 2020 2020 2020 2020  [10][2].        
+0001b510: 2020 2020 6966 2072 6573 756c 7420 213d      if result !=
+0001b520: 2027 5445 5854 273a 0a20 2020 2020 2020   'TEXT':.       
+0001b530: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0001b540: 616c 7565 4572 726f 7228 2744 6174 6162  alueError('Datab
+0001b550: 6173 6520 636f 6c75 6d6e 2074 7970 6520  ase column type 
+0001b560: 6f75 7464 6174 6564 2066 6f72 2043 6f6d  outdated for Com
+0001b570: 6d61 6e64 2066 6965 6c64 2729 0a20 2020  mand field').   
+0001b580: 2020 2020 2020 2020 2075 7067 7261 6465           upgrade
+0001b590: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+0001b5a0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0001b5b0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0001b5c0: 2020 2020 7072 696e 7428 6529 0a20 2020      print(e).   
+0001b5d0: 2020 2020 2020 2020 2075 7067 7261 6465           upgrade
+0001b5e0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+0001b5f0: 2020 2020 2070 7269 6e74 2827 4461 7461       print('Data
+0001b600: 6261 7365 206e 6565 6473 2075 7067 7261  base needs upgra
+0001b610: 6469 6e67 2c20 626f 6f74 7374 7261 7070  ding, bootstrapp
+0001b620: 696e 672e 2e2e 2729 0a20 2020 2020 2020  ing...').       
+0001b630: 2020 2020 2062 6f6f 7473 7472 6170 2829       bootstrap()
+0001b640: 0a0a 0a64 6566 206c 6f61 645f 6b65 7973  ...def load_keys
+0001b650: 2864 6174 615f 6469 723d 272e 272c 2077  (data_dir='.', w
+0001b660: 616c 6c65 745f 6669 6c65 6e61 6d65 3d27  allet_filename='
+0001b670: 7761 6c6c 6574 2e64 6572 2729 3a0a 2020  wallet.der'):.  
+0001b680: 2020 2222 2249 6e69 7469 616c 206c 6f61    """Initial loa
+0001b690: 6469 6e67 206f 6620 6372 7970 746f 206b  ding of crypto k
+0001b6a0: 6579 7322 2222 0a20 2020 2023 2054 4f44  eys""".    # TOD
+0001b6b0: 4f3a 2063 616e 6469 6461 7465 2066 6f72  O: candidate for
+0001b6c0: 2073 696e 676c 6520 7573 6572 206d 6f64   single user mod
+0001b6d0: 650a 2020 2020 6573 7365 6e74 6961 6c73  e.    essentials
+0001b6e0: 2e6b 6579 735f 6368 6563 6b28 6e6f 6465  .keys_check(node
+0001b6f0: 2e6c 6f67 6765 722e 6170 705f 6c6f 672c  .logger.app_log,
+0001b700: 2077 616c 6c65 745f 6669 6c65 6e61 6d65   wallet_filename
+0001b710: 2c20 6461 7461 5f64 6972 3d64 6174 615f  , data_dir=data_
+0001b720: 6469 7229 0a0a 2020 2020 6e6f 6465 2e6b  dir)..    node.k
+0001b730: 6579 732e 6b65 792c 206e 6f64 652e 6b65  eys.key, node.ke
+0001b740: 7973 2e70 7562 6c69 635f 6b65 795f 7265  ys.public_key_re
+0001b750: 6164 6162 6c65 2c20 6e6f 6465 2e6b 6579  adable, node.key
+0001b760: 732e 7072 6976 6174 655f 6b65 795f 7265  s.private_key_re
+0001b770: 6164 6162 6c65 2c20 5f2c 205f 2c20 6e6f  adable, _, _, no
+0001b780: 6465 2e6b 6579 732e 7075 626c 6963 5f6b  de.keys.public_k
+0001b790: 6579 5f62 3634 656e 636f 6465 642c 206e  ey_b64encoded, n
+0001b7a0: 6f64 652e 6b65 7973 2e61 6464 7265 7373  ode.keys.address
+0001b7b0: 2c20 6e6f 6465 2e6b 6579 732e 6b65 7966  , node.keys.keyf
+0001b7c0: 696c 6520 3d20 6573 7365 6e74 6961 6c73  ile = essentials
+0001b7d0: 2e6b 6579 735f 6c6f 6164 280a 2020 2020  .keys_load(.    
+0001b7e0: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
+0001b7f0: 2864 6174 615f 6469 722c 2027 7072 6976  (data_dir, 'priv
+0001b800: 6b65 792e 6465 7227 292c 0a20 2020 2020  key.der'),.     
+0001b810: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
+0001b820: 6461 7461 5f64 6972 2c20 2770 7562 6b65  data_dir, 'pubke
+0001b830: 792e 6465 7227 292c 0a20 2020 2020 2020  y.der'),.       
+0001b840: 2077 616c 6c65 745f 6669 6c65 6e61 6d65   wallet_filename
+0001b850: 2c0a 2020 2020 290a 0a20 2020 2069 6620  ,.    )..    if 
+0001b860: 6e6f 6465 2e69 735f 7265 676e 6574 3a0a  node.is_regnet:.
+0001b870: 2020 2020 2020 2020 7265 676e 6574 2e50          regnet.P
+0001b880: 5249 5641 5445 5f4b 4559 5f52 4541 4441  RIVATE_KEY_READA
+0001b890: 424c 4520 3d20 6e6f 6465 2e6b 6579 732e  BLE = node.keys.
+0001b8a0: 7072 6976 6174 655f 6b65 795f 7265 6164  private_key_read
+0001b8b0: 6162 6c65 0a20 2020 2020 2020 2072 6567  able.        reg
+0001b8c0: 6e65 742e 5055 424c 4943 5f4b 4559 5f42  net.PUBLIC_KEY_B
+0001b8d0: 3634 454e 434f 4445 4420 3d20 6e6f 6465  64ENCODED = node
+0001b8e0: 2e6b 6579 732e 7075 626c 6963 5f6b 6579  .keys.public_key
+0001b8f0: 5f62 3634 656e 636f 6465 640a 2020 2020  _b64encoded.    
+0001b900: 2020 2020 7265 676e 6574 2e41 4444 5245      regnet.ADDRE
+0001b910: 5353 203d 206e 6f64 652e 6b65 7973 2e61  SS = node.keys.a
+0001b920: 6464 7265 7373 0a20 2020 2020 2020 2072  ddress.        r
+0001b930: 6567 6e65 742e 4b45 5920 3d20 6e6f 6465  egnet.KEY = node
+0001b940: 2e6b 6579 732e 6b65 790a 0a20 2020 206e  .keys.key..    n
+0001b950: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+0001b960: 6f67 2e77 6172 6e69 6e67 2866 2753 7461  og.warning(f'Sta
+0001b970: 7475 733a 204c 6f63 616c 2061 6464 7265  tus: Local addre
+0001b980: 7373 3a20 7b6e 6f64 652e 6b65 7973 2e61  ss: {node.keys.a
+0001b990: 6464 7265 7373 7d27 290a 0a0a 6465 6620  ddress}')...def 
+0001b9a0: 7665 7269 6679 2864 625f 6861 6e64 6c65  verify(db_handle
+0001b9b0: 7229 3a0a 2020 2020 2320 544f 444f 3a20  r):.    # TODO: 
+0001b9c0: 6361 6e64 6964 6174 6520 666f 7220 7369  candidate for si
+0001b9d0: 6e67 6c65 2075 7365 7220 6d6f 6465 0a20  ngle user mode. 
+0001b9e0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001b9f0: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0001ba00: 6c6f 672e 7761 726e 696e 6728 2742 6c6f  log.warning('Blo
+0001ba10: 636b 6368 6169 6e20 7665 7269 6669 6361  ckchain verifica
+0001ba20: 7469 6f6e 2073 7461 7274 6564 2e2e 2e27  tion started...'
+0001ba30: 290a 2020 2020 2020 2020 2320 7665 7269  ).        # veri
+0001ba40: 6679 2062 6c6f 636b 6368 6169 6e0a 2020  fy blockchain.  
+0001ba50: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
+0001ba60: 2e65 7865 6375 7465 2864 625f 6861 6e64  .execute(db_hand
+0001ba70: 6c65 722e 682c 2027 5345 4c45 4354 2043  ler.h, 'SELECT C
+0001ba80: 6f75 6e74 282a 2920 4652 4f4d 2074 7261  ount(*) FROM tra
+0001ba90: 6e73 6163 7469 6f6e 7327 290a 2020 2020  nsactions').    
+0001baa0: 2020 2020 6462 5f72 6f77 7320 3d20 6462      db_rows = db
+0001bab0: 5f68 616e 646c 6572 2e68 2e66 6574 6368  _handler.h.fetch
+0001bac0: 6f6e 6528 295b 305d 0a20 2020 2020 2020  one()[0].       
+0001bad0: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0001bae0: 5f6c 6f67 2e77 6172 6e69 6e67 2827 546f  _log.warning('To
+0001baf0: 7461 6c20 7374 6570 733a 207b 7d27 2e66  tal steps: {}'.f
+0001bb00: 6f72 6d61 7428 6462 5f72 6f77 7329 290a  ormat(db_rows)).
+0001bb10: 0a20 2020 2020 2020 2023 2076 6572 6966  .        # verif
+0001bb20: 7920 6765 6e65 7369 730a 2020 2020 2020  y genesis.      
+0001bb30: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001bb40: 2020 2064 625f 6861 6e64 6c65 722e 6578     db_handler.ex
+0001bb50: 6563 7574 6528 6462 5f68 616e 646c 6572  ecute(db_handler
+0001bb60: 2e68 2c20 2753 454c 4543 5420 626c 6f63  .h, 'SELECT bloc
+0001bb70: 6b5f 6865 6967 6874 2c20 7265 6369 7069  k_height, recipi
+0001bb80: 656e 7420 4652 4f4d 2074 7261 6e73 6163  ent FROM transac
+0001bb90: 7469 6f6e 7320 5748 4552 4520 626c 6f63  tions WHERE bloc
+0001bba0: 6b5f 6865 6967 6874 203d 2031 2729 0a20  k_height = 1'). 
+0001bbb0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0001bbc0: 7420 3d20 6462 5f68 616e 646c 6572 2e68  t = db_handler.h
+0001bbd0: 2e66 6574 6368 616c 6c28 295b 305d 0a20  .fetchall()[0]. 
+0001bbe0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+0001bbf0: 5f68 6569 6768 7420 3d20 7265 7375 6c74  _height = result
+0001bc00: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0001bc10: 6765 6e65 7369 7320 3d20 7265 7375 6c74  genesis = result
+0001bc20: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+0001bc30: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0001bc40: 6c6f 672e 7761 726e 696e 6728 6627 4765  log.warning(f'Ge
+0001bc50: 6e65 7369 733a 207b 6765 6e65 7369 737d  nesis: {genesis}
+0001bc60: 2729 0a20 2020 2020 2020 2020 2020 2069  ').            i
+0001bc70: 6620 7374 7228 6765 6e65 7369 7329 2021  f str(genesis) !
+0001bc80: 3d20 6e6f 6465 2e67 656e 6573 6973 2061  = node.genesis a
+0001bc90: 6e64 2069 6e74 2862 6c6f 636b 5f68 6569  nd int(block_hei
+0001bca0: 6768 7429 203d 3d20 303a 0a20 2020 2020  ght) == 0:.     
+0001bcb0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0001bcc0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001bcd0: 6172 6e69 6e67 2827 496e 7661 6c69 6420  arning('Invalid 
+0001bce0: 6765 6e65 7369 7320 6164 6472 6573 7327  genesis address'
+0001bcf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001bd00: 2020 7379 732e 6578 6974 2831 290a 2020    sys.exit(1).  
+0001bd10: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+0001bd20: 2020 2020 2020 2020 2020 6e6f 6465 2e6c            node.l
+0001bd30: 6f67 6765 722e 6170 705f 6c6f 672e 7761  ogger.app_log.wa
+0001bd40: 726e 696e 6728 2748 7970 6572 626c 6f63  rning('Hyperbloc
+0001bd50: 6b20 6d6f 6465 2069 6e20 7573 6527 290a  k mode in use').
+0001bd60: 2020 2020 2020 2020 2320 7665 7269 6679          # verify
+0001bd70: 2067 656e 6573 6973 0a0a 2020 2020 2020   genesis..      
+0001bd80: 2020 6462 5f68 6173 6865 7320 3d20 7b0a    db_hashes = {.
+0001bd90: 2020 2020 2020 2020 2020 2020 2732 3732              '272
+0001bda0: 3538 2d31 3439 3337 3535 3337 352e 3233  58-1493755375.23
+0001bdb0: 273a 2027 6163 6436 3034 3435 3931 6335  ': 'acd6044591c5
+0001bdc0: 6261 6631 3231 6535 3831 3232 3537 3234  baf121e581225724
+0001bdd0: 6663 3133 3430 3039 3431 6337 272c 0a20  fc13400941c7',. 
+0001bde0: 2020 2020 2020 2020 2020 2027 3237 3239             '2729
+0001bdf0: 382d 3134 3933 3735 3538 3330 2e35 3827  8-1493755830.58'
+0001be00: 3a20 2734 3831 6563 3835 3662 3530 6135  : '481ec856b50a5
+0001be10: 6165 3466 3562 3936 6465 3630 6138 6564  ae4f5b96de60a8ed
+0001be20: 6137 3565 6363 6432 3136 3327 2c0a 2020  a75eccd2163',.  
+0001be30: 2020 2020 2020 2020 2020 2733 3034 3430            '30440
+0001be40: 2d31 3439 3337 3638 3132 332e 3038 273a  -1493768123.08':
+0001be50: 2027 6564 3131 6232 3435 3330 6462 6363   'ed11b24530dbcc
+0001be60: 3836 3663 6539 6265 3737 3362 6661 6431  866ce9be773bfad1
+0001be70: 3439 3637 6130 6533 6562 272c 0a20 2020  4967a0e3eb',.   
+0001be80: 2020 2020 2020 2020 2027 3332 3132 372d           '32127-
+0001be90: 3134 3933 3737 3531 3531 2e39 3227 3a20  1493775151.92': 
+0001bea0: 2765 3539 3464 3034 6164 3965 3535 3462  'e594d04ad9e554b
+0001beb0: 6365 3633 3539 3362 3831 6639 3434 3430  ce63593b81f94440
+0001bec0: 3536 6464 3137 3035 6427 2c0a 2020 2020  56dd1705d',.    
+0001bed0: 2020 2020 2020 2020 2733 3231 3238 2d31          '32128-1
+0001bee0: 3439 3337 3735 3137 302e 3137 273a 2027  493775170.17': '
+0001bef0: 3037 6138 6334 3964 3030 6537 3033 6631  07a8c49d00e703f1
+0001bf00: 6539 3531 3863 3764 3666 6131 3164 3931  e9518c7d6fa11d91
+0001bf10: 3864 3561 3930 3336 272c 0a20 2020 2020  8d5a9036',.     
+0001bf20: 2020 2020 2020 2027 3337 3733 322d 3134         '37732-14
+0001bf30: 3933 3739 3930 3337 2e36 3027 3a20 2734  93799037.60': '4
+0001bf40: 3363 3036 3433 3039 6566 6633 6233 6630  3c064309eff3b3f0
+0001bf50: 3635 3431 3464 3737 3532 6632 3365 3164  65414d7752f23e1d
+0001bf60: 6531 6537 3063 6427 2c0a 2020 2020 2020  e1e70cd',.      
+0001bf70: 2020 2020 2020 2733 3738 3938 2d31 3439        '37898-149
+0001bf80: 3337 3939 3331 372e 3430 273a 2027 3265  3799317.40': '2e
+0001bf90: 3835 6235 6334 3531 3366 3565 3866 3363  85b5c4513f5e8f3c
+0001bfa0: 3833 6134 3830 6165 6130 3264 3937 3837  83a480aea02d9787
+0001bfb0: 3439 3662 3761 272c 0a20 2020 2020 2020  496b7a',.       
+0001bfc0: 2020 2020 2027 3337 3839 382d 3134 3933       '37898-1493
+0001bfd0: 3739 3937 3734 2e34 3627 3a20 2734 6561  799774.46': '4ea
+0001bfe0: 3839 3962 3362 6464 3934 3361 3966 3136  899b3bdd943a9f16
+0001bff0: 3432 3635 6435 3162 3934 3237 6631 3331  4265d51b9427f131
+0001c000: 3663 6533 3927 2c0a 2020 2020 2020 2020  6ce39',.        
+0001c010: 2020 2020 2733 3830 3833 2d31 3439 3338      '38083-14938
+0001c020: 3030 3635 302e 3637 273a 2027 3635 6539  00650.67': '65e9
+0001c030: 3361 6162 3134 3963 3765 3737 6533 3833  3aab149c7e77e383
+0001c040: 6530 6639 6562 3165 3766 3961 3032 3137  e0f9eb1e7f9a0217
+0001c050: 3332 6130 272c 0a20 2020 2020 2020 2020  32a0',.         
+0001c060: 2020 2027 3532 3233 332d 3134 3933 3837     '52233-149387
+0001c070: 3639 3031 2e37 3327 3a20 2732 3936 3533  6901.73': '29653
+0001c080: 6664 6566 6336 6361 3938 6161 6465 6162  fdefc6ca98aadeab
+0001c090: 3337 3838 3433 3833 6665 6466 3965 3033  37884383fedf9e03
+0001c0a0: 3162 3327 2c0a 2020 2020 2020 2020 2020  1b3',.          
+0001c0b0: 2020 2735 3232 3339 2d31 3439 3338 3736    '52239-1493876
+0001c0c0: 3936 332e 3731 273a 2027 3463 3065 3236  963.71': '4c0e26
+0001c0d0: 3264 6536 3461 3565 3739 3236 3031 3933  2de64a5e79260193
+0001c0e0: 3761 3333 3363 6132 6266 3664 3636 3831  7a333ca2bf6d6681
+0001c0f0: 6632 272c 0a20 2020 2020 2020 2020 2020  f2',.           
+0001c100: 2027 3532 3238 322d 3134 3933 3837 3731   '52282-14938771
+0001c110: 3639 2e32 3927 3a20 2738 3038 6639 3035  69.29': '808f905
+0001c120: 3334 6537 6261 3638 6565 3630 6262 3265  34e7ba68ee60bb2e
+0001c130: 6134 3533 3066 3566 6637 6239 6438 6465  a4530f5ff7b9d8de
+0001c140: 6127 2c0a 2020 2020 2020 2020 2020 2020  a',.            
+0001c150: 2735 3233 3038 2d31 3439 3338 3737 3235  '52308-149387725
+0001c160: 372e 3835 273a 2027 3839 3139 3534 3866  7.85': '8919548f
+0001c170: 6462 6335 3039 3361 3665 3933 3230 3831  dbc5093a6e932081
+0001c180: 3861 3063 6130 3538 3434 3965 3239 6332  8a0ca058449e29c2
+0001c190: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001c1a0: 3532 3339 332d 3134 3933 3837 3734 3633  52393-1493877463
+0001c1b0: 2e39 3727 3a20 2730 6562 6137 3632 3361  .97': '0eba7623a
+0001c1c0: 3434 3434 3164 3235 3335 6561 6665 6134  44441d2535eafea4
+0001c1d0: 3635 3565 3865 6635 3234 6633 3731 3927  655e8ef524f3719'
+0001c1e0: 2c0a 2020 2020 2020 2020 2020 2020 2736  ,.            '6
+0001c1f0: 3235 3037 2d31 3439 3339 3436 3337 322e  2507-1493946372.
+0001c200: 3530 273a 2027 3831 6339 6361 3137 3564  50': '81c9ca175d
+0001c210: 3039 6634 3734 3937 6135 3765 6665 6235  09f47497a57efeb5
+0001c220: 3164 3136 6565 3738 6464 6332 3332 272c  1d16ee78ddc232',
+0001c230: 0a20 2020 2020 2020 2020 2020 2027 3730  .            '70
+0001c240: 3039 342d 3134 3934 3033 3239 3333 2e31  094-1494032933.1
+0001c250: 3427 3a20 2732 6361 3434 3033 3338 3765  4': '2ca4403387e
+0001c260: 3834 6239 3565 6435 3538 6537 6339 3335  84b95ed558e7c935
+0001c270: 3063 3433 6566 6666 3832 3235 6327 2c0a  0c43efff8225c',.
+0001c280: 2020 2020 2020 2020 2020 2020 2731 3037              '107
+0001c290: 3537 392d 3134 3935 3439 3933 3835 2e35  579-1495499385.5
+0001c2a0: 3527 3a20 2734 6330 3164 3439 3162 3335  5': '4c01d491b35
+0001c2b0: 3538 3365 3661 3838 3061 3031 3662 6430  583e6a880a016bd0
+0001c2c0: 3861 6339 3932 6232 3565 3934 3627 2c0a  8ac992b25e946',.
+0001c2d0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c2e0: 3033 322d 3134 3935 3538 3139 3334 2e37  032-1495581934.7
+0001c2f0: 3127 3a20 2765 3831 6361 6134 3866 3465  1': 'e81caa48f4e
+0001c300: 3034 3237 3262 3736 3462 6335 3861 3061  04272b764bc58a0a
+0001c310: 3638 6530 3765 3434 6535 3062 6527 2c0a  68e07e44e50be',.
+0001c320: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c330: 3033 322d 3134 3935 3538 3139 3638 2e33  032-1495581968.3
+0001c340: 3527 3a20 2732 3634 3139 3335 3162 6335  5': '26419351bc5
+0001c350: 6365 6137 3831 6163 3462 3431 6336 6135  cea781ac4b41c6a5
+0001c360: 6561 3735 3735 3835 6464 6265 3427 2c0a  ea757585ddbe4',.
+0001c370: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c380: 3033 322d 3134 3935 3538 3139 3937 2e37  032-1495581997.7
+0001c390: 3427 3a20 2761 6436 3334 6132 3362 3639  4': 'ad634a23b69
+0001c3a0: 6236 6435 6366 3835 3134 6436 6533 6135  b6d5cf8514d6e3a5
+0001c3b0: 6438 6337 3331 3132 3430 6235 3827 2c0a  d8c7311240b58',.
+0001c3c0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c3d0: 3033 322d 3134 3935 3538 3230 3532 2e33  032-1495582052.3
+0001c3e0: 3927 3a20 2739 6135 3831 3565 3161 6161  9': '9a5815e1aaa
+0001c3f0: 3530 6331 3239 6661 6430 3564 3935 3032  50c129fad05d9502
+0001c400: 6232 6238 3335 3138 6162 3063 3627 2c0a  b2b83518ab0c6',.
+0001c410: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c420: 3033 322d 3134 3935 3538 3230 3733 2e38  032-1495582073.8
+0001c430: 3027 3a20 2763 3365 6362 6334 3132 6564  0': 'c3ecbc412ed
+0001c440: 3832 3533 3966 3836 3664 3563 6539 3561  82539f866d5ce95a
+0001c450: 3436 6466 3866 3162 6263 3939 3227 2c0a  46df8f1bbc992',.
+0001c460: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c470: 3033 322d 3134 3935 3538 3230 3933 2e38  032-1495582093.8
+0001c480: 3527 3a20 2765 6666 3634 3335 3764 3033  5': 'eff64357d03
+0001c490: 3230 6337 3763 3737 3734 6264 6666 6266  20c77c7774bdffbf
+0001c4a0: 3030 3332 6266 6262 6366 3430 6127 2c0a  0032bfbbcf40a',.
+0001c4b0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c4c0: 3033 322d 3134 3935 3538 3231 3337 2e34  032-1495582137.4
+0001c4d0: 3827 3a20 2765 3366 3334 6333 6230 3630  8': 'e3f34c3b060
+0001c4e0: 3861 3232 3736 6333 6431 3739 6665 3230  8a2276c3d179fe20
+0001c4f0: 3931 6165 3362 3562 3333 3435 3827 2c0a  91ae3b5b33458',.
+0001c500: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c510: 3033 322d 3134 3935 3538 3231 3637 2e38  032-1495582167.8
+0001c520: 3127 3a20 2764 6439 6366 3234 3336 3637  1': 'dd9cf243667
+0001c530: 3263 3262 3262 3561 3663 6332 3330 6665  2c2b2b5a6cc230fe
+0001c540: 3062 6635 3438 6433 3835 3663 3927 2c0a  0bf548d3856c9',.
+0001c550: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c560: 3033 322d 3134 3935 3538 3231 3838 2e31  032-1495582188.1
+0001c570: 3627 3a20 2739 3738 6637 6534 3261 3938  6': '978f7e42a98
+0001c580: 6430 3064 6430 6235 3230 6661 3333 3061  d00dd0b520fa330a
+0001c590: 6563 3133 3639 3736 6632 6231 3027 2c0a  ec136976f2b10',.
+0001c5a0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c5b0: 3033 322d 3134 3935 3538 3232 3132 2e34  032-1495582212.4
+0001c5c0: 3927 3a20 2737 3939 3164 3265 6665 6436  9': '7991d2efed6
+0001c5d0: 6332 3135 3039 6431 3034 6334 6262 3961  c21509d104c4bb9a
+0001c5e0: 3431 6462 3837 3361 3138 3662 6627 2c0a  41db873a186bf',.
+0001c5f0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c600: 3033 322d 3134 3935 3538 3232 3631 2e39  032-1495582261.9
+0001c610: 3927 3a20 2734 3936 3439 3161 3832 3433  9': '496491a8243
+0001c620: 6639 3265 6632 3136 6233 3038 6134 6238  f92ef216b308a4b8
+0001c630: 6531 3630 6639 6163 3839 3032 6627 2c0a  e160f9ac8902f',.
+0001c640: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c650: 3033 322d 3134 3935 3538 3232 3831 2e39  032-1495582281.9
+0001c660: 3227 3a20 2763 3365 6237 3566 3039 3935  2': 'c3eb75f0995
+0001c670: 3436 6364 3161 6665 6330 3531 3139 3461  46cd1afec051194a
+0001c680: 3466 3063 6537 3238 3038 3831 3127 2c0a  4f0ce72808811',.
+0001c690: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c6a0: 3033 322d 3134 3935 3538 3233 3236 2e34  032-1495582326.4
+0001c6b0: 3927 3a20 2766 3661 3264 3135 6331 3836  9': 'f6a2d15c186
+0001c6c0: 3932 6331 3530 3761 3266 3066 3331 6662  92c1507a2f0f31fb
+0001c6d0: 3938 6564 3132 3666 3632 3835 6427 2c0a  98ed126f6285d',.
+0001c6e0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c6f0: 3033 322d 3134 3935 3538 3233 3435 2e36  032-1495582345.6
+0001c700: 3627 3a20 2763 3631 6233 3037 3361 6533  6': 'c61b3073ae3
+0001c710: 3334 3531 3436 3538 3965 6633 3161 3536  345146589ef31a56
+0001c720: 3538 3734 6633 3530 3661 6133 6227 2c0a  5874f3506aa3b',.
+0001c730: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c740: 3033 322d 3134 3935 3538 3233 3632 2e32  032-1495582362.2
+0001c750: 3927 3a20 2739 3166 3063 3265 6237 6337  9': '91f0c2eb7c7
+0001c760: 6438 6261 6466 3237 3931 3330 6639 6438  d8badf279130f9d8
+0001c770: 3831 3063 3331 6263 6130 3733 3827 2c0a  810c31bca0738',.
+0001c780: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c790: 3033 322d 3134 3935 3538 3233 3931 2e32  032-1495582391.2
+0001c7a0: 3727 3a20 2738 3662 6132 3261 3336 6164  7': '86ba22a36ad
+0001c7b0: 3136 3034 6663 6265 6363 6237 6235 3361  1604fcbeccb7b53a
+0001c7c0: 3466 3138 3738 6534 3265 3763 3827 2c0a  4f1878e42e7c8',.
+0001c7d0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c7e0: 3033 322d 3134 3935 3538 3234 3134 2e34  032-1495582414.4
+0001c7f0: 3827 3a20 2736 6337 6662 3936 3863 3664  8': '6c7fb968c6d
+0001c800: 6630 3565 3663 3431 6132 6235 3734 3137  f05e6c41a2b57417
+0001c810: 3236 3566 6364 3231 6366 3034 3927 2c0a  265fcd21cf049',.
+0001c820: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c830: 3033 322d 3134 3935 3538 3234 3331 2e35  032-1495582431.5
+0001c840: 3727 3a20 2738 3562 3834 3634 3739 6663  7': '85b846479fc
+0001c850: 6636 3565 3062 3034 3037 6165 3561 3632  f65e0b0407ae5a62
+0001c860: 6134 3365 3534 3861 3035 6230 6627 2c0a  a43e548a05b0f',.
+0001c870: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c880: 3033 322d 3134 3935 3538 3234 3532 2e39  032-1495582452.9
+0001c890: 3027 3a20 2762 6535 3938 3539 3439 6139  0': 'be5985949a9
+0001c8a0: 6639 6330 3565 3130 3837 6333 3733 3137  f9c05e1087c37317
+0001c8b0: 3966 3436 3939 6339 6132 3835 6227 2c0a  9f4699c9a285b',.
+0001c8c0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c8d0: 3033 322d 3134 3935 3538 3234 3734 2e33  032-1495582474.3
+0001c8e0: 3027 3a20 2735 6638 6633 3363 6364 3338  0': '5f8f33ccd38
+0001c8f0: 3631 6462 6166 3361 3964 6536 3739 6232  61dbaf3a9de679b2
+0001c900: 6335 3762 6234 6463 3661 6139 6527 2c0a  c57bb4dc6aa9e',.
+0001c910: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c920: 3033 322d 3134 3935 3538 3234 3931 2e33  032-1495582491.3
+0001c930: 3327 3a20 2762 6263 6134 6332 6366 6233  3': 'bbca4c2cfb3
+0001c940: 6230 3733 6463 3236 6532 3838 3261 3063  b073dc26e2882a0c
+0001c950: 3633 3562 3466 3534 3563 3739 3627 2c0a  635b4f545c796',.
+0001c960: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c970: 3033 322d 3134 3935 3538 3235 3139 2e36  032-1495582519.6
+0001c980: 3627 3a20 2765 3861 6361 6634 6333 3234  6': 'e8acaf4c324
+0001c990: 6164 3633 3830 6539 3566 3035 6235 3438  ad6380e95f05b548
+0001c9a0: 3835 3037 6331 6636 3737 6630 6427 2c0a  8507c1f677f0d',.
+0001c9b0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001c9c0: 3033 322d 3134 3935 3538 3235 3532 2e33  032-1495582552.3
+0001c9d0: 3327 3a20 2731 6431 3965 6662 6537 3466  3': '1d19efbe74f
+0001c9e0: 3164 6363 3066 3365 6563 6339 3765 3537  1dcc0f3eecc97e57
+0001c9f0: 3630 3261 3835 3463 6565 3830 6327 2c0a  602a854cee80c',.
+0001ca00: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001ca10: 3033 322d 3134 3935 3538 3235 3636 2e38  032-1495582566.8
+0001ca20: 3927 3a20 2736 6638 3535 3531 3761 3561  9': '6f855517a5a
+0001ca30: 3135 3736 3432 3735 6236 6234 3733 6466  15764275b6b473df
+0001ca40: 3364 3862 3034 3234 6531 3463 6127 2c0a  3d8b0424e14ca',.
+0001ca50: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001ca60: 3033 322d 3134 3935 3538 3235 3738 2e30  032-1495582578.0
+0001ca70: 3627 3a20 2735 3564 3461 6637 3439 6166  6': '55d4af749af
+0001ca80: 3931 3661 3461 6634 3139 3031 3036 3133  916a4af419010613
+0001ca90: 3363 3462 6436 3138 6663 6364 3827 2c0a  3c4bd618fccd8',.
+0001caa0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cab0: 3033 322d 3134 3935 3538 3235 3930 2e32  032-1495582590.2
+0001cac0: 3727 3a20 2733 3132 3030 3965 6661 3764  7': '312009efa7d
+0001cad0: 3866 6266 3362 6437 3838 3730 3462 3966  8fbf3bd788704b9f
+0001cae0: 3466 3966 3463 6361 3262 6636 6227 2c0a  4f9f4cca2bf6b',.
+0001caf0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cb00: 3033 322d 3134 3935 3538 3236 3035 2e37  032-1495582605.7
+0001cb10: 3827 3a20 2739 3264 6431 3561 3933 6535  8': '92dd15a93e5
+0001cb20: 6664 6336 6434 3139 6534 3065 3733 6337  fdc6d419e40e73c7
+0001cb30: 3338 3631 3838 3330 3737 3862 6627 2c0a  38618830778bf',.
+0001cb40: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cb50: 3033 322d 3134 3935 3538 3236 3239 2e37  032-1495582629.7
+0001cb60: 3227 3a20 2763 3930 6132 6261 6565 6666  2': 'c90a2baeeff
+0001cb70: 6238 3238 3361 3738 3137 3837 6166 3162  b8283a781787af1b
+0001cb80: 3961 3264 3465 3733 3930 3736 3827 2c0a  9a2d4e7390768',.
+0001cb90: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cba0: 3033 322d 3134 3935 3538 3236 3530 2e36  032-1495582650.6
+0001cbb0: 3627 3a20 2737 3639 3139 3631 3662 3362  6': '76919616b3b
+0001cbc0: 3236 6131 3366 6266 6363 6462 3166 3661  26a13fbfccdb1f6a
+0001cbd0: 3730 3437 3865 6363 3939 6635 6227 2c0a  70478ecc99f5b',.
+0001cbe0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cbf0: 3033 322d 3134 3935 3538 3236 3733 2e36  032-1495582673.6
+0001cc00: 3927 3a20 2738 3232 3861 3239 6563 3436  9': '8228a29ec46
+0001cc10: 6634 6330 3137 6339 3833 3037 3365 3462  f4c017c983073e4b
+0001cc20: 6635 3233 3036 6433 3061 3230 6527 2c0a  f52306d30a20e',.
+0001cc30: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cc40: 3033 322d 3134 3935 3538 3236 3932 2e37  032-1495582692.7
+0001cc50: 3627 3a20 2764 3766 3833 6339 6364 6137  6': 'd7f83c9cda7
+0001cc60: 3233 3830 3734 3863 3965 3639 3765 3836  2380748c9e697e86
+0001cc70: 3465 3634 6633 3731 6230 6338 3727 2c0a  4e64f371b0c87',.
+0001cc80: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cc90: 3033 322d 3134 3935 3538 3237 3035 2e38  032-1495582705.8
+0001cca0: 3227 3a20 2764 3837 6637 3465 6161 3832  2': 'd87f74eaa82
+0001ccb0: 6432 3536 3631 3239 6434 3566 3030 3430  d2566129d45f0040
+0001ccc0: 6336 6137 3936 6536 6330 3064 3627 2c0a  c6a796e6c00d6',.
+0001ccd0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cce0: 3033 322d 3134 3935 3538 3237 3138 2e37  032-1495582718.7
+0001ccf0: 3527 3a20 2734 3165 3462 3635 3935 6563  5': '41e4b6595ec
+0001cd00: 6330 3038 3762 3761 3337 3063 3038 6239  c0087b7a370c08b9
+0001cd10: 6539 3131 6464 6637 3036 3231 6527 2c0a  e911ddf70621e',.
+0001cd20: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cd30: 3033 322d 3134 3935 3538 3237 3331 2e32  032-1495582731.2
+0001cd40: 3327 3a20 2731 3162 3935 6537 6632 3130  3': '11b95e7f210
+0001cd50: 6536 3136 6133 3966 3166 3366 6336 3730  e616a39f1f3fc670
+0001cd60: 3535 6665 6433 3464 3036 6435 3827 2c0a  55fed34d06d58',.
+0001cd70: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cd80: 3033 322d 3134 3935 3538 3237 3433 2e39  032-1495582743.9
+0001cd90: 3227 3a20 2731 3138 6263 6166 3261 3430  2': '118bcaf2a40
+0001cda0: 3634 6236 3464 3166 3438 6161 6165 3233  64b64d1f48aaae23
+0001cdb0: 3832 6164 3935 3035 3032 3761 3427 2c0a  82ad9505027a4',.
+0001cdc0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cdd0: 3033 322d 3134 3935 3538 3237 3536 2e39  032-1495582756.9
+0001cde0: 3227 3a20 2736 3761 3831 6530 3430 6562  2': '67a81e040eb
+0001cdf0: 6632 3537 3032 3462 3536 6266 3939 6465  f257024b56bf99de
+0001ce00: 3537 3633 3037 3964 3963 3338 6227 2c0a  5763079d9c38b',.
+0001ce10: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001ce20: 3033 322d 3134 3935 3538 3237 3638 2e30  032-1495582768.0
+0001ce30: 3727 3a20 2730 6166 6263 6431 3131 6265  7': '0afbcd111be
+0001ce40: 6466 3631 6636 3765 6535 6561 6663 3265  df61f67ee5eafc2e
+0001ce50: 3237 3932 3939 3132 3534 6633 3327 2c0a  2792991254f33',.
+0001ce60: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001ce70: 3033 322d 3134 3935 3538 3237 3830 2e35  032-1495582780.5
+0001ce80: 3827 3a20 2764 3733 3531 6165 3861 3239  8': 'd7351ae8a29
+0001ce90: 6532 3733 3237 6663 3039 3532 6365 3237  e27327fc0952ce27
+0001cea0: 3430 3562 6534 3837 6434 6463 6627 2c0a  405be487d4dcf',.
+0001ceb0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cec0: 3033 322d 3134 3935 3538 3237 3933 2e37  032-1495582793.7
+0001ced0: 3627 3a20 2735 3665 6361 3332 3032 3739  6': '56eca320279
+0001cee0: 3534 3433 3636 3962 3335 6166 3138 6333  5443669b35af18c3
+0001cef0: 3136 6130 6264 6330 3136 3661 6227 2c0a  16a0bdc0166ab',.
+0001cf00: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cf10: 3033 322d 3134 3935 3538 3238 3130 2e32  032-1495582810.2
+0001cf20: 3427 3a20 2734 3834 3166 3366 3031 6364  4': '4841f3f01cd
+0001cf30: 3938 3638 3633 3131 3066 6339 6536 3136  986863110fc9e616
+0001cf40: 3232 6333 3539 3864 3766 3663 3427 2c0a  22c3598d7f6c4',.
+0001cf50: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cf60: 3033 322d 3134 3935 3538 3238 3233 2e32  032-1495582823.2
+0001cf70: 3227 3a20 2737 6134 3234 3465 3035 3439  2': '7a4244e0549
+0001cf80: 6663 3264 6139 6661 3135 3332 3835 3036  fc2da9fa15328506
+0001cf90: 6635 6166 6562 3766 6333 3666 3427 2c0a  f5afeb7fc36f4',.
+0001cfa0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001cfb0: 3033 322d 3134 3935 3538 3238 3333 2e38  032-1495582833.8
+0001cfc0: 3927 3a20 2737 6166 3966 6334 3662 3264  9': '7af9fc46b2d
+0001cfd0: 3730 6335 3037 3037 3337 6330 6131 6563  70c5070737c0a1ec
+0001cfe0: 6163 6361 6331 3166 3432 3064 6427 2c0a  accac11f420dd',.
+0001cff0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d000: 3033 322d 3134 3935 3538 3238 3630 2e35  032-1495582860.5
+0001d010: 3527 3a20 2765 6238 3734 3261 6531 6563  5': 'eb8742ae1ec
+0001d020: 3634 3965 3031 6235 6361 3530 3634 6461  649e01b5ca5064da
+0001d030: 3532 6238 6265 3735 6130 6265 3127 2c0a  52b8be75a0be1',.
+0001d040: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d050: 3033 342d 3134 3935 3538 3238 3932 2e37  034-1495582892.7
+0001d060: 3927 3a20 2765 6630 3035 3136 6239 6637  9': 'ef00516b9f7
+0001d070: 3233 6665 3765 6565 6439 3834 3635 6132  23fe7eeed98465a2
+0001d080: 3532 3166 3164 3139 3130 3138 3927 2c0a  521f1d1910189',.
+0001d090: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d0a0: 3033 342d 3134 3935 3538 3239 3034 2e30  034-1495582904.0
+0001d0b0: 3527 3a20 2735 3631 3732 6236 3632 3561  5': '56172b6625a
+0001d0c0: 3136 3363 6431 6539 3065 3736 3736 6233  163cd1e90e7676b3
+0001d0d0: 3337 3734 6233 3064 6265 3961 3627 2c0a  3774b30dbe9a6',.
+0001d0e0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d0f0: 3033 342d 3134 3935 3538 3239 3135 2e33  034-1495582915.3
+0001d100: 3827 3a20 2739 3032 3930 6435 3366 6638  8': '90290d53ff8
+0001d110: 6631 3666 6661 3963 6638 6361 3561 6464  f16ffa9cf8ca5add
+0001d120: 3166 3135 3536 3132 6462 6566 6527 2c0a  1f155612dbefe',.
+0001d130: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d140: 3033 352d 3134 3935 3538 3239 3236 2e39  035-1495582926.9
+0001d150: 3827 3a20 2738 6335 6663 3938 6532 3339  8': '8c5fc98e239
+0001d160: 3438 6466 3536 6539 6330 3561 6363 3733  48df56e9c05acc73
+0001d170: 6530 6638 6631 3864 6631 3736 6527 2c0a  e0f8f18df176e',.
+0001d180: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d190: 3033 352d 3134 3935 3538 3239 3433 2e35  035-1495582943.5
+0001d1a0: 3327 3a20 2738 6336 6563 6563 6330 3833  3': '8c6ececc083
+0001d1b0: 6234 6663 6164 6163 3230 3232 6638 3135  b4fcadac2022f815
+0001d1c0: 3430 3763 3638 3561 3766 6361 6627 2c0a  407c685a7fcaf',.
+0001d1d0: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d1e0: 3033 352d 3134 3935 3538 3239 3736 2e36  035-1495582976.6
+0001d1f0: 3527 3a20 2734 6366 3464 3435 6430 6339  5': '4cf4d45d0c9
+0001d200: 3862 6533 6631 6138 3535 3366 3566 6632  8be3f1a8553f5ff2
+0001d210: 6431 3833 3737 3065 6331 6432 3727 2c0a  d183770ec1d27',.
+0001d220: 2020 2020 2020 2020 2020 2020 2731 3039              '109
+0001d230: 3033 352d 3134 3935 3538 3333 3232 2e31  035-1495583322.1
+0001d240: 3427 3a20 2738 6431 6334 3961 3563 3365  4': '8d1c49a5c3e
+0001d250: 3032 3961 3363 3432 3061 3533 3631 6633  029a3c420a5361f3
+0001d260: 6564 3065 6636 3239 6133 6539 3127 2c0a  ed0ef629a3e91',.
+0001d270: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0001d280: 2020 696e 7661 6c69 6420 3d20 300a 0a20    invalid = 0.. 
+0001d290: 2020 2020 2020 2066 6f72 2072 6f77 2069         for row i
+0001d2a0: 6e20 6462 5f68 616e 646c 6572 2e68 2e65  n db_handler.h.e
+0001d2b0: 7865 6375 7465 2827 5345 4c45 4354 202a  xecute('SELECT *
+0001d2c0: 2046 524f 4d20 7472 616e 7361 6374 696f   FROM transactio
+0001d2d0: 6e73 2057 4845 5245 2062 6c6f 636b 5f68  ns WHERE block_h
+0001d2e0: 6569 6768 7420 3e20 3020 616e 6420 7265  eight > 0 and re
+0001d2f0: 7761 7264 203d 2030 204f 5244 4552 2042  ward = 0 ORDER B
+0001d300: 5920 626c 6f63 6b5f 6865 6967 6874 2729  Y block_height')
+0001d310: 3a20 2023 206e 6174 6976 6520 7371 6c20  :  # native sql 
+0001d320: 6678 2074 6f20 6b65 6570 2063 6f6d 7061  fx to keep compa
+0001d330: 7469 6269 6c69 7479 0a0a 2020 2020 2020  tibility..      
+0001d340: 2020 2020 2020 6462 5f62 6c6f 636b 5f68        db_block_h
+0001d350: 6569 6768 7420 3d20 7374 7228 726f 775b  eight = str(row[
+0001d360: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+0001d370: 6462 5f74 696d 6573 7461 6d70 203d 2027  db_timestamp = '
+0001d380: 252e 3266 2720 2520 2871 7561 6e74 697a  %.2f' % (quantiz
+0001d390: 655f 7477 6f28 726f 775b 315d 2929 0a20  e_two(row[1])). 
+0001d3a0: 2020 2020 2020 2020 2020 2064 625f 6164             db_ad
+0001d3b0: 6472 6573 7320 3d20 7374 7228 726f 775b  dress = str(row[
+0001d3c0: 325d 295b 3a35 365d 0a20 2020 2020 2020  2])[:56].       
+0001d3d0: 2020 2020 2064 625f 7265 6369 7069 656e       db_recipien
+0001d3e0: 7420 3d20 7374 7228 726f 775b 335d 295b  t = str(row[3])[
+0001d3f0: 3a35 365d 0a20 2020 2020 2020 2020 2020  :56].           
+0001d400: 2064 625f 616d 6f75 6e74 203d 2027 252e   db_amount = '%.
+0001d410: 3866 2720 2520 2871 7561 6e74 697a 655f  8f' % (quantize_
+0001d420: 6569 6768 7428 726f 775b 345d 2929 0a20  eight(row[4])). 
+0001d430: 2020 2020 2020 2020 2020 2064 625f 7369             db_si
+0001d440: 676e 6174 7572 655f 656e 6320 3d20 7374  gnature_enc = st
+0001d450: 7228 726f 775b 355d 295b 3a36 3834 5d0a  r(row[5])[:684].
+0001d460: 2020 2020 2020 2020 2020 2020 6462 5f70              db_p
+0001d470: 7562 6c69 635f 6b65 795f 6236 3465 6e63  ublic_key_b64enc
+0001d480: 6f64 6564 203d 2073 7472 2872 6f77 5b36  oded = str(row[6
+0001d490: 5d29 5b3a 3130 3638 5d0a 2020 2020 2020  ])[:1068].      
+0001d4a0: 2020 2020 2020 6462 5f6f 7065 7261 7469        db_operati
+0001d4b0: 6f6e 203d 2073 7472 2872 6f77 5b31 305d  on = str(row[10]
+0001d4c0: 295b 3a33 305d 0a20 2020 2020 2020 2020  )[:30].         
+0001d4d0: 2020 2064 625f 6f70 656e 6669 656c 6420     db_openfield 
+0001d4e0: 3d20 7374 7228 726f 775b 3131 5d29 2020  = str(row[11])  
+0001d4f0: 2320 6e6f 206c 696d 6974 2066 6f72 2062  # no limit for b
+0001d500: 6163 6b77 6172 6420 636f 6d70 6174 6962  ackward compatib
+0001d510: 696c 6974 790a 2020 2020 2020 2020 2020  ility.          
+0001d520: 2020 6462 5f74 7261 6e73 6163 7469 6f6e    db_transaction
+0001d530: 203d 2073 7472 2828 6462 5f74 696d 6573   = str((db_times
+0001d540: 7461 6d70 2c20 6462 5f61 6464 7265 7373  tamp, db_address
+0001d550: 2c20 6462 5f72 6563 6970 6965 6e74 2c20  , db_recipient, 
+0001d560: 6462 5f61 6d6f 756e 742c 2064 625f 6f70  db_amount, db_op
+0001d570: 6572 6174 696f 6e2c 2064 625f 6f70 656e  eration, db_open
+0001d580: 6669 656c 6429 292e 656e 636f 6465 2827  field)).encode('
+0001d590: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
+0001d5a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001d5b0: 2020 2020 2020 2020 2020 2320 5369 676e            # Sign
+0001d5c0: 6572 2066 6163 746f 7279 2069 7320 6177  er factory is aw
+0001d5d0: 6172 6520 6f66 2074 6865 2064 6966 6665  are of the diffe
+0001d5e0: 7265 6e74 2074 7820 7363 6865 6d65 732c  rent tx schemes,
+0001d5f0: 2061 6e64 2077 696c 6c20 6236 3420 6465   and will b64 de
+0001d600: 636f 6465 2070 7562 6c69 635f 6b65 7920  code public_key 
+0001d610: 6f6e 6365 206f 7220 7477 6963 6520 6173  once or twice as
+0001d620: 206e 6565 6465 642e 0a20 2020 2020 2020   needed..       
+0001d630: 2020 2020 2020 2020 2053 6967 6e65 7246           SignerF
+0001d640: 6163 746f 7279 2e76 6572 6966 795f 6269  actory.verify_bi
+0001d650: 735f 7369 676e 6174 7572 6528 6462 5f73  s_signature(db_s
+0001d660: 6967 6e61 7475 7265 5f65 6e63 2c20 6462  ignature_enc, db
+0001d670: 5f70 7562 6c69 635f 6b65 795f 6236 3465  _public_key_b64e
+0001d680: 6e63 6f64 6564 2c20 6462 5f74 7261 6e73  ncoded, db_trans
+0001d690: 6163 7469 6f6e 2c20 6462 5f61 6464 7265  action, db_addre
+0001d6a0: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
+0001d6b0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0001d6c0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0001d6d0: 2020 2020 2020 2073 6861 5f68 6173 6820         sha_hash 
+0001d6e0: 3d20 5348 412e 6e65 7728 6462 5f74 7261  = SHA.new(db_tra
+0001d6f0: 6e73 6163 7469 6f6e 290a 2020 2020 2020  nsaction).      
+0001d700: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0001d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d720: 2020 2069 6620 7368 615f 6861 7368 2e68     if sha_hash.h
+0001d730: 6578 6469 6765 7374 2829 2021 3d20 6462  exdigest() != db
+0001d740: 5f68 6173 6865 735b 6462 5f62 6c6f 636b  _hashes[db_block
+0001d750: 5f68 6569 6768 7420 2b20 272d 2720 2b20  _height + '-' + 
+0001d760: 6462 5f74 696d 6573 7461 6d70 5d3a 0a20  db_timestamp]:. 
+0001d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d780: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+0001d790: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
+0001d7a0: 6e67 2827 5369 676e 6174 7572 6520 7661  ng('Signature va
+0001d7b0: 6c69 6461 7469 6f6e 2070 726f 626c 656d  lidation problem
+0001d7c0: 3a20 7b7d 207b 7d27 2e66 6f72 6d61 7428  : {} {}'.format(
+0001d7d0: 6462 5f62 6c6f 636b 5f68 6569 6768 742c  db_block_height,
+0001d7e0: 2064 625f 7472 616e 7361 6374 696f 6e29   db_transaction)
+0001d7f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d800: 2020 2020 2020 2020 2020 696e 7661 6c69            invali
+0001d810: 6420 3d20 696e 7661 6c69 6420 2b20 310a  d = invalid + 1.
+0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d830: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0001d840: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0001d850: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0001d860: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001d870: 6172 6e69 6e67 2827 5369 676e 6174 7572  arning('Signatur
+0001d880: 6520 7661 6c69 6461 7469 6f6e 2070 726f  e validation pro
+0001d890: 626c 656d 3a20 7b7d 207b 7d27 2e66 6f72  blem: {} {}'.for
+0001d8a0: 6d61 7428 6462 5f62 6c6f 636b 5f68 6569  mat(db_block_hei
+0001d8b0: 6768 742c 2064 625f 7472 616e 7361 6374  ght, db_transact
+0001d8c0: 696f 6e29 290a 2020 2020 2020 2020 2020  ion)).          
+0001d8d0: 2020 2020 2020 2020 2020 696e 7661 6c69            invali
+0001d8e0: 6420 3d20 696e 7661 6c69 6420 2b20 310a  d = invalid + 1.
+0001d8f0: 0a20 2020 2020 2020 2069 6620 696e 7661  .        if inva
+0001d900: 6c69 6420 3d3d 2030 3a0a 2020 2020 2020  lid == 0:.      
+0001d910: 2020 2020 2020 6e6f 6465 2e6c 6f67 6765        node.logge
+0001d920: 722e 6170 705f 6c6f 672e 7761 726e 696e  r.app_log.warnin
+0001d930: 6728 2741 6c6c 2074 7261 6e73 6163 6974  g('All transacit
+0001d940: 6f6e 7320 696e 2074 6865 206c 6f63 616c  ons in the local
+0001d950: 206c 6564 6765 7220 6172 6520 7661 6c69   ledger are vali
+0001d960: 6427 290a 0a20 2020 2065 7863 6570 7420  d')..    except 
+0001d970: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0001d980: 2020 2020 2020 2020 6e6f 6465 2e6c 6f67          node.log
+0001d990: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
+0001d9a0: 696e 6728 2745 7272 6f72 3a20 7b7d 272e  ing('Error: {}'.
+0001d9b0: 666f 726d 6174 2865 2929 0a20 2020 2020  format(e)).     
+0001d9c0: 2020 2072 6169 7365 0a0a 0a64 6566 2061     raise...def a
+0001d9d0: 6464 5f69 6e64 6963 6573 2864 625f 6861  dd_indices(db_ha
+0001d9e0: 6e64 6c65 723a 2064 6268 616e 646c 6572  ndler: dbhandler
+0001d9f0: 2e44 6248 616e 646c 6572 293a 0a20 2020  .DbHandler):.   
+0001da00: 2043 5245 4154 455f 5458 4944 345f 494e   CREATE_TXID4_IN
+0001da10: 4445 585f 4946 5f4e 4f54 5f45 5849 5354  DEX_IF_NOT_EXIST
+0001da20: 5320 3d20 2743 5245 4154 4520 494e 4445  S = 'CREATE INDE
+0001da30: 5820 4946 204e 4f54 2045 5849 5354 5320  X IF NOT EXISTS 
+0001da40: 5458 4944 345f 496e 6465 7820 4f4e 2074  TXID4_Index ON t
+0001da50: 7261 6e73 6163 7469 6f6e 7328 7375 6273  ransactions(subs
+0001da60: 7472 2873 6967 6e61 7475 7265 2c31 2c34  tr(signature,1,4
+0001da70: 2929 270a 2020 2020 4352 4541 5445 5f4d  ))'.    CREATE_M
+0001da80: 4953 435f 424c 4f43 4b5f 4845 4947 4854  ISC_BLOCK_HEIGHT
+0001da90: 5f49 4e44 4558 5f49 465f 4e4f 545f 4558  _INDEX_IF_NOT_EX
+0001daa0: 4953 5453 203d 2022 4352 4541 5445 2049  ISTS = "CREATE I
+0001dab0: 4e44 4558 2049 4620 4e4f 5420 4558 4953  NDEX IF NOT EXIS
+0001dac0: 5453 2027 4d69 7363 2042 6c6f 636b 2048  TS 'Misc Block H
+0001dad0: 6569 6768 7420 496e 6465 7827 206f 6e20  eight Index' on 
+0001dae0: 6d69 7363 2862 6c6f 636b 5f68 6569 6768  misc(block_heigh
+0001daf0: 7429 220a 0a20 2020 206e 6f64 652e 6c6f  t)"..    node.lo
+0001db00: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
+0001db10: 6e69 6e67 2827 4372 6561 7469 6e67 2069  ning('Creating i
+0001db20: 6e64 6963 6573 2729 0a0a 2020 2020 2320  ndices')..    # 
+0001db30: 6c65 6467 6572 2e64 620a 2020 2020 6966  ledger.db.    if
+0001db40: 206e 6f74 206e 6f64 652e 6f6c 645f 7371   not node.old_sq
+0001db50: 6c69 7465 3a0a 2020 2020 2020 2020 6462  lite:.        db
+0001db60: 5f68 616e 646c 6572 2e65 7865 6375 7465  _handler.execute
+0001db70: 2864 625f 6861 6e64 6c65 722e 682c 2043  (db_handler.h, C
+0001db80: 5245 4154 455f 5458 4944 345f 494e 4445  REATE_TXID4_INDE
+0001db90: 585f 4946 5f4e 4f54 5f45 5849 5354 5329  X_IF_NOT_EXISTS)
+0001dba0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001dbb0: 2020 206e 6f64 652e 6c6f 6767 6572 2e61     node.logger.a
+0001dbc0: 7070 5f6c 6f67 2e77 6172 6e69 6e67 2827  pp_log.warning('
+0001dbd0: 5365 7474 696e 6720 6f6c 645f 7371 6c69  Setting old_sqli
+0001dbe0: 7465 2069 7320 5472 7565 2c20 6c6f 6f6b  te is True, look
+0001dbf0: 7570 7320 7769 6c6c 2062 6520 736c 6f77  ups will be slow
+0001dc00: 6572 2e27 290a 2020 2020 6462 5f68 616e  er.').    db_han
+0001dc10: 646c 6572 2e65 7865 6375 7465 2864 625f  dler.execute(db_
+0001dc20: 6861 6e64 6c65 722e 682c 2043 5245 4154  handler.h, CREAT
+0001dc30: 455f 4d49 5343 5f42 4c4f 434b 5f48 4549  E_MISC_BLOCK_HEI
+0001dc40: 4748 545f 494e 4445 585f 4946 5f4e 4f54  GHT_INDEX_IF_NOT
+0001dc50: 5f45 5849 5354 5329 0a0a 2020 2020 2320  _EXISTS)..    # 
+0001dc60: 6879 7065 722e 6462 0a20 2020 2069 6620  hyper.db.    if 
+0001dc70: 6e6f 7420 6e6f 6465 2e6f 6c64 5f73 716c  not node.old_sql
+0001dc80: 6974 653a 0a20 2020 2020 2020 2064 625f  ite:.        db_
+0001dc90: 6861 6e64 6c65 722e 6578 6563 7574 6528  handler.execute(
+0001dca0: 6462 5f68 616e 646c 6572 2e68 322c 2043  db_handler.h2, C
+0001dcb0: 5245 4154 455f 5458 4944 345f 494e 4445  REATE_TXID4_INDE
+0001dcc0: 585f 4946 5f4e 4f54 5f45 5849 5354 5329  X_IF_NOT_EXISTS)
+0001dcd0: 0a20 2020 2064 625f 6861 6e64 6c65 722e  .    db_handler.
+0001dce0: 6578 6563 7574 6528 6462 5f68 616e 646c  execute(db_handl
+0001dcf0: 6572 2e68 322c 2043 5245 4154 455f 4d49  er.h2, CREATE_MI
+0001dd00: 5343 5f42 4c4f 434b 5f48 4549 4748 545f  SC_BLOCK_HEIGHT_
+0001dd10: 494e 4445 585f 4946 5f4e 4f54 5f45 5849  INDEX_IF_NOT_EXI
+0001dd20: 5354 5329 0a0a 2020 2020 2320 5241 4d20  STS)..    # RAM 
+0001dd30: 6f72 2068 7970 6572 2e64 620a 2020 2020  or hyper.db.    
+0001dd40: 6966 206e 6f74 206e 6f64 652e 6f6c 645f  if not node.old_
+0001dd50: 7371 6c69 7465 3a0a 2020 2020 2020 2020  sqlite:.        
+0001dd60: 6462 5f68 616e 646c 6572 2e65 7865 6375  db_handler.execu
+0001dd70: 7465 2864 625f 6861 6e64 6c65 722e 632c  te(db_handler.c,
+0001dd80: 2043 5245 4154 455f 5458 4944 345f 494e   CREATE_TXID4_IN
+0001dd90: 4445 585f 4946 5f4e 4f54 5f45 5849 5354  DEX_IF_NOT_EXIST
+0001dda0: 5329 0a20 2020 2064 625f 6861 6e64 6c65  S).    db_handle
+0001ddb0: 722e 6578 6563 7574 6528 6462 5f68 616e  r.execute(db_han
+0001ddc0: 646c 6572 2e63 2c20 4352 4541 5445 5f4d  dler.c, CREATE_M
+0001ddd0: 4953 435f 424c 4f43 4b5f 4845 4947 4854  ISC_BLOCK_HEIGHT
+0001dde0: 5f49 4e44 4558 5f49 465f 4e4f 545f 4558  _INDEX_IF_NOT_EX
+0001ddf0: 4953 5453 290a 0a20 2020 206e 6f64 652e  ISTS)..    node.
+0001de00: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001de10: 6172 6e69 6e67 2827 4669 6e69 7368 6564  arning('Finished
+0001de20: 2063 7265 6174 696e 6720 696e 6469 6365   creating indice
+0001de30: 7327 290a 0a0a 6966 205f 5f6e 616d 655f  s')...if __name_
+0001de40: 5f20 3d3d 2027 5f5f 6d61 696e 5f5f 273a  _ == '__main__':
+0001de50: 0a20 2020 2023 2063 6c61 7373 6573 0a20  .    # classes. 
+0001de60: 2020 206e 6f64 6520 3d20 5f6e 6f64 652e     node = _node.
+0001de70: 4e6f 6465 2829 0a20 2020 206e 6f64 652e  Node().    node.
+0001de80: 6c6f 6767 6572 203d 206c 6f67 6765 722e  logger = logger.
+0001de90: 4c6f 6767 6572 2829 0a20 2020 206e 6f64  Logger().    nod
+0001dea0: 652e 6b65 7973 203d 206b 6579 732e 4b65  e.keys = keys.Ke
+0001deb0: 7973 2829 0a0a 2020 2020 6e6f 6465 2e69  ys()..    node.i
+0001dec0: 735f 7465 7374 6e65 7420 3d20 4661 6c73  s_testnet = Fals
+0001ded0: 650a 2020 2020 2320 7265 676e 6574 2074  e.    # regnet t
+0001dee0: 616b 6573 206f 7665 7220 7465 7374 6e65  akes over testne
+0001def0: 740a 2020 2020 6e6f 6465 2e69 735f 7265  t.    node.is_re
+0001df00: 676e 6574 203d 2046 616c 7365 0a20 2020  gnet = False.   
+0001df10: 2023 2069 6620 6974 2773 206e 6f74 2074   # if it's not t
+0001df20: 6573 746e 6574 2c20 6e6f 7220 7265 676e  estnet, nor regn
+0001df30: 6574 2c20 6974 2773 206d 6169 6e6e 6574  et, it's mainnet
+0001df40: 0a20 2020 206e 6f64 652e 6973 5f6d 6169  .    node.is_mai
+0001df50: 6e6e 6574 203d 2054 7275 650a 0a20 2020  nnet = True..   
+0001df60: 2063 6f6e 6669 6720 3d20 6f70 7469 6f6e   config = option
+0001df70: 732e 4765 7428 290a 2020 2020 636f 6e66  s.Get().    conf
+0001df80: 6967 2e72 6561 6428 290a 2020 2020 2320  ig.read().    # 
+0001df90: 636c 6173 7365 730a 0a20 2020 206e 6f64  classes..    nod
+0001dfa0: 652e 6170 705f 7665 7273 696f 6e20 3d20  e.app_version = 
+0001dfb0: 5645 5253 494f 4e0a 2020 2020 2320 544f  VERSION.    # TO
+0001dfc0: 444f 3a20 7765 2063 6f75 6c64 206a 7573  DO: we could jus
+0001dfd0: 7420 6c6f 6f70 206f 7665 7220 636f 6e66  t loop over conf
+0001dfe0: 6967 2069 7465 6d73 2c20 616e 6420 6173  ig items, and as
+0001dff0: 7369 676e 2074 6865 6d20 746f 206e 6f64  sign them to nod
+0001e000: 652e 0a20 2020 2023 206f 7220 6a75 7374  e..    # or just
+0001e010: 2064 6f20 6e6f 6465 2e63 6f6e 6669 6720   do node.config 
+0001e020: 3d20 636f 6e66 6967 0a20 2020 2023 2061  = config.    # a
+0001e030: 6e64 2075 7365 206e 6f64 652e 636f 6e66  nd use node.conf
+0001e040: 6967 2e70 6f72 742e 2e2e 2061 736f 0a0a  ig.port... aso..
+0001e050: 2020 2020 2320 544f 444f 3a20 5369 6d70      # TODO: Simp
+0001e060: 6c69 6679 2e20 4a75 7374 2064 6f20 6e6f  lify. Just do no
+0001e070: 6465 2e63 6f6e 6669 6720 3d20 636f 6e66  de.config = conf
+0001e080: 6967 2c20 7468 656e 2075 7365 206e 6f64  ig, then use nod
+0001e090: 652e 636f 6e66 6967 2e72 6571 7569 7265  e.config.require
+0001e0a0: 645f 6f70 7469 6f6e 0a20 2020 206e 6f64  d_option.    nod
+0001e0b0: 652e 7665 7273 696f 6e20 3d20 636f 6e66  e.version = conf
+0001e0c0: 6967 2e76 6572 7369 6f6e 0a20 2020 206e  ig.version.    n
+0001e0d0: 6f64 652e 6465 6275 675f 6c65 7665 6c20  ode.debug_level 
+0001e0e0: 3d20 636f 6e66 6967 2e64 6562 7567 5f6c  = config.debug_l
+0001e0f0: 6576 656c 0a20 2020 206e 6f64 652e 706f  evel.    node.po
+0001e100: 7274 203d 2063 6f6e 6669 672e 706f 7274  rt = config.port
+0001e110: 0a20 2020 206e 6f64 652e 7665 7269 6679  .    node.verify
+0001e120: 203d 2063 6f6e 6669 672e 7665 7269 6679   = config.verify
+0001e130: 0a20 2020 206e 6f64 652e 7468 7265 6164  .    node.thread
+0001e140: 5f6c 696d 6974 203d 2063 6f6e 6669 672e  _limit = config.
+0001e150: 7468 7265 6164 5f6c 696d 6974 0a20 2020  thread_limit.   
+0001e160: 206e 6f64 652e 7265 6275 696c 645f 6462   node.rebuild_db
+0001e170: 203d 2063 6f6e 6669 672e 7265 6275 696c   = config.rebuil
+0001e180: 645f 6462 0a20 2020 206e 6f64 652e 6465  d_db.    node.de
+0001e190: 6275 6720 3d20 636f 6e66 6967 2e64 6562  bug = config.deb
+0001e1a0: 7567 0a20 2020 206e 6f64 652e 6465 6275  ug.    node.debu
+0001e1b0: 675f 6c65 7665 6c20 3d20 636f 6e66 6967  g_level = config
+0001e1c0: 2e64 6562 7567 5f6c 6576 656c 0a20 2020  .debug_level.   
+0001e1d0: 206e 6f64 652e 7061 7573 6520 3d20 636f   node.pause = co
+0001e1e0: 6e66 6967 2e70 6175 7365 0a20 2020 206e  nfig.pause.    n
+0001e1f0: 6f64 652e 6c65 6467 6572 5f70 6174 6820  ode.ledger_path 
+0001e200: 3d20 636f 6e66 6967 2e6c 6564 6765 725f  = config.ledger_
+0001e210: 7061 7468 0a20 2020 206e 6f64 652e 6879  path.    node.hy
+0001e220: 7065 725f 7061 7468 203d 2063 6f6e 6669  per_path = confi
+0001e230: 672e 6879 7065 725f 7061 7468 0a20 2020  g.hyper_path.   
+0001e240: 206e 6f64 652e 6879 7065 725f 7265 636f   node.hyper_reco
+0001e250: 6d70 7265 7373 203d 2063 6f6e 6669 672e  mpress = config.
+0001e260: 6879 7065 725f 7265 636f 6d70 7265 7373  hyper_recompress
+0001e270: 0a20 2020 206e 6f64 652e 746f 7220 3d20  .    node.tor = 
+0001e280: 636f 6e66 6967 2e74 6f72 0a20 2020 206e  config.tor.    n
+0001e290: 6f64 652e 7261 6d20 3d20 636f 6e66 6967  ode.ram = config
+0001e2a0: 2e72 616d 0a20 2020 206e 6f64 652e 7665  .ram.    node.ve
+0001e2b0: 7273 696f 6e5f 616c 6c6f 7720 3d20 636f  rsion_allow = co
+0001e2c0: 6e66 6967 2e76 6572 7369 6f6e 5f61 6c6c  nfig.version_all
+0001e2d0: 6f77 0a20 2020 206e 6f64 652e 7265 7665  ow.    node.reve
+0001e2e0: 616c 5f61 6464 7265 7373 203d 2063 6f6e  al_address = con
+0001e2f0: 6669 672e 7265 7665 616c 5f61 6464 7265  fig.reveal_addre
+0001e300: 7373 0a20 2020 206e 6f64 652e 7465 726d  ss.    node.term
+0001e310: 696e 616c 5f6f 7574 7075 7420 3d20 636f  inal_output = co
+0001e320: 6e66 6967 2e74 6572 6d69 6e61 6c5f 6f75  nfig.terminal_ou
+0001e330: 7470 7574 0a20 2020 206e 6f64 652e 6567  tput.    node.eg
+0001e340: 7265 7373 203d 2063 6f6e 6669 672e 6567  ress = config.eg
+0001e350: 7265 7373 0a20 2020 206e 6f64 652e 6765  ress.    node.ge
+0001e360: 6e65 7369 7320 3d20 636f 6e66 6967 2e67  nesis = config.g
+0001e370: 656e 6573 6973 0a20 2020 206e 6f64 652e  enesis.    node.
+0001e380: 6163 6365 7074 5f70 6565 7273 203d 2063  accept_peers = c
+0001e390: 6f6e 6669 672e 6163 6365 7074 5f70 6565  onfig.accept_pee
+0001e3a0: 7273 0a20 2020 206e 6f64 652e 6675 6c6c  rs.    node.full
+0001e3b0: 5f6c 6564 6765 7220 3d20 636f 6e66 6967  _ledger = config
+0001e3c0: 2e66 756c 6c5f 6c65 6467 6572 0a20 2020  .full_ledger.   
+0001e3d0: 206e 6f64 652e 7472 6163 655f 6462 5f63   node.trace_db_c
+0001e3e0: 616c 6c73 203d 2063 6f6e 6669 672e 7472  alls = config.tr
+0001e3f0: 6163 655f 6462 5f63 616c 6c73 0a20 2020  ace_db_calls.   
+0001e400: 206e 6f64 652e 6865 6176 7933 5f70 6174   node.heavy3_pat
+0001e410: 6820 3d20 636f 6e66 6967 2e68 6561 7679  h = config.heavy
+0001e420: 335f 7061 7468 0a20 2020 206e 6f64 652e  3_path.    node.
+0001e430: 6f6c 645f 7371 6c69 7465 203d 2063 6f6e  old_sqlite = con
+0001e440: 6669 672e 6f6c 645f 7371 6c69 7465 0a20  fig.old_sqlite. 
+0001e450: 2020 206e 6f64 652e 6865 6176 7920 3d20     node.heavy = 
+0001e460: 636f 6e66 6967 2e68 6561 7679 0a0a 2020  config.heavy..  
+0001e470: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+0001e480: 705f 6c6f 6720 3d20 6c6f 672e 6c6f 6728  p_log = log.log(
+0001e490: 276e 6f64 652e 6c6f 6727 2c20 6e6f 6465  'node.log', node
+0001e4a0: 2e64 6562 7567 5f6c 6576 656c 2c20 6e6f  .debug_level, no
+0001e4b0: 6465 2e74 6572 6d69 6e61 6c5f 6f75 7470  de.terminal_outp
+0001e4c0: 7574 290a 2020 2020 6e6f 6465 2e6c 6f67  ut).    node.log
+0001e4d0: 6765 722e 6170 705f 6c6f 672e 7761 726e  ger.app_log.warn
+0001e4e0: 696e 6728 2743 6f6e 6669 6775 7261 7469  ing('Configurati
+0001e4f0: 6f6e 2073 6574 7469 6e67 7320 6c6f 6164  on settings load
+0001e500: 6564 2729 0a20 2020 206e 6f64 652e 6c6f  ed').    node.lo
+0001e510: 6767 6572 2e61 7070 5f6c 6f67 2e77 6172  gger.app_log.war
+0001e520: 6e69 6e67 2866 2750 7974 686f 6e20 7665  ning(f'Python ve
+0001e530: 7273 696f 6e3a 207b 6e6f 6465 2e70 795f  rsion: {node.py_
+0001e540: 7665 7273 696f 6e7d 2729 0a0a 2020 2020  version}')..    
+0001e550: 2320 7570 6772 6164 6520 7761 6c6c 6574  # upgrade wallet
+0001e560: 206c 6f63 6174 696f 6e20 6166 7465 7220   location after 
+0001e570: 6e75 6974 6b61 2d72 6571 7569 7265 6420  nuitka-required 
+0001e580: 2266 696c 6573 2220 666f 6c64 6572 2069  "files" folder i
+0001e590: 6e74 726f 6475 6374 696f 6e0a 2020 2020  ntroduction.    
+0001e5a0: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
+0001e5b0: 7328 272e 2e2f 7761 6c6c 6574 2e64 6572  s('../wallet.der
+0001e5c0: 2729 2061 6e64 206e 6f74 206f 732e 7061  ') and not os.pa
+0001e5d0: 7468 2e65 7869 7374 7328 2777 616c 6c65  th.exists('walle
+0001e5e0: 742e 6465 7227 2920 616e 6420 2757 696e  t.der') and 'Win
+0001e5f0: 646f 7773 2720 696e 2070 6c61 7466 6f72  dows' in platfor
+0001e600: 6d2e 7379 7374 656d 2829 3a0a 2020 2020  m.system():.    
+0001e610: 2020 2020 7072 696e 7428 2755 7067 7261      print('Upgra
+0001e620: 6469 6e67 2077 616c 6c65 7420 6c6f 6361  ding wallet loca
+0001e630: 7469 6f6e 2729 0a20 2020 2020 2020 206f  tion').        o
+0001e640: 732e 7265 6e61 6d65 2827 2e2e 2f77 616c  s.rename('../wal
+0001e650: 6c65 742e 6465 7227 2c20 2777 616c 6c65  let.der', 'walle
+0001e660: 742e 6465 7227 290a 2020 2020 2320 7570  t.der').    # up
+0001e670: 6772 6164 6520 7761 6c6c 6574 206c 6f63  grade wallet loc
+0001e680: 6174 696f 6e20 6166 7465 7220 6e75 6974  ation after nuit
+0001e690: 6b61 2d72 6571 7569 7265 6420 2266 696c  ka-required "fil
+0001e6a0: 6573 2220 666f 6c64 6572 2069 6e74 726f  es" folder intro
+0001e6b0: 6475 6374 696f 6e0a 0a20 2020 2069 6620  duction..    if 
+0001e6c0: 6e6f 7420 6e6f 6465 2e66 756c 6c5f 6c65  not node.full_le
+0001e6d0: 6467 6572 2061 6e64 206f 732e 7061 7468  dger and os.path
+0001e6e0: 2e65 7869 7374 7328 6e6f 6465 2e6c 6564  .exists(node.led
+0001e6f0: 6765 725f 7061 7468 2920 616e 6420 6e6f  ger_path) and no
+0001e700: 6465 2e69 735f 6d61 696e 6e65 743a 0a20  de.is_mainnet:. 
+0001e710: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
+0001e720: 286e 6f64 652e 6c65 6467 6572 5f70 6174  (node.ledger_pat
+0001e730: 6829 0a20 2020 2020 2020 206e 6f64 652e  h).        node.
+0001e740: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001e750: 6172 6e69 6e67 2827 5265 6d6f 7665 6420  arning('Removed 
+0001e760: 6675 6c6c 206c 6564 6765 7220 666f 7220  full ledger for 
+0001e770: 6879 7065 7262 6c6f 636b 206d 6f64 6527  hyperblock mode'
+0001e780: 290a 2020 2020 6966 206e 6f74 206e 6f64  ).    if not nod
+0001e790: 652e 6675 6c6c 5f6c 6564 6765 723a 0a20  e.full_ledger:. 
+0001e7a0: 2020 2020 2020 206e 6f64 652e 6c6f 6767         node.logg
+0001e7b0: 6572 2e61 7070 5f6c 6f67 2e77 6172 6e69  er.app_log.warni
+0001e7c0: 6e67 2827 436c 6f6e 696e 6720 6879 7065  ng('Cloning hype
+0001e7d0: 7262 6c6f 636b 7320 746f 206c 6564 6765  rblocks to ledge
+0001e7e0: 7220 6669 6c65 2729 0a20 2020 2020 2020  r file').       
+0001e7f0: 2073 6875 7469 6c2e 636f 7079 286e 6f64   shutil.copy(nod
+0001e800: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+0001e810: 6465 2e6c 6564 6765 725f 7061 7468 2920  de.ledger_path) 
+0001e820: 2023 2068 6163 6b65 6420 746f 2072 656d   # hacked to rem
+0001e830: 6f76 6520 616c 6c20 7468 6520 656e 646c  ove all the endl
+0001e840: 6573 7320 6368 6563 6b73 0a20 2020 2074  ess checks.    t
+0001e850: 7279 3a0a 2020 2020 2020 2020 2320 6372  ry:.        # cr
+0001e860: 6561 7465 2061 2070 6c75 6769 6e20 6d61  eate a plugin ma
+0001e870: 6e61 6765 722c 206c 6f61 6420 616c 6c20  nager, load all 
+0001e880: 706c 7567 696e 206d 6f64 756c 6573 2061  plugin modules a
+0001e890: 6e64 2069 6e69 740a 2020 2020 2020 2020  nd init.        
+0001e8a0: 6e6f 6465 2e70 6c75 6769 6e5f 6d61 6e61  node.plugin_mana
+0001e8b0: 6765 7220 3d20 706c 7567 696e 732e 506c  ger = plugins.Pl
+0001e8c0: 7567 696e 4d61 6e61 6765 7228 6170 705f  uginManager(app_
+0001e8d0: 6c6f 673d 6e6f 6465 2e6c 6f67 6765 722e  log=node.logger.
+0001e8e0: 6170 705f 6c6f 672c 2063 6f6e 6669 673d  app_log, config=
+0001e8f0: 636f 6e66 6967 2c20 696e 6974 3d54 7275  config, init=Tru
+0001e900: 6529 0a20 2020 2020 2020 2023 2067 6574  e).        # get
+0001e910: 2074 6865 2070 6f74 656e 7469 616c 2065   the potential e
+0001e920: 7874 7261 2063 6f6d 6d61 6e64 2070 7265  xtra command pre
+0001e930: 6669 7865 7320 6672 6f6d 2070 6c75 6769  fixes from plugi
+0001e940: 6e0a 2020 2020 2020 2020 6578 7472 615f  n.        extra_
+0001e950: 636f 6d6d 616e 6473 203d 207b 7d20 2023  commands = {}  #
+0001e960: 2067 6c6f 6261 6c20 7661 722c 2075 7365   global var, use
+0001e970: 6420 6279 2074 6865 2073 6572 7665 7220  d by the server 
+0001e980: 7061 7274 2e0a 2020 2020 2020 2020 6578  part..        ex
+0001e990: 7472 615f 636f 6d6d 616e 6473 203d 206e  tra_commands = n
+0001e9a0: 6f64 652e 706c 7567 696e 5f6d 616e 6167  ode.plugin_manag
+0001e9b0: 6572 2e65 7865 6375 7465 5f66 696c 7465  er.execute_filte
+0001e9c0: 725f 686f 6f6b 2827 6578 7472 615f 636f  r_hook('extra_co
+0001e9d0: 6d6d 616e 6473 5f70 7265 6669 7865 7327  mmands_prefixes'
+0001e9e0: 2c20 6578 7472 615f 636f 6d6d 616e 6473  , extra_commands
+0001e9f0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+0001ea00: 2745 7874 7261 2070 7265 6669 7865 733a  'Extra prefixes:
+0001ea10: 2027 2c20 272c 272e 6a6f 696e 2865 7874   ', ','.join(ext
+0001ea20: 7261 5f63 6f6d 6d61 6e64 732e 6b65 7973  ra_commands.keys
+0001ea30: 2829 2929 0a0a 2020 2020 2020 2020 7365  ()))..        se
+0001ea40: 7475 705f 6e65 745f 7479 7065 2829 0a20  tup_net_type(). 
+0001ea50: 2020 2020 2020 206c 6f61 645f 6b65 7973         load_keys
+0001ea60: 2829 0a0a 2020 2020 2020 2020 2320 6e65  ()..        # ne
+0001ea70: 6564 6564 2066 6f72 2064 6f63 6b65 7220  eded for docker 
+0001ea80: 6c6f 6773 0a20 2020 2020 2020 206e 6f64  logs.        nod
+0001ea90: 652e 6c6f 6767 6572 2e61 7070 5f6c 6f67  e.logger.app_log
+0001eaa0: 2e77 6172 6e69 6e67 2866 2743 6865 636b  .warning(f'Check
+0001eab0: 696e 6720 4865 6176 7933 2066 696c 652c  ing Heavy3 file,
+0001eac0: 2063 616e 2074 616b 6520 7570 2074 6f20   can take up to 
+0001ead0: 3520 6d69 6e75 7465 732e 2e2e 2729 0a20  5 minutes...'). 
+0001eae0: 2020 2020 2020 206d 696e 696e 675f 6865         mining_he
+0001eaf0: 6176 7933 2e6d 696e 696e 675f 6f70 656e  avy3.mining_open
+0001eb00: 286e 6f64 652e 6865 6176 7933 5f70 6174  (node.heavy3_pat
+0001eb10: 6829 0a20 2020 2020 2020 206e 6f64 652e  h).        node.
+0001eb20: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001eb30: 6172 6e69 6e67 2866 2748 6561 7679 3320  arning(f'Heavy3 
+0001eb40: 6669 6c65 204f 6b21 2729 0a0a 2020 2020  file Ok!')..    
+0001eb50: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0001eb60: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+0001eb70: 6627 5374 6174 7573 3a20 5374 6172 7469  f'Status: Starti
+0001eb80: 6e67 206e 6f64 6520 7665 7273 696f 6e20  ng node version 
+0001eb90: 7b56 4552 5349 4f4e 7d27 290a 2020 2020  {VERSION}').    
+0001eba0: 2020 2020 6e6f 6465 2e73 7461 7274 7570      node.startup
+0001ebb0: 5f74 696d 6520 3d20 7469 6d65 2e74 696d  _time = time.tim
+0001ebc0: 6528 290a 2020 2020 2020 2020 7472 793a  e().        try:
+0001ebd0: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
+0001ebe0: 6465 2e70 6565 7273 203d 2070 6565 7273  de.peers = peers
+0001ebf0: 6861 6e64 6c65 722e 5065 6572 7328 6e6f  handler.Peers(no
+0001ec00: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+0001ec10: 672c 2063 6f6e 6669 673d 636f 6e66 6967  g, config=config
+0001ec20: 2c20 6e6f 6465 3d6e 6f64 6529 0a0a 2020  , node=node)..  
+0001ec30: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+0001ec40: 7428 7065 6572 732e 7065 6572 5f6c 6973  t(peers.peer_lis
+0001ec50: 745f 6f6c 645f 666f 726d 6174 2829 290a  t_old_format()).
+0001ec60: 2020 2020 2020 2020 2020 2020 2320 7379              # sy
+0001ec70: 732e 6578 6974 2829 0a0a 2020 2020 2020  s.exit()..      
+0001ec80: 2020 2020 2020 6e6f 6465 2e61 7069 6861        node.apiha
+0001ec90: 6e64 6c65 7220 3d20 6170 6968 616e 646c  ndler = apihandl
+0001eca0: 6572 2e41 7069 4861 6e64 6c65 7228 6e6f  er.ApiHandler(no
+0001ecb0: 6465 2e6c 6f67 6765 722e 6170 705f 6c6f  de.logger.app_lo
+0001ecc0: 672c 2063 6f6e 6669 6729 0a20 2020 2020  g, config).     
+0001ecd0: 2020 2020 2020 206d 702e 4d45 4d50 4f4f         mp.MEMPOO
+0001ece0: 4c20 3d20 6d70 2e4d 656d 706f 6f6c 286e  L = mp.Mempool(n
+0001ecf0: 6f64 652e 6c6f 6767 6572 2e61 7070 5f6c  ode.logger.app_l
+0001ed00: 6f67 2c20 636f 6e66 6967 2c20 6e6f 6465  og, config, node
+0001ed10: 2e64 625f 6c6f 636b 2c20 6e6f 6465 2e69  .db_lock, node.i
+0001ed20: 735f 7465 7374 6e65 742c 2074 7261 6365  s_testnet, trace
+0001ed30: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+0001ed40: 7261 6365 5f64 625f 6361 6c6c 7329 0a0a  race_db_calls)..
+0001ed50: 2020 2020 2020 2020 2020 2020 6368 6563              chec
+0001ed60: 6b5f 696e 7465 6772 6974 7928 6e6f 6465  k_integrity(node
+0001ed70: 2e68 7970 6572 5f70 6174 6829 0a20 2020  .hyper_path).   
+0001ed80: 2020 2020 2020 2020 2023 504c 4143 4548           #PLACEH
+0001ed90: 4f4c 4445 5220 464f 5220 4652 4553 4820  OLDER FOR FRESH 
+0001eda0: 4859 5045 5242 4c4f 434b 2042 5549 4c44  HYPERBLOCK BUILD
+0001edb0: 4552 0a0a 2020 2020 2020 2020 2020 2020  ER..            
+0001edc0: 2320 6966 206e 6f64 652e 7265 6275 696c  # if node.rebuil
+0001edd0: 645f 6462 3a20 2364 6f65 7320 6e6f 7468  d_db: #does noth
+0001ede0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0001edf0: 2320 2020 2064 625f 6d61 696e 7465 6e61  #    db_maintena
+0001ee00: 6e63 6528 696e 6974 5f64 6174 6162 6173  nce(init_databas
+0001ee10: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0001ee20: 2320 6462 5f6d 616e 6167 6572 203d 2064  # db_manager = d
+0001ee30: 625f 6c6f 6f70 6572 2e44 624d 616e 6167  b_looper.DbManag
+0001ee40: 6572 286e 6f64 652e 6c6f 6767 6572 2e61  er(node.logger.a
+0001ee50: 7070 5f6c 6f67 290a 2020 2020 2020 2020  pp_log).        
+0001ee60: 2020 2020 2320 6462 5f6d 616e 6167 6572      # db_manager
+0001ee70: 2e73 7461 7274 2829 0a0a 2020 2020 2020  .start()..      
+0001ee80: 2020 2020 2020 6462 5f68 616e 646c 6572        db_handler
+0001ee90: 5f69 6e69 7469 616c 203d 2064 6268 616e  _initial = dbhan
+0001eea0: 646c 6572 2e44 6248 616e 646c 6572 286e  dler.DbHandler(n
+0001eeb0: 6f64 652e 696e 6465 785f 6462 2c20 6e6f  ode.index_db, no
+0001eec0: 6465 2e6c 6564 6765 725f 7061 7468 2c20  de.ledger_path, 
+0001eed0: 6e6f 6465 2e68 7970 6572 5f70 6174 682c  node.hyper_path,
+0001eee0: 206e 6f64 652e 7261 6d2c 206e 6f64 652e   node.ram, node.
+0001eef0: 6c65 6467 6572 5f72 616d 5f66 696c 652c  ledger_ram_file,
+0001ef00: 206e 6f64 652e 6c6f 6767 6572 2c20 7472   node.logger, tr
+0001ef10: 6163 655f 6462 5f63 616c 6c73 3d6e 6f64  ace_db_calls=nod
+0001ef20: 652e 7472 6163 655f 6462 5f63 616c 6c73  e.trace_db_calls
+0001ef30: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
+0001ef40: 6564 6765 725f 6368 6563 6b5f 6865 6967  edger_check_heig
+0001ef50: 6874 7328 6e6f 6465 2c20 6462 5f68 616e  hts(node, db_han
+0001ef60: 646c 6572 5f69 6e69 7469 616c 290a 0a20  dler_initial).. 
+0001ef70: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001ef80: 6465 2e72 6563 6f6d 7072 6573 733a 0a20  de.recompress:. 
+0001ef90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001efa0: 746f 646f 3a20 646f 206e 6f74 2063 6c6f  todo: do not clo
+0001efb0: 7365 2064 6174 6162 6173 6520 616e 6420  se database and 
+0001efc0: 6d6f 7665 2066 696c 6573 2c20 7377 6170  move files, swap
+0001efd0: 2074 6162 6c65 7320 696e 7374 6561 640a   tables instead.
+0001efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eff0: 6462 5f68 616e 646c 6572 5f69 6e69 7469  db_handler_initi
+0001f000: 616c 2e63 6c6f 7365 2829 0a20 2020 2020  al.close().     
+0001f010: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+0001f020: 7072 6573 735f 6c65 6467 6572 286e 6f64  press_ledger(nod
+0001f030: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001f040: 2020 2064 625f 6861 6e64 6c65 725f 696e     db_handler_in
+0001f050: 6974 6961 6c20 3d20 6462 6861 6e64 6c65  itial = dbhandle
+0001f060: 722e 4462 4861 6e64 6c65 7228 6e6f 6465  r.DbHandler(node
+0001f070: 2e69 6e64 6578 5f64 622c 206e 6f64 652e  .index_db, node.
+0001f080: 6c65 6467 6572 5f70 6174 682c 206e 6f64  ledger_path, nod
+0001f090: 652e 6879 7065 725f 7061 7468 2c20 6e6f  e.hyper_path, no
+0001f0a0: 6465 2e72 616d 2c20 6e6f 6465 2e6c 6564  de.ram, node.led
+0001f0b0: 6765 725f 7261 6d5f 6669 6c65 2c20 6e6f  ger_ram_file, no
+0001f0c0: 6465 2e6c 6f67 6765 722c 2074 7261 6365  de.logger, trace
+0001f0d0: 5f64 625f 6361 6c6c 733d 6e6f 6465 2e74  _db_calls=node.t
+0001f0e0: 7261 6365 5f64 625f 6361 6c6c 7329 0a0a  race_db_calls)..
+0001f0f0: 2020 2020 2020 2020 2020 2020 7261 6d5f              ram_
+0001f100: 696e 6974 2864 625f 6861 6e64 6c65 725f  init(db_handler_
+0001f110: 696e 6974 6961 6c29 0a20 2020 2020 2020  initial).       
+0001f120: 2020 2020 206e 6f64 655f 626c 6f63 6b5f       node_block_
+0001f130: 696e 6974 2864 625f 6861 6e64 6c65 725f  init(db_handler_
+0001f140: 696e 6974 6961 6c29 0a20 2020 2020 2020  initial).       
+0001f150: 2020 2020 2069 6e69 7469 616c 5f64 625f       initial_db_
+0001f160: 6368 6563 6b28 290a 0a20 2020 2020 2020  check()..       
+0001f170: 2020 2020 2069 6620 6e6f 7420 6e6f 6465       if not node
+0001f180: 2e69 735f 7265 676e 6574 3a0a 2020 2020  .is_regnet:.    
+0001f190: 2020 2020 2020 2020 2020 2020 7365 7175              sequ
+0001f1a0: 656e 6369 6e67 5f63 6865 636b 2864 625f  encing_check(db_
+0001f1b0: 6861 6e64 6c65 725f 696e 6974 6961 6c29  handler_initial)
+0001f1c0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0001f1d0: 206e 6f64 652e 7665 7269 6679 3a0a 2020   node.verify:.  
+0001f1e0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+0001f1f0: 7269 6679 2864 625f 6861 6e64 6c65 725f  rify(db_handler_
+0001f200: 696e 6974 6961 6c29 0a0a 2020 2020 2020  initial)..      
+0001f210: 2020 2020 2020 6164 645f 696e 6469 6365        add_indice
+0001f220: 7328 6462 5f68 616e 646c 6572 5f69 6e69  s(db_handler_ini
+0001f230: 7469 616c 290a 0a20 2020 2020 2020 2020  tial)..         
+0001f240: 2020 2023 2054 4f44 4f3a 2075 6e74 696c     # TODO: until
+0001f250: 2068 6572 652c 2077 6520 6172 6520 696e   here, we are in
+0001f260: 2073 696e 676c 6520 7573 6572 206d 6f64   single user mod
+0001f270: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
+0001f280: 2041 6c6c 2074 6865 2061 626f 7665 2067   All the above g
+0001f290: 6f65 7320 696e 746f 2061 2022 626f 6f74  oes into a "boot
+0001f2a0: 7570 2220 6675 6e63 7469 6f6e 2c20 7769  up" function, wi
+0001f2b0: 7468 206d 6574 686f 6473 2066 726f 6d20  th methods from 
+0001f2c0: 7369 6e67 6c65 5f75 7365 7220 6d6f 6475  single_user modu
+0001f2d0: 6c65 206f 6e6c 792e 0a0a 2020 2020 2020  le only...      
+0001f2e0: 2020 2020 2020 6966 206e 6f74 206e 6f64        if not nod
+0001f2f0: 652e 746f 723a 0a20 2020 2020 2020 2020  e.tor:.         
+0001f300: 2020 2020 2020 2023 2050 6f72 7420 3020         # Port 0 
+0001f310: 6d65 616e 7320 746f 2073 656c 6563 7420  means to select 
+0001f320: 616e 2061 7262 6974 7261 7279 2075 6e75  an arbitrary unu
+0001f330: 7365 6420 706f 7274 0a20 2020 2020 2020  sed port.       
+0001f340: 2020 2020 2020 2020 2068 6f73 742c 2070           host, p
+0001f350: 6f72 7420 3d20 2730 2e30 2e30 2e30 272c  ort = '0.0.0.0',
+0001f360: 2069 6e74 286e 6f64 652e 706f 7274 290a   int(node.port).
+0001f370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f380: 2054 6872 6561 6465 6454 4350 5365 7276   ThreadedTCPServ
+0001f390: 6572 2e61 6c6c 6f77 5f72 6575 7365 5f61  er.allow_reuse_a
+0001f3a0: 6464 7265 7373 203d 2054 7275 650a 2020  ddress = True.  
+0001f3b0: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+0001f3c0: 7265 6164 6564 5443 5053 6572 7665 722e  readedTCPServer.
+0001f3d0: 6461 656d 6f6e 5f74 6872 6561 6473 203d  daemon_threads =
+0001f3e0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0001f3f0: 2020 2020 2020 5468 7265 6164 6564 5443        ThreadedTC
+0001f400: 5053 6572 7665 722e 7469 6d65 6f75 7420  PServer.timeout 
+0001f410: 3d20 3630 0a20 2020 2020 2020 2020 2020  = 60.           
+0001f420: 2020 2020 2054 6872 6561 6465 6454 4350       ThreadedTCP
+0001f430: 5365 7276 6572 2e72 6571 7565 7374 5f71  Server.request_q
+0001f440: 7565 7565 5f73 697a 6520 3d20 3130 300a  ueue_size = 100.
+0001f450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f460: 2073 6572 7665 7220 3d20 5468 7265 6164   server = Thread
+0001f470: 6564 5443 5053 6572 7665 7228 2868 6f73  edTCPServer((hos
+0001f480: 742c 2070 6f72 7429 2c20 5468 7265 6164  t, port), Thread
+0001f490: 6564 5443 5052 6571 7565 7374 4861 6e64  edTCPRequestHand
+0001f4a0: 6c65 7229 0a20 2020 2020 2020 2020 2020  ler).           
+0001f4b0: 2020 2020 2069 702c 206e 6f64 652e 706f       ip, node.po
+0001f4c0: 7274 203d 2073 6572 7665 722e 7365 7276  rt = server.serv
+0001f4d0: 6572 5f61 6464 7265 7373 0a0a 2020 2020  er_address..    
+0001f4e0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+0001f4f0: 6172 7420 6120 7468 7265 6164 2077 6974  art a thread wit
+0001f500: 6820 7468 6520 7365 7276 6572 202d 2d20  h the server -- 
+0001f510: 7468 6174 2074 6872 6561 6420 7769 6c6c  that thread will
+0001f520: 2074 6865 6e20 7374 6172 7420 6f6e 650a   then start one.
+0001f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f540: 2320 6d6f 7265 2074 6872 6561 6420 666f  # more thread fo
+0001f550: 7220 6561 6368 2072 6571 7565 7374 0a0a  r each request..
+0001f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f570: 7365 7276 6572 5f74 6872 6561 6420 3d20  server_thread = 
+0001f580: 7468 7265 6164 696e 672e 5468 7265 6164  threading.Thread
+0001f590: 2874 6172 6765 743d 7365 7276 6572 2e73  (target=server.s
+0001f5a0: 6572 7665 5f66 6f72 6576 6572 290a 2020  erve_forever).  
+0001f5b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001f5c0: 7276 6572 5f74 6872 6561 642e 6461 656d  rver_thread.daem
+0001f5d0: 6f6e 203d 2054 7275 650a 2020 2020 2020  on = True.      
+0001f5e0: 2020 2020 2020 2020 2020 7365 7276 6572            server
+0001f5f0: 5f74 6872 6561 642e 7374 6172 7428 290a  _thread.start().
+0001f600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f610: 206e 6f64 652e 6c6f 6767 6572 2e61 7070   node.logger.app
+0001f620: 5f6c 6f67 2e77 6172 6e69 6e67 2866 2753  _log.warning(f'S
+0001f630: 7461 7475 733a 2053 6572 7665 7220 6c6f  tatus: Server lo
+0001f640: 6f70 2072 756e 6e69 6e67 206f 6e20 7b69  op running on {i
+0001f650: 707d 3a7b 6e6f 6465 2e70 6f72 747d 2729  p}:{node.port}')
+0001f660: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0001f670: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001f680: 2020 2020 6e6f 6465 2e6c 6f67 6765 722e      node.logger.
+0001f690: 6170 705f 6c6f 672e 7761 726e 696e 6728  app_log.warning(
+0001f6a0: 2753 7461 7475 733a 204e 6f74 2073 7461  'Status: Not sta
+0001f6b0: 7274 696e 6720 6120 6c6f 6361 6c20 7365  rting a local se
+0001f6c0: 7276 6572 2074 6f20 636f 6e63 6561 6c20  rver to conceal 
+0001f6d0: 6964 656e 7469 7479 206f 6e20 546f 7220  identity on Tor 
+0001f6e0: 6e65 7477 6f72 6b27 290a 0a20 2020 2020  network')..     
+0001f6f0: 2020 2020 2020 2023 2073 7461 7274 2063         # start c
+0001f700: 6f6e 6e65 6374 696f 6e20 6d61 6e61 6765  onnection manage
+0001f710: 720a 2020 2020 2020 2020 2020 2020 636f  r.            co
+0001f720: 6e6e 6563 7469 6f6e 5f6d 616e 6167 6572  nnection_manager
+0001f730: 203d 2063 6f6e 6e65 6374 696f 6e6d 616e   = connectionman
+0001f740: 6167 6572 2e43 6f6e 6e65 6374 696f 6e4d  ager.ConnectionM
+0001f750: 616e 6167 6572 286e 6f64 652c 206d 7029  anager(node, mp)
+0001f760: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001f770: 6e65 6374 696f 6e5f 6d61 6e61 6765 722e  nection_manager.
+0001f780: 7374 6172 7428 290a 2020 2020 2020 2020  start().        
+0001f790: 2020 2020 2320 7374 6172 7420 636f 6e6e      # start conn
+0001f7a0: 6563 7469 6f6e 206d 616e 6167 6572 0a0a  ection manager..
+0001f7b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0001f7c0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0001f7d0: 2020 2020 2020 2020 2020 206e 6f64 652e             node.
+0001f7e0: 6c6f 6767 6572 2e61 7070 5f6c 6f67 2e77  logger.app_log.w
+0001f7f0: 6172 6e69 6e67 2865 290a 2020 2020 2020  arning(e).      
+0001f800: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
+0001f810: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0001f820: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0001f830: 6e6f 6465 2e6c 6f67 6765 722e 6170 705f  node.logger.app_
+0001f840: 6c6f 672e 7761 726e 696e 6728 6529 0a20  log.warning(e). 
+0001f850: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+0001f860: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+0001f870: 705f 6c6f 672e 7761 726e 696e 6728 2753  p_log.warning('S
+0001f880: 7461 7475 733a 2042 6973 6d75 7468 206c  tatus: Bismuth l
+0001f890: 6f6f 7020 7275 6e6e 696e 672e 2729 0a0a  oop running.')..
+0001f8a0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+0001f8b0: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+0001f8c0: 4953 5f53 544f 5050 494e 473a 0a20 2020  IS_STOPPING:.   
+0001f8d0: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
+0001f8e0: 2e64 625f 6c6f 636b 2e6c 6f63 6b65 6428  .db_lock.locked(
+0001f8f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001f900: 2020 2074 696d 652e 736c 6565 7028 302e     time.sleep(0.
+0001f910: 3529 0a20 2020 2020 2020 2020 2020 2065  5).            e
+0001f920: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001f930: 2020 2020 206d 696e 696e 675f 6865 6176       mining_heav
+0001f940: 7933 2e6d 696e 696e 675f 636c 6f73 6528  y3.mining_close(
+0001f950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001f960: 2020 6e6f 6465 2e6c 6f67 6765 722e 6170    node.logger.ap
+0001f970: 705f 6c6f 672e 7761 726e 696e 6728 2753  p_log.warning('S
+0001f980: 7461 7475 733a 2053 6563 7572 656c 7920  tatus: Securely 
+0001f990: 6469 7363 6f6e 6e65 6374 6564 206d 6169  disconnected mai
+0001f9a0: 6e20 7072 6f63 6573 7365 732c 2073 7562  n processes, sub
+0001f9b0: 7072 6f63 6573 7320 7465 726d 696e 6174  process terminat
+0001f9c0: 696f 6e20 696e 2070 726f 6772 6573 732e  ion in progress.
+0001f9d0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0001f9e0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+0001f9f0: 2074 696d 652e 736c 6565 7028 302e 3129   time.sleep(0.1)
+0001fa00: 0a20 2020 206e 6f64 652e 6c6f 6767 6572  .    node.logger
+0001fa10: 2e61 7070 5f6c 6f67 2e77 6172 6e69 6e67  .app_log.warning
+0001fa20: 2827 5374 6174 7573 3a20 436c 6561 6e20  ('Status: Clean 
+0001fa30: 5374 6f70 2729 0a                        Stop').
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/node_stop.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/node_stop.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/optiexplorer.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/optiexplorer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/optihash.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/optihash.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/options.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/options.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,11 +1,13 @@
 import json
 import os.path as path
 from sys import exit
 
+GENESIS_ADDRESS = 'cc846806ba14b8ec5a042d254beeeb637ee91033fa0f84c66063e0a9'
+
 
 class Get:
     # "param_name":["type"] or "param_name"=["type","property_name"]
     vars = {
         'port': ['str'],
         'verify': ['bool', 'verify'],
         'testnet': ['bool'],
@@ -102,15 +104,15 @@
                         # treat as "str"
                         pass
                     if len(params) > 1:
                         # deal with properties that do not match the config name.
                         left = params[1]
                     setattr(self, left, right)
         # Default genesis to keep compatibility
-        self.genesis = '3b9ca99a7804015f8eaebb78d4b50570bd8337e8a8196343dbbb59c4'
+        self.genesis = GENESIS_ADDRESS
         for key, default in self.defaults.items():
             if key not in self.__dict__:
                 setattr(self, key, default)
 
         # print(self.__dict__)
 
     def read(self, filename='config.txt', custom_filename='config_custom.txt'):
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/optipoolware.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/optipoolware.py`

 * *Files 0% similar despite different names*

```diff
@@ -596,15 +596,15 @@
                         signature = signer.sign(h)
                         signature_enc = base64.b64encode(signature)
 
                         if signer.verify(h, signature) == True:
                             app_log.warning('Signature valid')
 
                             block_send.append((str(block_timestamp), str(address[:56]), str(address[:56]), '%.8f' % float(0), str(signature_enc.decode('utf-8')), str(public_key_hashed.decode('utf-8')), '0', str(nonce)))  # mining reward tx
-                            app_log.warning('Block to send: {}'.format(block_send))
+                            # app_log.warning('Block to send: {}'.format(block_send))
 
                             if not any(isinstance(el, list) for el in block_send):  # if it's not a list of lists (only the mining tx and no others)
                                 new_list = []
                                 new_list.append(block_send)
                                 block_send = new_list  # make it a list of lists
                                 app_log.warning(block_send)
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/peershandler.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/peershandler.py`

 * *Files 3% similar despite different names*

```diff
@@ -139,24 +139,25 @@
         # called by Sync, should not be an issue, but check if needs to be thread safe or not.
         # also called by self.client_loop, which is to be reworked
         # Egg: Needs to be thread safe.
         self.peerlist_updated = False
         try:
             with open(file, 'r') as peer_file:
                 peers_pairs = json.load(peer_file)
+            # print('Peers file test', file, len(peers_pairs), len(peerdict))
             # TODO: rework, because this takes too much time and freezes the status thread.
             # to be done in a dedicated thread, with one peer per xx seconds, not all at once, and added properties.
             for ip, port in dict(peerdict).items():
                 # I do create a new dict copy above, because logs showed that the dict can change while iterating
                 if self.node.IS_STOPPING:
                     # Early exit if stopping
                     return
                 try:
                     if ip not in peers_pairs:
-                        self.app_log.info(f'Testing connectivity to: {ip}:{port}')
+                        self.app_log.debug(f'Testing connectivity to: {ip}:{port}')
                         s = socks.socksocket()
                         try:
                             # connect timeout
                             s.settimeout(5)
                             if self.config.tor:
                                 s.setproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)
                             if strict:
@@ -164,59 +165,59 @@
                                 connections.send(s, 'getversion')
                                 versiongot = connections.receive(s, timeout=1)
                                 if versiongot == '*':
                                     raise ValueError('peer busy')
                                 if versiongot not in self.config.version_allow:
                                     raise ValueError(f'cannot save {ip}, incompatible protocol version {versiongot} '
                                                      f'not in {self.config.version_allow}', )
-                                self.app_log.info(f'Inbound: Distant peer {ip}:{port} responding: {versiongot}')
+                                self.app_log.debug(f'Inbound: Distant peer {ip}:{port} responding: {versiongot}')
                             else:
                                 s.connect((ip, int(port)))
                         finally:
                             # properly end the connection in all cases
                             try:
                                 s.close()
                             except:
                                 pass
                         peers_pairs[ip] = port
-                        self.app_log.info(f'Inbound: Peer {ip}:{port} saved to peers')
+                        self.app_log.debug(f'Inbound: Peer {ip}:{port} saved to peers')
                         self.peerlist_updated = True
                     else:
-                        self.app_log.info('Distant peer already in peers')
+                        self.app_log.debug('Distant peer already in peers')
 
                 except Exception as e:
                     # exception for a single peer
-                    self.app_log.info(f'Inbound: Distant peer not connectible ({e})')
+                    self.app_log.debug(f'Inbound: Distant peer not connectible ({e})')
 
             if self.peerlist_updated:
-                self.app_log.warning(f'{file} peerlist updated ({len(peers_pairs)}) total')  # the whole dict is saved
+                self.app_log.debug(f'{file} peerlist updated ({len(peers_pairs)}) total')  # the whole dict is saved
                 with open(f'{file}.tmp', 'w') as peer_file:
                     json.dump(peers_pairs, peer_file)
                 shutil.move(f'{file}.tmp', file)
             else:
-                self.app_log.warning(f'{file} peerlist update skipped, no changes')
+                self.app_log.debug(f'{file} peerlist update skipped, no changes')
 
         except Exception as e:
             # Exception for the file itself.
-            self.app_log.info(f"Error reading {file}: '{e}'")
+            self.app_log.warning(f"Error reading {file}: '{e}'")
 
     def append_client(self, client):
         """
         :param client: a string "ip:port"
         :return:
         """
         # TODO: thread safe?
         self.connection_pool.append(client)
         self.del_try(client)
 
     def remove_client(self, client):
         # TODO: thread safe?
         if client in self.connection_pool:
             try:
-                self.app_log.info(f'Will remove {client} from active pool')
+                self.app_log.debug(f'Will remove {client} from active pool')
                 self.connection_pool.remove(client)
             except:
                 raise
 
     def unban(self, peer_ip):
         """Removes the peer_ip from the warning list"""
         # TODO: Not thread safe atm. Should use a thread aware list or some lock
@@ -245,15 +246,15 @@
         peer_dict = {}
         try:
             if not peer_file:
                 peer_file = self.peerfile
             if not os.path.exists(peer_file):
                 with open(peer_file, 'w') as fp:
                     # was "a": append would risk adding stuff to a file create in the mean time.
-                    self.app_log.warning('Peer file created')
+                    self.app_log.warning(f'Peer file created in {peer_file}')
                     fp.write('{}')  # empty dict. An empty string is not json valid.
             else:
                 with open(peer_file, 'r') as fp:
                     peer_dict = json.load(fp)
         except Exception as e:
             self.app_log.warning(f'Error peers_get {e} reading {peer_file}')
         return peer_dict
@@ -322,49 +323,49 @@
         subdata is a dict, { 'ip': 'port'}"""
         # early exit to reduce future levels
         if not self.config.accept_peers:
             return -1
         if self.peersync_lock.locked():
             # TODO: means we will lose those peers forever.
             # TODO: buffer, and keep track of recently tested peers.
-            self.app_log.info('Outbound: Peer sync occupied')
+            self.app_log.debug('Outbound: Peer sync occupied')
             return -1
         # Temp fix: subdata is typed str, but we have a dict sometimes.
         if type(subdata) == dict:
             # Enforce expected type.
             self.app_log.warning('Enforced expected type for peersync subdata')
             subdata = json.dumps(subdata)
         with self.peersync_lock:
             try:
                 total_added = 0
 
                 subdata = self.dict_validate(subdata)
                 data_dict = json.loads(subdata)
 
-                self.app_log.info(f'Received {len(data_dict)} peers.')
+                self.app_log.debug(f'Received {len(data_dict)} peers.')
                 # Simplified the log, every peers then has a ok or ko status anyway.
                 for ip, port in data_dict.items():
                     if ip not in self.peer_dict:
-                        self.app_log.info(f'Outbound: {ip}:{port} is a new peer, saving if connectible')
+                        self.app_log.debug(f'Outbound: {ip}:{port} is a new peer, saving if connectible')
                         try:
                             s_purge = socks.socksocket()
                             s_purge.settimeout(5)
                             if self.config.tor:
                                 s_purge.setproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)
                             s_purge.connect((ip, int(port)))  # save a new peer file with only active nodes
                             s_purge.close()
                             # This only adds to our local dict, does not force save.
                             if ip not in self.peer_dict:
                                 total_added += 1
                                 self.peer_dict[ip] = port
-                                self.app_log.info(f'Inbound: Peer {ip}:{port} saved to local peers')
+                                self.app_log.debug(f'Inbound: Peer {ip}:{port} saved to local peers')
                         except:
-                            self.app_log.info('Not connectible')
+                            self.app_log.debug('Not connectible')
                     else:
-                        self.app_log.info(f'Outbound: {ip}:{port} is not a new peer')
+                        self.app_log.debug(f'Outbound: {ip}:{port} is not a new peer')
             except Exception as e:
                 self.app_log.warning(e)
                 exc_type, exc_obj, exc_tb = sys.exc_info()
                 fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
                 print(exc_type, fname, exc_tb.tb_lineno)
                 raise
         return total_added
@@ -375,15 +376,15 @@
         too_old = last_block - 720
         try:
             if peer_ip not in self.peer_opinion_dict:
                 if consensus_blockheight < too_old:
                     self.app_log.warning(f'{peer_ip} received block too old ({consensus_blockheight}) for consensus')
                     return
 
-            self.app_log.info(f'Updating {peer_ip} in consensus')
+            self.app_log.debug(f'Updating {peer_ip} in consensus')
             self.peer_opinion_dict[peer_ip] = consensus_blockheight
 
             self.consensus = most_common_dict(self.peer_opinion_dict)
 
             self.consensus_percentage = percentage_in(self.peer_opinion_dict[peer_ip], self.peer_opinion_dict.values())
 
             if int(consensus_blockheight) > int(self.consensus) + 30 and self.consensus_percentage > 50 and len(self.peer_opinion_dict) > 10:
@@ -396,16 +397,16 @@
             fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
             print(exc_type, fname, exc_tb.tb_lineno)
             raise
 
     def consensus_remove(self, peer_ip):
         if peer_ip in self.peer_opinion_dict:
             try:
-                self.app_log.info(f'Will remove {peer_ip} from consensus pool {self.peer_opinion_dict}')
-                self.peer_opinion_dict.pop(peer_ip)
+                self.app_log.debug(f'Will remove {peer_ip} from consensus pool {self.peer_opinion_dict}')
+                self.peer_opinion_dict.pop(peer_ip, None)
             except:
                 raise
 
     def can_connect_to(self, host, port):
         """
         Tells if we can connect to this host
         :param host:
@@ -457,15 +458,15 @@
         else:  # 30 minutes before trying again
             delay = 30*60
         tries += 1
         if tries > 3:
             tries = 3
         self.tried[host_port] = (tries, time() + delay)
         # Temp
-        self.app_log.info(f'Set timeout {delay} try {tries} for {host_port}')
+        self.app_log.debug(f'Set timeout {delay} try {tries} for {host_port}')
 
     def del_try(self, host, port=None):
         """
         Remove the peer from tried list. To be called when we successfully connected.
         :param host: an ip as a string, or an "ip:port" string
         :param port: optional, port as an int
         :return:
@@ -497,57 +498,60 @@
         """Manager loop called every 30 sec. Handles maintenance"""
         try:
             for key, value in dict(self.dict_shuffle(self.peer_dict)).items():
                 # The dict() above is not an error or a cast,
                 # it's to make a copy of the dict and avoid "dictionary changed size during iteration"
                 host = key
                 port = int(value)
+                if host == self.node.host:
+                    self.app_log.debug(f'Skip connecting to {host}:{port}')
+                    continue
 
                 if self.is_testnet:
                     port = 2829
                 if threading.active_count()/3 < self.config.thread_limit and self.can_connect_to(host, port):
-                    self.app_log.info(f'Will attempt to connect to {host}:{port}')
+                    self.app_log.debug(f'Will attempt to connect to {host}:{port}')
                     self.add_try(host, port)
                     t = threading.Thread(target=this_target, args=(host, port, node), name=f'out_{host}_{port}')  # threaded connectivity to nodes here
-                    self.app_log.info(f'---Starting a client thread {threading.currentThread()} ---')
+                    self.app_log.debug(f'---Starting a client thread {threading.currentThread()} ---')
                     t.daemon = True
                     t.start()
 
             if len(self.peer_dict) < 6 and int(time() - self.startup_time) > 30:
                 # join in random peers after x seconds
-                self.app_log.warning('Not enough peers in consensus, joining in peers suggested by other nodes')
+                self.app_log.debug('Not enough peers in consensus, joining in peers suggested by other nodes')
                 self.peer_dict.update(self.peers_get(self.suggested_peerfile))
 
             if len(self.connection_pool) < self.config.nodes_ban_reset and int(time() - self.startup_time) > 15:
                 # do not reset before 30 secs have passed
-                self.app_log.warning(f'Only {len(self.connection_pool)} connections active, resetting banlist')
+                self.app_log.debug(f'Only {len(self.connection_pool)} connections active, resetting banlist')
                 del self.banlist[:]
                 self.banlist.extend(self.config.banlist)  # reset to config version
                 del self.warning_list[:]
 
             if len(self.connection_pool) < 10:
-                self.app_log.warning(f'Only {len(self.connection_pool)} connections active, '
+                self.app_log.debug(f'Only {len(self.connection_pool)} connections active, '
                                      f'resetting the connection history', )
                 # TODO: only reset large timeouts, or we end up trying the sames over and over if we never get to 10.
                 # self.
                 self.reset_tried()
 
             if self.config.nodes_ban_reset <= len(self.banlist) and len(self.connection_pool) <= len(self.banlist) \
                     and (time() - self.reset_time) > 60 * 10:
                 # do not reset too often. 10 minutes here
-                self.app_log.warning(f'Less active connections ({len(self.connection_pool)}) '
+                self.app_log.debug(f'Less active connections ({len(self.connection_pool)}) '
                                      f'than banlist ({len(self.banlist)}), resetting banlist and tried list', )
                 del self.banlist[:]
                 self.banlist.extend(self.config.banlist)  # reset to config version
                 del self.warning_list[:]
                 self.reset_tried()
                 self.reset_time = time()
 
-            if _LogStatusMessages:
-                self.app_log.warning('Status: Testing peers')
+            # if _LogStatusMessages:
+            #     self.app_log.debug('Status: Testing peers')
             self.peer_dict.update(self.peers_get(self.peerfile))
             # self.peer_dict.update(self.peers_get(self.suggested_peerfile))
 
             # TODO: this is not OK. client_loop is called every 30 sec and should NOT contain any lengthy calls.
             self.peers_test(self.suggested_peerfile, self.peer_dict, strict=False)
             self.peers_test(self.peerfile, self.peer_dict, strict=True)
 
@@ -566,15 +570,15 @@
         if self.banlist:
             self.app_log.warning(f'Status: Banlist: {self.banlist}')
             self.app_log.warning(f'Status: Banlist Count : {len(self.banlist)}')
         if self.whitelist:
             self.app_log.warning(f'Status: Whitelist: {self.whitelist}')
 
         self.app_log.warning(f'Status: Known Peers: {len(self.peer_dict)}')
-        self.app_log.info(f'Status: Tried: {self.tried}')
-        self.app_log.info(f'Status: Tried Count: {len(self.tried)}')
-        self.app_log.info(f'Status: List of Outbound connections: {self.connection_pool}')
+        self.app_log.debug(f'Status: Tried: {self.tried}')
+        self.app_log.debug(f'Status: Tried Count: {len(self.tried)}')
+        self.app_log.debug(f'Status: List of Outbound connections: {self.connection_pool}')
         self.app_log.warning(f'Status: Number of Outbound connections: {len(self.connection_pool)}')
         if self.consensus:  # once the consensus is filled
             self.app_log.warning(f'Status: Consensus height: {self.consensus} = {self.consensus_percentage}%')
             self.app_log.warning(f'Status: Last block opinion: {self.peer_opinion_dict}')
             self.app_log.warning(f'Status: Total number of nodes: {len(self.peer_opinion_dict)}')
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/plugins.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/plugins.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/process_search.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/process_search.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/quantizer.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/quantizer.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/regnet.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/regnet.py`

 * *Files 1% similar despite different names*

```diff
@@ -114,15 +114,15 @@
                     signer = PKCS1_v1_5.new(KEY)
                     signature = signer.sign(hash)
                     signature_enc = base64.b64encode(signature)
 
                     if signer.verify(hash, signature):
                         node.logger.app_log.warning('Signature valid')
                         block_send.append((str(block_timestamp), str(ADDRESS[:56]), str(ADDRESS[:56]), '%.8f' % float(0), str(signature_enc.decode('utf-8')), str(PUBLIC_KEY_B64ENCODED.decode('utf-8')), '0', str(nonce)))  # mining reward tx
-                        node.logger.app_log.warning('Block to send: {}'.format(block_send))
+                        # node.logger.app_log.warning('Block to send: {}'.format(block_send))
                     # calc hash
 
                     new_hash = DIGEST_BLOCK(node, [block_send], None, 'regtest', db_handler)
                     # post block to self or better, send to db to make sure it is. when we add the next one?
                     # use a link to the block digest function
                     # embed at mot TX_PER_BLOCK txs from the mp
                     return new_hash
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/rewards_reindex.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/rewards_reindex.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/send_csv.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/send_csv.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/send_nogui_noconf.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/send_nogui_noconf.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/simplecrypt.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/simplecrypt.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/staking.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/staking.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/tokensv2.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/tokensv2.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_keys.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_keys.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_server.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_server.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/wallet_websocket.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/wallet_websocket.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/Bismuth/worker.py` & `bitdust-0.1.9.241/bitdust_forks/Bismuth/worker.py`

 * *Files 8% similar despite different names*

```diff
@@ -3,15 +3,15 @@
 from libs import node, logger, client
 import time
 import dbhandler
 import socks
 from connections import send, receive
 from decimal import Decimal
 import mempool as mp
-from difficulty import *
+from difficulty import difficulty
 from libs import client
 
 
 def sendsync(sdef, peer_ip, status, node):
     """ Save peer_ip to peerlist and send `sendsync`
 
     :param sdef: socket object
@@ -22,20 +22,20 @@
     Save peer IP to peers list if applicable
     Wait for database to unlock
     Send `sendsync` command via socket `sdef`
 
     returns None
     """
     # TODO: ERROR, does **not** save anything. code or comment wrong.
-    node.logger.app_log.info(f'Outbound: Synchronization with {peer_ip} finished after: {status}, sending new sync request')
-    time.sleep(Decimal(node.pause))
+    node.logger.app_log.debug(f'Outbound: Synchronization with {peer_ip} finished after: {status}, sending new sync request')
+    time.sleep(int(node.pause))
     while node.db_lock.locked():
         if node.IS_STOPPING:
             return
-        time.sleep(Decimal(node.pause))
+        time.sleep(int(node.pause))
     send(sdef, 'sendsync')
 
 
 def worker(host, port, node):
     logger = node.logger
 
     this_client = f'{host}:{port}'
@@ -50,65 +50,67 @@
     if node.peers.is_banned(host) or dict_ip['ip'] == 'banned':
         node.logger.app_log.warning(f"IP {host} is banned, won't connect")
         return
 
     timeout_operation = 60  # timeout
     timer_operation = time.time()  # start counting
 
+    # print('started Bismuth peer worker', threading.current_thread(), host, port)
+
     try:
 
         s = socks.socksocket()
 
         if node.tor:
             s.setproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)
         # s.setblocking(0)
         s.connect((host, port))
-        node.logger.app_log.info(f'Outbound: Connected to {this_client}')
+        node.logger.app_log.debug(f'Outbound: Connected to {this_client}')
         client_instance_worker.connected = True
 
         # communication starter
 
         send(s, 'version')
         send(s, node.version)
 
         data = receive(s)
 
         if data == 'ok':
-            node.logger.app_log.info(f'Outbound: Node protocol version of {this_client} matches our client')
+            node.logger.app_log.debug(f'Outbound: Node protocol version of {this_client} matches our client')
         else:
             raise ValueError(f'Outbound: Node protocol version of {this_client} mismatch')
 
         send(s, 'getversion')
         peer_version = receive(s)
         if peer_version not in node.version_allow:
             raise ValueError(f'Outbound: Incompatible peer version {peer_version} from {this_client}')
 
         send(s, 'hello')
 
         # communication starter
 
     except Exception as e:
-        node.logger.app_log.info(f'Could not connect to {this_client}: {e}')
+        node.logger.app_log.debug(f'Could not connect to {this_client}: {e}')
         return  # can return here, because no lists are affected yet
 
     node.peers.store_mainnet(host, peer_version)
     try:
         peer_ip = s.getpeername()[0]
     except:
         # Should not happen, extra safety
         node.logger.app_log.warning('Outbound: Transport endpoint was not connected')
         return
 
     if this_client not in node.peers.connection_pool:
         node.peers.append_client(this_client)
-        node.logger.app_log.info(f'Connected to {this_client}')
-        node.logger.app_log.info(f'Current active pool: {node.peers.connection_pool}')
+        node.logger.app_log.debug(f'Connected to {this_client}')
+        node.logger.app_log.debug(f'Current active pool: {node.peers.connection_pool}')
 
-    if not node.peers.is_banned(host) and node.peers.version_allowed(host, node.version_allow) and not node.IS_STOPPING:
-        db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
+    # if not node.peers.is_banned(host) and node.peers.version_allowed(host, node.version_allow) and not node.IS_STOPPING:
+    #     db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
 
     while not node.peers.is_banned(host) and node.peers.version_allowed(host, node.version_allow) and not node.IS_STOPPING:
         try:
             #ensure_good_peer_version(host)
 
             data = receive(s)  # receive data, one and the only root point
             # print(data)
@@ -129,35 +131,37 @@
 
                     node.syncing.append(peer_ip)
                     # sync start
 
                     # send block height, receive block height
                     send(s, 'blockheight')
 
-                    node.logger.app_log.info(f'Outbound: Sending block height to compare: {node.hdd_block}')
+                    node.logger.app_log.debug(f'Outbound: Sending block height to compare: {node.hdd_block}')
                     # append zeroes to get static length
                     send(s, node.hdd_block)
 
                     received_block_height = receive(s)  # receive node's block height
-                    node.logger.app_log.info(f'Outbound: Node {peer_ip} is at block height: {received_block_height}')
+                    node.logger.app_log.debug(f'Outbound: Node {peer_ip} is at block height: {received_block_height}')
 
                     if int(received_block_height) < node.hdd_block:
                         node.logger.app_log.warning(f'Outbound: We have a higher block ({node.hdd_block}) than {peer_ip} ({received_block_height}), sending')
 
                         data = receive(s)  # receive client's last block_hash
 
                         # send all our followup hashes
-                        node.logger.app_log.info(f'Outbound: Will seek the following block: {data}')
+                        node.logger.app_log.debug(f'Outbound: Will seek the following block: {data}')
 
                         # consensus pool 2 (active connection)
                         consensus_blockheight = int(received_block_height)
                         node.peers.consensus_add(peer_ip, consensus_blockheight, s, node.hdd_block)
                         # consensus pool 2 (active connection)
 
+                        db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
                         client_block = db_handler_instance.block_height_from_hash(data)
+                        db_handler_instance.close()
 
                         if not client_block:
                             node.logger.app_log.warning(f'Outbound: Block {data[:8]} of {peer_ip} not found')
                             if node.full_ledger:
                                 send(s, 'blocknf')
                             else:
                                 send(s, 'blocknfhb')
@@ -170,41 +174,43 @@
                             node.logger.app_log.warning(f'Outbound: Node is at block {client_block}')  # now check if we have any newer
 
                             if node.hdd_hash == data or not node.egress:
                                 if not node.egress:
                                     node.logger.app_log.warning(f'Outbound: Egress disabled for {peer_ip}')
                                     time.sleep(int(node.pause))  # reduce CPU usage
                                 else:
-                                    node.logger.app_log.info(f'Outbound: Node {peer_ip} has the latest block')
+                                    node.logger.app_log.debug(f'Outbound: Node {peer_ip} has the latest block')
                                     # TODO: this is unlikely to happen due to conditions above, consider removing
                                 send(s, 'nonewblk')
 
                             else:
+                                db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
                                 blocks_fetched = db_handler_instance.blocksync(client_block)
+                                db_handler_instance.close()
 
-                                node.logger.app_log.info(f'Outbound: Selected {blocks_fetched}')
+                                node.logger.app_log.debug(f'Outbound: Selected {blocks_fetched}')
 
                                 send(s, 'blocksfnd')
 
                                 confirmation = receive(s)
 
                                 if confirmation == 'blockscf':
-                                    node.logger.app_log.info('Outbound: Client confirmed they want to sync from us')
+                                    node.logger.app_log.debug('Outbound: Client confirmed they want to sync from us')
                                     send(s, blocks_fetched)
 
                                 elif confirmation == 'blocksrj':
-                                    node.logger.app_log.info("Outbound: Client rejected to sync from us because we're dont have the latest block")
+                                    node.logger.app_log.debug("Outbound: Client rejected to sync from us because we're dont have the latest block")
 
                     elif int(received_block_height) >= node.hdd_block:
                         if int(received_block_height) == node.hdd_block:
-                            node.logger.app_log.info(f'Outbound: We have the same block as {peer_ip} ({received_block_height}), hash will be verified')
+                            node.logger.app_log.debug(f'Outbound: We have the same block as {peer_ip} ({received_block_height}), hash will be verified')
                         else:
                             node.logger.app_log.warning(f'Outbound: We have a lower block ({node.hdd_block}) than {peer_ip} ({received_block_height}), hash will be verified')
 
-                        node.logger.app_log.info(f'Outbound: block_hash to send: {node.hdd_hash}')
+                        node.logger.app_log.debug(f'Outbound: block_hash to send: {node.hdd_hash}')
                         send(s, node.hdd_hash)
 
                         #ensure_good_peer_version(host)
 
                         # consensus pool 2 (active connection)
                         consensus_blockheight = int(received_block_height)  # str int to remove leading zeros
                         node.peers.consensus_add(peer_ip, consensus_blockheight, s, node.hdd_block)
@@ -217,38 +223,42 @@
 
             elif data == 'blocknfhb':  # one of the possible outcomes
                 block_hash_delete = receive(s)
                 # print peer_ip
                 # if max(consensus_blockheight_list) == int(received_block_height):
                 if int(received_block_height) == node.peers.consensus_max:
 
+                    db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
                     blocknf(node, block_hash_delete, peer_ip, db_handler_instance, hyperblocks=True)
+                    db_handler_instance.close()
 
                     if node.peers.warning(s, peer_ip, 'Rollback', 2):
                         raise ValueError(f'{peer_ip} is banned')
 
                 sendsync(s, peer_ip, 'Block not found', node)
 
             elif data == 'blocknf':  # one of the possible outcomes
                 block_hash_delete = receive(s)
                 # print peer_ip
                 # if max(consensus_blockheight_list) == int(received_block_height):
                 if int(received_block_height) == node.peers.consensus_max:
 
+                    db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
                     blocknf(node, block_hash_delete, peer_ip, db_handler_instance)
+                    db_handler_instance.close()
 
                     if node.peers.warning(s, peer_ip, 'Rollback', 2):
                         raise ValueError(f'{peer_ip} is banned')
 
                 sendsync(s, peer_ip, 'Block not found', node)
 
             elif data == 'blocksfnd':
-                node.logger.app_log.info(f'Outbound: Node {peer_ip} has the block(s)')  # node should start sending txs in this step
+                node.logger.app_log.debug(f'Outbound: Node {peer_ip} has the block(s)')  # node should start sending txs in this step
 
-                # node.logger.app_log.info("Inbound: Combined segments: " + segments)
+                # node.logger.app_log.debug("Inbound: Combined segments: " + segments)
                 # print peer_ip
                 if node.db_lock.locked():
                     node.logger.app_log.warning(f'Skipping sync from {peer_ip}, syncing already in progress')
 
                 else:
                     if int(node.last_block_timestamp) < (time.time() - 600):
                         block_req = node.peers.consensus_most_common
@@ -268,39 +278,44 @@
                             segments = receive(s)
                             #ensure_good_peer_version(host)
 
                         except:
                             if node.peers.warning(s, peer_ip, 'Failed to deliver the longest chain', 2):
                                 raise ValueError(f'{peer_ip} is banned')
                         else:
+                            db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
                             digest_block(node, segments, s, peer_ip, db_handler_instance)
+                            db_handler_instance.close()
 
                             # receive theirs
                     else:
                         send(s, 'blocksrj')
                         node.logger.app_log.warning(f'Inbound: Distant peer {peer_ip} is at {received_block_height}, should be at least {max(block_req,node.last_block+1)}')
 
                 sendsync(s, peer_ip, 'Block found', node)
 
                 # block_hash validation end
 
             elif data == 'nonewblk':
                 # send and receive mempool
+                # print('nonewblk', mp.MEMPOOL, id(mp.MEMPOOL), getattr(mp.MEMPOOL, 'sendable', '?'), threading.current_thread())
                 if mp.MEMPOOL.sendable(peer_ip):
                     mempool_txs = mp.MEMPOOL.tx_to_send(peer_ip)
-                    # node.logger.app_log.info("Outbound: Extracted from the mempool: " + str(mempool_txs))  # improve: sync based on signatures only
+                    # node.logger.app_log.debug("Outbound: Extracted from the mempool: " + str(mempool_txs))  # improve: sync based on signatures only
                     # if len(mempool_txs) > 0: #wont sync mempool until we send something, which is bad
                     # send own
                     send(s, 'mempool')
                     send(s, mempool_txs)
                     # send own
                     # receive theirs
                     segments = receive(s)
 
-                    node.logger.app_log.info(mp.MEMPOOL.merge(segments, peer_ip, db_handler_instance.c, True))
+                    db_handler_instance = dbhandler.DbHandler(node.index_db, node.ledger_path, node.hyper_path, node.ram, node.ledger_ram_file, logger)
+                    node.logger.app_log.debug(mp.MEMPOOL.merge(segments, peer_ip, db_handler_instance.c, True))
+                    db_handler_instance.close()
 
                     # receive theirs
                     # Tell the mempool we just send our pool to a peer
                     mp.MEMPOOL.sent(peer_ip)
                 sendsync(s, peer_ip, 'No new block', node)
 
             elif data == 'hyperlane':
@@ -313,34 +328,34 @@
 
         except Exception as e:
             """
             exc_type, exc_obj, exc_tb = sys.exc_info()
             fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
             print(exc_type, fname, exc_tb.tb_lineno)
             """
-
-            db_handler_instance.close()
+            import traceback
+            traceback.print_exc()
 
             # remove from active pool
             node.peers.remove_client(this_client)
             node.logger.app_log.warning(f'Outbound: Disconnected from {this_client}: {e}')
             # remove from active pool
 
             # remove from consensus 2
             node.peers.consensus_remove(peer_ip)
             # remove from consensus 2
 
-            node.logger.app_log.info(f'Connection to {this_client} terminated due to {e}')
-            node.logger.app_log.info(f'---thread {threading.currentThread()} ended---')
+            node.logger.app_log.debug(f'Connection to {this_client} terminated due to {e}')
+            node.logger.app_log.debug(f'---thread {threading.currentThread()} ended---')
 
             # properly end the connection
             s.close()
 
             # properly end the connection
             if node.debug:
                 raise  # major debug client
             else:
-                node.logger.app_log.info(f'Ending thread, because {e}')
+                node.logger.app_log.warning(f'Ending thread, because {e}')
                 return
 
     if not node.peers.version_allowed(host, node.version_allow):
         node.logger.app_log.warning(f'Outbound: Ending thread, because {host} has too old a version: {node.peers.ip_to_mainnet[host]}')
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/database.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/database.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_gevent.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_gevent.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_safe_shared.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_safe_shared.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_super_thread_safe.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_super_thread_safe.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/database_thread_safe.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/database_thread_safe.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/debug_stuff.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/debug_stuff.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/env.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/env.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/hash_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/hash_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/indexcreator.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/indexcreator.py`

 * *Files 2% similar despite different names*

```diff
@@ -21,15 +21,14 @@
 import tokenize
 import token
 import uuid
 from six.moves import range
 
 
 class IndexCreatorException(Exception):
-
     def __init__(self, ex, line=None):
         self.ex = ex
         self.line = line
 
     def __str__(self):
         if self.line:
             return repr(self.ex + "(in line: %d)" % self.line)
@@ -41,89 +40,92 @@
 
 
 class IndexCreatorValueException(IndexCreatorException):
     pass
 
 
 class Parser(object):
-
     def __init__(self):
         pass
 
     def parse(self, data, name=None):
         if not name:
             self.name = "_" + uuid.uuid4().hex
         else:
             self.name = name
 
         self.ind = 0
         self.stage = 0
         self.logic = ['and', 'or', 'in']
         self.logic2 = ['&', '|']
-        self.allowed_props = {'TreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format'],
-                              'HashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
-                              'MultiHashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
-                              'MultiTreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format']
-                              }
-        self.funcs = {'md5': (['md5'], ['.digest()']),
-                      'len': (['len'], []),
-                      'str': (['str'], []),
-                      'fix_r': (['self.fix_r'], []),
-                      'prefix': (['self.prefix'], []),
-                      'infix': (['self.infix'], []),
-                      'suffix': (['self.suffix'], [])
-                      }
-        self.handle_int_imports = {'infix': "from itertools import izip\n"}
+        self.allowed_props = {
+            'TreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format'],
+            'HashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
+            'MultiHashIndex': ['type', 'name', 'key_format', 'hash_lim', 'entry_line_format'],
+            'MultiTreeBasedIndex': ['type', 'name', 'key_format', 'node_capacity', 'pointer_format', 'meta_format']
+        }
+        self.funcs = {
+            'md5': (['md5'], ['.digest()']),
+            'len': (['len'], []),
+            'str': (['str'], []),
+            'fix_r': (['self.fix_r'], []),
+            'prefix': (['self.prefix'], []),
+            'infix': (['self.infix'], []),
+            'suffix': (['self.suffix'], [])
+        }
+        self.handle_int_imports = {'infix': "\n"}
 
-        self.funcs_with_body = {'fix_r':
-                                ("""    def fix_r(self,s,l):
+        self.funcs_with_body = {
+            'fix_r': (
+                """    def fix_r(self,s,l):
         e = len(s)
         if e == l:
             return s
         elif e > l:
             return s[:l]
         else:
-            return s.rjust(l,'_')\n""", False),
-                                'prefix':
-                                ("""    def prefix(self,s,m,l,f):
+            return s.rjust(l,b'_')\n""", False),
+
+            'prefix': (
+                """    def prefix(self,s,m,l,f):
         t = len(s)
         if m < 1:
             m = 1
         o = set()
         if t > l:
             s = s[:l]
             t = l
         while m <= t:
             o.add(s.rjust(f,'_'))
             s = s[:-1]
             t -= 1
         return o\n""", False),
-                                'suffix':
-                                ("""    def suffix(self,s,m,l,f):
+            'suffix': (
+                """    def suffix(self,s,m,l,f):
         t = len(s)
         if m < 1:
             m = 1
         o = set()
         if t > l:
             s = s[t-l:]
             t = len(s)
         while m <= t:
             o.add(s.rjust(f,'_'))
             s = s[1:]
             t -= 1
         return o\n""", False),
-                                'infix':
-                                ("""    def infix(self,s,m,l,f):
+            'infix': (
+                """    def infix(self,s,m,l,f):
         t = len(s)
         o = set()
-        for x in xrange(m - 1, l):
+        for x in range(m - 1, l):
             t = (s, )
-            for y in xrange(0, x):
+            for y in range(0, x):
                 t += (s[y + 1:],)
-            o.update(set(''.join(x).rjust(f, '_').lower() for x in izip(*t)))
+            o.update(set(''.join(x).rjust(f, '_').lower() for x in zip(*t)))
         return o\n""", False)}
         self.none = ['None', 'none', 'null']
         self.props_assign = ['=', ':']
         self.all_adj_num_comp = {token.NUMBER: (
             token.NUMBER, token.NAME, '-', '('),
             token.NAME: (token.NUMBER, token.NAME, '-', '('),
             ')': (token.NUMBER, token.NAME, '-', '(')
@@ -178,14 +180,15 @@
         def is_num(s):
             m = re.search('[^0-9*()+\-\s/]+', s)
             return not m
 
         def is_string(s):
             m = re.search('\s*(?P<a>[\'\"]+).*?(?P=a)\s*', s)
             return m
+
         data = re.split('make_key_value\:', data)
 
         if len(data) < 2:
             raise IndexCreatorFunctionException(
                 "Couldn't find a definition of make_key_value function!\n")
 
         spl1 = re.split('make_key\:', data[0])
@@ -198,19 +201,21 @@
             self.funcs_rev = True
         elif len(spl2) > 1:
             data = [data[0]] + spl2
         else:
             data.append("key")
 
         if data[1] == re.search('\s*', data[1], re.S | re.M).group(0):  # @UndefinedVariable
-            raise IndexCreatorFunctionException("Empty function body ",
-                                                len(re.split('\n', data[0])) + (len(re.split('\n', data[2])) if self.funcs_rev else 1) - 1)
+            raise IndexCreatorFunctionException(
+                "Empty function body ",
+                len(re.split('\n', data[0])) + (len(re.split('\n', data[2])) if self.funcs_rev else 1) - 1)
         if data[2] == re.search('\s*', data[2], re.S | re.M).group(0):  # @UndefinedVariable
-            raise IndexCreatorFunctionException("Empty function body ",
-                                                len(re.split('\n', data[0])) + (1 if self.funcs_rev else len(re.split('\n', data[1]))) - 1)
+            raise IndexCreatorFunctionException(
+                "Empty function body ",
+                len(re.split('\n', data[0])) + (1 if self.funcs_rev else len(re.split('\n', data[1]))) - 1)
         if data[0] == re.search('\s*', data[0], re.S | re.M).group(0):  # @UndefinedVariable
             raise IndexCreatorValueException("You didn't set any properity or you set them not at the begining of the code\n")
 
         data = [re.split(
             '\n', data[0]), re.split('\n', data[1]), re.split('\n', data[2])]
         self.cnt_lines = (len(data[0]), len(data[1]), len(data[2]))
         ind = 0
@@ -247,15 +252,15 @@
             else:
                 self.ind += 1
                 return self.data[stage][self.ind - 1]
         return foo
 
     def add(self, l, i):
         def add_aux(*args):
-            # print args,self.ind
+            # print(args,self.ind)
             if len(l[i]) < self.ind:
                 l[i].append([])
             l[i][self.ind - 1].append(args)
         return add_aux
 
     def parse_ex(self):
         self.index_name = ""
@@ -273,31 +278,38 @@
         self.is_one_arg_enough = False
         self.funcs_stack = []
         self.last_line = [-1, -1, -1]
         self.props_set = []
         self.custom_header = set()
 
         self.tokens = []
-        self.tokens_head = ['# %s\n' % self.name, 'class %s(' % self.name, '):\n', '    def __init__(self, *args, **kwargs):        ']
+        self.tokens_head = [
+            '# %s\n' % self.name,
+            'class %s(' % self.name, '):\n',
+            '    def __init__(self, *args, **kwargs):        ']
 
         for i in range(3):
-            tokenize.tokenize(self.readline(i), self.add(self.pre_tokens, i))
+            for tolkien in tokenize.generate_tokens(self.readline(i)):
+                t = tuple(tolkien)
+                self.add(self.pre_tokens, i)(*t)
             # tokenize treats some keyword not in the right way, thats why we
             # have to change some of them
             for nk, k in enumerate(self.pre_tokens[i]):
                 for na, a in enumerate(k):
                     if a[0] == token.NAME and a[1] in self.logic:
-                        self.pre_tokens[i][nk][
-                            na] = (token.OP, a[1], a[2], a[3], a[4])
+                        self.pre_tokens[i][nk][na] = (
+                            token.OP, a[1], a[2], a[3], a[4])
 
         for i in self.pre_tokens[1]:
             self.line_cons[1].append(self.check_colons(i, 1))
             self.check_adjacents(i, 1)
             if self.check_for_2nd_arg(i) == -1 and not self.is_one_arg_enough:
-                raise IndexCreatorValueException("No 2nd value to return (did u forget about ',None'?", self.cnt_line_nr(i[0][4], 1))
+                raise IndexCreatorValueException(
+                    "No 2nd value to return (did u forget about ',None'?",
+                    self.cnt_line_nr(i[0][4], 1))
             self.is_one_arg_enough = False
 
         for i in self.pre_tokens[2]:
             self.line_cons[2].append(self.check_colons(i, 2))
             self.check_adjacents(i, 2)
 
         for i in self.pre_tokens[0]:
@@ -341,17 +353,17 @@
             self.tokens_head.insert(4, s)
 
         if self.index_type in self.allowed_props:
             for i in self.props_set:
                 if i not in self.allowed_props[self.index_type]:
                     raise IndexCreatorValueException("Properity %s is not allowed for index type: %s" % (i, self.index_type))
 
-        # print "".join(self.tokens_head)
-        # print "----------"
-        # print (" ".join(self.tokens))
+        # print("".join(self.tokens_head))
+        # print("----------")
+        # print(" ".join(self.tokens))
         return "".join(self.custom_header), "".join(self.tokens_head) + (" ".join(self.tokens))
 
     # has to be run BEFORE tokenize
     def check_enclosures(self, d, st):
         encs = []
         contr = {'(': ')', '{': '}', '[': ']', "'": "'", '"': '"'}
         ends = [')', '}', ']', "'", '"']
@@ -501,15 +513,15 @@
             elif i == ']':
                 s_b_cnt -= 1
         return -1
 
     def cnt_line_nr(self, l, stage):
         nr = -1
         for n, i in enumerate(self.predata[stage]):
-            # print i,"|||",i.strip(),"|||",l
+            # print(i,"|||",i.strip(),"|||",l)
             if l == i.strip():
                 nr = n
         if nr == -1:
             return -1
 
         if stage == 0:
             return nr + 1
@@ -549,19 +561,19 @@
                         tk = m.groups()[1]
                 elif t != token.NAME:
                     raise IndexCreatorValueException(
                         "Wrong value to assign", self.cnt_line_nr(line, 0))
 
                 if d[0][1] == "type":
                     if d[2][1] == "TreeBasedIndex":
-                        self.custom_header.add("from CodernityDB.tree_index import TreeBasedIndex\n")
+                        self.custom_header.add("from CodernityDB3.tree_index import TreeBasedIndex\n")
                     elif d[2][1] == "MultiTreeBasedIndex":
-                        self.custom_header.add("from CodernityDB.tree_index import MultiTreeBasedIndex\n")
+                        self.custom_header.add("from CodernityDB3.tree_index import MultiTreeBasedIndex\n")
                     elif d[2][1] == "MultiHashIndex":
-                        self.custom_header.add("from CodernityDB.hash_index import MultiHashIndex\n")
+                        self.custom_header.add("from CodernityDB3.hash_index import MultiHashIndex\n")
                     self.tokens_head.insert(2, tk)
                     self.index_type = tk
                 else:
                     self.index_name = tk
                 return
             else:
                 self.tokens += ['\n        kwargs["' + d[0][1] + '"]']
@@ -591,15 +603,15 @@
         elif tk == ':' and self.line_cons[stage][pos_start[0] - 1] > -1:
             if self.line_cons[stage][pos_start[0] - 1] == 0:
                 self.tokens += [':\n            return']
                 return
             self.line_cons[stage][pos_start[0] - 1] -= 1
 
         if tk in self.logic2:
-            # print tk
+            # print(tk)
             if line[pos_start[1] - 1] != tk and line[pos_start[1] + 1] != tk:
                 self.tokens += [tk]
             if line[pos_start[1] - 1] != tk and line[pos_start[1] + 1] == tk:
                 if tk == '&':
                     self.tokens += ['and']
                 else:
                     self.tokens += ['or']
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/lfu_cache.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/lfu_cache.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/lfu_cache_with_lock.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/lfu_cache_with_lock.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/migrate.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/migrate.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/misc.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/misc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/patch.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/patch.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/rr_cache.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/rr_cache.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/rr_cache_with_lock.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/rr_cache_with_lock.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/sharded_hash.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/sharded_hash.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/sharded_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/sharded_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/storage.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/storage.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB/tree_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB/tree_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_gevent.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_gevent.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_safe_shared.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_safe_shared.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_super_thread_safe.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_super_thread_safe.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/database_thread_safe.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/database_thread_safe.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/debug_stuff.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/debug_stuff.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/env.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/env.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/hash_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/hash_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/lfu_cache.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/lfu_cache.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/lfu_cache_with_lock.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/lfu_cache_with_lock.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/migrate.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/migrate.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/misc.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/misc.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/patch.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/patch.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/rr_cache.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/rr_cache.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/rr_cache_with_lock.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/rr_cache_with_lock.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/sharded_hash.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/sharded_hash.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/sharded_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/sharded_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/storage.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/storage.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/CodernityDB3/tree_index.py` & `bitdust-0.1.9.241/bitdust_forks/CodernityDB3/tree_index.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/dtuple.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/dtuple.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/constants.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/constants.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/contact.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/contact.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/datastore.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/datastore.py`

 * *Files 2% similar despite different names*

```diff
@@ -15,15 +15,18 @@
 # may be created by processing this file with epydoc: http://epydoc.sf.net
 
 from __future__ import absolute_import
 
 try:
     from UserDict import DictMixin
 except ImportError:
-    from collections import MutableMapping as DictMixin
+    try:
+        from collections.abc import MutableMapping as DictMixin
+    except:
+        from collections import MutableMapping as DictMixin
 
 import sqlite3
 import os
 import json
 
 from . import constants  # @UnresolvedImport
 from . import encoding  # @UnresolvedImport
```

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/encoding.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/encoding.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/kbucket.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/kbucket.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/msgformat.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/msgformat.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/msgtypes.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/msgtypes.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/node.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/protocol.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/protocol.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/kademlia/routingtable.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/kademlia/routingtable.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/entangled/node.py` & `bitdust-0.1.9.241/bitdust_forks/entangled/node.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/parallelp/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppauto.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppauto.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppserver.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppserver.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/parallelp/pp/pptransport.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/pp/pptransport.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/parallelp/pp/ppworker.py` & `bitdust-0.1.9.241/bitdust_forks/parallelp/pp/ppworker.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/json_resource.py` & `bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/json_resource.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/methods.py` & `bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/methods.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/resource.py` & `bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/resource.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/txrestapi/txrestapi/tests.py` & `bitdust-0.1.9.241/bitdust_forks/txrestapi/txrestapi/tests.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/__init__.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/__init__.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_abnf.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_abnf.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_app.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_app.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_cookiejar.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_cookiejar.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_core.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_core.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_exceptions.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_exceptions.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_handshake.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_handshake.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_http.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_http.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_logging.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_logging.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_socket.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_socket.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_ssl_compat.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_ssl_compat.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_url.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_url.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/bitdust_forks/websocket/_utils.py` & `bitdust-0.1.9.241/bitdust_forks/websocket/_utils.py`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/scripts/bitdust` & `bitdust-0.1.9.241/scripts/bitdust`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/scripts/bitdust_worker` & `bitdust-0.1.9.241/scripts/bitdust_worker`

 * *Files identical despite different names*

### Comparing `bitdust-0.1.8.234/setup.py` & `bitdust-0.1.9.241/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -20,15 +20,15 @@
 #
 # Please contact us if you have any questions at bitdust.io@gmail.com
 from __future__ import absolute_import
 from setuptools import setup
 
 setup(
     name='bitdust',
-    version='0.1.8.234',
+    version='0.1.9.241',
     author='Veselin Penev, BitDust',
     author_email='bitdust.io@gmail.com',
     maintainer='Veselin Penev, BitDust',
     maintainer_email='veselin@bitdust.io',
     url='https://bitdust.io',
     description='p2p secure distributed storage and communication engine',
     long_description=open('README.txt', 'r').read(),
```

