# Comparing `tmp/xnote-web-0.1.0.tar.gz` & `tmp/xnote-web-0.1.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "xnote-web-0.1.0.tar", last modified: Fri May  3 04:09:11 2024, max compression
+gzip compressed data, was "xnote-web-0.1.1.tar", last modified: Sat Jun  1 04:52:29 2024, max compression
```

## Comparing `xnote-web-0.1.0.tar` & `xnote-web-0.1.1.tar`

### file list

```diff
@@ -1,1217 +1,1220 @@
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.430080 xnote-web-0.1.0/
--rw-rw-rw-   0        0        0    35147 2021-10-01 10:27:00.000000 xnote-web-0.1.0/COPYING
--rw-rw-rw-   0        0        0      259 2023-10-27 13:17:40.000000 xnote-web-0.1.0/MANIFEST.in
--rw-rw-rw-   0        0        0     5759 2024-05-03 04:09:11.426935 xnote-web-0.1.0/PKG-INFO
--rw-rw-rw-   0        0        0     5416 2024-03-16 14:56:17.000000 xnote-web-0.1.0/README.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.026140 xnote-web-0.1.0/config/
--rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.0/config/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.093944 xnote-web-0.1.0/config/boot/
--rw-rw-rw-   0        0        0     3661 2024-04-05 04:01:41.000000 xnote-web-0.1.0/config/boot/boot.default.properties
--rw-rw-rw-   0        0        0      413 2022-05-29 13:03:06.000000 xnote-web-0.1.0/config/boot/boot.local.follower.properties
--rw-rw-rw-   0        0        0      612 2022-10-06 02:04:52.000000 xnote-web-0.1.0/config/boot/boot.local.leveldb.properties
--rw-rw-rw-   0        0        0       98 2024-04-20 13:28:50.000000 xnote-web-0.1.0/config/boot/boot.local.mem.properties
--rw-rw-rw-   0        0        0      792 2024-04-20 13:35:54.000000 xnote-web-0.1.0/config/boot/boot.local.properties
--rw-rw-rw-   0        0        0      116 2023-04-06 04:04:41.000000 xnote-web-0.1.0/config/boot/boot.min.properties
--rw-rw-rw-   0        0        0      581 2024-04-21 03:04:26.000000 xnote-web-0.1.0/config/boot/boot.sae.properties
--rw-rw-rw-   0        0        0      113 2022-08-14 10:12:12.000000 xnote-web-0.1.0/config/boot/boot.sqlite.properties
--rw-rw-rw-   0        0        0      201 2024-03-16 14:56:17.000000 xnote-web-0.1.0/config/boot/boot.test.properties
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.098128 xnote-web-0.1.0/config/cron/
--rw-rw-rw-   0        0        0     1572 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/cron/cron.json
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.126393 xnote-web-0.1.0/config/file/
--rw-rw-rw-   0        0        0       20 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/file/audio.properties
--rw-rw-rw-   0        0        0      142 2023-03-04 06:34:27.000000 xnote-web-0.1.0/config/file/code.properties
--rw-rw-rw-   0        0        0      181 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/file/image.properties
--rw-rw-rw-   0        0        0      448 2022-04-17 03:52:32.000000 xnote-web-0.1.0/config/file/mime-types.properties
--rw-rw-rw-   0        0        0      298 2023-10-27 13:17:40.000000 xnote-web-0.1.0/config/file/preview.properties
--rw-rw-rw-   0        0        0      580 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/file/text.properties
--rw-rw-rw-   0        0        0       35 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/file/video.properties
--rw-rw-rw-   0        0        0       27 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/file/zip.properties
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.134519 xnote-web-0.1.0/config/lang/
--rw-rw-rw-   0        0        0      794 2022-03-19 10:57:33.000000 xnote-web-0.1.0/config/lang/en.properties
--rw-rw-rw-   0        0        0     2259 2023-07-16 02:37:42.000000 xnote-web-0.1.0/config/lang/zh.properties
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.143016 xnote-web-0.1.0/config/note/
--rw-rw-rw-   0        0        0      231 2022-07-15 15:16:19.000000 xnote-web-0.1.0/config/note/category.ddc.properties
--rw-rw-rw-   0        0        0      135 2022-07-15 16:06:41.000000 xnote-web-0.1.0/config/note/category.properties
--rw-rw-rw-   0        0        0      857 2022-11-26 16:30:19.000000 xnote-web-0.1.0/config/note/smart_group.ini
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.154596 xnote-web-0.1.0/config/plugin/
--rw-rw-rw-   0        0        0     6718 2024-03-16 14:56:17.000000 xnote-web-0.1.0/config/plugin/form_plugin.tpl.py
--rw-rw-rw-   0        0        0      798 2024-03-16 14:56:17.000000 xnote-web-0.1.0/config/plugin/plugin.tpl.py
--rw-rw-rw-   0        0        0      179 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/plugin/plugins.ini
--rw-rw-rw-   0        0        0      141 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/requirements.full.txt
--rw-rw-rw-   0        0        0       12 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/requirements.min.txt
--rw-rw-rw-   0        0        0       25 2023-10-27 13:17:40.000000 xnote-web-0.1.0/config/requirements.mysql.txt
--rw-rw-rw-   0        0        0       88 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/requirements.test.txt
--rw-rw-rw-   0        0        0      127 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/requirements.txt
--rw-rw-rw-   0        0        0      126 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/requirements.win.txt
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.160066 xnote-web-0.1.0/config/user/
--rw-rw-rw-   0        0        0       76 2021-10-01 10:27:00.000000 xnote-web-0.1.0/config/user/invalid_names.list
--rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.0/config/user/user_config.default.properties
--rw-rw-rw-   0        0        0       23 2024-05-02 14:09:14.000000 xnote-web-0.1.0/config/version.txt
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.194989 xnote-web-0.1.0/docs/
--rw-rw-rw-   0        0        0     2792 2022-11-26 16:30:19.000000 xnote-web-0.1.0/docs/architecture.md
--rw-rw-rw-   0        0        0    18566 2024-03-16 14:56:17.000000 xnote-web-0.1.0/docs/changelog.md
--rw-rw-rw-   0        0        0     3008 2022-05-28 11:20:41.000000 xnote-web-0.1.0/docs/code_style.md
--rw-rw-rw-   0        0        0      567 2022-03-13 14:33:54.000000 xnote-web-0.1.0/docs/code_style_css.md
--rw-rw-rw-   0        0        0     2257 2022-11-26 16:30:19.000000 xnote-web-0.1.0/docs/commands.md
--rw-rw-rw-   0        0        0     3025 2023-10-27 13:17:40.000000 xnote-web-0.1.0/docs/database.md
--rw-rw-rw-   0        0        0     1799 2023-10-27 13:17:40.000000 xnote-web-0.1.0/docs/db_migrate.md
--rw-rw-rw-   0        0        0     1364 2022-11-26 16:30:19.000000 xnote-web-0.1.0/docs/plugins.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.418787 xnote-web-0.1.0/docs/screenshots/
--rw-rw-rw-   0        0        0    43384 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/architecture.png
--rw-rw-rw-   0        0        0    13063 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/architecture.svg
--rw-rw-rw-   0        0        0    57359 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/architecture_2.png
--rw-rw-rw-   0        0        0   112396 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/command_listdir.png
--rw-rw-rw-   0        0        0    81824 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/command_rmfolder.png
--rw-rw-rw-   0        0        0   139528 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/screenshot01.png
--rw-rw-rw-   0        0        0   236777 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/screenshot02.png
--rw-rw-rw-   0        0        0   101099 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/screenshot03.png
--rw-rw-rw-   0        0        0    24412 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/task_web.PNG
--rw-rw-rw-   0        0        0    29284 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.2_editor.PNG
--rw-rw-rw-   0        0        0    43162 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.2_list.PNG
--rw-rw-rw-   0        0        0   225642 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.2_mobile.png
--rw-rw-rw-   0        0        0    23527 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.2_search.png
--rw-rw-rw-   0        0        0    54676 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.3_desktop01.png
--rw-rw-rw-   0        0        0   153849 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.4.png
--rw-rw-rw-   0        0        0   235750 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v1.5.png
--rw-rw-rw-   0        0        0   214791 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.0.png
--rw-rw-rw-   0        0        0   187105 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.1_home.png
--rw-rw-rw-   0        0        0   202760 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.2_20190331.png
--rw-rw-rw-   0        0        0   179408 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.3_20190411.png
--rw-rw-rw-   0        0        0   214443 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.3_home.png
--rw-rw-rw-   0        0        0    99255 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.4_home.png
--rw-rw-rw-   0        0        0   103529 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.4_home2.png
--rw-rw-rw-   0        0        0    82664 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.5_20200502.png
--rw-rw-rw-   0        0        0   121009 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.5_home.png
--rw-rw-rw-   0        0        0    78846 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.5_recent.png
--rw-rw-rw-   0        0        0    66479 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.6_home.png
--rw-rw-rw-   0        0        0   107994 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.7_home.png
--rw-rw-rw-   0        0        0    88658 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.8_home.png
--rw-rw-rw-   0        0        0   120643 2022-11-26 16:30:19.000000 xnote-web-0.1.0/docs/screenshots/xnote_v2.9.2_home.png
--rw-rw-rw-   0        0        0   110782 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote_v20191111.png
--rw-rw-rw-   0        0        0   158216 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/screenshots/xnote架构.png
--rw-rw-rw-   0        0        0       16 2021-10-01 10:27:00.000000 xnote-web-0.1.0/docs/search_extension.md
--rw-rw-rw-   0        0        0      456 2024-03-16 14:56:17.000000 xnote-web-0.1.0/docs/upload_to_pip.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.445227 xnote-web-0.1.0/handlers/
--rw-rw-rw-   0        0        0       26 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.454491 xnote-web-0.1.0/handlers/admin/
--rw-rw-rw-   0        0        0        0 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/admin/__init__.py
--rw-rw-rw-   0        0        0     1439 2024-03-31 03:21:12.000000 xnote-web-0.1.0/handlers/admin/func_admin.py
--rw-rw-rw-   0        0        0     5756 2024-04-20 08:50:50.000000 xnote-web-0.1.0/handlers/admin/job_admin.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.487678 xnote-web-0.1.0/handlers/api/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/__init__.py
--rw-rw-rw-   0        0        0      705 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/alarm.py
--rw-rw-rw-   0        0        0      727 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/check_network.py
--rw-rw-rw-   0        0        0     1249 2023-03-11 14:27:18.000000 xnote-web-0.1.0/handlers/api/getip.py
--rw-rw-rw-   0        0        0      365 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/http_headers.py
--rw-rw-rw-   0        0        0     1466 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/ipv6.py
--rw-rw-rw-   0        0        0     3563 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/readbook.py
--rw-rw-rw-   0        0        0     1020 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/report_time.py
--rw-rw-rw-   0        0        0     1986 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/api/report_weather.py
--rw-rw-rw-   0        0        0      604 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/api/tts.py
--rw-rw-rw-   0        0        0       30 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/base.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.522795 xnote-web-0.1.0/handlers/code/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/code/__init__.py
--rw-rw-rw-   0        0        0     7726 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/code/code_edit.html
--rw-rw-rw-   0        0        0     4717 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/code/code_edit.py
--rw-rw-rw-   0        0        0     2573 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/code/code_lines.html
--rw-rw-rw-   0        0        0     6066 2022-04-30 02:31:41.000000 xnote-web-0.1.0/handlers/code/code_lines.py
--rw-rw-rw-   0        0        0     3278 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/code/code_search.html
--rw-rw-rw-   0        0        0     8351 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/code/code_search.py
--rw-rw-rw-   0        0        0     2480 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/code/preview.html
--rw-rw-rw-   0        0        0     5556 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/code/preview.py
--rw-rw-rw-   0        0        0     5912 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/code/wiki_edit.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.570951 xnote-web-0.1.0/handlers/common/
--rw-rw-rw-   0        0        0      472 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/README.md
--rw-rw-rw-   0        0        0      121 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/back.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.577328 xnote-web-0.1.0/handlers/common/base/
--rw-rw-rw-   0        0        0      410 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/base/README.md
--rw-rw-rw-   0        0        0     1358 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/base/pagination.html
--rw-rw-rw-   0        0        0     2156 2023-11-19 08:31:53.000000 xnote-web-0.1.0/handlers/common/base.html
--rw-rw-rw-   0        0        0       79 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/base_bottom.html
--rw-rw-rw-   0        0        0      927 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/base_footer.html
--rw-rw-rw-   0        0        0     2414 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/base_head.html
--rw-rw-rw-   0        0        0      988 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/base_nav.html
--rw-rw-rw-   0        0        0      185 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/base_simple.html
--rw-rw-rw-   0        0        0      645 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/base_title.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.581619 xnote-web-0.1.0/handlers/common/button/
--rw-rw-rw-   0        0        0      149 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/button/back_button.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.585619 xnote-web-0.1.0/handlers/common/date/
--rw-rw-rw-   0        0        0     2820 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/common/date/month_picker.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.589924 xnote-web-0.1.0/handlers/common/form/
--rw-rw-rw-   0        0        0     3630 2024-04-13 12:07:35.000000 xnote-web-0.1.0/handlers/common/form/form.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.600924 xnote-web-0.1.0/handlers/common/hook/
--rw-rw-rw-   0        0        0      137 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/hook/message_search_btn_hook.html
--rw-rw-rw-   0        0        0      526 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/hook/search_box_hook.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.606304 xnote-web-0.1.0/handlers/common/layout/
--rw-rw-rw-   0        0        0     3870 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/layout/base_layout.html
--rw-rw-rw-   0        0        0       67 2023-04-06 10:45:42.000000 xnote-web-0.1.0/handlers/common/layout/wide_left.html
--rw-rw-rw-   0        0        0      702 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/mod_notice.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.622690 xnote-web-0.1.0/handlers/common/nav/
--rw-rw-rw-   0        0        0     2919 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/nav/base_nav_left.html
--rw-rw-rw-   0        0        0     1374 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/nav/base_nav_project.html
--rw-rw-rw-   0        0        0      654 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/nav/base_nav_top.html
--rw-rw-rw-   0        0        0      799 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/nav/content_nav.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.626774 xnote-web-0.1.0/handlers/common/page/
--rw-rw-rw-   0        0        0      497 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/page/notfound.html
--rw-rw-rw-   0        0        0     1358 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/pagination.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.664324 xnote-web-0.1.0/handlers/common/script/
--rw-rw-rw-   0        0        0     1251 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/common/script/adjust.html
--rw-rw-rw-   0        0        0      420 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/script/debug_script.html
--rw-rw-rw-   0        0        0      965 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/script/geo_location.html
--rw-rw-rw-   0        0        0      460 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/common/script/image_fix_1.html
--rw-rw-rw-   0        0        0     4529 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/common/script/image_fix_2.html
--rw-rw-rw-   0        0        0      455 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/common/script/load_vue.html
--rw-rw-rw-   0        0        0      764 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/common/script/require_init.html
--rw-rw-rw-   0        0        0      256 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/script/safe_script.html
--rw-rw-rw-   0        0        0     3234 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/common/script/textarea_script.html
--rw-rw-rw-   0        0        0      463 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/common/script/translate_script.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.671324 xnote-web-0.1.0/handlers/common/search/
--rw-rw-rw-   0        0        0      758 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/search/search_box.html
--rw-rw-rw-   0        0        0      750 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/search/search_mobile.html
--rw-rw-rw-   0        0        0       43 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/search_box.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.678324 xnote-web-0.1.0/handlers/common/sidebar/
--rw-rw-rw-   0        0        0      724 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/sidebar/app_index.html
--rw-rw-rw-   0        0        0       43 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/sidebar/default.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.682326 xnote-web-0.1.0/handlers/common/table/
--rw-rw-rw-   0        0        0     3491 2024-04-21 04:39:30.000000 xnote-web-0.1.0/handlers/common/table/table.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.685323 xnote-web-0.1.0/handlers/common/text/
--rw-rw-rw-   0        0        0       41 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/common/text/empty_text.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.691159 xnote-web-0.1.0/handlers/common/theme/
--rw-rw-rw-   0        0        0     2331 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/common/theme/sidebar.html
--rw-rw-rw-   0        0        0     1683 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/common/theme/sidebar_left.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.695514 xnote-web-0.1.0/handlers/common/title/
--rw-rw-rw-   0        0        0      273 2021-10-31 03:54:18.000000 xnote-web-0.1.0/handlers/common/title/base_title.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.704293 xnote-web-0.1.0/handlers/cron/
--rw-rw-rw-   0        0        0      142 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/cron/__init__.py
--rw-rw-rw-   0        0        0      999 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/cron/cron_stats.py
--rw-rw-rw-   0        0        0     3344 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/cron/diskclean.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.721921 xnote-web-0.1.0/handlers/dict/
--rw-rw-rw-   0        0        0      136 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/dict/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.725224 xnote-web-0.1.0/handlers/dict/component/
--rw-rw-rw-   0        0        0      798 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/dict/component/dict_sidebar.html
--rw-rw-rw-   0        0        0     2483 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/dict/dao_relevant.py
--rw-rw-rw-   0        0        0     5490 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/dict/dict.py
--rw-rw-rw-   0        0        0     2620 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/dict/dict_dao.py
--rw-rw-rw-   0        0        0     2000 2022-05-21 15:50:36.000000 xnote-web-0.1.0/handlers/dict/dict_relevant.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.745475 xnote-web-0.1.0/handlers/dict/page/
--rw-rw-rw-   0        0        0     1899 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/dict/page/dict_add.html
--rw-rw-rw-   0        0        0     1255 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/dict/page/dict_edit.html
--rw-rw-rw-   0        0        0     1305 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/dict/page/dict_list.html
--rw-rw-rw-   0        0        0     2650 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/dict/page/dict_update.html
--rw-rw-rw-   0        0        0     3767 2022-05-15 04:37:11.000000 xnote-web-0.1.0/handlers/dict/page/relevant_list.html
--rw-rw-rw-   0        0        0      589 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/error.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.807553 xnote-web-0.1.0/handlers/fs/
--rw-rw-rw-   0        0        0      142 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.845483 xnote-web-0.1.0/handlers/fs/component/
--rw-rw-rw-   0        0        0     2927 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/component/clipboard-dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.851566 xnote-web-0.1.0/handlers/fs/component/css/
--rw-rw-rw-   0        0        0      103 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/fs/component/css/fs_css.html
--rw-rw-rw-   0        0        0     1505 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/component/filelist_gallery.html
--rw-rw-rw-   0        0        0     1174 2024-04-05 13:23:50.000000 xnote-web-0.1.0/handlers/fs/component/filelist_simple.html
--rw-rw-rw-   0        0        0      893 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/component/fs_sidebar.html
--rw-rw-rw-   0        0        0      408 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/component/fs_title.html
--rw-rw-rw-   0        0        0     4086 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/component/move_file_dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.861427 xnote-web-0.1.0/handlers/fs/component/options/
--rw-rw-rw-   0        0        0      673 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/fs/component/options/fs_options.html
--rw-rw-rw-   0        0        0     3238 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/fs/component/options/fs_options_buttons.html
--rw-rw-rw-   0        0        0     2132 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/fs/component/options/fs_options_buttons.mobile.html
--rw-rw-rw-   0        0        0     2942 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/fs/component/options_css.html
--rw-rw-rw-   0        0        0     1910 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/component/plugins-dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.866850 xnote-web-0.1.0/handlers/fs/component/script/
--rw-rw-rw-   0        0        0    13910 2024-05-02 13:44:58.000000 xnote-web-0.1.0/handlers/fs/component/script/file_op_script.html
--rw-rw-rw-   0        0        0    24179 2024-05-02 14:02:24.000000 xnote-web-0.1.0/handlers/fs/fs.py
--rw-rw-rw-   0        0        0     2642 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/fs_add.py
--rw-rw-rw-   0        0        0      867 2022-05-21 16:20:57.000000 xnote-web-0.1.0/handlers/fs/fs_api.py
--rw-rw-rw-   0        0        0     1862 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/fs/fs_cache.py
--rw-rw-rw-   0        0        0     2806 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/fs_find.py
--rw-rw-rw-   0        0        0     6768 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/fs_helper.py
--rw-rw-rw-   0        0        0     4615 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/fs_hex.py
--rw-rw-rw-   0        0        0     2428 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/fs_image.py
--rw-rw-rw-   0        0        0     7046 2024-04-03 14:52:41.000000 xnote-web-0.1.0/handlers/fs/fs_index.py
--rw-rw-rw-   0        0        0     1004 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/fs/fs_mode.py
--rw-rw-rw-   0        0        0     4700 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/fs_plugins.py
--rw-rw-rw-   0        0        0     3635 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/fs/fs_preview.py
--rw-rw-rw-   0        0        0     5410 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/fs_text.py
--rw-rw-rw-   0        0        0    14864 2024-05-02 13:42:44.000000 xnote-web-0.1.0/handlers/fs/fs_upload.py
--rw-rw-rw-   0        0        0     1902 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/mod_aside.html
--rw-rw-rw-   0        0        0     6622 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/mod_fs_upload.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.907639 xnote-web-0.1.0/handlers/fs/page/
--rw-rw-rw-   0        0        0     2180 2024-05-02 13:34:45.000000 xnote-web-0.1.0/handlers/fs/page/fs.html
--rw-rw-rw-   0        0        0     1974 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/fs/page/fs_bookmark.html
--rw-rw-rw-   0        0        0     3165 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/fs/page/fs_grid.html
--rw-rw-rw-   0        0        0     2778 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/page/fs_index.html
--rw-rw-rw-   0        0        0      352 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/page/fs_not_readable.html
--rw-rw-rw-   0        0        0     2540 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/page/fs_plugins.html
--rw-rw-rw-   0        0        0     1788 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/fs/page/fs_shell.html
--rw-rw-rw-   0        0        0     4442 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/fs/page/fs_sidebar.html
--rw-rw-rw-   0        0        0     5629 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/fs/page/fs_text.html
--rw-rw-rw-   0        0        0     4920 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/fs/page/fs_text_v1.html
--rw-rw-rw-   0        0        0     3078 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/fs/page/fs_upload.html
--rw-rw-rw-   0        0        0     2093 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/index.html
--rw-rw-rw-   0        0        0     1517 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/index.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.935817 xnote-web-0.1.0/handlers/message/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/message/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.942939 xnote-web-0.1.0/handlers/message/ajax/
--rw-rw-rw-   0        0        0     4497 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/ajax/message_ajax.html
--rw-rw-rw-   0        0        0     2711 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/message/ajax/message_tag_ajax.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:07.961805 xnote-web-0.1.0/handlers/message/card/
--rw-rw-rw-   0        0        0    17381 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/card/deleted_msg_left.html
--rw-rw-rw-   0        0        0     4712 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/message/card/deleted_msg_left_new.html
--rw-rw-rw-   0        0        0      585 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/message/card/deleted_msg_right.html
--rw-rw-rw-   0        0        0     1401 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/card/message_system_tag.html
--rw-rw-rw-   0        0        0     1429 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/message/card/msg_edit_card.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.022566 xnote-web-0.1.0/handlers/message/component/
--rw-rw-rw-   0        0        0      977 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/message_date_right.html
--rw-rw-rw-   0        0        0     3782 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/component/message_edit.html
--rw-rw-rw-   0        0        0      787 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/message/component/message_event.html
--rw-rw-rw-   0        0        0      415 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/message/component/message_header.html
--rw-rw-rw-   0        0        0     2860 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/component/message_input.html
--rw-rw-rw-   0        0        0     1230 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/component/message_keyword_info.html
--rw-rw-rw-   0        0        0     2059 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/component/message_list.html
--rw-rw-rw-   0        0        0     1956 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/message_sub_link.html
--rw-rw-rw-   0        0        0     1181 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/message_tab.html
--rw-rw-rw-   0        0        0      821 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/component/message_tab_log.html
--rw-rw-rw-   0        0        0      833 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/message_tab_task.html
--rw-rw-rw-   0        0        0      669 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/component/message_tag_list.html
--rw-rw-rw-   0        0        0      977 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/component/message_title.html
--rw-rw-rw-   0        0        0     3343 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/message_todo_inner.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.028227 xnote-web-0.1.0/handlers/message/component/right/
--rw-rw-rw-   0        0        0     1169 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/component/right/tags.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.032068 xnote-web-0.1.0/handlers/message/component/script/
--rw-rw-rw-   0        0        0     1009 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/message/component/script/tab_script.html
--rw-rw-rw-   0        0        0     1939 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/component/select_topic_dialog.html
--rw-rw-rw-   0        0        0      765 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/message/component/show_topic_dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.035663 xnote-web-0.1.0/handlers/message/component/tag/
--rw-rw-rw-   0        0        0      884 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/component/tag/orderby_tab.html
--rw-rw-rw-   0        0        0    33301 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/dao.py
--rw-rw-rw-   0        0        0    35414 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message.py
--rw-rw-rw-   0        0        0      904 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message_model.py
--rw-rw-rw-   0        0        0     3647 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message_search.py
--rw-rw-rw-   0        0        0     3058 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message_tag.py
--rw-rw-rw-   0        0        0     2646 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message_task.py
--rw-rw-rw-   0        0        0    17095 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/message_utils.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.072317 xnote-web-0.1.0/handlers/message/page/
--rw-rw-rw-   0        0        0     1064 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/message/page/message.html
--rw-rw-rw-   0        0        0     2226 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/page/message_calendar.html
--rw-rw-rw-   0        0        0     2214 2024-03-16 14:56:17.000000 xnote-web-0.1.0/handlers/message/page/message_list_by_day.html
--rw-rw-rw-   0        0        0     3752 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/page/message_list_view.html
--rw-rw-rw-   0        0        0     4057 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/message/page/message_search.html
--rw-rw-rw-   0        0        0     2716 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/page/message_tag_select.html
--rw-rw-rw-   0        0        0     1608 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/message/page/message_tag_view.html
--rw-rw-rw-   0        0        0      178 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/message/page/message_todo.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.080801 xnote-web-0.1.0/handlers/message/page/old/
--rw-rw-rw-   0        0        0     1967 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/page/old/dairy.html
--rw-rw-rw-   0        0        0    12904 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/message/page/old/message_calendar_old.html
--rw-rw-rw-   0        0        0     3251 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/message/page/task_index.html
--rw-rw-rw-   0        0        0      823 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/mod_fs_path.html
--rw-rw-rw-   0        0        0       36 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/mod_pagenation.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.177555 xnote-web-0.1.0/handlers/note/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.262578 xnote-web-0.1.0/handlers/note/ajax/
--rw-rw-rw-   0        0        0     2587 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/ajax/comment_edit_dialog.html
--rw-rw-rw-   0        0        0     1265 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/ajax/comment_list.html
--rw-rw-rw-   0        0        0     1281 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/note/ajax/edit_symbol_dialog.html
--rw-rw-rw-   0        0        0      134 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/note/ajax/group_detail_dialog.html
--rw-rw-rw-   0        0        0     3167 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/ajax/group_option_dialog.html
--rw-rw-rw-   0        0        0      407 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/note/ajax/option_dialog.html
--rw-rw-rw-   0        0        0       62 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/note/ajax/select_note_dialog.html
--rw-rw-rw-   0        0        0     1192 2022-03-12 15:02:09.000000 xnote-web-0.1.0/handlers/note/ajax/share_group_dialog.html
--rw-rw-rw-   0        0        0      726 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/ajax/share_note_dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.339420 xnote-web-0.1.0/handlers/note/card/
--rw-rw-rw-   0        0        0      277 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/card/README.md
--rw-rw-rw-   0        0        0      939 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/hot_notes.html
--rw-rw-rw-   0        0        0      950 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/note_contents_left.html
--rw-rw-rw-   0        0        0      936 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/card/note_date_picker.html
--rw-rw-rw-   0        0        0      977 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/note_groups.html
--rw-rw-rw-   0        0        0      994 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/note_types.html
--rw-rw-rw-   0        0        0      128 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/card/plan_detail.html
--rw-rw-rw-   0        0        0      952 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/plan_note_card.html
--rw-rw-rw-   0        0        0      952 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/plan_sidebar.html
--rw-rw-rw-   0        0        0     1063 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/recent_created_notes.html
--rw-rw-rw-   0        0        0     1138 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/recent_update_groups.html
--rw-rw-rw-   0        0        0     1352 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/recent_update_notes.html
--rw-rw-rw-   0        0        0     1195 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/sticky_notes.html
--rw-rw-rw-   0        0        0     1096 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/card/task_memo.html
--rw-rw-rw-   0        0        0     8850 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/comment.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.412782 xnote-web-0.1.0/handlers/note/component/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.416721 xnote-web-0.1.0/handlers/note/component/attribute/
--rw-rw-rw-   0        0        0     1024 2022-07-17 10:20:13.000000 xnote-web-0.1.0/handlers/note/component/attribute/note_category.html
--rw-rw-rw-   0        0        0     2699 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/component/batch_move.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.423538 xnote-web-0.1.0/handlers/note/component/button/
--rw-rw-rw-   0        0        0      317 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/button/fixed_bottom_buttons.html
--rw-rw-rw-   0        0        0      199 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/button/fixed_buttons.html
--rw-rw-rw-   0        0        0      581 2022-07-14 14:34:40.000000 xnote-web-0.1.0/handlers/note/component/create_note_header.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.432561 xnote-web-0.1.0/handlers/note/component/css/
--rw-rw-rw-   0        0        0     1574 2022-04-04 06:46:25.000000 xnote-web-0.1.0/handlers/note/component/css/edit_css.html
--rw-rw-rw-   0        0        0      788 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/component/css/gallery_css.html
--rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/detail_left.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.465401 xnote-web-0.1.0/handlers/note/component/editor/
--rw-rw-rw-   0        0        0      552 2022-04-19 15:15:43.000000 xnote-web-0.1.0/handlers/note/component/editor/editor_default_vars.html
--rw-rw-rw-   0        0        0     3141 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/component/editor/gallery.html
--rw-rw-rw-   0        0        0     6424 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/editor/markdown.html
--rw-rw-rw-   0        0        0    15648 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/editor/markdown_edit.html
--rw-rw-rw-   0        0        0     6150 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/editor/markdown_edit.mobile.html
--rw-rw-rw-   0        0        0     2051 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/component/editor/post.html
--rw-rw-rw-   0        0        0     1509 2022-04-01 14:26:37.000000 xnote-web-0.1.0/handlers/note/component/editor/table_lang.html
--rw-rw-rw-   0        0        0     2521 2022-04-04 15:50:05.000000 xnote-web-0.1.0/handlers/note/component/editor/table_myexcel.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.477174 xnote-web-0.1.0/handlers/note/component/filter/
--rw-rw-rw-   0        0        0      766 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/filter/group_tag_filter.html
--rw-rw-rw-   0        0        0      762 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/filter/note_tag_filter.html
--rw-rw-rw-   0        0        0      556 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/component/filter/type_filter.html
--rw-rw-rw-   0        0        0     1971 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/group_select.html
--rw-rw-rw-   0        0        0     3375 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/group_select_tree.html
--rw-rw-rw-   0        0        0       55 2022-04-22 14:59:54.000000 xnote-web-0.1.0/handlers/note/component/group_special_folder.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.484176 xnote-web-0.1.0/handlers/note/component/header/
--rw-rw-rw-   0        0        0     1096 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/note/component/header/common_header.html
--rw-rw-rw-   0        0        0      844 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/header/group_detail_header.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.487175 xnote-web-0.1.0/handlers/note/component/mobile/
--rw-rw-rw-   0        0        0      855 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/mobile/group_category_switch.html
--rw-rw-rw-   0        0        0     3460 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/mod_aside.html
--rw-rw-rw-   0        0        0      495 2022-06-26 11:06:28.000000 xnote-web-0.1.0/handlers/note/component/note_ext_info.html
--rw-rw-rw-   0        0        0     2899 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/note_list_component.html
--rw-rw-rw-   0        0        0      318 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/component/note_orderby.html
--rw-rw-rw-   0        0        0      668 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/note_orderby_select.html
--rw-rw-rw-   0        0        0      804 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/note_path.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.502558 xnote-web-0.1.0/handlers/note/component/option/
--rw-rw-rw-   0        0        0     1403 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/option/create_option.html
--rw-rw-rw-   0        0        0      756 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/component/option/group_option.html
--rw-rw-rw-   0        0        0     1303 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/option/group_option_dropdown.html
--rw-rw-rw-   0        0        0     5053 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/option/note_dropdown.html
--rw-rw-rw-   0        0        0      725 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/root_dropdown.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.553084 xnote-web-0.1.0/handlers/note/component/script/
--rw-rw-rw-   0        0        0      219 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/note/component/script/all_script.html
--rw-rw-rw-   0        0        0     2619 2022-07-15 06:43:03.000000 xnote-web-0.1.0/handlers/note/component/script/create_script.html
--rw-rw-rw-   0        0        0     1164 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/component/script/delete_script.html
--rw-rw-rw-   0        0        0     1513 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/script/group_select_script.html
--rw-rw-rw-   0        0        0      697 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/component/script/note_copy_script.html
--rw-rw-rw-   0        0        0     7434 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/script/note_option_script.html
--rw-rw-rw-   0        0        0      367 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/script/note_template.html
--rw-rw-rw-   0        0        0      125 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/script/orderby_script.html
--rw-rw-rw-   0        0        0      936 2022-03-07 15:10:58.000000 xnote-web-0.1.0/handlers/note/component/script/rename_script.html
--rw-rw-rw-   0        0        0     1443 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/note/component/script/share_script.html
--rw-rw-rw-   0        0        0      677 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/script/status_script.html
--rw-rw-rw-   0        0        0     3733 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/script/tag_manage_script.html
--rw-rw-rw-   0        0        0     2185 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/script/tag_script.html
--rw-rw-rw-   0        0        0     4092 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/note/component/share_dialog.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.577143 xnote-web-0.1.0/handlers/note/component/sidebar/
--rw-rw-rw-   0        0        0     1173 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/sidebar/group_list_sidebar.html
--rw-rw-rw-   0        0        0     1034 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/sidebar/group_manage_sidebar.html
--rw-rw-rw-   0        0        0     1672 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/sidebar/group_sidebar.html
--rw-rw-rw-   0        0        0     1370 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/sidebar/markdown_edit_sidebar.html
--rw-rw-rw-   0        0        0     1794 2024-01-27 06:07:10.000000 xnote-web-0.1.0/handlers/note/component/sidebar/note_sidebar.html
--rw-rw-rw-   0        0        0      324 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/sidebar/share_sidebar.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.581260 xnote-web-0.1.0/handlers/note/component/sort/
--rw-rw-rw-   0        0        0      694 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/sort/note_sort_tab.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.588037 xnote-web-0.1.0/handlers/note/component/timeline/
--rw-rw-rw-   0        0        0     4522 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/component/timeline/timeline_body.html
--rw-rw-rw-   0        0        0      716 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/timeline/timeline_create_option.html
--rw-rw-rw-   0        0        0     1794 2022-06-05 05:50:24.000000 xnote-web-0.1.0/handlers/note/component/view_css.html
--rw-rw-rw-   0        0        0      807 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/view_footer.html
--rw-rw-rw-   0        0        0     1368 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/component/view_header.html
--rw-rw-rw-   0        0        0     1798 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/component/view_header_tag.html
--rw-rw-rw-   0        0        0     1672 2022-03-12 01:39:04.000000 xnote-web-0.1.0/handlers/note/constant.py
--rw-rw-rw-   0        0        0    62424 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/dao.py
--rw-rw-rw-   0        0        0     2162 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_api.py
--rw-rw-rw-   0        0        0     2532 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_book.py
--rw-rw-rw-   0        0        0     1276 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_category.py
--rw-rw-rw-   0        0        0     6741 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/dao_comment.py
--rw-rw-rw-   0        0        0     2140 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_delete.py
--rw-rw-rw-   0        0        0     3383 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_draft.py
--rw-rw-rw-   0        0        0      687 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/dao_edit.py
--rw-rw-rw-   0        0        0     8364 2023-11-05 02:18:54.000000 xnote-web-0.1.0/handlers/note/dao_log.py
--rw-rw-rw-   0        0        0      879 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/dao_read.py
--rw-rw-rw-   0        0        0     4314 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/dao_share.py
--rw-rw-rw-   0        0        0    12681 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/dao_tag.py
--rw-rw-rw-   0        0        0    11086 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/html_importer.py
--rw-rw-rw-   0        0        0     2397 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/note_api.py
--rw-rw-rw-   0        0        0      487 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/note_calendar.py
--rw-rw-rw-   0        0        0     2934 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/note_category.py
--rw-rw-rw-   0        0        0     1381 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/note_checklist.py
--rw-rw-rw-   0        0        0    28876 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/note_edit.py
--rw-rw-rw-   0        0        0      491 2022-07-09 01:18:05.000000 xnote-web-0.1.0/handlers/note/note_fix.py
--rw-rw-rw-   0        0        0    31590 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/note_group.py
--rw-rw-rw-   0        0        0     1005 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/note_helper.py
--rw-rw-rw-   0        0        0     3144 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/note_stat.py
--rw-rw-rw-   0        0        0     8581 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/note_tag.py
--rw-rw-rw-   0        0        0    21187 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/note_timeline.py
--rw-rw-rw-   0        0        0    16587 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/note_view.py
--rw-rw-rw-   0        0        0     4669 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/note_workspace.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.665792 xnote-web-0.1.0/handlers/note/page/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.683297 xnote-web-0.1.0/handlers/note/page/batch/
--rw-rw-rw-   0        0        0      637 2024-04-05 13:29:57.000000 xnote-web-0.1.0/handlers/note/page/batch/gallery_manage.html
--rw-rw-rw-   0        0        0     7504 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/page/batch/group_manage.html
--rw-rw-rw-   0        0        0      632 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/note/page/batch/group_manage_category.html
--rw-rw-rw-   0        0        0     5580 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/batch/note_manage.html
--rw-rw-rw-   0        0        0      774 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/page/category.html
--rw-rw-rw-   0        0        0     5298 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/comment.html
--rw-rw-rw-   0        0        0      431 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/note/page/comment_user_page.html
--rw-rw-rw-   0        0        0     5726 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/create.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.706848 xnote-web-0.1.0/handlers/note/page/detail/
--rw-rw-rw-   0        0        0     2152 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/detail/checklist_detail.html
--rw-rw-rw-   0        0        0     2452 2023-04-06 04:04:41.000000 xnote-web-0.1.0/handlers/note/page/detail/form_detail.html
--rw-rw-rw-   0        0        0     1261 2024-03-16 14:56:18.000000 xnote-web-0.1.0/handlers/note/page/detail/group_detail.html
--rw-rw-rw-   0        0        0     1169 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/note/page/detail/group_detail_body.html
--rw-rw-rw-   0        0        0     1715 2023-04-06 04:04:41.000000 xnote-web-0.1.0/handlers/note/page/detail/note_detail.html
--rw-rw-rw-   0        0        0     5694 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/detail/table_detail.html
--rw-rw-rw-   0        0        0     1503 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/note/page/group_list.html
--rw-rw-rw-   0        0        0      764 2023-12-16 03:36:03.000000 xnote-web-0.1.0/handlers/note/page/group_list_nav_desktop.html
--rw-rw-rw-   0        0        0      862 2023-12-16 03:36:03.000000 xnote-web-0.1.0/handlers/note/page/group_list_nav_mobile.html
--rw-rw-rw-   0        0        0     1708 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/history_list.html
--rw-rw-rw-   0        0        0     4262 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/html_importer.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.722531 xnote-web-0.1.0/handlers/note/page/index/
--rw-rw-rw-   0        0        0      971 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/page/index/note_index.html
--rw-rw-rw-   0        0        0     1278 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/index/note_workspace.html
--rw-rw-rw-   0        0        0      907 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/index/note_workspace.mobile.html
--rw-rw-rw-   0        0        0     1008 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/page/index/note_workspace2.html
--rw-rw-rw-   0        0        0     3604 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/list_by_date.html
--rw-rw-rw-   0        0        0    12810 2024-04-05 13:32:08.000000 xnote-web-0.1.0/handlers/note/page/note_calendar.html
--rw-rw-rw-   0        0        0      606 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/note_default.html
--rw-rw-rw-   0        0        0     1426 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/note_list.html
--rw-rw-rw-   0        0        0     1508 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/note_recent.html
--rw-rw-rw-   0        0        0     2003 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/note/page/note_share.html
--rw-rw-rw-   0        0        0     1292 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/note_tools.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.749302 xnote-web-0.1.0/handlers/note/page/old/
--rw-rw-rw-   0        0        0      740 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/old/category_old.html
--rw-rw-rw-   0        0        0     1425 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/note/page/old/create_log.html
--rw-rw-rw-   0        0        0      807 2022-06-18 00:42:54.000000 xnote-web-0.1.0/handlers/note/page/old/group_list_archived.html
--rw-rw-rw-   0        0        0     2324 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/old/list_by_date_old.html
--rw-rw-rw-   0        0        0       92 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/note/page/old/notice.html
--rw-rw-rw-   0        0        0     4194 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/old/project_list_old.html
--rw-rw-rw-   0        0        0     2150 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/old/upload_file.html
--rw-rw-rw-   0        0        0     1267 2023-04-06 04:04:41.000000 xnote-web-0.1.0/handlers/note/page/print.html
--rw-rw-rw-   0        0        0     1286 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/note/page/taglist.html
--rw-rw-rw-   0        0        0      783 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/note/page/tagname.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.753302 xnote-web-0.1.0/handlers/note/page/timeline/
--rw-rw-rw-   0        0        0     1902 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/note/page/timeline/timeline.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.767087 xnote-web-0.1.0/handlers/plan/
--rw-rw-rw-   0        0        0        0 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/plan/__init__.py
--rw-rw-rw-   0        0        0     2118 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plan/dao.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.771087 xnote-web-0.1.0/handlers/plan/page/
--rw-rw-rw-   0        0        0     3773 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plan/page/month_plan.html
--rw-rw-rw-   0        0        0     3641 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plan/plan.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.788984 xnote-web-0.1.0/handlers/plugin/
--rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/plugin/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.803747 xnote-web-0.1.0/handlers/plugin/base/
--rw-rw-rw-   0        0        0     2051 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/plugin/base/base_form_plugin.html
--rw-rw-rw-   0        0        0     1118 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/plugin/base/base_plugin.html
--rw-rw-rw-   0        0        0      510 2022-06-19 09:05:51.000000 xnote-web-0.1.0/handlers/plugin/base/base_plugin_body.html
--rw-rw-rw-   0        0        0     2228 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plugin/base/base_plugin_title.html
--rw-rw-rw-   0        0        0     3037 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plugin/dao.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.819215 xnote-web-0.1.0/handlers/plugin/header/
--rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/plugin/header/plugin_category.html
--rw-rw-rw-   0        0        0      930 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/plugin/header/plugin_header_normal.html
--rw-rw-rw-   0        0        0      254 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/plugin/header/plugin_header_note.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.835550 xnote-web-0.1.0/handlers/plugin/page/
--rw-rw-rw-   0        0        0      999 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/plugin/page/grid.html
--rw-rw-rw-   0        0        0     4756 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/plugin/page/plugins_v1.html
--rw-rw-rw-   0        0        0     1677 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/plugin/page/plugins_v2.html
--rw-rw-rw-   0        0        0     1341 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/plugin/page/plugins_v3.html
--rw-rw-rw-   0        0        0     3969 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plugin/plugin_create.py
--rw-rw-rw-   0        0        0    28433 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plugin/plugin_page.py
--rw-rw-rw-   0        0        0     1812 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/plugin/plugin_upload.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.886683 xnote-web-0.1.0/handlers/search/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.892934 xnote-web-0.1.0/handlers/search/ajax/
--rw-rw-rw-   0        0        0      641 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/search/ajax/search_dialog.html
--rw-rw-rw-   0        0        0      977 2022-02-11 14:35:52.000000 xnote-web-0.1.0/handlers/search/ajax/search_dialog_detail.html
--rw-rw-rw-   0        0        0     1364 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/search/api.py
--rw-rw-rw-   0        0        0      958 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/calc.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.905121 xnote-web-0.1.0/handlers/search/component/
--rw-rw-rw-   0        0        0     1367 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/search/component/search_pagination.html
--rw-rw-rw-   0        0        0     1034 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/search/component/search_sidebar.html
--rw-rw-rw-   0        0        0     2172 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/search/component/search_tab.html
--rw-rw-rw-   0        0        0     3278 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/search/dictionary.py
--rw-rw-rw-   0        0        0      910 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/mute.py
--rw-rw-rw-   0        0        0     1428 2022-03-10 14:02:41.000000 xnote-web-0.1.0/handlers/search/note.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.913136 xnote-web-0.1.0/handlers/search/page/
--rw-rw-rw-   0        0        0     1967 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/search/page/search_history.html
--rw-rw-rw-   0        0        0     5839 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/search/page/search_result.html
--rw-rw-rw-   0        0        0      617 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/pydoc.py
--rw-rw-rw-   0        0        0     2905 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/reminder.py
--rw-rw-rw-   0        0        0     1778 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/search/scripts.py
--rw-rw-rw-   0        0        0     1245 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/search/search.html
--rw-rw-rw-   0        0        0    18128 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/search/search.py
--rw-rw-rw-   0        0        0      440 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/search/search_aside.html
--rw-rw-rw-   0        0        0     1874 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/search/search_rules.html
--rw-rw-rw-   0        0        0     2878 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/search/tools.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.919855 xnote-web-0.1.0/handlers/settings/
--rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/settings/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.937012 xnote-web-0.1.0/handlers/settings/component/
--rw-rw-rw-   0        0        0     2855 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/component/admin_settings.html
--rw-rw-rw-   0        0        0     4751 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/component/note_settings.html
--rw-rw-rw-   0        0        0     1278 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/component/search_settings.html
--rw-rw-rw-   0        0        0      868 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/component/settings_sidebar.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:08.943928 xnote-web-0.1.0/handlers/settings/page/
--rw-rw-rw-   0        0        0     1951 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/page/properties.html
--rw-rw-rw-   0        0        0     2097 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/settings/page/settings.html
--rw-rw-rw-   0        0        0     7109 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/settings/settings.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.048875 xnote-web-0.1.0/handlers/system/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/system/__init__.py
--rw-rw-rw-   0        0        0    14937 2024-04-21 14:30:26.000000 xnote-web-0.1.0/handlers/system/backup.py
--rw-rw-rw-   0        0        0     2773 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/cache_admin.py
--rw-rw-rw-   0        0        0     4849 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/clipboard.py
--rw-rw-rw-   0        0        0     3628 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/system/command.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.081684 xnote-web-0.1.0/handlers/system/component/
--rw-rw-rw-   0        0        0     1425 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/component/admin_nav.html
--rw-rw-rw-   0        0        0      979 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/component/db_kv_nav.html
--rw-rw-rw-   0        0        0     1051 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/component/db_nav.html
--rw-rw-rw-   0        0        0      463 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/system/component/system_css.html
--rw-rw-rw-   0        0        0      597 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/component/system_log_tab.html
--rw-rw-rw-   0        0        0     1445 2022-07-02 01:04:41.000000 xnote-web-0.1.0/handlers/system/component/system_sync_cluster_info.html
--rw-rw-rw-   0        0        0     3450 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/component/system_sync_follower_view.html
--rw-rw-rw-   0        0        0      564 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/component/thread_nav.html
--rw-rw-rw-   0        0        0     9561 2024-04-20 08:36:25.000000 xnote-web-0.1.0/handlers/system/crontab.py
--rw-rw-rw-   0        0        0      719 2024-04-20 08:34:48.000000 xnote-web-0.1.0/handlers/system/dao_cron.py
--rw-rw-rw-   0        0        0    19557 2024-04-15 15:37:16.000000 xnote-web-0.1.0/handlers/system/db_admin.py
--rw-rw-rw-   0        0        0     3959 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/db_index.py
--rw-rw-rw-   0        0        0     8098 2023-10-21 00:22:22.000000 xnote-web-0.1.0/handlers/system/db_migrate_tools.py
--rw-rw-rw-   0        0        0     1808 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/db_refresh.py
--rw-rw-rw-   0        0        0     3968 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/db_shell.py
--rw-rw-rw-   0        0        0     1132 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/db_upgrade.py
--rw-rw-rw-   0        0        0      534 2022-05-06 04:45:28.000000 xnote-web-0.1.0/handlers/system/develop_controller.py
--rw-rw-rw-   0        0        0     2165 2024-04-13 14:16:03.000000 xnote-web-0.1.0/handlers/system/handler_profile.py
--rw-rw-rw-   0        0        0     1823 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/mod_aside.html
--rw-rw-rw-   0        0        0      567 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/network_profile.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.134926 xnote-web-0.1.0/handlers/system/page/
--rw-rw-rw-   0        0        0     2797 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/cache_admin.html
--rw-rw-rw-   0        0        0     2586 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/page/crontab.html
--rw-rw-rw-   0        0        0     2259 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/system/page/crontab_edit.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.166930 xnote-web-0.1.0/handlers/system/page/db/
--rw-rw-rw-   0        0        0     6164 2024-04-15 15:37:25.000000 xnote-web-0.1.0/handlers/system/page/db/db_admin.html
--rw-rw-rw-   0        0        0     2055 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/page/db/db_backup.html
--rw-rw-rw-   0        0        0     2555 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/db/db_index.html
--rw-rw-rw-   0        0        0     1192 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/db/db_index_v2.html
--rw-rw-rw-   0        0        0     2342 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/db/db_meta.html
--rw-rw-rw-   0        0        0     1557 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/db/db_struct.html
--rw-rw-rw-   0        0        0      649 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/db/driver_info.html
--rw-rw-rw-   0        0        0     1091 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/db/sqldb_detail.html
--rw-rw-rw-   0        0        0     1412 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/db/sqldb_list.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.173358 xnote-web-0.1.0/handlers/system/page/develop/
--rw-rw-rw-   0        0        0        0 2022-05-06 04:45:10.000000 xnote-web-0.1.0/handlers/system/page/develop/component_demo.html
--rw-rw-rw-   0        0        0      971 2024-03-31 10:54:40.000000 xnote-web-0.1.0/handlers/system/page/develop/index.html
--rw-rw-rw-   0        0        0      931 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/system/page/history.html
--rw-rw-rw-   0        0        0     1726 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/module_detail.html
--rw-rw-rw-   0        0        0     1046 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/page/module_list.html
--rw-rw-rw-   0        0        0     5954 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/page/script.html
--rw-rw-rw-   0        0        0     2949 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/sqlite.html
--rw-rw-rw-   0        0        0      651 2022-06-18 13:08:01.000000 xnote-web-0.1.0/handlers/system/page/system_admin.html
--rw-rw-rw-   0        0        0     2661 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/page/system_index.html
--rw-rw-rw-   0        0        0     2291 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/system_info.html
--rw-rw-rw-   0        0        0      651 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/system/page/system_info_text.html
--rw-rw-rw-   0        0        0     4173 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/system_sync.html
--rw-rw-rw-   0        0        0      590 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/system/page/template_cache.html
--rw-rw-rw-   0        0        0     1360 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/page/thread_info.html
--rw-rw-rw-   0        0        0     6736 2023-03-04 06:34:27.000000 xnote-web-0.1.0/handlers/system/script.py
--rw-rw-rw-   0        0        0     3566 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/stats.py
--rw-rw-rw-   0        0        0     8047 2024-04-20 08:44:06.000000 xnote-web-0.1.0/handlers/system/system.py
--rw-rw-rw-   0        0        0      708 2022-04-03 14:17:05.000000 xnote-web-0.1.0/handlers/system/system_boot.py
--rw-rw-rw-   0        0        0     2513 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/system_event.py
--rw-rw-rw-   0        0        0     5213 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/system_info.py
--rw-rw-rw-   0        0        0     7523 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_log.py
--rw-rw-rw-   0        0        0     4428 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/system_module.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.198223 xnote-web-0.1.0/handlers/system/system_sync/
--rw-rw-rw-   0        0        0      772 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/system_sync/models.py
--rw-rw-rw-   0        0        0     1386 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/node_base.py
--rw-rw-rw-   0        0        0    19983 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/node_follower.py
--rw-rw-rw-   0        0        0     9517 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/node_leader.py
--rw-rw-rw-   0        0        0    12355 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/system_sync_controller.py
--rw-rw-rw-   0        0        0     7071 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/system_sync_indexer.py
--rw-rw-rw-   0        0        0    10245 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/system/system_sync/system_sync_proxy.py
--rw-rw-rw-   0        0        0      444 2023-04-06 15:44:02.000000 xnote-web-0.1.0/handlers/system/system_todo.py
--rw-rw-rw-   0        0        0      676 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/system/template_cache.py
--rw-rw-rw-   0        0        0      852 2024-04-03 14:55:09.000000 xnote-web-0.1.0/handlers/system/thread_info.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.255226 xnote-web-0.1.0/handlers/test/
--rw-rw-rw-   0        0        0      128 2022-01-25 14:37:52.000000 xnote-web-0.1.0/handlers/test/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.259225 xnote-web-0.1.0/handlers/test/component/
--rw-rw-rw-   0        0        0     1034 2024-03-31 03:24:19.000000 xnote-web-0.1.0/handlers/test/component/example_nav.html
--rw-rw-rw-   0        0        0      193 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/test/exception.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.309819 xnote-web-0.1.0/handlers/test/page/
--rw-rw-rw-   0        0        0      697 2022-06-26 11:21:01.000000 xnote-web-0.1.0/handlers/test/page/example_btn.html
--rw-rw-rw-   0        0        0     1378 2022-05-07 14:15:21.000000 xnote-web-0.1.0/handlers/test/page/example_dialog.html
--rw-rw-rw-   0        0        0      866 2022-03-13 13:50:59.000000 xnote-web-0.1.0/handlers/test/page/example_dropdown.html
--rw-rw-rw-   0        0        0     1537 2022-04-17 03:52:32.000000 xnote-web-0.1.0/handlers/test/page/example_hammer.html
--rw-rw-rw-   0        0        0      102 2022-03-11 12:10:15.000000 xnote-web-0.1.0/handlers/test/page/example_index.html
--rw-rw-rw-   0        0        0     1707 2022-03-13 13:45:19.000000 xnote-web-0.1.0/handlers/test/page/example_tab.html
--rw-rw-rw-   0        0        0     1032 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/test/page/example_tag.html
--rw-rw-rw-   0        0        0     1695 2024-04-13 12:09:36.000000 xnote-web-0.1.0/handlers/test/test_dbutil_handler.py
--rw-rw-rw-   0        0        0      977 2024-03-31 06:02:23.000000 xnote-web-0.1.0/handlers/test/test_handler.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.445671 xnote-web-0.1.0/handlers/tools/
--rw-rw-rw-   0        0        0      105 2022-04-17 09:04:15.000000 xnote-web-0.1.0/handlers/tools/__init__.py
--rw-rw-rw-   0        0        0     2198 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/barcode.html
--rw-rw-rw-   0        0        0     1035 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/base64.html
--rw-rw-rw-   0        0        0      371 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/base_title.html
--rw-rw-rw-   0        0        0     3539 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/browser_info.html
--rw-rw-rw-   0        0        0     4077 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/camera.html
--rw-rw-rw-   0        0        0     1353 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/chat_demo.html
--rw-rw-rw-   0        0        0    10087 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/code_template.html
--rw-rw-rw-   0        0        0     3818 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/color.html
--rw-rw-rw-   0        0        0     1486 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/datetime.html
--rw-rw-rw-   0        0        0     5346 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/hex.html
--rw-rw-rw-   0        0        0      426 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/iframe_viewer.html
--rw-rw-rw-   0        0        0     6029 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/img2gray.html
--rw-rw-rw-   0        0        0     7694 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/img_merge.html
--rw-rw-rw-   0        0        0     6002 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/img_split.html
--rw-rw-rw-   0        0        0      619 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/md5.html
--rw-rw-rw-   0        0        0     4769 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/multi_win.html
--rw-rw-rw-   0        0        0     3033 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/notebook.html
--rw-rw-rw-   0        0        0      342 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/notebook.py
--rw-rw-rw-   0        0        0     2101 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/port_scanner.py
--rw-rw-rw-   0        0        0     1020 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/qrcode.html
--rw-rw-rw-   0        0        0     2424 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/random_string.html
--rw-rw-rw-   0        0        0     1000 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/responsive.html
--rw-rw-rw-   0        0        0     4119 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/runjs.html
--rw-rw-rw-   0        0        0     1224 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/search_compare.html
--rw-rw-rw-   0        0        0      774 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/sha1.html
--rw-rw-rw-   0        0        0     1937 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/shell.html
--rw-rw-rw-   0        0        0     3906 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/speech_recognition.html
--rw-rw-rw-   0        0        0      896 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/tcc.html
--rw-rw-rw-   0        0        0     1409 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/terminal.html
--rw-rw-rw-   0        0        0     8164 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/text_convert.html
--rw-rw-rw-   0        0        0     3732 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/tools/text_diff.html
--rw-rw-rw-   0        0        0     3297 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/text_set.html
--rw-rw-rw-   0        0        0     1011 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/tools.py
--rw-rw-rw-   0        0        0      487 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/tts.html
--rw-rw-rw-   0        0        0     1249 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/tools/urlcoder.html
--rw-rw-rw-   0        0        0     7610 2022-11-26 16:30:19.000000 xnote-web-0.1.0/handlers/tools/vue_test.html
--rw-rw-rw-   0        0        0     5326 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/tools/webuploader.html
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.462670 xnote-web-0.1.0/handlers/user/
--rw-rw-rw-   0        0        0      287 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/user/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.466670 xnote-web-0.1.0/handlers/user/component/
--rw-rw-rw-   0        0        0     1241 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/user/component/user_script.html
--rw-rw-rw-   0        0        0      347 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/user/dao.py
--rw-rw-rw-   0        0        0     4949 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/user/login.py
--rw-rw-rw-   0        0        0      255 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/user/logout.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.490603 xnote-web-0.1.0/handlers/user/page/
--rw-rw-rw-   0        0        0     1516 2023-04-06 15:52:08.000000 xnote-web-0.1.0/handlers/user/page/change_password.html
--rw-rw-rw-   0        0        0     3357 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/user/page/login.html
--rw-rw-rw-   0        0        0      912 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/user/page/user.html
--rw-rw-rw-   0        0        0     3551 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/user/page/user_list.html
--rw-rw-rw-   0        0        0     2440 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/user/page/user_manage.html
--rw-rw-rw-   0        0        0      802 2023-10-27 13:17:40.000000 xnote-web-0.1.0/handlers/user/page/user_op_log.html
--rw-rw-rw-   0        0        0     1522 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/user/page/userinfo.html
--rw-rw-rw-   0        0        0     6400 2024-03-16 14:56:19.000000 xnote-web-0.1.0/handlers/user/user.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.498791 xnote-web-0.1.0/handlers/webdav/
--rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.0/handlers/webdav/__init__.py
--rw-rw-rw-   0        0        0     5704 2023-06-30 12:24:59.000000 xnote-web-0.1.0/handlers/webdav/webdav.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.542110 xnote-web-0.1.0/lib/
--rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.0/lib/__init__.py
--rw-rw-rw-   0        0        0    33040 2022-05-22 05:10:24.000000 xnote-web-0.1.0/lib/html2text.py
--rw-rw-rw-   0        0        0   451584 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/leveldb-x64.dll
--rw-rw-rw-   0        0        0   367104 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/leveldb.dll
--rw-rw-rw-   0        0        0    37736 2023-10-27 13:17:40.000000 xnote-web-0.1.0/lib/leveldbpy.py
--rw-rw-rw-   0        0        0     6529 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/smallseg.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.599204 xnote-web-0.1.0/lib/web/
--rw-rw-rw-   0        0        0      754 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/__init__.py
--rw-rw-rw-   0        0        0    25946 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/application.py
--rw-rw-rw-   0        0        0     8714 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/browser.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.605934 xnote-web-0.1.0/lib/web/contrib/
--rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/contrib/__init__.py
--rw-rw-rw-   0        0        0     3457 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/contrib/template.py
--rw-rw-rw-   0        0        0    56068 2023-12-02 10:30:00.000000 xnote-web-0.1.0/lib/web/db.py
--rw-rw-rw-   0        0        0    13157 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/debugerror.py
--rw-rw-rw-   0        0        0    13983 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/form.py
--rw-rw-rw-   0        0        0     4619 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/http.py
--rw-rw-rw-   0        0        0    13278 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/httpserver.py
--rw-rw-rw-   0        0        0     6507 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/net.py
--rw-rw-rw-   0        0        0      877 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/py3helpers.py
--rw-rw-rw-   0        0        0    10921 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/session.py
--rw-rw-rw-   0        0        0    49690 2022-11-26 16:30:19.000000 xnote-web-0.1.0/lib/web/template.py
--rw-rw-rw-   0        0        0     2261 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/test.py
--rw-rw-rw-   0        0        0    42559 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/utils.py
--rw-rw-rw-   0        0        0    17704 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/webapi.py
--rw-rw-rw-   0        0        0     3707 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/webopenid.py
--rw-rw-rw-   0        0        0     2452 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgi.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.626914 xnote-web-0.1.0/lib/web/wsgiserver/
--rw-rw-rw-   0        0        0     1542 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgiserver/LICENSE.txt
--rw-rw-rw-   0        0        0      580 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgiserver/__init__.py
--rw-rw-rw-   0        0        0     4032 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgiserver/ssl_builtin.py
--rw-rw-rw-   0        0        0     9223 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgiserver/ssl_pyopenssl.py
--rw-rw-rw-   0        0        0    89663 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/web/wsgiserver/wsgiserver2.py
--rw-rw-rw-   0        0        0    79905 2022-02-26 02:25:16.000000 xnote-web-0.1.0/lib/web/wsgiserver/wsgiserver3.py
--rw-rw-rw-   0        0        0    22355 2021-10-01 10:27:00.000000 xnote-web-0.1.0/lib/wget.py
--rw-rw-rw-   0        0        0       42 2024-05-03 04:09:11.430080 xnote-web-0.1.0/setup.cfg
--rw-rw-rw-   0        0        0      985 2024-05-03 04:08:52.000000 xnote-web-0.1.0/setup.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.645211 xnote-web-0.1.0/static/
--rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.648257 xnote-web-0.1.0/static/audio/
--rw-rw-rw-   0        0        0    26675 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/audio/todo_done.mp3
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.691262 xnote-web-0.1.0/static/css/
--rw-rw-rw-   0        0        0    83858 2024-05-02 13:38:51.000000 xnote-web-0.1.0/static/css/app.build.css
--rw-rw-rw-   0        0        0     1926 2024-03-16 14:56:19.000000 xnote-web-0.1.0/static/css/app.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.748385 xnote-web-0.1.0/static/css/base/
--rw-rw-rw-   0        0        0     3205 2024-05-02 13:38:50.000000 xnote-web-0.1.0/static/css/base/common-button.css
--rw-rw-rw-   0        0        0      273 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/css/base/common-dialog.css
--rw-rw-rw-   0        0        0     1570 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/css/base/common-dropdown.css
--rw-rw-rw-   0        0        0     2212 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/base/common-icon.css
--rw-rw-rw-   0        0        0     1476 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/css/base/common-layout.css
--rw-rw-rw-   0        0        0      651 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/base/common-markdown.css
--rw-rw-rw-   0        0        0     1312 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/css/base/common-mobile.css
--rw-rw-rw-   0        0        0      927 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/css/base/common-page.css
--rw-rw-rw-   0        0        0      603 2023-04-16 02:40:01.000000 xnote-web-0.1.0/static/css/base/common-photo.css
--rw-rw-rw-   0        0        0     2241 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/css/base/common-tab.css
--rw-rw-rw-   0        0        0     2137 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/css/base/common-tag.css
--rw-rw-rw-   0        0        0    18296 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/css/base/common.css
--rw-rw-rw-   0        0        0      424 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/css/base/layout-second-nav.css
--rw-rw-rw-   0        0        0      368 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/css/base/reset-wide.css
--rw-rw-rw-   0        0        0     2689 2024-04-13 12:48:39.000000 xnote-web-0.1.0/static/css/base/reset.css
--rw-rw-rw-   0        0        0     1795 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/css/common-card.css
--rw-rw-rw-   0        0        0     3943 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/common-left.css
--rw-rw-rw-   0        0        0      802 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/common-react.css
--rw-rw-rw-   0        0        0    31004 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/font-awesome.min.css
--rw-rw-rw-   0        0        0     4476 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/css/message.css
--rw-rw-rw-   0        0        0     5431 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/css/note.css
--rw-rw-rw-   0        0        0      704 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/plugins.css
--rw-rw-rw-   0        0        0      269 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/search.css
--rw-rw-rw-   0        0        0     2066 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/css/timeline.css
--rw-rw-rw-   0        0        0     1286 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/css/todo.css
--rw-rw-rw-   0        0        0    16958 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/favicon.ico
--rw-rw-rw-   0        0        0    16372 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/favicon.png
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.756487 xnote-web-0.1.0/static/fonts/
--rw-rw-rw-   0        0        0    83588 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/fonts/fontawesome-webfont.woff
--rw-rw-rw-   0        0        0    66624 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/fonts/fontawesome-webfont.woff2
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.847382 xnote-web-0.1.0/static/image/
--rw-rw-rw-   0        0        0     1277 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/checked.png
--rw-rw-rw-   0        0        0     2593 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/file.png
--rw-rw-rw-   0        0        0      985 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/file2.png
--rw-rw-rw-   0        0        0      120 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/folder.gif
--rw-rw-rw-   0        0        0      340 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/folder2.png
--rw-rw-rw-   0        0        0     5696 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/folder3.png
--rw-rw-rw-   0        0        0      496 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_application.png
--rw-rw-rw-   0        0        0      956 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_application.svg
--rw-rw-rw-   0        0        0      128 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_csv.png
--rw-rw-rw-   0        0        0     1493 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_dict.png
--rw-rw-rw-   0        0        0      838 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_dict.svg
--rw-rw-rw-   0        0        0      465 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_folder_settings.png
--rw-rw-rw-   0        0        0     1024 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_recent.png
--rw-rw-rw-   0        0        0     1359 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_recent.svg
--rw-rw-rw-   0        0        0      696 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_right.png
--rw-rw-rw-   0        0        0      821 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_script.png
--rw-rw-rw-   0        0        0     1890 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_script.svg
--rw-rw-rw-   0        0        0     1194 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_search.png
--rw-rw-rw-   0        0        0     1122 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_search.svg
--rw-rw-rw-   0        0        0      958 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_settings_applications.png
--rw-rw-rw-   0        0        0     2120 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_settings_applications.svg
--rw-rw-rw-   0        0        0     1353 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_shell.png
--rw-rw-rw-   0        0        0      743 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_shell.svg
--rw-rw-rw-   0        0        0     2901 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icon_txt.png
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.862201 xnote-web-0.1.0/static/image/icons/
--rw-rw-rw-   0        0        0     1707 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icons/icon_barcode.png
--rw-rw-rw-   0        0        0     3158 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icons/icon_game.png
--rw-rw-rw-   0        0        0     5203 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icons/icon_network.png
--rw-rw-rw-   0        0        0     1375 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/image/icons/icon_work.png
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.914743 xnote-web-0.1.0/static/js/
--rw-rw-rw-   0        0        0     2294 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/Lexer.js
--rw-rw-rw-   0        0        0      657 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/admin.js
--rw-rw-rw-   0        0        0   103599 2024-05-02 14:01:09.000000 xnote-web-0.1.0/static/js/app.build.js
--rw-rw-rw-   0        0        0     7644 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/js/app.js
--rw-rw-rw-   0        0        0      472 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/js/autocss.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.939698 xnote-web-0.1.0/static/js/base/
--rw-rw-rw-   0        0        0     1309 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/ajax.js
--rw-rw-rw-   0        0        0     4375 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/array.js
--rw-rw-rw-   0        0        0      726 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/datetime.js
--rw-rw-rw-   0        0        0      731 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/jq-ext.js
--rw-rw-rw-   0        0        0      580 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/misc.js
--rw-rw-rw-   0        0        0     8338 2023-12-02 11:08:59.000000 xnote-web-0.1.0/static/js/base/string.js
--rw-rw-rw-   0        0        0     3173 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/base/url.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.943151 xnote-web-0.1.0/static/js/codemirror-addon/
--rw-rw-rw-   0        0        0    11711 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/codemirror-addon/xnote-search.js
--rw-rw-rw-   0        0        0    21933 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/colors.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.947445 xnote-web-0.1.0/static/js/components/
--rw-rw-rw-   0        0        0      786 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/components/date-picker.js
--rw-rw-rw-   0        0        0     7614 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/console.js
--rw-rw-rw-   0        0        0     2706 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/editor-csv.js
--rw-rw-rw-   0        0        0     9949 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/editor.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.950863 xnote-web-0.1.0/static/js/fs/
--rw-rw-rw-   0        0        0     2314 2024-05-02 13:58:06.000000 xnote-web-0.1.0/static/js/fs/fs.js
--rw-rw-rw-   0        0        0    16458 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/marked-ext.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:09.975003 xnote-web-0.1.0/static/js/message/
--rw-rw-rw-   0        0        0    11638 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/message/message.js
--rw-rw-rw-   0        0        0    15989 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/note.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.005003 xnote-web-0.1.0/static/js/old/
--rw-rw-rw-   0        0        0     5071 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/old/TagEditor.js
--rw-rw-rw-   0        0        0     2489 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/old/fileEditor.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.009001 xnote-web-0.1.0/static/js/plan/
--rw-rw-rw-   0        0        0     2543 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/plan/plan.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.037002 xnote-web-0.1.0/static/js/plugin/
--rw-rw-rw-   0        0        0     1811 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/plugin/plugin.form.js
--rw-rw-rw-   0        0        0     4091 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/upload.js
--rw-rw-rw-   0        0        0    14750 2023-12-02 11:09:33.000000 xnote-web-0.1.0/static/js/utils.build.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.138981 xnote-web-0.1.0/static/js/xnote-ui/
--rw-rw-rw-   0        0        0    11058 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/layer.photos.js
--rw-rw-rw-   0        0        0      703 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/js/xnote-ui/x-audio.js
--rw-rw-rw-   0        0        0      190 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-core.js
--rw-rw-rw-   0        0        0     2072 2023-04-16 02:40:01.000000 xnote-web-0.1.0/static/js/xnote-ui/x-device.js
--rw-rw-rw-   0        0        0    15513 2024-03-31 06:06:00.000000 xnote-web-0.1.0/static/js/xnote-ui/x-dialog.js
--rw-rw-rw-   0        0        0     3063 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-dropdown.js
--rw-rw-rw-   0        0        0     4092 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-event.js
--rw-rw-rw-   0        0        0      327 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/js/xnote-ui/x-ext.js
--rw-rw-rw-   0        0        0     8478 2024-03-16 14:56:20.000000 xnote-web-0.1.0/static/js/xnote-ui/x-init.js
--rw-rw-rw-   0        0        0      674 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-layout.js
--rw-rw-rw-   0        0        0     1365 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-photo.js
--rw-rw-rw-   0        0        0     1962 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-tab.js
--rw-rw-rw-   0        0        0     1257 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/js/xnote-ui/x-template.js
--rw-rw-rw-   0        0        0     8558 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/js/xnote-ui/x-upload.js
--rw-rw-rw-   0        0        0     3590 2023-06-30 12:24:59.000000 xnote-web-0.1.0/static/js/xnote-ui/x-url.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.160030 xnote-web-0.1.0/static/lib/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.164390 xnote-web-0.1.0/static/lib/JsBarcode/
--rw-rw-rw-   0        0        0    61195 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/JsBarcode/JsBarcode.all.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.167923 xnote-web-0.1.0/static/lib/art-template/
--rw-rw-rw-   0        0        0    17325 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/art-template/template-web-4.13.2.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.171747 xnote-web-0.1.0/static/lib/base64.js/
--rw-rw-rw-   0        0        0     2280 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/base64.js/base64.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.174943 xnote-web-0.1.0/static/lib/bootstrap/
--rw-rw-rw-   0        0        0   122544 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/bootstrap/bootstrap-3.3.5.min.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.180645 xnote-web-0.1.0/static/lib/clipboard/
--rw-rw-rw-   0        0        0    10760 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/clipboard/clipboard-2.0.4.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.187408 xnote-web-0.1.0/static/lib/codemirror/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.197745 xnote-web-0.1.0/static/lib/codemirror/5.41.0/
--rw-rw-rw-   0        0        0     5920 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/5.41.0/codemirror.min.css
--rw-rw-rw-   0        0        0   167495 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/codemirror/5.41.0/codemirror.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.204454 xnote-web-0.1.0/static/lib/codemirror/5.65.12/
--rw-rw-rw-   0        0        0     9064 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/5.65.12/codemirror.css
--rw-rw-rw-   0        0        0   411661 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/5.65.12/codemirror.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.916386 xnote-web-0.1.0/static/lib/codemirror/addon/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.214831 xnote-web-0.1.0/static/lib/codemirror/addon/dialog/
--rw-rw-rw-   0        0        0      539 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/dialog/dialog.css
--rw-rw-rw-   0        0        0     5336 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/dialog/dialog.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.247258 xnote-web-0.1.0/static/lib/codemirror/addon/hint/
--rw-rw-rw-   0        0        0     1722 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/anyword-hint.js
--rw-rw-rw-   0        0        0     2226 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/css-hint.js
--rw-rw-rw-   0        0        0    11767 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/html-hint.js
--rw-rw-rw-   0        0        0     6731 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/javascript-hint.js
--rw-rw-rw-   0        0        0      659 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/show-hint.css
--rw-rw-rw-   0        0        0    17150 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/show-hint.js
--rw-rw-rw-   0        0        0     9851 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/sql-hint.js
--rw-rw-rw-   0        0        0     4846 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/hint/xml-hint.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.258783 xnote-web-0.1.0/static/lib/codemirror/addon/search/
--rw-rw-rw-   0        0        0     2067 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/search/jump-to-line.js
--rw-rw-rw-   0        0        0    10935 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/search/search.js
--rw-rw-rw-   0        0        0    12261 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/addon/search/searchcursor.js
--rw-rw-rw-   0        0        0     5920 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/codemirror.min.css
--rw-rw-rw-   0        0        0   167495 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/codemirror/codemirror.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.264007 xnote-web-0.1.0/static/lib/codemirror/keymap/
--rw-rw-rw-   0        0        0    25979 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/keymap/sublime.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.294172 xnote-web-0.1.0/static/lib/codemirror/mode/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.298280 xnote-web-0.1.0/static/lib/codemirror/mode/clike/
--rw-rw-rw-   0        0        0    31730 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/clike/clike.js
--rw-rw-rw-   0        0        0    24791 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/codemirror/mode/css.min.js
--rw-rw-rw-   0        0        0    31934 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/javascript.js
--rw-rw-rw-   0        0        0    26408 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/markdown.js
--rw-rw-rw-   0        0        0    18501 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/php.js
--rw-rw-rw-   0        0        0     2249 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/properties.js
--rw-rw-rw-   0        0        0    12819 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/python.js
--rw-rw-rw-   0        0        0     4141 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/shell.js
--rw-rw-rw-   0        0        0    26353 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/mode/sql.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.312080 xnote-web-0.1.0/static/lib/codemirror/theme/
--rw-rw-rw-   0        0        0     1182 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/theme/eclipse.css
--rw-rw-rw-   0        0        0     1665 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/codemirror/theme/monokai.min.css
--rw-rw-rw-   0        0        0     2269 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/codemirror/theme/xq-light.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.317108 xnote-web-0.1.0/static/lib/csv.js/
--rw-rw-rw-   0        0        0    13851 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/csv.js/csv.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.324758 xnote-web-0.1.0/static/lib/d3/
--rw-rw-rw-   0        0        0   347498 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/d3/d3.js
--rw-rw-rw-   0        0        0   151729 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/d3/d3.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.329576 xnote-web-0.1.0/static/lib/exif-js/
--rw-rw-rw-   0        0        0    41513 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/exif-js/exif.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.333323 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/
--rw-rw-rw-   0        0        0      330 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/HELP-US-OUT.txt
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.340576 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/css/
--rw-rw-rw-   0        0        0    39751 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/css/font-awesome.css
--rw-rw-rw-   0        0        0    31004 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/css/font-awesome.min.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.369595 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/
--rw-rw-rw-   0        0        0   134808 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/FontAwesome.otf
--rw-rw-rw-   0        0        0   165742 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.eot
--rw-rw-rw-   0        0        0   447050 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.svg
--rw-rw-rw-   0        0        0   165548 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.ttf
--rw-rw-rw-   0        0        0    98024 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff
--rw-rw-rw-   0        0        0    77160 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff2
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.433475 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/
--rw-rw-rw-   0        0        0      747 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/animated.less
--rw-rw-rw-   0        0        0      610 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/bordered-pulled.less
--rw-rw-rw-   0        0        0      464 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/core.less
--rw-rw-rw-   0        0        0      125 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/fixed-width.less
--rw-rw-rw-   0        0        0      513 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/font-awesome.less
--rw-rw-rw-   0        0        0    50501 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/icons.less
--rw-rw-rw-   0        0        0      383 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/larger.less
--rw-rw-rw-   0        0        0      396 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/list.less
--rw-rw-rw-   0        0        0     1663 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/mixins.less
--rw-rw-rw-   0        0        0      786 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/path.less
--rw-rw-rw-   0        0        0      642 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/rotated-flipped.less
--rw-rw-rw-   0        0        0      123 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/screen-reader.less
--rw-rw-rw-   0        0        0      496 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/stacked.less
--rw-rw-rw-   0        0        0    23363 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/variables.less
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.498875 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/
--rw-rw-rw-   0        0        0      749 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_animated.scss
--rw-rw-rw-   0        0        0      617 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_bordered-pulled.scss
--rw-rw-rw-   0        0        0      471 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_core.scss
--rw-rw-rw-   0        0        0      126 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_fixed-width.scss
--rw-rw-rw-   0        0        0    51287 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_icons.scss
--rw-rw-rw-   0        0        0      388 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_larger.scss
--rw-rw-rw-   0        0        0      397 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_list.scss
--rw-rw-rw-   0        0        0     1697 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_mixins.scss
--rw-rw-rw-   0        0        0      798 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_path.scss
--rw-rw-rw-   0        0        0      692 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_rotated-flipped.scss
--rw-rw-rw-   0        0        0      139 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_screen-reader.scss
--rw-rw-rw-   0        0        0      502 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_stacked.scss
--rw-rw-rw-   0        0        0    23444 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_variables.scss
--rw-rw-rw-   0        0        0      448 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/font-awesome.scss
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.934234 xnote-web-0.1.0/static/lib/highlight.js/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.503273 xnote-web-0.1.0/static/lib/highlight.js/11.6.0/
--rw-rw-rw-   0        0        0   120388 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/lib/highlight.js/11.6.0/highlight.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.506439 xnote-web-0.1.0/static/lib/highlight.js/11.6.0/styles/
--rw-rw-rw-   0        0        0     1144 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/lib/highlight.js/11.6.0/styles/default.min.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.935270 xnote-web-0.1.0/static/lib/highlight.js/11.7.0/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.510897 xnote-web-0.1.0/static/lib/highlight.js/11.7.0/styles/
--rw-rw-rw-   0        0        0     1158 2023-10-27 13:17:40.000000 xnote-web-0.1.0/static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.936822 xnote-web-0.1.0/static/lib/jexcel/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.567309 xnote-web-0.1.0/static/lib/jexcel/2.0.2/
--rw-rw-rw-   0        0        0     8809 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jexcel.js
--rw-rw-rw-   0        0        0     2605 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jexcel.min.js
--rw-rw-rw-   0        0        0     5311 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.css
--rw-rw-rw-   0        0        0    35343 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.js
--rw-rw-rw-   0        0        0     4113 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.min.css
--rw-rw-rw-   0        0        0    13730 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.min.js
--rw-rw-rw-   0        0        0    11415 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.css
--rw-rw-rw-   0        0        0    30620 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.js
--rw-rw-rw-   0        0        0     9071 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.min.css
--rw-rw-rw-   0        0        0    11974 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.min.js
--rw-rw-rw-   0        0        0    12095 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.css
--rw-rw-rw-   0        0        0   208970 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.js
--rw-rw-rw-   0        0        0     9179 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.min.css
--rw-rw-rw-   0        0        0    74272 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.571961 xnote-web-0.1.0/static/lib/jquery/
--rw-rw-rw-   0        0        0    97168 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery/jquery-1.12.4.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.579175 xnote-web-0.1.0/static/lib/jquery-url-parser/
--rw-rw-rw-   0        0        0     9036 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery-url-parser/purl.js
--rw-rw-rw-   0        0        0     4487 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jquery-url-parser/purl.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.583646 xnote-web-0.1.0/static/lib/jquery.qrcode/
--rw-rw-rw-   0        0        0    14023 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery.qrcode/jquery.qrcode.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.597221 xnote-web-0.1.0/static/lib/jquery.terminal/
--rw-rw-rw-   0        0        0     2126 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery.terminal/dterm.js
--rw-rw-rw-   0        0        0     8268 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.css
--rw-rw-rw-   0        0        0    77663 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.600065 xnote-web-0.1.0/static/lib/jsdiff/
--rw-rw-rw-   0        0        0    32769 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jsdiff/diff.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.620632 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/
--rw-rw-rw-   0        0        0    11017 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/README.md
--rw-rw-rw-   0        0        0      647 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/WEBCOMPONENT.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.631225 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/deps/
--rw-rw-rw-   0        0        0    63460 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.css
--rw-rw-rw-   0        0        0   373913 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.646610 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/
--rw-rw-rw-   0        0        0    20709 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.css
--rw-rw-rw-   0        0        0   561932 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.js
--rw-rw-rw-   0        0        0     5435 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.theme.css
--rw-rw-rw-   0        0        0      143 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/docker-compose.yml
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.670573 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/
--rw-rw-rw-   0        0        0     1725 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/de_DE.json
--rw-rw-rw-   0        0        0     1568 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/en_GB.json
--rw-rw-rw-   0        0        0     1919 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/fr_FR.json
--rw-rw-rw-   0        0        0     1656 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/it_IT.json
--rw-rw-rw-   0        0        0     1706 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/pt_BR.json
--rw-rw-rw-   0        0        0     1444 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/zh_CN.json
--rw-rw-rw-   0        0        0     1015 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/package.json
--rw-rw-rw-   0        0        0     1709 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/webcomponent-spreadsheet.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.673714 xnote-web-0.1.0/static/lib/layDate-v5.0.9/
--rw-rw-rw-   0        0        0    27379 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/laydate.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.950856 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.678717 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.696287 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/
--rw-rw-rw-   0        0        0     2456 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.eot
--rw-rw-rw-   0        0        0     3119 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.svg
--rw-rw-rw-   0        0        0     2272 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.ttf
--rw-rw-rw-   0        0        0     1492 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.woff
--rw-rw-rw-   0        0        0     7980 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/laydate.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.703899 xnote-web-0.1.0/static/lib/layer/
--rw-rw-rw-   0        0        0    40713 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layer/layer.full.js
--rw-rw-rw-   0        0        0    22117 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layer/layer.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.712142 xnote-web-0.1.0/static/lib/layer/mobile/
--rw-rw-rw-   0        0        0     3303 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layer/mobile/layer.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.715826 xnote-web-0.1.0/static/lib/layer/mobile/need/
--rw-rw-rw-   0        0        0     5260 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/mobile/need/layer.css
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:06.959033 xnote-web-0.1.0/static/lib/layer/theme/
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.738724 xnote-web-0.1.0/static/lib/layer/theme/default/
--rw-rw-rw-   0        0        0     5911 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/icon-ext.png
--rw-rw-rw-   0        0        0    11493 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/icon.png
--rw-rw-rw-   0        0        0    14367 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/layer.css
--rw-rw-rw-   0        0        0     5793 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/loading-0.gif
--rw-rw-rw-   0        0        0      701 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/loading-1.gif
--rw-rw-rw-   0        0        0     1787 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/layer/theme/default/loading-2.gif
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.707386 xnote-web-0.1.0/static/lib/layer.mobile-v2.0/
--rw-rw-rw-   0        0        0       56 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/layer.mobile-v2.0/README.md
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.741397 xnote-web-0.1.0/static/lib/marked/
--rw-rw-rw-   0        0        0    30358 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/marked/marked.js
--rw-rw-rw-   0        0        0     6709 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/md5.js
--rw-rw-rw-   0        0        0      708 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/package-lock.json
--rw-rw-rw-   0        0        0       57 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/package.json
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.747097 xnote-web-0.1.0/static/lib/quarkjs/
--rw-rw-rw-   0        0        0    46947 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/quarkjs/quark.base-1.0.0.min.js
--rw-rw-rw-   0        0        0    15329 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/require-2.1.17.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.750787 xnote-web-0.1.0/static/lib/requirejs/
--rw-rw-rw-   0        0        0    17699 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/requirejs/require-2.3.6.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.759088 xnote-web-0.1.0/static/lib/string-format/
--rw-rw-rw-   0        0        0     3143 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/string-format/string-format.js
--rw-rw-rw-   0        0        0     2218 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/string-format/string-format.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.768184 xnote-web-0.1.0/static/lib/string.js/
--rw-rw-rw-   0        0        0    22555 2023-04-06 14:57:19.000000 xnote-web-0.1.0/static/lib/string.js/string-3.3.1.min.js
--rw-rw-rw-   0        0        0    38381 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/string.js/string.js
--rw-rw-rw-   0        0        0     1813 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/utf.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.775694 xnote-web-0.1.0/static/lib/vue/
--rw-rw-rw-   0        0        0    76673 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/vue/vue-2.2.6.min.js
--rw-rw-rw-   0        0        0   106768 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/vue/vue-2.7.9.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.780399 xnote-web-0.1.0/static/lib/wangEditor/
--rw-rw-rw-   0        0        0    66013 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/wangEditor/wangEditor-3.1.1.min.js
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.796587 xnote-web-0.1.0/static/lib/webuploader/
--rw-rw-rw-   0        0        0     1078 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/webuploader/README.md
--rw-rw-rw-   0        0        0   143099 2023-04-06 14:57:20.000000 xnote-web-0.1.0/static/lib/webuploader/Uploader.swf
--rw-rw-rw-   0        0        0      543 2023-04-06 14:57:39.000000 xnote-web-0.1.0/static/lib/webuploader/webuploader.css
--rw-rw-rw-   0        0        0    70755 2023-04-06 14:57:40.000000 xnote-web-0.1.0/static/lib/webuploader/webuploader.nolog.min.js
--rw-rw-rw-   0        0        0    21080 2023-04-06 14:57:20.000000 xnote-web-0.1.0/static/xnote.pdn
--rw-rw-rw-   0        0        0     3454 2023-04-06 14:57:20.000000 xnote-web-0.1.0/static/xnote.png
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.872131 xnote-web-0.1.0/tests/
--rw-rw-rw-   0        0        0      258 2022-05-01 06:45:23.000000 xnote-web-0.1.0/tests/__init__.py
--rw-rw-rw-   0        0        0      287 2023-10-27 13:17:40.000000 xnote-web-0.1.0/tests/a.py
--rw-rw-rw-   0        0        0     3258 2024-03-31 06:37:13.000000 xnote-web-0.1.0/tests/test_admin.py
--rw-rw-rw-   0        0        0    14637 2024-04-20 08:42:38.000000 xnote-web-0.1.0/tests/test_app.py
--rw-rw-rw-   0        0        0     6635 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_base.py
--rw-rw-rw-   0        0        0     1421 2022-05-01 07:09:21.000000 xnote-web-0.1.0/tests/test_dict.py
--rw-rw-rw-   0        0        0     1631 2023-03-04 06:34:27.000000 xnote-web-0.1.0/tests/test_exif.py
--rw-rw-rw-   0        0        0     3158 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_fs.py
--rw-rw-rw-   0        0        0    10420 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_message.py
--rw-rw-rw-   0        0        0    29005 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_note.py
--rw-rw-rw-   0        0        0     1248 2022-11-26 16:30:19.000000 xnote-web-0.1.0/tests/test_search.py
--rw-rw-rw-   0        0        0     2016 2024-04-03 17:07:22.000000 xnote-web-0.1.0/tests/test_service.py
--rw-rw-rw-   0        0        0    11261 2023-10-27 13:17:40.000000 xnote-web-0.1.0/tests/test_system_sync.py
--rw-rw-rw-   0        0        0      734 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_user.py
--rw-rw-rw-   0        0        0     5654 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_xauth.py
--rw-rw-rw-   0        0        0     1150 2021-10-01 10:27:00.000000 xnote-web-0.1.0/tests/test_xmanager.py
--rw-rw-rw-   0        0        0    15739 2024-05-02 14:09:10.000000 xnote-web-0.1.0/tests/test_xutils.py
--rw-rw-rw-   0        0        0     1999 2024-04-05 11:03:00.000000 xnote-web-0.1.0/tests/test_xutils_cache.py
--rw-rw-rw-   0        0        0    31902 2024-03-31 06:41:51.000000 xnote-web-0.1.0/tests/test_xutils_db.py
--rw-rw-rw-   0        0        0     2111 2024-04-15 15:43:16.000000 xnote-web-0.1.0/tests/test_xutils_db_hash_table.py
--rw-rw-rw-   0        0        0     9209 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_xutils_db_table.py
--rw-rw-rw-   0        0        0     3292 2024-03-16 14:56:20.000000 xnote-web-0.1.0/tests/test_xutils_sqldb.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.876837 xnote-web-0.1.0/xnote/
--rw-rw-rw-   0        0        0       40 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/__init__.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.927417 xnote-web-0.1.0/xnote/core/
--rw-rw-rw-   0        0        0     1952 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/__init__.py
--rw-rw-rw-   0        0        0     3874 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/core/autoreload.py
--rw-rw-rw-   0        0        0    27122 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/core/xauth.py
--rw-rw-rw-   0        0        0    29928 2024-05-03 04:08:17.000000 xnote-web-0.1.0/xnote/core/xconfig.py
--rw-rw-rw-   0        0        0    29243 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/core/xmanager.py
--rw-rw-rw-   0        0        0      155 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/xmanager_log.py
--rw-rw-rw-   0        0        0    12899 2024-04-21 03:01:03.000000 xnote-web-0.1.0/xnote/core/xnote_app.py
--rw-rw-rw-   0        0        0     5371 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/core/xnote_code_builder.py
--rw-rw-rw-   0        0        0      422 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/xnote_event.py
--rw-rw-rw-   0        0        0      919 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/xnote_hooks.py
--rw-rw-rw-   0        0        0      887 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/xnote_trace.py
--rw-rw-rw-   0        0        0     1467 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote/core/xnote_user_config.py
--rw-rw-rw-   0        0        0    26293 2024-04-05 04:04:25.000000 xnote-web-0.1.0/xnote/core/xtables.py
--rw-rw-rw-   0        0        0     7100 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/core/xtables_kv.py
--rw-rw-rw-   0        0        0    17841 2024-03-31 13:37:06.000000 xnote-web-0.1.0/xnote/core/xtemplate.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.947885 xnote-web-0.1.0/xnote/plugin/
--rw-rw-rw-   0        0        0       66 2024-03-31 03:18:38.000000 xnote-web-0.1.0/xnote/plugin/__init__.py
--rw-rw-rw-   0        0        0     1881 2024-03-31 03:15:40.000000 xnote-web-0.1.0/xnote/plugin/component.py
--rw-rw-rw-   0        0        0     2327 2024-04-13 12:08:25.000000 xnote-web-0.1.0/xnote/plugin/form.py
--rw-rw-rw-   0        0        0     7261 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/plugin/plugin.py
--rw-rw-rw-   0        0        0     3135 2024-04-21 11:15:41.000000 xnote-web-0.1.0/xnote/plugin/table.py
--rw-rw-rw-   0        0        0     3591 2024-04-13 12:11:10.000000 xnote-web-0.1.0/xnote/plugin/table_plugin.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:10.963890 xnote-web-0.1.0/xnote/service/
--rw-rw-rw-   0        0        0      409 2024-04-03 16:02:24.000000 xnote-web-0.1.0/xnote/service/__init__.py
--rw-rw-rw-   0        0        0     2196 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/service/comment_service.py
--rw-rw-rw-   0        0        0     3665 2024-04-03 15:59:03.000000 xnote-web-0.1.0/xnote/service/job_service.py
--rw-rw-rw-   0        0        0     3255 2024-04-03 17:01:19.000000 xnote-web-0.1.0/xnote/service/lock_service.py
--rw-rw-rw-   0        0        0     3117 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote/service/tag_service.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.115063 xnote-web-0.1.0/xnote_migrate/
--rw-rw-rw-   0        0        0      887 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/__init__.py
--rw-rw-rw-   0        0        0     3007 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/base.py
--rw-rw-rw-   0        0        0      473 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_000.py
--rw-rw-rw-   0        0        0     1314 2023-11-05 02:18:54.000000 xnote-web-0.1.0/xnote_migrate/upgrade_001.py
--rw-rw-rw-   0        0        0     1359 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_002.py
--rw-rw-rw-   0        0        0     2341 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_003.py
--rw-rw-rw-   0        0        0      661 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_004.py
--rw-rw-rw-   0        0        0      826 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_005.py
--rw-rw-rw-   0        0        0      472 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_006.py
--rw-rw-rw-   0        0        0      729 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_007.py
--rw-rw-rw-   0        0        0      459 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_008.py
--rw-rw-rw-   0        0        0      994 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_009.py
--rw-rw-rw-   0        0        0     1321 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_010.py
--rw-rw-rw-   0        0        0     1413 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_011.py
--rw-rw-rw-   0        0        0     2974 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_012.py
--rw-rw-rw-   0        0        0      604 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_013.py
--rw-rw-rw-   0        0        0      922 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_014.py
--rw-rw-rw-   0        0        0     2595 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_015.py
--rw-rw-rw-   0        0        0     2292 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xnote_migrate/upgrade_016.py
--rw-rw-rw-   0        0        0    11779 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xnote_migrate/upgrade_017.py
--rw-rw-rw-   0        0        0     7433 2024-04-05 10:58:27.000000 xnote-web-0.1.0/xnote_migrate/upgrade_018.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.132260 xnote-web-0.1.0/xnote_web.egg-info/
--rw-rw-rw-   0        0        0     5759 2024-05-03 04:09:04.000000 xnote-web-0.1.0/xnote_web.egg-info/PKG-INFO
--rw-rw-rw-   0        0        0    35173 2024-05-03 04:09:06.000000 xnote-web-0.1.0/xnote_web.egg-info/SOURCES.txt
--rw-rw-rw-   0        0        0        1 2024-05-03 04:09:05.000000 xnote-web-0.1.0/xnote_web.egg-info/dependency_links.txt
--rw-rw-rw-   0        0        0       60 2024-05-03 04:09:05.000000 xnote-web-0.1.0/xnote_web.egg-info/top_level.txt
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.230408 xnote-web-0.1.0/xutils/
--rw-rw-rw-   0        0        0     9355 2024-05-02 13:42:29.000000 xnote-web-0.1.0/xutils/__init__.py
--rw-rw-rw-   0        0        0     1799 2024-04-05 11:12:15.000000 xnote-web-0.1.0/xutils/base.py
--rw-rw-rw-   0        0        0    23004 2024-04-12 15:08:43.000000 xnote-web-0.1.0/xutils/cacheutil.py
--rw-rw-rw-   0        0        0      274 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/csvutil.py
--rw-rw-rw-   0        0        0    10684 2024-04-27 04:44:35.000000 xnote-web-0.1.0/xutils/dateutil.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.388116 xnote-web-0.1.0/xutils/db/
--rw-rw-rw-   0        0        0      128 2022-03-19 02:03:55.000000 xnote-web-0.1.0/xutils/db/__init__.py
--rw-rw-rw-   0        0        0     6574 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/binlog.py
--rw-rw-rw-   0        0        0    27014 2024-04-20 08:17:52.000000 xnote-web-0.1.0/xutils/db/dbutil_base.py
--rw-rw-rw-   0        0        0     3699 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/dbutil_cache.py
--rw-rw-rw-   0        0        0     4774 2023-06-30 12:24:59.000000 xnote-web-0.1.0/xutils/db/dbutil_deque.py
--rw-rw-rw-   0        0        0     7165 2024-04-13 13:46:10.000000 xnote-web-0.1.0/xutils/db/dbutil_hash.py
--rw-rw-rw-   0        0        0      697 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/dbutil_helper.py
--rw-rw-rw-   0        0        0     4006 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/db/dbutil_id_gen.py
--rw-rw-rw-   0        0        0     2692 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/dbutil_set.py
--rw-rw-rw-   0        0        0     8502 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/dbutil_sortedset.py
--rw-rw-rw-   0        0        0    30513 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/db/dbutil_table.py
--rw-rw-rw-   0        0        0    11927 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/db/dbutil_table_index.py
--rw-rw-rw-   0        0        0    13903 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/db/dbutil_table_v2.py
--rw-rw-rw-   0        0        0     1941 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_leveldb.py
--rw-rw-rw-   0        0        0     4696 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_leveldbpy.py
--rw-rw-rw-   0        0        0     9596 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_lmdb.py
--rw-rw-rw-   0        0        0    17289 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/db/driver_mysql.py
--rw-rw-rw-   0        0        0     3280 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_mysql_enhance.py
--rw-rw-rw-   0        0        0    11514 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_sqlite.py
--rw-rw-rw-   0        0        0     4064 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/driver_ssdb.py
--rw-rw-rw-   0        0        0     7816 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/encode.py
--rw-rw-rw-   0        0        0     2374 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/db/filters.py
--rw-rw-rw-   0        0        0     2690 2023-04-06 04:04:41.000000 xnote-web-0.1.0/xutils/db/lock.py
--rw-rw-rw-   0        0        0     4615 2022-05-17 15:05:38.000000 xnote-web-0.1.0/xutils/db/shard.py
--rw-rw-rw-   0        0        0     1908 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/dbutil.py
--rw-rw-rw-   0        0        0     9214 2023-11-11 11:01:44.000000 xnote-web-0.1.0/xutils/exeutil.py
--rw-rw-rw-   0        0        0    23736 2024-05-03 04:01:25.000000 xnote-web-0.1.0/xutils/fsutil.py
--rw-rw-rw-   0        0        0     1837 2022-01-25 14:37:52.000000 xnote-web-0.1.0/xutils/func_util.py
--rw-rw-rw-   0        0        0     9109 2024-04-27 04:46:04.000000 xnote-web-0.1.0/xutils/functions.py
--rw-rw-rw-   0        0        0     1080 2021-10-01 10:27:00.000000 xnote-web-0.1.0/xutils/htmlutil.py
--rw-rw-rw-   0        0        0     4008 2024-04-05 10:56:40.000000 xnote-web-0.1.0/xutils/imports.py
--rw-rw-rw-   0        0        0     7853 2024-04-20 12:48:58.000000 xnote-web-0.1.0/xutils/interfaces.py
--rw-rw-rw-   0        0        0      896 2024-05-01 16:02:36.000000 xnote-web-0.1.0/xutils/jsonutil.py
--rw-rw-rw-   0        0        0      317 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/lists.py
--rw-rw-rw-   0        0        0     2410 2024-04-20 13:08:53.000000 xnote-web-0.1.0/xutils/lockutil.py
--rw-rw-rw-   0        0        0    11834 2023-06-30 12:24:59.000000 xnote-web-0.1.0/xutils/logutil.py
--rw-rw-rw-   0        0        0     3426 2023-04-16 02:40:02.000000 xnote-web-0.1.0/xutils/mem_util.py
--rw-rw-rw-   0        0        0    10953 2023-12-02 11:46:25.000000 xnote-web-0.1.0/xutils/netutil.py
--rw-rw-rw-   0        0        0      216 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/numutil.py
--rw-rw-rw-   0        0        0    30698 2023-03-04 06:34:27.000000 xnote-web-0.1.0/xutils/six.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.405963 xnote-web-0.1.0/xutils/sqldb/
--rw-rw-rw-   0        0        0      382 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/sqldb/__init__.py
--rw-rw-rw-   0        0        0      728 2024-04-05 04:05:21.000000 xnote-web-0.1.0/xutils/sqldb/table_config.py
--rw-rw-rw-   0        0        0    13227 2024-04-05 04:46:39.000000 xnote-web-0.1.0/xutils/sqldb/table_manager.py
--rw-rw-rw-   0        0        0    10228 2024-04-21 14:00:24.000000 xnote-web-0.1.0/xutils/sqldb/table_proxy.py
--rw-rw-rw-   0        0        0      450 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/sqldb/utils.py
--rw-rw-rw-   0        0        0    18969 2024-05-03 04:05:40.000000 xnote-web-0.1.0/xutils/text_parser.py
--rw-rw-rw-   0        0        0     2741 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/text_parser_properties.py
--rw-rw-rw-   0        0        0    23168 2024-04-04 03:39:24.000000 xnote-web-0.1.0/xutils/textutil.py
--rw-rw-rw-   0        0        0      651 2023-03-04 06:34:27.000000 xnote-web-0.1.0/xutils/textutil_url.py
--rw-rw-rw-   0        0        0     7496 2023-01-22 10:01:14.000000 xnote-web-0.1.0/xutils/tokenizer.py
-drwxrwxrwx   0        0        0        0 2024-05-03 04:09:11.422935 xnote-web-0.1.0/xutils/tornado/
--rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/tornado/__init__.py
--rw-rw-rw-   0        0        0    14538 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/tornado/escape.py
--rw-rw-rw-   0        0        0    10906 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/tornado/log.py
--rw-rw-rw-   0        0        0    37310 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/tornado/template.py
--rw-rw-rw-   0        0        0    13605 2023-10-27 13:17:40.000000 xnote-web-0.1.0/xutils/tornado/util.py
--rw-rw-rw-   0        0        0     8287 2024-03-16 14:56:20.000000 xnote-web-0.1.0/xutils/webutil.py
--rw-rw-rw-   0        0        0     2394 2024-04-29 17:03:11.000000 xnote-web-0.1.0/xutils/ziputil.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:29.106861 xnote-web-0.1.1/
+-rw-rw-rw-   0        0        0    35147 2021-10-01 10:27:00.000000 xnote-web-0.1.1/COPYING
+-rw-rw-rw-   0        0        0      259 2023-10-27 13:17:40.000000 xnote-web-0.1.1/MANIFEST.in
+-rw-rw-rw-   0        0        0     5759 2024-06-01 04:52:29.104859 xnote-web-0.1.1/PKG-INFO
+-rw-rw-rw-   0        0        0     5280 2024-05-18 14:13:46.000000 xnote-web-0.1.1/README.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.024862 xnote-web-0.1.1/config/
+-rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.1/config/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.067639 xnote-web-0.1.1/config/boot/
+-rw-rw-rw-   0        0        0     3504 2024-05-18 14:13:46.000000 xnote-web-0.1.1/config/boot/boot.default.properties
+-rw-rw-rw-   0        0        0      413 2022-05-29 13:03:06.000000 xnote-web-0.1.1/config/boot/boot.local.follower.properties
+-rw-rw-rw-   0        0        0      612 2022-10-06 02:04:52.000000 xnote-web-0.1.1/config/boot/boot.local.leveldb.properties
+-rw-rw-rw-   0        0        0       98 2024-04-20 13:28:50.000000 xnote-web-0.1.1/config/boot/boot.local.mem.properties
+-rw-rw-rw-   0        0        0      792 2024-04-20 13:35:54.000000 xnote-web-0.1.1/config/boot/boot.local.properties
+-rw-rw-rw-   0        0        0      116 2023-04-06 04:04:41.000000 xnote-web-0.1.1/config/boot/boot.min.properties
+-rw-rw-rw-   0        0        0      552 2024-05-18 14:13:46.000000 xnote-web-0.1.1/config/boot/boot.sae.properties
+-rw-rw-rw-   0        0        0      113 2022-08-14 10:12:12.000000 xnote-web-0.1.1/config/boot/boot.sqlite.properties
+-rw-rw-rw-   0        0        0      186 2024-05-18 14:13:46.000000 xnote-web-0.1.1/config/boot/boot.test.properties
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.071216 xnote-web-0.1.1/config/cron/
+-rw-rw-rw-   0        0        0     1572 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/cron/cron.json
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.100731 xnote-web-0.1.1/config/file/
+-rw-rw-rw-   0        0        0       20 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/file/audio.properties
+-rw-rw-rw-   0        0        0      142 2023-03-04 06:34:27.000000 xnote-web-0.1.1/config/file/code.properties
+-rw-rw-rw-   0        0        0      181 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/file/image.properties
+-rw-rw-rw-   0        0        0      448 2022-04-17 03:52:32.000000 xnote-web-0.1.1/config/file/mime-types.properties
+-rw-rw-rw-   0        0        0      298 2023-10-27 13:17:40.000000 xnote-web-0.1.1/config/file/preview.properties
+-rw-rw-rw-   0        0        0      580 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/file/text.properties
+-rw-rw-rw-   0        0        0       35 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/file/video.properties
+-rw-rw-rw-   0        0        0       27 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/file/zip.properties
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.107241 xnote-web-0.1.1/config/lang/
+-rw-rw-rw-   0        0        0      794 2022-03-19 10:57:33.000000 xnote-web-0.1.1/config/lang/en.properties
+-rw-rw-rw-   0        0        0     2259 2023-07-16 02:37:42.000000 xnote-web-0.1.1/config/lang/zh.properties
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.117783 xnote-web-0.1.1/config/note/
+-rw-rw-rw-   0        0        0      231 2022-07-15 15:16:19.000000 xnote-web-0.1.1/config/note/category.ddc.properties
+-rw-rw-rw-   0        0        0      135 2022-07-15 16:06:41.000000 xnote-web-0.1.1/config/note/category.properties
+-rw-rw-rw-   0        0        0      857 2022-11-26 16:30:19.000000 xnote-web-0.1.1/config/note/smart_group.ini
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.127432 xnote-web-0.1.1/config/plugin/
+-rw-rw-rw-   0        0        0     6492 2024-05-18 14:13:46.000000 xnote-web-0.1.1/config/plugin/form_plugin.tpl.py
+-rw-rw-rw-   0        0        0      752 2024-05-18 14:13:46.000000 xnote-web-0.1.1/config/plugin/plugin.tpl.py
+-rw-rw-rw-   0        0        0      179 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/plugin/plugins.ini
+-rw-rw-rw-   0        0        0      141 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/requirements.full.txt
+-rw-rw-rw-   0        0        0       12 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/requirements.min.txt
+-rw-rw-rw-   0        0        0       25 2023-10-27 13:17:40.000000 xnote-web-0.1.1/config/requirements.mysql.txt
+-rw-rw-rw-   0        0        0       88 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/requirements.test.txt
+-rw-rw-rw-   0        0        0      127 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/requirements.txt
+-rw-rw-rw-   0        0        0      126 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/requirements.win.txt
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.138104 xnote-web-0.1.1/config/user/
+-rw-rw-rw-   0        0        0       76 2021-10-01 10:27:00.000000 xnote-web-0.1.1/config/user/invalid_names.list
+-rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.1/config/user/user_config.default.properties
+-rw-rw-rw-   0        0        0       21 2024-06-01 04:48:38.000000 xnote-web-0.1.1/config/version.txt
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.171070 xnote-web-0.1.1/docs/
+-rw-rw-rw-   0        0        0     2792 2022-11-26 16:30:19.000000 xnote-web-0.1.1/docs/architecture.md
+-rw-rw-rw-   0        0        0    18874 2024-05-18 14:13:46.000000 xnote-web-0.1.1/docs/changelog.md
+-rw-rw-rw-   0        0        0     3008 2022-05-28 11:20:41.000000 xnote-web-0.1.1/docs/code_style.md
+-rw-rw-rw-   0        0        0      567 2022-03-13 14:33:54.000000 xnote-web-0.1.1/docs/code_style_css.md
+-rw-rw-rw-   0        0        0     2257 2022-11-26 16:30:19.000000 xnote-web-0.1.1/docs/commands.md
+-rw-rw-rw-   0        0        0     3025 2023-10-27 13:17:40.000000 xnote-web-0.1.1/docs/database.md
+-rw-rw-rw-   0        0        0     1799 2023-10-27 13:17:40.000000 xnote-web-0.1.1/docs/db_migrate.md
+-rw-rw-rw-   0        0        0     1364 2022-11-26 16:30:19.000000 xnote-web-0.1.1/docs/plugins.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.329161 xnote-web-0.1.1/docs/screenshots/
+-rw-rw-rw-   0        0        0    43384 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/architecture.png
+-rw-rw-rw-   0        0        0    13063 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/architecture.svg
+-rw-rw-rw-   0        0        0    57359 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/architecture_2.png
+-rw-rw-rw-   0        0        0   112396 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/command_listdir.png
+-rw-rw-rw-   0        0        0    81824 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/command_rmfolder.png
+-rw-rw-rw-   0        0        0   139528 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/screenshot01.png
+-rw-rw-rw-   0        0        0   236777 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/screenshot02.png
+-rw-rw-rw-   0        0        0   101099 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/screenshot03.png
+-rw-rw-rw-   0        0        0    24412 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/task_web.PNG
+-rw-rw-rw-   0        0        0    29284 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.2_editor.PNG
+-rw-rw-rw-   0        0        0    43162 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.2_list.PNG
+-rw-rw-rw-   0        0        0   225642 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.2_mobile.png
+-rw-rw-rw-   0        0        0    23527 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.2_search.png
+-rw-rw-rw-   0        0        0    54676 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.3_desktop01.png
+-rw-rw-rw-   0        0        0   153849 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.4.png
+-rw-rw-rw-   0        0        0   235750 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v1.5.png
+-rw-rw-rw-   0        0        0   214791 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.0.png
+-rw-rw-rw-   0        0        0   187105 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.1_home.png
+-rw-rw-rw-   0        0        0   202760 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.2_20190331.png
+-rw-rw-rw-   0        0        0   179408 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.3_20190411.png
+-rw-rw-rw-   0        0        0   214443 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.3_home.png
+-rw-rw-rw-   0        0        0    99255 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.4_home.png
+-rw-rw-rw-   0        0        0   103529 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.4_home2.png
+-rw-rw-rw-   0        0        0    82664 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.5_20200502.png
+-rw-rw-rw-   0        0        0   121009 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.5_home.png
+-rw-rw-rw-   0        0        0    78846 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.5_recent.png
+-rw-rw-rw-   0        0        0    66479 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.6_home.png
+-rw-rw-rw-   0        0        0   107994 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.7_home.png
+-rw-rw-rw-   0        0        0    88658 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.8_home.png
+-rw-rw-rw-   0        0        0   120643 2022-11-26 16:30:19.000000 xnote-web-0.1.1/docs/screenshots/xnote_v2.9.2_home.png
+-rw-rw-rw-   0        0        0   110782 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote_v20191111.png
+-rw-rw-rw-   0        0        0   158216 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/screenshots/xnote架构.png
+-rw-rw-rw-   0        0        0       16 2021-10-01 10:27:00.000000 xnote-web-0.1.1/docs/search_extension.md
+-rw-rw-rw-   0        0        0      441 2024-05-18 14:13:46.000000 xnote-web-0.1.1/docs/upload_to_pip.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.368840 xnote-web-0.1.1/handlers/
+-rw-rw-rw-   0        0        0       26 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.378935 xnote-web-0.1.1/handlers/admin/
+-rw-rw-rw-   0        0        0        0 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/admin/__init__.py
+-rw-rw-rw-   0        0        0     1379 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/admin/func_admin.py
+-rw-rw-rw-   0        0        0     5587 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/admin/job_admin.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.438519 xnote-web-0.1.1/handlers/api/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/__init__.py
+-rw-rw-rw-   0        0        0      705 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/alarm.py
+-rw-rw-rw-   0        0        0      727 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/check_network.py
+-rw-rw-rw-   0        0        0     1249 2023-03-11 14:27:18.000000 xnote-web-0.1.1/handlers/api/getip.py
+-rw-rw-rw-   0        0        0      365 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/http_headers.py
+-rw-rw-rw-   0        0        0     1466 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/ipv6.py
+-rw-rw-rw-   0        0        0     3563 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/readbook.py
+-rw-rw-rw-   0        0        0     1020 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/report_time.py
+-rw-rw-rw-   0        0        0     1986 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/api/report_weather.py
+-rw-rw-rw-   0        0        0      604 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/api/tts.py
+-rw-rw-rw-   0        0        0       30 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/base.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.495963 xnote-web-0.1.1/handlers/code/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/code/__init__.py
+-rw-rw-rw-   0        0        0     7525 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/code/code_edit.html
+-rw-rw-rw-   0        0        0     4717 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/code/code_edit.py
+-rw-rw-rw-   0        0        0     2573 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/code/code_lines.html
+-rw-rw-rw-   0        0        0     6066 2022-04-30 02:31:41.000000 xnote-web-0.1.1/handlers/code/code_lines.py
+-rw-rw-rw-   0        0        0     3278 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/code/code_search.html
+-rw-rw-rw-   0        0        0     8351 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/code/code_search.py
+-rw-rw-rw-   0        0        0     2480 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/code/preview.html
+-rw-rw-rw-   0        0        0     5659 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/code/preview.py
+-rw-rw-rw-   0        0        0     5912 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/code/wiki_edit.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.608948 xnote-web-0.1.1/handlers/common/
+-rw-rw-rw-   0        0        0      472 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/README.md
+-rw-rw-rw-   0        0        0      121 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/back.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.619618 xnote-web-0.1.1/handlers/common/base/
+-rw-rw-rw-   0        0        0      410 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/base/README.md
+-rw-rw-rw-   0        0        0     1358 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/base/pagination.html
+-rw-rw-rw-   0        0        0     2156 2023-11-19 08:31:53.000000 xnote-web-0.1.1/handlers/common/base.html
+-rw-rw-rw-   0        0        0       79 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/base_bottom.html
+-rw-rw-rw-   0        0        0      927 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/base_footer.html
+-rw-rw-rw-   0        0        0     2356 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/base_head.html
+-rw-rw-rw-   0        0        0      952 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/base_nav.html
+-rw-rw-rw-   0        0        0      185 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/base_simple.html
+-rw-rw-rw-   0        0        0      645 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/base_title.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.624629 xnote-web-0.1.1/handlers/common/button/
+-rw-rw-rw-   0        0        0      149 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/button/back_button.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.627851 xnote-web-0.1.1/handlers/common/date/
+-rw-rw-rw-   0        0        0     2820 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/common/date/month_picker.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.638028 xnote-web-0.1.1/handlers/common/form/
+-rw-rw-rw-   0        0        0     3384 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/form/form.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.647665 xnote-web-0.1.1/handlers/common/hook/
+-rw-rw-rw-   0        0        0      137 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/hook/message_search_btn_hook.html
+-rw-rw-rw-   0        0        0      526 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/hook/search_box_hook.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.676404 xnote-web-0.1.1/handlers/common/layout/
+-rw-rw-rw-   0        0        0     3713 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/layout/base_layout.html
+-rw-rw-rw-   0        0        0       67 2023-04-06 10:45:42.000000 xnote-web-0.1.1/handlers/common/layout/wide_left.html
+-rw-rw-rw-   0        0        0      702 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/mod_notice.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.788913 xnote-web-0.1.1/handlers/common/nav/
+-rw-rw-rw-   0        0        0     2809 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/nav/base_nav_left.html
+-rw-rw-rw-   0        0        0     1374 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/nav/base_nav_project.html
+-rw-rw-rw-   0        0        0      654 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/nav/base_nav_top.html
+-rw-rw-rw-   0        0        0      799 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/nav/content_nav.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.793942 xnote-web-0.1.1/handlers/common/page/
+-rw-rw-rw-   0        0        0      497 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/page/notfound.html
+-rw-rw-rw-   0        0        0     1358 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/pagination.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.871586 xnote-web-0.1.1/handlers/common/script/
+-rw-rw-rw-   0        0        0     1251 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/common/script/adjust.html
+-rw-rw-rw-   0        0        0      420 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/script/debug_script.html
+-rw-rw-rw-   0        0        0      965 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/script/geo_location.html
+-rw-rw-rw-   0        0        0      460 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/common/script/image_fix_1.html
+-rw-rw-rw-   0        0        0     4529 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/common/script/image_fix_2.html
+-rw-rw-rw-   0        0        0      455 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/common/script/load_vue.html
+-rw-rw-rw-   0        0        0      764 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/common/script/require_init.html
+-rw-rw-rw-   0        0        0      246 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/script/safe_script.html
+-rw-rw-rw-   0        0        0     3234 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/common/script/textarea_script.html
+-rw-rw-rw-   0        0        0      452 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/script/translate_script.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.881131 xnote-web-0.1.1/handlers/common/search/
+-rw-rw-rw-   0        0        0      758 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/search/search_box.html
+-rw-rw-rw-   0        0        0      750 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/search/search_mobile.html
+-rw-rw-rw-   0        0        0       43 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/search_box.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.892657 xnote-web-0.1.1/handlers/common/sidebar/
+-rw-rw-rw-   0        0        0      724 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/sidebar/app_index.html
+-rw-rw-rw-   0        0        0       43 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/sidebar/default.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.897718 xnote-web-0.1.1/handlers/common/table/
+-rw-rw-rw-   0        0        0     3493 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/common/table/table.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.903326 xnote-web-0.1.1/handlers/common/text/
+-rw-rw-rw-   0        0        0       41 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/common/text/empty_text.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.910966 xnote-web-0.1.1/handlers/common/theme/
+-rw-rw-rw-   0        0        0     2331 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/common/theme/sidebar.html
+-rw-rw-rw-   0        0        0     1683 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/common/theme/sidebar_left.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.917009 xnote-web-0.1.1/handlers/common/title/
+-rw-rw-rw-   0        0        0      273 2021-10-31 03:54:18.000000 xnote-web-0.1.1/handlers/common/title/base_title.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.928998 xnote-web-0.1.1/handlers/cron/
+-rw-rw-rw-   0        0        0      142 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/cron/__init__.py
+-rw-rw-rw-   0        0        0      999 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/cron/cron_stats.py
+-rw-rw-rw-   0        0        0     3344 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/cron/diskclean.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.951556 xnote-web-0.1.1/handlers/dict/
+-rw-rw-rw-   0        0        0      136 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/dict/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.954557 xnote-web-0.1.1/handlers/dict/component/
+-rw-rw-rw-   0        0        0      798 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/dict/component/dict_sidebar.html
+-rw-rw-rw-   0        0        0     2483 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/dict/dao_relevant.py
+-rw-rw-rw-   0        0        0     5323 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/dict/dict.py
+-rw-rw-rw-   0        0        0     2520 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/dict/dict_dao.py
+-rw-rw-rw-   0        0        0     2000 2022-05-21 15:50:36.000000 xnote-web-0.1.1/handlers/dict/dict_relevant.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:23.982320 xnote-web-0.1.1/handlers/dict/page/
+-rw-rw-rw-   0        0        0     1899 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/dict/page/dict_add.html
+-rw-rw-rw-   0        0        0     1255 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/dict/page/dict_edit.html
+-rw-rw-rw-   0        0        0     1305 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/dict/page/dict_list.html
+-rw-rw-rw-   0        0        0     2650 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/dict/page/dict_update.html
+-rw-rw-rw-   0        0        0     3767 2022-05-15 04:37:11.000000 xnote-web-0.1.1/handlers/dict/page/relevant_list.html
+-rw-rw-rw-   0        0        0      562 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/error.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.069020 xnote-web-0.1.1/handlers/fs/
+-rw-rw-rw-   0        0        0      142 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.108334 xnote-web-0.1.1/handlers/fs/component/
+-rw-rw-rw-   0        0        0     2927 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/component/clipboard-dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.111877 xnote-web-0.1.1/handlers/fs/component/css/
+-rw-rw-rw-   0        0        0      103 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/fs/component/css/fs_css.html
+-rw-rw-rw-   0        0        0     1471 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/filelist_gallery.html
+-rw-rw-rw-   0        0        0     1174 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/filelist_simple.html
+-rw-rw-rw-   0        0        0      862 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/fs_sidebar.html
+-rw-rw-rw-   0        0        0      408 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/component/fs_title.html
+-rw-rw-rw-   0        0        0     3964 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/move_file_dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.123625 xnote-web-0.1.1/handlers/fs/component/options/
+-rw-rw-rw-   0        0        0      673 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/fs/component/options/fs_options.html
+-rw-rw-rw-   0        0        0     3157 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/options/fs_options_buttons.html
+-rw-rw-rw-   0        0        0     2051 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/options/fs_options_buttons.mobile.html
+-rw-rw-rw-   0        0        0     2942 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/fs/component/options_css.html
+-rw-rw-rw-   0        0        0     1910 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/component/plugins-dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.126772 xnote-web-0.1.1/handlers/fs/component/script/
+-rw-rw-rw-   0        0        0    13532 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/component/script/file_op_script.html
+-rw-rw-rw-   0        0        0    23591 2024-05-19 03:51:38.000000 xnote-web-0.1.1/handlers/fs/fs.py
+-rw-rw-rw-   0        0        0     2642 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/fs_add.py
+-rw-rw-rw-   0        0        0     2596 2024-05-19 09:20:45.000000 xnote-web-0.1.1/handlers/fs/fs_api.py
+-rw-rw-rw-   0        0        0     1862 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/fs/fs_cache.py
+-rw-rw-rw-   0        0        0      752 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_checker.py
+-rw-rw-rw-   0        0        0     2704 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_find.py
+-rw-rw-rw-   0        0        0     6565 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_helper.py
+-rw-rw-rw-   0        0        0     4430 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_hex.py
+-rw-rw-rw-   0        0        0     2428 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/fs_image.py
+-rw-rw-rw-   0        0        0     6807 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_index.py
+-rw-rw-rw-   0        0        0     1004 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/fs/fs_mode.py
+-rw-rw-rw-   0        0        0     4700 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/fs_plugins.py
+-rw-rw-rw-   0        0        0     3740 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_preview.py
+-rw-rw-rw-   0        0        0     5236 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_text.py
+-rw-rw-rw-   0        0        0    14892 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/fs_upload.py
+-rw-rw-rw-   0        0        0     1902 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/mod_aside.html
+-rw-rw-rw-   0        0        0     6622 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/mod_fs_upload.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.178125 xnote-web-0.1.1/handlers/fs/page/
+-rw-rw-rw-   0        0        0     2187 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/page/fs.html
+-rw-rw-rw-   0        0        0     1355 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/page/fs_bookmark.html
+-rw-rw-rw-   0        0        0     3165 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/fs/page/fs_grid.html
+-rw-rw-rw-   0        0        0     2669 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/page/fs_index.html
+-rw-rw-rw-   0        0        0      352 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/page/fs_not_readable.html
+-rw-rw-rw-   0        0        0     2540 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/page/fs_plugins.html
+-rw-rw-rw-   0        0        0     1788 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/fs/page/fs_shell.html
+-rw-rw-rw-   0        0        0     4442 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/fs/page/fs_sidebar.html
+-rw-rw-rw-   0        0        0     5422 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/fs/page/fs_text.html
+-rw-rw-rw-   0        0        0     4920 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/fs/page/fs_text_v1.html
+-rw-rw-rw-   0        0        0     3078 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/fs/page/fs_upload.html
+-rw-rw-rw-   0        0        0     2093 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/index.html
+-rw-rw-rw-   0        0        0     1450 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/index.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.218057 xnote-web-0.1.1/handlers/message/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/message/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.229359 xnote-web-0.1.1/handlers/message/ajax/
+-rw-rw-rw-   0        0        0     4497 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/ajax/message_ajax.html
+-rw-rw-rw-   0        0        0     2711 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/message/ajax/message_tag_ajax.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.278070 xnote-web-0.1.1/handlers/message/card/
+-rw-rw-rw-   0        0        0    17381 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/card/deleted_msg_left.html
+-rw-rw-rw-   0        0        0     4712 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/message/card/deleted_msg_left_new.html
+-rw-rw-rw-   0        0        0      585 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/message/card/deleted_msg_right.html
+-rw-rw-rw-   0        0        0     1374 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/card/message_system_tag.html
+-rw-rw-rw-   0        0        0     1429 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/message/card/msg_edit_card.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.441017 xnote-web-0.1.1/handlers/message/component/
+-rw-rw-rw-   0        0        0      977 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/message_date_right.html
+-rw-rw-rw-   0        0        0     3782 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/component/message_edit.html
+-rw-rw-rw-   0        0        0      787 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/message/component/message_event.html
+-rw-rw-rw-   0        0        0      415 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/message/component/message_header.html
+-rw-rw-rw-   0        0        0     2785 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/component/message_input.html
+-rw-rw-rw-   0        0        0     1230 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/component/message_keyword_info.html
+-rw-rw-rw-   0        0        0     1988 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/component/message_list.html
+-rw-rw-rw-   0        0        0     1956 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/message_sub_link.html
+-rw-rw-rw-   0        0        0     1181 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/message_tab.html
+-rw-rw-rw-   0        0        0      801 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/component/message_tab_log.html
+-rw-rw-rw-   0        0        0      833 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/message_tab_task.html
+-rw-rw-rw-   0        0        0      646 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/component/message_tag_list.html
+-rw-rw-rw-   0        0        0      977 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/component/message_title.html
+-rw-rw-rw-   0        0        0     3343 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/message_todo_inner.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.448121 xnote-web-0.1.1/handlers/message/component/right/
+-rw-rw-rw-   0        0        0     1169 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/component/right/tags.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.458237 xnote-web-0.1.1/handlers/message/component/script/
+-rw-rw-rw-   0        0        0     1009 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/message/component/script/tab_script.html
+-rw-rw-rw-   0        0        0     1939 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/component/select_topic_dialog.html
+-rw-rw-rw-   0        0        0      765 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/message/component/show_topic_dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.463568 xnote-web-0.1.1/handlers/message/component/tag/
+-rw-rw-rw-   0        0        0      861 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/component/tag/orderby_tab.html
+-rw-rw-rw-   0        0        0    32286 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/dao.py
+-rw-rw-rw-   0        0        0    34333 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message.py
+-rw-rw-rw-   0        0        0      866 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message_model.py
+-rw-rw-rw-   0        0        0     3529 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message_search.py
+-rw-rw-rw-   0        0        0     2964 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message_tag.py
+-rw-rw-rw-   0        0        0     2570 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message_task.py
+-rw-rw-rw-   0        0        0    16500 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/message_utils.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.529076 xnote-web-0.1.1/handlers/message/page/
+-rw-rw-rw-   0        0        0     1064 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/message/page/message.html
+-rw-rw-rw-   0        0        0     2150 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/page/message_calendar.html
+-rw-rw-rw-   0        0        0     2144 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/page/message_list_by_day.html
+-rw-rw-rw-   0        0        0     3752 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/page/message_list_view.html
+-rw-rw-rw-   0        0        0     3930 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/page/message_search.html
+-rw-rw-rw-   0        0        0     2716 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/page/message_tag_select.html
+-rw-rw-rw-   0        0        0     1550 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/message/page/message_tag_view.html
+-rw-rw-rw-   0        0        0      178 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/message/page/message_todo.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.538540 xnote-web-0.1.1/handlers/message/page/old/
+-rw-rw-rw-   0        0        0     1967 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/page/old/dairy.html
+-rw-rw-rw-   0        0        0    12904 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/message/page/old/message_calendar_old.html
+-rw-rw-rw-   0        0        0     3251 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/message/page/task_index.html
+-rw-rw-rw-   0        0        0      823 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/mod_fs_path.html
+-rw-rw-rw-   0        0        0       36 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/mod_pagenation.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.775294 xnote-web-0.1.1/handlers/note/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.829736 xnote-web-0.1.1/handlers/note/ajax/
+-rw-rw-rw-   0        0        0     2587 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/ajax/comment_edit_dialog.html
+-rw-rw-rw-   0        0        0     1265 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/ajax/comment_list.html
+-rw-rw-rw-   0        0        0     1281 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/note/ajax/edit_symbol_dialog.html
+-rw-rw-rw-   0        0        0      134 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/note/ajax/group_detail_dialog.html
+-rw-rw-rw-   0        0        0     3074 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/ajax/group_option_dialog.html
+-rw-rw-rw-   0        0        0      407 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/note/ajax/option_dialog.html
+-rw-rw-rw-   0        0        0       62 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/note/ajax/select_note_dialog.html
+-rw-rw-rw-   0        0        0     1192 2022-03-12 15:02:09.000000 xnote-web-0.1.1/handlers/note/ajax/share_group_dialog.html
+-rw-rw-rw-   0        0        0      710 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/ajax/share_note_dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.907715 xnote-web-0.1.1/handlers/note/card/
+-rw-rw-rw-   0        0        0      277 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/card/README.md
+-rw-rw-rw-   0        0        0      939 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/hot_notes.html
+-rw-rw-rw-   0        0        0      950 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/note_contents_left.html
+-rw-rw-rw-   0        0        0      936 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/card/note_date_picker.html
+-rw-rw-rw-   0        0        0      977 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/note_groups.html
+-rw-rw-rw-   0        0        0      994 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/note_types.html
+-rw-rw-rw-   0        0        0      128 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/card/plan_detail.html
+-rw-rw-rw-   0        0        0      952 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/plan_note_card.html
+-rw-rw-rw-   0        0        0      952 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/plan_sidebar.html
+-rw-rw-rw-   0        0        0     1063 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/recent_created_notes.html
+-rw-rw-rw-   0        0        0     1138 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/recent_update_groups.html
+-rw-rw-rw-   0        0        0     1352 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/recent_update_notes.html
+-rw-rw-rw-   0        0        0     1195 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/sticky_notes.html
+-rw-rw-rw-   0        0        0     1096 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/card/task_memo.html
+-rw-rw-rw-   0        0        0     8598 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/comment.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.992170 xnote-web-0.1.1/handlers/note/component/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:24.995906 xnote-web-0.1.1/handlers/note/component/attribute/
+-rw-rw-rw-   0        0        0     1024 2022-07-17 10:20:13.000000 xnote-web-0.1.1/handlers/note/component/attribute/note_category.html
+-rw-rw-rw-   0        0        0     2699 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/component/batch_move.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.005312 xnote-web-0.1.1/handlers/note/component/button/
+-rw-rw-rw-   0        0        0      317 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/button/fixed_bottom_buttons.html
+-rw-rw-rw-   0        0        0      199 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/button/fixed_buttons.html
+-rw-rw-rw-   0        0        0      581 2022-07-14 14:34:40.000000 xnote-web-0.1.1/handlers/note/component/create_note_header.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.014499 xnote-web-0.1.1/handlers/note/component/css/
+-rw-rw-rw-   0        0        0     1574 2022-04-04 06:46:25.000000 xnote-web-0.1.1/handlers/note/component/css/edit_css.html
+-rw-rw-rw-   0        0        0      788 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/component/css/gallery_css.html
+-rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/detail_left.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.059209 xnote-web-0.1.1/handlers/note/component/editor/
+-rw-rw-rw-   0        0        0      552 2022-04-19 15:15:43.000000 xnote-web-0.1.1/handlers/note/component/editor/editor_default_vars.html
+-rw-rw-rw-   0        0        0     3141 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/component/editor/gallery.html
+-rw-rw-rw-   0        0        0     6252 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/editor/markdown.html
+-rw-rw-rw-   0        0        0    15226 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/editor/markdown_edit.html
+-rw-rw-rw-   0        0        0     6150 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/editor/markdown_edit.mobile.html
+-rw-rw-rw-   0        0        0     2051 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/component/editor/post.html
+-rw-rw-rw-   0        0        0     1509 2022-04-01 14:26:37.000000 xnote-web-0.1.1/handlers/note/component/editor/table_lang.html
+-rw-rw-rw-   0        0        0     2521 2022-04-04 15:50:05.000000 xnote-web-0.1.1/handlers/note/component/editor/table_myexcel.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.072997 xnote-web-0.1.1/handlers/note/component/filter/
+-rw-rw-rw-   0        0        0      766 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/filter/group_tag_filter.html
+-rw-rw-rw-   0        0        0      762 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/filter/note_tag_filter.html
+-rw-rw-rw-   0        0        0      556 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/component/filter/type_filter.html
+-rw-rw-rw-   0        0        0     1971 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/group_select.html
+-rw-rw-rw-   0        0        0     3375 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/group_select_tree.html
+-rw-rw-rw-   0        0        0       55 2022-04-22 14:59:54.000000 xnote-web-0.1.1/handlers/note/component/group_special_folder.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.079908 xnote-web-0.1.1/handlers/note/component/header/
+-rw-rw-rw-   0        0        0     1096 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/note/component/header/common_header.html
+-rw-rw-rw-   0        0        0      844 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/header/group_detail_header.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.086028 xnote-web-0.1.1/handlers/note/component/mobile/
+-rw-rw-rw-   0        0        0      855 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/mobile/group_category_switch.html
+-rw-rw-rw-   0        0        0     3460 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/mod_aside.html
+-rw-rw-rw-   0        0        0      495 2022-06-26 11:06:28.000000 xnote-web-0.1.1/handlers/note/component/note_ext_info.html
+-rw-rw-rw-   0        0        0     2805 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/note_list_component.html
+-rw-rw-rw-   0        0        0      318 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/component/note_orderby.html
+-rw-rw-rw-   0        0        0      651 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/note_orderby_select.html
+-rw-rw-rw-   0        0        0      780 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/note_path.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.108193 xnote-web-0.1.1/handlers/note/component/option/
+-rw-rw-rw-   0        0        0     1403 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/option/create_option.html
+-rw-rw-rw-   0        0        0      756 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/component/option/group_option.html
+-rw-rw-rw-   0        0        0     1271 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/option/group_option_dropdown.html
+-rw-rw-rw-   0        0        0     4925 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/option/note_dropdown.html
+-rw-rw-rw-   0        0        0      725 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/root_dropdown.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.163925 xnote-web-0.1.1/handlers/note/component/script/
+-rw-rw-rw-   0        0        0      219 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/note/component/script/all_script.html
+-rw-rw-rw-   0        0        0     2619 2022-07-15 06:43:03.000000 xnote-web-0.1.1/handlers/note/component/script/create_script.html
+-rw-rw-rw-   0        0        0     1164 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/component/script/delete_script.html
+-rw-rw-rw-   0        0        0     1513 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/script/group_select_script.html
+-rw-rw-rw-   0        0        0      697 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/component/script/note_copy_script.html
+-rw-rw-rw-   0        0        0     7224 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/script/note_option_script.html
+-rw-rw-rw-   0        0        0      367 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/script/note_template.html
+-rw-rw-rw-   0        0        0      120 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/script/orderby_script.html
+-rw-rw-rw-   0        0        0      936 2022-03-07 15:10:58.000000 xnote-web-0.1.1/handlers/note/component/script/rename_script.html
+-rw-rw-rw-   0        0        0     1443 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/note/component/script/share_script.html
+-rw-rw-rw-   0        0        0      677 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/script/status_script.html
+-rw-rw-rw-   0        0        0     3733 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/script/tag_manage_script.html
+-rw-rw-rw-   0        0        0     2185 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/script/tag_script.html
+-rw-rw-rw-   0        0        0     4092 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/note/component/share_dialog.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.191018 xnote-web-0.1.1/handlers/note/component/sidebar/
+-rw-rw-rw-   0        0        0     1137 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/sidebar/group_list_sidebar.html
+-rw-rw-rw-   0        0        0     1034 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/sidebar/group_manage_sidebar.html
+-rw-rw-rw-   0        0        0     1630 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/sidebar/group_sidebar.html
+-rw-rw-rw-   0        0        0     1370 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/sidebar/markdown_edit_sidebar.html
+-rw-rw-rw-   0        0        0     1794 2024-01-27 06:07:10.000000 xnote-web-0.1.1/handlers/note/component/sidebar/note_sidebar.html
+-rw-rw-rw-   0        0        0      314 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/sidebar/share_sidebar.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.195023 xnote-web-0.1.1/handlers/note/component/sort/
+-rw-rw-rw-   0        0        0      675 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/sort/note_sort_tab.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.204184 xnote-web-0.1.1/handlers/note/component/timeline/
+-rw-rw-rw-   0        0        0     4364 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/component/timeline/timeline_body.html
+-rw-rw-rw-   0        0        0      716 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/timeline/timeline_create_option.html
+-rw-rw-rw-   0        0        0     1794 2022-06-05 05:50:24.000000 xnote-web-0.1.1/handlers/note/component/view_css.html
+-rw-rw-rw-   0        0        0      807 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/view_footer.html
+-rw-rw-rw-   0        0        0     1368 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/component/view_header.html
+-rw-rw-rw-   0        0        0     1798 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/component/view_header_tag.html
+-rw-rw-rw-   0        0        0     1672 2022-03-12 01:39:04.000000 xnote-web-0.1.1/handlers/note/constant.py
+-rw-rw-rw-   0        0        0    60425 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/dao.py
+-rw-rw-rw-   0        0        0     2162 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_api.py
+-rw-rw-rw-   0        0        0     2532 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_book.py
+-rw-rw-rw-   0        0        0     1276 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_category.py
+-rw-rw-rw-   0        0        0     6536 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/dao_comment.py
+-rw-rw-rw-   0        0        0     2140 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_delete.py
+-rw-rw-rw-   0        0        0     3383 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_draft.py
+-rw-rw-rw-   0        0        0      687 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/dao_edit.py
+-rw-rw-rw-   0        0        0     8364 2023-11-05 02:18:54.000000 xnote-web-0.1.1/handlers/note/dao_log.py
+-rw-rw-rw-   0        0        0      879 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/dao_read.py
+-rw-rw-rw-   0        0        0     4195 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/dao_share.py
+-rw-rw-rw-   0        0        0    12681 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/dao_tag.py
+-rw-rw-rw-   0        0        0    11200 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/html_importer.py
+-rw-rw-rw-   0        0        0     2321 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/note_api.py
+-rw-rw-rw-   0        0        0      487 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/note_calendar.py
+-rw-rw-rw-   0        0        0     2934 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/note_category.py
+-rw-rw-rw-   0        0        0     1381 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/note_checklist.py
+-rw-rw-rw-   0        0        0    28008 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/note_edit.py
+-rw-rw-rw-   0        0        0      491 2022-07-09 01:18:05.000000 xnote-web-0.1.1/handlers/note/note_fix.py
+-rw-rw-rw-   0        0        0    30615 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/note_group.py
+-rw-rw-rw-   0        0        0     1005 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/note_helper.py
+-rw-rw-rw-   0        0        0     2054 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/note_stat.py
+-rw-rw-rw-   0        0        0     8581 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/note_tag.py
+-rw-rw-rw-   0        0        0    20491 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/note_timeline.py
+-rw-rw-rw-   0        0        0    16257 2024-05-19 10:33:28.000000 xnote-web-0.1.1/handlers/note/note_view.py
+-rw-rw-rw-   0        0        0     4669 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/note_workspace.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.299250 xnote-web-0.1.1/handlers/note/page/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.318126 xnote-web-0.1.1/handlers/note/page/batch/
+-rw-rw-rw-   0        0        0      637 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/batch/gallery_manage.html
+-rw-rw-rw-   0        0        0     7276 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/batch/group_manage.html
+-rw-rw-rw-   0        0        0      632 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/note/page/batch/group_manage_category.html
+-rw-rw-rw-   0        0        0     5580 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/batch/note_manage.html
+-rw-rw-rw-   0        0        0      774 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/page/category.html
+-rw-rw-rw-   0        0        0     5298 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/comment.html
+-rw-rw-rw-   0        0        0      431 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/note/page/comment_user_page.html
+-rw-rw-rw-   0        0        0     5726 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/create.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.352325 xnote-web-0.1.1/handlers/note/page/detail/
+-rw-rw-rw-   0        0        0     2152 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/detail/checklist_detail.html
+-rw-rw-rw-   0        0        0     2452 2023-04-06 04:04:41.000000 xnote-web-0.1.1/handlers/note/page/detail/form_detail.html
+-rw-rw-rw-   0        0        0     1217 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/detail/group_detail.html
+-rw-rw-rw-   0        0        0     1126 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/detail/group_detail_body.html
+-rw-rw-rw-   0        0        0     1715 2023-04-06 04:04:41.000000 xnote-web-0.1.1/handlers/note/page/detail/note_detail.html
+-rw-rw-rw-   0        0        0     5694 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/detail/table_detail.html
+-rw-rw-rw-   0        0        0     1453 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/group_list.html
+-rw-rw-rw-   0        0        0      764 2023-12-16 03:36:03.000000 xnote-web-0.1.1/handlers/note/page/group_list_nav_desktop.html
+-rw-rw-rw-   0        0        0      862 2023-12-16 03:36:03.000000 xnote-web-0.1.1/handlers/note/page/group_list_nav_mobile.html
+-rw-rw-rw-   0        0        0     1708 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/history_list.html
+-rw-rw-rw-   0        0        0     4262 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/html_importer.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.367751 xnote-web-0.1.1/handlers/note/page/index/
+-rw-rw-rw-   0        0        0      971 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/page/index/note_index.html
+-rw-rw-rw-   0        0        0     1278 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/index/note_workspace.html
+-rw-rw-rw-   0        0        0      907 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/index/note_workspace.mobile.html
+-rw-rw-rw-   0        0        0     1008 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/page/index/note_workspace2.html
+-rw-rw-rw-   0        0        0     3604 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/list_by_date.html
+-rw-rw-rw-   0        0        0    12810 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/note_calendar.html
+-rw-rw-rw-   0        0        0      606 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/note_default.html
+-rw-rw-rw-   0        0        0     1426 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/note_list.html
+-rw-rw-rw-   0        0        0     1508 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/note_recent.html
+-rw-rw-rw-   0        0        0     1938 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/note_share.html
+-rw-rw-rw-   0        0        0     1292 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/note_tools.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.417095 xnote-web-0.1.1/handlers/note/page/old/
+-rw-rw-rw-   0        0        0      740 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/old/category_old.html
+-rw-rw-rw-   0        0        0     1425 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/note/page/old/create_log.html
+-rw-rw-rw-   0        0        0      807 2022-06-18 00:42:54.000000 xnote-web-0.1.1/handlers/note/page/old/group_list_archived.html
+-rw-rw-rw-   0        0        0     2324 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/old/list_by_date_old.html
+-rw-rw-rw-   0        0        0       92 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/note/page/old/notice.html
+-rw-rw-rw-   0        0        0     4194 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/old/project_list_old.html
+-rw-rw-rw-   0        0        0     2150 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/old/upload_file.html
+-rw-rw-rw-   0        0        0     1267 2023-04-06 04:04:41.000000 xnote-web-0.1.1/handlers/note/page/print.html
+-rw-rw-rw-   0        0        0     1286 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/note/page/taglist.html
+-rw-rw-rw-   0        0        0      783 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/note/page/tagname.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.425906 xnote-web-0.1.1/handlers/note/page/timeline/
+-rw-rw-rw-   0        0        0     1839 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/note/page/timeline/timeline.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.442221 xnote-web-0.1.1/handlers/plan/
+-rw-rw-rw-   0        0        0        0 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/plan/__init__.py
+-rw-rw-rw-   0        0        0     2044 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plan/dao.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.446281 xnote-web-0.1.1/handlers/plan/page/
+-rw-rw-rw-   0        0        0     3662 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plan/page/month_plan.html
+-rw-rw-rw-   0        0        0     3539 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plan/plan.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.473192 xnote-web-0.1.1/handlers/plugin/
+-rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/plugin/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.492153 xnote-web-0.1.1/handlers/plugin/base/
+-rw-rw-rw-   0        0        0     2051 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/plugin/base/base_form_plugin.html
+-rw-rw-rw-   0        0        0     1118 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/plugin/base/base_plugin.html
+-rw-rw-rw-   0        0        0      510 2022-06-19 09:05:51.000000 xnote-web-0.1.1/handlers/plugin/base/base_plugin_body.html
+-rw-rw-rw-   0        0        0     2216 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plugin/base/base_plugin_title.html
+-rw-rw-rw-   0        0        0     2941 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plugin/dao.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.512174 xnote-web-0.1.1/handlers/plugin/header/
+-rw-rw-rw-   0        0        0      818 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/plugin/header/plugin_category.html
+-rw-rw-rw-   0        0        0      930 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/plugin/header/plugin_header_normal.html
+-rw-rw-rw-   0        0        0      254 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/plugin/header/plugin_header_note.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.534263 xnote-web-0.1.1/handlers/plugin/page/
+-rw-rw-rw-   0        0        0      999 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/plugin/page/grid.html
+-rw-rw-rw-   0        0        0     4756 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/plugin/page/plugins_v1.html
+-rw-rw-rw-   0        0        0     1677 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/plugin/page/plugins_v2.html
+-rw-rw-rw-   0        0        0     1341 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/plugin/page/plugins_v3.html
+-rw-rw-rw-   0        0        0     3841 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plugin/plugin_create.py
+-rw-rw-rw-   0        0        0    27565 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plugin/plugin_page.py
+-rw-rw-rw-   0        0        0     1757 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/plugin/plugin_upload.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.607734 xnote-web-0.1.1/handlers/search/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.617483 xnote-web-0.1.1/handlers/search/ajax/
+-rw-rw-rw-   0        0        0      641 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/search/ajax/search_dialog.html
+-rw-rw-rw-   0        0        0      977 2022-02-11 14:35:52.000000 xnote-web-0.1.1/handlers/search/ajax/search_dialog_detail.html
+-rw-rw-rw-   0        0        0     1364 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/search/api.py
+-rw-rw-rw-   0        0        0      958 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/calc.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.634885 xnote-web-0.1.1/handlers/search/component/
+-rw-rw-rw-   0        0        0     1367 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/search/component/search_pagination.html
+-rw-rw-rw-   0        0        0     1034 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/search/component/search_sidebar.html
+-rw-rw-rw-   0        0        0     2172 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/search/component/search_tab.html
+-rw-rw-rw-   0        0        0     3164 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/search/dictionary.py
+-rw-rw-rw-   0        0        0      910 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/mute.py
+-rw-rw-rw-   0        0        0     1428 2022-03-10 14:02:41.000000 xnote-web-0.1.1/handlers/search/note.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.646088 xnote-web-0.1.1/handlers/search/page/
+-rw-rw-rw-   0        0        0     1967 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/search/page/search_history.html
+-rw-rw-rw-   0        0        0     5665 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/search/page/search_result.html
+-rw-rw-rw-   0        0        0      617 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/pydoc.py
+-rw-rw-rw-   0        0        0     2905 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/reminder.py
+-rw-rw-rw-   0        0        0     1778 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/search/scripts.py
+-rw-rw-rw-   0        0        0     1245 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/search/search.html
+-rw-rw-rw-   0        0        0    17603 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/search/search.py
+-rw-rw-rw-   0        0        0      440 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/search/search_aside.html
+-rw-rw-rw-   0        0        0     1874 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/search/search_rules.html
+-rw-rw-rw-   0        0        0     2878 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/search/tools.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.656935 xnote-web-0.1.1/handlers/settings/
+-rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/settings/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.677031 xnote-web-0.1.1/handlers/settings/component/
+-rw-rw-rw-   0        0        0     2855 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/component/admin_settings.html
+-rw-rw-rw-   0        0        0     4751 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/component/note_settings.html
+-rw-rw-rw-   0        0        0     1278 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/component/search_settings.html
+-rw-rw-rw-   0        0        0      868 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/component/settings_sidebar.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.689058 xnote-web-0.1.1/handlers/settings/page/
+-rw-rw-rw-   0        0        0     1951 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/page/properties.html
+-rw-rw-rw-   0        0        0     2097 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/settings/page/settings.html
+-rw-rw-rw-   0        0        0     6857 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/settings/settings.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.820899 xnote-web-0.1.1/handlers/system/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/system/__init__.py
+-rw-rw-rw-   0        0        0    14524 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/backup.py
+-rw-rw-rw-   0        0        0     2773 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/cache_admin.py
+-rw-rw-rw-   0        0        0     4876 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/clipboard.py
+-rw-rw-rw-   0        0        0     3628 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/system/command.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.854964 xnote-web-0.1.1/handlers/system/component/
+-rw-rw-rw-   0        0        0     1425 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/component/admin_nav.html
+-rw-rw-rw-   0        0        0      968 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/component/db_kv_nav.html
+-rw-rw-rw-   0        0        0     1051 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/component/db_nav.html
+-rw-rw-rw-   0        0        0      463 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/system/component/system_css.html
+-rw-rw-rw-   0        0        0      597 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/component/system_log_tab.html
+-rw-rw-rw-   0        0        0     1445 2022-07-02 01:04:41.000000 xnote-web-0.1.1/handlers/system/component/system_sync_cluster_info.html
+-rw-rw-rw-   0        0        0     3450 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/component/system_sync_follower_view.html
+-rw-rw-rw-   0        0        0      564 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/component/thread_nav.html
+-rw-rw-rw-   0        0        0     8946 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/crontab.py
+-rw-rw-rw-   0        0        0      688 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/dao_cron.py
+-rw-rw-rw-   0        0        0    19031 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/db_admin.py
+-rw-rw-rw-   0        0        0     3838 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/db_index.py
+-rw-rw-rw-   0        0        0     8098 2023-10-21 00:22:22.000000 xnote-web-0.1.1/handlers/system/db_migrate_tools.py
+-rw-rw-rw-   0        0        0     1808 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/db_refresh.py
+-rw-rw-rw-   0        0        0     3833 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/db_shell.py
+-rw-rw-rw-   0        0        0     1132 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/db_upgrade.py
+-rw-rw-rw-   0        0        0      534 2022-05-06 04:45:28.000000 xnote-web-0.1.1/handlers/system/develop_controller.py
+-rw-rw-rw-   0        0        0     2165 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/handler_profile.py
+-rw-rw-rw-   0        0        0     1760 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/mod_aside.html
+-rw-rw-rw-   0        0        0      546 2024-05-18 14:13:46.000000 xnote-web-0.1.1/handlers/system/network_profile.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:25.922192 xnote-web-0.1.1/handlers/system/page/
+-rw-rw-rw-   0        0        0     2797 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/cache_admin.html
+-rw-rw-rw-   0        0        0     2586 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/page/crontab.html
+-rw-rw-rw-   0        0        0     2259 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/system/page/crontab_edit.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.085196 xnote-web-0.1.1/handlers/system/page/db/
+-rw-rw-rw-   0        0        0     5972 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/db/db_admin.html
+-rw-rw-rw-   0        0        0     2055 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/page/db/db_backup.html
+-rw-rw-rw-   0        0        0     2555 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/db/db_index.html
+-rw-rw-rw-   0        0        0     1150 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/db/db_index_v2.html
+-rw-rw-rw-   0        0        0     2273 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/db/db_meta.html
+-rw-rw-rw-   0        0        0     1557 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/db/db_struct.html
+-rw-rw-rw-   0        0        0      649 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/db/driver_info.html
+-rw-rw-rw-   0        0        0     1051 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/db/sqldb_detail.html
+-rw-rw-rw-   0        0        0     1370 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/db/sqldb_list.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.094520 xnote-web-0.1.1/handlers/system/page/develop/
+-rw-rw-rw-   0        0        0        0 2022-05-06 04:45:10.000000 xnote-web-0.1.1/handlers/system/page/develop/component_demo.html
+-rw-rw-rw-   0        0        0      971 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/develop/index.html
+-rw-rw-rw-   0        0        0      931 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/system/page/history.html
+-rw-rw-rw-   0        0        0     1655 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/module_detail.html
+-rw-rw-rw-   0        0        0     1046 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/page/module_list.html
+-rw-rw-rw-   0        0        0     5774 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/script.html
+-rw-rw-rw-   0        0        0     2949 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/sqlite.html
+-rw-rw-rw-   0        0        0      651 2022-06-18 13:08:01.000000 xnote-web-0.1.1/handlers/system/page/system_admin.html
+-rw-rw-rw-   0        0        0     2661 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/page/system_index.html
+-rw-rw-rw-   0        0        0     2977 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/page/system_info.html
+-rw-rw-rw-   0        0        0      651 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/system/page/system_info_text.html
+-rw-rw-rw-   0        0        0     4173 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/system_sync.html
+-rw-rw-rw-   0        0        0      590 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/system/page/template_cache.html
+-rw-rw-rw-   0        0        0     1360 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/page/thread_info.html
+-rw-rw-rw-   0        0        0     6736 2023-03-04 06:34:27.000000 xnote-web-0.1.1/handlers/system/script.py
+-rw-rw-rw-   0        0        0     3461 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/stats.py
+-rw-rw-rw-   0        0        0     8747 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system.py
+-rw-rw-rw-   0        0        0      708 2022-04-03 14:17:05.000000 xnote-web-0.1.1/handlers/system/system_boot.py
+-rw-rw-rw-   0        0        0     2513 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/system_event.py
+-rw-rw-rw-   0        0        0     5213 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/system_info.py
+-rw-rw-rw-   0        0        0     7276 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_log.py
+-rw-rw-rw-   0        0        0     4428 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/system_module.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.126103 xnote-web-0.1.1/handlers/system/system_sync/
+-rw-rw-rw-   0        0        0      772 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/system_sync/models.py
+-rw-rw-rw-   0        0        0     1334 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/node_base.py
+-rw-rw-rw-   0        0        0    19381 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/node_follower.py
+-rw-rw-rw-   0        0        0     9237 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/node_leader.py
+-rw-rw-rw-   0        0        0    11939 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/system_sync_controller.py
+-rw-rw-rw-   0        0        0     6846 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/system_sync_indexer.py
+-rw-rw-rw-   0        0        0     9948 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/system_sync/system_sync_proxy.py
+-rw-rw-rw-   0        0        0      444 2023-04-06 15:44:02.000000 xnote-web-0.1.1/handlers/system/system_todo.py
+-rw-rw-rw-   0        0        0      676 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/system/template_cache.py
+-rw-rw-rw-   0        0        0      852 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/system/thread_info.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.143434 xnote-web-0.1.1/handlers/test/
+-rw-rw-rw-   0        0        0      128 2022-01-25 14:37:52.000000 xnote-web-0.1.1/handlers/test/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.148014 xnote-web-0.1.1/handlers/test/component/
+-rw-rw-rw-   0        0        0     1004 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/test/component/example_nav.html
+-rw-rw-rw-   0        0        0      193 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/test/exception.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.181222 xnote-web-0.1.1/handlers/test/page/
+-rw-rw-rw-   0        0        0      697 2022-06-26 11:21:01.000000 xnote-web-0.1.1/handlers/test/page/example_btn.html
+-rw-rw-rw-   0        0        0     1378 2022-05-07 14:15:21.000000 xnote-web-0.1.1/handlers/test/page/example_dialog.html
+-rw-rw-rw-   0        0        0      866 2022-03-13 13:50:59.000000 xnote-web-0.1.1/handlers/test/page/example_dropdown.html
+-rw-rw-rw-   0        0        0     1537 2022-04-17 03:52:32.000000 xnote-web-0.1.1/handlers/test/page/example_hammer.html
+-rw-rw-rw-   0        0        0      102 2022-03-11 12:10:15.000000 xnote-web-0.1.1/handlers/test/page/example_index.html
+-rw-rw-rw-   0        0        0     1707 2022-03-13 13:45:19.000000 xnote-web-0.1.1/handlers/test/page/example_tab.html
+-rw-rw-rw-   0        0        0     1032 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/test/page/example_tag.html
+-rw-rw-rw-   0        0        0     1695 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/test/test_dbutil_handler.py
+-rw-rw-rw-   0        0        0      939 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/test/test_handler.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.480641 xnote-web-0.1.1/handlers/tools/
+-rw-rw-rw-   0        0        0      105 2022-04-17 09:04:15.000000 xnote-web-0.1.1/handlers/tools/__init__.py
+-rw-rw-rw-   0        0        0     2198 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/barcode.html
+-rw-rw-rw-   0        0        0     1035 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/base64.html
+-rw-rw-rw-   0        0        0      371 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/base_title.html
+-rw-rw-rw-   0        0        0     3539 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/browser_info.html
+-rw-rw-rw-   0        0        0     4077 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/camera.html
+-rw-rw-rw-   0        0        0     1353 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/chat_demo.html
+-rw-rw-rw-   0        0        0    10087 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/code_template.html
+-rw-rw-rw-   0        0        0     3818 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/color.html
+-rw-rw-rw-   0        0        0     1486 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/datetime.html
+-rw-rw-rw-   0        0        0     5346 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/hex.html
+-rw-rw-rw-   0        0        0      426 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/iframe_viewer.html
+-rw-rw-rw-   0        0        0     6029 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/img2gray.html
+-rw-rw-rw-   0        0        0     7694 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/img_merge.html
+-rw-rw-rw-   0        0        0     6002 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/img_split.html
+-rw-rw-rw-   0        0        0      619 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/md5.html
+-rw-rw-rw-   0        0        0     4769 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/multi_win.html
+-rw-rw-rw-   0        0        0     3033 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/notebook.html
+-rw-rw-rw-   0        0        0      342 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/notebook.py
+-rw-rw-rw-   0        0        0     2101 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/port_scanner.py
+-rw-rw-rw-   0        0        0     1020 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/qrcode.html
+-rw-rw-rw-   0        0        0     2424 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/random_string.html
+-rw-rw-rw-   0        0        0     1000 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/responsive.html
+-rw-rw-rw-   0        0        0     4119 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/runjs.html
+-rw-rw-rw-   0        0        0     1224 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/search_compare.html
+-rw-rw-rw-   0        0        0      774 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/sha1.html
+-rw-rw-rw-   0        0        0     1937 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/shell.html
+-rw-rw-rw-   0        0        0     3906 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/speech_recognition.html
+-rw-rw-rw-   0        0        0      896 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/tcc.html
+-rw-rw-rw-   0        0        0     1409 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/terminal.html
+-rw-rw-rw-   0        0        0     8164 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/text_convert.html
+-rw-rw-rw-   0        0        0     3732 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/tools/text_diff.html
+-rw-rw-rw-   0        0        0     3297 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/text_set.html
+-rw-rw-rw-   0        0        0     1011 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/tools.py
+-rw-rw-rw-   0        0        0      487 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/tts.html
+-rw-rw-rw-   0        0        0     1249 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/tools/urlcoder.html
+-rw-rw-rw-   0        0        0     7610 2022-11-26 16:30:19.000000 xnote-web-0.1.1/handlers/tools/vue_test.html
+-rw-rw-rw-   0        0        0     5326 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/tools/webuploader.html
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.505887 xnote-web-0.1.1/handlers/user/
+-rw-rw-rw-   0        0        0      287 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/user/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.509417 xnote-web-0.1.1/handlers/user/component/
+-rw-rw-rw-   0        0        0     1241 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/user/component/user_script.html
+-rw-rw-rw-   0        0        0      336 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/user/dao.py
+-rw-rw-rw-   0        0        0     4789 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/user/login.py
+-rw-rw-rw-   0        0        0      255 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/user/logout.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.545028 xnote-web-0.1.1/handlers/user/page/
+-rw-rw-rw-   0        0        0     1516 2023-04-06 15:52:08.000000 xnote-web-0.1.1/handlers/user/page/change_password.html
+-rw-rw-rw-   0        0        0     3357 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/user/page/login.html
+-rw-rw-rw-   0        0        0      912 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/user/page/user.html
+-rw-rw-rw-   0        0        0     3551 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/user/page/user_list.html
+-rw-rw-rw-   0        0        0     2440 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/user/page/user_manage.html
+-rw-rw-rw-   0        0        0      802 2023-10-27 13:17:40.000000 xnote-web-0.1.1/handlers/user/page/user_op_log.html
+-rw-rw-rw-   0        0        0     1522 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/user/page/userinfo.html
+-rw-rw-rw-   0        0        0     6194 2024-05-18 14:13:47.000000 xnote-web-0.1.1/handlers/user/user.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.556644 xnote-web-0.1.1/handlers/webdav/
+-rw-rw-rw-   0        0        0      123 2021-10-01 10:27:00.000000 xnote-web-0.1.1/handlers/webdav/__init__.py
+-rw-rw-rw-   0        0        0     5704 2023-06-30 12:24:59.000000 xnote-web-0.1.1/handlers/webdav/webdav.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.626069 xnote-web-0.1.1/lib/
+-rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.1/lib/__init__.py
+-rw-rw-rw-   0        0        0    33040 2022-05-22 05:10:24.000000 xnote-web-0.1.1/lib/html2text.py
+-rw-rw-rw-   0        0        0   451584 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/leveldb-x64.dll
+-rw-rw-rw-   0        0        0   367104 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/leveldb.dll
+-rw-rw-rw-   0        0        0    37736 2023-10-27 13:17:40.000000 xnote-web-0.1.1/lib/leveldbpy.py
+-rw-rw-rw-   0        0        0     6529 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/smallseg.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.775293 xnote-web-0.1.1/lib/web/
+-rw-rw-rw-   0        0        0      754 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/__init__.py
+-rw-rw-rw-   0        0        0    25946 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/application.py
+-rw-rw-rw-   0        0        0     8714 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/browser.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.785848 xnote-web-0.1.1/lib/web/contrib/
+-rw-rw-rw-   0        0        0        0 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/contrib/__init__.py
+-rw-rw-rw-   0        0        0     3457 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/contrib/template.py
+-rw-rw-rw-   0        0        0    56068 2023-12-02 10:30:00.000000 xnote-web-0.1.1/lib/web/db.py
+-rw-rw-rw-   0        0        0    13157 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/debugerror.py
+-rw-rw-rw-   0        0        0    13983 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/form.py
+-rw-rw-rw-   0        0        0     4619 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/http.py
+-rw-rw-rw-   0        0        0    13278 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/httpserver.py
+-rw-rw-rw-   0        0        0     6507 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/net.py
+-rw-rw-rw-   0        0        0      877 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/py3helpers.py
+-rw-rw-rw-   0        0        0    10921 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/session.py
+-rw-rw-rw-   0        0        0    49690 2022-11-26 16:30:19.000000 xnote-web-0.1.1/lib/web/template.py
+-rw-rw-rw-   0        0        0     2261 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/test.py
+-rw-rw-rw-   0        0        0    42559 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/utils.py
+-rw-rw-rw-   0        0        0    17704 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/webapi.py
+-rw-rw-rw-   0        0        0     3707 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/webopenid.py
+-rw-rw-rw-   0        0        0     2452 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgi.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.823991 xnote-web-0.1.1/lib/web/wsgiserver/
+-rw-rw-rw-   0        0        0     1542 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgiserver/LICENSE.txt
+-rw-rw-rw-   0        0        0      580 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgiserver/__init__.py
+-rw-rw-rw-   0        0        0     4032 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgiserver/ssl_builtin.py
+-rw-rw-rw-   0        0        0     9223 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgiserver/ssl_pyopenssl.py
+-rw-rw-rw-   0        0        0    89663 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/web/wsgiserver/wsgiserver2.py
+-rw-rw-rw-   0        0        0    79905 2022-02-26 02:25:16.000000 xnote-web-0.1.1/lib/web/wsgiserver/wsgiserver3.py
+-rw-rw-rw-   0        0        0    22355 2021-10-01 10:27:00.000000 xnote-web-0.1.1/lib/wget.py
+-rw-rw-rw-   0        0        0       42 2024-06-01 04:52:29.107860 xnote-web-0.1.1/setup.cfg
+-rw-rw-rw-   0        0        0      953 2024-06-01 04:52:13.000000 xnote-web-0.1.1/setup.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.854102 xnote-web-0.1.1/static/
+-rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.858101 xnote-web-0.1.1/static/audio/
+-rw-rw-rw-   0        0        0    26675 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/audio/todo_done.mp3
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:26.950177 xnote-web-0.1.1/static/css/
+-rw-rw-rw-   0        0        0    82369 2024-05-19 09:13:02.000000 xnote-web-0.1.1/static/css/app.build.css
+-rw-rw-rw-   0        0        0     1799 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/app.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.044079 xnote-web-0.1.1/static/css/base/
+-rw-rw-rw-   0        0        0     3034 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/base/common-button.css
+-rw-rw-rw-   0        0        0      547 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/base/common-dialog.css
+-rw-rw-rw-   0        0        0     1570 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/css/base/common-dropdown.css
+-rw-rw-rw-   0        0        0     2212 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/base/common-icon.css
+-rw-rw-rw-   0        0        0     1476 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/css/base/common-layout.css
+-rw-rw-rw-   0        0        0      651 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/base/common-markdown.css
+-rw-rw-rw-   0        0        0     1312 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/css/base/common-mobile.css
+-rw-rw-rw-   0        0        0      927 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/css/base/common-page.css
+-rw-rw-rw-   0        0        0      603 2023-04-16 02:40:01.000000 xnote-web-0.1.1/static/css/base/common-photo.css
+-rw-rw-rw-   0        0        0     2241 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/css/base/common-tab.css
+-rw-rw-rw-   0        0        0     2137 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/css/base/common-tag.css
+-rw-rw-rw-   0        0        0    17189 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/base/common.css
+-rw-rw-rw-   0        0        0      424 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/css/base/layout-second-nav.css
+-rw-rw-rw-   0        0        0      368 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/css/base/reset-wide.css
+-rw-rw-rw-   0        0        0     2689 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/base/reset.css
+-rw-rw-rw-   0        0        0     1795 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/css/common-card.css
+-rw-rw-rw-   0        0        0     3943 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/common-left.css
+-rw-rw-rw-   0        0        0      802 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/common-react.css
+-rw-rw-rw-   0        0        0    31004 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/font-awesome.min.css
+-rw-rw-rw-   0        0        0     4476 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/css/message.css
+-rw-rw-rw-   0        0        0     5073 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/css/note.css
+-rw-rw-rw-   0        0        0      704 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/plugins.css
+-rw-rw-rw-   0        0        0      269 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/search.css
+-rw-rw-rw-   0        0        0     2066 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/css/timeline.css
+-rw-rw-rw-   0        0        0     1286 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/css/todo.css
+-rw-rw-rw-   0        0        0    16958 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/favicon.ico
+-rw-rw-rw-   0        0        0    16372 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/favicon.png
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.060123 xnote-web-0.1.1/static/fonts/
+-rw-rw-rw-   0        0        0    83588 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/fonts/fontawesome-webfont.woff
+-rw-rw-rw-   0        0        0    66624 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/fonts/fontawesome-webfont.woff2
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.174533 xnote-web-0.1.1/static/image/
+-rw-rw-rw-   0        0        0     1277 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/checked.png
+-rw-rw-rw-   0        0        0     2593 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/file.png
+-rw-rw-rw-   0        0        0      985 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/file2.png
+-rw-rw-rw-   0        0        0      120 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/folder.gif
+-rw-rw-rw-   0        0        0      340 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/folder2.png
+-rw-rw-rw-   0        0        0     5696 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/folder3.png
+-rw-rw-rw-   0        0        0      496 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_application.png
+-rw-rw-rw-   0        0        0      956 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_application.svg
+-rw-rw-rw-   0        0        0      128 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_csv.png
+-rw-rw-rw-   0        0        0     1493 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_dict.png
+-rw-rw-rw-   0        0        0      838 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_dict.svg
+-rw-rw-rw-   0        0        0      465 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_folder_settings.png
+-rw-rw-rw-   0        0        0     1024 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_recent.png
+-rw-rw-rw-   0        0        0     1359 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_recent.svg
+-rw-rw-rw-   0        0        0      696 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_right.png
+-rw-rw-rw-   0        0        0      821 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_script.png
+-rw-rw-rw-   0        0        0     1890 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_script.svg
+-rw-rw-rw-   0        0        0     1194 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_search.png
+-rw-rw-rw-   0        0        0     1122 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_search.svg
+-rw-rw-rw-   0        0        0      958 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_settings_applications.png
+-rw-rw-rw-   0        0        0     2120 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_settings_applications.svg
+-rw-rw-rw-   0        0        0     1353 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_shell.png
+-rw-rw-rw-   0        0        0      743 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_shell.svg
+-rw-rw-rw-   0        0        0     2901 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icon_txt.png
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.193613 xnote-web-0.1.1/static/image/icons/
+-rw-rw-rw-   0        0        0     1707 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icons/icon_barcode.png
+-rw-rw-rw-   0        0        0     3158 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icons/icon_game.png
+-rw-rw-rw-   0        0        0     5203 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icons/icon_network.png
+-rw-rw-rw-   0        0        0     1375 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/image/icons/icon_work.png
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.252843 xnote-web-0.1.1/static/js/
+-rw-rw-rw-   0        0        0     2294 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/Lexer.js
+-rw-rw-rw-   0        0        0      623 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/admin.js
+-rw-rw-rw-   0        0        0   106274 2024-05-19 09:13:02.000000 xnote-web-0.1.1/static/js/app.build.js
+-rw-rw-rw-   0        0        0     7644 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/js/app.js
+-rw-rw-rw-   0        0        0      472 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/js/autocss.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.284542 xnote-web-0.1.1/static/js/base/
+-rw-rw-rw-   0        0        0     1309 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/ajax.js
+-rw-rw-rw-   0        0        0     4375 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/array.js
+-rw-rw-rw-   0        0        0      726 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/datetime.js
+-rw-rw-rw-   0        0        0      731 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/jq-ext.js
+-rw-rw-rw-   0        0        0      580 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/misc.js
+-rw-rw-rw-   0        0        0     8338 2023-12-02 11:08:59.000000 xnote-web-0.1.1/static/js/base/string.js
+-rw-rw-rw-   0        0        0     3173 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/base/url.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.289798 xnote-web-0.1.1/static/js/codemirror-addon/
+-rw-rw-rw-   0        0        0    11711 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/codemirror-addon/xnote-search.js
+-rw-rw-rw-   0        0        0    21933 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/colors.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.292976 xnote-web-0.1.1/static/js/components/
+-rw-rw-rw-   0        0        0      786 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/components/date-picker.js
+-rw-rw-rw-   0        0        0     7614 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/console.js
+-rw-rw-rw-   0        0        0     2606 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/editor-csv.js
+-rw-rw-rw-   0        0        0     9587 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/editor.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.295590 xnote-web-0.1.1/static/js/fs/
+-rw-rw-rw-   0        0        0     3429 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/fs/fs.js
+-rw-rw-rw-   0        0        0    15920 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/marked-ext.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.301225 xnote-web-0.1.1/static/js/message/
+-rw-rw-rw-   0        0        0    11220 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/message/message.js
+-rw-rw-rw-   0        0        0    15470 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/note.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.311746 xnote-web-0.1.1/static/js/old/
+-rw-rw-rw-   0        0        0     5071 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/old/TagEditor.js
+-rw-rw-rw-   0        0        0     2489 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/old/fileEditor.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.316747 xnote-web-0.1.1/static/js/plan/
+-rw-rw-rw-   0        0        0     2456 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/plan/plan.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.321200 xnote-web-0.1.1/static/js/plugin/
+-rw-rw-rw-   0        0        0     1811 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/plugin/plugin.form.js
+-rw-rw-rw-   0        0        0     4091 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/upload.js
+-rw-rw-rw-   0        0        0    14750 2023-12-02 11:09:33.000000 xnote-web-0.1.1/static/js/utils.build.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.394015 xnote-web-0.1.1/static/js/xnote-ui/
+-rw-rw-rw-   0        0        0    11058 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/layer.photos.js
+-rw-rw-rw-   0        0        0      703 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/js/xnote-ui/x-audio.js
+-rw-rw-rw-   0        0        0      190 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-core.js
+-rw-rw-rw-   0        0        0     2072 2023-04-16 02:40:01.000000 xnote-web-0.1.1/static/js/xnote-ui/x-device.js
+-rw-rw-rw-   0        0        0    17670 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/xnote-ui/x-dialog.js
+-rw-rw-rw-   0        0        0     3063 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-dropdown.js
+-rw-rw-rw-   0        0        0     4092 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-event.js
+-rw-rw-rw-   0        0        0      327 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/js/xnote-ui/x-ext.js
+-rw-rw-rw-   0        0        0     8400 2024-05-18 14:13:47.000000 xnote-web-0.1.1/static/js/xnote-ui/x-init.js
+-rw-rw-rw-   0        0        0      674 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-layout.js
+-rw-rw-rw-   0        0        0     1365 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-photo.js
+-rw-rw-rw-   0        0        0     1962 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-tab.js
+-rw-rw-rw-   0        0        0     1257 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/js/xnote-ui/x-template.js
+-rw-rw-rw-   0        0        0     8558 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/js/xnote-ui/x-upload.js
+-rw-rw-rw-   0        0        0     3590 2023-06-30 12:24:59.000000 xnote-web-0.1.1/static/js/xnote-ui/x-url.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.420603 xnote-web-0.1.1/static/lib/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.424871 xnote-web-0.1.1/static/lib/JsBarcode/
+-rw-rw-rw-   0        0        0    61195 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/JsBarcode/JsBarcode.all.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.433695 xnote-web-0.1.1/static/lib/art-template/
+-rw-rw-rw-   0        0        0    17325 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/art-template/template-web-4.13.2.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.439240 xnote-web-0.1.1/static/lib/base64.js/
+-rw-rw-rw-   0        0        0     2280 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/base64.js/base64.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.442826 xnote-web-0.1.1/static/lib/bootstrap/
+-rw-rw-rw-   0        0        0   122544 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/bootstrap/bootstrap-3.3.5.min.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.447701 xnote-web-0.1.1/static/lib/clipboard/
+-rw-rw-rw-   0        0        0    10760 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/clipboard/clipboard-2.0.4.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.459058 xnote-web-0.1.1/static/lib/codemirror/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.471442 xnote-web-0.1.1/static/lib/codemirror/5.41.0/
+-rw-rw-rw-   0        0        0     5920 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/5.41.0/codemirror.min.css
+-rw-rw-rw-   0        0        0   167495 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/codemirror/5.41.0/codemirror.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.483994 xnote-web-0.1.1/static/lib/codemirror/5.65.12/
+-rw-rw-rw-   0        0        0     9064 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/5.65.12/codemirror.css
+-rw-rw-rw-   0        0        0   411661 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/5.65.12/codemirror.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.876669 xnote-web-0.1.1/static/lib/codemirror/addon/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.494412 xnote-web-0.1.1/static/lib/codemirror/addon/dialog/
+-rw-rw-rw-   0        0        0      539 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/dialog/dialog.css
+-rw-rw-rw-   0        0        0     5336 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/dialog/dialog.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.542863 xnote-web-0.1.1/static/lib/codemirror/addon/hint/
+-rw-rw-rw-   0        0        0     1722 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/anyword-hint.js
+-rw-rw-rw-   0        0        0     2226 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/css-hint.js
+-rw-rw-rw-   0        0        0    11767 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/html-hint.js
+-rw-rw-rw-   0        0        0     6731 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/javascript-hint.js
+-rw-rw-rw-   0        0        0      659 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/show-hint.css
+-rw-rw-rw-   0        0        0    17150 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/show-hint.js
+-rw-rw-rw-   0        0        0     9851 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/sql-hint.js
+-rw-rw-rw-   0        0        0     4846 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/hint/xml-hint.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.560053 xnote-web-0.1.1/static/lib/codemirror/addon/search/
+-rw-rw-rw-   0        0        0     2067 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/search/jump-to-line.js
+-rw-rw-rw-   0        0        0    10935 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/search/search.js
+-rw-rw-rw-   0        0        0    12261 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/addon/search/searchcursor.js
+-rw-rw-rw-   0        0        0     5920 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/codemirror.min.css
+-rw-rw-rw-   0        0        0   167495 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/codemirror/codemirror.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.568942 xnote-web-0.1.1/static/lib/codemirror/keymap/
+-rw-rw-rw-   0        0        0    25979 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/keymap/sublime.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.666147 xnote-web-0.1.1/static/lib/codemirror/mode/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.673674 xnote-web-0.1.1/static/lib/codemirror/mode/clike/
+-rw-rw-rw-   0        0        0    31730 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/clike/clike.js
+-rw-rw-rw-   0        0        0    24791 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/codemirror/mode/css.min.js
+-rw-rw-rw-   0        0        0    31934 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/javascript.js
+-rw-rw-rw-   0        0        0    26408 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/markdown.js
+-rw-rw-rw-   0        0        0    18501 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/php.js
+-rw-rw-rw-   0        0        0     2249 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/properties.js
+-rw-rw-rw-   0        0        0    12819 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/python.js
+-rw-rw-rw-   0        0        0     4141 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/shell.js
+-rw-rw-rw-   0        0        0    26353 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/mode/sql.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.703247 xnote-web-0.1.1/static/lib/codemirror/theme/
+-rw-rw-rw-   0        0        0     1182 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/theme/eclipse.css
+-rw-rw-rw-   0        0        0     1665 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/codemirror/theme/monokai.min.css
+-rw-rw-rw-   0        0        0     2269 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/codemirror/theme/xq-light.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.712863 xnote-web-0.1.1/static/lib/csv.js/
+-rw-rw-rw-   0        0        0    13851 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/csv.js/csv.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.768959 xnote-web-0.1.1/static/lib/d3/
+-rw-rw-rw-   0        0        0   347498 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/d3/d3.js
+-rw-rw-rw-   0        0        0   151729 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/d3/d3.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.777972 xnote-web-0.1.1/static/lib/exif-js/
+-rw-rw-rw-   0        0        0    41513 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/exif-js/exif.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.784494 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/
+-rw-rw-rw-   0        0        0      330 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/HELP-US-OUT.txt
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.794738 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/css/
+-rw-rw-rw-   0        0        0    39751 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/css/font-awesome.css
+-rw-rw-rw-   0        0        0    31004 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/css/font-awesome.min.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.837148 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/
+-rw-rw-rw-   0        0        0   134808 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/FontAwesome.otf
+-rw-rw-rw-   0        0        0   165742 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.eot
+-rw-rw-rw-   0        0        0   447050 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.svg
+-rw-rw-rw-   0        0        0   165548 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.ttf
+-rw-rw-rw-   0        0        0    98024 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff
+-rw-rw-rw-   0        0        0    77160 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff2
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.919487 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/
+-rw-rw-rw-   0        0        0      747 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/animated.less
+-rw-rw-rw-   0        0        0      610 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/bordered-pulled.less
+-rw-rw-rw-   0        0        0      464 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/core.less
+-rw-rw-rw-   0        0        0      125 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/fixed-width.less
+-rw-rw-rw-   0        0        0      513 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/font-awesome.less
+-rw-rw-rw-   0        0        0    50501 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/icons.less
+-rw-rw-rw-   0        0        0      383 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/larger.less
+-rw-rw-rw-   0        0        0      396 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/list.less
+-rw-rw-rw-   0        0        0     1663 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/mixins.less
+-rw-rw-rw-   0        0        0      786 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/path.less
+-rw-rw-rw-   0        0        0      642 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/rotated-flipped.less
+-rw-rw-rw-   0        0        0      123 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/screen-reader.less
+-rw-rw-rw-   0        0        0      496 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/stacked.less
+-rw-rw-rw-   0        0        0    23363 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/variables.less
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.989760 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/
+-rw-rw-rw-   0        0        0      749 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_animated.scss
+-rw-rw-rw-   0        0        0      617 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_bordered-pulled.scss
+-rw-rw-rw-   0        0        0      471 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_core.scss
+-rw-rw-rw-   0        0        0      126 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_fixed-width.scss
+-rw-rw-rw-   0        0        0    51287 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_icons.scss
+-rw-rw-rw-   0        0        0      388 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_larger.scss
+-rw-rw-rw-   0        0        0      397 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_list.scss
+-rw-rw-rw-   0        0        0     1697 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_mixins.scss
+-rw-rw-rw-   0        0        0      798 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_path.scss
+-rw-rw-rw-   0        0        0      692 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_rotated-flipped.scss
+-rw-rw-rw-   0        0        0      139 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_screen-reader.scss
+-rw-rw-rw-   0        0        0      502 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_stacked.scss
+-rw-rw-rw-   0        0        0    23444 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_variables.scss
+-rw-rw-rw-   0        0        0      448 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/font-awesome.scss
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.906275 xnote-web-0.1.1/static/lib/highlight.js/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.993764 xnote-web-0.1.1/static/lib/highlight.js/11.6.0/
+-rw-rw-rw-   0        0        0   120388 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/lib/highlight.js/11.6.0/highlight.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:27.998764 xnote-web-0.1.1/static/lib/highlight.js/11.6.0/styles/
+-rw-rw-rw-   0        0        0     1144 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/lib/highlight.js/11.6.0/styles/default.min.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.906275 xnote-web-0.1.1/static/lib/highlight.js/11.7.0/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.003364 xnote-web-0.1.1/static/lib/highlight.js/11.7.0/styles/
+-rw-rw-rw-   0        0        0     1158 2023-10-27 13:17:40.000000 xnote-web-0.1.1/static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.909175 xnote-web-0.1.1/static/lib/jexcel/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.084533 xnote-web-0.1.1/static/lib/jexcel/2.0.2/
+-rw-rw-rw-   0        0        0     8809 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jexcel.js
+-rw-rw-rw-   0        0        0     2605 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jexcel.min.js
+-rw-rw-rw-   0        0        0     5311 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.css
+-rw-rw-rw-   0        0        0    35343 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.js
+-rw-rw-rw-   0        0        0     4113 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.min.css
+-rw-rw-rw-   0        0        0    13730 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.min.js
+-rw-rw-rw-   0        0        0    11415 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.css
+-rw-rw-rw-   0        0        0    30620 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.js
+-rw-rw-rw-   0        0        0     9071 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.min.css
+-rw-rw-rw-   0        0        0    11974 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.min.js
+-rw-rw-rw-   0        0        0    12095 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.css
+-rw-rw-rw-   0        0        0   208970 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.js
+-rw-rw-rw-   0        0        0     9179 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.min.css
+-rw-rw-rw-   0        0        0    74272 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.089918 xnote-web-0.1.1/static/lib/jquery/
+-rw-rw-rw-   0        0        0    97168 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery/jquery-1.12.4.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.106912 xnote-web-0.1.1/static/lib/jquery-url-parser/
+-rw-rw-rw-   0        0        0     9036 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery-url-parser/purl.js
+-rw-rw-rw-   0        0        0     4487 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jquery-url-parser/purl.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.110432 xnote-web-0.1.1/static/lib/jquery.qrcode/
+-rw-rw-rw-   0        0        0    14023 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery.qrcode/jquery.qrcode.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.125520 xnote-web-0.1.1/static/lib/jquery.terminal/
+-rw-rw-rw-   0        0        0     2126 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery.terminal/dterm.js
+-rw-rw-rw-   0        0        0     8268 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.css
+-rw-rw-rw-   0        0        0    77663 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.129115 xnote-web-0.1.1/static/lib/jsdiff/
+-rw-rw-rw-   0        0        0    32769 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jsdiff/diff.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.158518 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/
+-rw-rw-rw-   0        0        0    11017 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/README.md
+-rw-rw-rw-   0        0        0      647 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/WEBCOMPONENT.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.169046 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/deps/
+-rw-rw-rw-   0        0        0    63460 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.css
+-rw-rw-rw-   0        0        0   373913 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.189415 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/
+-rw-rw-rw-   0        0        0    20709 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.css
+-rw-rw-rw-   0        0        0   561932 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.js
+-rw-rw-rw-   0        0        0     5435 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.theme.css
+-rw-rw-rw-   0        0        0      143 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/docker-compose.yml
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.217613 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/
+-rw-rw-rw-   0        0        0     1725 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/de_DE.json
+-rw-rw-rw-   0        0        0     1568 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/en_GB.json
+-rw-rw-rw-   0        0        0     1919 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/fr_FR.json
+-rw-rw-rw-   0        0        0     1656 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/it_IT.json
+-rw-rw-rw-   0        0        0     1706 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/pt_BR.json
+-rw-rw-rw-   0        0        0     1444 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/zh_CN.json
+-rw-rw-rw-   0        0        0     1015 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/package.json
+-rw-rw-rw-   0        0        0     1709 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/webcomponent-spreadsheet.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.221914 xnote-web-0.1.1/static/lib/layDate-v5.0.9/
+-rw-rw-rw-   0        0        0    27379 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/laydate.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.929090 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.229183 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.249269 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/
+-rw-rw-rw-   0        0        0     2456 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.eot
+-rw-rw-rw-   0        0        0     3119 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.svg
+-rw-rw-rw-   0        0        0     2272 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.ttf
+-rw-rw-rw-   0        0        0     1492 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.woff
+-rw-rw-rw-   0        0        0     7980 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/laydate.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.256941 xnote-web-0.1.1/static/lib/layer/
+-rw-rw-rw-   0        0        0    40713 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layer/layer.full.js
+-rw-rw-rw-   0        0        0    22117 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layer/layer.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.273141 xnote-web-0.1.1/static/lib/layer/mobile/
+-rw-rw-rw-   0        0        0     3303 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layer/mobile/layer.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.277218 xnote-web-0.1.1/static/lib/layer/mobile/need/
+-rw-rw-rw-   0        0        0     5260 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/mobile/need/layer.css
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:22.941217 xnote-web-0.1.1/static/lib/layer/theme/
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.307528 xnote-web-0.1.1/static/lib/layer/theme/default/
+-rw-rw-rw-   0        0        0     5911 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/icon-ext.png
+-rw-rw-rw-   0        0        0    11493 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/icon.png
+-rw-rw-rw-   0        0        0    14367 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/layer.css
+-rw-rw-rw-   0        0        0     5793 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/loading-0.gif
+-rw-rw-rw-   0        0        0      701 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/loading-1.gif
+-rw-rw-rw-   0        0        0     1787 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/layer/theme/default/loading-2.gif
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.262503 xnote-web-0.1.1/static/lib/layer.mobile-v2.0/
+-rw-rw-rw-   0        0        0       56 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/layer.mobile-v2.0/README.md
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.312269 xnote-web-0.1.1/static/lib/marked/
+-rw-rw-rw-   0        0        0    30358 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/marked/marked.js
+-rw-rw-rw-   0        0        0     6709 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/md5.js
+-rw-rw-rw-   0        0        0      708 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/package-lock.json
+-rw-rw-rw-   0        0        0       57 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/package.json
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.318861 xnote-web-0.1.1/static/lib/quarkjs/
+-rw-rw-rw-   0        0        0    46947 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/quarkjs/quark.base-1.0.0.min.js
+-rw-rw-rw-   0        0        0    15329 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/require-2.1.17.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.323315 xnote-web-0.1.1/static/lib/requirejs/
+-rw-rw-rw-   0        0        0    17699 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/requirejs/require-2.3.6.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.331994 xnote-web-0.1.1/static/lib/string-format/
+-rw-rw-rw-   0        0        0     3143 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/string-format/string-format.js
+-rw-rw-rw-   0        0        0     2218 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/string-format/string-format.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.342708 xnote-web-0.1.1/static/lib/string.js/
+-rw-rw-rw-   0        0        0    22555 2023-04-06 14:57:19.000000 xnote-web-0.1.1/static/lib/string.js/string-3.3.1.min.js
+-rw-rw-rw-   0        0        0    38381 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/string.js/string.js
+-rw-rw-rw-   0        0        0     1813 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/utf.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.358775 xnote-web-0.1.1/static/lib/vue/
+-rw-rw-rw-   0        0        0    76673 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/vue/vue-2.2.6.min.js
+-rw-rw-rw-   0        0        0   106768 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/vue/vue-2.7.9.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.362388 xnote-web-0.1.1/static/lib/wangEditor/
+-rw-rw-rw-   0        0        0    66013 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/wangEditor/wangEditor-3.1.1.min.js
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.389831 xnote-web-0.1.1/static/lib/webuploader/
+-rw-rw-rw-   0        0        0     1078 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/webuploader/README.md
+-rw-rw-rw-   0        0        0   143099 2023-04-06 14:57:20.000000 xnote-web-0.1.1/static/lib/webuploader/Uploader.swf
+-rw-rw-rw-   0        0        0      543 2023-04-06 14:57:39.000000 xnote-web-0.1.1/static/lib/webuploader/webuploader.css
+-rw-rw-rw-   0        0        0    70755 2023-04-06 14:57:40.000000 xnote-web-0.1.1/static/lib/webuploader/webuploader.nolog.min.js
+-rw-rw-rw-   0        0        0    21080 2023-04-06 14:57:20.000000 xnote-web-0.1.1/static/xnote.pdn
+-rw-rw-rw-   0        0        0     3454 2023-04-06 14:57:20.000000 xnote-web-0.1.1/static/xnote.png
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.537511 xnote-web-0.1.1/tests/
+-rw-rw-rw-   0        0        0      258 2022-05-01 06:45:23.000000 xnote-web-0.1.1/tests/__init__.py
+-rw-rw-rw-   0        0        0      287 2023-10-27 13:17:40.000000 xnote-web-0.1.1/tests/a.py
+-rw-rw-rw-   0        0        0     3159 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_admin.py
+-rw-rw-rw-   0        0        0    14195 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_app.py
+-rw-rw-rw-   0        0        0     6446 2024-05-19 04:17:17.000000 xnote-web-0.1.1/tests/test_base.py
+-rw-rw-rw-   0        0        0     1421 2022-05-01 07:09:21.000000 xnote-web-0.1.1/tests/test_dict.py
+-rw-rw-rw-   0        0        0     1631 2023-03-04 06:34:27.000000 xnote-web-0.1.1/tests/test_exif.py
+-rw-rw-rw-   0        0        0     3069 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_fs.py
+-rw-rw-rw-   0        0        0    10114 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_message.py
+-rw-rw-rw-   0        0        0    28235 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_note.py
+-rw-rw-rw-   0        0        0     1248 2022-11-26 16:30:19.000000 xnote-web-0.1.1/tests/test_search.py
+-rw-rw-rw-   0        0        0     1953 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_service.py
+-rw-rw-rw-   0        0        0    11261 2023-10-27 13:17:40.000000 xnote-web-0.1.1/tests/test_system_sync.py
+-rw-rw-rw-   0        0        0      699 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_user.py
+-rw-rw-rw-   0        0        0     5479 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_xauth.py
+-rw-rw-rw-   0        0        0     1150 2021-10-01 10:27:00.000000 xnote-web-0.1.1/tests/test_xmanager.py
+-rw-rw-rw-   0        0        0      455 2024-05-19 04:50:00.000000 xnote-web-0.1.1/tests/test_xtemplate.py
+-rw-rw-rw-   0        0        0    16588 2024-05-19 04:05:58.000000 xnote-web-0.1.1/tests/test_xutils.py
+-rw-rw-rw-   0        0        0     1999 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_xutils_cache.py
+-rw-rw-rw-   0        0        0    30902 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_xutils_db.py
+-rw-rw-rw-   0        0        0     2111 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_xutils_db_hash_table.py
+-rw-rw-rw-   0        0        0     8932 2024-05-18 14:13:47.000000 xnote-web-0.1.1/tests/test_xutils_db_table.py
+-rw-rw-rw-   0        0        0     3251 2024-05-18 16:22:52.000000 xnote-web-0.1.1/tests/test_xutils_sqldb.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.542279 xnote-web-0.1.1/xnote/
+-rw-rw-rw-   0        0        0       40 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/__init__.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.625868 xnote-web-0.1.1/xnote/core/
+-rw-rw-rw-   0        0        0     1952 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/__init__.py
+-rw-rw-rw-   0        0        0     3738 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/autoreload.py
+-rw-rw-rw-   0        0        0    26142 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xauth.py
+-rw-rw-rw-   0        0        0    28954 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xconfig.py
+-rw-rw-rw-   0        0        0    28337 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xmanager.py
+-rw-rw-rw-   0        0        0      155 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/xmanager_log.py
+-rw-rw-rw-   0        0        0    12830 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xnote_app.py
+-rw-rw-rw-   0        0        0     5213 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xnote_code_builder.py
+-rw-rw-rw-   0        0        0      422 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/xnote_event.py
+-rw-rw-rw-   0        0        0      919 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/xnote_hooks.py
+-rw-rw-rw-   0        0        0      887 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/xnote_trace.py
+-rw-rw-rw-   0        0        0     1467 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote/core/xnote_user_config.py
+-rw-rw-rw-   0        0        0    25664 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xtables.py
+-rw-rw-rw-   0        0        0     6921 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/core/xtables_kv.py
+-rw-rw-rw-   0        0        0    18795 2024-06-01 04:44:53.000000 xnote-web-0.1.1/xnote/core/xtemplate.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.660091 xnote-web-0.1.1/xnote/plugin/
+-rw-rw-rw-   0        0        0       63 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/__init__.py
+-rw-rw-rw-   0        0        0     1794 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/component.py
+-rw-rw-rw-   0        0        0     2235 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/form.py
+-rw-rw-rw-   0        0        0     7040 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/plugin.py
+-rw-rw-rw-   0        0        0     1180 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/tab.py
+-rw-rw-rw-   0        0        0     3022 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/plugin/table.py
+-rw-rw-rw-   0        0        0     3375 2024-06-01 04:48:38.000000 xnote-web-0.1.1/xnote/plugin/table_plugin.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.685222 xnote-web-0.1.1/xnote/service/
+-rw-rw-rw-   0        0        0      392 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/service/__init__.py
+-rw-rw-rw-   0        0        0     2136 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/service/comment_service.py
+-rw-rw-rw-   0        0        0     3544 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/service/job_service.py
+-rw-rw-rw-   0        0        0     3155 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/service/lock_service.py
+-rw-rw-rw-   0        0        0     3023 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote/service/tag_service.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.802676 xnote-web-0.1.1/xnote_migrate/
+-rw-rw-rw-   0        0        0      887 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/__init__.py
+-rw-rw-rw-   0        0        0     3007 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/base.py
+-rw-rw-rw-   0        0        0      473 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_000.py
+-rw-rw-rw-   0        0        0     1314 2023-11-05 02:18:54.000000 xnote-web-0.1.1/xnote_migrate/upgrade_001.py
+-rw-rw-rw-   0        0        0     1359 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_002.py
+-rw-rw-rw-   0        0        0     2341 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_003.py
+-rw-rw-rw-   0        0        0      661 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_004.py
+-rw-rw-rw-   0        0        0      826 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_005.py
+-rw-rw-rw-   0        0        0      472 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_006.py
+-rw-rw-rw-   0        0        0      729 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_007.py
+-rw-rw-rw-   0        0        0      459 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_008.py
+-rw-rw-rw-   0        0        0      994 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_009.py
+-rw-rw-rw-   0        0        0     1321 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_010.py
+-rw-rw-rw-   0        0        0     1413 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_011.py
+-rw-rw-rw-   0        0        0     2974 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_012.py
+-rw-rw-rw-   0        0        0      604 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_013.py
+-rw-rw-rw-   0        0        0      922 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_014.py
+-rw-rw-rw-   0        0        0     2595 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_015.py
+-rw-rw-rw-   0        0        0     2292 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xnote_migrate/upgrade_016.py
+-rw-rw-rw-   0        0        0    11467 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote_migrate/upgrade_017.py
+-rw-rw-rw-   0        0        0     7527 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xnote_migrate/upgrade_018.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.821940 xnote-web-0.1.1/xnote_web.egg-info/
+-rw-rw-rw-   0        0        0     5759 2024-06-01 04:52:19.000000 xnote-web-0.1.1/xnote_web.egg-info/PKG-INFO
+-rw-rw-rw-   0        0        0    35243 2024-06-01 04:52:22.000000 xnote-web-0.1.1/xnote_web.egg-info/SOURCES.txt
+-rw-rw-rw-   0        0        0        1 2024-06-01 04:52:19.000000 xnote-web-0.1.1/xnote_web.egg-info/dependency_links.txt
+-rw-rw-rw-   0        0        0       60 2024-06-01 04:52:20.000000 xnote-web-0.1.1/xnote_web.egg-info/top_level.txt
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:28.944676 xnote-web-0.1.1/xutils/
+-rw-rw-rw-   0        0        0     8025 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/__init__.py
+-rw-rw-rw-   0        0        0     1991 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/base.py
+-rw-rw-rw-   0        0        0    22219 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/cacheutil.py
+-rw-rw-rw-   0        0        0      394 2024-05-18 16:36:07.000000 xnote-web-0.1.1/xutils/csvutil.py
+-rw-rw-rw-   0        0        0    10311 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/dateutil.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:29.053406 xnote-web-0.1.1/xutils/db/
+-rw-rw-rw-   0        0        0      128 2022-03-19 02:03:55.000000 xnote-web-0.1.1/xutils/db/__init__.py
+-rw-rw-rw-   0        0        0     6574 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/binlog.py
+-rw-rw-rw-   0        0        0    26096 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_base.py
+-rw-rw-rw-   0        0        0     3699 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/dbutil_cache.py
+-rw-rw-rw-   0        0        0     4774 2023-06-30 12:24:59.000000 xnote-web-0.1.1/xutils/db/dbutil_deque.py
+-rw-rw-rw-   0        0        0     7165 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_hash.py
+-rw-rw-rw-   0        0        0      697 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/dbutil_helper.py
+-rw-rw-rw-   0        0        0     3891 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_id_gen.py
+-rw-rw-rw-   0        0        0     2692 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/dbutil_set.py
+-rw-rw-rw-   0        0        0     8502 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/dbutil_sortedset.py
+-rw-rw-rw-   0        0        0    29711 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_table.py
+-rw-rw-rw-   0        0        0    11598 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_table_index.py
+-rw-rw-rw-   0        0        0    13510 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/dbutil_table_v2.py
+-rw-rw-rw-   0        0        0     1941 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_leveldb.py
+-rw-rw-rw-   0        0        0     4696 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_leveldbpy.py
+-rw-rw-rw-   0        0        0     9596 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_lmdb.py
+-rw-rw-rw-   0        0        0    16839 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/db/driver_mysql.py
+-rw-rw-rw-   0        0        0     3280 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_mysql_enhance.py
+-rw-rw-rw-   0        0        0    11514 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_sqlite.py
+-rw-rw-rw-   0        0        0     4064 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/driver_ssdb.py
+-rw-rw-rw-   0        0        0     7816 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/encode.py
+-rw-rw-rw-   0        0        0     2374 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/db/filters.py
+-rw-rw-rw-   0        0        0     2690 2023-04-06 04:04:41.000000 xnote-web-0.1.1/xutils/db/lock.py
+-rw-rw-rw-   0        0        0     4615 2022-05-17 15:05:38.000000 xnote-web-0.1.1/xutils/db/shard.py
+-rw-rw-rw-   0        0        0     1836 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/dbutil.py
+-rw-rw-rw-   0        0        0     8951 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/exeutil.py
+-rw-rw-rw-   0        0        0    24793 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/fsutil.py
+-rw-rw-rw-   0        0        0     2038 2024-05-18 16:17:07.000000 xnote-web-0.1.1/xutils/func_util.py
+-rw-rw-rw-   0        0        0     8763 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/functions.py
+-rw-rw-rw-   0        0        0     1080 2021-10-01 10:27:00.000000 xnote-web-0.1.1/xutils/htmlutil.py
+-rw-rw-rw-   0        0        0     4008 2024-04-05 10:56:40.000000 xnote-web-0.1.1/xutils/imports.py
+-rw-rw-rw-   0        0        0     7659 2024-05-18 16:10:58.000000 xnote-web-0.1.1/xutils/interfaces.py
+-rw-rw-rw-   0        0        0     1259 2024-05-19 04:05:48.000000 xnote-web-0.1.1/xutils/jsonutil.py
+-rw-rw-rw-   0        0        0      317 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/lists.py
+-rw-rw-rw-   0        0        0     2487 2024-05-18 18:08:20.000000 xnote-web-0.1.1/xutils/lockutil.py
+-rw-rw-rw-   0        0        0    12065 2024-05-18 16:39:38.000000 xnote-web-0.1.1/xutils/logutil.py
+-rw-rw-rw-   0        0        0     3474 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/mem_util.py
+-rw-rw-rw-   0        0        0    10953 2023-12-02 11:46:25.000000 xnote-web-0.1.1/xutils/netutil.py
+-rw-rw-rw-   0        0        0      370 2024-05-18 15:43:59.000000 xnote-web-0.1.1/xutils/numutil.py
+-rw-rw-rw-   0        0        0    34581 2024-05-19 09:35:46.000000 xnote-web-0.1.1/xutils/six.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:29.077299 xnote-web-0.1.1/xutils/sqldb/
+-rw-rw-rw-   0        0        0      382 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/sqldb/__init__.py
+-rw-rw-rw-   0        0        0      700 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/sqldb/table_config.py
+-rw-rw-rw-   0        0        0    12835 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/sqldb/table_manager.py
+-rw-rw-rw-   0        0        0     9935 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/sqldb/table_proxy.py
+-rw-rw-rw-   0        0        0      430 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/sqldb/utils.py
+-rw-rw-rw-   0        0        0    19009 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/text_parser.py
+-rw-rw-rw-   0        0        0     2635 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/text_parser_properties.py
+-rw-rw-rw-   0        0        0    22488 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/textutil.py
+-rw-rw-rw-   0        0        0      651 2023-03-04 06:34:27.000000 xnote-web-0.1.1/xutils/textutil_url.py
+-rw-rw-rw-   0        0        0     7496 2023-01-22 10:01:14.000000 xnote-web-0.1.1/xutils/tokenizer.py
+drwxrwxrwx   0        0        0        0 2024-06-01 04:52:29.100854 xnote-web-0.1.1/xutils/tornado/
+-rw-rw-rw-   0        0        0        0 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/tornado/__init__.py
+-rw-rw-rw-   0        0        0    14538 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/tornado/escape.py
+-rw-rw-rw-   0        0        0    10906 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/tornado/log.py
+-rw-rw-rw-   0        0        0    37379 2024-06-01 04:40:01.000000 xnote-web-0.1.1/xutils/tornado/template.py
+-rw-rw-rw-   0        0        0    13605 2023-10-27 13:17:40.000000 xnote-web-0.1.1/xutils/tornado/util.py
+-rw-rw-rw-   0        0        0     8013 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/webutil.py
+-rw-rw-rw-   0        0        0     2394 2024-05-18 14:13:47.000000 xnote-web-0.1.1/xutils/ziputil.py
```

### Comparing `xnote-web-0.1.0/COPYING` & `xnote-web-0.1.1/COPYING`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/PKG-INFO` & `xnote-web-0.1.1/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: xnote-web
-Version: 0.1.0
+Version: 0.1.1
 Summary: xnote-web框架
 Author: mark
 Author-email: 578749341@qq.com
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: OS Independent
 Description-Content-Type: text/markdown
```

### Comparing `xnote-web-0.1.0/README.md` & `xnote-web-0.1.1/xnote_web.egg-info/PKG-INFO`

 * *Files 9% similar despite different names*

```diff
@@ -1,7 +1,19 @@
+Metadata-Version: 2.1
+Name: xnote-web
+Version: 0.1.1
+Summary: xnote-web框架
+Author: mark
+Author-email: 578749341@qq.com
+Classifier: Programming Language :: Python :: 3
+Classifier: License :: OSI Approved :: MIT License
+Classifier: Operating System :: OS Independent
+Description-Content-Type: text/markdown
+License-File: COPYING
+
 # Xnote
 
 [![Coverage Status](https://coveralls.io/repos/github/xupingmao/xnote/badge.svg?branch=master)](https://coveralls.io/github/xupingmao/xnote?branch=master)
 ![Docker Image](https://img.shields.io/docker/pulls/donjuanplatinum/xnote)
 
 xnote是一款面向个人的轻量级笔记系统，提供多种维度的数据管理功能，致力于把个人从信息过载中解放出来。它主要有如下特性
```

### Comparing `xnote-web-0.1.0/config/boot/boot.local.leveldb.properties` & `xnote-web-0.1.1/config/boot/boot.local.leveldb.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/boot/boot.local.properties` & `xnote-web-0.1.1/config/boot/boot.local.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/cron/cron.json` & `xnote-web-0.1.1/config/cron/cron.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/file/text.properties` & `xnote-web-0.1.1/config/file/text.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/lang/en.properties` & `xnote-web-0.1.1/config/lang/en.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/lang/zh.properties` & `xnote-web-0.1.1/config/lang/zh.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/note/smart_group.ini` & `xnote-web-0.1.1/config/note/smart_group.ini`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/config/plugin/form_plugin.tpl.py` & `xnote-web-0.1.1/config/plugin/form_plugin.tpl.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,226 +1,226 @@
-# -*- coding:utf-8 -*-
-# @id $plugin_id
-# @api-level 2.8
-# @since $since
-# @author $author
-# @version 1.0.0
-# @category note
-# @title 我的表单插件-$date
-# @description 插件描述
-# @icon-class fa-cube
-# @permitted-role admin # 对admin用户开放
-# @debug true # 开启调试模式，开发完成后记得关闭
-
-import xconfig
-import xutils
-import xauth
-import xmanager
-import xtemplate
-from xutils import Storage
-from xutils import dbutil
-from xutils import textutil
-from xtemplate import BasePlugin
-
-HTML = """
-<!-- 操作区域 -->
-<div class="card btn-line-height">
-    <span>插件功能说明...</span>
-    <div class="float-right">
-        <button class="edit-btn">添加记录</button>
-        <button class="option-btn btn-default">选项</button>
-    </div>
-</div>
-
-<!-- 输出的表格 -->
-<div class="card">
-    <table class="table">
-        <tr>
-            <th>姓名</th>
-            <th>年龄</th>
-            <th>职业</th>
-            <th>操作</th>
-        </tr>
-        
-        {% for row in data_list %}
-            <tr>
-                <td>{{row.name}}</td>
-                <td>{{row.age}}</td>
-                <td>{{row.job}}</td>
-                <td>
-                    <button class="edit-btn btn-default" data-key="{{row._key}}">编辑</button>
-                    <button class="delete-btn btn-danger" data-key="{{row._key}}">删除</button>
-                </td>
-            </tr>
-        {% end %}
-    </table>
-</div>
-
-<!-- 选项的HTML -->
-<div class="option-html hide">
-    <ul>
-        <li>选项1</li>
-        <li>选项2</li>
-    </ul>
-</div>
-
-<!-- 编辑脚本 -->
-<script>
-$(function(){
-    // 编辑事件处理(创建和更新)
-    $(".edit-btn").click(function (event) {
-        var rowKey  = $(event.target).attr("data-key");
-        $.get("?action=get_template", {key: rowKey}, function(resp) {
-            var buttons = ["确认", "取消"];
-            var functions = [function (index, layero) {
-                var params = $(".x-form").formData();
-                params.key = rowKey;
-                $.post("?action=edit", params, function (resp) {
-                    if (resp.code != "success") {
-                        xnote.alert(resp.message);
-                    } else {
-                        window.location.reload();
-                    }
-                }).fail(function (e) {
-                    console.error(e);
-                    xnote.alert("请求编辑接口失败");
-                });
-            }];
-            xnote.showDialog("编辑行", resp, buttons, functions);
-        });
-    });
-
-    // 删除事件处理
-    $(".delete-btn").click(function (event) {
-        var rowKey = $(event.target).attr("data-key");
-        xnote.confirm("确认删除记录?", function (confirmed) {    
-            $.post("?action=delete", {key: rowKey}, function (resp) {
-                if (resp.code != "success") {
-                    xnote.alert(resp.message);
-                } else {
-                    window.location.reload();
-                }
-            }).fail(function (e) {
-                console.error(e);
-                xnote.alert("请求删除接口失败");
-            });
-        });
-    });
-
-    // 选项事件处理
-    $(".option-btn").click(function (event) {
-        var option = {};
-        option.html = $(".option-html").html();
-        xnote.showOptionDialog(option);
-    });
-});
-</script>
-"""
-
-EDIT_HTML = """
-<form class="x-form" method="POST">
-    <textarea class="col-md-12" name="content" rows=20>{{content}}</textarea>
-</form>
-"""
-
-DEFAULT_EDIT_CONTENT = """
-name = 张三
-age  = 20
-job  = 学生
-"""
-
-
-# 注册存储
-dbutil.register_table("form_test_data", "表单测试数据")
-TABLE = dbutil.LdbTable("form_test_data")
-
-
-def convert_content_to_row(content):
-    """把纯文本转换为键值对属性
-    @param {str} content 输入的文本
-    @return {Storage} 行对象
-    """
-    if content is None or content == "":
-        return Storage(_content = content)
-
-    row = Storage()
-    properties = textutil.parse_prop_text(content)
-    row.update(properties)
-    row._content = content
-    return row
-
-def convert_row_to_content(row):
-    """把键值对属性转换为文本"""
-    if row is None:
-        return DEFAULT_EDIT_CONTENT
-    return row._content
-
-def convert_data_list(data_list):
-    """数据列表转换"""
-    return data_list
-
-class Main(BasePlugin):
-
-    rows = 0
-
-    def get_input_template(self):
-        key = xutils.get_argument("key", "")
-        row = TABLE.get_by_key(key)        
-        
-        # 转换成文本对象
-        content = convert_row_to_content(row)
-            
-        return self.ajax_response(EDIT_HTML, content = content)
-    
-    def edit_row(self):
-        key = xutils.get_argument("key", "")
-        content = xutils.get_argument("content", "")
-        user_name = xauth.current_name()
-
-        # 转换对象
-        row = convert_content_to_row(content)
-
-        if key != "":
-            TABLE.update_by_key(key, row)
-            return dict(code = "success", message = "更新成功")
-        else:
-            TABLE.insert_by_user(user_name, row, id_type = "timeseq")
-            return dict(code = "success", message = "创建成功")
-
-    def delete_row(self):
-        key = xutils.get_argument("key", "")
-        user_name = xauth.current_name()
-        if TABLE.is_valid_key(key, user_name = user_name):
-            TABLE.delete_by_key(key)
-            return dict(code = "success", message = "删除成功")
-        else:
-            return dict(code = "fail", message = "无权删除")
-    
-    def load_data_list(self):
-        user_name = xauth.current_name()
-        offset = xutils.get_argument("offset", 0, type = int)
-        limit  = xutils.get_argument("limit", 20, type = int)
-        data_list = TABLE.list_by_user(user_name, offset, limit, reverse = True)
-        data_list = convert_data_list(data_list)
-        self.writehtml(HTML, data_list = data_list)
-    
-    def handle(self, input):
-        action  = xutils.get_argument("action", "")
-        if action == "get_template":
-            # 获取编辑对象
-            return self.get_input_template()
-        
-        if action == "edit":
-            # 编辑操作
-            return self.edit_row()
-
-        if action == "delete":
-            # 删除操作
-            return self.delete_row()
-        
-        # 加载数据列表
-        return self.load_data_list()
-
-
-if __name__ == "__main__":
-    # 命令行中执行
-    pass
+# -*- coding:utf-8 -*-
+# @id $plugin_id
+# @api-level 2.8
+# @since $since
+# @author $author
+# @version 1.0.0
+# @category note
+# @title 我的表单插件-$date
+# @description 插件描述
+# @icon-class fa-cube
+# @permitted-role admin # 对admin用户开放
+# @debug true # 开启调试模式，开发完成后记得关闭
+
+import xconfig
+import xutils
+import xauth
+import xmanager
+import xtemplate
+from xutils import Storage
+from xutils import dbutil
+from xutils import textutil
+from xtemplate import BasePlugin
+
+HTML = """
+<!-- 操作区域 -->
+<div class="card btn-line-height">
+    <span>插件功能说明...</span>
+    <div class="float-right">
+        <button class="edit-btn">添加记录</button>
+        <button class="option-btn btn-default">选项</button>
+    </div>
+</div>
+
+<!-- 输出的表格 -->
+<div class="card">
+    <table class="table">
+        <tr>
+            <th>姓名</th>
+            <th>年龄</th>
+            <th>职业</th>
+            <th>操作</th>
+        </tr>
+        
+        {% for row in data_list %}
+            <tr>
+                <td>{{row.name}}</td>
+                <td>{{row.age}}</td>
+                <td>{{row.job}}</td>
+                <td>
+                    <button class="edit-btn btn-default" data-key="{{row._key}}">编辑</button>
+                    <button class="delete-btn btn-danger" data-key="{{row._key}}">删除</button>
+                </td>
+            </tr>
+        {% end %}
+    </table>
+</div>
+
+<!-- 选项的HTML -->
+<div class="option-html hide">
+    <ul>
+        <li>选项1</li>
+        <li>选项2</li>
+    </ul>
+</div>
+
+<!-- 编辑脚本 -->
+<script>
+$(function(){
+    // 编辑事件处理(创建和更新)
+    $(".edit-btn").click(function (event) {
+        var rowKey  = $(event.target).attr("data-key");
+        $.get("?action=get_template", {key: rowKey}, function(resp) {
+            var buttons = ["确认", "取消"];
+            var functions = [function (index, layero) {
+                var params = $(".x-form").formData();
+                params.key = rowKey;
+                $.post("?action=edit", params, function (resp) {
+                    if (resp.code != "success") {
+                        xnote.alert(resp.message);
+                    } else {
+                        window.location.reload();
+                    }
+                }).fail(function (e) {
+                    console.error(e);
+                    xnote.alert("请求编辑接口失败");
+                });
+            }];
+            xnote.showDialog("编辑行", resp, buttons, functions);
+        });
+    });
+
+    // 删除事件处理
+    $(".delete-btn").click(function (event) {
+        var rowKey = $(event.target).attr("data-key");
+        xnote.confirm("确认删除记录?", function (confirmed) {    
+            $.post("?action=delete", {key: rowKey}, function (resp) {
+                if (resp.code != "success") {
+                    xnote.alert(resp.message);
+                } else {
+                    window.location.reload();
+                }
+            }).fail(function (e) {
+                console.error(e);
+                xnote.alert("请求删除接口失败");
+            });
+        });
+    });
+
+    // 选项事件处理
+    $(".option-btn").click(function (event) {
+        var option = {};
+        option.html = $(".option-html").html();
+        xnote.showOptionDialog(option);
+    });
+});
+</script>
+"""
+
+EDIT_HTML = """
+<form class="x-form" method="POST">
+    <textarea class="col-md-12" name="content" rows=20>{{content}}</textarea>
+</form>
+"""
+
+DEFAULT_EDIT_CONTENT = """
+name = 张三
+age  = 20
+job  = 学生
+"""
+
+
+# 注册存储
+dbutil.register_table("form_test_data", "表单测试数据")
+TABLE = dbutil.LdbTable("form_test_data")
+
+
+def convert_content_to_row(content):
+    """把纯文本转换为键值对属性
+    @param {str} content 输入的文本
+    @return {Storage} 行对象
+    """
+    if content is None or content == "":
+        return Storage(_content = content)
+
+    row = Storage()
+    properties = textutil.parse_prop_text(content)
+    row.update(properties)
+    row._content = content
+    return row
+
+def convert_row_to_content(row):
+    """把键值对属性转换为文本"""
+    if row is None:
+        return DEFAULT_EDIT_CONTENT
+    return row._content
+
+def convert_data_list(data_list):
+    """数据列表转换"""
+    return data_list
+
+class Main(BasePlugin):
+
+    rows = 0
+
+    def get_input_template(self):
+        key = xutils.get_argument("key", "")
+        row = TABLE.get_by_key(key)        
+        
+        # 转换成文本对象
+        content = convert_row_to_content(row)
+            
+        return self.ajax_response(EDIT_HTML, content = content)
+    
+    def edit_row(self):
+        key = xutils.get_argument("key", "")
+        content = xutils.get_argument("content", "")
+        user_name = xauth.current_name()
+
+        # 转换对象
+        row = convert_content_to_row(content)
+
+        if key != "":
+            TABLE.update_by_key(key, row)
+            return dict(code = "success", message = "更新成功")
+        else:
+            TABLE.insert_by_user(user_name, row, id_type = "timeseq")
+            return dict(code = "success", message = "创建成功")
+
+    def delete_row(self):
+        key = xutils.get_argument("key", "")
+        user_name = xauth.current_name()
+        if TABLE.is_valid_key(key, user_name = user_name):
+            TABLE.delete_by_key(key)
+            return dict(code = "success", message = "删除成功")
+        else:
+            return dict(code = "fail", message = "无权删除")
+    
+    def load_data_list(self):
+        user_name = xauth.current_name()
+        offset = xutils.get_argument("offset", 0, type = int)
+        limit  = xutils.get_argument("limit", 20, type = int)
+        data_list = TABLE.list_by_user(user_name, offset, limit, reverse = True)
+        data_list = convert_data_list(data_list)
+        self.writehtml(HTML, data_list = data_list)
+    
+    def handle(self, input):
+        action  = xutils.get_argument("action", "")
+        if action == "get_template":
+            # 获取编辑对象
+            return self.get_input_template()
+        
+        if action == "edit":
+            # 编辑操作
+            return self.edit_row()
+
+        if action == "delete":
+            # 删除操作
+            return self.delete_row()
+        
+        # 加载数据列表
+        return self.load_data_list()
+
+
+if __name__ == "__main__":
+    # 命令行中执行
+    pass
```

### Comparing `xnote-web-0.1.0/config/user/user_config.default.properties` & `xnote-web-0.1.1/config/user/user_config.default.properties`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/architecture.md` & `xnote-web-0.1.1/docs/architecture.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/changelog.md` & `xnote-web-0.1.1/docs/changelog.md`

 * *Files 12% similar despite different names*

```diff
@@ -1,443 +1,464 @@
-# v2.9.5 (2023.07.01~2023.10.27)
-
-- 待办&随手记
-    - [x] 随手记的备注功能（类似于评论的回复）
-    - [x] 隔离随手记和待办任务
-    - [x] 支持文字强调标记
-- 笔记管理
-    - [x] 支持代码高亮
-    - [x] Fix标签关联的笔记列表排序
-    - [x] Fix笔记本搜索
-- 文件管理
-    - [x] 优化侧边栏模式
-- 系统功能
-    - [x] 支持作为模块(xnote-web)发布到pip
-    - [x] 插件支持 plugin_id 唯一标识，支持本地开发远程部署
-    - [x] 支持sql数据库的binlog同步
-    - [x] 笔记、评论、随手记拆分成sql存储索引，kv存储主数据
-    - [x] 移动tornado模板库到`xutils`模块
-    - [x] kv数据库添加`ssdb`的驱动
-    - [x] P1-上传文件要更新binlog
-    - [x] SQL数据库支持只读状态
-
-
-# v2.9.4 (2023.03.05~2023.06.30)
-
-- 笔记管理
-    - [x] 标签上批量添加笔记
-    - [x] 点击标签，筛选出全部包含标签的笔记（而不是当前笔记本的）
-- 随手记
-    - [x] 支持文字高亮
-- 文件管理
-    - [x] 优化了代码编辑器的交互，使用ajax来更新数据
-- UI优化&菜单
-    - [x] 未登录状态下展示应用列表链接
-    - [x] 支持侧边栏的样式，提高屏幕的空间使用率
-- 系统功能
-    - [x] 增强作为web框架的功能
-    - [x] 数据库支持联合索引
-    - [x] 数据库支持where条件查询
-    - [x] 优化关系型数据库接口
-    - [x] 账号安全性提升
-    - [x] Fix若干个漏洞
-
-# v2.9.3 (2022.11.28~2023.03.04)
-
-- 待办&随手记
-    - [x] 优化标签选择功能
-- 笔记管理
-    - [x] 使用单独的表记录笔记更新历史列表
-    - [x] 优化相册ui
-    - [x] 笔记复制的功能
-    - [x] 支持月度计划
-    - [x] 支持系统标签（可以跨越笔记本全局可用）
-    - [x] 发送笔记到待办任务，通过系统标签的方式支持
-- 笔记本
-    - [x] 增加排序的选项
-- UI优化
-    - [x] PC页面更多的使用左右分栏，提升效率
-- 系统功能
-    - [x] 修复了前端资源缓存的问题
-    - [x] 优化缩略图生成逻辑
-
-# v2.9.2 (2022.07.31~2022.11.27)
-
-- 笔记管理
-    - [x] 支持笔记编辑页目录跳转
-    - 笔记标签管理
-        - [x] 创建时绑定标签
-        - [x] 单个笔记绑定标签
-        - [x] 批量绑定标签
-    - [x] 优化移动端编辑器的插入图片操作，直接插入到光标后面
-- 笔记本
-    - [x] 新增按钮下可以创建标签或者子章节，通过标签的功能实现了
-    - [x] 笔记本标签
-- 搜索功能
-    - [x] 搜索历史展示5个热门关键字，其余按照最近搜索展示
-- 系统功能
-    - [x] 外部资源缓存功能，防止导入的资料中临时链接失效导致图片无法访问
-    - [x] 数据库自增ID优化
-    - [x] 统计请求服务端耗时
-    - [x] 数据库管理工具增加用户筛选条件,优化搜索功能
-    - [x] 文件变更记录到binlog
-    - [x] 查看图片支持旋转
-    - [x] 数据库支持mysql，并且做了针对性的缓存优化+批量查询优化(不然性能太差了。。。)
-- BugFix
-    - [x] Windows平台 Python3.7 环境下的 urlopen 函数有内存泄漏风险，安装 requests 可以解决这个问题
-
-# v2.9.1 (2022.02.21~2022.07.17)
-
-- 随手记
-    - [x] 侧边栏展示常用的标签
-- 笔记管理
-    - [x] 不允许admin修改其他账号的笔记
-    - [x] 并发编辑保护。
-        - 编辑过程中自动保存草稿。打开编辑的时候自动加载草稿，并且编辑器上予以提示，提交修改后自动删除草稿内容
-        - 编辑的时候需要申请编辑锁。如果没有成功获取锁，不允许编辑
-    - [x] 优化了表格编辑功能：可以自己调整表格宽度，支持中文菜单
-    - [x] 侧边栏可以支持查看同级别的其他笔记 04/23
-- 评论
-    - [x] 笔记详情设置是否允许编辑评论
-    - [x] 支持自定义设置Markdown预览的默认状态
-- 笔记本
-    - [x] 笔记本列表排序功能（2022/03/06）
-    - [x] 支持笔记本类目属性
-    - [x] 支持笔记本层级
-- 搜索功能
-    - [x] 支持搜索相关词，可以通过后台配置相关词
-- 系统功能
-    - [x] 支持词库配置
-    - [x] 守护进程和工作进程分离，支持远程重启
-    - [x] 启动参数支持配置leveldb的缓存大小
-    - [x] 优化内存的使用,调整了缓存大小和打开的文件数量参数
-    - [x] 数据库备份导入导出功能
-    - [x] 数据库支持多驱动(leveldb/leveldbpy/sqlite/lmdb)
-    - [x] 数据库索引管理
-    - [x] 实现双端队列
-- BUG修复
-    - [x] 笔记本删除的功能入口没了
-    - [x] 评论里面的编辑页面上传文件有BUG，功能错位到了主输入框
-
-# v2.8 (2021.06.28~2022.02.20)
-
-- 菜单导航和布局
-    - [x] 【优化】导航配置化
-    - [x] 【优化】优化移动端布局适配
-- Markdown编辑器
-    - [x] 【优化】移动版编辑器优化
-    - [x] 【新增】支持插入笔记内链(2022/02/07)
-    - [x] 【优化】支持待办项状态切换
-- 清单列表编辑器
-    - [x] 【新增】支持内容编辑
-- 插件功能
-    - [x] 【新增】支持@header注解的方式配置（类似于GM脚本）
-    - [x] 【新增】支持按热度和最近访问进行排序
-    - [x] 【新增】新增表单模板
-- 系统功能
-    - [x] 【新增】用户操作日志
-    - [x] 【修复】修复Cookie的有效期
-    - [x] 【新增】主从同步初版(基于文件)
-    - [x] 【新增】LdbTable功能开发，支持索引
-
-# v2.7 (2020.11.13~2021.06.27)
-- 【新增】支持首页内容配置，链接保持不变
-- 【修复】`urlsafe_b64`格式的编解码
-- 【优化】随手记功能优化
-    - 新增书籍、电话、人物(@)的识别
-    - 选择标签功能优化
-    - 标签支持按照访问量排序
-    - 支持按天查看随手记
-- 【优化】搜索功能优化，笔记、词典的搜索统一到综合搜索里面
-- 【优化】优化笔记的时间视图，增加年报、月报功能
-- 【优化】支持webdav功能（当前仅限admin用户）
-- 【优化】代码编辑器的搜索功能
-- 【优化】优化卡片布局
-
-
-# v2.6 (2020.05.23~2020.11.12)
-- 【优化】markdown编辑页面上传文件的时候加loading蒙版，防止误操作
-- 【优化】统一整个交互页面，优化前进返回的交互
-- 【优化】公共笔记右侧加一个按钮【分享】，可以通过搜索分享我的笔记。
-- 【优化】最近常用优化成相对的统计
-- 【修复】创建笔记的项目列表排序是乱序的 2020.07.11
-- 【优化】“最近”板块优化成“动态”，把所有动态聚合在一起，添加筛选条件
-- 【优化】行内代码的高亮
-- 【优化】文件上传校验
-- 【优化】插件的代码逻辑优化，界面优化
-- 【优化】dbutil新增`register_table`方法，写入数据前要注册数据表的信息
-- 【优化】分页组件样式
-- 【优化】文件管理器的样式
-- 【优化】目录的样式
-
-# v2.5 (2019.12.01~2020.05.22)
-- 【新增】链接分享功能，在笔记详情页，更多可以开启。
-- 【新增】新增笔记类型：日志，系统生成默认标题，不进行标题的唯一性检验。
-- 【新增】笔记的DAO层增加一个`list_by_func`方法
-- 【新增】批量管理项目功能
-- 【新增】更新和查看笔记的操作日志
-- 【优化】支持Python3.8
-- 【优化】大范围的重构，消除冗余代码，提高测试的覆盖率
-- 【优化】笔记本改造成项目，项目列表和项目里的笔记列表都以时间轴视图呈现。
-- 【优化】项目内批量移动功能，移动笔记时支持搜索项目
-- 【优化】按月查看的日期格式优化(2020/01/11)
-- 【优化】优化相册文件上传的体验，上传完成后自动刷新
-- 【优化】笔记索引更新的性能问题
-- 【优化】设置功能的交互优化
-- 【优化】编辑器适配移动端
-- 【修复】搜索历史的字符转义问题
-- 【修复】字典搜索翻页问题。
-- 【更新】字典功能设置成默认关闭的
-
-# v2.4 (2019.08.05~2019.11.30)
-- 优化Markdown文档目录
-- 文件浏览模式优化（操作选项组织到一个下拉列表中）
-- 支持Python 3.7
-- 支持Windows的64位版本
-- 新增评论功能
-- 笔记的详情页在PC上面分三栏展示，分别是菜单、目录、正文
-- 采用font-awesome，大幅优化交互体验
-- 相册的路径优化，放在`files/<userName>`目录下，以id作为文件夹名称，归档到`files/<userName>/gallery/<id后两位>/<id>`
-- CSS模块化
-- 归档笔记的功能，归档之后的笔记本放入统一的大类【已归档】，就是不活跃的笔记，多用于工作记录之类的。
-- 批量移动笔记功能
-- 待办功能的优化: 1. 增加更多的tab页; 2. 显示各个分类的数量 3. 增加话题模式
-- 插件支持二级目录
-
-# v2.3 (2019.04.01~2019.08.04)
-- [x] 数据库更新为leveldb，主要考虑到以下几点
-    - sqlite在SAE上面运行缓慢（可能是共享存储的seek性能较差，替换成leveldb之后性能大幅提升）
-    - 没有关系型数据的模式限制，更加灵活
-    - KV存储的替代方案非常多，只需要支持Get/Put/Scan/Delete四种操作即可，自己实现一个都可以
-    - 支持大规模数据，做水平扩展方便
-    - 性能调优也比较方便，通过冗余设计即可，相比于关系型数据库的复杂程度，KV数据库简直不要太简单。
-- [x] 上传文件管理功能
-    - 普通用户可以使用
-    - 支持上传、重命名、删除、搜索
-- [x] 笔记修改记录
-- [x] 笔记按月归档
-- [x] 笔记置顶功能
-- [x] 导航调整，【更多】改成【系统】，专注于设置和系统管理。
-- [x] 导航调整，【插件】改成【工具】
-- [x] 提醒记录IP信息
-- [x] 删除自定义菜单导航功能
-- [x] 支持相册类型的笔记
-- [x] 界面优化
-
-# v2.2 (2018.12.16~2019.03.31)
-- [x] Add 导航菜单配置化
-- [x] Add 电子表格功能，基于jexcel
-- [x] Add 词典编辑功能，仅管理员可用
-- [x] Add 笔记的历史版本记录（界面功能暂未完成）
-- [x] Improve 首页信息聚合，使操作更加快捷
-- [x] Improve 文件管理器，支持批量删除、批量粘贴
-- [x] Improve 代码编辑器，支持自动补全
-- [x] Refactor 缓存目录从`etc`改为`storage`
-- [x] 定义插件分类，在不同的场景展示响应分类的插件作为扩展功能。
-    - 文件管理器选项增加更多的文件处理方式。插件需要显示列表让用户选择一个。
-- [x] 规范文件上传生成的文件名，`类型@用户@文件名@时间.后缀名`
-
-
-# v2.1 (2018.09.16~2018.12.15)
-- [x] Fix 清空剪切板功能
-- [x] 文件管理器预览模式
-- [x] 卡片式布局、切换主题
-- [x] 插件的优化，应用启动时初始化，生产环境执行代码缓存
-- [x] 文本阅读器的优化，支持快捷键
-- [x] 系统设置集中化、支持在系统状态中切换调试状态、主题、语言等等
-- [x] 插件默认使用admin权限拦截
-- [x] 系统日志功能，实现了内存版的系统日志，还需要考虑持久化的问题
-- [x] 持久化搜索历史
-- [x] 增强cache的能力，使用json格式，增强通用性
-- [x] 多语言支持
-- [x] 笔记推荐系统接口
-- [x] 提醒支持hashtag
-- [x] 引入分词器
-
-# v2.0功能 (2018.07.04 - 2018.09.15)
-v2.0版本主要目标是增强扩展能力。
-
-- [x] 从模板创建插件，使用插件完成
-- [x] 插件的基类BasePlugin
-- [x] 最近使用的5个插件
-- [x] 缓存的持久化
-- [x] 首页性能提升
-- [x] file表做垂直拆分，内容移动到```note_content```表
-- [x] code/view\_source 限制文件大小(500K)，超过默认大小只展示部分内容，不允许修改
-- [x] 自定义CSS和JS脚本
-- [x] 修改文档的默认排序
-- [x] 编辑器TODO样式的优化
-- [x] 分页的优化
-- [x] 优化侧边栏
-- [x] 登录失败重试的限制
-- [x] 通过标签实现文档收藏的功能
-- [x] 文件管理的剪切粘贴功能
-
-
-
-# xnote v1.5 (2018.05.01 - 2018.07.03)
-
-- 新增
-    - [x] 扩展命令confirmed参数，input输入参数
-    - [x] 扩展命令不再显示按钮
-    - [x] 扩展命令支持html格式
-    - [x] 扩展命令的别名alias
-    - [x] 页面扩展scripts/pages
-    - [x] 借助iframe实现分屏功能，不需要在开多个窗口切换
-    - [x] 文件浏览器分栏模式
-    - [x] 文件自动分类，先按日期自动整理，通过插件完成
-    - [x] 笔记的数据报表-整体情况，环比，同比
-    - [x] 监听文档的新增、重命名事件，实时更新name的缓存
-    - [x] 搜索不强制要求登录，可以搜索公开的笔记
-    - [x] 浏览器标签页显示文档标题
-    - [x] 记录最近的访问记录，统计最近最常访问
-    - ~~Markdown的代码高亮，先做一个关键字的高亮，工作量不小而且要一直更新，放弃~~
-    - ~~支持流程图绘制，非核心功能，不做了，利用现有的工具~~
-    - ~~支持jsonview，非核心功能，放弃~~
-    - ~~TODO的快捷按钮，必要性不大，放弃~~
-
-- 更新
-    - [x] 主界面优化，增加侧边栏统计数据
-    - [x] 用户管理优化，左右分栏模式
-    - [x] 优化删除线按钮，已经加上删除线的再点击取消删除线
-
-- 修复
-    - [x] 若干API的错误
-    - [x] 扩展命令的编辑超链接
-    - [x] /fs\_shell链接异常, ```xutils.get_real_path``` 没有判断参数为None
-
-- 删除
-    - ```api/monitor_task```，似乎一直没有用过
-    - ```system/app_admin``` 使用文件管理即可
-    - ```code/code_format``` 没怎么用过
-    - ```tools/httpd``` 没什么用处
-    - ```tools/http_proxy``` 没什么用
-    - ```note/table.html``` 废弃
-
-- 命令
-    - [x] 事件监听器管理
-
-# xnote v1.4 (2018.02.09 - 2018.04.30)
-
-- 新增
-    - 新的网格首页和导航样式
-    - 添加自定义的工具链接，自定义存储 /system/storage?key=tools
-    - markdown编辑器【格式化表格】
-    - URL编解码工具
-    - 操作行为历史记录，限制200条
-
-- 更新
-    - 调整主界面的宽度，调整导航栏，突出搜索框
-    - 表格样式的统一优化
-    - 分页支持跳转到最后一页
-    - 公告的API支持wday
-    - handlers/file重命名为handlers/note
-    - 搜索优化，图书搜索移出默认操作，加快搜索速度
-    - markdown的图片居中
-
-- 修复
-    - utils.js的getUrlParams方法进行urldecode
-
-- 删除
-    - 脚本的搜索功能，没有必要，交互上也比较混乱，后续考虑全部复用公共搜索框
-
-
-# xnote v1.3.1 (2018.01.20 - 2018.02.08)
-
-- 新增功能
-    - 支持token的方式校验权限
-    - markdown编辑器上传图片压缩
-
-- BugFix
-    - Fix urlencode模式删除中文文件失败
-    - Fix 重命名权限
-    - Fix csv中文名预览
-
-# xnote v1.3 （2017.12.01 - 2018.01.19）
-
-缓存，搜索升级，性能优化，系统通知，代码规范
-
-
-- 新增功能
-    - [x] 指定启动脚本参数
-    - [x] 公告提醒，通过脚本配置
-    - [x] 系统配置项，使用启动脚本配置，不依赖数据库
-    - [x] 缓存支持
-    - [x] 统一规则定义
-
-- 优化更新
-    - [x] markdown编辑器体验优化，加粗、删除线等
-    - [x] 文章的重命名、删除移到浏览页面，编辑页面只保留内容修改
-    - [x] 优化搜索内部实现
-    - [x] 主页搜索加入文件系统搜索结果
-    - [x] 知识库列表优化，简化信息展示
-    - [x] 短消息中的资源文件放入files目录
-    - [x] 文件管理器优化，支持csv文件预览，txt文件阅读器，新增文件功能
-    - [x] 文件管理器urlencode不默认开启，通过启动参数来指定
-    - [x] 数据库搜索的性能优化
-
-# xnote v1.2 (2017.10.04-2017.11.30) 
-
-UI升级，分组，任务清单，系统升级
-
-1.2版本主要新增任务清单功能以及大量优化工作，主要如下
-
-- 新的功能——清单列表
-    - 由原来的留言板改造而来，复用message表
-    - 清单在用户之间是隔离的
-    - 清单有两个状态，进行中和完成
-    - 支持清单的添加、编辑和状态变更
-
-- 功能优化
-    - 使用侧边栏响应式，支持快捷访问，减少操作复杂度
-    - 交互上使用ajax提高体验，知识库保持静态化
-    - 增加分组类型
-    - 优化MD编辑器的样式
-    - ~~自动保存功能~~，考虑之后放弃
-    - 增加富文本编辑器
-    - 搜索优化，默认只搜索标题，减少无用信息
-    - 文件管理器优化，隐藏不常用功能按钮
-    - 支持无sqlite启动（主要为了支持jython），作为文件夹管理工具
-    - 定时任务优化，使用线程池而不是新开线程
-
-- 数据升级与兼容
-    - 本次升级可能会引起部分不兼容情况,README里说明了升级方案
-
-# xnote v1.1 (2017.07.20-2017.10.03) 
-
-**兼容，支持Python2、Jython**，这个版本主要是一些bugfix和对原有功能的优化
-
-- 系统增强
-    - [x] 警告定义跨目录的url-pattern，避免覆盖
-    - [x] 脚本管理支持添加自定义Python脚本，支持输出到web页面
-    - [x] 定时任务支持自定义脚本`script://{script_name}`
-    - [x] UI交互优化，原来的系统页面从简单的列表优化成分类块
- 
-- Python2 兼容
-    - [x] markdown编辑器
-    - [x] 搜索
-    - [x] 其他工具
- 
-- 编辑器优化
-    - [x] 保存按钮优化
- 
-- 文件浏览器升级
-    - [x] 预览图片
-    - [x] 文件搜索
-    - [x] 新建文件夹
- 
-- 工具
-    - [x] 留言板功能
-    - [x] 图片合并工具
-    - [x] 图片分离工具
-
-# xnote v1.0 (2016.12.04~2017.07.19)
-- [x] 资料查看、编辑、搜索
-- [x] 文件浏览器
-- [x] 定时任务
-- [x] 日历关联创建的资料
-- [x] 日历显示当月添加的资料，按照时间倒序排列
-- [x] 记录访问日志
-- [x] 备份功能优化，包括导入导出，按月份导入导出（集成在文件管理的压缩功能）
-- [x] WebUploader
-- [x] 语音提醒，静音功能
+# v2.9.6 (2023.10.28~2024.05.18)
+
+- 笔记管理
+    - [x] 支持在查看页面编辑csv表格
+    - [x] P1-草稿管理，支持单独查看和删除草稿
+    - [x] 关联到日历的功能（关联到月度计划）
+- 笔记本
+    - [x] 支持时间线的视图
+- 插件
+    - [x] 支持通过pip模块的方式开发和安装插件
+    - [x] 支持表格组件
+- 文件管理
+    - [x] 优化侧边栏模式
+- UI优化&菜单
+- 系统功能
+    - [x] 混合数据库(SQL索引+KV存储)
+    - [x] 支持translate.js，可以通过 `ui_show_translate_js` 配置开启
+    - [x] P2-开发一套插件打包发布的流程。可以在本地开发测试，然后发布到远程服务器。
+    - [x] 支持在线升级的功能 (需要基于git)
+
+
+# v2.9.5 (2023.07.01~2023.10.27)
+
+- 待办&随手记
+    - [x] 随手记的备注功能（类似于评论的回复）
+    - [x] 隔离随手记和待办任务
+    - [x] 支持文字强调标记
+- 笔记管理
+    - [x] 支持代码高亮
+    - [x] Fix标签关联的笔记列表排序
+    - [x] Fix笔记本搜索
+- 文件管理
+    - [x] 优化侧边栏模式
+- 系统功能
+    - [x] 支持作为模块(xnote-web)发布到pip
+    - [x] 插件支持 plugin_id 唯一标识，支持本地开发远程部署
+    - [x] 支持sql数据库的binlog同步
+    - [x] 笔记、评论、随手记拆分成sql存储索引，kv存储主数据
+    - [x] 移动tornado模板库到`xutils`模块
+    - [x] kv数据库添加`ssdb`的驱动
+    - [x] P1-上传文件要更新binlog
+    - [x] SQL数据库支持只读状态
+
+
+# v2.9.4 (2023.03.05~2023.06.30)
+
+- 笔记管理
+    - [x] 标签上批量添加笔记
+    - [x] 点击标签，筛选出全部包含标签的笔记（而不是当前笔记本的）
+- 随手记
+    - [x] 支持文字高亮
+- 文件管理
+    - [x] 优化了代码编辑器的交互，使用ajax来更新数据
+- UI优化&菜单
+    - [x] 未登录状态下展示应用列表链接
+    - [x] 支持侧边栏的样式，提高屏幕的空间使用率
+- 系统功能
+    - [x] 增强作为web框架的功能
+    - [x] 数据库支持联合索引
+    - [x] 数据库支持where条件查询
+    - [x] 优化关系型数据库接口
+    - [x] 账号安全性提升
+    - [x] Fix若干个漏洞
+
+# v2.9.3 (2022.11.28~2023.03.04)
+
+- 待办&随手记
+    - [x] 优化标签选择功能
+- 笔记管理
+    - [x] 使用单独的表记录笔记更新历史列表
+    - [x] 优化相册ui
+    - [x] 笔记复制的功能
+    - [x] 支持月度计划
+    - [x] 支持系统标签（可以跨越笔记本全局可用）
+    - [x] 发送笔记到待办任务，通过系统标签的方式支持
+- 笔记本
+    - [x] 增加排序的选项
+- UI优化
+    - [x] PC页面更多的使用左右分栏，提升效率
+- 系统功能
+    - [x] 修复了前端资源缓存的问题
+    - [x] 优化缩略图生成逻辑
+
+# v2.9.2 (2022.07.31~2022.11.27)
+
+- 笔记管理
+    - [x] 支持笔记编辑页目录跳转
+    - 笔记标签管理
+        - [x] 创建时绑定标签
+        - [x] 单个笔记绑定标签
+        - [x] 批量绑定标签
+    - [x] 优化移动端编辑器的插入图片操作，直接插入到光标后面
+- 笔记本
+    - [x] 新增按钮下可以创建标签或者子章节，通过标签的功能实现了
+    - [x] 笔记本标签
+- 搜索功能
+    - [x] 搜索历史展示5个热门关键字，其余按照最近搜索展示
+- 系统功能
+    - [x] 外部资源缓存功能，防止导入的资料中临时链接失效导致图片无法访问
+    - [x] 数据库自增ID优化
+    - [x] 统计请求服务端耗时
+    - [x] 数据库管理工具增加用户筛选条件,优化搜索功能
+    - [x] 文件变更记录到binlog
+    - [x] 查看图片支持旋转
+    - [x] 数据库支持mysql，并且做了针对性的缓存优化+批量查询优化(不然性能太差了。。。)
+- BugFix
+    - [x] Windows平台 Python3.7 环境下的 urlopen 函数有内存泄漏风险，安装 requests 可以解决这个问题
+
+# v2.9.1 (2022.02.21~2022.07.17)
+
+- 随手记
+    - [x] 侧边栏展示常用的标签
+- 笔记管理
+    - [x] 不允许admin修改其他账号的笔记
+    - [x] 并发编辑保护。
+        - 编辑过程中自动保存草稿。打开编辑的时候自动加载草稿，并且编辑器上予以提示，提交修改后自动删除草稿内容
+        - 编辑的时候需要申请编辑锁。如果没有成功获取锁，不允许编辑
+    - [x] 优化了表格编辑功能：可以自己调整表格宽度，支持中文菜单
+    - [x] 侧边栏可以支持查看同级别的其他笔记 04/23
+- 评论
+    - [x] 笔记详情设置是否允许编辑评论
+    - [x] 支持自定义设置Markdown预览的默认状态
+- 笔记本
+    - [x] 笔记本列表排序功能（2022/03/06）
+    - [x] 支持笔记本类目属性
+    - [x] 支持笔记本层级
+- 搜索功能
+    - [x] 支持搜索相关词，可以通过后台配置相关词
+- 系统功能
+    - [x] 支持词库配置
+    - [x] 守护进程和工作进程分离，支持远程重启
+    - [x] 启动参数支持配置leveldb的缓存大小
+    - [x] 优化内存的使用,调整了缓存大小和打开的文件数量参数
+    - [x] 数据库备份导入导出功能
+    - [x] 数据库支持多驱动(leveldb/leveldbpy/sqlite/lmdb)
+    - [x] 数据库索引管理
+    - [x] 实现双端队列
+- BUG修复
+    - [x] 笔记本删除的功能入口没了
+    - [x] 评论里面的编辑页面上传文件有BUG，功能错位到了主输入框
+
+# v2.8 (2021.06.28~2022.02.20)
+
+- 菜单导航和布局
+    - [x] 【优化】导航配置化
+    - [x] 【优化】优化移动端布局适配
+- Markdown编辑器
+    - [x] 【优化】移动版编辑器优化
+    - [x] 【新增】支持插入笔记内链(2022/02/07)
+    - [x] 【优化】支持待办项状态切换
+- 清单列表编辑器
+    - [x] 【新增】支持内容编辑
+- 插件功能
+    - [x] 【新增】支持@header注解的方式配置（类似于GM脚本）
+    - [x] 【新增】支持按热度和最近访问进行排序
+    - [x] 【新增】新增表单模板
+- 系统功能
+    - [x] 【新增】用户操作日志
+    - [x] 【修复】修复Cookie的有效期
+    - [x] 【新增】主从同步初版(基于文件)
+    - [x] 【新增】LdbTable功能开发，支持索引
+
+# v2.7 (2020.11.13~2021.06.27)
+- 【新增】支持首页内容配置，链接保持不变
+- 【修复】`urlsafe_b64`格式的编解码
+- 【优化】随手记功能优化
+    - 新增书籍、电话、人物(@)的识别
+    - 选择标签功能优化
+    - 标签支持按照访问量排序
+    - 支持按天查看随手记
+- 【优化】搜索功能优化，笔记、词典的搜索统一到综合搜索里面
+- 【优化】优化笔记的时间视图，增加年报、月报功能
+- 【优化】支持webdav功能（当前仅限admin用户）
+- 【优化】代码编辑器的搜索功能
+- 【优化】优化卡片布局
+
+
+# v2.6 (2020.05.23~2020.11.12)
+- 【优化】markdown编辑页面上传文件的时候加loading蒙版，防止误操作
+- 【优化】统一整个交互页面，优化前进返回的交互
+- 【优化】公共笔记右侧加一个按钮【分享】，可以通过搜索分享我的笔记。
+- 【优化】最近常用优化成相对的统计
+- 【修复】创建笔记的项目列表排序是乱序的 2020.07.11
+- 【优化】“最近”板块优化成“动态”，把所有动态聚合在一起，添加筛选条件
+- 【优化】行内代码的高亮
+- 【优化】文件上传校验
+- 【优化】插件的代码逻辑优化，界面优化
+- 【优化】dbutil新增`register_table`方法，写入数据前要注册数据表的信息
+- 【优化】分页组件样式
+- 【优化】文件管理器的样式
+- 【优化】目录的样式
+
+# v2.5 (2019.12.01~2020.05.22)
+- 【新增】链接分享功能，在笔记详情页，更多可以开启。
+- 【新增】新增笔记类型：日志，系统生成默认标题，不进行标题的唯一性检验。
+- 【新增】笔记的DAO层增加一个`list_by_func`方法
+- 【新增】批量管理项目功能
+- 【新增】更新和查看笔记的操作日志
+- 【优化】支持Python3.8
+- 【优化】大范围的重构，消除冗余代码，提高测试的覆盖率
+- 【优化】笔记本改造成项目，项目列表和项目里的笔记列表都以时间轴视图呈现。
+- 【优化】项目内批量移动功能，移动笔记时支持搜索项目
+- 【优化】按月查看的日期格式优化(2020/01/11)
+- 【优化】优化相册文件上传的体验，上传完成后自动刷新
+- 【优化】笔记索引更新的性能问题
+- 【优化】设置功能的交互优化
+- 【优化】编辑器适配移动端
+- 【修复】搜索历史的字符转义问题
+- 【修复】字典搜索翻页问题。
+- 【更新】字典功能设置成默认关闭的
+
+# v2.4 (2019.08.05~2019.11.30)
+- 优化Markdown文档目录
+- 文件浏览模式优化（操作选项组织到一个下拉列表中）
+- 支持Python 3.7
+- 支持Windows的64位版本
+- 新增评论功能
+- 笔记的详情页在PC上面分三栏展示，分别是菜单、目录、正文
+- 采用font-awesome，大幅优化交互体验
+- 相册的路径优化，放在`files/<userName>`目录下，以id作为文件夹名称，归档到`files/<userName>/gallery/<id后两位>/<id>`
+- CSS模块化
+- 归档笔记的功能，归档之后的笔记本放入统一的大类【已归档】，就是不活跃的笔记，多用于工作记录之类的。
+- 批量移动笔记功能
+- 待办功能的优化: 1. 增加更多的tab页; 2. 显示各个分类的数量 3. 增加话题模式
+- 插件支持二级目录
+
+# v2.3 (2019.04.01~2019.08.04)
+- [x] 数据库更新为leveldb，主要考虑到以下几点
+    - sqlite在SAE上面运行缓慢（可能是共享存储的seek性能较差，替换成leveldb之后性能大幅提升）
+    - 没有关系型数据的模式限制，更加灵活
+    - KV存储的替代方案非常多，只需要支持Get/Put/Scan/Delete四种操作即可，自己实现一个都可以
+    - 支持大规模数据，做水平扩展方便
+    - 性能调优也比较方便，通过冗余设计即可，相比于关系型数据库的复杂程度，KV数据库简直不要太简单。
+- [x] 上传文件管理功能
+    - 普通用户可以使用
+    - 支持上传、重命名、删除、搜索
+- [x] 笔记修改记录
+- [x] 笔记按月归档
+- [x] 笔记置顶功能
+- [x] 导航调整，【更多】改成【系统】，专注于设置和系统管理。
+- [x] 导航调整，【插件】改成【工具】
+- [x] 提醒记录IP信息
+- [x] 删除自定义菜单导航功能
+- [x] 支持相册类型的笔记
+- [x] 界面优化
+
+# v2.2 (2018.12.16~2019.03.31)
+- [x] Add 导航菜单配置化
+- [x] Add 电子表格功能，基于jexcel
+- [x] Add 词典编辑功能，仅管理员可用
+- [x] Add 笔记的历史版本记录（界面功能暂未完成）
+- [x] Improve 首页信息聚合，使操作更加快捷
+- [x] Improve 文件管理器，支持批量删除、批量粘贴
+- [x] Improve 代码编辑器，支持自动补全
+- [x] Refactor 缓存目录从`etc`改为`storage`
+- [x] 定义插件分类，在不同的场景展示响应分类的插件作为扩展功能。
+    - 文件管理器选项增加更多的文件处理方式。插件需要显示列表让用户选择一个。
+- [x] 规范文件上传生成的文件名，`类型@用户@文件名@时间.后缀名`
+
+
+# v2.1 (2018.09.16~2018.12.15)
+- [x] Fix 清空剪切板功能
+- [x] 文件管理器预览模式
+- [x] 卡片式布局、切换主题
+- [x] 插件的优化，应用启动时初始化，生产环境执行代码缓存
+- [x] 文本阅读器的优化，支持快捷键
+- [x] 系统设置集中化、支持在系统状态中切换调试状态、主题、语言等等
+- [x] 插件默认使用admin权限拦截
+- [x] 系统日志功能，实现了内存版的系统日志，还需要考虑持久化的问题
+- [x] 持久化搜索历史
+- [x] 增强cache的能力，使用json格式，增强通用性
+- [x] 多语言支持
+- [x] 笔记推荐系统接口
+- [x] 提醒支持hashtag
+- [x] 引入分词器
+
+# v2.0功能 (2018.07.04 - 2018.09.15)
+v2.0版本主要目标是增强扩展能力。
+
+- [x] 从模板创建插件，使用插件完成
+- [x] 插件的基类BasePlugin
+- [x] 最近使用的5个插件
+- [x] 缓存的持久化
+- [x] 首页性能提升
+- [x] file表做垂直拆分，内容移动到```note_content```表
+- [x] code/view\_source 限制文件大小(500K)，超过默认大小只展示部分内容，不允许修改
+- [x] 自定义CSS和JS脚本
+- [x] 修改文档的默认排序
+- [x] 编辑器TODO样式的优化
+- [x] 分页的优化
+- [x] 优化侧边栏
+- [x] 登录失败重试的限制
+- [x] 通过标签实现文档收藏的功能
+- [x] 文件管理的剪切粘贴功能
+
+
+
+# xnote v1.5 (2018.05.01 - 2018.07.03)
+
+- 新增
+    - [x] 扩展命令confirmed参数，input输入参数
+    - [x] 扩展命令不再显示按钮
+    - [x] 扩展命令支持html格式
+    - [x] 扩展命令的别名alias
+    - [x] 页面扩展scripts/pages
+    - [x] 借助iframe实现分屏功能，不需要在开多个窗口切换
+    - [x] 文件浏览器分栏模式
+    - [x] 文件自动分类，先按日期自动整理，通过插件完成
+    - [x] 笔记的数据报表-整体情况，环比，同比
+    - [x] 监听文档的新增、重命名事件，实时更新name的缓存
+    - [x] 搜索不强制要求登录，可以搜索公开的笔记
+    - [x] 浏览器标签页显示文档标题
+    - [x] 记录最近的访问记录，统计最近最常访问
+    - ~~Markdown的代码高亮，先做一个关键字的高亮，工作量不小而且要一直更新，放弃~~
+    - ~~支持流程图绘制，非核心功能，不做了，利用现有的工具~~
+    - ~~支持jsonview，非核心功能，放弃~~
+    - ~~TODO的快捷按钮，必要性不大，放弃~~
+
+- 更新
+    - [x] 主界面优化，增加侧边栏统计数据
+    - [x] 用户管理优化，左右分栏模式
+    - [x] 优化删除线按钮，已经加上删除线的再点击取消删除线
+
+- 修复
+    - [x] 若干API的错误
+    - [x] 扩展命令的编辑超链接
+    - [x] /fs\_shell链接异常, ```xutils.get_real_path``` 没有判断参数为None
+
+- 删除
+    - ```api/monitor_task```，似乎一直没有用过
+    - ```system/app_admin``` 使用文件管理即可
+    - ```code/code_format``` 没怎么用过
+    - ```tools/httpd``` 没什么用处
+    - ```tools/http_proxy``` 没什么用
+    - ```note/table.html``` 废弃
+
+- 命令
+    - [x] 事件监听器管理
+
+# xnote v1.4 (2018.02.09 - 2018.04.30)
+
+- 新增
+    - 新的网格首页和导航样式
+    - 添加自定义的工具链接，自定义存储 /system/storage?key=tools
+    - markdown编辑器【格式化表格】
+    - URL编解码工具
+    - 操作行为历史记录，限制200条
+
+- 更新
+    - 调整主界面的宽度，调整导航栏，突出搜索框
+    - 表格样式的统一优化
+    - 分页支持跳转到最后一页
+    - 公告的API支持wday
+    - handlers/file重命名为handlers/note
+    - 搜索优化，图书搜索移出默认操作，加快搜索速度
+    - markdown的图片居中
+
+- 修复
+    - utils.js的getUrlParams方法进行urldecode
+
+- 删除
+    - 脚本的搜索功能，没有必要，交互上也比较混乱，后续考虑全部复用公共搜索框
+
+
+# xnote v1.3.1 (2018.01.20 - 2018.02.08)
+
+- 新增功能
+    - 支持token的方式校验权限
+    - markdown编辑器上传图片压缩
+
+- BugFix
+    - Fix urlencode模式删除中文文件失败
+    - Fix 重命名权限
+    - Fix csv中文名预览
+
+# xnote v1.3 （2017.12.01 - 2018.01.19）
+
+缓存，搜索升级，性能优化，系统通知，代码规范
+
+
+- 新增功能
+    - [x] 指定启动脚本参数
+    - [x] 公告提醒，通过脚本配置
+    - [x] 系统配置项，使用启动脚本配置，不依赖数据库
+    - [x] 缓存支持
+    - [x] 统一规则定义
+
+- 优化更新
+    - [x] markdown编辑器体验优化，加粗、删除线等
+    - [x] 文章的重命名、删除移到浏览页面，编辑页面只保留内容修改
+    - [x] 优化搜索内部实现
+    - [x] 主页搜索加入文件系统搜索结果
+    - [x] 知识库列表优化，简化信息展示
+    - [x] 短消息中的资源文件放入files目录
+    - [x] 文件管理器优化，支持csv文件预览，txt文件阅读器，新增文件功能
+    - [x] 文件管理器urlencode不默认开启，通过启动参数来指定
+    - [x] 数据库搜索的性能优化
+
+# xnote v1.2 (2017.10.04-2017.11.30) 
+
+UI升级，分组，任务清单，系统升级
+
+1.2版本主要新增任务清单功能以及大量优化工作，主要如下
+
+- 新的功能——清单列表
+    - 由原来的留言板改造而来，复用message表
+    - 清单在用户之间是隔离的
+    - 清单有两个状态，进行中和完成
+    - 支持清单的添加、编辑和状态变更
+
+- 功能优化
+    - 使用侧边栏响应式，支持快捷访问，减少操作复杂度
+    - 交互上使用ajax提高体验，知识库保持静态化
+    - 增加分组类型
+    - 优化MD编辑器的样式
+    - ~~自动保存功能~~，考虑之后放弃
+    - 增加富文本编辑器
+    - 搜索优化，默认只搜索标题，减少无用信息
+    - 文件管理器优化，隐藏不常用功能按钮
+    - 支持无sqlite启动（主要为了支持jython），作为文件夹管理工具
+    - 定时任务优化，使用线程池而不是新开线程
+
+- 数据升级与兼容
+    - 本次升级可能会引起部分不兼容情况,README里说明了升级方案
+
+# xnote v1.1 (2017.07.20-2017.10.03) 
+
+**兼容，支持Python2、Jython**，这个版本主要是一些bugfix和对原有功能的优化
+
+- 系统增强
+    - [x] 警告定义跨目录的url-pattern，避免覆盖
+    - [x] 脚本管理支持添加自定义Python脚本，支持输出到web页面
+    - [x] 定时任务支持自定义脚本`script://{script_name}`
+    - [x] UI交互优化，原来的系统页面从简单的列表优化成分类块
+ 
+- Python2 兼容
+    - [x] markdown编辑器
+    - [x] 搜索
+    - [x] 其他工具
+ 
+- 编辑器优化
+    - [x] 保存按钮优化
+ 
+- 文件浏览器升级
+    - [x] 预览图片
+    - [x] 文件搜索
+    - [x] 新建文件夹
+ 
+- 工具
+    - [x] 留言板功能
+    - [x] 图片合并工具
+    - [x] 图片分离工具
+
+# xnote v1.0 (2016.12.04~2017.07.19)
+- [x] 资料查看、编辑、搜索
+- [x] 文件浏览器
+- [x] 定时任务
+- [x] 日历关联创建的资料
+- [x] 日历显示当月添加的资料，按照时间倒序排列
+- [x] 记录访问日志
+- [x] 备份功能优化，包括导入导出，按月份导入导出（集成在文件管理的压缩功能）
+- [x] WebUploader
+- [x] 语音提醒，静音功能
 - [x] 时光轴
```

### Comparing `xnote-web-0.1.0/docs/code_style.md` & `xnote-web-0.1.1/docs/code_style.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/code_style_css.md` & `xnote-web-0.1.1/docs/code_style_css.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/commands.md` & `xnote-web-0.1.1/docs/commands.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/database.md` & `xnote-web-0.1.1/docs/database.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/db_migrate.md` & `xnote-web-0.1.1/docs/db_migrate.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/plugins.md` & `xnote-web-0.1.1/docs/plugins.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/architecture.png` & `xnote-web-0.1.1/docs/screenshots/architecture.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/architecture.svg` & `xnote-web-0.1.1/docs/screenshots/architecture.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/architecture_2.png` & `xnote-web-0.1.1/docs/screenshots/architecture_2.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/command_listdir.png` & `xnote-web-0.1.1/docs/screenshots/command_listdir.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/command_rmfolder.png` & `xnote-web-0.1.1/docs/screenshots/command_rmfolder.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/screenshot01.png` & `xnote-web-0.1.1/docs/screenshots/screenshot01.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/screenshot02.png` & `xnote-web-0.1.1/docs/screenshots/screenshot02.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/screenshot03.png` & `xnote-web-0.1.1/docs/screenshots/screenshot03.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/task_web.PNG` & `xnote-web-0.1.1/docs/screenshots/task_web.PNG`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.2_editor.PNG` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.2_editor.PNG`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.2_list.PNG` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.2_list.PNG`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.2_mobile.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.2_mobile.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.2_search.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.2_search.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.3_desktop01.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.3_desktop01.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.4.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.4.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v1.5.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v1.5.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.0.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.0.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.1_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.1_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.2_20190331.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.2_20190331.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.3_20190411.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.3_20190411.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.3_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.3_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.4_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.4_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.4_home2.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.4_home2.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.5_20200502.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.5_20200502.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.5_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.5_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.5_recent.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.5_recent.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.6_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.6_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.7_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.7_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.8_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.8_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v2.9.2_home.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v2.9.2_home.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote_v20191111.png` & `xnote-web-0.1.1/docs/screenshots/xnote_v20191111.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/docs/screenshots/xnote架构.png` & `xnote-web-0.1.1/docs/screenshots/xnote架构.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/admin/job_admin.py` & `xnote-web-0.1.1/handlers/admin/job_admin.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,170 +1,170 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-03-10 22:56:56
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-20 16:50:19
-@FilePath     : /xnote/handlers/admin/job_admin.py
-@Description  : 描述
-"""
-import time
-from xnote.core.xtemplate import BasePlugin
-from xutils import Storage
-from xutils import webutil
-from xnote.plugin import DataTable, DataForm
-from xnote.service import JobService, SysJob, JobStatusEnum
-from xnote.core import xauth
-from xutils import dateutil
-import xutils
-import json
-
-HTML = r"""
-<div class="card">
-    {% include common/table/table.html %}
-</div>
-
-<div class="card">
-    {% include common/pagination.html %}
-</div>
-"""
-
-ASIDE_HTML = """
-{% include system/component/admin_nav.html %}
-"""
-
-VIEW_HTML = """
-<div class="card">
-    <textarea class="row" rows=20>{{job_info}}</textarea>
-</div>
-"""
-
-VIEW_FORM_HTML = """
-{% include common/form/form.html %}
-"""
-
-class JobHandler(BasePlugin):
-    
-    title = '任务管理'
-    show_edit = False
-    rows = 0
-    
-    def handle_view(self):
-        self.show_nav = False
-        self.show_title = False
-        
-        job_id = xutils.get_argument_int("job_id")
-        job_info = JobService.get_job_by_id(job_id=job_id)
-        kw = Storage()
-        kw.job_info = xutils.tojson(xutils.obj2dict(job_info), format=True)
-        self.writehtml(VIEW_HTML, **kw)
-        self.write_aside(ASIDE_HTML) 
-
-    def handle_edit(self):
-        self.show_nav = False
-        self.show_title = False
-        
-        job_id = xutils.get_argument_int("job_id")
-        job_info = JobService.get_job_by_id(job_id=job_id)
-        kw = Storage()
-        kw.job_info = xutils.tojson(xutils.obj2dict(job_info), format=True)
-
-        if job_info != None:
-            form = DataForm()
-            form.add_row("ID", "id", value=str(job_info.id), readonly=True)
-            form.add_row("创建时间", "ctime", value=job_info.ctime, readonly=True)
-            form.add_row("更新时间", "mtime", value=job_info.mtime, readonly=True)
-            
-            row = form.add_row("任务类型", "job_type", value=str(job_info.job_type), type="select")
-            row.add_option("数据库备份", "db_backup")
-            row.add_option("测试", "test")
-            
-            form.add_row("任务参数", "job_params", value=job_info.job_params, type="textarea")
-            form.add_row("任务结果", "job_result", value=job_info.job_result, type="textarea")
-            kw.form = form
-        
-        return self.response_ajax(VIEW_FORM_HTML, **kw)
-        
-    def handle_delete(self):
-        job_id = xutils.get_argument_int("job_id")
-        JobService.delete_by_id(job_id=job_id)
-        return webutil.SuccessResult()
-    
-    def handle_save(self):
-        data_json = xutils.get_argument_str("data")
-        data_dict = json.loads(data_json)
-        
-        job_id = data_dict.get("id")
-        job_info = JobService.get_job_by_id(job_id=job_id)
-        if job_info == None:
-            return webutil.FailedResult(code="404", message="数据不存在")
-
-
-        job_info.job_type = data_dict.get("job_type")
-        JobService.update_job(job_info)
-        return webutil.SuccessResult()
-
-    def handle(self, content):
-        action = xutils.get_argument_str("action")
-        
-        if action == "view":
-            return self.handle_view()
-        if action == "edit":
-            return self.handle_edit()
-        if action == "save":
-            return self.handle_save()
-        if action == "delete":
-            return self.handle_delete()
-        
-        page = xutils.get_argument_int("page", 1)
-        page_size = 20
-        
-        assert page >= 1
-        
-        table = DataTable()
-        table.add_head("ID", "id", width="10%")
-        table.add_head("更新时间", "mtime", width="20%")
-        table.add_head("任务类型", "job_type", width="20%")
-        table.add_head("任务状态", "status_title", width="20%")
-        
-        table.add_action("查看详情", link_field="view_url")
-        table.add_action("编辑", link_field="edit_url", type="edit_form")
-        table.add_action("删除", type="confirm", link_field="delete_url", msg_field="delete_msg", css_class="btn danger")
-        
-        job_list, total = JobService.list_job_page(offset=(page-1)*page_size, limit=page_size)
-        
-        for job_info in job_list:
-            row = job_info.__dict__
-            row["status_title"] = JobStatusEnum.get_title_by_status(job_info.job_status)
-            row["view_url"] = f"?action=view&job_id={job_info.id}"
-            row["edit_url"] = f"?action=edit&job_id={job_info.id}"
-            row["delete_url"] = f"?action=delete&job_id={job_info.id}"
-            row["delete_msg"] = f"确认删除记录【{job_info.id}】吗?"
-            table.add_row(row)
-        
-        pagination = webutil.Pagination(page=1, total=total)
-        kw = Storage()
-        kw.table = table
-        kw.page = page
-        kw.page_max = pagination.page_max
-        kw.page_url = "?page="
-        
-        self.writehtml(HTML, **kw)
-        self.write_aside(ASIDE_HTML)
-    
-class JobTestHandler:
-    
-    @xauth.login_required("admin")
-    def GET(self):
-        job_info = SysJob()
-        job_info.job_type = "test"
-        with JobService.run_with_job(job_info):
-            time.sleep(1)
-            job_info.job_result = "success"
-            job_info.mtime = dateutil.format_datetime()
-        return webutil.SuccessResult()
-    
-xurls = (
-    r"/admin/jobs", JobHandler,
-    r"/admin/test_job", JobTestHandler
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-03-10 22:56:56
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-20 16:50:19
+@FilePath     : /xnote/handlers/admin/job_admin.py
+@Description  : 描述
+"""
+import time
+from xnote.core.xtemplate import BasePlugin
+from xutils import Storage
+from xutils import webutil
+from xnote.plugin import DataTable, DataForm
+from xnote.service import JobService, SysJob, JobStatusEnum
+from xnote.core import xauth
+from xutils import dateutil
+import xutils
+import json
+
+HTML = r"""
+<div class="card">
+    {% include common/table/table.html %}
+</div>
+
+<div class="card">
+    {% include common/pagination.html %}
+</div>
+"""
+
+ASIDE_HTML = """
+{% include system/component/admin_nav.html %}
+"""
+
+VIEW_HTML = """
+<div class="card">
+    <textarea class="row" rows=20>{{job_info}}</textarea>
+</div>
+"""
+
+VIEW_FORM_HTML = """
+{% include common/form/form.html %}
+"""
+
+class JobHandler(BasePlugin):
+    
+    title = '任务管理'
+    show_edit = False
+    rows = 0
+    
+    def handle_view(self):
+        self.show_nav = False
+        self.show_title = False
+        
+        job_id = xutils.get_argument_int("job_id")
+        job_info = JobService.get_job_by_id(job_id=job_id)
+        kw = Storage()
+        kw.job_info = xutils.tojson(xutils.obj2dict(job_info), format=True)
+        self.writehtml(VIEW_HTML, **kw)
+        self.write_aside(ASIDE_HTML) 
+
+    def handle_edit(self):
+        self.show_nav = False
+        self.show_title = False
+        
+        job_id = xutils.get_argument_int("job_id")
+        job_info = JobService.get_job_by_id(job_id=job_id)
+        kw = Storage()
+        kw.job_info = xutils.tojson(xutils.obj2dict(job_info), format=True)
+
+        if job_info != None:
+            form = DataForm()
+            form.add_row("ID", "id", value=str(job_info.id), readonly=True)
+            form.add_row("创建时间", "ctime", value=job_info.ctime, readonly=True)
+            form.add_row("更新时间", "mtime", value=job_info.mtime, readonly=True)
+            
+            row = form.add_row("任务类型", "job_type", value=str(job_info.job_type), type="select")
+            row.add_option("数据库备份", "db_backup")
+            row.add_option("测试", "test")
+            
+            form.add_row("任务参数", "job_params", value=job_info.job_params, type="textarea")
+            form.add_row("任务结果", "job_result", value=job_info.job_result, type="textarea")
+            kw.form = form
+        
+        return self.response_ajax(VIEW_FORM_HTML, **kw)
+        
+    def handle_delete(self):
+        job_id = xutils.get_argument_int("job_id")
+        JobService.delete_by_id(job_id=job_id)
+        return webutil.SuccessResult()
+    
+    def handle_save(self):
+        data_json = xutils.get_argument_str("data")
+        data_dict = json.loads(data_json)
+        
+        job_id = data_dict.get("id")
+        job_info = JobService.get_job_by_id(job_id=job_id)
+        if job_info == None:
+            return webutil.FailedResult(code="404", message="数据不存在")
+
+
+        job_info.job_type = data_dict.get("job_type")
+        JobService.update_job(job_info)
+        return webutil.SuccessResult()
+
+    def handle(self, content):
+        action = xutils.get_argument_str("action")
+        
+        if action == "view":
+            return self.handle_view()
+        if action == "edit":
+            return self.handle_edit()
+        if action == "save":
+            return self.handle_save()
+        if action == "delete":
+            return self.handle_delete()
+        
+        page = xutils.get_argument_int("page", 1)
+        page_size = 20
+        
+        assert page >= 1
+        
+        table = DataTable()
+        table.add_head("ID", "id", width="10%")
+        table.add_head("更新时间", "mtime", width="20%")
+        table.add_head("任务类型", "job_type", width="20%")
+        table.add_head("任务状态", "status_title", width="20%")
+        
+        table.add_action("查看详情", link_field="view_url")
+        table.add_action("编辑", link_field="edit_url", type="edit_form")
+        table.add_action("删除", type="confirm", link_field="delete_url", msg_field="delete_msg", css_class="btn danger")
+        
+        job_list, total = JobService.list_job_page(offset=(page-1)*page_size, limit=page_size)
+        
+        for job_info in job_list:
+            row = job_info.__dict__
+            row["status_title"] = JobStatusEnum.get_title_by_status(job_info.job_status)
+            row["view_url"] = f"?action=view&job_id={job_info.id}"
+            row["edit_url"] = f"?action=edit&job_id={job_info.id}"
+            row["delete_url"] = f"?action=delete&job_id={job_info.id}"
+            row["delete_msg"] = f"确认删除记录【{job_info.id}】吗?"
+            table.add_row(row)
+        
+        pagination = webutil.Pagination(page=1, total=total)
+        kw = Storage()
+        kw.table = table
+        kw.page = page
+        kw.page_max = pagination.page_max
+        kw.page_url = "?page="
+        
+        self.writehtml(HTML, **kw)
+        self.write_aside(ASIDE_HTML)
+    
+class JobTestHandler:
+    
+    @xauth.login_required("admin")
+    def GET(self):
+        job_info = SysJob()
+        job_info.job_type = "test"
+        with JobService.run_with_job(job_info):
+            time.sleep(1)
+            job_info.job_result = "success"
+            job_info.mtime = dateutil.format_datetime()
+        return webutil.SuccessResult()
+    
+xurls = (
+    r"/admin/jobs", JobHandler,
+    r"/admin/test_job", JobTestHandler
 )
```

### Comparing `xnote-web-0.1.0/handlers/api/alarm.py` & `xnote-web-0.1.1/handlers/api/alarm.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/check_network.py` & `xnote-web-0.1.1/handlers/api/check_network.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/getip.py` & `xnote-web-0.1.1/handlers/api/getip.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/ipv6.py` & `xnote-web-0.1.1/handlers/api/ipv6.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/readbook.py` & `xnote-web-0.1.1/handlers/api/readbook.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/report_time.py` & `xnote-web-0.1.1/handlers/api/report_time.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/report_weather.py` & `xnote-web-0.1.1/handlers/api/report_weather.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/api/tts.py` & `xnote-web-0.1.1/handlers/api/tts.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/code_edit.html` & `xnote-web-0.1.1/handlers/code/code_edit.html`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,202 +1,202 @@
-{% extends base %}
-
-{% block head %}
-
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.css">
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/monokai.min.css">
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/xq-light.css">
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/addon/dialog/dialog.css">
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/addon/hint/show-hint.css">
-
-    <script type="text/javascript" src="/_static/lib/codemirror/5.65.12/codemirror.js"></script>
-    <script type="text/javascript" src="/_static/lib/codemirror/mode/clike/clike.js"></script>
-    <script type="text/javascript" src="/_static/lib/codemirror/mode/shell.js"></script>
-    <script type="text/javascript" src="/_static/lib/codemirror/mode/markdown.js"></script>
-    <script type="text/javascript" src="/_static/lib/codemirror/keymap/sublime.js"></script>
-    <!-- 自定义的搜索 -->
-    <script type="text/javascript" src="/_static/js/codemirror-addon/xnote-search.js"></script>
-    <!-- 用于把光标定位到搜索对象上 -->    
-    <script type="text/javascript" src="/_static/lib/codemirror/addon/search/searchcursor.js"></script>
-    <!-- 搜索的输入框 -->
-    <script type="text/javascript" src="/_static/lib/codemirror/addon/dialog/dialog.js"></script>
-
-    <script type="text/javascript" src="/_static/lib/codemirror/addon/hint/show-hint.js"></script>
-    <script type="text/javascript" src="/_static/lib/codemirror/addon/hint/anyword-hint.js"></script>
-
-    <script type="text/javascript" src="/_static/js/editor.js"></script>
-
-    {% if path.endswith(".py") %}
-        <script type="text/javascript" src="/_static/lib/codemirror/mode/python.js"></script>
-    {% end %}
-    {% if path.endswith(".js") %}
-        <script type="text/javascript" src="/_static/lib/codemirror/mode/javascript.js"></script>
-    {% end %}
-    {% if path.endswith(".php") %}
-        <script type="text/javascript" src="/_static/lib/codemirror/mode/php.js"></script>
-    {% end %}
-    {% if path.endswith(".css") %}
-        <script type="text/javascript" src="/_static/lib/codemirror/mode/css.min.js"></script>
-    {% end %}
-
-    <style type="text/css">
-        .search-key {
-            background-color: #FF8000;
-            color: #000;
-        }
-
-        #result {
-            border: 1px solid #ccc;
-            padding: 4px;
-            background-color: #eee;
-        }
-
-        #editorArea {
-            border: 1px solid #ccc;
-        }
-
-        #editor {
-            width: 100%;
-            height: 100%;
-        }
-
-        .CodeMirror-search-match {
-          background: gold;
-          border-top: 1px solid orange;
-          border-bottom: 1px solid orange;
-          -moz-box-sizing: border-box;
-          box-sizing: border-box;
-          opacity: .5;
-        }
-
-        .CodeMirror {
-            font-family: Fira Code,Menlo,Monaco,Consolas,Liberation Mono,Courier New,Courier,monospace;
-        }
-
-        .global-warn {
-            display: none;
-        }
-    </style>
-
-    {% include common/layout/wide_left.html %}
-{% end %}
-
-{% block body_left %}
-{% import os %}
-{% init readonly = False %}
-{% init warn = "" %}
-{% init error = "" %}
-{% init pathlist = [] %}
-{% init show_preview = False %}
-{% init embed = False %}
-
-<div class="card editor-title">
-    <h3 class="card-title btn-line-height">
-        <span>文本编辑</span>
-        <div class="float-right">
-            {% if show_preview %}
-                <a class="btn" href="{{_server_home}}/code/wiki/{{path}}?embed={{embed}}">{{T("Preview")}}</a>
-            {% end %}
-            <a class="btn btn-default" href="javascript:history.back();">返回</a>
-        </div>
-    </h3>
-</div>
-
-<div class="card">
-
-    {% include "mod_fs_path.html" %}
-
-    {% if error != "" %}
-        <div class="col-md-12 error">
-            {{?error}}
-        </div>
-    {% end %}
-
-    {% if warn != "" and warn != None %}
-        <pre class="col-md-12 warn">
-            {{warn}}
-        </pre>
-    {% end %}
-
-    <form method="POST" action="/code/update">
-        <input name="path" class="hide" value="{{path}}"/>
-        <input name="basename" class="hide" value="{{os.path.basename(path)}}"/>
-        <input name="dirname" class="hide" value="{{os.path.dirname(path)}}"/>
-        <div id="editorArea" class="col-md-12">
-            <textarea name="content" id="editor">{{content}}</textarea>
-        </div>
-
-        <div class="col-md-12 bottom-offset-1">
-            {% if not readonly %}
-                <input type="button" value="保存" class="save-btn">
-                <input type="button" id="rename" class="btn rename-btn" value="重命名"/>
-            {% end %}
-            <input id="execute" type="button" class="btn hide" value="执行"/>
-            {% if show_preview %}
-                <a class="btn" href="{{_server_home}}/code/wiki/{{path}}?embed={{embed}}">{{T("Preview")}}</a>
-            {% end %}
-            {% if path.find("/plugins/") >= 0 or path.find("\\plugins\\") >= 0 %}
-                <input type="button" class="link-btn" href="{{_server_home}}/plugins/{{plugin_name}}?embed={{embed}}&_reload=true" value="预览"/>
-            {% end %}
-            <span>注意不会自动保存</span>
-        </div>
-
-        <div id="resultDiv" class="col-md-12 hide">
-            <div class="output-title">结果</div>
-            <pre id="result" class="col-md-12 output-body">
-            </pre>
-        </div>
-    </form>
-</div>
-
-{# TODO 需要处理下搜索的高亮 #}
-
-<script type="text/javascript">
-    if (xnote.getUrlParam("embed") == "true") {
-        $("body").css("overflow-y", "hidden");
-        $(".editor-title").hide();
-    }
-
-
-    $(function () {
-        var editorHeight = adjustHeight("#editorArea", 50);
-        $("#editorArea").css("overflow-y", "hidden");
-        var editor = initCodeMirror("#editor", {
-            filename: getUrlParams().path,
-            height: editorHeight
-        });
-        window.codeEditor = editor;
-
-        // 重命名
-        $(".rename-btn").click(function (event) {
-            var name     = $("[name=basename]").val();
-            var dirname  = $("[name=dirname]").val();
-            xnote.prompt("重命名为", name, function (new_name) {
-                var request =  {dirname: dirname, old_name: name, new_name: new_name};
-                xnote.http.post("/fs_api/rename", request,
-                    function (resp) {
-                        if (resp.code == "success") {
-                            var location = resp.location;
-                            window.location.href = "/code/edit?path=" + dirname + "/" + new_name;
-                        } else {
-                            showErrorMessage("重命名失败, %s".format(resp.message));
-                        }
-                });
-            });
-        });
-
-        // 保存
-        $(".save-btn").click(function (e) {
-            var params = {};
-            params.path = $("[name=path]").val();
-            params.content = $("[name=content]").val();
-            xnote.http.post("/code/update", params, function (resp) {
-                if (resp.code == "success") {
-                    xnote.toast("保存成功");
-                } else {
-                    xnote.toast("保存失败: " + resp.message);
-                }
-            })
-        });
-    });
-</script>
+{% extends base %}
+
+{% block head %}
+
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.css">
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/monokai.min.css">
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/xq-light.css">
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/addon/dialog/dialog.css">
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/addon/hint/show-hint.css">
+
+    <script type="text/javascript" src="/_static/lib/codemirror/5.65.12/codemirror.js"></script>
+    <script type="text/javascript" src="/_static/lib/codemirror/mode/clike/clike.js"></script>
+    <script type="text/javascript" src="/_static/lib/codemirror/mode/shell.js"></script>
+    <script type="text/javascript" src="/_static/lib/codemirror/mode/markdown.js"></script>
+    <script type="text/javascript" src="/_static/lib/codemirror/keymap/sublime.js"></script>
+    <!-- 自定义的搜索 -->
+    <script type="text/javascript" src="/_static/js/codemirror-addon/xnote-search.js"></script>
+    <!-- 用于把光标定位到搜索对象上 -->    
+    <script type="text/javascript" src="/_static/lib/codemirror/addon/search/searchcursor.js"></script>
+    <!-- 搜索的输入框 -->
+    <script type="text/javascript" src="/_static/lib/codemirror/addon/dialog/dialog.js"></script>
+
+    <script type="text/javascript" src="/_static/lib/codemirror/addon/hint/show-hint.js"></script>
+    <script type="text/javascript" src="/_static/lib/codemirror/addon/hint/anyword-hint.js"></script>
+
+    <script type="text/javascript" src="/_static/js/editor.js"></script>
+
+    {% if path.endswith(".py") %}
+        <script type="text/javascript" src="/_static/lib/codemirror/mode/python.js"></script>
+    {% end %}
+    {% if path.endswith(".js") %}
+        <script type="text/javascript" src="/_static/lib/codemirror/mode/javascript.js"></script>
+    {% end %}
+    {% if path.endswith(".php") %}
+        <script type="text/javascript" src="/_static/lib/codemirror/mode/php.js"></script>
+    {% end %}
+    {% if path.endswith(".css") %}
+        <script type="text/javascript" src="/_static/lib/codemirror/mode/css.min.js"></script>
+    {% end %}
+
+    <style type="text/css">
+        .search-key {
+            background-color: #FF8000;
+            color: #000;
+        }
+
+        #result {
+            border: 1px solid #ccc;
+            padding: 4px;
+            background-color: #eee;
+        }
+
+        #editorArea {
+            border: 1px solid #ccc;
+        }
+
+        #editor {
+            width: 100%;
+            height: 100%;
+        }
+
+        .CodeMirror-search-match {
+          background: gold;
+          border-top: 1px solid orange;
+          border-bottom: 1px solid orange;
+          -moz-box-sizing: border-box;
+          box-sizing: border-box;
+          opacity: .5;
+        }
+
+        .CodeMirror {
+            font-family: Fira Code,Menlo,Monaco,Consolas,Liberation Mono,Courier New,Courier,monospace;
+        }
+
+        .global-warn {
+            display: none;
+        }
+    </style>
+
+    {% include common/layout/wide_left.html %}
+{% end %}
+
+{% block body_left %}
+{% import os %}
+{% init readonly = False %}
+{% init warn = "" %}
+{% init error = "" %}
+{% init pathlist = [] %}
+{% init show_preview = False %}
+{% init embed = False %}
+
+<div class="card editor-title">
+    <h3 class="card-title btn-line-height">
+        <span>文本编辑</span>
+        <div class="float-right">
+            {% if show_preview %}
+                <a class="btn" href="{{_server_home}}/code/wiki/{{path}}?embed={{embed}}">{{T("Preview")}}</a>
+            {% end %}
+            <a class="btn btn-default" href="javascript:history.back();">返回</a>
+        </div>
+    </h3>
+</div>
+
+<div class="card">
+
+    {% include "mod_fs_path.html" %}
+
+    {% if error != "" %}
+        <div class="col-md-12 error">
+            {{?error}}
+        </div>
+    {% end %}
+
+    {% if warn != "" and warn != None %}
+        <pre class="col-md-12 warn">
+            {{warn}}
+        </pre>
+    {% end %}
+
+    <form method="POST" action="/code/update">
+        <input name="path" class="hide" value="{{path}}"/>
+        <input name="basename" class="hide" value="{{os.path.basename(path)}}"/>
+        <input name="dirname" class="hide" value="{{os.path.dirname(path)}}"/>
+        <div id="editorArea" class="col-md-12">
+            <textarea name="content" id="editor">{{content}}</textarea>
+        </div>
+
+        <div class="col-md-12 bottom-offset-1">
+            {% if not readonly %}
+                <input type="button" value="保存" class="save-btn">
+                <input type="button" id="rename" class="btn rename-btn" value="重命名"/>
+            {% end %}
+            <input id="execute" type="button" class="btn hide" value="执行"/>
+            {% if show_preview %}
+                <a class="btn" href="{{_server_home}}/code/wiki/{{path}}?embed={{embed}}">{{T("Preview")}}</a>
+            {% end %}
+            {% if path.find("/plugins/") >= 0 or path.find("\\plugins\\") >= 0 %}
+                <input type="button" class="link-btn" href="{{_server_home}}/plugins/{{plugin_name}}?embed={{embed}}&_reload=true" value="预览"/>
+            {% end %}
+            <span>注意不会自动保存</span>
+        </div>
+
+        <div id="resultDiv" class="col-md-12 hide">
+            <div class="output-title">结果</div>
+            <pre id="result" class="col-md-12 output-body">
+            </pre>
+        </div>
+    </form>
+</div>
+
+{# TODO 需要处理下搜索的高亮 #}
+
+<script type="text/javascript">
+    if (xnote.getUrlParam("embed") == "true") {
+        $("body").css("overflow-y", "hidden");
+        $(".editor-title").hide();
+    }
+
+
+    $(function () {
+        var editorHeight = adjustHeight("#editorArea", 50);
+        $("#editorArea").css("overflow-y", "hidden");
+        var editor = initCodeMirror("#editor", {
+            filename: getUrlParams().path,
+            height: editorHeight
+        });
+        window.codeEditor = editor;
+
+        // 重命名
+        $(".rename-btn").click(function (event) {
+            var name     = $("[name=basename]").val();
+            var dirname  = $("[name=dirname]").val();
+            xnote.prompt("重命名为", name, function (new_name) {
+                var request =  {dirname: dirname, old_name: name, new_name: new_name};
+                xnote.http.post("/fs_api/rename", request,
+                    function (resp) {
+                        if (resp.code == "success") {
+                            var location = resp.location;
+                            window.location.href = "/code/edit?path=" + dirname + "/" + new_name;
+                        } else {
+                            showErrorMessage("重命名失败, %s".format(resp.message));
+                        }
+                });
+            });
+        });
+
+        // 保存
+        $(".save-btn").click(function (e) {
+            var params = {};
+            params.path = $("[name=path]").val();
+            params.content = $("[name=content]").val();
+            xnote.http.post("/code/update", params, function (resp) {
+                if (resp.code == "success") {
+                    xnote.toast("保存成功");
+                } else {
+                    xnote.toast("保存失败: " + resp.message);
+                }
+            })
+        });
+    });
+</script>
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/code/code_edit.py` & `xnote-web-0.1.1/handlers/code/code_edit.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/code_lines.html` & `xnote-web-0.1.1/handlers/code/code_lines.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/code_lines.py` & `xnote-web-0.1.1/handlers/code/code_lines.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/code_search.html` & `xnote-web-0.1.1/handlers/code/code_search.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/code_search.py` & `xnote-web-0.1.1/handlers/code/code_search.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/preview.html` & `xnote-web-0.1.1/handlers/code/preview.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/code/preview.py` & `xnote-web-0.1.1/handlers/code/preview.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,16 +1,16 @@
 # encoding=utf-8
 # @modified 2019/09/30 11:13:34
 import os
 import web
 import xutils
-import xtemplate
-import xconfig
-import xauth
-from xtemplate import render
+from xnote.core import xtemplate
+from xnote.core import xconfig
+from xnote.core import xauth
+from xnote.core.xtemplate import render
 from xutils import Storage
 from xutils import fsutil
 
 WIKI_PATH = "./"
 
 HIDE_EXT_LIST = [
     ".bak"
@@ -83,16 +83,18 @@
         path = xutils.get_real_path(path)
         kw = Storage()
 
         if os.path.isfile(path):
             check_resource(path)
             type = "file"
             content = xutils.readfile(path)
-            _, ext = os.path.splitext(path)
-            if ext == ".csv" and not content.startswith("```csv"):
+            assert isinstance(content, str)
+
+            ext = fsutil.get_file_ext(path)
+            if ext == "csv" and not content.startswith("```csv"):
                 content = "```csv\n" + content + "\n```"
         else:
             # file not exists or not readable
             content = "File \"%s\" does not exists" % path
             type = "file"
 
         handle_layout(kw)
```

### Comparing `xnote-web-0.1.0/handlers/code/wiki_edit.html` & `xnote-web-0.1.1/handlers/code/wiki_edit.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/base/pagination.html` & `xnote-web-0.1.1/handlers/common/base/pagination.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/base.html` & `xnote-web-0.1.1/handlers/common/base.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/base_footer.html` & `xnote-web-0.1.1/handlers/common/base_footer.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/base_head.html` & `xnote-web-0.1.1/handlers/common/base_head.html`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,58 +1,58 @@
-<head>
-{% init html_title = None %}
-{% init _user_name = None %}
-{% init FONT_SCALE = 100 %}
-{% init show_menu  = True %}
-{% init show_aside = False %}
-{% init show_search = True %}
-{% import xconfig %}
-
-<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
-{% if FONT_SCALE == 80 %}
-  <meta name="viewport" content="width=device-width,initial-scale=0.8,maximum-scale=0.8,user-scalable=0"/>
-{% elif FONT_SCALE == 120 %}
-  <meta name="viewport" content="width=300,initial-scale=1.2,maximum-scale=1.2,user-scalable=0"/>
-{% else %}
-  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=0"/>
-{% end %}
-
-<title>{{xconfig.WebConfig.ui_title_prefix}}{%if html_title%} | {{T(html_title)}}{%end%}</title>
-
-<link rel="shortcut icon" href="{{_server_home}}/_static/favicon.ico"/>
-<link rel="bookmark" href="{{_server_home}}/_static/favicon.ico"/>
-<link rel="stylesheet" href="{{_server_home}}/_static/css/app.build.css?ts={{_ts}}"/>
-<link rel="stylesheet" href="{{_server_home}}/_static/css/common-card.css?ts={{_ts}}"/>
-
-<script type="text/javascript" src="{{_server_home}}/_static/lib/jquery/jquery-1.12.4.min.js"></script>
-<!-- 弹层组件 -->
-<script type="text/javascript" src="{{_server_home}}/_static/lib/layer/layer.js"></script>
-<!-- 模板引擎 -->
-<script type="text/javascript" src="{{_server_home}}/_static/lib/art-template/template-web-4.13.2.js"></script>
-<!-- 应用JS脚本,优先级更高，所以放在后面 -->
-<script type="text/javascript" src="{{_server_home}}/_static/js/app.build.js?ts={{_ts}}"></script>
-
-{% include common/layout/base_layout.html %}
-
-{% if xconfig.WebConfig.record_location %}
-<script type="text/javascript" src="{{_server_home}}/system/stats"></script>
-{% end %}
-
-{# 自定义的样式 #}
-{% if xconfig.USER_CSS != None %}
-  <link rel="stylesheet" type="text/css" href="{{_server_home}}/system/user.css?ts={{_ts}}">
-{% end %}
-
-{# 自定义脚本 #}
-{% if xconfig.USER_JS != None %}
-  <script type="text/javascript" src="{{_server_home}}/system/user.js?ts={{_ts}}" async="true"></script>
-{% end %}
-
-<script type="text/javascript">
-  xnote.state.system.isAdmin = Boolean("{{_is_admin}}");
-  xnote.state.system.nodeRole = '{{xconfig.get_system_config("node_role")}}';
-  xnote.config.serverHome = "{{_server_home}}";
-</script>
-
-{% block head %} {% end %}
-
-</head>
+<head>
+{% init html_title = None %}
+{% init _user_name = None %}
+{% init FONT_SCALE = 100 %}
+{% init show_menu  = True %}
+{% init show_aside = False %}
+{% init show_search = True %}
+{% import xconfig %}
+
+<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+{% if FONT_SCALE == 80 %}
+  <meta name="viewport" content="width=device-width,initial-scale=0.8,maximum-scale=0.8,user-scalable=0"/>
+{% elif FONT_SCALE == 120 %}
+  <meta name="viewport" content="width=300,initial-scale=1.2,maximum-scale=1.2,user-scalable=0"/>
+{% else %}
+  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=0"/>
+{% end %}
+
+<title>{{xconfig.WebConfig.ui_title_prefix}}{%if html_title%} | {{T(html_title)}}{%end%}</title>
+
+<link rel="shortcut icon" href="{{_server_home}}/_static/favicon.ico"/>
+<link rel="bookmark" href="{{_server_home}}/_static/favicon.ico"/>
+<link rel="stylesheet" href="{{_server_home}}/_static/css/app.build.css?ts={{_ts}}"/>
+<link rel="stylesheet" href="{{_server_home}}/_static/css/common-card.css?ts={{_ts}}"/>
+
+<script type="text/javascript" src="{{_server_home}}/_static/lib/jquery/jquery-1.12.4.min.js"></script>
+<!-- 弹层组件 -->
+<script type="text/javascript" src="{{_server_home}}/_static/lib/layer/layer.js"></script>
+<!-- 模板引擎 -->
+<script type="text/javascript" src="{{_server_home}}/_static/lib/art-template/template-web-4.13.2.js"></script>
+<!-- 应用JS脚本,优先级更高，所以放在后面 -->
+<script type="text/javascript" src="{{_server_home}}/_static/js/app.build.js?ts={{_ts}}"></script>
+
+{% include common/layout/base_layout.html %}
+
+{% if xconfig.WebConfig.record_location %}
+<script type="text/javascript" src="{{_server_home}}/system/stats"></script>
+{% end %}
+
+{# 自定义的样式 #}
+{% if xconfig.USER_CSS != None %}
+  <link rel="stylesheet" type="text/css" href="{{_server_home}}/system/user.css?ts={{_ts}}">
+{% end %}
+
+{# 自定义脚本 #}
+{% if xconfig.USER_JS != None %}
+  <script type="text/javascript" src="{{_server_home}}/system/user.js?ts={{_ts}}" async="true"></script>
+{% end %}
+
+<script type="text/javascript">
+  xnote.state.system.isAdmin = Boolean("{{_is_admin}}");
+  xnote.state.system.nodeRole = '{{xconfig.get_system_config("node_role")}}';
+  xnote.config.serverHome = "{{_server_home}}";
+</script>
+
+{% block head %} {% end %}
+
+</head>
```

### Comparing `xnote-web-0.1.0/handlers/common/base_nav.html` & `xnote-web-0.1.1/handlers/common/base_nav.html`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,37 +1,37 @@
-{% init show_menu = True %}
-{% init show_nav  = True %}
-{% init search_placeholder = "搜索或指令" %}
-{% init search_action = "/search/search" %}
-{% init nav_type = "default" %}
-
-{% include $base_nav_top %}
-
-{% if _user_config.nav_style == "left" %}
-  {% include $base_nav_left %}
-{% end %}
-
-{% if _is_admin and show_menu and show_nav and xconfig.get_system_config("node_role") == "follower" %}
-<div class="row warn">
-  <div class="x-center">
-    <div class="dev-info">
-      当前系统以从节点身份运行，请勿编辑
-      <a href="{{_server_home}}/system/sync?p=home">查看同步状态</a>
-    </div>
-  </div>
-</div>
-{% end %}
-
-{% if xconfig.WebConfig.ui_show_translate_js %}
-<!-- 展示translate.js组件 -->
-<div class="row warn">
-  <div class="x-center">
-    {% include common/script/translate_script.html %}
-  </div>
-</div>
-{% end %}
-
-<div class="toolbar homepage hide">
-  <div class="action">
-    回到<br/>顶部
-  </div>
+{% init show_menu = True %}
+{% init show_nav  = True %}
+{% init search_placeholder = "搜索或指令" %}
+{% init search_action = "/search/search" %}
+{% init nav_type = "default" %}
+
+{% include $base_nav_top %}
+
+{% if _user_config.nav_style == "left" %}
+  {% include $base_nav_left %}
+{% end %}
+
+{% if _is_admin and show_menu and show_nav and xconfig.get_system_config("node_role") == "follower" %}
+<div class="row warn">
+  <div class="x-center">
+    <div class="dev-info">
+      当前系统以从节点身份运行，请勿编辑
+      <a href="{{_server_home}}/system/sync?p=home">查看同步状态</a>
+    </div>
+  </div>
+</div>
+{% end %}
+
+{% if xconfig.WebConfig.ui_show_translate_js %}
+<!-- 展示translate.js组件 -->
+<div class="row warn">
+  <div class="x-center">
+    {% include common/script/translate_script.html %}
+  </div>
+</div>
+{% end %}
+
+<div class="toolbar homepage hide">
+  <div class="action">
+    回到<br/>顶部
+  </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/common/base_title.html` & `xnote-web-0.1.1/handlers/common/base_title.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/date/month_picker.html` & `xnote-web-0.1.1/handlers/common/date/month_picker.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/form/form.html` & `xnote-web-0.1.1/handlers/common/form/form.html`

 * *Files 21% similar despite different names*

```diff
@@ -1,112 +1,105 @@
-{% init xnote_form_var = "form" %}
-{% set _xnote_form = globals()[xnote_form_var] %}
-
-<style>
-    .form-row {
-        margin-bottom: 10px;
-    }
-    .form-row label {
-        width: 100px;
-        display: block;
-        float: left;
-    }
-    .form-row textarea {
-        width: 300px;
-        height: 50px;
-    }
-    .form-body {
-        padding: 10px;
-    }
-    .form-body {
-        position: absolute;
-        padding: 10px;
-        top: 0px;
-        bottom: 50px;
-        overflow-y: auto;
-        right: 0px;
-        left: 0px;
-    }
-    .form-footer {
-        position: absolute;
-        bottom: 0px;
-        left: 0px;
-        right: 0px;
-        height: 50px;
-        padding: 10px;
-    }
-</style>
-
-<div class="form-body">
-    <form id="xnoteForm{{_xnote_form.id}}">
-        {% for row in _xnote_form.rows %}
-            <div class="form-row {{row.css_class}}">
-                <label>{{row.title}}</label>
-                {% if row.type == "input" %}
-                    <input type="text" name="{{row.field}}" placeholder="{{row.placeholder}}" value="{{row.value}}" {{row.get_readonly_attr()}}>
-                {% end %}
-                {% if row.type == "textarea" %}
-                    <textarea name="{{row.field}}" placeholder="{{row.placeholder}}">{{row.value}}</textarea>
-                {% end %}
-                {% if row.type == "select" %}
-                    <select name="{{row.field}}" value="{{row.value}}">
-                        {% for option in row.options %}
-                            <option value="{{option.value}}">{{option.title}}</option>
-                        {% end %}
-                    </select>
-                {% end %}
-                {% if row.type == "date" %}
-                    <input id="{{row.id}}" name="{{row.field}}" class="form-date" data-date-type="{{row.date_type}}" 
-                        placeholder="{{row.placeholder}}" value="{{row.value}}" autocomplete="off">
-                {% end %}
-            </div>
-        {% end %}
-    </form>
-</div>
-
-<div class="form-footer">
-    <div class="float-right">
-        <button class="large" onclick="xnote.handleFormSubmit(this)" data-form-id="xnoteForm{{_xnote_form.id}}">保存</button>
-        <button class="large btn-default" onclick="xnote.closeFormDialog(this)" data-form-id="xnoteForm{{_xnote_form.id}}">关闭</button>
-    </div>
-</div>
-
-<script>
-    // 刷新默认值
-    xnote.refresh();
-    xnote.handleFormSubmit = function(target) {
-        var request = {};
-        var formId = $(target).attr("data-form-id");
-        var data = $("#"+formId).formData();
-        request.data = JSON.stringify(data);
-        console.log("request:", request);
-    
-        xnote.http.post("?model={{_xnote_form.model_name}}&action={{_xnote_form.save_action}}", request, function (resp) {
-            if (resp.success) {
-                xnote.toast("保存成功");
-                window.parent.location.reload();
-                // xnote.closeDialog("last");
-            } else {
-                xnote.toast(resp.message);
-            }
-        });
-    }
-
-    xnote.closeFormDialog = function (target) {
-        xnote.closeDialog("last");
-    }
-
-    $(".form-date").click(function(event) {
-        var elem = event.target;
-        if ($(elem).attr("data-laydate-bind")) {
-            return;
-        }
-
-        laydate.render({
-            elem: elem,
-            type: $(elem).attr("data-date-type"),
-            show: true
-        });
-        
-        $(elem).attr("data-laydate-bind", true);
-    });
+{% init xnote_form_var = "form" %}
+{% set _xnote_form = globals()[xnote_form_var] %}
+
+<style>
+    .form-row {
+        margin-bottom: 10px;
+    }
+    .form-row label {
+        width: 100px;
+        display: block;
+        float: left;
+    }
+    .form-row textarea {
+        width: 300px;
+        height: 50px;
+    }
+    .form-body {
+        position: absolute;
+        padding: 10px;
+        top: 0px;
+        bottom: 50px;
+        overflow-y: auto;
+        right: 0px;
+        left: 0px;
+    }
+    .form-footer {
+        position: absolute;
+        bottom: 0px;
+        left: 0px;
+        right: 0px;
+        height: 50px;
+        padding: 10px;
+    }
+</style>
+
+<div class="form-body">
+    <form id="xnoteForm{{_xnote_form.id}}">
+        {% for row in _xnote_form.rows %}
+            <div class="form-row {{row.css_class}}">
+                <label>{{row.title}}</label>
+                {% if row.type == "input" %}
+                    <input type="text" name="{{row.field}}" placeholder="{{row.placeholder}}" value="{{row.value}}" {{row.get_readonly_attr()}}>
+                {% end %}
+                {% if row.type == "textarea" %}
+                    <textarea name="{{row.field}}" placeholder="{{row.placeholder}}">{{row.value}}</textarea>
+                {% end %}
+                {% if row.type == "select" %}
+                    <select name="{{row.field}}" value="{{row.value}}">
+                        {% for option in row.options %}
+                            <option value="{{option.value}}">{{option.title}}</option>
+                        {% end %}
+                    </select>
+                {% end %}
+                {% if row.type == "date" %}
+                    <input id="{{row.id}}" name="{{row.field}}" class="form-date" data-date-type="{{row.date_type}}" 
+                        placeholder="{{row.placeholder}}" value="{{row.value}}" autocomplete="off">
+                {% end %}
+            </div>
+        {% end %}
+    </form>
+</div>
+
+<div class="form-footer">
+    <div class="float-right">
+        <button class="large" onclick="xnote.handleFormSubmit(this)" data-form-id="xnoteForm{{_xnote_form.id}}">保存</button>
+        <button class="large btn-default" onclick="xnote.dialog.closeLast(this)" data-form-id="xnoteForm{{_xnote_form.id}}">关闭</button>
+    </div>
+</div>
+
+<script>
+    // 刷新默认值
+    xnote.refresh();
+    xnote.handleFormSubmit = function(target) {
+        var request = {};
+        var formId = $(target).attr("data-form-id");
+        var data = $("#"+formId).formData();
+        request.data = JSON.stringify(data);
+        console.log("request:", request);
+    
+        xnote.http.post("?model={{_xnote_form.model_name}}&action={{_xnote_form.save_action}}", request, function (resp) {
+            if (resp.success) {
+                xnote.toast("保存成功");
+                window.parent.location.reload();
+                // xnote.closeDialog("last");
+            } else {
+                xnote.toast(resp.message);
+            }
+        });
+    }
+
+    $(".form-date").click(function(event) {
+        var elem = event.target;
+        if ($(elem).attr("data-laydate-bind")) {
+            return;
+        }
+
+        laydate.render({
+            elem: elem,
+            type: $(elem).attr("data-date-type"),
+            show: true
+        });
+        
+        $(elem).attr("data-laydate-bind", true);
+    });
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/common/hook/search_box_hook.html` & `xnote-web-0.1.1/handlers/common/hook/search_box_hook.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/layout/base_layout.html` & `xnote-web-0.1.1/handlers/common/layout/base_layout.html`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,158 +1,158 @@
-{% init show_right = True %}
-
-{% if not show_menu %}
-<style type="text/css">
-  body {
-    background: transparent;
-  }
-
-  .main {
-    padding: 0px;
-  }
-
-  .nav {
-    display: none;
-  }
-
-  .nav-left {
-    display: none;
-  }
-
-  .x-body {
-    left: 0px;
-  }
-</style>
-{% end %}
-
-{% if not show_search %}
-<style type="text/css">
-  .nav-left-search {
-    display: none;
-  }
-
-  .search-box {
-    display: none;
-  }
-</style>
-{% end %}
-
-{% if xconfig.DEBUG_HTML_BOX %}
-<!-- 用于移动端或者其他不方便调试设备的样式调试 -->
-<style type="text/css">
-  * {
-    box-sizing: border-box;
-    border: solid 1px red;
-  }
-</style>
-{% end %}
-
-
-{# 侧边栏(右侧)是否显示 #}
-{% if not show_aside %}
-<style type="text/css">
-  .x-body {
-    right: 0px;
-  }
-
-  .aside {
-    display: none;
-  }
-</style>
-{% end %}
-
-<style type="text/css" id="layout-css"></style>
-
-<script type="text/javascript">
-  // JavaScript执行的顺序和<script>标签定义的顺序有关
-  // 这里动态生成<style>不会导致闪烁
-  (function () {
-    function loadStyle() {
-      var navStyle = "{{_user_config.nav_style}}";
-      var contentWidth = parseInt("{{CONTENT_WIDTH}}");
-      var winWidth = $(window).width(); // 窗口的宽度
-      var leftNavWidth = 0; // 左侧导航的宽度
-      var contentLeftWidth = 0; // content-left宽度
-      var styleText = "";
-      var paddingLeft = 10;
-      var paddingRight = 10;
-      var showLeftNav = (navStyle == "left" && xnote.isDesktop());
-
-      xnote.config.navStyle = navStyle;
-      
-      if (showLeftNav) {
-        leftNavWidth = 180;
-        xnote.device.leftNavWidth = leftNavWidth;
-        contentWidth = winWidth - leftNavWidth;
-      }
-
-      if (winWidth >= xnote.MOBILE_MAX_WIDTH) {
-        // 桌面版
-        styleText += ".content-left { width: calc(100% - 300px); }";
-        styleText += ".content-right { width: 300px; }";
-        styleText += ".mobile-only { display: none; }";
-        contentLeftWidth = contentWidth - 300; // 300是右侧边栏宽度
-        if (navStyle == "left") {
-          paddingLeft = leftNavWidth + 10;
-        } else {
-          paddingLeft = (winWidth - contentWidth) / 2 + 10;
-          paddingRight = paddingLeft;
-        }
-      } else {
-        // 移动版
-        styleText += ".content-left { width: 100%; }";
-        styleText += ".content-right { display: none; }";
-        styleText += ".nav {display: block;}";
-        styleText += ".desktop-only { display: none; }";
-        contentLeftWidth = winWidth;
-        contentWidth = winWidth;
-      }
-
-      // 设置最小的高度
-      var rootMinHeight = $(window).height() - 39;
-
-      styleText += ".x-center, .nav-container {"
-        + "float:left;"
-        + "width:100%;"
-        + "padding-left:" + paddingLeft + "px;"
-        + "padding-right:" + paddingRight + "px;"
-        + "}";
-
-      styleText += ".main-content { width: 100%; padding-left:" + paddingLeft + "px; "
-        + "padding-right: " + paddingRight + "px;}";
-
-      styleText += ".root{ min-height:" + rootMinHeight + "px;}";
-
-      // 设备大小信息
-      xnote.device.isMobile = winWidth < xnote.MOBILE_MAX_WIDTH;
-      xnote.device.isDesktop = winWidth >= xnote.MOBILE_MAX_WIDTH;
-      xnote.device.contentWidth = contentWidth;
-      xnote.device.contentLeftWidth = contentLeftWidth;
-
-      // 居中的样式
-      $("#layout-css").html(styleText);
-
-      for (var i = 0; i < xnote.events.resizeHooks.length; i++) {
-        xnote.events.resizeHooks[i]();
-      }
-    };
-
-    loadStyle();
-
-    $(window).on("resize", loadStyle);
-
-  })();
-</script>
-
-{% if not show_right %}
-
-<style>
-  .content-left {
-    width: 100%;
-  }
-
-  .content-right {
-    display: none;
-  }
-</style>
-
+{% init show_right = True %}
+
+{% if not show_menu %}
+<style type="text/css">
+  body {
+    background: transparent;
+  }
+
+  .main {
+    padding: 0px;
+  }
+
+  .nav {
+    display: none;
+  }
+
+  .nav-left {
+    display: none;
+  }
+
+  .x-body {
+    left: 0px;
+  }
+</style>
+{% end %}
+
+{% if not show_search %}
+<style type="text/css">
+  .nav-left-search {
+    display: none;
+  }
+
+  .search-box {
+    display: none;
+  }
+</style>
+{% end %}
+
+{% if xconfig.DEBUG_HTML_BOX %}
+<!-- 用于移动端或者其他不方便调试设备的样式调试 -->
+<style type="text/css">
+  * {
+    box-sizing: border-box;
+    border: solid 1px red;
+  }
+</style>
+{% end %}
+
+
+{# 侧边栏(右侧)是否显示 #}
+{% if not show_aside %}
+<style type="text/css">
+  .x-body {
+    right: 0px;
+  }
+
+  .aside {
+    display: none;
+  }
+</style>
+{% end %}
+
+<style type="text/css" id="layout-css"></style>
+
+<script type="text/javascript">
+  // JavaScript执行的顺序和<script>标签定义的顺序有关
+  // 这里动态生成<style>不会导致闪烁
+  (function () {
+    function loadStyle() {
+      var navStyle = "{{_user_config.nav_style}}";
+      var contentWidth = parseInt("{{CONTENT_WIDTH}}");
+      var winWidth = $(window).width(); // 窗口的宽度
+      var leftNavWidth = 0; // 左侧导航的宽度
+      var contentLeftWidth = 0; // content-left宽度
+      var styleText = "";
+      var paddingLeft = 10;
+      var paddingRight = 10;
+      var showLeftNav = (navStyle == "left" && xnote.isDesktop());
+
+      xnote.config.navStyle = navStyle;
+      
+      if (showLeftNav) {
+        leftNavWidth = 180;
+        xnote.device.leftNavWidth = leftNavWidth;
+        contentWidth = winWidth - leftNavWidth;
+      }
+
+      if (winWidth >= xnote.MOBILE_MAX_WIDTH) {
+        // 桌面版
+        styleText += ".content-left { width: calc(100% - 300px); }";
+        styleText += ".content-right { width: 300px; }";
+        styleText += ".mobile-only { display: none; }";
+        contentLeftWidth = contentWidth - 300; // 300是右侧边栏宽度
+        if (navStyle == "left") {
+          paddingLeft = leftNavWidth + 10;
+        } else {
+          paddingLeft = (winWidth - contentWidth) / 2 + 10;
+          paddingRight = paddingLeft;
+        }
+      } else {
+        // 移动版
+        styleText += ".content-left { width: 100%; }";
+        styleText += ".content-right { display: none; }";
+        styleText += ".nav {display: block;}";
+        styleText += ".desktop-only { display: none; }";
+        contentLeftWidth = winWidth;
+        contentWidth = winWidth;
+      }
+
+      // 设置最小的高度
+      var rootMinHeight = $(window).height() - 39;
+
+      styleText += ".x-center, .nav-container {"
+        + "float:left;"
+        + "width:100%;"
+        + "padding-left:" + paddingLeft + "px;"
+        + "padding-right:" + paddingRight + "px;"
+        + "}";
+
+      styleText += ".main-content { width: 100%; padding-left:" + paddingLeft + "px; "
+        + "padding-right: " + paddingRight + "px;}";
+
+      styleText += ".root{ min-height:" + rootMinHeight + "px;}";
+
+      // 设备大小信息
+      xnote.device.isMobile = winWidth < xnote.MOBILE_MAX_WIDTH;
+      xnote.device.isDesktop = winWidth >= xnote.MOBILE_MAX_WIDTH;
+      xnote.device.contentWidth = contentWidth;
+      xnote.device.contentLeftWidth = contentLeftWidth;
+
+      // 居中的样式
+      $("#layout-css").html(styleText);
+
+      for (var i = 0; i < xnote.events.resizeHooks.length; i++) {
+        xnote.events.resizeHooks[i]();
+      }
+    };
+
+    loadStyle();
+
+    $(window).on("resize", loadStyle);
+
+  })();
+</script>
+
+{% if not show_right %}
+
+<style>
+  .content-left {
+    width: 100%;
+  }
+
+  .content-right {
+    display: none;
+  }
+</style>
+
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/common/mod_notice.html` & `xnote-web-0.1.1/handlers/common/mod_notice.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/nav/base_nav_left.html` & `xnote-web-0.1.1/handlers/common/nav/base_nav_left.html`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,111 +1,111 @@
-<style>
-  .nav {
-    display: none;
-  }
-
-  .nav-left {
-    display: block;
-  }
-
-  .nav-left-block {
-    display: block;
-    float: left;
-    width: 100%;
-    margin-bottom: 10px;
-  }
-
-  .nav-left-block a {
-    display: block;
-    float: left;
-    width: 100%;
-    color: white;
-    padding-left: 40px;
-    padding-bottom: 5px;
-    padding-top: 5px;
-  }
-
-  .nav-left-block a:hover {
-    background-color: #333;
-  }
-
-  @media screen and (max-width: 1000px) {
-    /* mobile mode */
-    .nav {
-      display: block;
-    }
-
-    .nav-left {
-      display: none;
-    }
-  }
-</style>
-<div class="nav-left">
-  <div class="nav-scroll">
-    <!-- 侧边菜单栏 -->
-    <div class="nav-left-block">
-      <div class="navMenu">
-        {% if _has_login %}
-        <!-- 登录状态 -->
-        <a href="{{_server_home}}/note/index">{{T("首页")}}</a>
-        <a href="{{_server_home}}/note/recent?orderby=update">{{T("动态")}}</a>
-        <a href="{{_server_home}}/note/taglist">{{T("标签")}}</a>
-        <a href="{{_server_home}}/search/history">{{T("搜索")}}</a>
-        <a href="{{_server_home}}/note/public">{{T("分享")}}</a>
-        {% end %}
-      </div>
-    </div>
-
-    <div class="nav-left-block">
-      <div class="navMenu">
-        {% if _has_login %}
-        <!-- 登录状态 -->
-        <a href="{{_server_home}}/message?tag=task">{{T("待办")}}</a>
-        <a href="{{_server_home}}/message?tag=log">{{T("随手记")}}</a>
-        {% end %}
-      </div>
-    </div>
-
-    <div class="nav-left-block">
-      <div class="navMenu">
-        {% if _has_login %}
-        <a href="{{_server_home}}/system/index">{{T("应用")}}</a>
-        <a href="{{_server_home}}/plugins_list">{{T("插件")}}</a>
-        <a href="{{_server_home}}/system/settings">{{T("设置")}}</a>
-        {% end %}
-
-        {% if _is_admin %}
-        <a href="{{_server_home}}/fs_list">{{T("文件")}}</a>
-        <a href="{{_server_home}}/system/admin">{{T("后台")}}</a>
-        {% end %}
-
-        {% if not _has_login %}
-        <!-- 未登录状态 -->
-        <a href="{{_server_home}}/note/public">分享</a>
-        <a href="{{_server_home}}/login" class="afinve"><span>登录</span></a>
-        {% end %}
-      </div>
-    </div>
-
-    {% if len(xconfig.WebConfig.custom_nav_list) > 0 %}
-    <div class="nav-left-block">
-      <div class="navMenu">
-        {% for nav_info in xconfig.WebConfig.custom_nav_list %}
-          <a href="{{_server_home}}{{nav_info.url}}">{{T(nav_info.name)}}</a>
-        {% end %}
-      </div>
-    </div>
-    {% end %}
-
-  </div>
-
-  <div id="poweredBy">
-    <!-- 关于可以挂外链 -->
-    <div><a href="{{xconfig.WebConfig.about_url}}">{{T(xconfig.WebConfig.about_text)}}</a></div>
-  </div>
-</div>
-
-<script>
-  (function () {
-    $(".nav-left").width(xnote.device.leftNavWidth);
-  })();
+<style>
+  .nav {
+    display: none;
+  }
+
+  .nav-left {
+    display: block;
+  }
+
+  .nav-left-block {
+    display: block;
+    float: left;
+    width: 100%;
+    margin-bottom: 10px;
+  }
+
+  .nav-left-block a {
+    display: block;
+    float: left;
+    width: 100%;
+    color: white;
+    padding-left: 40px;
+    padding-bottom: 5px;
+    padding-top: 5px;
+  }
+
+  .nav-left-block a:hover {
+    background-color: #333;
+  }
+
+  @media screen and (max-width: 1000px) {
+    /* mobile mode */
+    .nav {
+      display: block;
+    }
+
+    .nav-left {
+      display: none;
+    }
+  }
+</style>
+<div class="nav-left">
+  <div class="nav-scroll">
+    <!-- 侧边菜单栏 -->
+    <div class="nav-left-block">
+      <div class="navMenu">
+        {% if _has_login %}
+        <!-- 登录状态 -->
+        <a href="{{_server_home}}/note/index">{{T("首页")}}</a>
+        <a href="{{_server_home}}/note/recent?orderby=update">{{T("动态")}}</a>
+        <a href="{{_server_home}}/note/taglist">{{T("标签")}}</a>
+        <a href="{{_server_home}}/search/history">{{T("搜索")}}</a>
+        <a href="{{_server_home}}/note/public">{{T("分享")}}</a>
+        {% end %}
+      </div>
+    </div>
+
+    <div class="nav-left-block">
+      <div class="navMenu">
+        {% if _has_login %}
+        <!-- 登录状态 -->
+        <a href="{{_server_home}}/message?tag=task">{{T("待办")}}</a>
+        <a href="{{_server_home}}/message?tag=log">{{T("随手记")}}</a>
+        {% end %}
+      </div>
+    </div>
+
+    <div class="nav-left-block">
+      <div class="navMenu">
+        {% if _has_login %}
+        <a href="{{_server_home}}/system/index">{{T("应用")}}</a>
+        <a href="{{_server_home}}/plugins_list">{{T("插件")}}</a>
+        <a href="{{_server_home}}/system/settings">{{T("设置")}}</a>
+        {% end %}
+
+        {% if _is_admin %}
+        <a href="{{_server_home}}/fs_list">{{T("文件")}}</a>
+        <a href="{{_server_home}}/system/admin">{{T("后台")}}</a>
+        {% end %}
+
+        {% if not _has_login %}
+        <!-- 未登录状态 -->
+        <a href="{{_server_home}}/note/public">分享</a>
+        <a href="{{_server_home}}/login" class="afinve"><span>登录</span></a>
+        {% end %}
+      </div>
+    </div>
+
+    {% if len(xconfig.WebConfig.custom_nav_list) > 0 %}
+    <div class="nav-left-block">
+      <div class="navMenu">
+        {% for nav_info in xconfig.WebConfig.custom_nav_list %}
+          <a href="{{_server_home}}{{nav_info.url}}">{{T(nav_info.name)}}</a>
+        {% end %}
+      </div>
+    </div>
+    {% end %}
+
+  </div>
+
+  <div id="poweredBy">
+    <!-- 关于可以挂外链 -->
+    <div><a href="{{xconfig.WebConfig.about_url}}">{{T(xconfig.WebConfig.about_text)}}</a></div>
+  </div>
+</div>
+
+<script>
+  (function () {
+    $(".nav-left").width(xnote.device.leftNavWidth);
+  })();
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/common/nav/base_nav_project.html` & `xnote-web-0.1.1/handlers/common/nav/base_nav_project.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/nav/base_nav_top.html` & `xnote-web-0.1.1/handlers/common/nav/base_nav_top.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/nav/content_nav.html` & `xnote-web-0.1.1/handlers/common/nav/content_nav.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/pagination.html` & `xnote-web-0.1.1/handlers/common/pagination.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/script/adjust.html` & `xnote-web-0.1.1/handlers/common/script/adjust.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/script/geo_location.html` & `xnote-web-0.1.1/handlers/common/script/geo_location.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/script/image_fix_2.html` & `xnote-web-0.1.1/handlers/common/script/image_fix_2.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/script/require_init.html` & `xnote-web-0.1.1/handlers/common/script/require_init.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/script/textarea_script.html` & `xnote-web-0.1.1/handlers/common/script/textarea_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/search/search_box.html` & `xnote-web-0.1.1/handlers/common/search/search_box.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/search/search_mobile.html` & `xnote-web-0.1.1/handlers/common/search/search_mobile.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/sidebar/app_index.html` & `xnote-web-0.1.1/handlers/common/sidebar/app_index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/theme/sidebar.html` & `xnote-web-0.1.1/handlers/common/theme/sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/common/theme/sidebar_left.html` & `xnote-web-0.1.1/handlers/common/theme/sidebar_left.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/cron/cron_stats.py` & `xnote-web-0.1.1/handlers/cron/cron_stats.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/cron/diskclean.py` & `xnote-web-0.1.1/handlers/cron/diskclean.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/component/dict_sidebar.html` & `xnote-web-0.1.1/handlers/dict/component/dict_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/dao_relevant.py` & `xnote-web-0.1.1/handlers/dict/dao_relevant.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/dict.py` & `xnote-web-0.1.1/handlers/dict/dict.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,168 +1,168 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2019/02/15 21:46:37
-# @modified 2022/04/18 23:25:56
-
-from xnote.core import xtables
-from xnote.core import xtemplate
-import xutils
-from xnote.core import xauth
-from xnote.core import xconfig
-from xnote.core import xmanager
-import math
-from xutils import Storage, encode_uri_component, dateutil
-
-from . import dict_dao
-from handlers.dict.dict_dao import search_dict, convert_dict_func
-
-PAGE_SIZE = xconfig.PAGE_SIZE
-
-class DictEditHandler:
-
-    def GET(self, name=""):
-        if name is None:
-            name = ""
-        name  = xutils.unquote(name)
-        table = xtables.get_dict_table()
-        item  = table.select_first(where=dict(key=name))
-        value = ""
-        if item != None:
-            value = item.value
-        return xtemplate.render("dict/page/dict_edit.html", 
-            name = name, value = value, search_type = "dict")
-
-    @xauth.login_required("admin")
-    def POST(self, name=""):
-        key   = xutils.get_argument("name", "")
-        value = xutils.get_argument("value", "")
-        if key != "" and value != "":
-            key   = xutils.unquote(key)
-            table = xtables.get_dict_table()
-            item  = table.select_first(where=dict(key=key))
-            if item != None:
-                table.update(value = value, where = dict(key = key))
-            else:
-                table.insert(key = key, value = value)
-        return self.GET(name)
-
-class DictSearchHandler:
-
-    def GET(self):
-        key  = xutils.get_argument("key")
-        page = xutils.get_argument_int("page", 1)
-        items, count = search_dict(key, (page-1) * PAGE_SIZE)
-        page_max = math.ceil(count / PAGE_SIZE)
-
-        return xtemplate.render("dict/page/dict_list.html", 
-            show_aside = True,
-            files      = items, 
-            file_type  = "group",
-            show_opts  = False,
-            page       = page,
-            page_max   = page_max,
-            show_pagination = True,
-            page_url   = "/dict/search?key=%s&page=" % encode_uri_component(key), 
-            search_type = "dict")
-
-
-class DictHandler:
-
-    def GET(self):
-        page = xutils.get_argument_int("page", 1)
-        db = xtables.get_dict_table()
-        items = db.select(order="id", limit=PAGE_SIZE, offset=(page-1)*PAGE_SIZE)
-        items = map(convert_dict_func, items)
-        count = db.count()
-        page_max = math.ceil(count / PAGE_SIZE)
-
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(user_name, "/note/dict")
-
-        return xtemplate.render("dict/page/dict_list.html", 
-            show_aside = True,
-            files      = list(items), 
-            file_type  = "group",
-            show_opts  = False,
-            page       = page,
-            page_max   = page_max,
-            pathlist   = [Storage(name = "词典", url = "#")],
-            show_pagination = True,
-            page_url   = "/note/dict?page=",
-            search_type = "dict")
-
-class DictAddHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        return xtemplate.render("dict/page/dict_add.html")
-
-class DictUpdateHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        item_id = xutils.get_argument_int("id")
-        item = dict_dao.get_by_id(item_id)
-        kw = Storage()
-        if item != None:
-            kw.name = item.key
-            kw.value = item.value
-        return xtemplate.render("dict/page/dict_update.html", **kw)
-
-class CreateAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        key = xutils.get_argument_str("key", "")
-        value = xutils.get_argument_str("value", "")
-        if key == "":
-            return dict(code="400", message="key不能为空")
-
-        if value == "":
-            return dict(code="400", message="value不能为空")
-
-        key   = xutils.unquote(key)
-        item  = dict_dao.get_by_key(key)
-        if item != None:
-            return dict(code="302", message="记录已经存在，请前往更新", data = dict(url = "/dict/update?id=%s" % item.id))
-        else:
-            new_record = dict_dao.DictItem()
-            new_record.key = key
-            new_record.value = value
-            new_record.ctime = dateutil.format_datetime()
-            new_record.mtime = dateutil.format_datetime()
-            id = dict_dao.create(new_record)
-            return dict(code="success", data = dict(url = "/dict/update?id=%s" % id))
-
-
-class UpdateAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        id = xutils.get_argument_int("id")
-        value = xutils.get_argument_str("value")
-        dict_dao.update(id, value)
-        return dict(code="success")
-
-
-class DeleteAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        id = xutils.get_argument_int("id")
-        dict_dao.delete(id)
-        return dict(code="success")
-
-xutils.register_func("dict.search", search_dict)
-
-xurls = (
-    r"/dict/add", DictAddHandler,
-    r"/dict/edit/(.+)", DictEditHandler,
-    r"/dict/update",    DictUpdateHandler,
-    r"/dict/search",    DictSearchHandler,
-    r"/dict/list",      DictHandler,
-    r"/note/dict",      DictHandler,
-
-    r"/api/dict/create", CreateAjaxHandler,
-    r"/api/dict/update", UpdateAjaxHandler,
-    r"/api/dict/delete", DeleteAjaxHandler,
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2019/02/15 21:46:37
+# @modified 2022/04/18 23:25:56
+
+from xnote.core import xtables
+from xnote.core import xtemplate
+import xutils
+from xnote.core import xauth
+from xnote.core import xconfig
+from xnote.core import xmanager
+import math
+from xutils import Storage, encode_uri_component, dateutil
+
+from . import dict_dao
+from handlers.dict.dict_dao import search_dict, convert_dict_func
+
+PAGE_SIZE = xconfig.PAGE_SIZE
+
+class DictEditHandler:
+
+    def GET(self, name=""):
+        if name is None:
+            name = ""
+        name  = xutils.unquote(name)
+        table = xtables.get_dict_table()
+        item  = table.select_first(where=dict(key=name))
+        value = ""
+        if item != None:
+            value = item.value
+        return xtemplate.render("dict/page/dict_edit.html", 
+            name = name, value = value, search_type = "dict")
+
+    @xauth.login_required("admin")
+    def POST(self, name=""):
+        key   = xutils.get_argument("name", "")
+        value = xutils.get_argument("value", "")
+        if key != "" and value != "":
+            key   = xutils.unquote(key)
+            table = xtables.get_dict_table()
+            item  = table.select_first(where=dict(key=key))
+            if item != None:
+                table.update(value = value, where = dict(key = key))
+            else:
+                table.insert(key = key, value = value)
+        return self.GET(name)
+
+class DictSearchHandler:
+
+    def GET(self):
+        key  = xutils.get_argument("key")
+        page = xutils.get_argument_int("page", 1)
+        items, count = search_dict(key, (page-1) * PAGE_SIZE)
+        page_max = math.ceil(count / PAGE_SIZE)
+
+        return xtemplate.render("dict/page/dict_list.html", 
+            show_aside = True,
+            files      = items, 
+            file_type  = "group",
+            show_opts  = False,
+            page       = page,
+            page_max   = page_max,
+            show_pagination = True,
+            page_url   = "/dict/search?key=%s&page=" % encode_uri_component(key), 
+            search_type = "dict")
+
+
+class DictHandler:
+
+    def GET(self):
+        page = xutils.get_argument_int("page", 1)
+        db = xtables.get_dict_table()
+        items = db.select(order="id", limit=PAGE_SIZE, offset=(page-1)*PAGE_SIZE)
+        items = map(convert_dict_func, items)
+        count = db.count()
+        page_max = math.ceil(count / PAGE_SIZE)
+
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(user_name, "/note/dict")
+
+        return xtemplate.render("dict/page/dict_list.html", 
+            show_aside = True,
+            files      = list(items), 
+            file_type  = "group",
+            show_opts  = False,
+            page       = page,
+            page_max   = page_max,
+            pathlist   = [Storage(name = "词典", url = "#")],
+            show_pagination = True,
+            page_url   = "/note/dict?page=",
+            search_type = "dict")
+
+class DictAddHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        return xtemplate.render("dict/page/dict_add.html")
+
+class DictUpdateHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        item_id = xutils.get_argument_int("id")
+        item = dict_dao.get_by_id(item_id)
+        kw = Storage()
+        if item != None:
+            kw.name = item.key
+            kw.value = item.value
+        return xtemplate.render("dict/page/dict_update.html", **kw)
+
+class CreateAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        key = xutils.get_argument_str("key", "")
+        value = xutils.get_argument_str("value", "")
+        if key == "":
+            return dict(code="400", message="key不能为空")
+
+        if value == "":
+            return dict(code="400", message="value不能为空")
+
+        key   = xutils.unquote(key)
+        item  = dict_dao.get_by_key(key)
+        if item != None:
+            return dict(code="302", message="记录已经存在，请前往更新", data = dict(url = "/dict/update?id=%s" % item.id))
+        else:
+            new_record = dict_dao.DictItem()
+            new_record.key = key
+            new_record.value = value
+            new_record.ctime = dateutil.format_datetime()
+            new_record.mtime = dateutil.format_datetime()
+            id = dict_dao.create(new_record)
+            return dict(code="success", data = dict(url = "/dict/update?id=%s" % id))
+
+
+class UpdateAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        id = xutils.get_argument_int("id")
+        value = xutils.get_argument_str("value")
+        dict_dao.update(id, value)
+        return dict(code="success")
+
+
+class DeleteAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        id = xutils.get_argument_int("id")
+        dict_dao.delete(id)
+        return dict(code="success")
+
+xutils.register_func("dict.search", search_dict)
+
+xurls = (
+    r"/dict/add", DictAddHandler,
+    r"/dict/edit/(.+)", DictEditHandler,
+    r"/dict/update",    DictUpdateHandler,
+    r"/dict/search",    DictSearchHandler,
+    r"/dict/list",      DictHandler,
+    r"/note/dict",      DictHandler,
+
+    r"/api/dict/create", CreateAjaxHandler,
+    r"/api/dict/update", UpdateAjaxHandler,
+    r"/api/dict/delete", DeleteAjaxHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/dict/dict_dao.py` & `xnote-web-0.1.1/handlers/dict/dict_dao.py`

 * *Ordering differences only*

 * *Files 10% similar despite different names*

```diff
@@ -1,100 +1,100 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-04-15 14:39:26
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-24 21:37:56
-@FilePath     : /xnote/handlers/dict/dict_dao.py
-@Description  : 描述
-"""
-from xnote.core import xtables
-from xnote.core import xconfig
-from xutils import Storage
-from xutils import dateutil, is_str
-
-PAGE_SIZE = xconfig.PAGE_SIZE
-
-
-class DictItem(Storage):
-
-    def __init__(self):
-        self.key = ""
-        self.value = ""
-        self.ctime = ""
-        self.mtime = ""
-
-def dict_to_obj(item):
-    if item == None:
-        return None
-    result = DictItem()
-    result.update(item)
-    return result
-
-def get_by_key(key):
-    table = xtables.get_dict_table()
-    item = table.select_first(where=dict(key=key))
-    return dict_to_obj(item)
-
-def get_by_id(id):
-    table = xtables.get_dict_table()
-    item = table.select_first(where=dict(id=id))
-    return dict_to_obj(item)
-
-def create(dict_item):
-    table = xtables.get_dict_table()
-    return table.insert(**dict_item)
-
-def update(id, value):
-    assert isinstance(id, int), "id必须为数字"
-    table = xtables.get_dict_table()
-    now = dateutil.format_datetime()
-    return table.update(value = value, mtime = now, where = dict(id = id))
-
-def delete(id):
-    table = xtables.get_dict_table()
-    return table.delete(where = dict(id = id))
-
-
-def convert_dict_func(item):
-    v = Storage()
-    v.name = item.key
-    v.value = item.value
-    v.summary = item.value
-    v.mtime = item.mtime
-    v.ctime = item.ctime
-    v.url = "/dict/update?id=%s" % item.id
-    v.priority = 0
-    v.show_next = True
-    return v
-
-
-def escape_sqlite_text(text):
-    text = text.replace('/', '//')
-    text = text.replace("'", '\'\'')
-    text = text.replace('[', '/[')
-    text = text.replace(']', '/]')
-    text = text.replace('(', '/(')
-    text = text.replace(')', '/)')
-    return text
-
-def search_escape(text):
-    if not is_str(text):
-        return text
-    text = escape_sqlite_text(text)
-    return "'%" + text + "%'"
-
-
-def left_match_escape(text):
-    return "'%s%%'" % escape_sqlite_text(text)
-
-
-def search_dict(key, offset = 0, limit = None):
-    if limit is None:
-        limit = PAGE_SIZE
-    db = xtables.get_dict_table()
-    where_sql = "`key` LIKE %s" % left_match_escape(key)
-    items = db.select(order="key", where = where_sql, limit=limit, offset=offset)
-    items = list(map(convert_dict_func, items))
-    count = db.count(where = where_sql)
-    return items, count
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-04-15 14:39:26
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-24 21:37:56
+@FilePath     : /xnote/handlers/dict/dict_dao.py
+@Description  : 描述
+"""
+from xnote.core import xtables
+from xnote.core import xconfig
+from xutils import Storage
+from xutils import dateutil, is_str
+
+PAGE_SIZE = xconfig.PAGE_SIZE
+
+
+class DictItem(Storage):
+
+    def __init__(self):
+        self.key = ""
+        self.value = ""
+        self.ctime = ""
+        self.mtime = ""
+
+def dict_to_obj(item):
+    if item == None:
+        return None
+    result = DictItem()
+    result.update(item)
+    return result
+
+def get_by_key(key):
+    table = xtables.get_dict_table()
+    item = table.select_first(where=dict(key=key))
+    return dict_to_obj(item)
+
+def get_by_id(id):
+    table = xtables.get_dict_table()
+    item = table.select_first(where=dict(id=id))
+    return dict_to_obj(item)
+
+def create(dict_item):
+    table = xtables.get_dict_table()
+    return table.insert(**dict_item)
+
+def update(id, value):
+    assert isinstance(id, int), "id必须为数字"
+    table = xtables.get_dict_table()
+    now = dateutil.format_datetime()
+    return table.update(value = value, mtime = now, where = dict(id = id))
+
+def delete(id):
+    table = xtables.get_dict_table()
+    return table.delete(where = dict(id = id))
+
+
+def convert_dict_func(item):
+    v = Storage()
+    v.name = item.key
+    v.value = item.value
+    v.summary = item.value
+    v.mtime = item.mtime
+    v.ctime = item.ctime
+    v.url = "/dict/update?id=%s" % item.id
+    v.priority = 0
+    v.show_next = True
+    return v
+
+
+def escape_sqlite_text(text):
+    text = text.replace('/', '//')
+    text = text.replace("'", '\'\'')
+    text = text.replace('[', '/[')
+    text = text.replace(']', '/]')
+    text = text.replace('(', '/(')
+    text = text.replace(')', '/)')
+    return text
+
+def search_escape(text):
+    if not is_str(text):
+        return text
+    text = escape_sqlite_text(text)
+    return "'%" + text + "%'"
+
+
+def left_match_escape(text):
+    return "'%s%%'" % escape_sqlite_text(text)
+
+
+def search_dict(key, offset = 0, limit = None):
+    if limit is None:
+        limit = PAGE_SIZE
+    db = xtables.get_dict_table()
+    where_sql = "`key` LIKE %s" % left_match_escape(key)
+    items = db.select(order="key", where = where_sql, limit=limit, offset=offset)
+    items = list(map(convert_dict_func, items))
+    count = db.count(where = where_sql)
+    return items, count
```

### Comparing `xnote-web-0.1.0/handlers/dict/dict_relevant.py` & `xnote-web-0.1.1/handlers/dict/dict_relevant.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/page/dict_add.html` & `xnote-web-0.1.1/handlers/dict/page/dict_add.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/page/dict_edit.html` & `xnote-web-0.1.1/handlers/dict/page/dict_edit.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/page/dict_list.html` & `xnote-web-0.1.1/handlers/dict/page/dict_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/page/dict_update.html` & `xnote-web-0.1.1/handlers/dict/page/dict_update.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/dict/page/relevant_list.html` & `xnote-web-0.1.1/handlers/dict/page/relevant_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/error.html` & `xnote-web-0.1.1/handlers/error.html`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,27 +1,27 @@
-{% extends base %}
-{% block body %}
-
-    {% init error = "" %}
-
-    <div class="card">
-        <div class="card-title">
-            <span>系统错误</span>
-            <div class="float-right">
-                {% include common/button/back_button.html %}
-            </div>
-        </div>
-    </div>
-
-    {% if error != "" %}
-        <div class="card">
-            <pre class="col-md-12 error">
-                {{error}}
-            </pre>
-        </div>
-    {% end %}
-
-{% end %}
-
-{% block body_right %}
-    {% include common/sidebar/default.html %}
-{% end %}
+{% extends base %}
+{% block body %}
+
+    {% init error = "" %}
+
+    <div class="card">
+        <div class="card-title">
+            <span>系统错误</span>
+            <div class="float-right">
+                {% include common/button/back_button.html %}
+            </div>
+        </div>
+    </div>
+
+    {% if error != "" %}
+        <div class="card">
+            <pre class="col-md-12 error">
+                {{error}}
+            </pre>
+        </div>
+    {% end %}
+
+{% end %}
+
+{% block body_right %}
+    {% include common/sidebar/default.html %}
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/component/clipboard-dialog.html` & `xnote-web-0.1.1/handlers/fs/component/clipboard-dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/component/filelist_gallery.html` & `xnote-web-0.1.1/handlers/fs/component/filelist_gallery.html`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,34 +1,34 @@
-{% import os %}
-{% from xutils import fsutil %}
-{% init show_rename_file_link = True %}
-{% init get_file_thumbnail = xutils.get_func_by_name("fs.get_file_thumbnail") %}
-{% init get_file_download_link = xutils.get_func_by_name("fs.get_file_download_link") %}
-
-<table class="table row">
-    {% for fpath in pathlist %}
-        {% set fname = os.path.basename(fpath) %}
-        {% set display_name = fsutil.get_display_name(fpath, dirname) %}
-        <tr>
-            <td>
-                <!-- <a href="{{fsutil.get_webpath(fpath)}}">{{display_name}}</a> -->
-                <img class="fs-thumbnail x-photo" src="{{get_file_thumbnail(fpath)}}" 
-                    data-src="{{get_file_download_link(fpath)}}" title="{{fname}}"/>
-            </td>
-            <td class="option-td">
-                {{xutils.format_file_size(fpath)}}
-            </td>
-            <td class="option-td">
-                <div class="float-right">
-                    {% if show_rename_file_link %}
-                        <a class="rename-btn" data-name="{{display_name}}">重命名</a>
-                    {% end %}
-                    <a href="{{get_file_download_link(fpath)}}">下载</a>
-                    <a class="danger-link" data-path="{{fpath}}" data-name="{{display_name}}" 
-                    onclick="xnote.action.fs.delete(this);">删除</a>
-                </div>
-            </td>
-        </tr>
-    {% end %}
-</table>
-
-{% include fs/component/script/file_op_script.html %}
+{% import os %}
+{% from xutils import fsutil %}
+{% init show_rename_file_link = True %}
+{% init get_file_thumbnail = xutils.get_func_by_name("fs.get_file_thumbnail") %}
+{% init get_file_download_link = xutils.get_func_by_name("fs.get_file_download_link") %}
+
+<table class="table row">
+    {% for fpath in pathlist %}
+        {% set fname = os.path.basename(fpath) %}
+        {% set display_name = fsutil.get_display_name(fpath, dirname) %}
+        <tr>
+            <td>
+                <!-- <a href="{{fsutil.get_webpath(fpath)}}">{{display_name}}</a> -->
+                <img class="fs-thumbnail x-photo" src="{{get_file_thumbnail(fpath)}}" 
+                    data-src="{{get_file_download_link(fpath)}}" title="{{fname}}"/>
+            </td>
+            <td class="option-td">
+                {{xutils.format_file_size(fpath)}}
+            </td>
+            <td class="option-td">
+                <div class="float-right">
+                    {% if show_rename_file_link %}
+                        <a class="rename-btn" data-name="{{display_name}}">重命名</a>
+                    {% end %}
+                    <a href="{{get_file_download_link(fpath)}}">下载</a>
+                    <a class="danger-link" data-path="{{fpath}}" data-name="{{display_name}}" 
+                    onclick="xnote.action.fs.delete(this);">删除</a>
+                </div>
+            </td>
+        </tr>
+    {% end %}
+</table>
+
+{% include fs/component/script/file_op_script.html %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/component/filelist_simple.html` & `xnote-web-0.1.1/handlers/fs/component/filelist_simple.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/component/move_file_dialog.html` & `xnote-web-0.1.1/handlers/fs/component/move_file_dialog.html`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,122 +1,122 @@
-<!-- 移动文件功能 -->
-
-<div class="file-element-tpl hide">
-    <div class="fs-move-row">
-        <i class="fa ${icon}"></i>
-        <a class="fs-move-row-link" data-path="${path}">${name}</a>
-    </div>
-</div>
-
-<input type="hidden" class="current-dirname"/>
-
-<script type="text/javascript">
-if (xnote.action.fs == undefined) {
-    xnote.action.fs = {};
-}
-
-$(function () {
-    /**
-     * 简单的模板渲染，这里假设传进来的参数已经进行了html转义
-     */
-    function renderTemplate(templateText, object) {
-        return xnote.renderTemplate(templateText, object);
-    }
-
-    function moveFile(fpath, dirname, context) {
-        var data = {old_path: fpath, dirname: dirname};
-        xnote.http.post("/fs_api/paste", data, function (resp) {
-            if (resp.code != "success") {
-                layer.message("failed to paste " + dataPath);
-            } else {
-                context.count -= 1;
-                if (context.count == 0) {
-                    setTimeout(function () {
-                        window.location.reload();
-                    }, 500);
-                }
-            }
-        });
-    }
-
-    function updateMoveFileDialog(elementId, fpath) {
-        var params = {fpath: fpath, show_parent: true, filter: "dir"};
-        
-        $(".current-dirname").val(fpath);
-        xnote.http.get("/fs_api/list", params, function (resp) {
-            console.log(resp);
-            if (resp.code != "success") {
-                layer.alert("查询文件列表失败:" + resp.message);
-            } else {
-                $("#" + elementId).empty();
-                // $("#" + elementId).append($("<span>").text(resp.fpath));
-
-                for (var i = 0; i < resp.data.length; i++) {
-                    var fileObject = resp.data[i];
-                    var templateHtml = $(".file-element-tpl").html();
-                    $("#" + elementId).append(renderTemplate(templateHtml, fileObject));
-                }
-
-                registerDialogLinkEvent(elementId);
-            }
-        }).fail(function (resp) {
-            layer.alert("查询文件列表失败:" + resp);
-        });
-    }
-
-    function registerDialogLinkEvent(elementId) {
-        $(".fs-move-row-link").click(function (event) {
-            var path = $(this).attr("data-path");
-            updateMoveFileDialog(elementId, path);
-        })
-    }
-
-    // 打开移动文件的对话框
-    xnote.action.fs.openMoveDialog = function(req) {
-        var selectedFiles = req.selectedFiles;
-
-        var elementId = "moveFileDialog" + new Date().getTime();
-        var respHtml = '<div class="move-file-dialog" id="' + elementId + '"></div>';
-
-        xnote.showDialog("移动文件", respHtml, ["移动到这里", "取消"],
-            function (index, layero) {
-                console.log(index, layero);
-                layer.close(index);
-
-                var dirname = $(".current-dirname").val();
-
-                context = {count: selectedFiles.length};
-                // layer.msg("选择了移动");
-                for (var i = 0; i < selectedFiles.length; i++) {
-                    var fpath = selectedFiles[i];
-                    moveFile(fpath, dirname, context);
-                }
-        });
-
-        updateMoveFileDialog(elementId, "{{path}}");
-    };
-
-
-    $("#moveFilesBtn").click(function () {
-        // 1. 检查是否选中文件
-        // 2. 弹出选择弹窗
-        // 3. 执行移动
-
-        var selectedFileElements = $(":checked");
-        if (selectedFileElements.length == 0) {
-            layer.alert("请选择文件");
-            return;
-        }
-        var selectedFiles = [];
-        for (var i = 0 ; i < selectedFileElements.length; i++) {
-            var item = selectedFileElements[i];
-            selectedFiles.push($(item).attr("data-path"));
-        }
-
-        var req = {
-            selectedFiles: selectedFiles,
-        };
-
-        xnote.action.fs.openMoveDialog(req);
-    });
-});
-</script>
+<!-- 移动文件功能 -->
+
+<div class="file-element-tpl hide">
+    <div class="fs-move-row">
+        <i class="fa ${icon}"></i>
+        <a class="fs-move-row-link" data-path="${path}">${name}</a>
+    </div>
+</div>
+
+<input type="hidden" class="current-dirname"/>
+
+<script type="text/javascript">
+if (xnote.action.fs == undefined) {
+    xnote.action.fs = {};
+}
+
+$(function () {
+    /**
+     * 简单的模板渲染，这里假设传进来的参数已经进行了html转义
+     */
+    function renderTemplate(templateText, object) {
+        return xnote.renderTemplate(templateText, object);
+    }
+
+    function moveFile(fpath, dirname, context) {
+        var data = {old_path: fpath, dirname: dirname};
+        xnote.http.post("/fs_api/paste", data, function (resp) {
+            if (resp.code != "success") {
+                layer.message("failed to paste " + dataPath);
+            } else {
+                context.count -= 1;
+                if (context.count == 0) {
+                    setTimeout(function () {
+                        window.location.reload();
+                    }, 500);
+                }
+            }
+        });
+    }
+
+    function updateMoveFileDialog(elementId, fpath) {
+        var params = {fpath: fpath, show_parent: true, filter: "dir"};
+        
+        $(".current-dirname").val(fpath);
+        xnote.http.get("/fs_api/list", params, function (resp) {
+            console.log(resp);
+            if (resp.code != "success") {
+                layer.alert("查询文件列表失败:" + resp.message);
+            } else {
+                $("#" + elementId).empty();
+                // $("#" + elementId).append($("<span>").text(resp.fpath));
+
+                for (var i = 0; i < resp.data.length; i++) {
+                    var fileObject = resp.data[i];
+                    var templateHtml = $(".file-element-tpl").html();
+                    $("#" + elementId).append(renderTemplate(templateHtml, fileObject));
+                }
+
+                registerDialogLinkEvent(elementId);
+            }
+        }).fail(function (resp) {
+            layer.alert("查询文件列表失败:" + resp);
+        });
+    }
+
+    function registerDialogLinkEvent(elementId) {
+        $(".fs-move-row-link").click(function (event) {
+            var path = $(this).attr("data-path");
+            updateMoveFileDialog(elementId, path);
+        })
+    }
+
+    // 打开移动文件的对话框
+    xnote.action.fs.openMoveDialog = function(req) {
+        var selectedFiles = req.selectedFiles;
+
+        var elementId = "moveFileDialog" + new Date().getTime();
+        var respHtml = '<div class="move-file-dialog" id="' + elementId + '"></div>';
+
+        xnote.showDialog("移动文件", respHtml, ["移动到这里", "取消"],
+            function (index, layero) {
+                console.log(index, layero);
+                layer.close(index);
+
+                var dirname = $(".current-dirname").val();
+
+                context = {count: selectedFiles.length};
+                // layer.msg("选择了移动");
+                for (var i = 0; i < selectedFiles.length; i++) {
+                    var fpath = selectedFiles[i];
+                    moveFile(fpath, dirname, context);
+                }
+        });
+
+        updateMoveFileDialog(elementId, "{{path}}");
+    };
+
+
+    $("#moveFilesBtn").click(function () {
+        // 1. 检查是否选中文件
+        // 2. 弹出选择弹窗
+        // 3. 执行移动
+
+        var selectedFileElements = $(":checked");
+        if (selectedFileElements.length == 0) {
+            layer.alert("请选择文件");
+            return;
+        }
+        var selectedFiles = [];
+        for (var i = 0 ; i < selectedFileElements.length; i++) {
+            var item = selectedFileElements[i];
+            selectedFiles.push($(item).attr("data-path"));
+        }
+
+        var req = {
+            selectedFiles: selectedFiles,
+        };
+
+        xnote.action.fs.openMoveDialog(req);
+    });
+});
+</script>
```

### Comparing `xnote-web-0.1.0/handlers/fs/component/options/fs_options.html` & `xnote-web-0.1.1/handlers/fs/component/options/fs_options.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/component/options/fs_options_buttons.html` & `xnote-web-0.1.1/handlers/fs/component/options/fs_options_buttons.html`

 * *Files 7% similar despite different names*

```diff
@@ -45,15 +45,14 @@
         <div class="dropdown">
             <span class="dropdown-btn link btn">更多▾</span>
             <div class="dropdown-content">
                 <a class="dropdown-option" href="{{_server_home}}/code/search?path={{xutils.quote(path)}}&recursive=on">高级搜索</a>
                 <a class="dropdown-option" href="{{_server_home}}/code/lines?path={{xutils.quote(path)}}&recursive=on">代码统计</a>
                 <a class="dropdown-option" href="{{_server_home}}/fs/~{{path}}?show_hidden_files=true">显示隐藏文件</a>
                 <a class="dropdown-option" id="addToBookmarkBtn">收藏</a>
-                <a class="dropdown-option rebuild-index-option">重建索引</a>
 
                 <!-- 移动端选项 -->
                 <a class="dropdown-option delete-btn mobile-only">删除</a>
             </div>
         </div>
     </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/fs/component/options/fs_options_buttons.mobile.html` & `xnote-web-0.1.1/handlers/fs/component/options/fs_options_buttons.mobile.html`

 * *Files 5% similar despite different names*

```diff
@@ -30,12 +30,11 @@
         <div class="dropdown">
             <span class="dropdown-btn link btn">更多▾</span>
             <div class="dropdown-content">
                 <a class="dropdown-option" href="{{_server_home}}/code/search?path={{xutils.quote(path)}}&recursive=on">高级搜索</a>
                 <a class="dropdown-option" href="{{_server_home}}/code/lines?path={{xutils.quote(path)}}&recursive=on">代码统计</a>
                 <a class="dropdown-option" href="{{_server_home}}/fs~{{path}}?show_hidden_files=true">显示隐藏文件</a>
                 <a class="dropdown-option" id="addToBookmarkBtn">收藏</a>
-                <a class="dropdown-option rebuild-index-option">重建索引</a>
             </div>
         </div>
     </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/fs/component/options_css.html` & `xnote-web-0.1.1/handlers/fs/component/options_css.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/component/plugins-dialog.html` & `xnote-web-0.1.1/handlers/fs/component/plugins-dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/component/script/file_op_script.html` & `xnote-web-0.1.1/handlers/fs/component/script/file_op_script.html`

 * *Files 14% similar despite different names*

```diff
@@ -1,380 +1,379 @@
-{% init file_op_script_loaded = False %}
-{% init path = "" %}
-{% if not file_op_script_loaded %}
-{% set-global file_op_script_loaded = True %}
-{% include fs/component/move_file_dialog.html %}
-
-<input type="hidden" id="currentPath" value="{{path}}">
-
-<script type="text/template" id="fileItemOptionDialog">
-    <div class="card">
-        <div class="align-center">
-            <button class="btn btn-default huge" data-path="{{!filePath}}" 
-                onclick="xnote.action.fs.download(this);">下载</button>
-            <button class="btn btn-default huge" 
-                data-path="{{!filePath}}" 
-                data-name="{{!fileName}}"
-                data-realname="{{!fileRealName}}"
-                onclick="xnote.action.fs.rename(this);">重命名</button>
-            <button class="btn btn-default huge" 
-                data-path="{{!filePath}}"
-                data-name="{{!fileName}}"
-                data-realname="{{!fileRealName}}"
-                onclick="xnote.action.fs.delete(this);">删除</button>
-            <button class="btn btn-default huge"
-                data-path="{{!filePath}}"
-                onclick="xnote.action.fs.move(this);">移动</button>
-            <button class="btn btn-default huge"
-                onclick="xnote.action.fs.copy(this);">复制</button>
-            <button class="btn btn-default huge"
-                onclick="xnote.action.fs.showDetail(this);">详细信息</button>
-        </div>
-    </div>
-</script>
-
-<script type="text/javascript">
-
-xnote.action.fs.download = function(target) {
-    var path = $(target).attr("data-path");
-    window.open("{{_server_home}}/fs/~" + path +"?type=blob", "_blank");
-};
-
-xnote.action.fs.move = function(target) {
-    var path = $(target).attr("data-path");
-    var req = {
-        selectedFiles: [path]
-    };
-    xnote.action.fs.openMoveDialog(req);
-};
-
-xnote.action.fs.copy = function(target) {
-    xnote.alert("功能开发中...");
-};
-
-xnote.action.fs.showDetail = function(target) {
-    xnote.alert("功能开发中...");
-};
-
-$(function () {
-    $(".rename-btn").click(function (e) {
-        var dirname = $("#dirname").val();
-        var oldName = $(this).attr("data-name");
-        xnote.prompt("输入新的文件名", oldName, function (newName) {
-            if (newName != oldName && newName) {
-                $.post("/fs_api/rename", 
-                    {dirname: dirname, old_name: oldName, new_name: newName}, 
-                    function (resp) {
-                        if (resp.code == "success") {
-                            window.location.reload();
-                        } else {
-                            xnote.alert("重命名失败:" + resp.message);
-                        }
-                }).fail(function (e) {
-                    xnote.alert("系统繁忙，请稍后重试");
-                });
-            } else {
-                xnote.alert("请输入有效文件名");
-            }
-        });
-    });
-
-    $(".delete-btn").click(function (e) {
-        var target = $(e).target;
-        xnote.fs.delete(target);
-    })
-})
-</script>
-
-
-<script type="text/javascript">
-    $(function () {
-        var globalPath = $("#currentPath").val();
-        var globalError = $("#currentError").val();
-    
-        function getCurrentPath() {
-            return $("#currentPath").val();
-        }
-    
-        function previewImages() {
-            $(".fs-image-div").each(function (index, target) {
-                var src = $(target).attr("img-src");
-                var img = $("<img>").attr("src", src)
-                    .attr("alt", src)
-                    .addClass("fs-image")
-                    .addClass("x-photo");
-                $(target).append(img);
-                img.on("load", function (event) {
-                    $(target).append($("<span class='fs-image-size'>").text(img[0].naturalWidth + "*" + img[0].naturalHeight));
-                });
-            })
-            $("#previewImg").val("取消预览");
-        }
-    
-        function togglePreview() {
-            var self = this;
-            var value = $(self).val();
-            if (window.location.hash != '#preview') {
-                previewImages();
-                window.location.hash = '#preview';
-            } else {
-                $(".fs-image").remove();
-                $(".fs-image-size").remove();
-                $(self).val("预览图片");
-                window.location.hash = '';
-            }  
-        }
-    
-        $("#previewImg").on("click", togglePreview);
-    
-        if (window.location.hash == '#preview') {
-            previewImages();
-        }
-    
-        function showErrorMessage(message) {
-            showMessage("error", message);
-        }
-    
-        function showMessage(level, message) {
-            var ele = ".error";
-            if (level == "error") {
-                ele = ".error";
-            }
-            if (level == "success") {
-                ele = ".success";
-            }
-            // $(ele).text(message).fadeIn(200).delay(3000).fadeOut(300);
-            showToast(message, 3000);
-        }
-    
-        function createFile(promptMessage, url) {
-            xnote.prompt(promptMessage, "", function (fileName) {
-                if (fileName && fileName != "") {
-                    $.post(url, {path: globalPath, filename: fileName}, function (respText) {
-                        console.log(respText);
-                        var data = respText;
-                        if (data.code == "success") {
-                            window.location.reload();
-                        } else {
-                            showErrorMessage(data.message);
-                        }
-                    }).fail(function (data) {
-                        console.log(data);
-                        showErrorMessage(data);
-                    })
-                }
-            });
-            
-        }
-    
-        $("#addDirectory").on("click", function (target) {
-            createFile("新建文件夹", "/fs_api/add_dir");
-        });
-    
-        $(".add-file-btn").on("click", function (event) {
-            var target = event.target;
-            var title = $(target).text();
-            var api   = $(target).attr("data-api");
-            createFile(title, api);
-        })
-    
-        $(".native-opener").on("click", function () {
-            openByNative();
-        });
-    
-        window.openByNative = function () {
-            var path = getCurrentPath();
-            $.post("/system/command/open", {path: path});
-        }
-    
-        window.openTerminal = function () {
-            var path = getCurrentPath();
-            $.post("/system/command/openTerminal", {command: "openTerminal", path: path});
-        }
-    
-        $(".command-btn").on("click", function () {
-            var command = $(this).attr("data-command");
-            xnote.http.get("/system/command", {command: command, path: globalPath});
-        })
-    
-        function doDeleteFile(path) {
-            var pathlist;
-            if (path instanceof Array) {
-                pathlist = path
-            } else {
-                pathlist = [path]
-            }
-    
-            var rest = pathlist.length;
-            for (var i = 0; i < pathlist.length; i++) {
-                rest--;
-                var path = pathlist[i];        
-                $.post("/fs_api/remove", {path: path}, function (resp) {
-                    if (resp.code == "success" && rest <= 0) {
-                        location.reload();
-                    } else {
-                        showErrorMessage("删除失败, %s".format(resp.message));
-                    }
-                }).fail(function (resp) {
-                    console.log(resp);
-                    showErrorMessage("删除失败");
-                })
-            }
-        }
-    
-        window.removeFile = function(path) {
-            if (path instanceof Array) {
-                xnote.confirm("确认删除%s个文件?".format(path.length), function (result) {
-                    doDeleteFile(path);
-                });
-            } else {
-                // 从path中获取文件名
-                var name = /([^\/\\]+)[\\\/]?$/.exec(path)[1];
-                name = decodeURI(name);
-    
-                xnote.confirm("确认删除 '%s' ?".format(name), function (result) {
-                    doDeleteFile(path);
-                });
-            }
-        }
-    
-        $(".delete-link").click(function (e) {
-            var path = $(this).attr("data-path");
-            removeFile(path);
-        })
-    
-        $(".delete-btn").on("click", function () {
-            var checked = $(".checkboxTd :checked");
-            if (checked.length == 0) {
-                xnote.alert("请选择文件");
-            } else if (checked.length > 1) {
-                var pathlist = []
-                $(".checkboxTd :checked").each(function (index, element) {
-                    var name = $(element).attr("data-name");
-                    var path = $(element).attr("data-path");
-                    pathlist.push(path);
-                });
-    
-                removeFile(pathlist);
-            } else {
-                var name = checked.attr("data-name");
-                var path = checked.attr("data-path");
-                removeFile(path);
-            }
-        });
-    
-        $("#renameBtn").on("click", function () {
-            var checked = $(".checkboxTd :checked");
-            if (checked.length == 0) {
-                xnote.alert("请选择文件");
-            } else if (checked.length > 1) {
-                xnote.alert("不支持批量重命名");
-            } else {
-                var name = checked.attr("data-name");
-                var path = checked.attr("data-path");
-                var dirname = getCurrentPath();
-                xnote.prompt("重命名为", name, function (new_name) {
-                    if (new_name) {
-                        $.post("/fs_api/rename", 
-                            {dirname: dirname, old_name: name, new_name: new_name}, 
-                            function (resp) {
-                                if (resp.code == "success") {
-                                    location.reload();
-                                } else {
-                                    showErrorMessage("重命名失败, %s".format(resp.message));
-                                }
-                        }).fail(function (resp) {
-                            console.log(resp);
-                            xnote.alert("重命名失败");
-                        })
-                    }
-                });
-            }
-        });
-    
-    
-        $("#cutBtn").on("click", function () {
-            var checked = $(".checkboxTd :checked");
-            if (checked.length == 0) {
-                xnote.alert("请选择文件");
-            } else {
-                var cutPathList = [];
-                checked.each(function (index, element) {
-                    // console.log(element);
-                    var path = $(element).attr("data-path");
-                    console.log(path);
-                    cutPathList.push(path);
-                });
-                var data = {"files": cutPathList};
-                $.post("/fs_api/cut", data, function (resp) {
-                    console.log(resp);
-                    window.location.reload();
-                }).fail(function (errorMessage) {
-                    alert("update clipboard failed!" + errorMessage);
-                })
-            }
-        });
-    
-        $("#showMoreOptsBtn").click(function (event) {
-            $(".advanced-opt").toggle(200);
-        });
-    
-        $("#uploadFileBtn").click(function () {
-            $("#uploadFileArea").toggle(200);
-        });
-    
-        $("#selectAllBtn").click(function () {
-            var toggle = parseInt($(this).attr("toggle") || 0);
-            if (toggle % 2 === 0) {        
-                $("input[type=checkbox]").prop("checked", true);
-                $(this).val("反选");
-            } 
-    
-            if (toggle % 2 === 1) {        
-                $("input[type=checkbox]").prop("checked", false);
-                $(this).val("全选");
-            }
-            toggle += 1;
-            $(this).attr("toggle", toggle);
-        });
-    
-        $("#clipboardBtn").click(function () {
-            showClipboardDialog();
-        });
-    
-        $("#addToBookmarkBtn").click(function (event) {
-            var path = getCurrentPath();
-            var params = {"path": path};
-            $.post("/fs_api/bookmark", params, function (resp) {
-                layer.msg("收藏成功");
-            }).fail(function (e) {
-                layer.alert("收藏失败:" + e);
-            });
-        });
-    
-        $(".fs-sort-btn").click(function (e) {
-            var order = $(e.target).attr("data-order");
-            var params = {
-                "action": "sort",
-                "order": order,
-            };
-            $.post("/fs_api/config", params, function (resp) {
-                if (resp.code === "success") {
-                    window.location.reload();
-                } else {
-                    xnote.alert(resp.message);
-                }
-            });
-        });
-    
-        $(".rebuild-index-option").click(function (e) {
-            xnote.showIframeDialog("重建索引", "/fs_index?p=rebuild&path={{xutils.quote(path)}}&embed=true");
-        });
-    
-        // do not adjust height in mobile
-        if (isPc()) {
-            adjustHeight(".file-list", 30);
-        }
-    });
-</script>
-    
+{% init file_op_script_loaded = False %}
+{% init path = "" %}
+{% if not file_op_script_loaded %}
+{% set-global file_op_script_loaded = True %}
+{% include fs/component/move_file_dialog.html %}
+
+<input type="hidden" id="currentPath" value="{{path}}">
+
+<script type="text/template" id="fileItemOptionDialog">
+    <div class="card dialog-body">
+        <div class="align-center">
+            <button class="btn btn-default huge" data-path="{{!filePath}}" 
+                onclick="xnote.action.fs.download(this);">下载</button>
+            <button class="btn btn-default huge" 
+                data-path="{{!filePath}}" 
+                data-name="{{!fileName}}"
+                data-realname="{{!fileRealName}}"
+                onclick="xnote.action.fs.rename(this);">重命名</button>
+            <button class="btn btn-default huge"
+                data-path="{{!filePath}}"
+                onclick="xnote.action.fs.move(this);">移动</button>
+            <button class="btn btn-default huge"
+                onclick="xnote.action.fs.copy(this);">复制</button>
+            <button class="btn btn-default huge"
+                data-path="{{!filePath}}"
+                onclick="xnote.action.fs.showDetail(this);">详细信息</button>
+            <button class="btn danger huge" 
+                data-path="{{!filePath}}"
+                data-name="{{!fileName}}"
+                data-realname="{{!fileRealName}}"
+                onclick="xnote.action.fs.delete(this);">删除</button>
+        </div>
+    </div>
+
+    <div class="dialog-footer">
+        <div class="float-right">
+            <button class="large btn-default" data-dialog-id="{{!dialogId}}" onclick="xnote.dialog.closeByElement(this)">关闭</button>
+        </div>
+    </div>
+</script>
+
+<script type="text/javascript">
+
+xnote.action.fs.download = function(target) {
+    var path = $(target).attr("data-path");
+    window.open("{{_server_home}}/fs/~" + path +"?type=blob", "_blank");
+};
+
+xnote.action.fs.move = function(target) {
+    var path = $(target).attr("data-path");
+    var req = {
+        selectedFiles: [path]
+    };
+    xnote.action.fs.openMoveDialog(req);
+};
+
+xnote.action.fs.copy = function(target) {
+    xnote.alert("功能开发中...");
+};
+
+$(function () {
+    $(".rename-btn").click(function (e) {
+        var dirname = $("#dirname").val();
+        var oldName = $(this).attr("data-name");
+        xnote.prompt("输入新的文件名", oldName, function (newName) {
+            if (newName != oldName && newName) {
+                $.post("/fs_api/rename", 
+                    {dirname: dirname, old_name: oldName, new_name: newName}, 
+                    function (resp) {
+                        if (resp.code == "success") {
+                            window.location.reload();
+                        } else {
+                            xnote.alert("重命名失败:" + resp.message);
+                        }
+                }).fail(function (e) {
+                    xnote.alert("系统繁忙，请稍后重试");
+                });
+            } else {
+                xnote.alert("请输入有效文件名");
+            }
+        });
+    });
+
+    $(".delete-btn").click(function (e) {
+        var target = $(e).target;
+        xnote.fs.delete(target);
+    })
+})
+</script>
+
+
+<script type="text/javascript">
+    $(function () {
+        var globalPath = $("#currentPath").val();
+        var globalError = $("#currentError").val();
+    
+        function getCurrentPath() {
+            return $("#currentPath").val();
+        }
+    
+        function previewImages() {
+            $(".fs-image-div").each(function (index, target) {
+                var src = $(target).attr("img-src");
+                var img = $("<img>").attr("src", src)
+                    .attr("alt", src)
+                    .addClass("fs-image")
+                    .addClass("x-photo");
+                $(target).append(img);
+                img.on("load", function (event) {
+                    $(target).append($("<span class='fs-image-size'>").text(img[0].naturalWidth + "*" + img[0].naturalHeight));
+                });
+            })
+            $("#previewImg").val("取消预览");
+        }
+    
+        function togglePreview() {
+            var self = this;
+            var value = $(self).val();
+            if (window.location.hash != '#preview') {
+                previewImages();
+                window.location.hash = '#preview';
+            } else {
+                $(".fs-image").remove();
+                $(".fs-image-size").remove();
+                $(self).val("预览图片");
+                window.location.hash = '';
+            }  
+        }
+    
+        $("#previewImg").on("click", togglePreview);
+    
+        if (window.location.hash == '#preview') {
+            previewImages();
+        }
+    
+        function showErrorMessage(message) {
+            showMessage("error", message);
+        }
+    
+        function showMessage(level, message) {
+            var ele = ".error";
+            if (level == "error") {
+                ele = ".error";
+            }
+            if (level == "success") {
+                ele = ".success";
+            }
+            // $(ele).text(message).fadeIn(200).delay(3000).fadeOut(300);
+            showToast(message, 3000);
+        }
+    
+        function createFile(promptMessage, url) {
+            xnote.prompt(promptMessage, "", function (fileName) {
+                if (fileName && fileName != "") {
+                    $.post(url, {path: globalPath, filename: fileName}, function (respText) {
+                        console.log(respText);
+                        var data = respText;
+                        if (data.code == "success") {
+                            window.location.reload();
+                        } else {
+                            showErrorMessage(data.message);
+                        }
+                    }).fail(function (data) {
+                        console.log(data);
+                        showErrorMessage(data);
+                    })
+                }
+            });
+            
+        }
+    
+        $("#addDirectory").on("click", function (target) {
+            createFile("新建文件夹", "/fs_api/add_dir");
+        });
+    
+        $(".add-file-btn").on("click", function (event) {
+            var target = event.target;
+            var title = $(target).text();
+            var api   = $(target).attr("data-api");
+            createFile(title, api);
+        })
+    
+        $(".native-opener").on("click", function () {
+            openByNative();
+        });
+    
+        window.openByNative = function () {
+            var path = getCurrentPath();
+            $.post("/system/command/open", {path: path});
+        }
+    
+        window.openTerminal = function () {
+            var path = getCurrentPath();
+            $.post("/system/command/openTerminal", {command: "openTerminal", path: path});
+        }
+    
+        $(".command-btn").on("click", function () {
+            var command = $(this).attr("data-command");
+            xnote.http.get("/system/command", {command: command, path: globalPath});
+        })
+    
+        function doDeleteFile(path) {
+            var pathlist;
+            if (path instanceof Array) {
+                pathlist = path
+            } else {
+                pathlist = [path]
+            }
+    
+            var rest = pathlist.length;
+            for (var i = 0; i < pathlist.length; i++) {
+                rest--;
+                var path = pathlist[i];        
+                $.post("/fs_api/remove", {path: path}, function (resp) {
+                    if (resp.code == "success" && rest <= 0) {
+                        location.reload();
+                    } else {
+                        showErrorMessage("删除失败, %s".format(resp.message));
+                    }
+                }).fail(function (resp) {
+                    console.log(resp);
+                    showErrorMessage("删除失败");
+                })
+            }
+        }
+    
+        window.removeFile = function(path) {
+            if (path instanceof Array) {
+                xnote.confirm("确认删除%s个文件?".format(path.length), function (result) {
+                    doDeleteFile(path);
+                });
+            } else {
+                // 从path中获取文件名
+                var name = /([^\/\\]+)[\\\/]?$/.exec(path)[1];
+                name = decodeURI(name);
+    
+                xnote.confirm("确认删除 '%s' ?".format(name), function (result) {
+                    doDeleteFile(path);
+                });
+            }
+        }
+    
+        $(".delete-link").click(function (e) {
+            var path = $(this).attr("data-path");
+            removeFile(path);
+        })
+    
+        $(".delete-btn").on("click", function () {
+            var checked = $(".checkboxTd :checked");
+            if (checked.length == 0) {
+                xnote.alert("请选择文件");
+            } else if (checked.length > 1) {
+                var pathlist = []
+                $(".checkboxTd :checked").each(function (index, element) {
+                    var name = $(element).attr("data-name");
+                    var path = $(element).attr("data-path");
+                    pathlist.push(path);
+                });
+    
+                removeFile(pathlist);
+            } else {
+                var name = checked.attr("data-name");
+                var path = checked.attr("data-path");
+                removeFile(path);
+            }
+        });
+    
+        $("#renameBtn").on("click", function () {
+            var checked = $(".checkboxTd :checked");
+            if (checked.length == 0) {
+                xnote.alert("请选择文件");
+            } else if (checked.length > 1) {
+                xnote.alert("不支持批量重命名");
+            } else {
+                var name = checked.attr("data-name");
+                var path = checked.attr("data-path");
+                var dirname = getCurrentPath();
+                xnote.prompt("重命名为", name, function (new_name) {
+                    if (new_name) {
+                        $.post("/fs_api/rename", 
+                            {dirname: dirname, old_name: name, new_name: new_name}, 
+                            function (resp) {
+                                if (resp.code == "success") {
+                                    location.reload();
+                                } else {
+                                    showErrorMessage("重命名失败, %s".format(resp.message));
+                                }
+                        }).fail(function (resp) {
+                            console.log(resp);
+                            xnote.alert("重命名失败");
+                        })
+                    }
+                });
+            }
+        });
+    
+    
+        $("#cutBtn").on("click", function () {
+            var checked = $(".checkboxTd :checked");
+            if (checked.length == 0) {
+                xnote.alert("请选择文件");
+            } else {
+                var cutPathList = [];
+                checked.each(function (index, element) {
+                    // console.log(element);
+                    var path = $(element).attr("data-path");
+                    console.log(path);
+                    cutPathList.push(path);
+                });
+                var data = {"files": cutPathList};
+                $.post("/fs_api/cut", data, function (resp) {
+                    console.log(resp);
+                    window.location.reload();
+                }).fail(function (errorMessage) {
+                    alert("update clipboard failed!" + errorMessage);
+                })
+            }
+        });
+    
+        $("#showMoreOptsBtn").click(function (event) {
+            $(".advanced-opt").toggle(200);
+        });
+    
+        $("#uploadFileBtn").click(function () {
+            $("#uploadFileArea").toggle(200);
+        });
+    
+        $("#selectAllBtn").click(function () {
+            var toggle = parseInt($(this).attr("toggle") || 0);
+            if (toggle % 2 === 0) {        
+                $("input[type=checkbox]").prop("checked", true);
+                $(this).val("反选");
+            } 
+    
+            if (toggle % 2 === 1) {        
+                $("input[type=checkbox]").prop("checked", false);
+                $(this).val("全选");
+            }
+            toggle += 1;
+            $(this).attr("toggle", toggle);
+        });
+    
+        $("#clipboardBtn").click(function () {
+            showClipboardDialog();
+        });
+    
+        $("#addToBookmarkBtn").click(function (event) {
+            var path = getCurrentPath();
+            var params = {"path": path};
+            $.post("/fs_api/bookmark", params, function (resp) {
+                layer.msg("收藏成功");
+            }).fail(function (e) {
+                layer.alert("收藏失败:" + e);
+            });
+        });
+    
+        $(".fs-sort-btn").click(function (e) {
+            var order = $(e.target).attr("data-order");
+            var params = {
+                "action": "sort",
+                "order": order,
+            };
+            $.post("/fs_api/config", params, function (resp) {
+                if (resp.code === "success") {
+                    window.location.reload();
+                } else {
+                    xnote.alert(resp.message);
+                }
+            });
+        });
+    
+        // do not adjust height in mobile
+        if (isPc()) {
+            adjustHeight(".file-list", 30);
+        }
+    });
+</script>
+    
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs.py` & `xnote-web-0.1.1/handlers/fs/fs.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,688 +1,693 @@
-# -*- coding:utf-8 -*-  
-# Created by xupingmao on 2017/03
-# @modified 2022/04/10 18:33:45
-
-"""xnote文件服务，主要功能:
-1. 静态文件服务器，生产模式使用强制缓存，开发模式使用协商缓存
-2. 文件浏览器
-3. 文件下载，支持断点续传
-4. 文件上传
-
-PS. 类似的功能可以参考 webdav
-"""
-import os
-import sys
-import time
-import datetime
-
-import mimetypes
-import web
-import xutils
-import logging
-
-from xnote.core import xauth
-from xnote.core import xconfig
-from xnote.core import xtemplate
-from xnote.core import xmanager
-from xnote.core import xnote_event
-
-from xutils import FileItem, u, Storage, fsutil
-from xutils import dbutil
-from xutils import webutil
-from .fs_mode import get_fs_page_by_mode
-from .fs_helper import sort_files_by_size
-from . import fs_image
-from . import fs_helper
-
-def is_stared(path):
-    return xconfig.has_config("STARED_DIRS", path)
-
-def get_file_size(filepath):
-    return fsutil.get_file_size(filepath, format=True)
-
-def get_filesystem_kw():
-    """return filesystem utils"""
-    kw = Storage()
-    kw["os"]            = os
-    kw["search_type"]   = "fs"
-    kw["get_file_size"] = get_file_size
-    kw["html_title"]    = "文件"
-    kw._show_footer = False
-    return kw
-
-def get_parent_path(path):
-    path2 = path.replace("\\", "/")
-    if path2.endswith("/"):
-        path2 = path[:-1]
-    if not path.endswith("/"):
-        path = path+"/"
-    return os.path.dirname(path2).replace("\\", "/") # fix windows file sep
-
-def list_abs_dir(path):
-    return [os.path.join(path, item) for item in os.listdir(path)]
-
-def print_env():
-    for key in web.ctx.env:
-        print(" - - %-20s = %s" % (key, web.ctx.env.get(key)))
-
-def get_user_home_path(user_name):
-    datapath = u(os.path.abspath(xconfig.DATA_DIR))
-    return os.path.join(datapath, "files", user_name) 
-
-def list_win_drives():
-    """获取Windows系统的驱动器列表"""
-    try:
-        import ctypes
-        import sys
-        lp_buf = ctypes.create_string_buffer(100)
-        ctypes.windll.kernel32.GetLogicalDriveStringsA(ctypes.sizeof(lp_buf), lp_buf)
-        drives_str = lp_buf.raw.decode(sys.getdefaultencoding())
-        drives_list = drives_str.split("\x00")
-        drives_list = list(filter(lambda x:len(x) > 0, drives_list))
-        filelist = []
-        for item in drives_list:
-            if item.endswith("\\"):
-                item = item[:-1]
-            filelist.append(item)
-        return filelist
-    except Exception as e:
-        return ["C:"]
-
-def list_file_objects(fpath):
-    if xutils.is_windows() and fpath == "/":
-        filenames = list_win_drives()
-    else:
-        filenames = list_abs_dir(fpath)
-    return process_file_list(filenames)
-
-def check_file_auth(path, user_name):
-    user_dir = os.path.join(xconfig.UPLOAD_DIR, user_name)
-    path = os.path.abspath(path)
-    return path.startswith(user_dir)
-
-def process_file_list(pathlist, parent = None):
-    filelist = [FileItem(fpath, parent, merge = False) for fpath in pathlist]
-    filelist.sort()
-    for item in filelist:
-        fs_helper.handle_file_item(item)
-
-    user_name = xauth.current_name()
-    fs_order = xauth.get_user_config(user_name, "fs_order")
-    if fs_order == "size":
-        sort_files_by_size(filelist)
-    return filelist
-
-class FileSystemHandler:
-
-    mime_types = xconfig.MIME_TYPES
-
-    encodings = {
-        # 二进制传输的编码格式
-    }
-
-    def handle_content_type(self, path):
-        """Content-Type设置, 优先级从高到低依次是：参数配置、系统配置、默认配置"""
-        type = xutils.get_argument_str("type")
-        path = xutils.decode_name(path)
-
-        if type == "text":
-            web.header("Content-Type", 'text/plain; charset=utf-8')
-            return
-        
-        if type == "blob":
-            web.header("Content-Type", self.mime_types[""])
-            fname = os.path.basename(path)
-            fname = xutils.quote_unicode(fname)
-            web.header("Content-Disposition", "attachment; filename=\"%s\"" % fname)
-            return
-        
-        name, ext = os.path.splitext(path)
-        mime_type = self.mime_types.get(ext.lower())
-        if mime_type is None:
-            mime_type, mime_encoding = mimetypes.guess_type(path)
-        if mime_type is None:
-            mime_type = self.mime_types['']
-
-        web.header("Content-Type", mime_type)
-
-    def handle_content_encoding(self, ext):
-        """Content-Encoding设置，这里应该是二进制编码格式"""
-        if ext in self.encodings:
-            web.header("Content-Encoding", self.encodings[ext])
-
-    def list_directory(self, path):
-        try:
-            filelist = list_file_objects(path)
-            parent_file = fs_helper.get_parent_file_object(path, "[上级目录]")
-            if not fsutil.is_same_file(parent_file.path, path):
-                filelist.insert(0, parent_file)
-        except OSError:
-            return xtemplate.render("fs/page/fs.html", 
-                show_aside = False,
-                path = path,
-                filelist = [],
-                error = "No permission to list directory")
-
-        # filelist中路径均不带/
-        # 排序：文件夹优先，按字母顺序排列
-        # filelist.sort(key=lambda a: a.lower())
-        # filelist.sort(key=lambda a: not os.path.isdir(os.path.join(path,a)))
-
-        # SAE上遇到中文出错
-        # Fix bad filenames，修改不生效
-        # filelist = list(map(lambda x: xutils.decode_bytes(x.encode("utf-8", errors='surrogateescape')), filelist))
-        # Fix, some `file` in *nix is not file either directory. os.stat方法报错
-        path           = path.replace("\\", "/")
-        kw             = get_filesystem_kw()
-        kw.filelist    = filelist
-        kw.path        = path
-        kw.quoted_path = xutils.quote(path)
-        user_info = xauth.current_user()
-        assert isinstance(user_info, Storage)
-
-        kw["token"]         = user_info.token
-        kw["parent_path"]   = get_parent_path(path)
-        kw["search_action"] = "/fs_find"
-        kw["show_aside"]    = False
-        kw["show_hidden_files"] = xutils.get_argument_bool("show_hidden_files")
-
-        mode = xutils.get_argument_str("mode", xconfig.FS_VIEW_MODE)
-        kw["fs_mode"] = mode
-        if mode == "sidebar":
-            kw.show_search = False
-        return get_fs_page_by_mode(mode, kw)
-
-    def list_root(self):
-        raise web.seeother("/fs/~/")
-
-    def read_range(self, path, http_range, blocksize):
-        xutils.trace("Download", "==> HTTP_RANGE %s" % http_range)
-        range_list = http_range.split("bytes=")
-        if len(range_list) == 2:
-            # 包含完整的范围
-            range_list = range_list[1]
-            try:
-                range_start, range_end = range_list.split('-')
-                range_start = int(range_start)
-                total_size = os.stat(path).st_size
-                if range_end != "":
-                    range_end = int(range_end)
-                else:
-                    range_end  = total_size-1
-                    web.header("Content-Length", total_size)
-                content_range = "bytes %s-%s/%s" % (range_start, range_end, total_size)
-                # 设置HTTP响应状态
-                web.ctx.status = "206 Partial Content"
-                # 发送HTTP首部
-                web.header("Accept-Ranges", "bytes")
-                web.header("Content-Range", content_range)
-
-                xutils.trace("Download", "<== Content-Range:%s" % content_range)
-                # 发送数据
-                fp = open(path, "rb")
-                try:
-                    fp.seek(range_start)
-                    rest = range_end - range_start + 1
-                    readsize = min(rest, blocksize)
-                    while readsize > 0:
-                        # print("%s send %s K" % (time.ctime(), readsize))
-                        yield fp.read(readsize)
-                        rest -= readsize
-                        readsize = min(rest, blocksize)
-                finally:
-                    # 基本上和with等价，这里打印出来
-                    xutils.trace("Download", "close %s" % path)
-                    fp.close()
-            except Exception as e:
-                # 其他未知异常
-                xutils.print_stacktrace()
-                # yield最好不要和return value混用
-                yield self.read_all(path, blocksize)
-        else:
-            # 处理不了，返回所有的数据
-            yield self.read_all(path, blocksize)
-
-    def read_all(self, path, blocksize):
-        total_size = os.stat(path).st_size
-        web.header("Content-Length", total_size)
-        with open(path, "rb") as fp:
-            block = fp.read(blocksize)
-            while block:
-                # print("%s Read %s K" % (time.ctime(), blocksize))
-                yield block
-                block = fp.read(blocksize)
-            
-    def read_thumbnail(self, path, blocksize):
-        # TODO 限制进程数量
-        # 在SAE环境中，pillow处理图片后无法释放内存，改成用子进程处理
-        data = fs_image.create_thumbnail_data(path)
-        if data != None:
-            yield data
-        else:
-            yield from self.read_all(path, blocksize)
-    
-    def set_cache_control(self, mtime, etag, expire_days=30):
-        # 如果Edge浏览器没有按照cache-control的建议执行，将浏览器设置重置
-        # 需要注意的是，服务器端在生成状态码为 304 的响应的时候，必须同时生成
-        # 以下会存在于对应的 200 响应中的首部：
-        # Cache-Control、Content-Location、Date、ETag、Expires 和 Vary。
-        # HTTP/1.0的缓存header是Expires
-        # HTTP/1.1的缓存首部是Cache-Control
-        expire_seconds = expire_days * 3600 * 24
-        expire_time = datetime.datetime.utcnow() + datetime.timedelta(days=expire_days)
-
-        web.header("Cache-Control", "max-age=%s" % expire_seconds)
-
-        # DEBUG模式会刷新ts
-        # 在发布缓存副本之前，强制要求缓存把请求提交给原始服务器进行验证 (协商缓存验证)。
-        # web.header("Cache-Control", "no-cache")
-        
-        modified = time.gmtime(mtime)
-        web.header("Last-Modified", time.strftime("%a, %d %b %Y %H:%M:%S GMT", modified))
-        web.header("Expires", expire_time.strftime("%a, %d %b %Y %H:%M:%S GMT"))
-        web.header("Etag", etag)
-        web.header("Content-Location", web.ctx.fullpath)
-        web.header("Vary", "Accept-Encoding") # 请求编码变化时缓存失效
-        # web.header("Vary", "User-Agent") # User-Agent变化时缓存失效
-
-    def read_file(self, path, content_type=None):
-        environ = web.ctx.environ
-        mtime = os.path.getmtime(path)
-        etag = '"%s"' % mtime
-        client_etag = environ.get('HTTP_IF_NONE_MATCH')
-
-        if etag == client_etag:
-            web.ctx.status = "304 Not Modified"
-            return b'' # 其实webpy已经通过yield空bytes来避免None
-
-        self.set_cache_control(mtime, etag)
-
-        if content_type != None:
-            web.header("Content-Type", content_type)
-        else:
-            self.handle_content_type(path)
-
-        http_range = environ.get("HTTP_RANGE")
-        blocksize = 64 * 1024;
-
-        if http_range is not None:
-            return self.read_range(path, http_range, blocksize)
-        else:
-            mode = xutils.get_argument("mode", "")
-            if mode == "thumbnail":
-                return self.read_thumbnail(path, blocksize)
-            return self.read_all(path, blocksize)            
-
-    def handle_get(self, path, content_type=None):
-        if path == "":
-            return self.list_root()
-        if os.path.isdir(path):
-            return self.list_directory(path)
-        elif os.path.isfile(path):
-            return self.read_file(path, content_type=content_type)
-        else:
-            # return "Not Readable %s" % path
-            return self.not_readable(path)
-
-    def not_readable(self, path):
-        return xtemplate.render("fs/page/fs_not_readable.html", path = path)
-
-    def resolve_fpath(self, path):
-        # fpath参数使用b64编码
-        fpath = xutils.get_argument_str("fpath")
-        if fpath != "":
-            return xutils.urlsafe_b64decode(fpath)
-
-        if not xconfig.USE_URLENCODE:
-            path = xutils.unquote(path)
-
-        if not os.path.exists(path):
-            # /fs/ 文件名来源是文件系统提供的，尝试unquote不会出现问题
-            path = xutils.unquote(path)
-
-        return path
-
-    @xauth.login_required("admin")
-    def GET(self, path = ""):
-        # 文件路径默认都进行urlencode
-        # 如果存储结构不采用urlencode，那么这里也必须unquote回去
-        path = self.resolve_fpath(path)
-        return self.handle_get(path)
-        
-
-class DownloadHandler(FileSystemHandler):
-    pass
-
-class GetFileHandler(FileSystemHandler):
-    pass
-
-class DocFileHandler:
-
-    fs_handler = FileSystemHandler()
-
-    def GET(self):
-        fpath = xutils.get_argument("fpath", "")
-        assert isinstance(fpath, str)
-        if fpath == "":
-            raise web.notfound()
-        if ".." in fpath:
-            raise web.badrequest()
-        fpath = os.path.join("./docs", fpath)
-        return self.fs_handler.handle_get(fpath)
-
-class StaticFileHandler(FileSystemHandler):
-    allowed_prefix = ["static", "img", "app", "files", "tmp", "scripts"]
-
-    def is_path_allowed(self, path):
-        if ".." in path:
-            return False
-        for prefix in self.allowed_prefix:
-            if path.startswith(prefix):
-                return True
-        return False
-
-    """外置数据的静态文件支持"""
-    def GET(self, path = ""):
-        origin_path = path
-        path = xutils.unquote(path)
-        if not self.is_path_allowed(path):
-            xauth.check_login("admin")
-
-        data_prefix = u(xconfig.DATA_DIR)
-        if not path.startswith("static"):
-            newpath = os.path.join(data_prefix, path)
-        else:
-            # /static/xxx 文件
-            newpath = xconfig.resolve_config_path(path)
-            # 兼容static目录数据
-            if not os.path.exists(newpath):
-                static_prefix_len = len("static/")
-                newpath = os.path.join(data_prefix, path[static_prefix_len:])
-
-        path = xutils.get_real_path(newpath)
-        if not os.path.isfile(path):
-            # 静态文件不允许访问文件夹
-            web.ctx.status = "404 Not Found"
-            return "Invalid File Path: %s" % origin_path
-        return self.handle_get(path)
-
-class RemoveAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        path = xutils.get_argument("path")
-        assert isinstance(path, str)
-        user_name = xauth.current_name()
-        if not xauth.is_admin() and not check_file_auth(path, user_name):
-            return dict(code="fail", message="unauthorized")
-        try:
-            if not os.path.exists(path):
-                basename = os.path.basename(path)
-                return dict(code="fail", message="源文件`%s`不存在" % basename)
-            xutils.remove(path)
-
-            event = xnote_event.FileDeleteEvent()
-            event.fpath = path
-            
-            xmanager.fire("fs.remove", event)
-            xmanager.fire("fs.delete", event)
-
-            return dict(code="success")
-        except Exception as e:
-            xutils.print_exc()
-            return dict(code="fail", message=str(e))
-    
-    def GET(self):
-        return self.POST()
-
-class RenameAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        dirname  = xutils.get_argument_str("dirname")
-        old_name = xutils.get_argument_str("old_name", "")
-        new_name = xutils.get_argument_str("new_name", "")
-        user_info = xauth.current_user()
-        assert user_info != None
-
-        user_name = user_info.name
-
-        if dirname is None or dirname == "":
-            return dict(code="fail", message="dirname is blank")
-        
-        if old_name is None or old_name == "":
-            return dict(code="fail", message="old_name is blank")
-
-        if ".." in new_name:
-            return dict(code="fail", message="invalid new name")
-        
-        if new_name == "":
-            return webutil.FailedResult(code="400", message="新的文件名称为空")
-        
-        logging.info("encode_name=%s, new_name=%s", xconfig.USE_URLENCODE, new_name)
-
-        if xconfig.USE_URLENCODE:
-            new_name = fsutil.get_safe_file_name(new_name)
-
-        old_path = os.path.join(dirname, old_name)
-        new_path = os.path.join(dirname, new_name)
-
-        # 获取真实的路径
-        old_path = xutils.get_real_path(old_path)
-
-        if not xauth.is_admin() and not check_file_auth(old_path, user_name):
-            return dict(code="fail", message="unauthorized")
-        if not os.path.exists(old_path):
-            return dict(code="fail", message="源文件 `%s` 不存在" % old_name)
-        if os.path.exists(new_path):
-            return dict(code="fail", message="目标文件 `%s` 已存在" % new_name)
-        os.rename(old_path, new_path)
-
-        event = xnote_event.FileRenameEvent()
-        event.fpath = new_path
-        event.old_fpath = old_path
-        event.user_name = user_name
-        event.user_id = user_info.id
-
-        xmanager.fire("fs.rename", event)
-        return dict(code="success")
-
-class CutAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        files = xutils.get_argument("files[]", list())
-        assert isinstance(files, list)
-        for i, fpath in enumerate(files):
-            files[i] = os.path.abspath(fpath)
-        xconfig.FS_CLIP = files
-        return dict(code="success")
-
-    def GET(self):
-        return self.POST()
-
-
-class PasteAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        dirname = xutils.get_argument("dirname", "")
-        old_path = xutils.get_argument("old_path", "")
-        old_path = xutils.get_real_path(old_path).rstrip("/")
-        old_path = os.path.abspath(old_path)
-        dirname  = xutils.get_real_path(dirname)
-        basename = os.path.basename(old_path)
-        print(old_path, dirname, basename)
-        new_path = os.path.join(dirname, basename)
-        if os.path.exists(new_path):
-            return dict(code="fail", message="%s 已存在" % new_path)
-        os.rename(old_path, new_path)
-        if xconfig.FS_CLIP != None:
-            xutils.listremove(xconfig.FS_CLIP, old_path)
-        return dict(code="success")
-
-class ClearClipAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        xconfig.FS_CLIP = None
-        return dict(code="success")
-
-    def GET(self):
-        return self.POST()
-
-class ListAjaxHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        fpath = xutils.get_argument_str("fpath")
-        show_parent = xutils.get_argument_str("show_parent")
-
-        if fpath == "" or fpath == None:
-            return dict(code = "400", message = u"fpath参数为空")
-
-        if not os.path.exists(fpath):
-            return dict(code = "404", message = u"文件不存在")
-
-        files = list_file_objects(fpath)
-        if show_parent == "true":
-            files.insert(0, fs_helper.get_parent_file_object(fpath, "[上级目录]"))
-
-        return dict(code = "success", fpath = fpath, data = files)
-
-
-class LinkHandler:
-
-    @xauth.login_required("admin")
-    def GET(self, name):
-        if name == "home":
-            link_path = "./"
-            if xutils.is_mac():
-                link_path = os.environ['HOME']
-            if xutils.is_windows():
-                link_path = os.path.join(os.environ['HOMEDRIVE'], os.environ['HOMEPATH'])
-        else:
-            link_path = os.path.join(xconfig.DATA_DIR, name)
-        
-        link_path = os.path.abspath(link_path)
-        raise web.seeother("/fs/~%s" % link_path)
-
-class Bookmark:
-
-    def __init__(self, user_name):
-        self.user_name = user_name
-        bookmark = dbutil.get("fs_bookmark:%s" % user_name)
-        if bookmark is None:
-            bookmark = []
-        assert isinstance(bookmark, list)
-        self.bookmark = bookmark
-
-        for i, value in enumerate(bookmark):
-            bookmark[i] = fsutil.normalize_path(value)
-
-    def append(self, path):
-        if path not in self.bookmark:
-            self.bookmark.append(path)
-
-    def remove(self, path):
-        if path in self.bookmark:
-            self.bookmark.remove(path)
-
-    def get(self):
-        self.bookmark = list(filter(lambda x:x!=None and os.path.exists(x), self.bookmark))
-        return self.bookmark
-
-    def save(self):
-        print("save: ", self.bookmark)
-        dbutil.put("fs_bookmark:%s" % self.user_name, self.bookmark)
-
-
-class BookmarkHandler:
-    @xauth.login_required("admin")
-    def GET(self):
-        user_name = xauth.current_name()
-        assert isinstance(user_name, str)
-
-        xmanager.add_visit_log(user_name, "/fs_bookmark")
-
-        kw = Storage()
-        bookmark = Bookmark(user_name)
-
-        filelist = []
-        filelist.append(FileItem("/", name = "操作系统根目录"))
-        filelist.append(FileItem(xconfig.DATA_DIR, name = "Xnote数据目录"))
-
-        for fpath in bookmark.get():
-            item = FileItem(fpath)
-            item.is_user_defined = True
-            filelist.append(item)
-        
-        for item in filelist:
-            fs_helper.handle_file_item(item)
-
-        kw.show_path = False
-        kw.show_fake_path = True
-        kw.fake_path_url = "/fs_bookmark"
-        kw.fake_path_name = "文件收藏夹"
-        kw.filelist = filelist
-        
-        return xtemplate.render("fs/page/fs_bookmark.html", **kw)
-
-class UserHomeHandler(BookmarkHandler):
-    pass
-
-class BookmarkAjaxHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        user_name = xauth.current_name()
-        path = xutils.get_argument("path")
-        action = xutils.get_argument("action")
-        bookmark = Bookmark(user_name)
-
-        if action == "remove":
-            bookmark.remove(path)
-        else:
-            bookmark.append(path)
-        
-        bookmark.save()
-        return dict(code = "success")
-
-class ToolListHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        raise web.found("/plugin_list?category=dir&show_back=true")
-
-dbutil.register_table("fs_bookmark", "文件收藏夹")
-xutils.register_func("fs.process_file_list", process_file_list)
-
-xurls = (
-    r"/fs_link/(.*)", LinkHandler,
-    r"/fs_tools",  ToolListHandler,
-
-    # Ajax服务
-    r"/fs_api/remove", RemoveAjaxHandler,
-    r"/fs_api/rename", RenameAjaxHandler,
-    r"/fs_api/cut",   CutAjaxHandler,
-    r"/fs_api/paste", PasteAjaxHandler,
-    r"/fs_api/clear_clip", ClearClipAjaxHandler,
-    r"/fs_api/bookmark", BookmarkAjaxHandler,
-    r"/fs_api/list", ListAjaxHandler,
-
-    r"/fs_list/?",   UserHomeHandler,
-    r"/fs_bookmark", BookmarkHandler,
-
-    r"/fs/~(.*)", FileSystemHandler,
-    r"/fs_download", DownloadHandler,
-    r"/fs_get"     , GetFileHandler,
-    r"/(static/.*)", StaticFileHandler,
-    # `/static/.*` 路径是`web.py`自带的中间件处理的，优先级更高，所以这里加了一个前缀用以区分
-    r"/_(static/.*)", StaticFileHandler,
-    r"/data/(.*)", StaticFileHandler,
-    r"/(app/.*)", StaticFileHandler,
-    r"/(tmp/.*)", StaticFileHandler,
-    r"/fs_doc", DocFileHandler,
-)
-
-
+# -*- coding:utf-8 -*-  
+# Created by xupingmao on 2017/03
+# @modified 2022/04/10 18:33:45
+
+"""xnote文件服务，主要功能:
+1. 静态文件服务器，生产模式使用强制缓存，开发模式使用协商缓存
+2. 文件浏览器
+3. 文件下载，支持断点续传
+4. 文件上传
+
+PS. 类似的功能可以参考 webdav
+"""
+import os
+import sys
+import time
+import datetime
+
+import mimetypes
+import web
+import xutils
+import logging
+
+from xnote.core import xauth
+from xnote.core import xconfig
+from xnote.core import xtemplate
+from xnote.core import xmanager
+from xnote.core import xnote_event
+
+from xutils import FileItem, u, Storage, fsutil
+from xutils import dbutil
+from xutils import webutil
+from xutils import XnoteException
+
+from .fs_mode import get_fs_page_by_mode
+from .fs_helper import sort_files_by_size
+from . import fs_image
+from . import fs_helper
+from . import fs_checker
+
+def is_stared(path):
+    return xconfig.has_config("STARED_DIRS", path)
+
+def get_file_size(filepath):
+    return fsutil.get_file_size(filepath, format=True)
+
+def get_filesystem_kw():
+    """return filesystem utils"""
+    kw = Storage()
+    kw["os"]            = os
+    kw["search_type"]   = "fs"
+    kw["get_file_size"] = get_file_size
+    kw["html_title"]    = "文件"
+    kw._show_footer = False
+    return kw
+
+def get_parent_path(path):
+    path2 = path.replace("\\", "/")
+    if path2.endswith("/"):
+        path2 = path[:-1]
+    if not path.endswith("/"):
+        path = path+"/"
+    return os.path.dirname(path2).replace("\\", "/") # fix windows file sep
+
+def list_abs_dir(path):
+    return [os.path.join(path, item) for item in os.listdir(path)]
+
+def print_env():
+    for key in web.ctx.env:
+        print(" - - %-20s = %s" % (key, web.ctx.env.get(key)))
+
+def get_user_home_path(user_name):
+    datapath = u(os.path.abspath(xconfig.DATA_DIR))
+    return os.path.join(datapath, "files", user_name) 
+
+def list_win_drives():
+    """获取Windows系统的驱动器列表"""
+    try:
+        import ctypes
+        import sys
+        lp_buf = ctypes.create_string_buffer(100)
+        ctypes.windll.kernel32.GetLogicalDriveStringsA(ctypes.sizeof(lp_buf), lp_buf)
+        drives_str = lp_buf.raw.decode(sys.getdefaultencoding())
+        drives_list = drives_str.split("\x00")
+        drives_list = list(filter(lambda x:len(x) > 0, drives_list))
+        filelist = []
+        for item in drives_list:
+            if item.endswith("\\"):
+                item = item[:-1]
+            filelist.append(item)
+        return filelist
+    except Exception as e:
+        return ["C:"]
+
+def list_file_objects(fpath):
+    if xutils.is_windows() and fpath == "/":
+        filenames = list_win_drives()
+    else:
+        filenames = list_abs_dir(fpath)
+    return process_file_list(filenames)
+
+def check_file_auth(path, user_name):
+    user_dir = os.path.join(xconfig.UPLOAD_DIR, user_name)
+    path = os.path.abspath(path)
+    return path.startswith(user_dir)
+
+def process_file_list(pathlist, parent = None):
+    filelist = [FileItem(fpath, parent, merge = False) for fpath in pathlist]
+    filelist.sort()
+    for item in filelist:
+        fs_helper.handle_file_item(item)
+
+    user_name = xauth.current_name()
+    fs_order = xauth.get_user_config(user_name, "fs_order")
+    if fs_order == "size":
+        sort_files_by_size(filelist)
+    return filelist
+
+class FileSystemHandler:
+
+    mime_types = xconfig.MIME_TYPES
+
+    encodings = {
+        # 二进制传输的编码格式
+    }
+
+    def handle_content_type(self, path):
+        """Content-Type设置, 优先级从高到低依次是：参数配置、系统配置、默认配置"""
+        type = xutils.get_argument_str("type")
+        path = xutils.decode_name(path)
+
+        if type == "text":
+            web.header("Content-Type", 'text/plain; charset=utf-8')
+            return
+        
+        if type == "blob":
+            web.header("Content-Type", self.mime_types[""])
+            fname = os.path.basename(path)
+            fname = xutils.quote_unicode(fname)
+            web.header("Content-Disposition", "attachment; filename=\"%s\"" % fname)
+            return
+        
+        name, ext = os.path.splitext(path)
+        mime_type = self.mime_types.get(ext.lower())
+        if mime_type is None:
+            mime_type, mime_encoding = mimetypes.guess_type(path)
+        if mime_type is None:
+            mime_type = self.mime_types['']
+
+        web.header("Content-Type", mime_type)
+
+    def handle_content_encoding(self, ext):
+        """Content-Encoding设置，这里应该是二进制编码格式"""
+        if ext in self.encodings:
+            web.header("Content-Encoding", self.encodings[ext])
+
+    def list_directory(self, path):
+        try:
+            filelist = list_file_objects(path)
+            parent_file = fs_helper.get_parent_file_object(path, "[上级目录]")
+            if not fsutil.is_same_file(parent_file.path, path):
+                filelist.insert(0, parent_file)
+        except OSError:
+            return xtemplate.render("fs/page/fs.html", 
+                show_aside = False,
+                path = path,
+                filelist = [],
+                error = "No permission to list directory")
+
+        # filelist中路径均不带/
+        # 排序：文件夹优先，按字母顺序排列
+        # filelist.sort(key=lambda a: a.lower())
+        # filelist.sort(key=lambda a: not os.path.isdir(os.path.join(path,a)))
+
+        # SAE上遇到中文出错
+        # Fix bad filenames，修改不生效
+        # filelist = list(map(lambda x: xutils.decode_bytes(x.encode("utf-8", errors='surrogateescape')), filelist))
+        # Fix, some `file` in *nix is not file either directory. os.stat方法报错
+        path           = path.replace("\\", "/")
+        kw             = get_filesystem_kw()
+        kw.filelist    = filelist
+        kw.path        = path
+        kw.quoted_path = xutils.quote(path)
+        user_info = xauth.current_user()
+        assert isinstance(user_info, Storage)
+
+        kw["token"]         = user_info.token
+        kw["parent_path"]   = get_parent_path(path)
+        kw["search_action"] = "/fs_find"
+        kw["show_aside"]    = False
+        kw["show_hidden_files"] = xutils.get_argument_bool("show_hidden_files")
+
+        mode = xutils.get_argument_str("mode", xconfig.FS_VIEW_MODE)
+        kw["fs_mode"] = mode
+        if mode == "sidebar":
+            kw.show_search = False
+        return get_fs_page_by_mode(mode, kw)
+
+    def list_root(self):
+        raise web.seeother("/fs/~/")
+
+    def read_range(self, path, http_range, blocksize):
+        xutils.trace("Download", "==> HTTP_RANGE %s" % http_range)
+        range_list = http_range.split("bytes=")
+        if len(range_list) == 2:
+            # 包含完整的范围
+            range_list = range_list[1]
+            try:
+                range_start, range_end = range_list.split('-')
+                range_start = int(range_start)
+                total_size = os.stat(path).st_size
+                if range_end != "":
+                    range_end = int(range_end)
+                else:
+                    range_end  = total_size-1
+                    web.header("Content-Length", total_size)
+                content_range = "bytes %s-%s/%s" % (range_start, range_end, total_size)
+                # 设置HTTP响应状态
+                web.ctx.status = "206 Partial Content"
+                # 发送HTTP首部
+                web.header("Accept-Ranges", "bytes")
+                web.header("Content-Range", content_range)
+
+                xutils.trace("Download", "<== Content-Range:%s" % content_range)
+                # 发送数据
+                fp = open(path, "rb")
+                try:
+                    fp.seek(range_start)
+                    rest = range_end - range_start + 1
+                    readsize = min(rest, blocksize)
+                    while readsize > 0:
+                        # print("%s send %s K" % (time.ctime(), readsize))
+                        yield fp.read(readsize)
+                        rest -= readsize
+                        readsize = min(rest, blocksize)
+                finally:
+                    # 基本上和with等价，这里打印出来
+                    xutils.trace("Download", "close %s" % path)
+                    fp.close()
+            except Exception as e:
+                # 其他未知异常
+                xutils.print_stacktrace()
+                # yield最好不要和return value混用
+                yield self.read_all(path, blocksize)
+        else:
+            # 处理不了，返回所有的数据
+            yield self.read_all(path, blocksize)
+
+    def read_all(self, path, blocksize):
+        total_size = os.stat(path).st_size
+        web.header("Content-Length", total_size)
+        with open(path, "rb") as fp:
+            block = fp.read(blocksize)
+            while block:
+                # print("%s Read %s K" % (time.ctime(), blocksize))
+                yield block
+                block = fp.read(blocksize)
+            
+    def read_thumbnail(self, path, blocksize):
+        # TODO 限制进程数量
+        # 在SAE环境中，pillow处理图片后无法释放内存，改成用子进程处理
+        data = fs_image.create_thumbnail_data(path)
+        if data != None:
+            yield data
+        else:
+            yield from self.read_all(path, blocksize)
+    
+    def set_cache_control(self, mtime, etag, expire_days=30):
+        # 如果Edge浏览器没有按照cache-control的建议执行，将浏览器设置重置
+        # 需要注意的是，服务器端在生成状态码为 304 的响应的时候，必须同时生成
+        # 以下会存在于对应的 200 响应中的首部：
+        # Cache-Control、Content-Location、Date、ETag、Expires 和 Vary。
+        # HTTP/1.0的缓存header是Expires
+        # HTTP/1.1的缓存首部是Cache-Control
+        expire_seconds = expire_days * 3600 * 24
+        expire_time = datetime.datetime.utcnow() + datetime.timedelta(days=expire_days)
+        # 强制开启缓存
+        web.header("Cache-Control", f"public, max-age={expire_seconds}")
+
+        # DEBUG模式会刷新ts
+        # 在发布缓存副本之前，强制要求缓存把请求提交给原始服务器进行验证 (协商缓存验证)。
+        # web.header("Cache-Control", "no-cache")
+        
+        modified = time.gmtime(mtime)
+        web.header("Last-Modified", time.strftime("%a, %d %b %Y %H:%M:%S GMT", modified))
+        web.header("Expires", expire_time.strftime("%a, %d %b %Y %H:%M:%S GMT"))
+        web.header("Etag", etag)
+        web.header("Content-Location", web.ctx.fullpath)
+        web.header("Vary", "Accept-Encoding") # 请求编码变化时缓存失效
+        # web.header("Vary", "User-Agent") # User-Agent变化时缓存失效
+
+    def read_file(self, path, content_type=None):
+        environ = web.ctx.environ
+        mtime = os.path.getmtime(path)
+        etag = '"%s"' % mtime
+        client_etag = environ.get('HTTP_IF_NONE_MATCH')
+
+        if etag == client_etag:
+            web.ctx.status = "304 Not Modified"
+            return b'' # 其实webpy已经通过yield空bytes来避免None
+
+        self.set_cache_control(mtime, etag)
+
+        if content_type != None:
+            web.header("Content-Type", content_type)
+        else:
+            self.handle_content_type(path)
+
+        http_range = environ.get("HTTP_RANGE")
+        blocksize = 64 * 1024;
+
+        if http_range is not None:
+            return self.read_range(path, http_range, blocksize)
+        else:
+            mode = xutils.get_argument("mode", "")
+            if mode == "thumbnail":
+                return self.read_thumbnail(path, blocksize)
+            return self.read_all(path, blocksize)            
+
+    def handle_get(self, path, content_type=None):
+        if path == "":
+            return self.list_root()
+        if os.path.isdir(path):
+            return self.list_directory(path)
+        elif os.path.isfile(path):
+            return self.read_file(path, content_type=content_type)
+        else:
+            # return "Not Readable %s" % path
+            return self.not_readable(path)
+
+    def not_readable(self, path):
+        return xtemplate.render("fs/page/fs_not_readable.html", path = path)
+
+    def resolve_fpath(self, path):
+        # fpath参数使用b64编码
+        fpath = xutils.get_argument_str("fpath")
+        if fpath != "":
+            return xutils.urlsafe_b64decode(fpath)
+
+        if not xconfig.USE_URLENCODE:
+            path = xutils.unquote(path)
+
+        if not os.path.exists(path):
+            # /fs/ 文件名来源是文件系统提供的，尝试unquote不会出现问题
+            path = xutils.unquote(path)
+
+        return path
+
+    @xauth.login_required("admin")
+    def GET(self, path = ""):
+        # 文件路径默认都进行urlencode
+        # 如果存储结构不采用urlencode，那么这里也必须unquote回去
+        path = self.resolve_fpath(path)
+        return self.handle_get(path)
+        
+
+class DownloadHandler(FileSystemHandler):
+    pass
+
+class GetFileHandler(FileSystemHandler):
+    pass
+
+class DocFileHandler:
+
+    fs_handler = FileSystemHandler()
+
+    def GET(self):
+        fpath = xutils.get_argument("fpath", "")
+        assert isinstance(fpath, str)
+        if fpath == "":
+            raise web.notfound()
+        if ".." in fpath:
+            raise web.badrequest()
+        fpath = os.path.join("./docs", fpath)
+        return self.fs_handler.handle_get(fpath)
+
+class StaticFileHandler(FileSystemHandler):
+    allowed_prefix = ["static", "img", "app", "files", "tmp", "scripts"]
+
+    def is_path_allowed(self, path):
+        if ".." in path:
+            return False
+        for prefix in self.allowed_prefix:
+            if path.startswith(prefix):
+                return True
+        return False
+
+    """外置数据的静态文件支持"""
+    def GET(self, path = ""):
+        origin_path = path
+        path = xutils.unquote(path)
+        if not self.is_path_allowed(path):
+            xauth.check_login("admin")
+
+        data_prefix = u(xconfig.DATA_DIR)
+        if not path.startswith("static"):
+            newpath = os.path.join(data_prefix, path)
+        else:
+            # /static/xxx 文件
+            newpath = xconfig.resolve_config_path(path)
+            # 兼容static目录数据
+            if not os.path.exists(newpath):
+                static_prefix_len = len("static/")
+                newpath = os.path.join(data_prefix, path[static_prefix_len:])
+
+        path = xutils.get_real_path(newpath)
+        if not os.path.isfile(path):
+            # 静态文件不允许访问文件夹
+            web.ctx.status = "404 Not Found"
+            return "Invalid File Path: %s" % origin_path
+        return self.handle_get(path)
+
+class RemoveAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        path = xutils.get_argument("path")
+        assert isinstance(path, str)
+        user_name = xauth.current_name()
+        if not xauth.is_admin() and not check_file_auth(path, user_name):
+            return dict(code="fail", message="unauthorized")
+        try:
+            if not os.path.exists(path):
+                basename = os.path.basename(path)
+                return dict(code="fail", message="源文件`%s`不存在" % basename)
+            xutils.remove(path)
+
+            event = xnote_event.FileDeleteEvent()
+            event.fpath = path
+            
+            xmanager.fire("fs.remove", event)
+            xmanager.fire("fs.delete", event)
+
+            return dict(code="success")
+        except Exception as e:
+            xutils.print_exc()
+            return dict(code="fail", message=str(e))
+    
+    def GET(self):
+        return self.POST()
+
+class RenameAjaxHandler:
+
+    def POST(self):
+        try:
+            return self.do_post()
+        except XnoteException as e:
+            return webutil.FailedResult(code=e.code, message=e.message)
+
+    @xauth.login_required("admin")
+    def do_post(self):
+        dirname  = xutils.get_argument_str("dirname")
+        old_name = xutils.get_argument_str("old_name", "")
+        new_name = xutils.get_argument_str("new_name", "")
+        user_info = xauth.current_user()
+        assert user_info != None
+
+        user_name = user_info.name
+
+        if dirname is None or dirname == "":
+            return dict(code="fail", message="dirname is blank")
+        
+        if old_name is None or old_name == "":
+            return dict(code="fail", message="old_name is blank")
+
+        fs_checker.check_file_name(new_name)
+        
+        logging.info("encode_name=%s, new_name=%s", xconfig.USE_URLENCODE, new_name)
+
+        if xconfig.USE_URLENCODE:
+            new_name = fsutil.get_safe_file_name(new_name)
+
+        old_path = os.path.join(dirname, old_name)
+        new_path = os.path.join(dirname, new_name)
+
+        # 获取真实的路径
+        old_path = xutils.get_real_path(old_path)
+
+        if not xauth.is_admin() and not check_file_auth(old_path, user_name):
+            return dict(code="fail", message="unauthorized")
+        if not os.path.exists(old_path):
+            return dict(code="fail", message="源文件 `%s` 不存在" % old_name)
+        if os.path.exists(new_path):
+            return dict(code="fail", message="目标文件 `%s` 已存在" % new_name)
+        os.rename(old_path, new_path)
+
+        event = xnote_event.FileRenameEvent()
+        event.fpath = new_path
+        event.old_fpath = old_path
+        event.user_name = user_name
+        event.user_id = user_info.id
+
+        xmanager.fire("fs.rename", event)
+        return dict(code="success")
+
+class CutAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        files = xutils.get_argument("files[]", list())
+        assert isinstance(files, list)
+        for i, fpath in enumerate(files):
+            files[i] = os.path.abspath(fpath)
+        xconfig.FS_CLIP = files
+        return dict(code="success")
+
+    def GET(self):
+        return self.POST()
+
+
+class PasteAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        dirname = xutils.get_argument("dirname", "")
+        old_path = xutils.get_argument("old_path", "")
+        old_path = xutils.get_real_path(old_path).rstrip("/")
+        old_path = os.path.abspath(old_path)
+        dirname  = xutils.get_real_path(dirname)
+        basename = os.path.basename(old_path)
+        print(old_path, dirname, basename)
+        new_path = os.path.join(dirname, basename)
+        if os.path.exists(new_path):
+            return dict(code="fail", message="%s 已存在" % new_path)
+        os.rename(old_path, new_path)
+        if xconfig.FS_CLIP != None:
+            xutils.listremove(xconfig.FS_CLIP, old_path)
+        return dict(code="success")
+
+class ClearClipAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        xconfig.FS_CLIP = None
+        return dict(code="success")
+
+    def GET(self):
+        return self.POST()
+
+class ListAjaxHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        fpath = xutils.get_argument_str("fpath")
+        show_parent = xutils.get_argument_str("show_parent")
+
+        if fpath == "" or fpath == None:
+            return dict(code = "400", message = u"fpath参数为空")
+
+        if not os.path.exists(fpath):
+            return dict(code = "404", message = u"文件不存在")
+
+        files = list_file_objects(fpath)
+        if show_parent == "true":
+            files.insert(0, fs_helper.get_parent_file_object(fpath, "[上级目录]"))
+
+        return dict(code = "success", fpath = fpath, data = files)
+
+
+class LinkHandler:
+
+    @xauth.login_required("admin")
+    def GET(self, name):
+        if name == "home":
+            link_path = "./"
+            if xutils.is_mac():
+                link_path = os.environ['HOME']
+            if xutils.is_windows():
+                link_path = os.path.join(os.environ['HOMEDRIVE'], os.environ['HOMEPATH'])
+        else:
+            link_path = os.path.join(xconfig.DATA_DIR, name)
+        
+        link_path = os.path.abspath(link_path)
+        raise web.seeother("/fs/~%s" % link_path)
+
+class Bookmark:
+
+    def __init__(self, user_name):
+        self.user_name = user_name
+        bookmark = dbutil.get("fs_bookmark:%s" % user_name)
+        if bookmark is None:
+            bookmark = []
+        assert isinstance(bookmark, list)
+        self.bookmark = bookmark
+
+        for i, value in enumerate(bookmark):
+            bookmark[i] = fsutil.normalize_path(value)
+
+    def append(self, path):
+        if path not in self.bookmark:
+            self.bookmark.append(path)
+
+    def remove(self, path):
+        if path in self.bookmark:
+            self.bookmark.remove(path)
+
+    def get(self):
+        self.bookmark = list(filter(lambda x:x!=None and os.path.exists(x), self.bookmark))
+        return self.bookmark
+
+    def save(self):
+        print("save: ", self.bookmark)
+        dbutil.put("fs_bookmark:%s" % self.user_name, self.bookmark)
+
+
+class BookmarkHandler:
+    @xauth.login_required("admin")
+    def GET(self):
+        user_name = xauth.current_name()
+        assert isinstance(user_name, str)
+
+        xmanager.add_visit_log(user_name, "/fs_bookmark")
+
+        kw = Storage()
+        bookmark = Bookmark(user_name)
+
+        filelist = []
+        filelist.append(FileItem("/", name = "操作系统根目录"))
+        filelist.append(FileItem(xconfig.DATA_DIR, name = "Xnote数据目录"))
+
+        for fpath in bookmark.get():
+            item = FileItem(fpath)
+            item.is_user_defined = True
+            filelist.append(item)
+        
+        for item in filelist:
+            fs_helper.handle_file_item(item)
+
+        kw.show_path = False
+        kw.show_fake_path = True
+        kw.fake_path_url = "/fs_bookmark"
+        kw.fake_path_name = "文件收藏夹"
+        kw.filelist = filelist
+        
+        return xtemplate.render("fs/page/fs_bookmark.html", **kw)
+
+class UserHomeHandler(BookmarkHandler):
+    pass
+
+class BookmarkAjaxHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        user_name = xauth.current_name()
+        path = xutils.get_argument("path")
+        action = xutils.get_argument("action")
+        bookmark = Bookmark(user_name)
+
+        if action == "remove":
+            bookmark.remove(path)
+        else:
+            bookmark.append(path)
+        
+        bookmark.save()
+        return dict(code = "success")
+
+class ToolListHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        raise web.found("/plugin_list?category=dir&show_back=true")
+
+dbutil.register_table("fs_bookmark", "文件收藏夹")
+xutils.register_func("fs.process_file_list", process_file_list)
+
+xurls = (
+    r"/fs_link/(.*)", LinkHandler,
+    r"/fs_tools",  ToolListHandler,
+
+    # Ajax服务
+    r"/fs_api/remove", RemoveAjaxHandler,
+    r"/fs_api/rename", RenameAjaxHandler,
+    r"/fs_api/cut",   CutAjaxHandler,
+    r"/fs_api/paste", PasteAjaxHandler,
+    r"/fs_api/clear_clip", ClearClipAjaxHandler,
+    r"/fs_api/bookmark", BookmarkAjaxHandler,
+    r"/fs_api/list", ListAjaxHandler,
+
+    r"/fs_list/?",   UserHomeHandler,
+    r"/fs_bookmark", BookmarkHandler,
+
+    r"/fs/~(.*)", FileSystemHandler,
+    r"/fs_download", DownloadHandler,
+    r"/fs_get"     , GetFileHandler,
+    r"/(static/.*)", StaticFileHandler,
+    # `/static/.*` 路径是`web.py`自带的中间件处理的，优先级更高，所以这里加了一个前缀用以区分
+    r"/_(static/.*)", StaticFileHandler,
+    r"/data/(.*)", StaticFileHandler,
+    r"/(app/.*)", StaticFileHandler,
+    r"/(tmp/.*)", StaticFileHandler,
+    r"/fs_doc", DocFileHandler,
+)
+
+
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_add.py` & `xnote-web-0.1.1/handlers/fs/fs_add.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/fs_cache.py` & `xnote-web-0.1.1/handlers/fs/fs_cache.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/fs_helper.py` & `xnote-web-0.1.1/handlers/fs/fs_helper.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,203 +1,203 @@
-# -*- coding:utf-8 -*-
-# @author mark
-# @since 2022/02/27 16:07:55
-# @modified 2022/04/09 10:54:40
-# @filename fs_helpers.py
-
-"""文件管理模块的工具
-注: 叫fs_helpers是为了和fsutil名称混淆
-"""
-
-import os
-import xutils
-
-from xnote.core import xconfig
-from xnote.core import xauth
-from xnote.core import xconfig
-from xnote.core import xtables
-from xutils import dbutil
-from xutils import format_size
-from xutils import fsutil, six
-from xutils.dbutil import LdbTable
-from xutils.fsutil import FileItem
-from xutils.sqldb import TableProxy
-from xutils import Storage
-
-class FileInfo(Storage):
-
-    def __init__(self):
-        self.ctime = xutils.format_datetime()
-        self.mtime = xutils.format_datetime()
-        self.fpath = ""
-        self.ftype = ""
-        self.user_id = 0
-        self.fsize = 0
-
-class FileInfoDao:
-    
-    data_root = xconfig.FileReplacement.data_dir + "/"
-    db = xtables.get_table_by_name("file_info")
-    
-    @classmethod
-    def get_virtual_path(cls, fpath=""):
-        if fpath.startswith(cls.data_root):
-            return fpath
-        data_dir = xconfig.FileConfig.data_dir
-        fpath = os.path.abspath(fpath)
-        if fsutil.is_parent_dir(data_dir, fpath):
-            relative_path = fsutil.get_relative_path(fpath, data_dir)
-            fpath = cls.data_root + relative_path
-        return fpath
-
-    @classmethod
-    def get_by_fpath(cls, fpath = ""):
-        fpath = cls.get_virtual_path(fpath)
-        return cls.db.select_first(where = dict(fpath = fpath))
-    
-    @classmethod
-    def delete_by_fpath(cls, fpath=""):
-        fpath = cls.get_virtual_path(fpath)
-        return cls.db.delete(where=dict(fpath=fpath))
-    
-    @classmethod
-    def delete_by_id(cls, id=0):
-        return cls.db.delete(where=dict(id=id))
-    
-    @classmethod
-    def upsert(cls, info: FileInfo):
-        info.fpath = cls.get_virtual_path(info.fpath)
-        old = cls.get_by_fpath(info.fpath)
-        if old == None:
-            return cls.db.insert(**info)
-        else:
-            updates = dict(**info)
-            updates.pop("ctime") # 不更新创建时间
-            updates.pop("user_id")
-            cls.db.update(**updates, where = dict(id=old.id))
-
-    @classmethod
-    def list(cls, user_id=0, offset=0, limit=100, start_time_inclusive="", end_time_exclusive="", is_admin=False, order="ctime desc"):
-        if not is_admin:
-            assert user_id > 0
-        vars = dict(user_id=user_id, start_time_inclusive=start_time_inclusive, end_time_exclusive=end_time_exclusive)
-        where = "1=1"
-        if user_id != 0:
-            where += " AND user_id=$user_id"
-        if start_time_inclusive != "":
-            where += " AND ctime >= $start_time_inclusive"
-        if end_time_exclusive != "":
-            where += " AND ctime < $end_time_exclusive"
-        return cls.db.select(where=where, vars=vars, offset=offset, limit=limit, order=order)
-
-    @classmethod
-    def prefix_count(cls, fpath=""):
-        if fpath != "":
-            fpath = cls.get_virtual_path(fpath)
-        return cls.db.count(where = "fpath LIKE $fpath", vars = dict(fpath = fpath + "%"))
-
-
-def get_index_db(): # type: ()-> TableProxy
-    return FileInfoDao.db
-
-
-class FileInfoModel(FileInfoDao):
-    pass
-
-def handle_file_item(item):
-    """文件的后置处理器"""
-    if item.type == "dir":
-        item.icon = "fa-folder orange"
-    elif item.ext in xconfig.FS_VIDEO_EXT_LIST:
-        item.icon = "fa-file-video-o"
-    elif item.ext in xconfig.FS_CODE_EXT_LIST:
-        item.icon = "fa-file-code-o"
-    elif item.ext in xconfig.FS_AUDIO_EXT_LIST:
-        item.icon = "fa-file-audio-o"
-    elif item.ext in xconfig.FS_ZIP_EXT_LIST:
-        item.icon = "fa-file-zip-o"
-    elif xutils.is_text_file(item.path):
-        item.icon = "fa-file-text-o"
-    elif xutils.is_img_file(item.path):
-        item.icon = "fa-file-image-o"
-
-    handle_file_url(item)
-    item.show_opt_btn = True
-    return item
-
-def handle_file_url(item):
-    item.css_class = ""
-    server_home = xconfig.WebConfig.server_home
-    if item.type == "dir":
-        item.url = server_home + "/fs/~%s" % item.encoded_path
-    elif xutils.is_img_file(item.path):
-        item.url = "#"
-        item.css_class = "x-photo"
-    elif xutils.is_audio_file(item.path):
-        item.url = server_home + "/fs/~%s" % item.encoded_path
-    else:
-        item.url = server_home + "/fs_preview?path=%s&embed=false" % item.encoded_path
-    
-    item.data_url = server_home + "/fs/~" + item.encoded_path
-
-def get_parent_file_object(path, name = ""):
-    path = os.path.abspath(path)
-    parent_file = FileItem(os.path.dirname(path))
-    handle_file_item(parent_file)
-    if name != "":
-        parent_file.name = name
-    parent_file.show_opt_btn = False
-    return parent_file
-
-def get_index_dirs():
-    index_dirs = xauth.get_user_config("admin", "fs_index_dirs")
-    assert isinstance(index_dirs, six.string_types)
-    return index_dirs.split("\n")
-
-def get_file_thumbnail(fpath):
-    if xutils.is_img_file(fpath):
-        return xutils.get_webpath(fpath) + "?mode=thumbnail"
-
-    if xutils.is_text_file(fpath):
-        return "/_static/image/icon_txt.png"
-
-    # 位置类型
-    return "/_static/image/file2.png"
-
-def get_file_download_link(fpath):
-    if fsutil.is_parent_dir(xconfig.DATA_DIR, fpath):
-        relative_path = fsutil.get_relative_path(fpath, xconfig.DATA_DIR)
-        fpath = relative_path
-        encoded_path = xutils.encode_uri_component(fpath)
-        return "/data/%s?type=blob" % encoded_path
-    encoded_path = xutils.encode_uri_component(fpath)
-    download_link = "/fs/%s?type=blob" % encoded_path
-    return download_link
-
-
-def sort_files_by_size(filelist):
-    for file in filelist:
-        fpath = file.path
-        fpath = os.path.abspath(fpath)
-        realpath = os.path.realpath(fpath)
-        info = FileInfoModel.get_by_fpath(realpath)
-        if info != None and hasattr(info, "fsize"):
-            file.fsize = info.fsize
-            size_str = format_size(info.fsize)
-            if os.path.islink(fpath):
-                file.size = "Link(%s)" % size_str
-            else:
-                file.size = size_str
-        else:
-            file.size = "Unknown"
-
-    def key_func(file):
-        if not isinstance(file.fsize, int):
-            return 0
-        return file.fsize
-
-    filelist.sort(key = key_func, reverse = True)
-
-
-xutils.register_func("fs.get_file_thumbnail", get_file_thumbnail)
-xutils.register_func("fs.get_file_download_link", get_file_download_link)
-xutils.register_func("fs.get_index_dirs", get_index_dirs)
+# -*- coding:utf-8 -*-
+# @author mark
+# @since 2022/02/27 16:07:55
+# @modified 2022/04/09 10:54:40
+# @filename fs_helpers.py
+
+"""文件管理模块的工具
+注: 叫fs_helpers是为了和fsutil名称混淆
+"""
+
+import os
+import xutils
+
+from xnote.core import xconfig
+from xnote.core import xauth
+from xnote.core import xconfig
+from xnote.core import xtables
+from xutils import dbutil
+from xutils import format_size
+from xutils import fsutil, six
+from xutils.dbutil import LdbTable
+from xutils.fsutil import FileItem
+from xutils.sqldb import TableProxy
+from xutils import Storage
+
+class FileInfo(Storage):
+
+    def __init__(self):
+        self.ctime = xutils.format_datetime()
+        self.mtime = xutils.format_datetime()
+        self.fpath = ""
+        self.ftype = ""
+        self.user_id = 0
+        self.fsize = 0
+
+class FileInfoDao:
+    
+    data_root = xconfig.FileReplacement.data_dir + "/"
+    db = xtables.get_table_by_name("file_info")
+    
+    @classmethod
+    def get_virtual_path(cls, fpath=""):
+        if fpath.startswith(cls.data_root):
+            return fpath
+        data_dir = xconfig.FileConfig.data_dir
+        fpath = os.path.abspath(fpath)
+        if fsutil.is_parent_dir(data_dir, fpath):
+            relative_path = fsutil.get_relative_path(fpath, data_dir)
+            fpath = cls.data_root + relative_path
+        return fpath
+
+    @classmethod
+    def get_by_fpath(cls, fpath = ""):
+        fpath = cls.get_virtual_path(fpath)
+        return cls.db.select_first(where = dict(fpath = fpath))
+    
+    @classmethod
+    def delete_by_fpath(cls, fpath=""):
+        fpath = cls.get_virtual_path(fpath)
+        return cls.db.delete(where=dict(fpath=fpath))
+    
+    @classmethod
+    def delete_by_id(cls, id=0):
+        return cls.db.delete(where=dict(id=id))
+    
+    @classmethod
+    def upsert(cls, info: FileInfo):
+        info.fpath = cls.get_virtual_path(info.fpath)
+        old = cls.get_by_fpath(info.fpath)
+        if old == None:
+            return cls.db.insert(**info)
+        else:
+            updates = dict(**info)
+            updates.pop("ctime") # 不更新创建时间
+            updates.pop("user_id")
+            cls.db.update(**updates, where = dict(id=old.id))
+
+    @classmethod
+    def list(cls, user_id=0, offset=0, limit=100, start_time_inclusive="", end_time_exclusive="", is_admin=False, order="ctime desc"):
+        if not is_admin:
+            assert user_id > 0
+        vars = dict(user_id=user_id, start_time_inclusive=start_time_inclusive, end_time_exclusive=end_time_exclusive)
+        where = "1=1"
+        if user_id != 0:
+            where += " AND user_id=$user_id"
+        if start_time_inclusive != "":
+            where += " AND ctime >= $start_time_inclusive"
+        if end_time_exclusive != "":
+            where += " AND ctime < $end_time_exclusive"
+        return cls.db.select(where=where, vars=vars, offset=offset, limit=limit, order=order)
+
+    @classmethod
+    def prefix_count(cls, fpath=""):
+        if fpath != "":
+            fpath = cls.get_virtual_path(fpath)
+        return cls.db.count(where = "fpath LIKE $fpath", vars = dict(fpath = fpath + "%"))
+
+
+def get_index_db(): # type: ()-> TableProxy
+    return FileInfoDao.db
+
+
+class FileInfoModel(FileInfoDao):
+    pass
+
+def handle_file_item(item):
+    """文件的后置处理器"""
+    if item.type == "dir":
+        item.icon = "fa-folder orange"
+    elif item.ext in xconfig.FS_VIDEO_EXT_LIST:
+        item.icon = "fa-file-video-o"
+    elif item.ext in xconfig.FS_CODE_EXT_LIST:
+        item.icon = "fa-file-code-o"
+    elif item.ext in xconfig.FS_AUDIO_EXT_LIST:
+        item.icon = "fa-file-audio-o"
+    elif item.ext in xconfig.FS_ZIP_EXT_LIST:
+        item.icon = "fa-file-zip-o"
+    elif xutils.is_text_file(item.path):
+        item.icon = "fa-file-text-o"
+    elif xutils.is_img_file(item.path):
+        item.icon = "fa-file-image-o"
+
+    handle_file_url(item)
+    item.show_opt_btn = True
+    return item
+
+def handle_file_url(item):
+    item.css_class = ""
+    server_home = xconfig.WebConfig.server_home
+    if item.type == "dir":
+        item.url = server_home + "/fs/~%s" % item.encoded_path
+    elif xutils.is_img_file(item.path):
+        item.url = "#"
+        item.css_class = "x-photo"
+    elif xutils.is_audio_file(item.path):
+        item.url = server_home + "/fs/~%s" % item.encoded_path
+    else:
+        item.url = server_home + "/fs_preview?path=%s&embed=false" % item.encoded_path
+    
+    item.data_url = server_home + "/fs/~" + item.encoded_path
+
+def get_parent_file_object(path, name = ""):
+    path = os.path.abspath(path)
+    parent_file = FileItem(os.path.dirname(path))
+    handle_file_item(parent_file)
+    if name != "":
+        parent_file.name = name
+    parent_file.show_opt_btn = False
+    return parent_file
+
+def get_index_dirs():
+    index_dirs = xauth.get_user_config("admin", "fs_index_dirs")
+    assert isinstance(index_dirs, six.string_types)
+    return index_dirs.split("\n")
+
+def get_file_thumbnail(fpath):
+    if xutils.is_img_file(fpath):
+        return xutils.get_webpath(fpath) + "?mode=thumbnail"
+
+    if xutils.is_text_file(fpath):
+        return "/_static/image/icon_txt.png"
+
+    # 位置类型
+    return "/_static/image/file2.png"
+
+def get_file_download_link(fpath):
+    if fsutil.is_parent_dir(xconfig.DATA_DIR, fpath):
+        relative_path = fsutil.get_relative_path(fpath, xconfig.DATA_DIR)
+        fpath = relative_path
+        encoded_path = xutils.encode_uri_component(fpath)
+        return "/data/%s?type=blob" % encoded_path
+    encoded_path = xutils.encode_uri_component(fpath)
+    download_link = "/fs/%s?type=blob" % encoded_path
+    return download_link
+
+
+def sort_files_by_size(filelist):
+    for file in filelist:
+        fpath = file.path
+        fpath = os.path.abspath(fpath)
+        realpath = os.path.realpath(fpath)
+        info = FileInfoModel.get_by_fpath(realpath)
+        if info != None and hasattr(info, "fsize"):
+            file.fsize = info.fsize
+            size_str = format_size(info.fsize)
+            if os.path.islink(fpath):
+                file.size = "Link(%s)" % size_str
+            else:
+                file.size = size_str
+        else:
+            file.size = "Unknown"
+
+    def key_func(file):
+        if not isinstance(file.fsize, int):
+            return 0
+        return file.fsize
+
+    filelist.sort(key = key_func, reverse = True)
+
+
+xutils.register_func("fs.get_file_thumbnail", get_file_thumbnail)
+xutils.register_func("fs.get_file_download_link", get_file_download_link)
+xutils.register_func("fs.get_index_dirs", get_index_dirs)
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_hex.py` & `xnote-web-0.1.1/handlers/fs/fs_hex.py`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,185 +1,185 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2019-01-10 00:21:16
-@LastEditors  : xupingmao
-@LastEditTime : 2023-01-21 16:48:26
-@FilePath     : /xnote/handlers/fs/fs_hex.py
-@Description  : 二进制查看工具
-"""
-
-import os
-import math
-import xutils
-from xutils import Storage
-from xnote.core.xtemplate import BasePlugin
-
-HTML = """
-<!-- Html -->
-<style>
-    .hex-text {
-        font-family: monospace;
-    }
-{% if embed == "true" %}
-    body {
-        background-color: transparent;
-    }
-{% end %}
-
-    .lineno-text {
-        width:10%;
-        float:left;
-    }
-
-    .hex-text {
-        width:50%;
-        float:left;
-    }
-
-    .plain-text {
-        width:40%;
-        float:left;
-    }
-</style>
-
-{% init plain_text = "" %}
-
-{% if embed == "true" %}
-    <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}&embed={{embed}}">编辑本文</a>
-{% else %}
-    <div class="card">
-        <div class="card-title btn-line-height">
-            <span>二进制查看</span>
-            
-            <div class="float-right">
-                <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}&embed={{embed}}">编辑本文</a>
-                {% include common/button/back_button.html %}
-            </div>
-        </div>
-    </div>
-{% end %}
-
-<div class="card">
-    {% if embed == "false" %}
-        {% include mod_fs_path.html %}
-    {% end %}
-
-    {% if error != "" %}
-        <div class="error">{{error}}</div>
-    {% end %}
-
-    <textarea class="lineno-text" rows=32>{{lineno_text}}</textarea>
-    <textarea class="hex-text" rows=32>{{hex_text}}</textarea>
-    <textarea class="plain-text" rows=32>{{plain_text}}</textarea>
-</div>
-
-"""
-
-HEX_DICT = {}
-for i in range(256):
-    HEX_DICT[i] = '%02x ' % i
-
-
-def bytes_hex(bytes):
-    out = ''
-    for b in bytes:
-        out += HEX_DICT[b]
-    return out
-
-
-def bytes_chars(bytes):
-    out = ''
-    for b in bytes:
-        c = chr(b)
-        if c.isprintable():
-            out += '%c' % c
-        else:
-            out += '.'
-    return out
-
-
-class Main(BasePlugin):
-
-    show_title = False
-    # 提示内容
-    description = ""
-    # 是否需要管理员权限
-    require_admin = True
-    category = 'dir'
-    editable = False
-
-    def handle(self, input):
-        # 输入框的行数
-        self.rows = 0
-        self.show_pagenation = True
-        self.page_max = 0
-
-        pagesize = 16 * 30
-
-        path = xutils.get_argument("path", "")
-        page = xutils.get_argument("page", 1, type=int)
-
-        assert isinstance(path, str)
-        assert isinstance(page, int)
-
-        offset = max(page-1, 0) * pagesize
-        embed = xutils.get_argument("embed", "false")
-
-        self.page_url = "?path={path}&embed={embed}&page=".format(path=path, embed=embed)
-
-        if path == "":
-            return
-
-        path = xutils.get_real_path(path)
-        hex_text = ""
-        plain_text = ""
-        lineno_text = ""
-        error = ""
-
-        if not os.path.isfile(path):
-            return "`%s` IS NOT A FILE!" % path
-        else:
-            filesize = xutils.get_file_size(path, format=False)
-            assert isinstance(filesize, int)
-            line_fmt = "%05x"
-            step = 16
-            self.page_max = math.ceil(filesize / pagesize)
-            # padding = ' ' * 4
-            try:
-                with open(path, 'rb') as fp:
-                    fp.seek(offset)
-                    for i in range(0, pagesize, step):
-                        bytes = fp.read(step)
-                        if len(bytes) == 0:
-                            break
-                        lineno_text += line_fmt % (offset + i) + "\n"
-                        hex_text += bytes_hex(bytes).ljust(step * 3) + "\n"
-                        plain_text += bytes_chars(bytes) + "\n"
-            except Exception as e:
-                xutils.print_exc()
-                error = str(e)
-            kw = Storage()
-            kw.path = path
-            kw.hex_text = hex_text
-            kw.plain_text = plain_text
-            kw.lineno_text = lineno_text
-            kw.embed = embed
-            kw.error = error
-
-            if embed == "true":
-                self.show_nav = False
-
-            self.writetemplate(HTML,**kw)
-
-    def on_init(self, context=None):
-        # 插件初始化操作
-        pass
-
-    def command(self):
-        pass
-
-
-xurls = (
-    r"/fs_hex", Main
-)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2019-01-10 00:21:16
+@LastEditors  : xupingmao
+@LastEditTime : 2023-01-21 16:48:26
+@FilePath     : /xnote/handlers/fs/fs_hex.py
+@Description  : 二进制查看工具
+"""
+
+import os
+import math
+import xutils
+from xutils import Storage
+from xnote.core.xtemplate import BasePlugin
+
+HTML = """
+<!-- Html -->
+<style>
+    .hex-text {
+        font-family: monospace;
+    }
+{% if embed == "true" %}
+    body {
+        background-color: transparent;
+    }
+{% end %}
+
+    .lineno-text {
+        width:10%;
+        float:left;
+    }
+
+    .hex-text {
+        width:50%;
+        float:left;
+    }
+
+    .plain-text {
+        width:40%;
+        float:left;
+    }
+</style>
+
+{% init plain_text = "" %}
+
+{% if embed == "true" %}
+    <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}&embed={{embed}}">编辑本文</a>
+{% else %}
+    <div class="card">
+        <div class="card-title btn-line-height">
+            <span>二进制查看</span>
+            
+            <div class="float-right">
+                <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}&embed={{embed}}">编辑本文</a>
+                {% include common/button/back_button.html %}
+            </div>
+        </div>
+    </div>
+{% end %}
+
+<div class="card">
+    {% if embed == "false" %}
+        {% include mod_fs_path.html %}
+    {% end %}
+
+    {% if error != "" %}
+        <div class="error">{{error}}</div>
+    {% end %}
+
+    <textarea class="lineno-text" rows=32>{{lineno_text}}</textarea>
+    <textarea class="hex-text" rows=32>{{hex_text}}</textarea>
+    <textarea class="plain-text" rows=32>{{plain_text}}</textarea>
+</div>
+
+"""
+
+HEX_DICT = {}
+for i in range(256):
+    HEX_DICT[i] = '%02x ' % i
+
+
+def bytes_hex(bytes):
+    out = ''
+    for b in bytes:
+        out += HEX_DICT[b]
+    return out
+
+
+def bytes_chars(bytes):
+    out = ''
+    for b in bytes:
+        c = chr(b)
+        if c.isprintable():
+            out += '%c' % c
+        else:
+            out += '.'
+    return out
+
+
+class Main(BasePlugin):
+
+    show_title = False
+    # 提示内容
+    description = ""
+    # 是否需要管理员权限
+    require_admin = True
+    category = 'dir'
+    editable = False
+
+    def handle(self, input):
+        # 输入框的行数
+        self.rows = 0
+        self.show_pagenation = True
+        self.page_max = 0
+
+        pagesize = 16 * 30
+
+        path = xutils.get_argument("path", "")
+        page = xutils.get_argument("page", 1, type=int)
+
+        assert isinstance(path, str)
+        assert isinstance(page, int)
+
+        offset = max(page-1, 0) * pagesize
+        embed = xutils.get_argument("embed", "false")
+
+        self.page_url = "?path={path}&embed={embed}&page=".format(path=path, embed=embed)
+
+        if path == "":
+            return
+
+        path = xutils.get_real_path(path)
+        hex_text = ""
+        plain_text = ""
+        lineno_text = ""
+        error = ""
+
+        if not os.path.isfile(path):
+            return "`%s` IS NOT A FILE!" % path
+        else:
+            filesize = xutils.get_file_size(path, format=False)
+            assert isinstance(filesize, int)
+            line_fmt = "%05x"
+            step = 16
+            self.page_max = math.ceil(filesize / pagesize)
+            # padding = ' ' * 4
+            try:
+                with open(path, 'rb') as fp:
+                    fp.seek(offset)
+                    for i in range(0, pagesize, step):
+                        bytes = fp.read(step)
+                        if len(bytes) == 0:
+                            break
+                        lineno_text += line_fmt % (offset + i) + "\n"
+                        hex_text += bytes_hex(bytes).ljust(step * 3) + "\n"
+                        plain_text += bytes_chars(bytes) + "\n"
+            except Exception as e:
+                xutils.print_exc()
+                error = str(e)
+            kw = Storage()
+            kw.path = path
+            kw.hex_text = hex_text
+            kw.plain_text = plain_text
+            kw.lineno_text = lineno_text
+            kw.embed = embed
+            kw.error = error
+
+            if embed == "true":
+                self.show_nav = False
+
+            self.writetemplate(HTML,**kw)
+
+    def on_init(self, context=None):
+        # 插件初始化操作
+        pass
+
+    def command(self):
+        pass
+
+
+xurls = (
+    r"/fs_hex", Main
+)
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_image.py` & `xnote-web-0.1.1/handlers/fs/fs_image.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/fs_index.py` & `xnote-web-0.1.1/handlers/fs/fs_index.py`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,239 +1,239 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/08/06 20:28:43
-# @modified 2022/04/10 21:45:11
-# @filename fs_index.py
-
-"""文件索引功能"""
-
-import logging
-import os
-import time
-import threading
-
-from xnote.core import xauth
-from xnote.core import xtemplate
-from xnote.core import xconfig
-from xnote.core import xmanager
-import xutils
-from xutils import Storage
-from xutils.sqldb import TableProxy
-from xutils import fsutil, webutil
-from .fs_helper import get_index_dirs, get_index_db, FileInfoDao, FileInfo
-
-class IndexBuilder:
-
-    _lock = threading.RLock()
-    _is_building = False
-
-    def calc_dir_size(self, db, dirname, depth=1000):
-        dirname = os.path.abspath(dirname)
-        size = 0
-        try:
-            for fname in os.listdir(dirname):
-                fpath = os.path.join(dirname, fname)
-                size += self.calc_size(db, fpath, depth-1)
-        except:
-            # 无法读取目录
-            xutils.print_exc()
-
-        info = FileInfo()
-        info.fpath = dirname
-        info.fsize = size
-        info.ftype = "dir"
-        FileInfoDao.upsert(info)
-        return size
-
-
-    def calc_size(self, db, fpath, depth=1000): 
-        # type: (TableProxy, str, int) -> int
-        if depth <= 0:
-            logging.error("too deep depth")
-            return 0
-        
-        if os.path.islink(fpath):
-            # 软链接会导致循环引用,即使用真实的路径也不能解决这个问题
-            return 0
-
-        fpath = os.path.realpath(fpath)
-        logging.info("fs_index path: %s", fpath)
-
-        if os.path.isdir(fpath):
-            return self.calc_dir_size(db, fpath, depth-1)
-        try:
-            st = os.stat(fpath)
-            info = FileInfo()
-            info.fsize = st.st_size
-            info.fpath = fpath
-            info.ctime = xutils.format_datetime(st.st_ctime)
-            info.mtime = xutils.format_datetime(st.st_mtime)
-            info.ftype = fsutil.get_file_ext(fpath)
-            FileInfoDao.upsert(info)
-            return st.st_size
-        except:
-            xutils.print_exc()
-            info = FileInfo()
-            info.fsize = -1
-            info.fpath = fpath
-            FileInfoDao.upsert(info)
-            return 0
-
-    @classmethod
-    def build_fs_index(cls, dirname, sync=False):
-        with cls._lock:
-            if cls._is_building:
-                raise Exception("正在构建索引，请稍后重试")
-            
-            if sync:
-                return cls.do_build_index(dirname)
-            else:
-                return cls.build_fs_index_async(dirname)
-
-    @classmethod
-    @xutils.async_func_deco()
-    def build_fs_index_async(cls, dirname):
-        return cls.do_build_index(dirname)
-    
-    @classmethod
-    def do_build_index(cls, dirname):
-        cls._is_building = True
-        try:
-            builder = IndexBuilder()
-            db = get_index_db()
-            size = builder.calc_size(db, dirname)
-            logging.info("Total size:%s", size)
-            return size
-        finally:
-            cls._is_building = False
-        
-
-def build_fs_index(dirname, sync=False):
-    return IndexBuilder.build_fs_index(dirname, sync)
-
-
-def update_file_index():
-    # 创建新的索引
-    build_fs_index(xconfig.DATA_DIR)
-
-    # 构建外部索引目录的索引
-    for dirname in get_index_dirs():
-        build_fs_index(dirname)
-
-class IndexHandler:
-    """文件索引管理"""
-
-    @xauth.login_required("admin")
-    def GET(self):
-        page = xutils.get_argument_int("page",1)
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(user_name, "/fs_index")
-        path = self.get_arg_path()
-        action = xutils.get_argument("p")
-        page_size = 20
-
-        if action == "rebuild":
-            return self.get_rebuild_page()
-
-        tpl = "fs/page/fs_index.html"
-        index_size = FileInfoDao.prefix_count(path)
-        
-        page_info = webutil.Pagination(page=page, total=index_size, page_size=page_size)
-        offset = (page-1) * page_size
-        
-        files = FileInfoDao.list(offset=offset, limit=20, is_admin=True)
-        for file_info in files:
-            file_info.fsize_str = "-"
-            if isinstance(file_info.fsize, int):
-                file_info.fsize_str = fsutil.format_size(file_info.fsize)
-                
-        kw = Storage()
-        kw.index_size = index_size
-        kw.files = files
-        kw.index_dirs = get_index_dirs()
-        kw.page = page
-        kw.page_max = page_info.page_max
-        kw.page_url = f"?page="
-        
-        return xtemplate.render(tpl, **kw)
-
-    @xauth.login_required("admin")
-    def POST(self):
-        is_ajax = xutils.get_argument_bool("is_ajax", False)
-        tpl = "fs/page/fs_index.html"
-        index_dirs = get_index_dirs()
-        cost = 0
-
-        action = xutils.get_argument("action")
-        path = self.get_arg_path()
-        err = ""
-        index_size = 0
-
-        try:
-            if action == "reindex":
-                cost = self.do_rebuild_index()
-
-            if action == "config":
-                return self.do_config()
-            
-            index_size = FileInfoDao.prefix_count(path)
-        except Exception as e:
-            xutils.print_exc()
-            err = str(e)
-
-        if is_ajax:
-            if err != "":
-                return dict(code="500", message=err)
-            return dict(code="success", data = index_size)
-        
-        kw = Storage()
-        kw.index_dirs = index_dirs
-        kw.index_size = index_size
-        kw.action = action
-        kw.cost = cost
-        kw.err = err
-
-        return xtemplate.render(tpl, **kw)
-    
-    def create_kw(self):
-        kw = Storage()
-        embed = xutils.get_argument_bool("embed", False)
-        if embed:
-            kw.show_nav = False
-        return kw
-    
-    def get_arg_path(self):
-        path = xutils.get_argument_str("path", "")
-        if path != "":
-            return os.path.abspath(path)
-        return path
-    
-    def do_config(self):
-        index_config = xutils.get_argument("index_config")
-        xauth.update_user_config(xauth.current_name(), "fs_index_dirs", index_config)
-        return dict(code = "success")
-
-    def do_rebuild_index(self):
-        path = self.get_arg_path()
-        t1 = time.time()
-
-        print("重建索引:", path)
-
-        if path != "":
-            build_fs_index(path)
-        else:
-            update_file_index()
-        t2 = time.time()
-        return (t2-t1)*1000
-    
-    def get_rebuild_page(self):
-        path = self.get_arg_path()
-        kw = self.create_kw()
-        kw.path = path
-        kw.show_index_dirs = False
-        kw.index_size = FileInfoDao.prefix_count(path)
-
-        return xtemplate.render("fs/page/fs_index.html", **kw)
-
-xurls = (
-    r"/fs_index", IndexHandler,
-)
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/08/06 20:28:43
+# @modified 2022/04/10 21:45:11
+# @filename fs_index.py
+
+"""文件索引功能"""
+
+import logging
+import os
+import time
+import threading
+
+from xnote.core import xauth
+from xnote.core import xtemplate
+from xnote.core import xconfig
+from xnote.core import xmanager
+import xutils
+from xutils import Storage
+from xutils.sqldb import TableProxy
+from xutils import fsutil, webutil
+from .fs_helper import get_index_dirs, get_index_db, FileInfoDao, FileInfo
+
+class IndexBuilder:
+
+    _lock = threading.RLock()
+    _is_building = False
+
+    def calc_dir_size(self, db, dirname, depth=1000):
+        dirname = os.path.abspath(dirname)
+        size = 0
+        try:
+            for fname in os.listdir(dirname):
+                fpath = os.path.join(dirname, fname)
+                size += self.calc_size(db, fpath, depth-1)
+        except:
+            # 无法读取目录
+            xutils.print_exc()
+
+        info = FileInfo()
+        info.fpath = dirname
+        info.fsize = size
+        info.ftype = "dir"
+        FileInfoDao.upsert(info)
+        return size
+
+
+    def calc_size(self, db, fpath, depth=1000): 
+        # type: (TableProxy, str, int) -> int
+        if depth <= 0:
+            logging.error("too deep depth")
+            return 0
+        
+        if os.path.islink(fpath):
+            # 软链接会导致循环引用,即使用真实的路径也不能解决这个问题
+            return 0
+
+        fpath = os.path.realpath(fpath)
+        logging.info("fs_index path: %s", fpath)
+
+        if os.path.isdir(fpath):
+            return self.calc_dir_size(db, fpath, depth-1)
+        try:
+            st = os.stat(fpath)
+            info = FileInfo()
+            info.fsize = st.st_size
+            info.fpath = fpath
+            info.ctime = xutils.format_datetime(st.st_ctime)
+            info.mtime = xutils.format_datetime(st.st_mtime)
+            info.ftype = fsutil.get_file_ext(fpath)
+            FileInfoDao.upsert(info)
+            return st.st_size
+        except:
+            xutils.print_exc()
+            info = FileInfo()
+            info.fsize = -1
+            info.fpath = fpath
+            FileInfoDao.upsert(info)
+            return 0
+
+    @classmethod
+    def build_fs_index(cls, dirname, sync=False):
+        with cls._lock:
+            if cls._is_building:
+                raise Exception("正在构建索引，请稍后重试")
+            
+            if sync:
+                return cls.do_build_index(dirname)
+            else:
+                return cls.build_fs_index_async(dirname)
+
+    @classmethod
+    @xutils.async_func_deco()
+    def build_fs_index_async(cls, dirname):
+        return cls.do_build_index(dirname)
+    
+    @classmethod
+    def do_build_index(cls, dirname):
+        cls._is_building = True
+        try:
+            builder = IndexBuilder()
+            db = get_index_db()
+            size = builder.calc_size(db, dirname)
+            logging.info("Total size:%s", size)
+            return size
+        finally:
+            cls._is_building = False
+        
+
+def build_fs_index(dirname, sync=False):
+    return IndexBuilder.build_fs_index(dirname, sync)
+
+
+def update_file_index():
+    # 创建新的索引
+    build_fs_index(xconfig.DATA_DIR)
+
+    # 构建外部索引目录的索引
+    for dirname in get_index_dirs():
+        build_fs_index(dirname)
+
+class IndexHandler:
+    """文件索引管理"""
+
+    @xauth.login_required("admin")
+    def GET(self):
+        page = xutils.get_argument_int("page",1)
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(user_name, "/fs_index")
+        path = self.get_arg_path()
+        action = xutils.get_argument("p")
+        page_size = 20
+
+        if action == "rebuild":
+            return self.get_rebuild_page()
+
+        tpl = "fs/page/fs_index.html"
+        index_size = FileInfoDao.prefix_count(path)
+        
+        page_info = webutil.Pagination(page=page, total=index_size, page_size=page_size)
+        offset = (page-1) * page_size
+        
+        files = FileInfoDao.list(offset=offset, limit=20, is_admin=True)
+        for file_info in files:
+            file_info.fsize_str = "-"
+            if isinstance(file_info.fsize, int):
+                file_info.fsize_str = fsutil.format_size(file_info.fsize)
+                
+        kw = Storage()
+        kw.index_size = index_size
+        kw.files = files
+        kw.index_dirs = get_index_dirs()
+        kw.page = page
+        kw.page_max = page_info.page_max
+        kw.page_url = f"?page="
+        
+        return xtemplate.render(tpl, **kw)
+
+    @xauth.login_required("admin")
+    def POST(self):
+        is_ajax = xutils.get_argument_bool("is_ajax", False)
+        tpl = "fs/page/fs_index.html"
+        index_dirs = get_index_dirs()
+        cost = 0
+
+        action = xutils.get_argument("action")
+        path = self.get_arg_path()
+        err = ""
+        index_size = 0
+
+        try:
+            if action == "reindex":
+                cost = self.do_rebuild_index()
+
+            if action == "config":
+                return self.do_config()
+            
+            index_size = FileInfoDao.prefix_count(path)
+        except Exception as e:
+            xutils.print_exc()
+            err = str(e)
+
+        if is_ajax:
+            if err != "":
+                return dict(code="500", message=err)
+            return dict(code="success", data = index_size)
+        
+        kw = Storage()
+        kw.index_dirs = index_dirs
+        kw.index_size = index_size
+        kw.action = action
+        kw.cost = cost
+        kw.err = err
+
+        return xtemplate.render(tpl, **kw)
+    
+    def create_kw(self):
+        kw = Storage()
+        embed = xutils.get_argument_bool("embed", False)
+        if embed:
+            kw.show_nav = False
+        return kw
+    
+    def get_arg_path(self):
+        path = xutils.get_argument_str("path", "")
+        if path != "":
+            return os.path.abspath(path)
+        return path
+    
+    def do_config(self):
+        index_config = xutils.get_argument("index_config")
+        xauth.update_user_config(xauth.current_name(), "fs_index_dirs", index_config)
+        return dict(code = "success")
+
+    def do_rebuild_index(self):
+        path = self.get_arg_path()
+        t1 = time.time()
+
+        print("重建索引:", path)
+
+        if path != "":
+            build_fs_index(path)
+        else:
+            update_file_index()
+        t2 = time.time()
+        return (t2-t1)*1000
+    
+    def get_rebuild_page(self):
+        path = self.get_arg_path()
+        kw = self.create_kw()
+        kw.path = path
+        kw.show_index_dirs = False
+        kw.index_size = FileInfoDao.prefix_count(path)
+
+        return xtemplate.render("fs/page/fs_index.html", **kw)
+
+xurls = (
+    r"/fs_index", IndexHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_mode.py` & `xnote-web-0.1.1/handlers/fs/fs_mode.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/fs_plugins.py` & `xnote-web-0.1.1/handlers/fs/fs_plugins.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/fs_preview.py` & `xnote-web-0.1.1/handlers/fs/fs_preview.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,17 +1,17 @@
 # -*- coding:utf-8 -*-
 # @author xupingmao <578749341@qq.com>
 # @since 2018/06/23 02:07:02
 # @modified 2020/03/21 17:28:19
 import os
 import web
 import xutils
-import xtemplate
-import xauth
-import xconfig
+from xnote.core import xtemplate
+from xnote.core import xauth
+from xnote.core import xconfig
 from xutils import fsutil
 
 preview_dict = xconfig.load_config_as_dict("./config/file/preview.properties")
 
 class SidebarHandler:
 
     @xauth.login_required("admin")
@@ -34,19 +34,21 @@
 class PreviewHandler:
 
     @xauth.login_required("admin")
     def GET(self):
         # TODO 使用文件扩展
         path = xutils.get_argument_str("path", "")
         embed = xutils.get_argument_str("embed", "true")
+        realname = fsutil.decode_name(path)
 
         path = xutils.get_real_path(path)
         path = path.replace("\\", "/")
         encoded_path = xutils.encode_uri_component(path)
-        _, ext = os.path.splitext(path)
+        
+        _, ext = os.path.splitext(realname)
         ext = ext.lower()
         
         open_url = preview_dict.get(ext)
         if open_url != None and open_url != "":
             quoted_path = xutils.quote(path)
             return web.seeother(open_url.format(path=encoded_path, quoted_path=quoted_path, embed = embed))
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_text.py` & `xnote-web-0.1.1/handlers/fs/fs_text.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,175 +1,175 @@
-# -*- coding:utf-8 -*-  
-# Created by xupingmao on 2022/09/24
-# @modified 2022/04/10 18:33:45
-from xnote.core import xauth, xtemplate
-import xutils
-from xutils import (
-    fsutil,
-    dbutil,
-    Storage,
-    webutil
-)
-
-TXT_INFO_VER = "v0.1"
-_db = dbutil.get_table_v2("txt_info")
-
-class TxtInfoDO(Storage):
-    
-    def __init__(self, **kw):
-        self._id = 0
-        self.user_id = 0
-        self.user_name = ""
-        self.offset = 0
-        self.pagesize = 100
-        self.total_size = 0
-        self.file_size = 0
-        self.current_offset = 0
-        self.contents = []
-        self.path = ""
-        self.encoding = ""
-        self.version = TXT_INFO_VER
-        self.update(kw)
-
-class TxtPageInfoDO(Storage):
-    
-    def __init__(self, **kw):
-        self.offset = 0
-        self.title = ""
-        self.data_size = 0
-        self.update(kw)
-
-class TextHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        method = xutils.get_argument("method", "page")
-        embed = xutils.get_argument_bool("embed")
-
-        if method == "contents":
-            return self.get_bookmark()
-        if method == "read_page":
-            return self.read_page()
-        if method == "refresh":
-            return self.refresh_txt_info()
-        
-        kw = Storage()
-        kw.embed = embed
-        kw.show_right = False
-        if embed:
-            kw.show_nav = False
-        
-        return xtemplate.render("fs/page/fs_text.html", **kw)
-
-    def get_table(self, user_name=""):
-        return _db
-    
-    def get_txt_info_record(self, user_id=0, path=""):
-        record = _db.select_first(where=dict(user_id=user_id, path=path))
-        if record != None:
-            return TxtInfoDO(**record)
-        else:
-            return None
-        
-    def save_txt_info(self, record:TxtInfoDO):
-        assert len(record.path)>0
-        if record._id == 0:
-            new_id = self.get_table().insert(record)
-            record._id = new_id
-        else:
-            self.get_table().update(record)
-
-    def get_bookmark(self):
-        path = xutils.get_argument_str("path", "")
-        if path == "":
-            return dict(code="400", message="path不能为空")
-        
-        user_info = xauth.current_user()
-        assert user_info != None
-        
-        bookmark = self.get_txt_info_record(user_info.id, path)
-        if bookmark == None:
-            bookmark = TxtInfoDO()
-        
-        bookmark.user_name = user_info.name
-        bookmark.user_id = user_info.id
-        bookmark.path = path
-        
-        if bookmark.contents == None or bookmark.version != TXT_INFO_VER:
-            bookmark = self.build_bookmark(bookmark)
-
-        return dict(code="success", data=bookmark)
-    
-    def build_bookmark(self, txt_info: TxtInfoDO):
-        fpath = txt_info.path
-        encoding = fsutil.detect_encoding(fpath)
-        contents = []
-        pagesize = 5000
-        total_size = 0
-
-        if encoding == None:
-            return dict(code="500", message="未知的文件编码")
-
-        with open(fpath, encoding=encoding, errors="ignore") as fp:
-            while True:
-                page_info = TxtPageInfoDO()
-                page_info.offset = fp.tell()
-                page_data = fp.read(pagesize)
-                if not page_data:
-                    # None(非阻塞IO)或者长度为0的字节数组
-                    break
-                page_info.title = page_data[:20]
-                page_info.data_size = len(page_data)
-                contents.append(page_info)
-                total_size += len(page_data)
-        
-        txt_info.contents = contents
-        txt_info.pagesize = pagesize
-        txt_info.version = TXT_INFO_VER
-        txt_info.encoding = encoding
-        txt_info.total_size = total_size
-        txt_info.file_size = fsutil.get_file_size_int(fpath)
-        txt_info.current_offset = 0
-        
-        self.save_txt_info(txt_info)
-        return txt_info
-    
-    def read_page(self):
-        user_id = xauth.current_user_id()
-        offset = xutils.get_argument_int("offset", 0)
-        path = xutils.get_argument_str("path", "")
-
-        txt_info = self.get_txt_info_record(user_id, path)
-        if txt_info == None:
-            return dict(code="400", message="txt信息不存在,请重试")
-
-        if offset > txt_info.file_size:
-            return dict(code="500", message="没有更多内容了")
-
-        txt_info.current_offset = offset
-        self.save_txt_info(txt_info)
-
-        with open(path, encoding=txt_info.encoding, errors="ignore") as fp:
-            fp.seek(offset)
-            page_data = fp.read(txt_info.pagesize)
-            return dict(code="success", data=page_data)
-        
-    def refresh_txt_info(self):
-        path = xutils.get_argument_str("path")
-        user_info = xauth.current_user()
-        assert user_info != None
-        
-        bookmark = self.get_txt_info_record(user_info.id, path)
-        if bookmark == None:
-            bookmark = TxtInfoDO()
-        
-        bookmark.user_name = user_info.name
-        bookmark.user_id = user_info.id
-        bookmark.path = path
-        
-        self.build_bookmark(bookmark)
-        return webutil.SuccessResult()
-    
-
-xurls = (
-    r"/fs_text", TextHandler,
+# -*- coding:utf-8 -*-  
+# Created by xupingmao on 2022/09/24
+# @modified 2022/04/10 18:33:45
+from xnote.core import xauth, xtemplate
+import xutils
+from xutils import (
+    fsutil,
+    dbutil,
+    Storage,
+    webutil
+)
+
+TXT_INFO_VER = "v0.1"
+_db = dbutil.get_table_v2("txt_info")
+
+class TxtInfoDO(Storage):
+    
+    def __init__(self, **kw):
+        self._id = 0
+        self.user_id = 0
+        self.user_name = ""
+        self.offset = 0
+        self.pagesize = 100
+        self.total_size = 0
+        self.file_size = 0
+        self.current_offset = 0
+        self.contents = []
+        self.path = ""
+        self.encoding = ""
+        self.version = TXT_INFO_VER
+        self.update(kw)
+
+class TxtPageInfoDO(Storage):
+    
+    def __init__(self, **kw):
+        self.offset = 0
+        self.title = ""
+        self.data_size = 0
+        self.update(kw)
+
+class TextHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        method = xutils.get_argument("method", "page")
+        embed = xutils.get_argument_bool("embed")
+
+        if method == "contents":
+            return self.get_bookmark()
+        if method == "read_page":
+            return self.read_page()
+        if method == "refresh":
+            return self.refresh_txt_info()
+        
+        kw = Storage()
+        kw.embed = embed
+        kw.show_right = False
+        if embed:
+            kw.show_nav = False
+        
+        return xtemplate.render("fs/page/fs_text.html", **kw)
+
+    def get_table(self, user_name=""):
+        return _db
+    
+    def get_txt_info_record(self, user_id=0, path=""):
+        record = _db.select_first(where=dict(user_id=user_id, path=path))
+        if record != None:
+            return TxtInfoDO(**record)
+        else:
+            return None
+        
+    def save_txt_info(self, record:TxtInfoDO):
+        assert len(record.path)>0
+        if record._id == 0:
+            new_id = self.get_table().insert(record)
+            record._id = new_id
+        else:
+            self.get_table().update(record)
+
+    def get_bookmark(self):
+        path = xutils.get_argument_str("path", "")
+        if path == "":
+            return dict(code="400", message="path不能为空")
+        
+        user_info = xauth.current_user()
+        assert user_info != None
+        
+        bookmark = self.get_txt_info_record(user_info.id, path)
+        if bookmark == None:
+            bookmark = TxtInfoDO()
+        
+        bookmark.user_name = user_info.name
+        bookmark.user_id = user_info.id
+        bookmark.path = path
+        
+        if bookmark.contents == None or bookmark.version != TXT_INFO_VER:
+            bookmark = self.build_bookmark(bookmark)
+
+        return dict(code="success", data=bookmark)
+    
+    def build_bookmark(self, txt_info: TxtInfoDO):
+        fpath = txt_info.path
+        encoding = fsutil.detect_encoding(fpath)
+        contents = []
+        pagesize = 5000
+        total_size = 0
+
+        if encoding == None:
+            return dict(code="500", message="未知的文件编码")
+
+        with open(fpath, encoding=encoding, errors="ignore") as fp:
+            while True:
+                page_info = TxtPageInfoDO()
+                page_info.offset = fp.tell()
+                page_data = fp.read(pagesize)
+                if not page_data:
+                    # None(非阻塞IO)或者长度为0的字节数组
+                    break
+                page_info.title = page_data[:20]
+                page_info.data_size = len(page_data)
+                contents.append(page_info)
+                total_size += len(page_data)
+        
+        txt_info.contents = contents
+        txt_info.pagesize = pagesize
+        txt_info.version = TXT_INFO_VER
+        txt_info.encoding = encoding
+        txt_info.total_size = total_size
+        txt_info.file_size = fsutil.get_file_size_int(fpath)
+        txt_info.current_offset = 0
+        
+        self.save_txt_info(txt_info)
+        return txt_info
+    
+    def read_page(self):
+        user_id = xauth.current_user_id()
+        offset = xutils.get_argument_int("offset", 0)
+        path = xutils.get_argument_str("path", "")
+
+        txt_info = self.get_txt_info_record(user_id, path)
+        if txt_info == None:
+            return dict(code="400", message="txt信息不存在,请重试")
+
+        if offset > txt_info.file_size:
+            return dict(code="500", message="没有更多内容了")
+
+        txt_info.current_offset = offset
+        self.save_txt_info(txt_info)
+
+        with open(path, encoding=txt_info.encoding, errors="ignore") as fp:
+            fp.seek(offset)
+            page_data = fp.read(txt_info.pagesize)
+            return dict(code="success", data=page_data)
+        
+    def refresh_txt_info(self):
+        path = xutils.get_argument_str("path")
+        user_info = xauth.current_user()
+        assert user_info != None
+        
+        bookmark = self.get_txt_info_record(user_info.id, path)
+        if bookmark == None:
+            bookmark = TxtInfoDO()
+        
+        bookmark.user_name = user_info.name
+        bookmark.user_id = user_info.id
+        bookmark.path = path
+        
+        self.build_bookmark(bookmark)
+        return webutil.SuccessResult()
+    
+
+xurls = (
+    r"/fs_text", TextHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/fs/fs_upload.py` & `xnote-web-0.1.1/handlers/fs/fs_upload.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,435 +1,449 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2017
-# @modified 2021/07/31 14:27:13
-import os
-import web
-import logging
-from xnote.core import xauth
-from xnote.core import xconfig
-import xutils
-from xnote.core import xtemplate
-from xnote.core import xmanager
-import time
-import math
-from xutils import fsutil, Storage, dateutil
-from xutils import webutil
-from xnote.core.xtemplate import T
-from xnote.core.xnote_event import FileUploadEvent
-from .fs_helper import FileInfoDao
-from xutils.fsutil import get_safe_file_name
-try:
-    from PIL import Image
-except ImportError:
-    Image = None
-
-
-# 完整的元信息参考文档 https://zhuanlan.zhihu.com/p/366726838
-TAG_ORIENTATION = 0x112
-
-
-def get_link(filename, webpath):
-    """返回Markdown的链接"""
-    if xutils.is_img_file(filename):
-        return "![%s](%s)" % (filename, webpath)
-    return "[%s](%s)" % (filename, webpath)
-
-
-def generate_filename(filename, prefix="", ext=None):
-    if prefix:
-        prefix = prefix + '_'
-    else:
-        prefix = ""
-
-    if filename is None:
-        filename = time.strftime("%Y%m%d")
-        filename += "_" + xutils.create_uuid()
-    filename = get_safe_file_name(filename)
-    if ext:
-        filename += ext
-    return prefix + filename
-
-
-def get_display_name(fpath, parent):
-    path = xutils.get_relative_path(fpath, parent)
-    return xutils.unquote(path)
-
-
-def get_webpath(fpath):
-    rpath = xutils.get_relative_path(fpath, xconfig.DATA_DIR)
-    return "/data/" + rpath
-
-
-def upload_link_by_month(year, month, delta=0):
-    t_mon = (month - 1 + delta) % 12 + 1
-    t_year = year + math.floor((month-1+delta)/12)
-    return "/fs_upload?year=%d&month=%02d" % (t_year, t_mon)
-
-
-def try_touch_note(note_id):
-    if note_id != None and note_id != "":
-        xutils.call("note.touch", note_id)
-
-
-def try_lock_file(fpath):
-    return True
-
-def try_fix_orientation(fpath):
-    fix_orientation = xutils.get_argument("fix_orientation", "")
-    # print("fix_orientation", fix_orientation)
-    if fix_orientation != "true":
-        return
-
-    if Image == None:
-        # 没有安装PIL
-        return
-
-    name, ext = os.path.splitext(fpath)
-    if ext.lower() not in (".jpg", ".jpeg"):
-        return
-
-    tmp_path = fsutil.tmp_path(xutils.create_uuid())
-    os.rename(fpath, tmp_path)
-
-    with Image.open(tmp_path) as img:
-        exif = img.getexif()
-        # print("exif", exif)
-        orientation = exif.get(TAG_ORIENTATION)
-
-        if orientation in (3, 6):
-            print("fix orientation")
-            img_new = img.copy()
-            exif_new = img_new.getexif()
-            exif_new[TAG_ORIENTATION] = 1
-            img_new.save(fpath)
-            img_new.close()
-            os.remove(tmp_path)
-        else:
-            # 重新命名回去
-            os.rename(tmp_path, fpath)
-
-# 业务上用到的函数
-
-def get_user_upload_dir(user):
-    return os.path.join(xconfig.UPLOAD_DIR, user)
-
-def get_upload_file_path(user, filename, upload_dir="files", rename_conflict=False):
-    """生成上传文件名"""
-    from xnote.core import xconfig
-    if xconfig.USE_URLENCODE:
-        origin_filename = filename
-        filename = xutils.quote_unicode(filename)
-        if origin_filename != filename:
-            filename = xutils.encode_name(filename)
-
-    basename, ext = os.path.splitext(filename)
-    date = time.strftime("upload/%Y/%m")
-    dirname = os.path.join(xconfig.DATA_PATH, upload_dir, user, date)
-    fsutil.makedirs(dirname)
-
-    origin_filename = os.path.join(dirname, filename)
-    fileindex = 1
-
-    newfilepath = origin_filename
-    webpath = "/data/{}/{}/{}/{}".format(upload_dir, user, date, filename)
-    if filename == "":
-        # get upload directory
-        return os.path.abspath(dirname), webpath
-
-    while not rename_conflict and os.path.exists(newfilepath):
-        name, ext = os.path.splitext(filename)
-        # 使用下划线，括号会使marked.js解析图片url失败
-        temp_filename = "{}_{}{}".format(name, fileindex, ext)
-        newfilepath = os.path.join(dirname, temp_filename)
-        webpath = "/data/{}/{}/{}/{}".format(upload_dir,
-                                             user, date, temp_filename)
-        fileindex += 1
-    return os.path.abspath(newfilepath), webpath
-
-
-class UploadHandler:
-
-    def get_recovery_path(self, fpath=""):
-        fpath = fpath.replace("$data", xconfig.FileConfig.data_dir)
-        return fpath, fsutil.get_webpath(fpath)
-
-    @xauth.login_required()
-    def POST(self):
-        try:
-            return self.do_post()
-        except Exception as e:
-            err_stack = xutils.print_exc()
-            err_msg = str(e)
-            if xauth.is_admin():
-                err_msg = err_stack
-            return webutil.FailedResult(code="500", message=err_msg)
-        
-    def do_post(self):
-        file = xutils.get_argument_field_storage("file")
-        prefix = xutils.get_argument_str("prefix")
-        name = xutils.get_argument_str("name")
-        note_id = xutils.get_argument_str("note_id")
-        upload_type = xutils.get_argument_str("upload_type")
-
-        user_info = xauth.current_user()
-        assert user_info != None
-        user_name = user_info.name
-        webpath = ""
-        filename = ""
-
-        if file.file is None:
-            return webutil.FailedResult(code="400", message="file.file is None")
-        
-        if file.filename is None:
-            return webutil.FailedResult(code="400", message="file.filename is None")
-        
-        filename = get_safe_file_name(file.filename)
-        basename, ext = os.path.splitext(filename)
-        if name == "auto":
-            # iOS上传文件截图文件固定是image.png
-            filename = generate_filename(None, prefix, ext)
-
-        if upload_type == "recovery":
-            if not xauth.is_admin():
-                return webutil.FailedResult(code="403", message="recovery mode is only allowed by admin")
-            filepath, webpath = self.get_recovery_path(filename)
-            dirs = os.path.dirname(filepath)
-            fsutil.makedirs(dirs)
-        else:
-            filepath, webpath = get_upload_file_path(user_name, filename)
-
-        with open(filepath, "wb") as fout:
-            for chunk in file.file:
-                fout.write(chunk)
-        
-        event = FileUploadEvent()
-        event.fpath = filepath
-        event.user_name = user_info.name
-        event.user_id = user_info.id
-        xmanager.fire("fs.upload", event)
-
-        try_fix_orientation(filepath)
-        try_touch_note(note_id)
-
-        result = webutil.SuccessResult()
-        result.webpath = webpath
-        result.link = get_link(filename, webpath)
-        return result
-
-    @xauth.login_required()
-    def GET(self):
-        return self.get_upload_page_v1()
-        
-    def get_upload_page_v1(self):
-        user_info = xauth.current_user()
-        assert user_info != None
-        user_name = user_info.name
-        xmanager.add_visit_log(user_name, "/fs_upload")
-
-        year = xutils.get_argument_str("year", time.strftime("%Y"))
-        month = xutils.get_argument_str("month", time.strftime("%m"))
-        if len(month) == 1:
-            month = '0' + month
-        
-
-        dirname = os.path.join(xconfig.FileConfig.data_dir, "files",
-                               user_name, "upload", year, month)
-        pathlist = fsutil.listdir_abs(dirname)
-        
-        return xtemplate.render("fs/page/fs_upload.html",
-                                show_aside=False,
-                                html_title=T("文件"),
-                                pathlist=pathlist,
-                                year=int(year),
-                                month=int(month),
-                                path=dirname,
-                                dirname=dirname,
-                                get_webpath=get_webpath,
-                                upload_link_by_month=upload_link_by_month,
-                                get_display_name=get_display_name)
-
-    def get_upload_page_v2(self):
-        # TODO 基于数据库数据的上传页面
-        user_info = xauth.current_user()
-        assert user_info != None
-        user_name = user_info.name
-        xmanager.add_visit_log(user_name, "/fs_upload")
-
-        user_id = user_info.id
-        files = FileInfoDao.list(user_id=user_id, limit=50)
-        
-        kw = Storage()
-        kw.html_title = T("文件")
-        kw.files = files
-        
-        return xtemplate.render("fs/page/fs_upload_v2.html",**kw)
-    
-
-class RangeUploadHandler:
-
-    def merge_files(self, dirname, filename, chunks):
-        dest_path = os.path.join(dirname, filename)
-        user_info = xauth.current_user()
-        assert user_info != None
-        user_name = user_info.name
-
-        with open(dest_path, "wb") as fp:
-            for chunk in range(chunks):
-                filename = get_safe_file_name(filename)
-                tmp_path = os.path.join(dirname, filename)
-                tmp_path = "%s_%d.part" % (tmp_path, chunk)
-                if not os.path.exists(tmp_path):
-                    raise Exception("upload file broken")
-                with open(tmp_path, "rb") as tmp_fp:
-                    fp.write(tmp_fp.read())
-                xutils.remove(tmp_path, True)
-
-            event = FileUploadEvent()
-            event.user_name = user_name
-            event.user_id = user_info.id
-            event.fpath = dest_path
-            xmanager.fire("fs.upload", event)
-
-    def is_fixed_name(self, filename):
-        name, ext = os.path.splitext(filename)
-        return name == "image"
-
-    def find_available_path(self, filename):
-        name, ext = os.path.splitext(filename)
-        assert name == "image"
-        return name + "_" + xutils.create_uuid() + ext
-
-    @xauth.login_required()
-    def POST(self):
-        user_name = xauth.current_name()
-        part_file = True
-        chunksize = 5 * 1024 * 1024
-        chunk = xutils.get_argument_int("chunk")
-        chunks = xutils.get_argument("chunks", 1, type=int)
-        file = xutils.get_argument_field_storage("file")
-        prefix = xutils.get_argument_str("prefix", "")
-        dirname = xutils.get_argument_str("dirname", xconfig.DATA_DIR)
-        dirname = dirname.replace("$DATA", xconfig.DATA_DIR)
-        note_id = xutils.get_argument("note_id")
-
-        # 不能访问上级目录
-        if ".." in dirname:
-            return dict(code="fail", message="can not access parent directory")
-
-        if not hasattr(file, "filename"):
-            return webutil.FailedResult(code="400", message="请选择文件")
-        
-        if file.file is None:
-            return webutil.FailedResult(code="400", message="file.file is None")
-
-        filename = None
-        webpath = ""
-        origin_name = ""
-        filepath = ""
-
-        origin_name = file.filename
-        xutils.trace("UploadFile", file.filename)
-        if origin_name is None:
-            return webutil.FailedResult(code="400", message="file.filename is None")
-        
-        filename = os.path.basename(origin_name)
-        filename = get_safe_file_name(filename)
-
-        if dirname == "auto":
-            filename = generate_filename(None, prefix)
-            filepath, webpath = get_upload_file_path(
-                user_name, filename, rename_conflict=True)
-            dirname = os.path.dirname(filepath)
-            filename = os.path.basename(filepath)
-        else:
-            # check permission.
-            if xauth.current_role() != "admin":
-                # 普通用户操作
-                user_upload_dir = get_user_upload_dir(user_name)
-                if not fsutil.is_parent_dir(user_upload_dir, dirname):
-                    return dict(code="403", message="无权操作")
-
-            filepath = os.path.join(dirname, filename)
-        
-        if self.is_fixed_name(origin_name):
-            filename = self.find_available_path(origin_name)
-            filepath = os.path.join(dirname, filename)
-
-        if chunk == 0:
-            lock = try_lock_file(filepath)
-
-        if os.path.exists(filepath):
-            # return dict(code = "fail", message = "文件已存在")
-            web.ctx.status = "500 Server Error"
-            return dict(code="fail", message="文件已存在")
-
-        if part_file:
-            tmp_name = "%s_%d.part" % (filename, chunk)
-            seek = 0
-        else:
-            tmp_name = filename
-            seek = chunk * chunksize
-
-        xutils.makedirs(dirname)
-        tmp_path = os.path.join(dirname, tmp_name)
-
-        with open(tmp_path, "wb") as fp:
-            fp.seek(seek)
-            if seek != 0:
-                logging.info("seek to %s", seek)
-            for file_chunk in file.file:
-                fp.write(file_chunk)
-        
-        if part_file and chunk+1 == chunks:
-            self.merge_files(dirname, filename, chunks)
-
-        try_fix_orientation(filepath)
-        try_touch_note(note_id)
-
-        if note_id != None and note_id != "":
-            xutils.call("note.touch", note_id)
-        return dict(code="success", webpath=webpath, link=get_link(origin_name, webpath))
-
-
-class UploadSearchHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        key = xutils.get_argument_str("key")
-        user_name = xauth.current_name_str()
-        user_dir = os.path.join(xconfig.UPLOAD_DIR, user_name)
-
-        find_key = "*" + key + "*"
-        if find_key == "**":
-            plist = []
-        else:
-            plist = sorted(xutils.search_path(user_dir, find_key, "file"))
-
-        return xtemplate.render("fs/page/fs_upload.html",
-                                show_aside=False,
-                                html_title=T("文件"),
-                                page="search",
-                                pathlist=plist,
-                                path=user_dir,
-                                dirname=user_dir,
-                                get_webpath=get_webpath,
-                                upload_link_by_month=upload_link_by_month,
-                                get_display_name=get_display_name)
-
-
-class CheckHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        pass
-
-
-xutils.register_func("fs.get_upload_file_path", get_upload_file_path)
-
-xurls = (
-    # 和文件系统的/fs/冲突了
-    r"/fs_upload", UploadHandler,
-    r"/fs_upload/check", CheckHandler,
-    r"/fs_upload/search", UploadSearchHandler,
-    r"/fs_upload/range", RangeUploadHandler
-)
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2017
+# @modified 2021/07/31 14:27:13
+import os
+import web
+import logging
+from xnote.core import xauth
+from xnote.core import xconfig
+import xutils
+from xnote.core import xtemplate
+from xnote.core import xmanager
+import time
+import math
+from xutils import fsutil, Storage, dateutil
+from xutils import webutil
+from xutils.base import XnoteException
+from xnote.core.xtemplate import T
+from xnote.core.xnote_event import FileUploadEvent
+from .fs_helper import FileInfoDao
+from handlers.fs import fs_checker
+from xutils.fsutil import get_safe_file_name
+try:
+    from PIL import Image
+except ImportError:
+    Image = None
+
+
+# 完整的元信息参考文档 https://zhuanlan.zhihu.com/p/366726838
+TAG_ORIENTATION = 0x112
+
+
+def get_link(filename, webpath):
+    """返回Markdown的链接"""
+    if xutils.is_img_file(filename):
+        return "![%s](%s)" % (filename, webpath)
+    return "[%s](%s)" % (filename, webpath)
+
+
+def generate_filename(filename, prefix="", ext=None):
+    if prefix:
+        prefix = prefix + '_'
+    else:
+        prefix = ""
+
+    if filename is None:
+        filename = time.strftime("%Y%m%d")
+        filename += "_" + xutils.create_uuid()
+    filename = get_safe_file_name(filename)
+    if ext:
+        filename += ext
+    return prefix + filename
+
+
+def get_display_name(fpath, parent):
+    path = xutils.get_relative_path(fpath, parent)
+    return xutils.unquote(path)
+
+
+def get_webpath(fpath):
+    rpath = xutils.get_relative_path(fpath, xconfig.DATA_DIR)
+    return "/data/" + rpath
+
+
+def upload_link_by_month(year, month, delta=0):
+    t_mon = (month - 1 + delta) % 12 + 1
+    t_year = year + math.floor((month-1+delta)/12)
+    return "/fs_upload?year=%d&month=%02d" % (t_year, t_mon)
+
+
+def try_touch_note(note_id):
+    if note_id != None and note_id != "":
+        xutils.call("note.touch", note_id)
+
+
+def try_lock_file(fpath):
+    return True
+
+def try_fix_orientation(fpath):
+    fix_orientation = xutils.get_argument("fix_orientation", "")
+    # print("fix_orientation", fix_orientation)
+    if fix_orientation != "true":
+        return
+
+    if Image == None:
+        # 没有安装PIL
+        return
+
+    name, ext = os.path.splitext(fpath)
+    if ext.lower() not in (".jpg", ".jpeg"):
+        return
+
+    tmp_path = fsutil.tmp_path(xutils.create_uuid())
+    os.rename(fpath, tmp_path)
+
+    with Image.open(tmp_path) as img:
+        exif = img.getexif()
+        # print("exif", exif)
+        orientation = exif.get(TAG_ORIENTATION)
+
+        if orientation in (3, 6):
+            print("fix orientation")
+            img_new = img.copy()
+            exif_new = img_new.getexif()
+            exif_new[TAG_ORIENTATION] = 1
+            img_new.save(fpath)
+            img_new.close()
+            os.remove(tmp_path)
+        else:
+            # 重新命名回去
+            os.rename(tmp_path, fpath)
+
+# 业务上用到的函数
+
+def get_user_upload_dir(user):
+    return os.path.join(xconfig.UPLOAD_DIR, user)
+
+def get_upload_file_path(user, filename, upload_dir="files", rename_conflict=False):
+    """生成上传文件名"""
+    from xnote.core import xconfig
+    if xconfig.USE_URLENCODE:
+        origin_filename = filename
+        filename = xutils.quote_unicode(filename)
+        if origin_filename != filename:
+            filename = xutils.encode_name(filename)
+
+    basename, ext = os.path.splitext(filename)
+    date = time.strftime("upload/%Y/%m")
+    dirname = os.path.join(xconfig.DATA_PATH, upload_dir, user, date)
+    fsutil.makedirs(dirname)
+
+    origin_filename = os.path.join(dirname, filename)
+    fileindex = 1
+
+    newfilepath = origin_filename
+    webpath = "/data/{}/{}/{}/{}".format(upload_dir, user, date, filename)
+    if filename == "":
+        # get upload directory
+        return os.path.abspath(dirname), webpath
+
+    while not rename_conflict and os.path.exists(newfilepath):
+        name, ext = os.path.splitext(filename)
+        # 使用下划线，括号会使marked.js解析图片url失败
+        temp_filename = "{}_{}{}".format(name, fileindex, ext)
+        newfilepath = os.path.join(dirname, temp_filename)
+        webpath = "/data/{}/{}/{}/{}".format(upload_dir,
+                                             user, date, temp_filename)
+        fileindex += 1
+    return os.path.abspath(newfilepath), webpath
+
+
+class UploadHandler:
+
+    def get_recovery_path(self, fpath=""):
+        fpath = fpath.replace("$data", xconfig.FileConfig.data_dir)
+        return fpath, fsutil.get_webpath(fpath)
+
+    @xauth.login_required()
+    def POST(self):
+        try:
+            return self.do_post()
+        except XnoteException as e:
+            return webutil.FailedResult(code=e.code, message=e.message)
+        except Exception as e:
+            err_stack = xutils.print_exc()
+            err_msg = str(e)
+            if xauth.is_admin():
+                err_msg = err_stack
+            return webutil.FailedResult(code="500", message=err_msg)
+        
+    def do_post(self):
+        file = xutils.get_argument_field_storage("file")
+        prefix = xutils.get_argument_str("prefix")
+        name = xutils.get_argument_str("name")
+        note_id = xutils.get_argument_str("note_id")
+        upload_type = xutils.get_argument_str("upload_type")
+
+        user_info = xauth.current_user()
+        assert user_info != None
+        user_name = user_info.name
+        webpath = ""
+        filename = ""
+
+        if file.file is None:
+            return webutil.FailedResult(code="400", message="file.file is None")
+        
+        if file.filename is None:
+            return webutil.FailedResult(code="400", message="file.filename is None")
+        
+        fs_checker.check_file_name(file.filename)
+
+        filename = get_safe_file_name(file.filename)
+        basename, ext = os.path.splitext(filename)
+        if name == "auto":
+            # iOS上传文件截图文件固定是image.png
+            filename = generate_filename(None, prefix, ext)
+
+        if upload_type == "recovery":
+            if not xauth.is_admin():
+                return webutil.FailedResult(code="403", message="recovery mode is only allowed by admin")
+            filepath, webpath = self.get_recovery_path(filename)
+            dirs = os.path.dirname(filepath)
+            fsutil.makedirs(dirs)
+        else:
+            filepath, webpath = get_upload_file_path(user_name, filename)
+
+        with open(filepath, "wb") as fout:
+            for chunk in file.file:
+                fout.write(chunk)
+        
+        event = FileUploadEvent()
+        event.fpath = filepath
+        event.user_name = user_info.name
+        event.user_id = user_info.id
+        xmanager.fire("fs.upload", event)
+
+        try_fix_orientation(filepath)
+        try_touch_note(note_id)
+
+        result = webutil.SuccessResult()
+        result.webpath = webpath
+        result.link = get_link(filename, webpath)
+        return result
+
+    @xauth.login_required()
+    def GET(self):
+        return self.get_upload_page_v1()
+        
+    def get_upload_page_v1(self):
+        user_info = xauth.current_user()
+        assert user_info != None
+        user_name = user_info.name
+        xmanager.add_visit_log(user_name, "/fs_upload")
+
+        year = xutils.get_argument_str("year", time.strftime("%Y"))
+        month = xutils.get_argument_str("month", time.strftime("%m"))
+        if len(month) == 1:
+            month = '0' + month
+        
+
+        dirname = os.path.join(xconfig.FileConfig.data_dir, "files",
+                               user_name, "upload", year, month)
+        pathlist = fsutil.listdir_abs(dirname)
+        
+        return xtemplate.render("fs/page/fs_upload.html",
+                                show_aside=False,
+                                html_title=T("文件"),
+                                pathlist=pathlist,
+                                year=int(year),
+                                month=int(month),
+                                path=dirname,
+                                dirname=dirname,
+                                get_webpath=get_webpath,
+                                upload_link_by_month=upload_link_by_month,
+                                get_display_name=get_display_name)
+
+    def get_upload_page_v2(self):
+        # TODO 基于数据库数据的上传页面
+        user_info = xauth.current_user()
+        assert user_info != None
+        user_name = user_info.name
+        xmanager.add_visit_log(user_name, "/fs_upload")
+
+        user_id = user_info.id
+        files = FileInfoDao.list(user_id=user_id, limit=50)
+        
+        kw = Storage()
+        kw.html_title = T("文件")
+        kw.files = files
+        
+        return xtemplate.render("fs/page/fs_upload_v2.html",**kw)
+    
+
+class RangeUploadHandler:
+
+    def merge_files(self, dirname, filename, chunks):
+        dest_path = os.path.join(dirname, filename)
+        user_info = xauth.current_user()
+        assert user_info != None
+        user_name = user_info.name
+
+        with open(dest_path, "wb") as fp:
+            for chunk in range(chunks):
+                filename = get_safe_file_name(filename)
+                tmp_path = os.path.join(dirname, filename)
+                tmp_path = "%s_%d.part" % (tmp_path, chunk)
+                if not os.path.exists(tmp_path):
+                    raise Exception("upload file broken")
+                with open(tmp_path, "rb") as tmp_fp:
+                    fp.write(tmp_fp.read())
+                xutils.remove(tmp_path, True)
+
+            event = FileUploadEvent()
+            event.user_name = user_name
+            event.user_id = user_info.id
+            event.fpath = dest_path
+            xmanager.fire("fs.upload", event)
+
+    def is_fixed_name(self, filename):
+        name, ext = os.path.splitext(filename)
+        return name == "image"
+
+    def find_available_path(self, filename):
+        name, ext = os.path.splitext(filename)
+        assert name == "image"
+        return name + "_" + xutils.create_uuid() + ext
+
+    def POST(self):
+        try:
+            return self.do_post()
+        except XnoteException as e:
+            return webutil.FailedResult(code=e.code, message=e.message)
+
+    @xauth.login_required()
+    def do_post(self):
+        user_name = xauth.current_name()
+        part_file = True
+        chunksize = 5 * 1024 * 1024
+        chunk = xutils.get_argument_int("chunk")
+        chunks = xutils.get_argument("chunks", 1, type=int)
+        file = xutils.get_argument_field_storage("file")
+        prefix = xutils.get_argument_str("prefix", "")
+        dirname = xutils.get_argument_str("dirname", xconfig.DATA_DIR)
+        dirname = dirname.replace("$DATA", xconfig.DATA_DIR)
+        note_id = xutils.get_argument("note_id")
+
+        # 不能访问上级目录
+        if ".." in dirname:
+            return dict(code="fail", message="can not access parent directory")
+
+        if not hasattr(file, "filename"):
+            return webutil.FailedResult(code="400", message="请选择文件")
+        
+        if file.file is None:
+            return webutil.FailedResult(code="400", message="file.file is None")
+        if file.filename is None:
+            return webutil.FailedResult(code="400", message="file.filename is None")
+
+        filename = None
+        webpath = ""
+        origin_name = ""
+        filepath = ""
+
+        origin_name = file.filename
+        fs_checker.check_file_name(origin_name)
+
+        xutils.trace("UploadFile", file.filename)
+        
+        filename = os.path.basename(origin_name)
+        filename = get_safe_file_name(filename)
+
+        if dirname == "auto":
+            filename = generate_filename(None, prefix)
+            filepath, webpath = get_upload_file_path(
+                user_name, filename, rename_conflict=True)
+            dirname = os.path.dirname(filepath)
+            filename = os.path.basename(filepath)
+        else:
+            # check permission.
+            if xauth.current_role() != "admin":
+                # 普通用户操作
+                user_upload_dir = get_user_upload_dir(user_name)
+                if not fsutil.is_parent_dir(user_upload_dir, dirname):
+                    return dict(code="403", message="无权操作")
+
+            filepath = os.path.join(dirname, filename)
+        
+        if self.is_fixed_name(origin_name):
+            filename = self.find_available_path(origin_name)
+            filepath = os.path.join(dirname, filename)
+
+        if chunk == 0:
+            lock = try_lock_file(filepath)
+
+        if os.path.exists(filepath):
+            # return dict(code = "fail", message = "文件已存在")
+            web.ctx.status = "500 Server Error"
+            return dict(code="fail", message="文件已存在")
+
+        if part_file:
+            tmp_name = "%s_%d.part" % (filename, chunk)
+            seek = 0
+        else:
+            tmp_name = filename
+            seek = chunk * chunksize
+
+        xutils.makedirs(dirname)
+        tmp_path = os.path.join(dirname, tmp_name)
+
+        with open(tmp_path, "wb") as fp:
+            fp.seek(seek)
+            if seek != 0:
+                logging.info("seek to %s", seek)
+            for file_chunk in file.file:
+                fp.write(file_chunk)
+        
+        if part_file and chunk+1 == chunks:
+            self.merge_files(dirname, filename, chunks)
+
+        try_fix_orientation(filepath)
+        try_touch_note(note_id)
+
+        if note_id != None and note_id != "":
+            xutils.call("note.touch", note_id)
+        return dict(code="success", webpath=webpath, link=get_link(origin_name, webpath))
+
+
+class UploadSearchHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        key = xutils.get_argument_str("key")
+        user_name = xauth.current_name_str()
+        user_dir = os.path.join(xconfig.UPLOAD_DIR, user_name)
+
+        find_key = "*" + key + "*"
+        if find_key == "**":
+            plist = []
+        else:
+            plist = sorted(xutils.search_path(user_dir, find_key, "file"))
+
+        return xtemplate.render("fs/page/fs_upload.html",
+                                show_aside=False,
+                                html_title=T("文件"),
+                                page="search",
+                                pathlist=plist,
+                                path=user_dir,
+                                dirname=user_dir,
+                                get_webpath=get_webpath,
+                                upload_link_by_month=upload_link_by_month,
+                                get_display_name=get_display_name)
+
+
+class CheckHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        pass
+
+
+xutils.register_func("fs.get_upload_file_path", get_upload_file_path)
+
+xurls = (
+    # 和文件系统的/fs/冲突了
+    r"/fs_upload", UploadHandler,
+    r"/fs_upload/check", CheckHandler,
+    r"/fs_upload/search", UploadSearchHandler,
+    r"/fs_upload/range", RangeUploadHandler
+)
```

### Comparing `xnote-web-0.1.0/handlers/fs/mod_aside.html` & `xnote-web-0.1.1/handlers/fs/mod_aside.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/mod_fs_upload.html` & `xnote-web-0.1.1/handlers/fs/mod_fs_upload.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs.html` & `xnote-web-0.1.1/handlers/fs/page/fs.html`

 * *Files 1% similar despite different names*

```diff
@@ -54,15 +54,15 @@
                 <div class="float-right">
                     <span class="fs-size-span">{{_item.size}}</span>
                     <span>&nbsp;</span>
                     <button class="btn btn-default" 
                         data-path="{{_item.path}}"
                         data-name="{{_item.name}}"
                         data-realname="{{_item.realname}}"
-                        onclick="xnote.action.fs.openOptionDialog(this)">{{T("操作")}}</button>
+                        onclick="xnote.action.fs.openOptionDialog(this, event)">{{T("操作")}}</button>
                 </div>
                 {% end %}
             </a>
         {% end %}
     </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_bookmark.html` & `xnote-web-0.1.1/handlers/note/component/editor/gallery.html`

 * *Files 21% similar despite different names*

```diff
@@ -1,79 +1,97 @@
-{% extends base %}
 
-{% block head %}
+{% import xutils.textutil as textutil %}
+{% init parent_path = None %}
 
-{% set search_action = '/fs_find' %}
-{% set search_placeholder = '搜索文件' %}
+{% include note/component/css/gallery_css.html %}
 
-<style type="text/css">
-    [color=red] {
-        color: red;
-    }
-</style>
+<div class="card">
+    {% include note/component/view_header.html %}
+</div>
 
-{% end %}
+<div class="card">
+    {% include note/component/note_path.html %}
+</div>
 
-{% block search_form %}
-    <input type="text" name="path" class="hide" value="{{?path}}"/>
-{% end %}
+<div class="card btn-line-height">
+    {% include note/component/view_header_tag.html %}
+</div>
 
+<style id="gallery-css" type="text/css"></style>
 
-{% block body_left %}
+<script type="text/javascript">
+xnote.execute(function () {
+    $("#noteIdInput").val("{{file.id}}");
+    function updateSize() { 
+        console.log("updateSize");
+        var listWidth = xnote.device.contentLeftWidth - 10;
+        var photoWidth = 150; // PC的默认值
+
+        if (xnote.device.isMobile) {
+            photoWidth = 100;
+            listWidth = listWidth - 20; // 移动端有一个padding
+        }
 
-    {% init find_key = "" %}
-    {% init error = "" %}
-    {% init show_fs_path = True %}
-    {% init search_category = "fs" %}
-    {% init show_hidden_files = False %}
+        var cols = parseInt(listWidth / photoWidth);
+        photoWidth = parseInt(listWidth / cols);
 
-    <div class="hide error row"></div>
-    <div class="hide success row"></div>
+        console.log("photoWidth:", photoWidth);
 
-    <div class="grid-card">
-        {% include fs/component/fs_title.html %}
-    </div>
+        var cssText = ".gallery-item{ width: ${width}px; height:${width}px;}";
+        cssText = xnote.renderTemplate(cssText, {width: photoWidth});
 
-    <div class="card">
-        {% for _item in filelist %}
-            <a class="list-item" href="{{_item.url}}">
-                <i class="fa {{_item.icon}}"></i>
-                <span>{{_item.name}}</span>
-
-                {% if _item.is_user_defined %}
-                    <div class="float-right">
-                        <button data-path="{{_item.path}}" class="btn btn-default remove-btn">{{T("移除")}}</button>
-                    </div>
-                {% end %}
-            </a>
-        {% end %}
-    </div>
+        $("#gallery-css").html(cssText);
+        // 采用读写分离的方式，阅读和编辑使用两个不同的视图
+    }
 
-<script type="text/javascript">
-$(function () {
-    $(".remove-btn").click(function (e) {
-        e.preventDefault();
-        var path = $(e.target).attr("data-path")
-        var params = {
-            action:"remove",
-            path: path,
+    xnote.events.onUploadPrepareEvent(function (event) {
+        console.log("onUploadPrepareEvent", event);
+        if (event.target.uploadType == "fs") {
+            $.post("/note/touch", {id: "{{file.id}}", resp_type: "json"}, function (resp) {
+                console.log(resp);
+            });
         }
+    });
 
-        xnote.confirm("确定要取消收藏文件<code color=red>" + path + "</code>?", function () {        
-            $.post("/fs_api/bookmark", params, function (resp) {
-                if (resp.code == "success") {
-                    window.location.reload()
-                } else {
-                    xnote.alert("取消收藏失败，请稍后重试!")
-                }
-            })
-        })
-
-    })
-})
+    updateSize();
+    $(window).on("resize", updateSize);
+});
 </script>
-{% end %}
 
+<div class="card">
+    <!-- 上传文件组件 -->
+    {% if file.creator == _user_name %} 
+        {% include fs/mod_fs_upload.html %}
+    {% end %}
+
+
+    <div class="file-list">
+        {% for item in filelist %}
+            {# 隐藏文件 #}
+            {% if item.name == "" %}
+                {% continue %}
+            {% end %}
+            
+            {% if xconfig.FS_HIDE_FILES and (item.name[0] == "." or item.name.endswith((".pyc", ".class"))) %}
+                {% continue %}
+            {% end %}
+
+            {% if not item.name.startswith("._") %}
+                <div class="gallery-item context-menu-one">
+                    <div class="icon-box">
+                        {% if item.type == "dir" %}
+                            <img class="fs-icon" src="/static/image/folder2.png">
+                        {% elif xutils.is_img_file(item.path) %}
+                            <img class="x-photo" src="/data/files/{{quote(item.path)}}?mode=thumbnail" 
+                                data-src="/data/files/{{quote(item.path)}}" loading="lazy">
+                        {% elif xutils.is_text_file(item.path) %}
+                            <img class="fs-icon" src="/static/image/icon_txt.png">
+                        {% else %}
+                            <img class="fs-icon" src="/static/image/file2.png">
+                        {% end %}
+                    </div>
+                </div>
+            {% end %}
+        {% end %}
+    </div>
+</div>
 
-{% block body_right %}
-    {% include fs/component/fs_sidebar.html %}
-{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_grid.html` & `xnote-web-0.1.1/handlers/fs/page/fs_grid.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_index.html` & `xnote-web-0.1.1/handlers/fs/page/fs_index.html`

 * *Ordering differences only*

 * *Files 22% similar despite different names*

```diff
@@ -1,110 +1,110 @@
-{% extends base %}
-
-{% block body_left %}
-
-{% init action = "" %}
-{% init path = "" %}
-{% init index_size = 0 %}
-{% init show_index_dirs = True %}
-{% init files = [] %}
-{% init page = 1 %}
-{% init page_max = 1 %}
-{% init page_url = "" %}
-
-<div class="card">
-    <div class="card-title">
-        <span>文件索引</span>
-
-        <div class="float-right">
-            {% include common/button/back_button.html %}
-        </div>
-    </div>
-</div>
-
-<div class="card">
-    <p>索引数量: {{index_size}}</p>
-
-    {% if action == "reindex" %}
-        <p>重建索引耗时: {{"%.2f"%cost}}秒</p>
-    {% end %}
-    
-    <div class="row">
-        <input type="hidden" name="action" value="reindex">
-        {% if path != "" %}
-        <div class="row">
-            <label>文件路径</label>
-            <input type="path" name="path" value="{{path}}">
-        </div>
-        {% end %}
-        <div class="row">
-            <button class="rebuild-index-btn">重建索引</button>
-        </div>
-    </div>
-</div>
-
-<div class="card">
-    <table class="table">
-        <tr>
-            <th>文件编号</th>
-            <th>文件路径</th>
-            <th>用户</th>
-            <th>上传时间</th>
-            <th>文件大小</th>
-        </tr>
-        {% for file_info in files %}
-        <tr class="hover-tr">
-            <td>{{file_info.id}}</td>
-            <td>{{file_info.fpath}}</td>
-            <td>{{file_info.user_id}}</td>
-            <td>{{file_info.ctime}}</td>
-            <td>{{file_info.fsize_str}}</td>
-        </tr>
-        {% end %}
-    </table>
-</div>
-
-<div class="card">
-    {% include common/pagination.html %}
-</div>
-
-
-<script type="text/javascript">
-
-$(".rebuild-index-btn").click(function () {
-    var rebuildParams = {
-        action: "reindex",
-        path: xnote.getUrlParam("path"),
-        is_ajax: true
-    };
-    xnote.http.post("/fs_index", rebuildParams, function (resp) {
-        if (resp.code == "success") {
-            xnote.toast("重建中...");
-        } else {
-            xnote.alert(resp.message);
-        }
-    });
-});
-
-$(function () {
-    $("body").on("click", ".update-index-dirs", function (e) {
-        var index_config = $("[name=index_config]").val();
-        var params = {"index_config": index_config};
-        xnote.http.post("?action=config", params, function (e) {
-            xnote.toast("更新成功");
-            setTimeout(function () {
-                window.location.reload();                    
-            }, 500);
-        });
-    });
-
-    $(".rebuild-index-btn").click(function (e) {
-
-    });
-});
-</script>
-{% end %}
-
-
-{% block body_right %}
-    {% include fs/component/fs_sidebar.html %}
+{% extends base %}
+
+{% block body_left %}
+
+{% init action = "" %}
+{% init path = "" %}
+{% init index_size = 0 %}
+{% init show_index_dirs = True %}
+{% init files = [] %}
+{% init page = 1 %}
+{% init page_max = 1 %}
+{% init page_url = "" %}
+
+<div class="card">
+    <div class="card-title">
+        <span>文件索引</span>
+
+        <div class="float-right">
+            {% include common/button/back_button.html %}
+        </div>
+    </div>
+</div>
+
+<div class="card">
+    <p>索引数量: {{index_size}}</p>
+
+    {% if action == "reindex" %}
+        <p>重建索引耗时: {{"%.2f"%cost}}秒</p>
+    {% end %}
+    
+    <div class="row">
+        <input type="hidden" name="action" value="reindex">
+        {% if path != "" %}
+        <div class="row">
+            <label>文件路径</label>
+            <input type="path" name="path" value="{{path}}">
+        </div>
+        {% end %}
+        <div class="row">
+            <button class="rebuild-index-btn">重建索引</button>
+        </div>
+    </div>
+</div>
+
+<div class="card">
+    <table class="table">
+        <tr>
+            <th>文件编号</th>
+            <th>文件路径</th>
+            <th>用户</th>
+            <th>上传时间</th>
+            <th>文件大小</th>
+        </tr>
+        {% for file_info in files %}
+        <tr class="hover-tr">
+            <td>{{file_info.id}}</td>
+            <td>{{file_info.fpath}}</td>
+            <td>{{file_info.user_id}}</td>
+            <td>{{file_info.ctime}}</td>
+            <td>{{file_info.fsize_str}}</td>
+        </tr>
+        {% end %}
+    </table>
+</div>
+
+<div class="card">
+    {% include common/pagination.html %}
+</div>
+
+
+<script type="text/javascript">
+
+$(".rebuild-index-btn").click(function () {
+    var rebuildParams = {
+        action: "reindex",
+        path: xnote.getUrlParam("path"),
+        is_ajax: true
+    };
+    xnote.http.post("/fs_index", rebuildParams, function (resp) {
+        if (resp.code == "success") {
+            xnote.toast("重建中...");
+        } else {
+            xnote.alert(resp.message);
+        }
+    });
+});
+
+$(function () {
+    $("body").on("click", ".update-index-dirs", function (e) {
+        var index_config = $("[name=index_config]").val();
+        var params = {"index_config": index_config};
+        xnote.http.post("?action=config", params, function (e) {
+            xnote.toast("更新成功");
+            setTimeout(function () {
+                window.location.reload();                    
+            }, 500);
+        });
+    });
+
+    $(".rebuild-index-btn").click(function (e) {
+
+    });
+});
+</script>
+{% end %}
+
+
+{% block body_right %}
+    {% include fs/component/fs_sidebar.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_plugins.html` & `xnote-web-0.1.1/handlers/fs/page/fs_plugins.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_shell.html` & `xnote-web-0.1.1/handlers/fs/page/fs_shell.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_sidebar.html` & `xnote-web-0.1.1/handlers/fs/page/fs_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_text.html` & `xnote-web-0.1.1/handlers/fs/page/fs_text.html`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,208 +1,208 @@
-{% extends base %}
-
-<!-- 
-@since 2017/12/02
-@modified 2021/02/13 20:56:18
-@version 2.0.0
--->
-
-{% block head %}
-<style>
-    .contents-item .current {
-        color: red;
-    }
-</style>
-{% end %}
-
-{% block body %}
-
-{% init embed = False %}
-{% set path = xutils.get_argument("path") %}
-
-{% if not embed %}
-<div class="card">
-    {% init fs_title = "文本阅读" %}
-    <h3 class="card-title btn-line-height">
-        <span>{{fs_title}}</span>
-        
-        <div class="float-right">
-            <a class="btn btn-default contents-btn">目录</a>
-            <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}">编辑</a>
-            {% include common/button/back_button.html %}
-        </div>
-    </h3>
-</div>
-{% end %}
-
-<div class="card">
-    <!-- header -->
-    {% if not embed %}
-    {% include mod_fs_path.html %}
-    {% end %}
-
-    <!-- 目录 -->
-    <div class="book-contents">
-    </div>
-
-    <!-- 文本内容 -->
-    <div class="book-text"></div>
-
-    <!-- footer -->
-    <div class="reader-footer align-center">
-        <button class="backward-btn">上一页</button>
-        <button class="contents-btn">目录</button>
-        <button onclick="xnoteRefreshTxtInfo()">刷新</button>
-        <button class="forward-btn">下一页</button>
-    </div>
-</div>
-
-<script type="text/template" id="book-contents-tpl">
-{{!each contents item}}
-    <div class="contents-item">
-        <a data-offset="{{!item.offset}}" data-page="{{!$index+1}}" 
-            class="contents-link {{!if currentOffset == item.offset }}current{{!/if}}">
-            [{{!$index+1}}] {{! item.title }}
-        </a>
-    </div>
-{{!/each}}
-</script>
-
-<script type="text/javascript">
-$(function () {
-    var path = xnote.getUrlParam("path");
-    var params = {
-        method: "contents",
-        path: path
-    };
-    var state = {
-        currentPage: 1,
-        offsetMap: {},
-    };
-
-    function hideContents() {
-        $(".book-contents").hide();
-        $(".book-text").show();
-    }
-
-    function showContents() {
-        $(".book-contents").show();
-        $(".book-text").hide();
-        readContents();
-    }
-
-    function escapeText(text) {
-        text = text.replace(/\</gi, "&lt;");
-        text = text.replace(/\>/gi, "&gt;");
-        text = text.replace(/ /gi, "&nbsp;");
-        text = text.replace(/\n/gi, "<br>");
-        return text
-    }
-
-    function readPage(page) {
-        var offset = state.offsetMap[page];
-        if (offset == undefined) {
-            xnote.alert("没有更多内容了!");
-            return;
-        }
-        var params = {
-            method: "read_page",
-            offset: offset,
-            path: xnote.getUrlParam("path"),
-        };
-        xnote.http.get("/fs_text", params, function (resp) {
-            if (resp.code != "success") {
-                xnote.alert(resp.message);
-            } else {
-                var text = resp.data;
-                text = escapeText(text);
-                $(".book-text").html(text);
-                hideContents();
-                state.currentPage = page - 0;
-                // 滚动到顶部
-                window.scroll(0, 0);
-            }
-        });
-    }
-
-    // 读取目录
-    function readContents() {
-        xnote.http.get("/fs_text", params, function (resp) {
-            console.log(resp);
-            if (resp.code != "success") {
-                xnote.alert(resp.message);
-            } else {
-                var bookmark = resp.data;
-                var html = $("#book-contents-tpl").renderTemplate({
-                    contents: bookmark.contents,
-                    currentOffset: bookmark.current_offset,
-                });
-
-                var contents = bookmark.contents;
-                // console.log("html", html);
-                for (var i = 0; i < contents.length; i++) {
-                    var item = contents[i];
-                    state.offsetMap[i+1] = item.offset;
-                }
-
-                $(".book-contents").html(html);
-            }
-        });
-    }
-
-    // 点击目录链接
-    $("body").on("click", ".contents-link", function (e) {
-        readPage($(e.target).attr("data-page"));
-    });
-
-    // 点击目录
-    $(".contents-btn").click(function (e) {
-        showContents();
-    })
-
-    // 点击下一页
-    $(".forward-btn").click(function (e) {
-        readPage(state.currentPage+1);
-    });
-
-    // 点击上一页
-    $(".backward-btn").click(function (e) {
-        if (state.currentPage == 1) {
-            xnote.alert("已经是第一页了!");
-            return;
-        }
-        readPage(state.currentPage-1);
-    });
-
-    // 快捷键
-    $(window).on("keyup", function (event) {
-        var keyCode = event.keyCode;
-        console.log(keyCode);
-        switch (keyCode) {
-          // shift
-          case 16: return;
-          case 39: readPage(state.currentPage+1); break;
-          case 37: readPage(state.currentPage-1); break;
-          case 27: showContents(); break; // ESC
-        }
-    });
-
-    // 初始化
-    showContents();
-});
-
-window.xnoteRefreshTxtInfo = function () {
-    var path = xnote.getUrlParam("path");
-    var request = {};
-    request.path = path;
-    xnote.http.get("?method=refresh", request, function (resp) {
-        if (resp.success) {
-            xnote.toast("刷新成功");
-            window.location.reload();
-        } else {
-            xnote.toast(resp.message);
-        }
-    });
-}
-</script>
-
+{% extends base %}
+
+<!-- 
+@since 2017/12/02
+@modified 2021/02/13 20:56:18
+@version 2.0.0
+-->
+
+{% block head %}
+<style>
+    .contents-item .current {
+        color: red;
+    }
+</style>
+{% end %}
+
+{% block body %}
+
+{% init embed = False %}
+{% set path = xutils.get_argument("path") %}
+
+{% if not embed %}
+<div class="card">
+    {% init fs_title = "文本阅读" %}
+    <h3 class="card-title btn-line-height">
+        <span>{{fs_title}}</span>
+        
+        <div class="float-right">
+            <a class="btn btn-default contents-btn">目录</a>
+            <a class="btn btn-default" href="{{_server_home}}/code/edit?path={{path}}">编辑</a>
+            {% include common/button/back_button.html %}
+        </div>
+    </h3>
+</div>
+{% end %}
+
+<div class="card">
+    <!-- header -->
+    {% if not embed %}
+    {% include mod_fs_path.html %}
+    {% end %}
+
+    <!-- 目录 -->
+    <div class="book-contents">
+    </div>
+
+    <!-- 文本内容 -->
+    <div class="book-text"></div>
+
+    <!-- footer -->
+    <div class="reader-footer align-center">
+        <button class="backward-btn">上一页</button>
+        <button class="contents-btn">目录</button>
+        <button onclick="xnoteRefreshTxtInfo()">刷新</button>
+        <button class="forward-btn">下一页</button>
+    </div>
+</div>
+
+<script type="text/template" id="book-contents-tpl">
+{{!each contents item}}
+    <div class="contents-item">
+        <a data-offset="{{!item.offset}}" data-page="{{!$index+1}}" 
+            class="contents-link {{!if currentOffset == item.offset }}current{{!/if}}">
+            [{{!$index+1}}] {{! item.title }}
+        </a>
+    </div>
+{{!/each}}
+</script>
+
+<script type="text/javascript">
+$(function () {
+    var path = xnote.getUrlParam("path");
+    var params = {
+        method: "contents",
+        path: path
+    };
+    var state = {
+        currentPage: 1,
+        offsetMap: {},
+    };
+
+    function hideContents() {
+        $(".book-contents").hide();
+        $(".book-text").show();
+    }
+
+    function showContents() {
+        $(".book-contents").show();
+        $(".book-text").hide();
+        readContents();
+    }
+
+    function escapeText(text) {
+        text = text.replace(/\</gi, "&lt;");
+        text = text.replace(/\>/gi, "&gt;");
+        text = text.replace(/ /gi, "&nbsp;");
+        text = text.replace(/\n/gi, "<br>");
+        return text
+    }
+
+    function readPage(page) {
+        var offset = state.offsetMap[page];
+        if (offset == undefined) {
+            xnote.alert("没有更多内容了!");
+            return;
+        }
+        var params = {
+            method: "read_page",
+            offset: offset,
+            path: xnote.getUrlParam("path"),
+        };
+        xnote.http.get("/fs_text", params, function (resp) {
+            if (resp.code != "success") {
+                xnote.alert(resp.message);
+            } else {
+                var text = resp.data;
+                text = escapeText(text);
+                $(".book-text").html(text);
+                hideContents();
+                state.currentPage = page - 0;
+                // 滚动到顶部
+                window.scroll(0, 0);
+            }
+        });
+    }
+
+    // 读取目录
+    function readContents() {
+        xnote.http.get("/fs_text", params, function (resp) {
+            console.log(resp);
+            if (resp.code != "success") {
+                xnote.alert(resp.message);
+            } else {
+                var bookmark = resp.data;
+                var html = $("#book-contents-tpl").renderTemplate({
+                    contents: bookmark.contents,
+                    currentOffset: bookmark.current_offset,
+                });
+
+                var contents = bookmark.contents;
+                // console.log("html", html);
+                for (var i = 0; i < contents.length; i++) {
+                    var item = contents[i];
+                    state.offsetMap[i+1] = item.offset;
+                }
+
+                $(".book-contents").html(html);
+            }
+        });
+    }
+
+    // 点击目录链接
+    $("body").on("click", ".contents-link", function (e) {
+        readPage($(e.target).attr("data-page"));
+    });
+
+    // 点击目录
+    $(".contents-btn").click(function (e) {
+        showContents();
+    })
+
+    // 点击下一页
+    $(".forward-btn").click(function (e) {
+        readPage(state.currentPage+1);
+    });
+
+    // 点击上一页
+    $(".backward-btn").click(function (e) {
+        if (state.currentPage == 1) {
+            xnote.alert("已经是第一页了!");
+            return;
+        }
+        readPage(state.currentPage-1);
+    });
+
+    // 快捷键
+    $(window).on("keyup", function (event) {
+        var keyCode = event.keyCode;
+        console.log(keyCode);
+        switch (keyCode) {
+          // shift
+          case 16: return;
+          case 39: readPage(state.currentPage+1); break;
+          case 37: readPage(state.currentPage-1); break;
+          case 27: showContents(); break; // ESC
+        }
+    });
+
+    // 初始化
+    showContents();
+});
+
+window.xnoteRefreshTxtInfo = function () {
+    var path = xnote.getUrlParam("path");
+    var request = {};
+    request.path = path;
+    xnote.http.get("?method=refresh", request, function (resp) {
+        if (resp.success) {
+            xnote.toast("刷新成功");
+            window.location.reload();
+        } else {
+            xnote.toast(resp.message);
+        }
+    });
+}
+</script>
+
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_text_v1.html` & `xnote-web-0.1.1/handlers/fs/page/fs_text_v1.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/fs/page/fs_upload.html` & `xnote-web-0.1.1/handlers/fs/page/fs_upload.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/index.html` & `xnote-web-0.1.1/handlers/index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/ajax/message_ajax.html` & `xnote-web-0.1.1/handlers/message/ajax/message_ajax.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/ajax/message_tag_ajax.html` & `xnote-web-0.1.1/handlers/message/ajax/message_tag_ajax.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/card/deleted_msg_left.html` & `xnote-web-0.1.1/handlers/message/card/deleted_msg_left.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/card/deleted_msg_left_new.html` & `xnote-web-0.1.1/handlers/message/card/deleted_msg_left_new.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/card/deleted_msg_right.html` & `xnote-web-0.1.1/handlers/message/card/deleted_msg_right.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/card/msg_edit_card.html` & `xnote-web-0.1.1/handlers/message/card/msg_edit_card.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_date_right.html` & `xnote-web-0.1.1/handlers/message/component/message_date_right.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_edit.html` & `xnote-web-0.1.1/handlers/message/component/message_edit.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_event.html` & `xnote-web-0.1.1/handlers/message/component/message_event.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_input.html` & `xnote-web-0.1.1/handlers/message/component/message_input.html`

 * *Ordering differences only*

 * *Files 20% similar despite different names*

```diff
@@ -1,76 +1,76 @@
-{% init message_placeholder = "记录发生的事情/产生的想法" %}
-{% init show_tag_btn = True %}
-{% init show_attachment_btn = True %}
-{% init default_content = "" %}
-{% init filter_default_content = xutils.get_func_by_name("message.filter_default_content") %}
-{% init create_tag = tag %}
-
-<div class="message-input-box card">
-    <textarea class="col-md-12 input-box" rows=3 autoHeight=true 
-        placeholder="{{message_placeholder}}">{{filter_default_content(default_content)}}</textarea>
-    <input type="file" id="filePicker" class="hide" multiple/>
-
-    <div class="col-md-12 btn-line-height">
-        {% if show_tag_btn %}
-            <!-- <input type="button" name="" class="send-button btn btn-default select-topic-btn" value="#标签" @click=""> -->
-            <input type="button" class="send-button btn btn-default"
-                onclick="xnote.action.message.showTopicDialog(this);" value="#标签">
-        {% end %}
-
-        {% if show_attachment_btn %}
-            <input type="button" id="filePickerBtn" class="send-button btn btn-default" 
-                onclick="xnote.action.message.upload(this);"
-                value="添加附件"/>
-        {% end %}
-        
-        <input type="button" name="" class="send-button btn create-btn" value="创建">
-    </div>
-
-</div>
-
-<!-- 选择话题组件 -->
-{% include message/component/select_topic_dialog.html %}
-
-<script type="text/javascript">
-$(function () {
-    function onFileUploaded(event) {
-        var inputText = event.target;
-        var oldText = $(".input-box").val();
-        var newText = oldText + "\n" + inputText + "\n";
-        $(".input-box").val(newText);
-    }
-
-    function onTopicSelected(event) {
-        xnote.closeAllDialog();
-        var topic = event.target;
-        var oldText = $(".input-box").val();
-        $(".input-box").val(topic + " " + oldText);
-    }
-
-
-    $(".create-btn").click(function () {
-        var content = $(".input-box").val();
-        var date = getUrlParam("date");
-        var params = {content:content, tag: "{{create_tag}}", date: date};
-        xnote.http.post("/message/save", 
-            params,
-            function (respText) {
-                var data = respText;
-                if (data.code != "success") {
-                    xnote.alert(data.message);
-                } else {
-                    $(".input-box").val("{{default_content}}");
-                    $(".input-box")[0].style.height = "52px";
-                    // 发布创建消息
-                    xnote.fire("message.created", "");
-                }
-        });
-    });
-         
-    $('textarea[autoHeight]').autoHeight();    
-
-    // 监听上传事件
-    xnote.on("message.upload", onFileUploaded);
-    xnote.on("message.topic.selected", onTopicSelected);
-})
+{% init message_placeholder = "记录发生的事情/产生的想法" %}
+{% init show_tag_btn = True %}
+{% init show_attachment_btn = True %}
+{% init default_content = "" %}
+{% init filter_default_content = xutils.get_func_by_name("message.filter_default_content") %}
+{% init create_tag = tag %}
+
+<div class="message-input-box card">
+    <textarea class="col-md-12 input-box" rows=3 autoHeight=true 
+        placeholder="{{message_placeholder}}">{{filter_default_content(default_content)}}</textarea>
+    <input type="file" id="filePicker" class="hide" multiple/>
+
+    <div class="col-md-12 btn-line-height">
+        {% if show_tag_btn %}
+            <!-- <input type="button" name="" class="send-button btn btn-default select-topic-btn" value="#标签" @click=""> -->
+            <input type="button" class="send-button btn btn-default"
+                onclick="xnote.action.message.showTopicDialog(this);" value="#标签">
+        {% end %}
+
+        {% if show_attachment_btn %}
+            <input type="button" id="filePickerBtn" class="send-button btn btn-default" 
+                onclick="xnote.action.message.upload(this);"
+                value="添加附件"/>
+        {% end %}
+        
+        <input type="button" name="" class="send-button btn create-btn" value="创建">
+    </div>
+
+</div>
+
+<!-- 选择话题组件 -->
+{% include message/component/select_topic_dialog.html %}
+
+<script type="text/javascript">
+$(function () {
+    function onFileUploaded(event) {
+        var inputText = event.target;
+        var oldText = $(".input-box").val();
+        var newText = oldText + "\n" + inputText + "\n";
+        $(".input-box").val(newText);
+    }
+
+    function onTopicSelected(event) {
+        xnote.closeAllDialog();
+        var topic = event.target;
+        var oldText = $(".input-box").val();
+        $(".input-box").val(topic + " " + oldText);
+    }
+
+
+    $(".create-btn").click(function () {
+        var content = $(".input-box").val();
+        var date = getUrlParam("date");
+        var params = {content:content, tag: "{{create_tag}}", date: date};
+        xnote.http.post("/message/save", 
+            params,
+            function (respText) {
+                var data = respText;
+                if (data.code != "success") {
+                    xnote.alert(data.message);
+                } else {
+                    $(".input-box").val("{{default_content}}");
+                    $(".input-box")[0].style.height = "52px";
+                    // 发布创建消息
+                    xnote.fire("message.created", "");
+                }
+        });
+    });
+         
+    $('textarea[autoHeight]').autoHeight();    
+
+    // 监听上传事件
+    xnote.on("message.upload", onFileUploaded);
+    xnote.on("message.topic.selected", onTopicSelected);
+})
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/message/component/message_keyword_info.html` & `xnote-web-0.1.1/handlers/message/component/message_keyword_info.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_list.html` & `xnote-web-0.1.1/static/js/plugin/plugin.form.js`

 * *Files 25% similar despite different names*

```diff
@@ -1,129 +1,114 @@
-00000000: 3c21 2d2d 20e9 9a8f e689 8be8 aeb0 e588  <!-- ...........
-00000010: 97e8 a1a8 202d 2d3e 0d0a 3c64 6976 2063  .... -->..<div c
-00000020: 6c61 7373 3d22 6d65 7373 6167 652d 6c69  lass="message-li
-00000030: 7374 223e 0d0a 0d0a 3c2f 6469 763e 0d0a  st">....</div>..
-00000040: 0d0a 3c73 6372 6970 7420 7479 7065 3d22  ..<script type="
-00000050: 7465 7874 2f6a 6176 6173 6372 6970 7422  text/javascript"
-00000060: 3e0d 0a28 6675 6e63 7469 6f6e 2028 2920  >..(function () 
-00000070: 7b0d 0a0d 0a20 2020 2076 6172 204c 4153  {....    var LAS
-00000080: 545f 4441 5445 3b0d 0a0d 0a20 2020 2066  T_DATE;....    f
-00000090: 756e 6374 696f 6e20 6765 7443 7572 7265  unction getCurre
-000000a0: 6e74 5061 6765 2829 207b 0d0a 2020 2020  ntPage() {..    
-000000b0: 2020 2020 7661 7220 7061 6765 203d 2067      var page = g
-000000c0: 6574 5572 6c50 6172 616d 2822 7061 6765  etUrlParam("page
-000000d0: 2229 3b0d 0a20 2020 2020 2020 2069 6620  ");..        if 
-000000e0: 2870 6167 6520 3d3d 2075 6e64 6566 696e  (page == undefin
-000000f0: 6564 2920 7b0d 0a20 2020 2020 2020 2020  ed) {..         
-00000100: 2020 2072 6574 7572 6e20 313b 0d0a 2020     return 1;..  
-00000110: 2020 2020 2020 7d20 656c 7365 207b 0d0a        } else {..
-00000120: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00000130: 726e 2070 6172 7365 496e 7428 7061 6765  rn parseInt(page
-00000140: 293b 0d0a 2020 2020 2020 2020 7d0d 0a20  );..        }.. 
-00000150: 2020 207d 0d0a 0d0a 2020 2020 6675 6e63     }....    func
-00000160: 7469 6f6e 2072 6566 7265 7368 4d65 7373  tion refreshMess
-00000170: 6167 654c 6973 7428 6461 7465 2920 7b0d  ageList(date) {.
-00000180: 0a20 2020 2020 2020 204c 4153 545f 4441  .        LAST_DA
-00000190: 5445 203d 2064 6174 653b 0d0a 2020 2020  TE = date;..    
-000001a0: 2020 2020 7661 7220 7061 7261 6d73 203d      var params =
-000001b0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-000001c0: 6461 7465 3a20 6461 7465 2c0d 0a20 2020  date: date,..   
-000001d0: 2020 2020 2020 2020 2070 6167 653a 2067           page: g
-000001e0: 6574 4375 7272 656e 7450 6167 6528 290d  etCurrentPage().
-000001f0: 0a20 2020 2020 2020 207d 3b0d 0a20 2020  .        };..   
-00000200: 2020 2020 2070 6172 616d 732e 6669 6c74       params.filt
-00000210: 6572 4b65 7920 3d20 786e 6f74 652e 6765  erKey = xnote.ge
-00000220: 7455 726c 5061 7261 6d28 2266 696c 7465  tUrlParam("filte
-00000230: 724b 6579 2229 3b0d 0a0d 0a20 2020 2020  rKey");....     
-00000240: 2020 2078 6e6f 7465 2e68 7474 702e 6765     xnote.http.ge
-00000250: 7428 222f 6d65 7373 6167 652f 6461 7465  t("/message/date
-00000260: 222c 2070 6172 616d 732c 6675 6e63 7469  ", params,functi
-00000270: 6f6e 2028 7265 7370 5465 7874 2920 7b0d  on (respText) {.
-00000280: 0a20 2020 2020 2020 2020 2020 2024 2822  .            $("
-00000290: 2e6d 6573 7361 6765 2d6c 6973 7422 292e  .message-list").
-000002a0: 6874 6d6c 2872 6573 7054 6578 7429 3b0d  html(respText);.
-000002b0: 0a20 2020 2020 2020 207d 293b 0d0a 2020  .        });..  
-000002c0: 2020 7d3b 0d0a 0d0a 2020 2020 6675 6e63    };....    func
-000002d0: 7469 6f6e 2064 6f52 6566 7265 7368 4d65  tion doRefreshMe
-000002e0: 7373 6167 654c 6973 7428 7061 7261 6d73  ssageList(params
-000002f0: 2920 7b0d 0a20 2020 2020 2020 2078 6e6f  ) {..        xno
-00000300: 7465 2e61 7373 6572 7428 7479 7065 6f66  te.assert(typeof
-00000310: 2870 6172 616d 7329 203d 3d20 226f 626a  (params) == "obj
-00000320: 6563 7422 2c20 2265 7870 6563 7420 7061  ect", "expect pa
-00000330: 7261 6d73 2074 6f20 6265 206f 626a 6563  rams to be objec
-00000340: 7422 293b 0d0a 2020 2020 2020 2020 786e  t");..        xn
-00000350: 6f74 652e 6173 7365 7274 2870 6172 616d  ote.assert(param
-00000360: 732e 7061 6765 2c20 2270 6172 616d 732e  s.page, "params.
-00000370: 7061 6765 2065 7870 6563 7465 6422 293b  page expected");
-00000380: 0d0a 2020 2020 2020 2020 786e 6f74 652e  ..        xnote.
-00000390: 6173 7365 7274 2870 6172 616d 732e 7461  assert(params.ta
-000003a0: 672c 2022 7061 7261 6d73 2e74 6167 2065  g, "params.tag e
-000003b0: 7870 6563 7465 6422 293b 0d0a 0d0a 2020  xpected");....  
-000003c0: 2020 2020 2020 7061 7261 6d73 2e66 6f72        params.for
-000003d0: 6d61 7420 3d20 2268 746d 6c22 3b0d 0a20  mat = "html";.. 
-000003e0: 2020 2020 2020 2070 6172 616d 732e 6469         params.di
-000003f0: 7370 6c61 7954 6167 203d 2067 6574 5572  splayTag = getUr
-00000400: 6c50 6172 616d 2822 6469 7370 6c61 7954  lParam("displayT
-00000410: 6167 222c 2022 2229 3b0d 0a0d 0a20 2020  ag", "");....   
-00000420: 2020 2020 2078 6e6f 7465 2e68 7474 702e       xnote.http.
-00000430: 6765 7428 222f 6d65 7373 6167 652f 6c69  get("/message/li
-00000440: 7374 222c 2070 6172 616d 732c 2066 756e  st", params, fun
-00000450: 6374 696f 6e20 2872 6573 7029 207b 0d0a  ction (resp) {..
-00000460: 2020 2020 2020 2020 2020 2020 2f2f 2063              // c
-00000470: 6f6e 736f 6c65 2e6c 6f67 2872 6573 7029  onsole.log(resp)
-00000480: 3b0d 0a20 2020 2020 2020 2020 2020 2024  ;..            $
-00000490: 2822 2e6d 6573 7361 6765 2d6c 6973 7422  (".message-list"
-000004a0: 292e 6874 6d6c 2872 6573 7029 3b0d 0a20  ).html(resp);.. 
-000004b0: 2020 2020 2020 207d 293b 0d0a 2020 2020         });..    
-000004c0: 7d0d 0a0d 0a20 2020 2066 756e 6374 696f  }....    functio
-000004d0: 6e20 6f6e 4d65 7373 6167 6552 6563 6569  n onMessageRecei
-000004e0: 7665 6428 6576 656e 7429 207b 0d0a 2020  ved(event) {..  
-000004f0: 2020 2020 2020 7661 7220 6461 7461 203d        var data =
-00000500: 2065 7665 6e74 2e64 6174 613b 0d0a 2020   event.data;..  
-00000510: 2020 2020 2020 7472 7920 7b0d 0a20 2020        try {..   
-00000520: 2020 2020 2020 2020 2076 6172 206d 7367           var msg
-00000530: 203d 204a 534f 4e2e 7061 7273 6528 6461   = JSON.parse(da
-00000540: 7461 293b 0d0a 2020 2020 2020 2020 2020  ta);..          
-00000550: 2020 6966 2028 6d73 672e 7479 7065 203d    if (msg.type =
-00000560: 3d20 226d 6573 7361 6765 2e75 7064 6174  = "message.updat
-00000570: 6564 2229 207b 0d0a 2020 2020 2020 2020  ed") {..        
-00000580: 2020 2020 2020 2020 2f2f 20e4 bc98 e585          // .....
-00000590: 88e8 afbb e58f 96e6 89a9 e5b1 95e5 87bd  ................
-000005a0: e695 b00d 0a20 2020 2020 2020 2020 2020  .....           
-000005b0: 2020 2020 2076 6172 2072 6566 7265 7368       var refresh
-000005c0: 4578 7446 756e 6320 3d20 786e 6f74 652e  ExtFunc = xnote.
-000005d0: 6765 7445 7874 4675 6e63 2822 6d65 7373  getExtFunc("mess
-000005e0: 6167 652e 7265 6672 6573 684d 6573 7361  age.refreshMessa
-000005f0: 6765 4c69 7374 2229 3b0d 0a20 2020 2020  geList");..     
-00000600: 2020 2020 2020 2020 2020 2069 6620 2872             if (r
-00000610: 6566 7265 7368 4578 7446 756e 6320 213d  efreshExtFunc !=
-00000620: 2075 6e64 6566 696e 6564 2920 7b0d 0a20   undefined) {.. 
-00000630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000640: 2020 2072 6566 7265 7368 4578 7446 756e     refreshExtFun
-00000650: 6328 4c41 5354 5f44 4154 4529 3b0d 0a20  c(LAST_DATE);.. 
-00000660: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00000670: 2065 6c73 6520 7b0d 0a20 2020 2020 2020   else {..       
-00000680: 2020 2020 2020 2020 2020 2020 2072 6566               ref
-00000690: 7265 7368 4d65 7373 6167 654c 6973 7428  reshMessageList(
-000006a0: 4c41 5354 5f44 4154 4529 3b0d 0a20 2020  LAST_DATE);..   
-000006b0: 2020 2020 2020 2020 2020 2020 207d 0d0a               }..
-000006c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000006d0: 2020 786e 6f74 652e 636c 6f73 6541 6c6c    xnote.closeAll
-000006e0: 4469 616c 6f67 2829 3b0d 0a20 2020 2020  Dialog();..     
-000006f0: 2020 2020 2020 207d 0d0a 2020 2020 2020         }..      
-00000700: 2020 7d20 6361 7463 6820 2865 2920 7b0d    } catch (e) {.
-00000710: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00000720: 736f 6c65 2e65 7272 6f72 2822 7061 7273  sole.error("pars
-00000730: 6520 7769 6e64 6f77 206d 6573 7361 6765  e window message
-00000740: 2066 6169 6c65 6422 2c20 6576 656e 742c   failed", event,
-00000750: 2065 293b 0d0a 2020 2020 2020 2020 7d0d   e);..        }.
-00000760: 0a20 2020 207d 0d0a 0d0a 2020 2020 2f2f  .    }....    //
-00000770: 20e6 b3a8 e586 8ce5 88b0 7769 6e64 6f77   .........window
-00000780: e5af b9e8 b1a1 e4b8 8a0d 0a20 2020 2077  ...........    w
-00000790: 696e 646f 772e 7265 6672 6573 684d 6573  indow.refreshMes
-000007a0: 7361 6765 4c69 7374 203d 2072 6566 7265  sageList = refre
-000007b0: 7368 4d65 7373 6167 654c 6973 743b 0d0a  shMessageList;..
-000007c0: 2020 2020 7769 6e64 6f77 2e64 6f52 6566      window.doRef
-000007d0: 7265 7368 4d65 7373 6167 654c 6973 7420  reshMessageList 
-000007e0: 3d20 646f 5265 6672 6573 684d 6573 7361  = doRefreshMessa
-000007f0: 6765 4c69 7374 3b0d 0a0d 0a7d 2928 293b  geList;....})();
-00000800: 0d0a 3c2f 7363 7269 7074 3e              ..</script>
+00000000: 2f2a 2a0d 0a20 2a20 e8a1 a8e5 8d95 e68f  /**.. * ........
+00000010: 92e4 bbb6 e79a 844a 53e8 849a e69c acef  .......JS.......
+00000020: bc8c e5be 85e7 a8b3 e5ae 9ae5 908e e590  ................
+00000030: afe7 94a8 0d0a 202a 2040 6175 7468 6f72  ...... * @author
+00000040: 2078 7570 696e 676d 616f 0d0a 202a 2040   xupingmao.. * @
+00000050: 7369 6e63 6520 3230 3231 2f30 392f 3034  since 2021/09/04
+00000060: 2032 333a 3536 3a34 340d 0a20 2a20 406d   23:56:44.. * @m
+00000070: 6f64 6966 6965 6420 3230 3231 2f30 392f  odified 2021/09/
+00000080: 3035 2030 303a 3033 3a34 340d 0a20 2a20  05 00:03:44.. * 
+00000090: 4066 696c 656e 616d 6520 706c 7567 696e  @filename plugin
+000000a0: 2e66 6f72 6d2e 6a73 0d0a 202a 2f0d 0a0d  .form.js.. */...
+000000b0: 0a24 2866 756e 6374 696f 6e28 297b 0d0a  .$(function(){..
+000000c0: 2020 2020 2f2f 20e7 bc96 e8be 91e4 ba8b      // .........
+000000d0: e4bb b6e5 a484 e790 860d 0a20 2020 2024  ...........    $
+000000e0: 2822 2e78 2d66 6f72 6d2d 6564 6974 2d62  (".x-form-edit-b
+000000f0: 746e 2229 2e63 6c69 636b 2866 756e 6374  tn").click(funct
+00000100: 696f 6e20 2865 7665 6e74 2920 7b0d 0a20  ion (event) {.. 
+00000110: 2020 2020 2020 2076 6172 2072 6f77 4b65         var rowKe
+00000120: 7920 203d 2024 2865 7665 6e74 2e74 6172  y  = $(event.tar
+00000130: 6765 7429 2e61 7474 7228 2264 6174 612d  get).attr("data-
+00000140: 6b65 7922 293b 0d0a 2020 2020 2020 2020  key");..        
+00000150: 242e 6765 7428 223f 6163 7469 6f6e 3d67  $.get("?action=g
+00000160: 6574 5f74 656d 706c 6174 6522 2c20 7b6b  et_template", {k
+00000170: 6579 3a20 726f 774b 6579 7d2c 2066 756e  ey: rowKey}, fun
+00000180: 6374 696f 6e28 7265 7370 2920 7b0d 0a20  ction(resp) {.. 
+00000190: 2020 2020 2020 2020 2020 2076 6172 2062             var b
+000001a0: 7574 746f 6e73 203d 205b 22e7 a1ae e8ae  uttons = [".....
+000001b0: a422 2c20 22e5 8f96 e6b6 8822 5d3b 0d0a  .", "......"];..
+000001c0: 2020 2020 2020 2020 2020 2020 7661 7220              var 
+000001d0: 6675 6e63 7469 6f6e 7320 3d20 5b66 756e  functions = [fun
+000001e0: 6374 696f 6e20 2869 6e64 6578 2c20 6c61  ction (index, la
+000001f0: 7965 726f 2920 7b0d 0a20 2020 2020 2020  yero) {..       
+00000200: 2020 2020 2020 2020 2076 6172 2063 6f6e           var con
+00000210: 7465 6e74 203d 2024 2822 5b6e 616d 653d  tent = $("[name=
+00000220: 636f 6e74 656e 745d 2229 2e76 616c 2829  content]").val()
+00000230: 3b0d 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00000240: 2020 2076 6172 2070 6172 616d 7320 3d20     var params = 
+00000250: 7b63 6f6e 7465 6e74 3a20 636f 6e74 656e  {content: conten
+00000260: 742c 206b 6579 3a20 726f 774b 6579 7d3b  t, key: rowKey};
+00000270: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00000280: 2020 242e 706f 7374 2822 3f61 6374 696f    $.post("?actio
+00000290: 6e3d 6564 6974 222c 2070 6172 616d 732c  n=edit", params,
+000002a0: 2066 756e 6374 696f 6e20 2872 6573 7029   function (resp)
+000002b0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
+000002c0: 2020 2020 2020 2020 6966 2028 7265 7370          if (resp
+000002d0: 2e63 6f64 6520 213d 2022 7375 6363 6573  .code != "succes
+000002e0: 7322 2920 7b0d 0a20 2020 2020 2020 2020  s") {..         
+000002f0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+00000300: 6e6f 7465 2e61 6c65 7274 2872 6573 702e  note.alert(resp.
+00000310: 6d65 7373 6167 6529 3b0d 0a20 2020 2020  message);..     
+00000320: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00000330: 2065 6c73 6520 7b0d 0a20 2020 2020 2020   else {..       
+00000340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000350: 2077 696e 646f 772e 6c6f 6361 7469 6f6e   window.location
+00000360: 2e72 656c 6f61 6428 293b 0d0a 2020 2020  .reload();..    
+00000370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000380: 7d0d 0a20 2020 2020 2020 2020 2020 2020  }..             
+00000390: 2020 207d 292e 6661 696c 2866 756e 6374     }).fail(funct
+000003a0: 696f 6e20 2865 2920 7b0d 0a20 2020 2020  ion (e) {..     
+000003b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000003c0: 6f6e 736f 6c65 2e65 7272 6f72 2865 293b  onsole.error(e);
+000003d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000003e0: 2020 2020 2020 786e 6f74 652e 616c 6572        xnote.aler
+000003f0: 7428 22e8 afb7 e6b1 82e7 bc96 e8be 91e6  t(".............
+00000400: 8ea5 e58f a3e5 a4b1 e8b4 a522 293b 0d0a  ...........");..
+00000410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000420: 7d29 3b0d 0a20 2020 2020 2020 2020 2020  });..           
+00000430: 207d 5d3b 0d0a 2020 2020 2020 2020 2020   }];..          
+00000440: 2020 786e 6f74 652e 7368 6f77 4469 616c    xnote.showDial
+00000450: 6f67 2822 e7bc 96e8 be91 e8a1 8c22 2c20  og(".........", 
+00000460: 7265 7370 2c20 6275 7474 6f6e 732c 2066  resp, buttons, f
+00000470: 756e 6374 696f 6e73 293b 0d0a 2020 2020  unctions);..    
+00000480: 2020 2020 7d29 3b0d 0a20 2020 207d 293b      });..    });
+00000490: 0d0a 0d0a 2020 2020 2f2f 20e5 88a0 e999  ....    // .....
+000004a0: a4e4 ba8b e4bb b6e5 a484 e790 860d 0a20  ............... 
+000004b0: 2020 2024 2822 2e78 2d66 6f72 6d2d 6465     $(".x-form-de
+000004c0: 6c65 7465 2d62 746e 2229 2e63 6c69 636b  lete-btn").click
+000004d0: 2866 756e 6374 696f 6e20 2865 7665 6e74  (function (event
+000004e0: 2920 7b0d 0a20 2020 2020 2020 2076 6172  ) {..        var
+000004f0: 2072 6f77 4b65 7920 3d20 2428 6576 656e   rowKey = $(even
+00000500: 742e 7461 7267 6574 292e 6174 7472 2822  t.target).attr("
+00000510: 6461 7461 2d6b 6579 2229 3b0d 0a20 2020  data-key");..   
+00000520: 2020 2020 2078 6e6f 7465 2e63 6f6e 6669       xnote.confi
+00000530: 726d 2822 e7a1 aee8 aea4 e588 a0e9 99a4  rm("............
+00000540: e8ae b0e5 bd95 3f22 2c20 6675 6e63 7469  ......?", functi
+00000550: 6f6e 2028 636f 6e66 6972 6d65 6429 207b  on (confirmed) {
+00000560: 2020 2020 0d0a 2020 2020 2020 2020 2020      ..          
+00000570: 2020 242e 706f 7374 2822 3f61 6374 696f    $.post("?actio
+00000580: 6e3d 6465 6c65 7465 222c 207b 6b65 793a  n=delete", {key:
+00000590: 2072 6f77 4b65 797d 2c20 6675 6e63 7469   rowKey}, functi
+000005a0: 6f6e 2028 7265 7370 2920 7b0d 0a20 2020  on (resp) {..   
+000005b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000005c0: 2872 6573 702e 636f 6465 2021 3d20 2273  (resp.code != "s
+000005d0: 7563 6365 7373 2229 207b 0d0a 2020 2020  uccess") {..    
+000005e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000005f0: 786e 6f74 652e 616c 6572 7428 7265 7370  xnote.alert(resp
+00000600: 2e6d 6573 7361 6765 293b 0d0a 2020 2020  .message);..    
+00000610: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00000620: 7365 207b 0d0a 2020 2020 2020 2020 2020  se {..          
+00000630: 2020 2020 2020 2020 2020 7769 6e64 6f77            window
+00000640: 2e6c 6f63 6174 696f 6e2e 7265 6c6f 6164  .location.reload
+00000650: 2829 3b0d 0a20 2020 2020 2020 2020 2020  ();..           
+00000660: 2020 2020 207d 0d0a 2020 2020 2020 2020       }..        
+00000670: 2020 2020 7d29 2e66 6169 6c28 6675 6e63      }).fail(func
+00000680: 7469 6f6e 2028 6529 207b 0d0a 2020 2020  tion (e) {..    
+00000690: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000006a0: 6f6c 652e 6572 726f 7228 6529 3b0d 0a20  ole.error(e);.. 
+000006b0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+000006c0: 6e6f 7465 2e61 6c65 7274 2822 e8af b7e6  note.alert("....
+000006d0: b182 e588 a0e9 99a4 e68e a5e5 8fa3 e5a4  ................
+000006e0: b1e8 b4a5 2229 3b0d 0a20 2020 2020 2020  ....");..       
+000006f0: 2020 2020 207d 293b 0d0a 2020 2020 2020       });..      
+00000700: 2020 7d29 3b0d 0a20 2020 207d 293b 0d0a    });..    });..
+00000710: 7d29 3b                                  });
```

### Comparing `xnote-web-0.1.0/handlers/message/component/message_sub_link.html` & `xnote-web-0.1.1/handlers/message/component/message_sub_link.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_tab.html` & `xnote-web-0.1.1/handlers/message/component/message_tab.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_tab_log.html` & `xnote-web-0.1.1/handlers/message/component/message_tab_log.html`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,20 +1,20 @@
-{% init show_tab = True %}
-
-{% if show_tab %}
-
-{% init message_stat = xutils.call("message.get_current_message_stat") %}
-
-<!-- 桌面版菜单 -->
-<div class="card x-tab-box message-tab" data-tab-key="tag" data-tab-default="{{tag}}">
-    <a class="x-tab" data-tab-value="log" href="{{_server_home}}/message?tag=log">
-        记事(<span class="log-count">{{message_stat.log_count}}</span>)
-    </a>
-    <a class="x-tab" data-tab-value="log.tags" href="{{_server_home}}/message?tag=log.tags&orderby=amount_desc">
-        标签(<span class="key-count">{{message_stat.key_count}}</span>)
-    </a>
-    <a class="x-tab" data-tab-value="log.date" href="{{_server_home}}/message/dairy?tag=log.date">日期</a>
-</div>
-
-{% include message/component/script/tab_script.html %}
-
-{% end %} <!-- show_tab end -->
+{% init show_tab = True %}
+
+{% if show_tab %}
+
+{% init message_stat = xutils.call("message.get_current_message_stat") %}
+
+<!-- 桌面版菜单 -->
+<div class="card x-tab-box message-tab" data-tab-key="tag" data-tab-default="{{tag}}">
+    <a class="x-tab" data-tab-value="log" href="{{_server_home}}/message?tag=log">
+        记事(<span class="log-count">{{message_stat.log_count}}</span>)
+    </a>
+    <a class="x-tab" data-tab-value="log.tags" href="{{_server_home}}/message?tag=log.tags&orderby=amount_desc">
+        标签(<span class="key-count">{{message_stat.key_count}}</span>)
+    </a>
+    <a class="x-tab" data-tab-value="log.date" href="{{_server_home}}/message/dairy?tag=log.date">日期</a>
+</div>
+
+{% include message/component/script/tab_script.html %}
+
+{% end %} <!-- show_tab end -->
```

### Comparing `xnote-web-0.1.0/handlers/message/component/message_tab_task.html` & `xnote-web-0.1.1/handlers/message/component/message_tab_task.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_tag_list.html` & `xnote-web-0.1.1/handlers/message/component/message_tag_list.html`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,23 +1,23 @@
-<!-- 标签列表 -->
-{% init tag_list = [] %}
-
-<div class="card">
-    {% if len(tag_list) == 0 %}
-        {% include common/text/empty_text.html %}
-    {% end %}
-
-    {% for tag_item in tag_list %}
-        <a href="{{ tag_item.url }}" class="list-link">
-            {% if tag_item.is_marked %}
-                <span class="task-tag">置顶</span>
-            {% end %}
-
-            <span>{{ tag_item.name }}</span>
-            
-            <div class="float-right">
-                <span class="book-size-span">{{ tag_item.amount }}</span>
-                <i class="fa fa-chevron-right"></i>
-            </div>
-        </a>
-    {% end %}
-</div>
+<!-- 标签列表 -->
+{% init tag_list = [] %}
+
+<div class="card">
+    {% if len(tag_list) == 0 %}
+        {% include common/text/empty_text.html %}
+    {% end %}
+
+    {% for tag_item in tag_list %}
+        <a href="{{ tag_item.url }}" class="list-link">
+            {% if tag_item.is_marked %}
+                <span class="task-tag">置顶</span>
+            {% end %}
+
+            <span>{{ tag_item.name }}</span>
+            
+            <div class="float-right">
+                <span class="book-size-span">{{ tag_item.amount }}</span>
+                <i class="fa fa-chevron-right"></i>
+            </div>
+        </a>
+    {% end %}
+</div>
```

### Comparing `xnote-web-0.1.0/handlers/message/component/message_title.html` & `xnote-web-0.1.1/handlers/message/component/message_title.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/message_todo_inner.html` & `xnote-web-0.1.1/handlers/message/component/message_todo_inner.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/right/tags.html` & `xnote-web-0.1.1/handlers/message/component/right/tags.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/script/tab_script.html` & `xnote-web-0.1.1/handlers/message/component/script/tab_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/select_topic_dialog.html` & `xnote-web-0.1.1/handlers/message/component/select_topic_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/show_topic_dialog.html` & `xnote-web-0.1.1/handlers/message/component/show_topic_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/component/tag/orderby_tab.html` & `xnote-web-0.1.1/handlers/message/component/tag/orderby_tab.html`

 * *Ordering differences only*

 * *Files 25% similar despite different names*

```diff
@@ -1,24 +1,24 @@
-{# <!--
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-04-17 11:52:32
-@LastEditors  : xupingmao
-@LastEditTime : 2022-05-28 18:38:43
-@FilePath     : /xnote/handlers/message/component/tag/orderby_tab.html
-@Description  : 描述
---> #}
-
-<div class="x-tab-box" data-tab-key="orderby" data-tab-default="amount_desc">
-    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=amount_desc" 
-        data-tab-value="amount_desc">热门</a>
-
-    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=visit&show_marked_tag=false" 
-        data-tab-value="visit">常用</a>
-
-    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=recent&show_marked_tag=false" 
-        data-tab-value="recent">最近</a>
-</div>
-
-<script type="text/javascript">
-    xnote.fire("init-default-value");
+{# <!--
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-04-17 11:52:32
+@LastEditors  : xupingmao
+@LastEditTime : 2022-05-28 18:38:43
+@FilePath     : /xnote/handlers/message/component/tag/orderby_tab.html
+@Description  : 描述
+--> #}
+
+<div class="x-tab-box" data-tab-key="orderby" data-tab-default="amount_desc">
+    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=amount_desc" 
+        data-tab-value="amount_desc">热门</a>
+
+    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=visit&show_marked_tag=false" 
+        data-tab-value="visit">常用</a>
+
+    <a class="x-tab" href="{{_server_home}}/message?tag=log.tags&orderby=recent&show_marked_tag=false" 
+        data-tab-value="recent">最近</a>
+</div>
+
+<script type="text/javascript">
+    xnote.fire("init-default-value");
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/message/dao.py` & `xnote-web-0.1.1/handlers/message/dao.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,1015 +1,1015 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2019/06/12 22:59:33
-# @modified 2022/04/11 23:29:47
-import xutils
-import re
-import logging
-import copy
-from xnote.core import xconfig, xmanager, xtables, xauth
-
-from xutils import dbutil, cacheutil, textutil, Storage, functions
-from xutils import dateutil
-from xutils.functions import del_dict_key
-from xnote.core.xtemplate import T
-from xutils.db.dbutil_helper import new_from_dict
-from xnote.service import TagBindService, TagTypeEnum
-from .message_model import is_task_tag
-from xutils import numutil
-
-VALID_MESSAGE_PREFIX_TUPLE = ("message:", "msg_key:", "msg_task:")
-# 带日期创建的最大重试次数
-CREATE_MAX_RETRY = 20
-MOBILE_LENGTH = 11
-VALID_TAG_SET = set(["task", "done", "log", "key"])
-
-_msg_db = dbutil.get_table("message")
-_msg_stat_cache = cacheutil.PrefixedCache("msgStat:")
-_msg_history_db = dbutil.get_table_v2("msg_history")
-
-_debug = False
-
-sys_comment_dict = {
-    "$mark_task_done$": T("标记任务完成"),
-    "$reopen_task$": T("重新开启任务"),
-}
-
-class MessageHistory:
-    def __init__(self):
-        self.msg_id = 0
-        self.msg_version = 0
-        self.user_id = 0
-        self.content = ""
-        self.ctime = dateutil.format_datetime()
-
-class MessageDO(Storage):
-    def __init__(self):
-        self._key = "" # kv的主键
-        self._id = "" # kv的ID
-
-        self.id = "" # 主键
-        self.tag = "" # tag标签 {task, done, log, key}
-        self.user = "" # 用户名
-        self.user_id = 0 # 用户ID
-        self.ip = ""
-        self.ref = None # 引用的id
-        self.ctime = xutils.format_datetime()  # 展示的创建时间
-        self.ctime0 = xutils.format_datetime() # 实际的创建时间
-        self.mtime = xutils.format_datetime()
-        self.date = xutils.format_date()
-        self.content = ""
-        self.comments = [] # 评论信息
-        self.version = 0
-        self.visit_cnt = 0
-        self.status = None # 老的结构
-        self.keywords = None
-        self.full_keywords = set()
-        self.no_tag = True
-        self.amount = 0 # keyword对象的数量
-        self.done_time = None # type: str|None
-        self.sort_value = ""
-
-    @classmethod
-    def from_dict(cls, dict_value: dict):
-        result = MessageDO()
-        result.update(dict_value)
-        result.id = result._key
-        if result.comments == None:
-            result.comments = []
-        for item in result.comments:
-            comment_text = item.get("content")
-            item["content"] = sys_comment_dict.get(comment_text, comment_text)
-        if result.sort_value == "":
-            index = MsgIndexDao.get_by_id(numutil.parse_int(result._id))
-            if index != None:
-                result.sort_value = index.sort_value
-                MessageDao.update(result)
-            
-        return result
-    
-    @classmethod
-    def from_dict_list(cls, dict_list):
-        result = []
-        for item in dict_list:
-            result.append(cls.from_dict(item))
-        return result
-    
-    @classmethod
-    def from_dict_or_None(cls, dict_value):
-        if dict_value == None:
-            return None
-        return cls.from_dict(dict_value)
-
-    def check_before_update(self):
-        id = self.id
-        if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
-            raise Exception("[msg.update] invalid message id:%s" % id)
-
-    def fix_before_update(self):
-        if self.tag is None:
-            # 修复tag为空的情况，这种一般是之前的待办任务，只有状态没有tag
-            if self.status == 100:
-                self.tag = "done"
-            if self.status in (0, 50):
-                self.tag = "task"
-
-        del_dict_key(self, "html")
-        del_dict_key(self, "tag_text")
-        del_dict_key(self, "full_keywords")
-        
-        if self.status == None:
-            self.pop("status", None)
-        if self.amount == None:
-            self.pop("amount", None)
-        if self.ref == None:
-            self.pop("ref", None)
-        if self.keywords == None:
-            self.pop("keywords", None)
-
-    def check_before_create(self):
-        if self.id != "":
-            raise Exception("message.dao.create: can not set id")
-        
-        if self.user == "":
-            raise Exception("message.dao.create: key `user` is missing")
-
-        if self.ctime == "":
-            raise Exception("message.dao.create: key `ctime` is missing")
-
-        if self.tag != "done" and self.content == "":
-            raise Exception("message.dao.create: key `content` is missing")
-
-        if self.tag not in VALID_TAG_SET:
-            raise Exception("message.dao.create: tag `%s` is invalid" % self.tag)
-        
-    def append_comment(self, comment_text=""):
-        comment = MessageComment()
-        comment.content = comment_text
-        self.comments.append(comment)
-
-    def get_int_id(self):
-        return int(self._id)
-
-
-def build_task_index(kw):
-    pass
-
-def execute_after_create(kw):
-    build_task_index(kw)
-
-
-def execute_after_update(kw):
-    build_task_index(kw)
-
-
-def execute_after_delete(kw):
-    build_task_index(kw)
-
-def _create_message_with_date(kw):
-    assert isinstance(kw, MessageDO)
-    date = kw.date
-    today = dateutil.get_today()
-
-    if today == date or date == "":
-        return _create_message_without_date(kw)
-
-    timestamp = dateutil.parse_date_to_timestamp(date)
-    timestamp += 60 * 60 * 23 + 60 * 59 # 追加日志的开始时间默认为23点59
-    ctime = dateutil.format_datetime(timestamp)
-
-    kw.ctime0 = xutils.format_datetime()
-    kw.ctime = ctime
-    kw.date = date
-
-    msg_index = MsgIndex()
-    msg_index.tag = kw.tag
-    msg_index.user_name = kw.user
-    msg_index.user_id = xauth.UserDao.get_id_by_name(kw.user)
-    msg_index.ctime_sys = xutils.format_datetime()
-    msg_index.ctime = ctime
-    msg_index.date = date
-    msg_index.sort_value = ctime
-    msg_id = MsgIndexDao.insert(msg_index)
-    _msg_db.update_by_id(str(msg_id), kw)
-    kw.id = kw._key
-    return kw._key
-
-
-def _create_message_without_date(kw):
-    assert isinstance(kw, MessageDO)
-
-    tag = kw.tag
-    ctime = kw.ctime
-    kw.date = dateutil.format_date(ctime)
-
-    index = MsgIndex()
-    index.tag = tag
-    index.ctime = ctime
-    index.date = kw.date
-    index.user_name = kw.user
-    index.user_id = xauth.UserDao.get_id_by_name(kw.user)
-    index.sort_value = ctime
-
-    msg_id = MsgIndexDao.insert(index)
-    _msg_db.update_by_id(str(msg_id), kw)
-    
-    kw.id = kw._key
-    execute_after_create(kw)
-    return kw._key
-
-
-def create_message(message):
-    # type: (MessageDO) -> str
-    """创建信息
-    :param {str} user: 用户名
-    :param {str} tag: 类型
-    :param {str} ctime: 创建时间
-    :param {str|None} date: 日期，可选的
-    :param {str} content: 文本的内容
-    """
-    assert isinstance(message, MessageDO)
-    message.check_before_create()
-    message.fix_before_update()
-    return _create_message_with_date(message)
-
-
-def update_message(message):
-    assert isinstance(message, MessageDO)
-    message.check_before_update()
-    message.fix_before_update()
-    _msg_db.update(message)
-    MsgIndexDao.touch(int(message._id))
-    execute_after_update(message)
-
-
-def add_message_history(message):
-    assert isinstance(message, MessageDO)
-    history_obj = MessageHistory()
-    history_obj.msg_id = message.get_int_id()
-    history_obj.msg_version = message.get("version", 0)
-    history_obj.content = message.content
-    history_obj.user_id = message.user_id
-    
-    _msg_history_db.insert(history_obj.__dict__)
-
-
-def get_words_from_key(key):
-    words = []
-    for item in key.split():
-        if item == "":
-            continue
-        words.append(item.lower())
-    return words
-
-
-def has_tag_fast(content):
-    return content.find("#") >= 0 or content.find("@") >= 0
-
-
-def search_message(user_name, key, offset=0, limit=20, *, search_tags=None, no_tag=None, count_only=False, date=""):
-    """搜索短信
-    :param {str} user_name: 用户名
-    :param {str} key: 要搜索的关键字
-    :param {int} offset: 下标
-    :param {int} limit: 返回结果最大限制
-    :param {list} search_tags: 搜索的标签集合
-    :param {bool} no_tag: 是否搜索无标签的
-    :param {bool} count_only: 只统计数量
-    :param {str} date: 日期过滤条件
-    """
-    assert user_name != None and user_name != ""
-    assert date != None
-
-    words = get_words_from_key(key)
-
-    def search_func_default(key, value):
-        if value.content is None:
-            return False
-        if no_tag is True and has_tag_fast(value.content):
-            return False
-        value_date = dateutil.format_date(value.ctime)
-        if value_date == None or not value_date.startswith(date):
-            return False
-        return textutil.contains_all(value.content.lower(), words)
-
-    def search_func_with_tags(key, value):
-        if value.tag not in search_tags:
-            return False
-        return search_func_default(key, value)
-
-    if search_tags != None:
-        search_func = search_func_with_tags
-    else:
-        search_func = search_func_default
-
-    if count_only:
-        chatlist = []
-    else:
-        chatlist = _msg_db.list(filter_func=search_func, offset=offset,
-                                limit=limit, reverse=True, user_name=user_name)
-        # 按照创建时间倒排 (按日期补充的随手记的key不是按时间顺序的)
-    
-    chatlist = MessageDO.from_dict_list(chatlist)
-    chatlist.sort(key = lambda x:x.sort_value, reverse=True)
-    amount = _msg_db.count(filter_func=search_func, user_name=user_name)
-    return chatlist, amount
-
-
-def check_before_delete(id):
-    if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
-        raise Exception("[delete] invalid message id:%s" % id)
-
-
-def delete_message_by_id(id):
-    # type: (str) -> None
-    check_before_delete(id)
-
-    old = get_message_by_id(id)
-
-    if old == None:
-        return
-    index_id = int(old._id)
-    _msg_db.delete(old)
-    MsgIndexDao.delete_by_id(index_id)
-
-
-    xmanager.fire("message.remove", Storage(id=id))
-    execute_after_delete(old)
-
-
-@xutils.timeit(name="Kv.Message.Count", logfile=True)
-def kv_count_message(user, status):
-    def filter_func(k, v):
-        return v.status == status
-    return _msg_db.count(filter_func=filter_func, user_name=user)
-
-
-@xutils.cache(prefix="message.count.status", expire=60)
-def count_message(user, status):
-    return kv_count_message(user, status)
-
-def get_message_by_id(full_key, user_name=""):
-    if full_key == None:
-        return None
-    if not full_key.startswith(_msg_db.prefix):
-        return None
-    value = _msg_db.get_by_key(full_key)
-    if value != None:
-        value = MessageDO.from_dict(value)
-        value.id = full_key
-        if user_name != "" and user_name != value.user:
-            return None
-    return value
-
-def check_param_user(user_name):
-    if user_name is None or user_name == "":
-        raise Exception("[query] invalid user_name:%s" % user_name)
-
-
-def check_param_id(id):
-    if id is None:
-        raise Exception("param id is None")
-    if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
-        raise Exception("param id invalid: %s" % id)
-
-
-@xutils.timeit(name="kv.message.list", logfile=True, logargs=True)
-def list_message_page(user, status, offset, limit):
-    def filter_func(key, value):
-        if status is None:
-            return value.user == user
-        value.id = key
-        return value.user == user and value.status == status
-    chatlist = _msg_db.list(filter_func=filter_func, offset=offset,
-                            limit=limit, reverse=True, user_name=user)
-
-    amount = _msg_db.count(filter_func=filter_func, user_name=user)
-    return chatlist, amount
-
-def query_special_page(user_name="", filter_func=None, offset=0, limit=10):
-    chatlist = _msg_db.list(filter_func=filter_func, offset=offset,
-                            limit=limit, reverse=True, user_name=user_name)
-    chatlist.sort(key = lambda x:x.ctime, reverse=True)
-    # TODO 后续可以用message_stat加速
-    amount = _msg_db.count(filter_func=filter_func, user_name=user_name)
-    return chatlist, amount
-
-def list_file_page(user, offset, limit):
-    def filter_func(key, value):
-        if value.content is None:
-            return False
-        return value.content.find("file://") >= 0
-    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
-
-
-def list_link_page(user, offset, limit):
-    def filter_func(key, value):
-        if value.content is None:
-            return False
-        return value.content.find("http://") >= 0 or value.content.find("https://") >= 0
-    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
-
-
-def list_book_page(user, offset, limit, key=None):
-    pattern = re.compile(r"《.+》")
-
-    def filter_func(key, value):
-        if value.content is None:
-            return False
-        return pattern.search(value.content)
-    
-    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
-
-
-def list_people_page(user, offset, limit, key=None):
-    def filter_func(key, value):
-        if value.content is None:
-            return False
-        return value.content.find("@") >= 0
-
-    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
-
-
-def list_phone_page(user, offset, limit, key=None):
-    pattern = re.compile(r"([0-9]+)")
-
-    def filter_func(key, value):
-        if value.content is None:
-            return False
-        result = pattern.findall(value.content)
-        for item in result:
-            if len(item) == MOBILE_LENGTH:
-                return True
-        return False
-
-    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
-
-
-def filter_todo_func(key, value):
-    # 兼容老版本的数据
-    return value.tag in ("task", "cron", "todo") or value.status == 0 or value.status == 50
-
-
-def get_filter_by_tag_func(tag):
-    if tag in ("task", "todo"):
-        return filter_todo_func
-
-    def filter_func(key, value):
-        if tag is None or tag == "all":
-            return True
-        if tag == "done":
-            return value.tag == "done" or value.status == 100
-        return value.tag == tag
-    return filter_func
-
-
-def list_key(user, offset=0, limit=1000):
-    user_id = xauth.UserDao.get_id_by_name(user)
-    items = MsgIndexDao.list(user_id=user_id, tag="key", offset=offset, limit=limit)
-    items.sort(key=lambda x: x.mtime, reverse=True)
-
-    if limit < 0:
-        return items[offset:]
-
-    return items[offset: offset+limit]
-
-
-def get_content_filter_func(tag, content):
-    def filter_func(key, value):
-        if tag is None:
-            return value.content == content
-        return value.tag == tag and value.content == content
-    return filter_func
-
-
-def get_by_content(user, tag, content):
-    if tag == "key":
-        # tag是独立的表，不需要比较tag
-        value = MsgTagInfoDao.get_first(user=user, content=content)
-        return MsgTagInfo.from_dict_or_None(value)
-    else:
-        return None
-
-def delete_keyword(user, content):
-    first = MsgTagInfoDao.get_first(user=user, content=content)
-    if first != None:
-        MsgTagInfoDao.delete(first)
-
-def list_task(user, offset=0, limit=xconfig.PAGE_SIZE):
-    return list_by_tag(user, "task", offset, limit)
-
-
-def list_task_done(user, offset=0, limit=xconfig.PAGE_SIZE):
-    return list_by_tag(user, "done", offset, limit)
-
-
-def list_by_tag(user, tag, offset=0, limit=xconfig.PAGE_SIZE):
-    check_param_user(user)
-
-    if tag == "key":
-        chatlist = MsgTagInfoDao.list(user=user, offset=offset, limit=limit)
-    else:
-        user_id = xauth.UserDao.get_id_by_name(user)
-        index_list = MsgIndexDao.list(user_id=user_id, tag=tag, offset=offset, limit=limit)
-        
-        chatlist = MessageDao.batch_get_by_index_list(index_list, user_name=user)
-
-    # 利用message_stat优化count查询
-    if tag == "done":
-        amount = get_message_stat(user).done_count
-    elif tag == "task" or tag == "todo":
-        amount = get_message_stat(user).task_count
-    elif tag == "cron":
-        amount = get_message_stat(user).cron_count
-    elif tag == "log":
-        amount = get_message_stat(user).log_count
-    elif tag == "key":
-        amount = get_message_stat(user).key_count
-    else:
-        amount = count_by_tag(user, tag)
-
-    if amount is None:
-        amount = 0
-    return chatlist, amount
-
-
-def list_by_date(user, date, offset=0, limit=xconfig.PAGE_SIZE):
-    if date is None or date == "":
-        return []
-    
-    user_id = xauth.UserDao.get_id_by_name(user)
-    index_list = MsgIndexDao.list(user_id=user_id, date_prefix=date, offset=offset, limit=limit)
-    msg_list = MessageDao.batch_get_by_index_list(index_list, user_name=user)
-    amount = MsgIndexDao.count(user_id=user_id, date_prefix=date)
-    return msg_list, amount
-
-def list_by_date_range(user_id=0, tag="", date_start="", date_end="", offset=0, limit=1000):
-    user_info = xauth.UserDao.get_by_id(user_id)
-    assert user_info != None
-    user_name = user_info.name
-    index_list = MsgIndexDao.list(user_id=user_id, tag=tag, date_start=date_start, date_end=date_end, offset=offset, limit=limit)
-    msg_list = MessageDao.batch_get_by_index_list(index_list=index_list, user_name=user_name)
-    amount = MsgIndexDao.count(user_id=user_id, tag=tag, date_start=date_start, date_end=date_end)
-    return msg_list, amount
-
-def count_by_tag(user, tag):
-    """内部方法"""
-    if tag == "key":
-        return MsgTagInfoDao.count(user=user)
-    
-    if tag == "all":
-        user_id = xauth.UserDao.get_id_by_name(user)
-        return MsgIndexDao.count(user_id=user_id)
-    
-    if tag in ("task", "done", "log"):
-        user_id = xauth.UserDao.get_id_by_name(user)
-        return MsgIndexDao.count(user_id=user_id, tag=tag)
-    
-    return dbutil.prefix_count("message:%s" % user, get_filter_by_tag_func(tag))
-
-
-def get_message_stat0(user=""):
-    stat = dbutil.get("user_stat:%s:message" % user)
-    result = MessageStatDO()
-    if stat != None:
-        assert isinstance(stat, Storage)
-        result.update(stat)
-    return result
-
-
-class MessageStatDO(xutils.Storage):
-    def __init__(self, **kw):
-        self.task_count = 0
-        self.log_count = 0
-        self.done_count = 0
-        self.cron_count = 0
-        self.key_count = 0
-        self.canceled_count = 0
-        self.update(kw)
-
-def get_empty_stat():
-    return MessageStatDO()
-
-def get_message_stat(user):
-    # type: (str) -> MessageStatDO
-    """读取随手记的状态"""
-    if user == None:
-        return get_empty_stat()
-    check_param_user(user)
-
-    value = _msg_stat_cache.get_dict(user)
-
-    if _debug:
-        logging.debug("[get_message_stat] cacheValue=%s", value)
-
-    if value == None:
-        value = get_message_stat0(user)
-        _msg_stat_cache.put(user, value)
-
-    if value is None:
-        return refresh_message_stat(user)
-
-    return MessageStatDO(**value)
-
-
-def refresh_message_stat(user, tag_list=[]) -> MessageStatDO:
-    if user == None:
-        return get_empty_stat()
-
-    stat = get_message_stat0(user)
-    if stat is None:
-        stat = get_empty_stat()
-
-    update_all = len(tag_list) == 0
-    if update_all or "task" in tag_list:
-        task_count = count_by_tag(user, "task")
-        stat.task_count = task_count
-    if update_all or "log" in tag_list:
-        log_count = count_by_tag(user, "log")
-        stat.log_count = log_count
-    if update_all or "done" in tag_list:
-        done_count = count_by_tag(user, "done")
-        stat.done_count = done_count
-    if update_all or "cron" in tag_list:
-        cron_count = count_by_tag(user, "cron")
-        stat.cron_count = cron_count
-    if update_all or "key" in tag_list:
-        key_count = count_by_tag(user, "key")
-        stat.key_count = key_count
-    if update_all or "canceled" in tag_list:
-        canceled_count = count_by_tag(user, "canceled")
-        stat.canceled_count = canceled_count
-
-    dbutil.put("user_stat:%s:message" % user, stat)
-    _msg_stat_cache.delete(user)
-
-    return stat
-
-class MessageStatDao:
-
-    db = dbutil.get_table("user_stat")
-
-    @classmethod
-    def put_by_user(cls, user="", stat={}):
-        cls.db.put_by_id(f"{user}:message", stat)
-
-class MsgSearchLogDao:
-
-    max_log_size = xconfig.DatabaseConfig.user_max_log_size
-    
-    @classmethod
-    def get_table(cls, user_name=""):
-        return dbutil.get_hash_table("msg_search_history", user_name=user_name)
-
-    @classmethod
-    def add_log(cls, user_name="", search_key="", cost_time=0):
-        user_db = cls.get_table(user_name)
-        search_log = Storage(key=search_key, cost_time=cost_time)
-        user_db.put(dbutil.timeseq(), search_log)
-
-        if user_db.count() > cls.max_log_size:
-            keys = []
-            for key, value in user_db.list(limit=20):
-                keys.append(key)
-            user_db.batch_delete(keys=keys)
-
-
-def add_search_history(user="", search_key="", cost_time=0):
-    MsgSearchLogDao.add_log(user_name=user, search_key=search_key, cost_time=cost_time)
-
-
-class MessageTag(Storage):
-
-    def __init__(self, tag, size, priority=0):
-        self.type = type
-        self.size = size
-        self.url = "/message?tag=" + tag
-        self.priority = priority
-        self.show_next = True
-        self.is_deleted = 0
-        self.name = "Message"
-        self.icon = "fa-file-text-o"
-        self.category = None
-        self.badge_info = size
-
-        if tag == "log":
-            self.name = T("随手记")
-            self.icon = "fa-file-text-o"
-
-        if tag == "task":
-            self.name = T("待办任务")
-            self.icon = "fa-calendar-check-o"
-
-
-def get_message_tag(user, tag, priority=0):
-    msg_stat = get_message_stat(user)
-
-    if tag == "log":
-        return MessageTag(tag, msg_stat.log_count, priority=priority)
-    if tag == "task":
-        return MessageTag(tag, msg_stat.task_count, priority=priority)
-
-    raise Exception("unknown tag:%s" % tag)
-
-class MessageComment(Storage):
-    def __init__(self):
-        self.time = dateutil.format_datetime()
-        self.content = ""
-
-class MsgIndex(Storage):
-    def __init__(self, **kw):
-        self.id = 0
-        self.tag = ""
-        self.user_id = 0
-        self.user_name = ""
-        self.ctime_sys = dateutil.format_datetime() # 实际创建时间
-        self.ctime = dateutil.format_datetime() # 展示创建时间
-        self.mtime = dateutil.format_datetime() # 修改时间
-        self.date = "1970-01-01"
-        self.sort_value = "" # 排序字段, 对于log/task,存储创建时间,对于done,存储完成时间
-        self.update(kw)
-
-class MsgIndexDao:
-    """随手记索引表,使用SQL存储"""
-    db = xtables.get_table_by_name("msg_index")
-
-    @classmethod
-    def insert(cls, msg_index: MsgIndex):
-        msg_index.pop("id")
-        assert msg_index.tag != ""
-        assert msg_index.ctime != ""
-        assert msg_index.ctime_sys != ""
-        assert msg_index.date != ""
-        assert msg_index.user_id != 0
-        assert msg_index.user_name != ""
-
-        msg_index.mtime = dateutil.format_datetime()
-        return cls.db.insert(**msg_index)
-    
-    @classmethod
-    def count(cls, user_id=0, tag = "", date_prefix="", date_start="", date_end=""):
-        where = "1=1"
-        if user_id != 0:
-            where += " AND user_id=$user_id"
-        
-        if tag != "":
-            where += " AND tag=$tag"
-        
-        if date_prefix != "":
-            where += " AND date LIKE $date_prefix"
-        if date_start != "":
-            where += " AND date >= $date_start"
-        if date_end != "":
-            where += " AND date < $date_end"
-
-        vars = dict(user_id=user_id, tag=tag, date_prefix=date_prefix+"%", date_start=date_start, date_end=date_end)
-        return cls.db.count(where=where, vars=vars)
-    
-    @classmethod
-    def list(cls, user_id=0, tag="", date_prefix="", date_start="", date_end="", offset=0, limit=10, order="sort_value desc"):
-        where = "1=1"
-        if user_id != 0:
-            where += " AND user_id=$user_id"
-        if tag != "":
-            where += " AND tag=$tag"
-        if date_prefix != "":
-            where += " AND date LIKE $date_prefix"
-        if date_start != "":
-            where += " AND date >= $date_start"
-        if date_end != "":
-            where += " AND date < $date_end"
-
-        vars = dict(user_id=user_id, tag=tag, date_prefix=date_prefix+"%", date_start=date_start, date_end=date_end)
-        return cls.db.select(where=where, vars=vars,offset=offset,limit=limit,order=order)
-    
-    @classmethod
-    def delete_by_id(cls, id=0):
-        return cls.db.delete(where=dict(id=id))
-    
-    @classmethod
-    def get_by_id(cls, id=0):
-        if id == 0:
-            return None
-        result = cls.db.select_first(where=dict(id=id))
-        if result == None:
-            return None
-        return MsgIndex(**result)
-    
-    @classmethod
-    def update_tag(cls, id=0, tag="", sort_value=""):
-        now = xutils.format_datetime()
-        updates = dict()
-        updates["tag"] = tag
-        updates["mtime"] = now
-        if sort_value != "":
-            updates["sort_value"] = sort_value
-        return cls.db.update(where=dict(id=id), **updates)
-    
-    @classmethod
-    def touch(cls, id=0):
-        now = xutils.format_datetime()
-        return cls.db.update(mtime=now, where=dict(id=id))
-    
-    @classmethod
-    def get_first(cls, user_id=0, content="", tag=""):
-        where = "1=1"
-        if user_id != 0:
-            where += " AND user_id=$user_id"
-        if tag != "":
-            where += " AND tag=$tag"
-        vars = dict(user_id=user_id, tag=tag)
-        return cls.db.select_first(where=where, vars=vars)
-
-    @classmethod
-    def iter_batch(cls, user_id=0, batch_size=20):
-        yield from cls.db.iter_batch(batch_size=batch_size, where="user_id=$user_id", vars=dict(user_id=user_id))
-
-class MsgTagInfo(Storage):
-    def __init__(self):
-        self._key = "" # kv的真实key
-        self.id = ""
-        self.ctime = xutils.format_datetime()
-        self.mtime = xutils.format_datetime()
-        self.user = ""
-        self.content=""
-        self.amount=0
-        self.is_marked=False
-        self.visit_cnt=0
-    
-    @staticmethod
-    def from_dict(dict_value):
-        result = new_from_dict(MsgTagInfo, dict_value)
-        result.id = result._key
-        return result
-    
-    @classmethod
-    def from_dict_or_None(cls, dict_value):
-        if dict_value == None:
-            return None
-        return cls.from_dict(dict_value)
-
-class MsgTagInfoDao:
-    """随手记标签元信息表,使用KV存储"""
-    db = dbutil.get_table("msg_key")
-
-    @classmethod
-    def get_first(cls, user="", content=""):
-        where = dict(user=user, content=content)
-        return cls.db.get_first(where=where)
-    
-    @classmethod
-    def get_by_key(cls, key=""):
-        result = cls.db.get_by_key(key)
-        return MsgTagInfo.from_dict_or_None(result)
-    
-    @classmethod
-    def list(cls, user="", offset=0, limit=20, content=None):
-        where = {}
-        if content != None:
-            where["content"] = content
-        return cls.db.list(where=where, user_name=user,offset=offset,limit=limit,reverse=True)
-    
-    @classmethod
-    def update(cls, tag_info: MsgTagInfo):
-        tag_info.mtime = xutils.format_datetime()
-        return cls.db.update(tag_info)
-
-    @classmethod
-    def delete_by_id(cls, id=""):
-        return cls.db.delete_by_id(id=id)
-    
-    @classmethod
-    def delete(cls, obj):
-        return cls.db.delete(obj)
-
-    @classmethod
-    def get_or_create(cls, user="", content=""):
-        item = cls.get_first(user=user, content=content)
-        if item != None:
-            return MsgTagInfo.from_dict(item)
-        else:
-            record = MsgTagInfo()
-            record.user = user
-            record.content = content
-            cls.db.insert(record)
-            record.id = record._key
-            return record
-
-    @classmethod
-    def count(cls, user=""):
-        return cls.db.count(user_name=user)
-
-class MsgTagBindDao:
-
-    tag_bind_service = TagBindService(TagTypeEnum.msg_tag)
-
-    @classmethod
-    def bind_tags(cls, user_id=0, msg_id=0, tags=[]):
-        if user_id == 0:
-            logging.error("user_id=0")
-            return
-        cls.tag_bind_service.bind_tags(user_id=user_id, target_id=msg_id, tags=tags, update_only_changed=True)
-        
-    @classmethod
-    def count_by_key(cls, user_id=0, key=""):
-        assert isinstance(user_id, int)
-        assert isinstance(key, str)
-        return cls.tag_bind_service.count_user_tag(user_id=user_id, tag_code=key)
-
-class MessageDao:
-    """message的主数据接口,使用KV存储"""
-
-    @staticmethod
-    def get_by_id(full_key):
-        return get_message_by_id(full_key)
-    
-    @staticmethod
-    def create(message):
-        return create_message(message)
-    
-    @staticmethod
-    def update(message):
-        return update_message(message)
-    
-    @staticmethod
-    def update_user_tags(message:MessageDO):
-        msg_id = message.get_int_id()
-        MsgTagBindDao.bind_tags(message.user_id, msg_id=msg_id, tags=message.full_keywords)
-    
-    @classmethod
-    def update_tag(cls, message:MessageDO, tag="", sort_value=""):
-        message.tag = tag
-        MsgIndexDao.update_tag(id=int(message._id), tag=tag, sort_value=sort_value)
-        cls.update(message)
-        cls.refresh_message_stat(message.user)
-
-    @staticmethod
-    def delete(full_key):
-        return delete_message_by_id(full_key)
-    
-    @staticmethod
-    def delete_by_key(full_key):
-        return delete_message_by_id(full_key)
-
-    @staticmethod
-    def add_search_history(user, search_key, cost_time=0):
-        return add_search_history(user, search_key, cost_time)
-
-    @staticmethod
-    def add_history(message):
-        return add_message_history(message)
-    
-    @staticmethod
-    def refresh_message_stat(user, tag_list=[]):       
-        return refresh_message_stat(user, tag_list)
-    
-    @staticmethod
-    def get_message_stat(user):
-        return get_message_stat(user)
-    
-    @staticmethod
-    def get_message_tag(user, tag, priority=0):
-        return get_message_tag(user, tag, priority)
-    
-    @classmethod
-    def batch_get_by_index_list(cls, index_list, user_name=""):
-        id_list = []
-        for index in index_list:
-            id_list.append(str(index.id))
-
-        dict_result = _msg_db.batch_get_by_id(id_list, user_name=user_name)
-        result = []
-        for index in index_list:
-            msg = dict_result.get(str(index.id))
-            if msg != None:
-                new_msg = MessageDO.from_dict(msg)
-                new_msg.sort_value = index.sort_value
-                result.append(new_msg)
-        return result
-
-xutils.register_func("message.create", create_message)
-xutils.register_func("message.update", update_message)
-xutils.register_func("message.search", search_message)
-xutils.register_func("message.delete", delete_message_by_id)
-xutils.register_func("message.count", count_message)
-
-xutils.register_func("message.find_by_id", get_message_by_id)
-xutils.register_func("message.get_by_id",  get_message_by_id)
-xutils.register_func("message.get_by_content", get_by_content)
-xutils.register_func("message.get_message_tag", get_message_tag)
-
-xutils.register_func("message.list", list_message_page)
-xutils.register_func("message.list_file", list_file_page)
-xutils.register_func("message.list_link", list_link_page)
-xutils.register_func("message.list_book", list_book_page)
-xutils.register_func("message.list_people", list_people_page)
-xutils.register_func("message.list_phone", list_phone_page)
-xutils.register_func("message.list_task", list_task)
-xutils.register_func("message.list_task_done", list_task_done)
-xutils.register_func("message.list_by_tag",  list_by_tag)
-xutils.register_func("message.list_by_date", list_by_date)
-
-xutils.register_func("message.get_message_stat", get_message_stat)
-xutils.register_func("message.refresh_message_stat", refresh_message_stat)
-xutils.register_func("message.add_search_history", add_search_history)
-xutils.register_func("message.add_history", add_message_history)
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2019/06/12 22:59:33
+# @modified 2022/04/11 23:29:47
+import xutils
+import re
+import logging
+import copy
+from xnote.core import xconfig, xmanager, xtables, xauth
+
+from xutils import dbutil, cacheutil, textutil, Storage, functions
+from xutils import dateutil
+from xutils.functions import del_dict_key
+from xnote.core.xtemplate import T
+from xutils.db.dbutil_helper import new_from_dict
+from xnote.service import TagBindService, TagTypeEnum
+from .message_model import is_task_tag
+from xutils import numutil
+
+VALID_MESSAGE_PREFIX_TUPLE = ("message:", "msg_key:", "msg_task:")
+# 带日期创建的最大重试次数
+CREATE_MAX_RETRY = 20
+MOBILE_LENGTH = 11
+VALID_TAG_SET = set(["task", "done", "log", "key"])
+
+_msg_db = dbutil.get_table("message")
+_msg_stat_cache = cacheutil.PrefixedCache("msgStat:")
+_msg_history_db = dbutil.get_table_v2("msg_history")
+
+_debug = False
+
+sys_comment_dict = {
+    "$mark_task_done$": T("标记任务完成"),
+    "$reopen_task$": T("重新开启任务"),
+}
+
+class MessageHistory:
+    def __init__(self):
+        self.msg_id = 0
+        self.msg_version = 0
+        self.user_id = 0
+        self.content = ""
+        self.ctime = dateutil.format_datetime()
+
+class MessageDO(Storage):
+    def __init__(self):
+        self._key = "" # kv的主键
+        self._id = "" # kv的ID
+
+        self.id = "" # 主键
+        self.tag = "" # tag标签 {task, done, log, key}
+        self.user = "" # 用户名
+        self.user_id = 0 # 用户ID
+        self.ip = ""
+        self.ref = None # 引用的id
+        self.ctime = xutils.format_datetime()  # 展示的创建时间
+        self.ctime0 = xutils.format_datetime() # 实际的创建时间
+        self.mtime = xutils.format_datetime()
+        self.date = xutils.format_date()
+        self.content = ""
+        self.comments = [] # 评论信息
+        self.version = 0
+        self.visit_cnt = 0
+        self.status = None # 老的结构
+        self.keywords = None
+        self.full_keywords = set()
+        self.no_tag = True
+        self.amount = 0 # keyword对象的数量
+        self.done_time = None # type: str|None
+        self.sort_value = ""
+
+    @classmethod
+    def from_dict(cls, dict_value: dict):
+        result = MessageDO()
+        result.update(dict_value)
+        result.id = result._key
+        if result.comments == None:
+            result.comments = []
+        for item in result.comments:
+            comment_text = item.get("content")
+            item["content"] = sys_comment_dict.get(comment_text, comment_text)
+        if result.sort_value == "":
+            index = MsgIndexDao.get_by_id(numutil.parse_int(result._id))
+            if index != None:
+                result.sort_value = index.sort_value
+                MessageDao.update(result)
+            
+        return result
+    
+    @classmethod
+    def from_dict_list(cls, dict_list):
+        result = []
+        for item in dict_list:
+            result.append(cls.from_dict(item))
+        return result
+    
+    @classmethod
+    def from_dict_or_None(cls, dict_value):
+        if dict_value == None:
+            return None
+        return cls.from_dict(dict_value)
+
+    def check_before_update(self):
+        id = self.id
+        if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
+            raise Exception("[msg.update] invalid message id:%s" % id)
+
+    def fix_before_update(self):
+        if self.tag is None:
+            # 修复tag为空的情况，这种一般是之前的待办任务，只有状态没有tag
+            if self.status == 100:
+                self.tag = "done"
+            if self.status in (0, 50):
+                self.tag = "task"
+
+        del_dict_key(self, "html")
+        del_dict_key(self, "tag_text")
+        del_dict_key(self, "full_keywords")
+        
+        if self.status == None:
+            self.pop("status", None)
+        if self.amount == None:
+            self.pop("amount", None)
+        if self.ref == None:
+            self.pop("ref", None)
+        if self.keywords == None:
+            self.pop("keywords", None)
+
+    def check_before_create(self):
+        if self.id != "":
+            raise Exception("message.dao.create: can not set id")
+        
+        if self.user == "":
+            raise Exception("message.dao.create: key `user` is missing")
+
+        if self.ctime == "":
+            raise Exception("message.dao.create: key `ctime` is missing")
+
+        if self.tag != "done" and self.content == "":
+            raise Exception("message.dao.create: key `content` is missing")
+
+        if self.tag not in VALID_TAG_SET:
+            raise Exception("message.dao.create: tag `%s` is invalid" % self.tag)
+        
+    def append_comment(self, comment_text=""):
+        comment = MessageComment()
+        comment.content = comment_text
+        self.comments.append(comment)
+
+    def get_int_id(self):
+        return int(self._id)
+
+
+def build_task_index(kw):
+    pass
+
+def execute_after_create(kw):
+    build_task_index(kw)
+
+
+def execute_after_update(kw):
+    build_task_index(kw)
+
+
+def execute_after_delete(kw):
+    build_task_index(kw)
+
+def _create_message_with_date(kw):
+    assert isinstance(kw, MessageDO)
+    date = kw.date
+    today = dateutil.get_today()
+
+    if today == date or date == "":
+        return _create_message_without_date(kw)
+
+    timestamp = dateutil.parse_date_to_timestamp(date)
+    timestamp += 60 * 60 * 23 + 60 * 59 # 追加日志的开始时间默认为23点59
+    ctime = dateutil.format_datetime(timestamp)
+
+    kw.ctime0 = xutils.format_datetime()
+    kw.ctime = ctime
+    kw.date = date
+
+    msg_index = MsgIndex()
+    msg_index.tag = kw.tag
+    msg_index.user_name = kw.user
+    msg_index.user_id = xauth.UserDao.get_id_by_name(kw.user)
+    msg_index.ctime_sys = xutils.format_datetime()
+    msg_index.ctime = ctime
+    msg_index.date = date
+    msg_index.sort_value = ctime
+    msg_id = MsgIndexDao.insert(msg_index)
+    _msg_db.update_by_id(str(msg_id), kw)
+    kw.id = kw._key
+    return kw._key
+
+
+def _create_message_without_date(kw):
+    assert isinstance(kw, MessageDO)
+
+    tag = kw.tag
+    ctime = kw.ctime
+    kw.date = dateutil.format_date(ctime)
+
+    index = MsgIndex()
+    index.tag = tag
+    index.ctime = ctime
+    index.date = kw.date
+    index.user_name = kw.user
+    index.user_id = xauth.UserDao.get_id_by_name(kw.user)
+    index.sort_value = ctime
+
+    msg_id = MsgIndexDao.insert(index)
+    _msg_db.update_by_id(str(msg_id), kw)
+    
+    kw.id = kw._key
+    execute_after_create(kw)
+    return kw._key
+
+
+def create_message(message):
+    # type: (MessageDO) -> str
+    """创建信息
+    :param {str} user: 用户名
+    :param {str} tag: 类型
+    :param {str} ctime: 创建时间
+    :param {str|None} date: 日期，可选的
+    :param {str} content: 文本的内容
+    """
+    assert isinstance(message, MessageDO)
+    message.check_before_create()
+    message.fix_before_update()
+    return _create_message_with_date(message)
+
+
+def update_message(message):
+    assert isinstance(message, MessageDO)
+    message.check_before_update()
+    message.fix_before_update()
+    _msg_db.update(message)
+    MsgIndexDao.touch(int(message._id))
+    execute_after_update(message)
+
+
+def add_message_history(message):
+    assert isinstance(message, MessageDO)
+    history_obj = MessageHistory()
+    history_obj.msg_id = message.get_int_id()
+    history_obj.msg_version = message.get("version", 0)
+    history_obj.content = message.content
+    history_obj.user_id = message.user_id
+    
+    _msg_history_db.insert(history_obj.__dict__)
+
+
+def get_words_from_key(key):
+    words = []
+    for item in key.split():
+        if item == "":
+            continue
+        words.append(item.lower())
+    return words
+
+
+def has_tag_fast(content):
+    return content.find("#") >= 0 or content.find("@") >= 0
+
+
+def search_message(user_name, key, offset=0, limit=20, *, search_tags=None, no_tag=None, count_only=False, date=""):
+    """搜索短信
+    :param {str} user_name: 用户名
+    :param {str} key: 要搜索的关键字
+    :param {int} offset: 下标
+    :param {int} limit: 返回结果最大限制
+    :param {list} search_tags: 搜索的标签集合
+    :param {bool} no_tag: 是否搜索无标签的
+    :param {bool} count_only: 只统计数量
+    :param {str} date: 日期过滤条件
+    """
+    assert user_name != None and user_name != ""
+    assert date != None
+
+    words = get_words_from_key(key)
+
+    def search_func_default(key, value):
+        if value.content is None:
+            return False
+        if no_tag is True and has_tag_fast(value.content):
+            return False
+        value_date = dateutil.format_date(value.ctime)
+        if value_date == None or not value_date.startswith(date):
+            return False
+        return textutil.contains_all(value.content.lower(), words)
+
+    def search_func_with_tags(key, value):
+        if value.tag not in search_tags:
+            return False
+        return search_func_default(key, value)
+
+    if search_tags != None:
+        search_func = search_func_with_tags
+    else:
+        search_func = search_func_default
+
+    if count_only:
+        chatlist = []
+    else:
+        chatlist = _msg_db.list(filter_func=search_func, offset=offset,
+                                limit=limit, reverse=True, user_name=user_name)
+        # 按照创建时间倒排 (按日期补充的随手记的key不是按时间顺序的)
+    
+    chatlist = MessageDO.from_dict_list(chatlist)
+    chatlist.sort(key = lambda x:x.sort_value, reverse=True)
+    amount = _msg_db.count(filter_func=search_func, user_name=user_name)
+    return chatlist, amount
+
+
+def check_before_delete(id):
+    if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
+        raise Exception("[delete] invalid message id:%s" % id)
+
+
+def delete_message_by_id(id):
+    # type: (str) -> None
+    check_before_delete(id)
+
+    old = get_message_by_id(id)
+
+    if old == None:
+        return
+    index_id = int(old._id)
+    _msg_db.delete(old)
+    MsgIndexDao.delete_by_id(index_id)
+
+
+    xmanager.fire("message.remove", Storage(id=id))
+    execute_after_delete(old)
+
+
+@xutils.timeit(name="Kv.Message.Count", logfile=True)
+def kv_count_message(user, status):
+    def filter_func(k, v):
+        return v.status == status
+    return _msg_db.count(filter_func=filter_func, user_name=user)
+
+
+@xutils.cache(prefix="message.count.status", expire=60)
+def count_message(user, status):
+    return kv_count_message(user, status)
+
+def get_message_by_id(full_key, user_name=""):
+    if full_key == None:
+        return None
+    if not full_key.startswith(_msg_db.prefix):
+        return None
+    value = _msg_db.get_by_key(full_key)
+    if value != None:
+        value = MessageDO.from_dict(value)
+        value.id = full_key
+        if user_name != "" and user_name != value.user:
+            return None
+    return value
+
+def check_param_user(user_name):
+    if user_name is None or user_name == "":
+        raise Exception("[query] invalid user_name:%s" % user_name)
+
+
+def check_param_id(id):
+    if id is None:
+        raise Exception("param id is None")
+    if not id.startswith(VALID_MESSAGE_PREFIX_TUPLE):
+        raise Exception("param id invalid: %s" % id)
+
+
+@xutils.timeit(name="kv.message.list", logfile=True, logargs=True)
+def list_message_page(user, status, offset, limit):
+    def filter_func(key, value):
+        if status is None:
+            return value.user == user
+        value.id = key
+        return value.user == user and value.status == status
+    chatlist = _msg_db.list(filter_func=filter_func, offset=offset,
+                            limit=limit, reverse=True, user_name=user)
+
+    amount = _msg_db.count(filter_func=filter_func, user_name=user)
+    return chatlist, amount
+
+def query_special_page(user_name="", filter_func=None, offset=0, limit=10):
+    chatlist = _msg_db.list(filter_func=filter_func, offset=offset,
+                            limit=limit, reverse=True, user_name=user_name)
+    chatlist.sort(key = lambda x:x.ctime, reverse=True)
+    # TODO 后续可以用message_stat加速
+    amount = _msg_db.count(filter_func=filter_func, user_name=user_name)
+    return chatlist, amount
+
+def list_file_page(user, offset, limit):
+    def filter_func(key, value):
+        if value.content is None:
+            return False
+        return value.content.find("file://") >= 0
+    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
+
+
+def list_link_page(user, offset, limit):
+    def filter_func(key, value):
+        if value.content is None:
+            return False
+        return value.content.find("http://") >= 0 or value.content.find("https://") >= 0
+    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
+
+
+def list_book_page(user, offset, limit, key=None):
+    pattern = re.compile(r"《.+》")
+
+    def filter_func(key, value):
+        if value.content is None:
+            return False
+        return pattern.search(value.content)
+    
+    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
+
+
+def list_people_page(user, offset, limit, key=None):
+    def filter_func(key, value):
+        if value.content is None:
+            return False
+        return value.content.find("@") >= 0
+
+    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
+
+
+def list_phone_page(user, offset, limit, key=None):
+    pattern = re.compile(r"([0-9]+)")
+
+    def filter_func(key, value):
+        if value.content is None:
+            return False
+        result = pattern.findall(value.content)
+        for item in result:
+            if len(item) == MOBILE_LENGTH:
+                return True
+        return False
+
+    return query_special_page(user_name=user, offset=offset, limit=limit, filter_func=filter_func)
+
+
+def filter_todo_func(key, value):
+    # 兼容老版本的数据
+    return value.tag in ("task", "cron", "todo") or value.status == 0 or value.status == 50
+
+
+def get_filter_by_tag_func(tag):
+    if tag in ("task", "todo"):
+        return filter_todo_func
+
+    def filter_func(key, value):
+        if tag is None or tag == "all":
+            return True
+        if tag == "done":
+            return value.tag == "done" or value.status == 100
+        return value.tag == tag
+    return filter_func
+
+
+def list_key(user, offset=0, limit=1000):
+    user_id = xauth.UserDao.get_id_by_name(user)
+    items = MsgIndexDao.list(user_id=user_id, tag="key", offset=offset, limit=limit)
+    items.sort(key=lambda x: x.mtime, reverse=True)
+
+    if limit < 0:
+        return items[offset:]
+
+    return items[offset: offset+limit]
+
+
+def get_content_filter_func(tag, content):
+    def filter_func(key, value):
+        if tag is None:
+            return value.content == content
+        return value.tag == tag and value.content == content
+    return filter_func
+
+
+def get_by_content(user, tag, content):
+    if tag == "key":
+        # tag是独立的表，不需要比较tag
+        value = MsgTagInfoDao.get_first(user=user, content=content)
+        return MsgTagInfo.from_dict_or_None(value)
+    else:
+        return None
+
+def delete_keyword(user, content):
+    first = MsgTagInfoDao.get_first(user=user, content=content)
+    if first != None:
+        MsgTagInfoDao.delete(first)
+
+def list_task(user, offset=0, limit=xconfig.PAGE_SIZE):
+    return list_by_tag(user, "task", offset, limit)
+
+
+def list_task_done(user, offset=0, limit=xconfig.PAGE_SIZE):
+    return list_by_tag(user, "done", offset, limit)
+
+
+def list_by_tag(user, tag, offset=0, limit=xconfig.PAGE_SIZE):
+    check_param_user(user)
+
+    if tag == "key":
+        chatlist = MsgTagInfoDao.list(user=user, offset=offset, limit=limit)
+    else:
+        user_id = xauth.UserDao.get_id_by_name(user)
+        index_list = MsgIndexDao.list(user_id=user_id, tag=tag, offset=offset, limit=limit)
+        
+        chatlist = MessageDao.batch_get_by_index_list(index_list, user_name=user)
+
+    # 利用message_stat优化count查询
+    if tag == "done":
+        amount = get_message_stat(user).done_count
+    elif tag == "task" or tag == "todo":
+        amount = get_message_stat(user).task_count
+    elif tag == "cron":
+        amount = get_message_stat(user).cron_count
+    elif tag == "log":
+        amount = get_message_stat(user).log_count
+    elif tag == "key":
+        amount = get_message_stat(user).key_count
+    else:
+        amount = count_by_tag(user, tag)
+
+    if amount is None:
+        amount = 0
+    return chatlist, amount
+
+
+def list_by_date(user, date, offset=0, limit=xconfig.PAGE_SIZE):
+    if date is None or date == "":
+        return []
+    
+    user_id = xauth.UserDao.get_id_by_name(user)
+    index_list = MsgIndexDao.list(user_id=user_id, date_prefix=date, offset=offset, limit=limit)
+    msg_list = MessageDao.batch_get_by_index_list(index_list, user_name=user)
+    amount = MsgIndexDao.count(user_id=user_id, date_prefix=date)
+    return msg_list, amount
+
+def list_by_date_range(user_id=0, tag="", date_start="", date_end="", offset=0, limit=1000):
+    user_info = xauth.UserDao.get_by_id(user_id)
+    assert user_info != None
+    user_name = user_info.name
+    index_list = MsgIndexDao.list(user_id=user_id, tag=tag, date_start=date_start, date_end=date_end, offset=offset, limit=limit)
+    msg_list = MessageDao.batch_get_by_index_list(index_list=index_list, user_name=user_name)
+    amount = MsgIndexDao.count(user_id=user_id, tag=tag, date_start=date_start, date_end=date_end)
+    return msg_list, amount
+
+def count_by_tag(user, tag):
+    """内部方法"""
+    if tag == "key":
+        return MsgTagInfoDao.count(user=user)
+    
+    if tag == "all":
+        user_id = xauth.UserDao.get_id_by_name(user)
+        return MsgIndexDao.count(user_id=user_id)
+    
+    if tag in ("task", "done", "log"):
+        user_id = xauth.UserDao.get_id_by_name(user)
+        return MsgIndexDao.count(user_id=user_id, tag=tag)
+    
+    return dbutil.prefix_count("message:%s" % user, get_filter_by_tag_func(tag))
+
+
+def get_message_stat0(user=""):
+    stat = dbutil.get("user_stat:%s:message" % user)
+    result = MessageStatDO()
+    if stat != None:
+        assert isinstance(stat, Storage)
+        result.update(stat)
+    return result
+
+
+class MessageStatDO(xutils.Storage):
+    def __init__(self, **kw):
+        self.task_count = 0
+        self.log_count = 0
+        self.done_count = 0
+        self.cron_count = 0
+        self.key_count = 0
+        self.canceled_count = 0
+        self.update(kw)
+
+def get_empty_stat():
+    return MessageStatDO()
+
+def get_message_stat(user):
+    # type: (str) -> MessageStatDO
+    """读取随手记的状态"""
+    if user == None:
+        return get_empty_stat()
+    check_param_user(user)
+
+    value = _msg_stat_cache.get_dict(user)
+
+    if _debug:
+        logging.debug("[get_message_stat] cacheValue=%s", value)
+
+    if value == None:
+        value = get_message_stat0(user)
+        _msg_stat_cache.put(user, value)
+
+    if value is None:
+        return refresh_message_stat(user)
+
+    return MessageStatDO(**value)
+
+
+def refresh_message_stat(user, tag_list=[]) -> MessageStatDO:
+    if user == None:
+        return get_empty_stat()
+
+    stat = get_message_stat0(user)
+    if stat is None:
+        stat = get_empty_stat()
+
+    update_all = len(tag_list) == 0
+    if update_all or "task" in tag_list:
+        task_count = count_by_tag(user, "task")
+        stat.task_count = task_count
+    if update_all or "log" in tag_list:
+        log_count = count_by_tag(user, "log")
+        stat.log_count = log_count
+    if update_all or "done" in tag_list:
+        done_count = count_by_tag(user, "done")
+        stat.done_count = done_count
+    if update_all or "cron" in tag_list:
+        cron_count = count_by_tag(user, "cron")
+        stat.cron_count = cron_count
+    if update_all or "key" in tag_list:
+        key_count = count_by_tag(user, "key")
+        stat.key_count = key_count
+    if update_all or "canceled" in tag_list:
+        canceled_count = count_by_tag(user, "canceled")
+        stat.canceled_count = canceled_count
+
+    dbutil.put("user_stat:%s:message" % user, stat)
+    _msg_stat_cache.delete(user)
+
+    return stat
+
+class MessageStatDao:
+
+    db = dbutil.get_table("user_stat")
+
+    @classmethod
+    def put_by_user(cls, user="", stat={}):
+        cls.db.put_by_id(f"{user}:message", stat)
+
+class MsgSearchLogDao:
+
+    max_log_size = xconfig.DatabaseConfig.user_max_log_size
+    
+    @classmethod
+    def get_table(cls, user_name=""):
+        return dbutil.get_hash_table("msg_search_history", user_name=user_name)
+
+    @classmethod
+    def add_log(cls, user_name="", search_key="", cost_time=0):
+        user_db = cls.get_table(user_name)
+        search_log = Storage(key=search_key, cost_time=cost_time)
+        user_db.put(dbutil.timeseq(), search_log)
+
+        if user_db.count() > cls.max_log_size:
+            keys = []
+            for key, value in user_db.list(limit=20):
+                keys.append(key)
+            user_db.batch_delete(keys=keys)
+
+
+def add_search_history(user="", search_key="", cost_time=0):
+    MsgSearchLogDao.add_log(user_name=user, search_key=search_key, cost_time=cost_time)
+
+
+class MessageTag(Storage):
+
+    def __init__(self, tag, size, priority=0):
+        self.type = type
+        self.size = size
+        self.url = "/message?tag=" + tag
+        self.priority = priority
+        self.show_next = True
+        self.is_deleted = 0
+        self.name = "Message"
+        self.icon = "fa-file-text-o"
+        self.category = None
+        self.badge_info = size
+
+        if tag == "log":
+            self.name = T("随手记")
+            self.icon = "fa-file-text-o"
+
+        if tag == "task":
+            self.name = T("待办任务")
+            self.icon = "fa-calendar-check-o"
+
+
+def get_message_tag(user, tag, priority=0):
+    msg_stat = get_message_stat(user)
+
+    if tag == "log":
+        return MessageTag(tag, msg_stat.log_count, priority=priority)
+    if tag == "task":
+        return MessageTag(tag, msg_stat.task_count, priority=priority)
+
+    raise Exception("unknown tag:%s" % tag)
+
+class MessageComment(Storage):
+    def __init__(self):
+        self.time = dateutil.format_datetime()
+        self.content = ""
+
+class MsgIndex(Storage):
+    def __init__(self, **kw):
+        self.id = 0
+        self.tag = ""
+        self.user_id = 0
+        self.user_name = ""
+        self.ctime_sys = dateutil.format_datetime() # 实际创建时间
+        self.ctime = dateutil.format_datetime() # 展示创建时间
+        self.mtime = dateutil.format_datetime() # 修改时间
+        self.date = "1970-01-01"
+        self.sort_value = "" # 排序字段, 对于log/task,存储创建时间,对于done,存储完成时间
+        self.update(kw)
+
+class MsgIndexDao:
+    """随手记索引表,使用SQL存储"""
+    db = xtables.get_table_by_name("msg_index")
+
+    @classmethod
+    def insert(cls, msg_index: MsgIndex):
+        msg_index.pop("id")
+        assert msg_index.tag != ""
+        assert msg_index.ctime != ""
+        assert msg_index.ctime_sys != ""
+        assert msg_index.date != ""
+        assert msg_index.user_id != 0
+        assert msg_index.user_name != ""
+
+        msg_index.mtime = dateutil.format_datetime()
+        return cls.db.insert(**msg_index)
+    
+    @classmethod
+    def count(cls, user_id=0, tag = "", date_prefix="", date_start="", date_end=""):
+        where = "1=1"
+        if user_id != 0:
+            where += " AND user_id=$user_id"
+        
+        if tag != "":
+            where += " AND tag=$tag"
+        
+        if date_prefix != "":
+            where += " AND date LIKE $date_prefix"
+        if date_start != "":
+            where += " AND date >= $date_start"
+        if date_end != "":
+            where += " AND date < $date_end"
+
+        vars = dict(user_id=user_id, tag=tag, date_prefix=date_prefix+"%", date_start=date_start, date_end=date_end)
+        return cls.db.count(where=where, vars=vars)
+    
+    @classmethod
+    def list(cls, user_id=0, tag="", date_prefix="", date_start="", date_end="", offset=0, limit=10, order="sort_value desc"):
+        where = "1=1"
+        if user_id != 0:
+            where += " AND user_id=$user_id"
+        if tag != "":
+            where += " AND tag=$tag"
+        if date_prefix != "":
+            where += " AND date LIKE $date_prefix"
+        if date_start != "":
+            where += " AND date >= $date_start"
+        if date_end != "":
+            where += " AND date < $date_end"
+
+        vars = dict(user_id=user_id, tag=tag, date_prefix=date_prefix+"%", date_start=date_start, date_end=date_end)
+        return cls.db.select(where=where, vars=vars,offset=offset,limit=limit,order=order)
+    
+    @classmethod
+    def delete_by_id(cls, id=0):
+        return cls.db.delete(where=dict(id=id))
+    
+    @classmethod
+    def get_by_id(cls, id=0):
+        if id == 0:
+            return None
+        result = cls.db.select_first(where=dict(id=id))
+        if result == None:
+            return None
+        return MsgIndex(**result)
+    
+    @classmethod
+    def update_tag(cls, id=0, tag="", sort_value=""):
+        now = xutils.format_datetime()
+        updates = dict()
+        updates["tag"] = tag
+        updates["mtime"] = now
+        if sort_value != "":
+            updates["sort_value"] = sort_value
+        return cls.db.update(where=dict(id=id), **updates)
+    
+    @classmethod
+    def touch(cls, id=0):
+        now = xutils.format_datetime()
+        return cls.db.update(mtime=now, where=dict(id=id))
+    
+    @classmethod
+    def get_first(cls, user_id=0, content="", tag=""):
+        where = "1=1"
+        if user_id != 0:
+            where += " AND user_id=$user_id"
+        if tag != "":
+            where += " AND tag=$tag"
+        vars = dict(user_id=user_id, tag=tag)
+        return cls.db.select_first(where=where, vars=vars)
+
+    @classmethod
+    def iter_batch(cls, user_id=0, batch_size=20):
+        yield from cls.db.iter_batch(batch_size=batch_size, where="user_id=$user_id", vars=dict(user_id=user_id))
+
+class MsgTagInfo(Storage):
+    def __init__(self):
+        self._key = "" # kv的真实key
+        self.id = ""
+        self.ctime = xutils.format_datetime()
+        self.mtime = xutils.format_datetime()
+        self.user = ""
+        self.content=""
+        self.amount=0
+        self.is_marked=False
+        self.visit_cnt=0
+    
+    @staticmethod
+    def from_dict(dict_value):
+        result = new_from_dict(MsgTagInfo, dict_value)
+        result.id = result._key
+        return result
+    
+    @classmethod
+    def from_dict_or_None(cls, dict_value):
+        if dict_value == None:
+            return None
+        return cls.from_dict(dict_value)
+
+class MsgTagInfoDao:
+    """随手记标签元信息表,使用KV存储"""
+    db = dbutil.get_table("msg_key")
+
+    @classmethod
+    def get_first(cls, user="", content=""):
+        where = dict(user=user, content=content)
+        return cls.db.get_first(where=where)
+    
+    @classmethod
+    def get_by_key(cls, key=""):
+        result = cls.db.get_by_key(key)
+        return MsgTagInfo.from_dict_or_None(result)
+    
+    @classmethod
+    def list(cls, user="", offset=0, limit=20, content=None):
+        where = {}
+        if content != None:
+            where["content"] = content
+        return cls.db.list(where=where, user_name=user,offset=offset,limit=limit,reverse=True)
+    
+    @classmethod
+    def update(cls, tag_info: MsgTagInfo):
+        tag_info.mtime = xutils.format_datetime()
+        return cls.db.update(tag_info)
+
+    @classmethod
+    def delete_by_id(cls, id=""):
+        return cls.db.delete_by_id(id=id)
+    
+    @classmethod
+    def delete(cls, obj):
+        return cls.db.delete(obj)
+
+    @classmethod
+    def get_or_create(cls, user="", content=""):
+        item = cls.get_first(user=user, content=content)
+        if item != None:
+            return MsgTagInfo.from_dict(item)
+        else:
+            record = MsgTagInfo()
+            record.user = user
+            record.content = content
+            cls.db.insert(record)
+            record.id = record._key
+            return record
+
+    @classmethod
+    def count(cls, user=""):
+        return cls.db.count(user_name=user)
+
+class MsgTagBindDao:
+
+    tag_bind_service = TagBindService(TagTypeEnum.msg_tag)
+
+    @classmethod
+    def bind_tags(cls, user_id=0, msg_id=0, tags=[]):
+        if user_id == 0:
+            logging.error("user_id=0")
+            return
+        cls.tag_bind_service.bind_tags(user_id=user_id, target_id=msg_id, tags=tags, update_only_changed=True)
+        
+    @classmethod
+    def count_by_key(cls, user_id=0, key=""):
+        assert isinstance(user_id, int)
+        assert isinstance(key, str)
+        return cls.tag_bind_service.count_user_tag(user_id=user_id, tag_code=key)
+
+class MessageDao:
+    """message的主数据接口,使用KV存储"""
+
+    @staticmethod
+    def get_by_id(full_key):
+        return get_message_by_id(full_key)
+    
+    @staticmethod
+    def create(message):
+        return create_message(message)
+    
+    @staticmethod
+    def update(message):
+        return update_message(message)
+    
+    @staticmethod
+    def update_user_tags(message:MessageDO):
+        msg_id = message.get_int_id()
+        MsgTagBindDao.bind_tags(message.user_id, msg_id=msg_id, tags=message.full_keywords)
+    
+    @classmethod
+    def update_tag(cls, message:MessageDO, tag="", sort_value=""):
+        message.tag = tag
+        MsgIndexDao.update_tag(id=int(message._id), tag=tag, sort_value=sort_value)
+        cls.update(message)
+        cls.refresh_message_stat(message.user)
+
+    @staticmethod
+    def delete(full_key):
+        return delete_message_by_id(full_key)
+    
+    @staticmethod
+    def delete_by_key(full_key):
+        return delete_message_by_id(full_key)
+
+    @staticmethod
+    def add_search_history(user, search_key, cost_time=0):
+        return add_search_history(user, search_key, cost_time)
+
+    @staticmethod
+    def add_history(message):
+        return add_message_history(message)
+    
+    @staticmethod
+    def refresh_message_stat(user, tag_list=[]):       
+        return refresh_message_stat(user, tag_list)
+    
+    @staticmethod
+    def get_message_stat(user):
+        return get_message_stat(user)
+    
+    @staticmethod
+    def get_message_tag(user, tag, priority=0):
+        return get_message_tag(user, tag, priority)
+    
+    @classmethod
+    def batch_get_by_index_list(cls, index_list, user_name=""):
+        id_list = []
+        for index in index_list:
+            id_list.append(str(index.id))
+
+        dict_result = _msg_db.batch_get_by_id(id_list, user_name=user_name)
+        result = []
+        for index in index_list:
+            msg = dict_result.get(str(index.id))
+            if msg != None:
+                new_msg = MessageDO.from_dict(msg)
+                new_msg.sort_value = index.sort_value
+                result.append(new_msg)
+        return result
+
+xutils.register_func("message.create", create_message)
+xutils.register_func("message.update", update_message)
+xutils.register_func("message.search", search_message)
+xutils.register_func("message.delete", delete_message_by_id)
+xutils.register_func("message.count", count_message)
+
+xutils.register_func("message.find_by_id", get_message_by_id)
+xutils.register_func("message.get_by_id",  get_message_by_id)
+xutils.register_func("message.get_by_content", get_by_content)
+xutils.register_func("message.get_message_tag", get_message_tag)
+
+xutils.register_func("message.list", list_message_page)
+xutils.register_func("message.list_file", list_file_page)
+xutils.register_func("message.list_link", list_link_page)
+xutils.register_func("message.list_book", list_book_page)
+xutils.register_func("message.list_people", list_people_page)
+xutils.register_func("message.list_phone", list_phone_page)
+xutils.register_func("message.list_task", list_task)
+xutils.register_func("message.list_task_done", list_task_done)
+xutils.register_func("message.list_by_tag",  list_by_tag)
+xutils.register_func("message.list_by_date", list_by_date)
+
+xutils.register_func("message.get_message_stat", get_message_stat)
+xutils.register_func("message.refresh_message_stat", refresh_message_stat)
+xutils.register_func("message.add_search_history", add_search_history)
+xutils.register_func("message.add_history", add_message_history)
```

### Comparing `xnote-web-0.1.0/handlers/message/message.py` & `xnote-web-0.1.1/handlers/message/message.py`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,1081 +1,1081 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2017-05-29 00:00:00
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-07 23:35:01
-@FilePath     : /xnote/handlers/message/message.py
-@Description  : 描述
-"""
-
-"""短消息处理，比如任务、备忘、临时文件等等
-tag: 短消息的类型
-key/keyword: 短消息关键字
-"""
-import time
-import math
-import xutils
-from xnote.core import xauth, xconfig, xmanager, xtemplate
-import logging
-from xutils import BaseRule, Storage, functions, u, SearchResult
-from xutils import dateutil
-from xnote.core.xtemplate import T
-from xutils import netutil, webutil
-from xutils.functions import safe_list
-from xutils.textutil import quote
-from handlers.message.message_task import TaskListHandler
-from handlers.message.message_utils import (
-    process_message,
-    filter_key,
-    filter_msg_list_by_key,
-    format_message_stat,
-    MessageListParser,
-    get_remote_ip,
-    get_length,
-    get_tags_from_message_list,
-    do_split_date,
-    success,
-    failure,
-    convert_message_list_to_day_folder,
-    count_month_size,
-    touch_key_by_content,
-    TagHelper,
-)
-
-from .message_utils import sort_keywords_by_marked
-from . import dao, message_tag, message_search
-from .dao import MessageDao
-from handlers.message import message_utils
-import handlers.message.dao as msg_dao
-
-MSG_DAO = xutils.DAO("message")
-# 消息处理规则
-MSG_RULES = []
-# 默认的标签
-DEFAULT_TAG = "log"
-MAX_LIST_LIMIT = 1000
-# 系统标签
-SYSTEM_TAG_TUPLE = ("book", "people", "file", "phone", "link")
-
-LIST_VIEW_TPL = "message/page/message_list_view.html"
-
-def get_current_message_stat():
-    user_name = xauth.current_name()
-    message_stat = MessageDao.get_message_stat(user_name)
-    return format_message_stat(message_stat)
-
-
-def update_keyword_amount(tag_info: msg_dao.MsgTagInfo, user_name="", key=""):
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    amount = dao.MsgTagBindDao.count_by_key(user_id=user_id, key=key)
-    tag_info.amount = amount
-    if amount == 0:
-        msg_dao.MsgTagInfoDao.delete(tag_info)
-    else:
-        msg_dao.MsgTagInfoDao.update(tag_info)
-    logging.info("user:%s,key:%s,amount:%s", user_name, key, amount)
-
-
-@xutils.timeit(name="message.refresh", logfile=True)
-def refresh_key_amount():
-    pass
-
-
-def refresh_message_index():
-    """刷新随手记的索引"""
-    pass
-
-
-def get_page_max(amount, pagesize=None):
-    if pagesize is None:
-        pagesize = xconfig.PAGE_SIZE
-    return math.ceil(amount / pagesize)
-
-
-def get_offset_from_page(page, pagesize=None):
-    if pagesize is None:
-        pagesize = xconfig.PAGE_SIZE
-
-    offset = (page - 1) * pagesize
-    return max(offset, 0)
-
-
-def after_message_create_or_update(msg_item):
-    assert isinstance(msg_item, dao.MessageDO)
-    process_message(msg_item)
-
-    if get_length(msg_item.full_keywords) == 0:
-        msg_item.no_tag = True
-        msg_item.keywords = None
-        MessageDao.update(msg_item)
-    else:
-        MessageDao.update_user_tags(msg_item)
-
-    after_upsert(msg_item)
-
-def after_message_delete(msg_item):
-    process_message(msg_item)
-    after_upsert(msg_item)
-
-def after_upsert(msg_item):
-    """插入或者更新异步处理"""
-    user_name = msg_item.user
-
-    for keyword in safe_list(msg_item.keywords):
-        # 只自动创建标准的tag
-        if not message_utils.is_standard_tag(keyword):
-            continue
-        message = get_or_create_keyword(user_name, keyword, msg_item.ip)
-        update_keyword_amount(message, user_name, keyword)
-
-class ListAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        pagesize = xutils.get_argument_int("pagesize", xconfig.PAGE_SIZE)
-        page = xutils.get_argument_int("page", 1)
-        tag = xutils.get_argument_str("tag", "task")
-        format = xutils.get_argument_str("format")
-        offset = get_offset_from_page(page, pagesize)
-
-        assert isinstance(tag, str)
-
-        user_name = xauth.get_current_name()
-
-        chatlist, amount = self.do_list_message(
-            user_name, tag, offset, pagesize)
-
-        page_max = get_page_max(amount, pagesize)
-
-        parser = MessageListParser(chatlist, tag=tag)
-        parser.parse()
-        chatlist = parser.get_message_list()
-
-        if format == "html":
-            return self.do_get_html(chatlist, page, page_max, tag)
-
-        return dict(code="success", message="",
-                    data=chatlist,
-                    keywords=parser.get_keywords(),
-                    amount=amount,
-                    page_max=page_max,
-                    pagesize=pagesize,
-                    current_user=xauth.current_name())
-
-    def do_list_message(self, user_name, tag, offset, pagesize):
-        key = xutils.get_argument_str("key", "")
-        date = xutils.get_argument_str("date", "")
-        filter_date = xutils.get_argument_str("filterDate", "")
-
-        if tag == "task.search":
-            return self.do_search(user_name, key, offset, pagesize,search_tags=["task"])
-        
-        if tag == "done.search":
-            return self.do_search(user_name, key, offset, pagesize, search_tags=["done"])
-
-        if (tag in ("search", "log.search")) or (key != "" and key != None):
-            # 搜索
-            return self.do_search(user_name, key, offset, pagesize, search_tags=["log"])
-
-        if tag in ("date", "log.date"):
-            # 日期
-            return self.do_list_by_date(user_name, date, offset, pagesize)
-
-        if filter_date != "":
-            return self.do_list_by_date(user_name, filter_date, offset, pagesize)
-
-        if tag == "task":
-            return self.do_list_task(user_name, offset, pagesize)
-
-        if tag == "key":
-            orderby = xutils.get_argument_str("orderby", "amount_desc")
-            return message_tag.list_message_tags(user_name, offset, pagesize, orderby = orderby, only_standard=True)
-
-        list_func = xutils.lookup_func("message.list_%s" % tag)
-        if list_func != None:
-            return list_func(user_name, offset, pagesize)
-        else:
-            return msg_dao.list_by_tag(user_name, tag, offset, pagesize)
-
-    def do_get_html(self, msg_list, page: int, page_max: int, tag="task"):
-        show_todo_check = True
-        show_edit_btn = True
-        show_to_log_btn = False
-        display_tag = xutils.get_argument("displayTag", "")
-        date = xutils.get_argument("date", "")
-        key = xutils.get_argument("key", "")
-        filter_key = xutils.get_argument("filterKey", "")
-        orderby = xutils.get_argument("orderby", "")
-        p = xutils.get_argument("p", "")
-        xutils.get_argument_bool("show_marked_tag", True)
-
-        show_edit_btn = (p != "done")
-
-        if tag == "todo" or tag == "task":
-            show_todo_check = True
-            show_to_log_btn = True
-
-        if tag == "done":
-            show_to_log_btn = True
-
-        if tag == "key":
-            show_edit_btn = False
-
-        if tag == "key":
-            template_file = "message/ajax/message_tag_ajax.html"
-        else:
-            template_file = "message/ajax/message_ajax.html"
-
-        params = dict(
-            tag=tag,
-            displayTag=display_tag,
-            key=key,
-            date=date,
-            filterKey=filter_key,
-            orderby=orderby,
-            p=p,
-        )
-
-        page_url = "?" + \
-            netutil.build_query_string(
-                params=params, skip_empty_value=True) + "&page="
-
-        kw = Storage(
-            show_todo_check=show_todo_check,
-            show_edit_btn=show_edit_btn,
-            show_to_log_btn=show_to_log_btn,
-            page=page,
-            page_url=page_url,
-            page_max=page_max,
-            item_list=msg_list
-        )
-
-        if tag == "key":
-            user_name = xauth.current_name()
-            assert isinstance(user_name, str)
-            kw.top_keywords = []
-            if orderby == "amount_desc" and page == 1:
-                kw.recent_keywords = message_tag.get_recent_keywords(user_name, tag = tag)
-                
-        return xtemplate.render(template_file, **kw)
-    
-    def get_top_keywords(self, msg_list):
-        """返回热门的标签"""
-        result = []
-        for item in msg_list:
-            if item.is_marked:
-                result.append(item)
-        return result
-
-    def do_search(self, user_name, key, offset, pagesize, search_tags=None):
-        # 搜索
-        no_tag = False
-
-        input_search_tags = xutils.get_argument_str("searchTags")
-        input_no_tag = xutils.get_argument("noTag", "false")
-        p = xutils.get_argument("p", "")
-        date = xutils.get_argument_str("date")
-
-        if search_tags == None:
-            if input_search_tags != "":
-                search_tags = input_search_tags.split(",")
-            if p == "task":
-                search_tags = ["task"]
-            if p == "done":
-                search_tags = ["done"]
-            if p == "log":
-                search_tags = ["log"]
-
-        if input_no_tag == "true":
-            no_tag = True
-
-        searcher = message_search.SearchHandler()
-        return searcher.get_ajax_data(user_name=user_name, key=key, offset=offset,
-                                      limit=pagesize, search_tags=search_tags,
-                                      no_tag=no_tag, date=date)
-
-    def do_list_task(self, user_name, offset, limit):
-        p = xutils.get_argument("p", "")
-        filter_key = xutils.get_argument("filterKey", "")
-        status = xutils.get_argument("status", "")
-
-        if p == "done":
-            return msg_dao.list_task_done(user_name, offset, limit)
-
-        if filter_key != "":
-            msg_list, amount = msg_dao.list_task(
-                user_name, offset=0, limit=MAX_LIST_LIMIT)
-            msg_list = filter_msg_list_by_key(msg_list, filter_key)
-            return msg_list[offset:offset+limit], len(msg_list)
-        else:
-            return msg_dao.list_task(user_name, offset, limit)
-
-    def do_list_by_date(self, user_name, date, offset, pagesize):
-        filter_key = xutils.get_argument_str("filterKey", "")
-
-        if filter_key != "":
-            msg_list, amount = msg_dao.list_by_date(
-                user_name, date, 0, MAX_LIST_LIMIT)
-            msg_list = filter_msg_list_by_key(msg_list, filter_key)
-            return msg_list[offset:offset+pagesize], len(msg_list)
-        else:
-            return msg_dao.list_by_date(user_name, date, offset, pagesize)
-
-
-def update_message_status(id, status):
-    user_name = xauth.current_name()
-    data = MessageDao.get_by_id(id)
-    if data and data.user == user_name:
-        data.status = status
-        data.mtime = xutils.format_datetime()
-
-        MessageDao.update(data)
-        MessageDao.refresh_message_stat(user_name, ["task", "done"])
-
-        event = Storage(id=id, user=user_name,
-                        status=status, content=data.content)
-        xmanager.fire("message.updated", event)
-        xmanager.fire("message.update", event)
-        return dict(code="success")
-    else:
-        return failure(message="无操作权限")
-
-
-def update_message_content(id, user_name, content):
-    data = MessageDao.get_by_id(id)
-    if data and data.user == user_name:
-        if data.user_id == 0:
-            data.user_id = xauth.UserDao.get_id_by_name(user_name)
-            
-        # 先保存历史
-        MessageDao.add_history(data)
-        
-        data.content = content
-        data.mtime = xutils.format_datetime()
-        data.version = data.get('version', 0) + 1
-        MessageDao.update(data)
-
-        xmanager.fire("message.update", dict(
-            id=id, user=user_name, content=content))
-
-        after_message_create_or_update(data)
-
-
-def create_done_message(old_message):
-    old_id = old_message['id']
-
-    new_message = dao.MessageDO()
-    new_message.ref = old_id
-    new_message.tag = 'done'
-    new_message.user = old_message['user']
-    new_message.ctime = xutils.format_datetime()
-    MessageDao.create(new_message)
-
-
-def update_message_tag(id, tag):
-    """更新message的tag字段"""
-    user_name = xauth.current_name()
-    data = MessageDao.get_by_id(id)
-    if data == None:
-        return webutil.FailedResult(message="数据不存在")
-    if data.user != user_name:
-        return webutil.FailedResult(message="无权操作")
-    
-    # 修复status数据，全部采用tag
-    data.pop("status", None)
-    data.tag = tag
-    data.mtime = xutils.format_datetime()
-    data.sort_value = data.mtime
-    need_update = True
-    
-    if tag == "done":
-        # 任务完成时除了标记原来任务的完成时间，还要新建一条消息
-        data.done_time = xutils.format_datetime()
-        data.mtime = xutils.format_datetime()
-        data.append_comment("$mark_task_done$")
-    
-    if tag == "task":
-        # 重新开启任务
-        data.append_comment("$reopen_task$")
-
-        ref = data.ref
-        origin_data = MessageDao.get_by_id(ref)
-        if origin_data != None:
-            # 更新原始任务后删除当前的完成记录
-            origin_data.append_comment("$reopen_task$")
-            MessageDao.update_tag(origin_data, tag, sort_value = origin_data.sort_value)
-            MessageDao.delete_by_key(data.id)
-            need_update = False
-    
-    if need_update:    
-        MessageDao.update_tag(data, tag, sort_value=data.sort_value)
-
-    xmanager.fire("message.updated", Storage(
-        id=id, user=user_name, tag=tag, content=data.content))
-
-    return webutil.SuccessResult()
-
-
-class FinishMessageAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument("id")
-        if id == "":
-            return
-        return update_message_tag(id, "done")
-
-
-class OpenMessageAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument("id")
-        if id == "":
-            return
-        return update_message_tag(id, "task")
-
-
-class UpdateTagAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id")
-        tag = xutils.get_argument_str("tag")
-        if id == "":
-            return webutil.FailedResult(code="404", message="id为空")
-
-        if tag in ("task", "cron", "log", "key", "done"):
-            return update_message_tag(id, tag)
-        else:
-            return webutil.FailedResult(message="无效的标签: %s" % tag)
-
-class TouchAjaxHandler:
-
-    def do_touch_by_id(self, id):
-        msg = MessageDao.get_by_id(id)
-        if msg is None:
-            return failure(message="message not found, id:%s" % id)
-        if msg.user != xauth.current_name():
-            return failure(message="not authorized")
-        msg.mtime = xutils.format_datetime()
-        MessageDao.update(msg)
-        return success()
-
-    def do_touch_by_key(self, key):
-        user_name = xauth.current_name()
-        touch_key_by_content(user_name, "key", key)
-        return success()
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument("id")
-        key = xutils.get_argument("key")
-
-        if id != None and id != "":
-            return self.do_touch_by_id(id)
-        elif key != "":
-            return self.do_touch_by_key(key)
-        else:
-            return failure(message="id or key is missing")
-
-
-class DeleteAjaxHandler:
-
-    def delete_msg(self, msg: msg_dao.MessageDO):
-        if msg.user != xauth.current_name():
-            return dict(code="fail", message="no permission")
-
-        # 先保存历史
-        MessageDao.add_history(msg)
-
-        # 删除并刷新统计信息
-        MessageDao.delete_by_key(msg.id)
-        if msg.tag == "done" and msg.ref != None:
-            MessageDao.delete_by_key(msg.ref)
-            
-        MessageDao.refresh_message_stat(msg.user, [msg.tag])
-        after_message_delete(msg)
-
-        return webutil.SuccessResult()
-    
-    def delete_tag(self, tag_info: msg_dao.MsgTagInfo):
-        if tag_info.user != xauth.current_name_str():
-            return webutil.FailedResult(message="no permission")
-        
-        msg_dao.MsgTagInfoDao.delete(tag_info)
-        return webutil.SuccessResult()
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id")
-        if id == "":
-            return failure(message="id为空")
-
-        try:
-            msg = MessageDao.get_by_id(id)
-            if msg != None:
-                return self.delete_msg(msg)
-            tag_info = msg_dao.MsgTagInfoDao.get_by_key(id)
-            if tag_info != None:
-                return self.delete_tag(tag_info)
-            return webutil.FailedResult(message="数据不存在")
-        except:
-            xutils.print_exc()
-            return webutil.FailedResult(message="删除失败")
-
-
-class CalendarRule(BaseRule):
-
-    def execute(self, ctx, date, month, day):
-        print(date, month, day)
-        ctx.type = "calendar"
-
-
-def create_message(user_name, tag, content, ip):
-    assert isinstance(user_name, str)
-    assert isinstance(tag, str)
-    assert isinstance(content, str)
-
-    date = xutils.get_argument_str("date", xutils.format_date())
-    content = content.strip()
-    ctime = xutils.format_datetime()
-
-    message = dao.MessageDO()
-    message.user = user_name
-    message.user_id = xauth.UserDao.get_id_by_name(user_name)
-    message.tag = tag
-    message.ip = ip
-    message.date = date
-    message.ctime = ctime
-    message.mtime = ctime
-    message.content = content
-    message.sort_value = ctime
-    
-    id = MessageDao.create(message)
-    MessageDao.refresh_message_stat(user_name, [message.tag])
-
-    created_msg = MessageDao.get_by_id(id)
-    assert created_msg != None
-    
-    after_message_create_or_update(created_msg)
-
-    create_event = dict(id=id, user=user_name, content=content, ctime=ctime)
-    xmanager.fire('message.add', create_event)
-    xmanager.fire('message.create', create_event)
-
-    return message
-
-def get_or_create_keyword(user_name, content="", ip=""):
-    return msg_dao.MsgTagInfoDao.get_or_create(user_name, content)
-
-class SaveAjaxHandler:
-
-    def apply_rules(self, user_name, id, tag, content):
-        global MSG_RULES
-        ctx = Storage(id=id, content=content, user=user_name, type="")
-        for rule in MSG_RULES:
-            rule.match_execute(ctx, content)
-
-    @xauth.login_required()
-    def do_post(self):
-        id = xutils.get_argument("id")
-        content = xutils.get_argument_str("content")
-        tag = xutils.get_argument_str("tag", DEFAULT_TAG)
-        location = xutils.get_argument_str("location", "")
-        user_name = xauth.get_current_name()
-        ip = get_remote_ip()
-
-        if content == "":
-            return dict(code="fail", message="输入内容为空!")
-        
-        tag = TagHelper.get_create_tag(tag)
-
-        # 对消息进行语义分析处理，后期优化把所有规则统一管理起来
-        self.apply_rules(user_name, id, tag, content)
-
-        if id == "" or id is None:
-            message = create_message(user_name, tag, content, ip)
-            return webutil.SuccessResult(data=message)
-        else:
-            update_message_content(id, user_name, content)
-        return webutil.SuccessResult(data=dict(id=id))
-
-    def POST(self):
-        try:
-            return self.do_post()
-        except Exception as e:
-            xutils.print_exc()
-            return webutil.FailedResult(code="fail", message=str(e))
-
-
-class DateAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        date = xutils.get_argument_str("date", "")
-        page = xutils.get_argument("page", 1, type=int)
-        filter_key = xutils.get_argument_str("filterKey")
-        user_id = xauth.current_user_id()
-
-        if date == "":
-            return xtemplate.render("error.html", error="date参数为空")
-
-        offset = get_offset_from_page(page)
-        limit = xconfig.PAGE_SIZE
-
-        msg_list, msg_count = message_utils.list_by_date_and_key(
-            user_id=user_id, month=date, offset=offset, limit=limit, filter_key=filter_key)
-
-        parser = MessageListParser(msg_list)
-        parser.parse()
-
-        page_max = get_page_max(msg_count, xconfig.PAGE_SIZE)
-
-        return xtemplate.render("message/ajax/message_ajax.html",
-                                page_max=page_max,
-                                page=page,
-                                page_url=f"?date={date}&filterKey={quote(filter_key)}&page=",
-                                item_list=msg_list)
-
-class MessageListHandler:
-
-    @xauth.login_required()
-    def do_get(self, tag="task"):
-        """随手记/待办的入口
-        xxx_page 返回页面
-        xxx_data 返回数据
-        """
-        user = xauth.current_name()
-        key = xutils.get_argument("key", "")
-        from_ = xutils.get_argument("from", "")
-        type_ = xutils.get_argument("type", "")
-        show_tab = xutils.get_argument_bool("show_tab", True)
-        op = xutils.get_argument("op", "")
-        date = xutils.get_argument("date", "")
-        p = xutils.get_argument("p", "")
-
-        # 记录日志
-        assert isinstance(user, str)
-        xmanager.add_visit_log(user, "/message?tag=%s" % tag)
-
-        if tag == "month_tags":
-            return self.do_view_month_tags()
-
-        if tag in ("date", "log.date"):
-            return self.do_view_by_date(date)
-
-        if tag == "key" and op == "select":
-            return self.do_select_key()
-
-        if tag == "api.tag_list":
-            return self.get_tag_list()
-
-        if tag == "key":
-            return self.get_log_tags_page()
-
-        if tag == "task":
-            return self.get_task_page()
-
-        if tag == "task.tags":
-            return TaskListHandler.get_task_taglist_page()
-
-        if tag in ("search", "task.search", "done.search") or type_ == "search":
-            return message_search.SearchHandler().get_page()
-
-        if tag == "log.tags":
-            return self.get_log_tags_page()
-        
-        return self.get_log_page()
-
-    def do_select_key(self):
-        user_name = xauth.current_name()
-        offset = 0
-        msg_list, amount = dao.list_by_tag(
-            user_name, "key", offset, MAX_LIST_LIMIT)
-
-        return xtemplate.render("message/page/message_tag_select.html",
-                                msg_list=msg_list,
-                                show_nav=False)
-    
-    def get_tag_list(self):
-        return message_tag.get_tag_list()
-
-    def get_log_tags_page(self):
-        sys_tag = xutils.get_argument_str("sys_tag")
-        if sys_tag in SYSTEM_TAG_TUPLE:
-            return self.get_system_tag_page(sys_tag)
-
-        return message_tag.get_log_tags_page()
-
-    def get_system_tag_page(self, tag):
-        kw = Storage(
-            message_tag=tag,
-            search_type="message",
-            show_input_box=False,
-            show_side_tags=False,
-        )
-
-        return xtemplate.render("message/page/message_list_view.html", **kw)
-
-    def get_task_kw(self):
-        return TaskListHandler.get_task_kw()
-
-    def get_task_page(self):
-        filter_key = xutils.get_argument_str("filterKey", "")
-        page_name = xutils.get_argument_str("p", "")
-
-        if page_name == "create":
-            return TaskListHandler.get_task_create_page()
-
-        if page_name == "done":
-            return TaskListHandler.get_task_done_page()
-
-        if page_name == "taglist":
-            return TaskListHandler.get_task_taglist_page()
-
-        if filter_key != "":
-            return TaskListHandler.get_task_by_keyword_page(filter_key)
-        else:
-            # 任务的首页
-            return TaskListHandler.get_task_create_page()
-
-    def get_task_home_page(self):
-        return TaskListHandler.get_task_create_page()
-
-    def do_view_month_tags(self):
-        user_name = xauth.current_name()
-        date = xutils.get_argument_str("date")
-
-        year, month, mday = do_split_date(date)
-
-        msg_list, amount = msg_dao.list_by_date(
-            user_name, date, limit=MAX_LIST_LIMIT)
-
-        tag_list = get_tags_from_message_list(msg_list, "date", date)
-
-        return xtemplate.render("message/page/message_tag_view.html",
-                                year=year,
-                                month=month,
-                                message_tag="calendar",
-                                search_type="message",
-                                show_back_btn=True,
-                                tag_list=tag_list,
-                                html_title=T("待办任务"),
-                                message_placeholder="添加待办任务")
-
-    def get_log_page(self):
-        key = xutils.get_argument("key", "")
-        input_tag = xutils.get_argument("tag", "log")
-        p = xutils.get_argument("p", "")
-        user_name = xauth.current_name()
-        default_content = filter_key(key)
-
-        kw = Storage(
-            tag=input_tag,
-            message_tag=input_tag,
-            search_type="message",
-            show_system_tag=False,
-            show_side_system_tags=True,
-            show_sub_link=False,
-            html_title=T("随手记"),
-            default_content=default_content,
-            show_back_btn=False,
-            message_tab="log",
-            message_placeholder="记录发生的事情/产生的想法",
-            side_tags=message_utils.list_hot_tags(user_name, 20),
-        )
-
-        kw.search_ext_dict = dict(tag="log.search")
-
-        return xtemplate.render("message/page/message_list_view.html", **kw)
-
-    def do_view_by_date(self, date):
-        kw = Storage()
-        kw.message_placeholder = "补充%s发生的事情" % date
-
-        filter_key = xutils.get_argument("filterKey", "")
-        if filter_key != "":
-            kw.show_input_box = False
-
-        return xtemplate.render("message/page/message_list_view.html",
-                                tag="date",
-                                message_tag="date",
-                                search_type="message",
-                                show_system_tag=False,
-                                show_sub_link=False,
-                                html_title=T("随手记"),
-                                show_back_btn=True,
-                                **kw)
-
-    def GET(self):
-        tag = xutils.get_argument_str("tag")
-        return self.do_get(tag)
-
-class MessageDetailAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        id = xutils.get_argument_str("id")
-        user_name = xauth.current_name_str()
-        detail = msg_dao.get_message_by_id(id, user_name=user_name)
-        if detail == None:
-            return webutil.FailedResult(message="数据不存在")
-
-        if detail.ref != None:
-            detail = msg_dao.get_message_by_id(detail.ref, user_name=user_name)
-        
-        return dict(code="success", data = detail)
-
-class CalendarHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_id = xauth.current_user_id()
-        date = xutils.get_argument("date")
-
-        year, month, mday = do_split_date(date)
-
-        date = "%s-%02d" % (year, month)
-
-        kw = Storage()
-        kw.tag = "log.date"
-        kw.year = year
-        kw.month = month
-        kw.date = date
-        kw.html_title = T("随手记")
-        kw.search_type = "message"
-        kw.tag_list = message_tag.get_tag_list_by_month(user_id=user_id, month=date)
-
-        return xtemplate.render("message/page/message_calendar.html", **kw)
-
-
-class StatAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user = xauth.current_name_str()
-        stat = msg_dao.get_message_stat(user)
-        format_message_stat(stat)
-        return stat
-
-
-class MessageHandler(MessageListHandler):
-    pass
-
-
-class MessageLogHandler(MessageHandler):
-
-    def GET(self):
-        return self.do_get("log")
-
-
-class TodoHandler(MessageHandler):
-
-    @xauth.login_required()
-    def do_get(self, tag="todo", title="待办任务", show_input_box=True):
-        user_name = xauth.current_name()
-        assert isinstance(user_name, str)
-        message_stat = msg_dao.get_message_stat(user_name)
-        xmanager.add_visit_log(user_name, "/message/todo")
-
-        return xtemplate.render("message/page/message_todo.html",
-                                search_type="task",
-                                tag=tag,
-                                title=T(title),
-                                show_input_box=show_input_box,
-                                message_stat=message_stat)
-
-    def GET(self):
-        return self.do_get("todo")
-
-
-class TodoDoneHandler(TodoHandler):
-
-    def GET(self):
-        return self.do_get("done", "已完成任务", show_input_box=False)
-
-
-class TodoCanceledHandler(TodoHandler):
-
-    def GET(self):
-        return self.do_get("canceled", "已取消任务", show_input_box=False)
-
-
-def get_default_year_and_month():
-    return dateutil.format_date(None, "%Y-%m")
-
-
-class MessageListByDayHandler():
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name()
-        date = xutils.get_argument("date", "")
-        show_empty = xutils.get_argument("show_empty", True, type=bool)
-
-        if date == "":
-            date = get_default_year_and_month()
-
-        year, month, day = do_split_date(date)
-
-        item_list, amount = msg_dao.list_by_date(
-            user_name, date, limit=MAX_LIST_LIMIT)
-        message_list = convert_message_list_to_day_folder(
-            item_list, date, True)
-        
-        kw = Storage()
-        kw.tag = "log.date"
-        kw.search_type = "message"
-        kw.search_ext_dict = dict(tag="log.search")
-
-        return xtemplate.render("message/page/message_list_by_day.html",
-                                date=date,
-                                year=year,
-                                month=month,
-                                message_list=message_list,
-                                show_empty=show_empty,
-                                show_back_btn=True,
-                                month_size=count_month_size(message_list),
-                                **kw)
-
-
-class MessageRefreshHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        refresh_key_amount()
-        refresh_message_index()
-        return "success"
-
-
-class MessageKeywordAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        keyword = xutils.get_argument_str("keyword")
-        action = xutils.get_argument_str("action")
-
-        assert keyword != ""
-        assert action != ""
-
-        if action in ("mark", "unmark"):
-            return self.do_mark_or_unmark(keyword, action)
-
-        return dict(code="404", message="指定动作不存在")
-
-    def do_mark_or_unmark(self, keyword, action):
-        user_name = xauth.current_name_str()
-        tag_info = msg_dao.MsgTagInfoDao.get_or_create(user=user_name, content=keyword)
-        assert tag_info != None
-
-        if action == "unmark":
-            tag_info.is_marked = False
-        else:
-            tag_info.is_marked = True
-
-        msg_dao.MsgTagInfoDao.update(tag_info)
-        
-        return dict(code="success")
-
-xutils.register_func("message.process_message", process_message)
-xutils.register_func("message.get_current_message_stat",
-                     get_current_message_stat)
-xutils.register_func("url:/message/log", MessageLogHandler)
-
-
-MSG_RULES = [
-    CalendarRule(r"(\d+)年(\d+)月(\d+)日"),
-]
-
-class CreateCommentHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id")
-        content = xutils.get_argument_str("content")
-
-        if content == "":
-            return webutil.FailedResult(message="备注内容不能为空")
-
-        user_name = xauth.current_name_str()
-        msg = dao.get_message_by_id(id, user_name=user_name)
-        if msg == None:
-            return webutil.FailedResult(message="随手记不存在")
-        comment = dao.MessageComment()
-        comment.content = content
-        msg.comments.append(comment)
-        
-        dao.update_message(msg)
-        return webutil.SuccessResult()
-
-
-class DeleteCommentHandler:
-    
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id")
-        time_str = xutils.get_argument_str("time")
-
-        if time_str == "":
-            return webutil.FailedResult(message="备注时间不能为空")
-        user_name = xauth.current_name_str()
-        msg = dao.get_message_by_id(id, user_name=user_name)
-        if msg == None:
-            return webutil.FailedResult(message="随手记不存在")
-        
-        new_comments = []
-        for comment in msg.comments:
-            if comment.get("time") != time_str:
-                new_comments.append(comment)
-        
-        msg.comments = new_comments
-        dao.update_message(msg)
-        return webutil.SuccessResult()
-    
-class ListCommentHandler:
-    
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id")
-        user_name = xauth.current_name_str()
-        msg = dao.get_message_by_id(id, user_name=user_name)
-        if msg == None:
-            return webutil.FailedResult(message="随手记不存在")
-        
-        comments = list(reversed(msg.comments))
-        return webutil.SuccessResult(data=comments)
-
-
-xurls = (
-    r"/message", MessageHandler,
-    r"/message/calendar", CalendarHandler,
-    r"/message/todo", TodoHandler,
-    r"/message/log", MessageLogHandler,
-    r"/message/done", TodoDoneHandler,
-    r"/message/canceled", TodoCanceledHandler,
-    r"/message/detail", MessageDetailAjaxHandler,
-
-    # 日记
-    r"/message/dairy", MessageListByDayHandler,
-    r"/message/list_by_day", MessageListByDayHandler,
-
-    r"/message/refresh", MessageRefreshHandler,
-    
-    # Ajax处理
-    r"/message/list", ListAjaxHandler,
-    r"/message/date", DateAjaxHandler,
-    r"/message/stat", StatAjaxHandler,
-    r"/message/save", SaveAjaxHandler,
-    r"/message/delete", DeleteAjaxHandler,
-    r"/message/update", SaveAjaxHandler,
-    r"/message/open", OpenMessageAjaxHandler,
-    r"/message/finish", FinishMessageAjaxHandler,
-    r"/message/touch", TouchAjaxHandler,
-    r"/message/tag", UpdateTagAjaxHandler,
-    r"/message/keyword", MessageKeywordAjaxHandler,
-    r"/message/comment/create", CreateCommentHandler,
-    r"/message/comment/delete", DeleteCommentHandler,
-    r"/message/comment/list", ListCommentHandler,
-)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2017-05-29 00:00:00
+@LastEditors  : xupingmao
+@LastEditTime : 2024-03-07 23:35:01
+@FilePath     : /xnote/handlers/message/message.py
+@Description  : 描述
+"""
+
+"""短消息处理，比如任务、备忘、临时文件等等
+tag: 短消息的类型
+key/keyword: 短消息关键字
+"""
+import time
+import math
+import xutils
+from xnote.core import xauth, xconfig, xmanager, xtemplate
+import logging
+from xutils import BaseRule, Storage, functions, u, SearchResult
+from xutils import dateutil
+from xnote.core.xtemplate import T
+from xutils import netutil, webutil
+from xutils.functions import safe_list
+from xutils.textutil import quote
+from handlers.message.message_task import TaskListHandler
+from handlers.message.message_utils import (
+    process_message,
+    filter_key,
+    filter_msg_list_by_key,
+    format_message_stat,
+    MessageListParser,
+    get_remote_ip,
+    get_length,
+    get_tags_from_message_list,
+    do_split_date,
+    success,
+    failure,
+    convert_message_list_to_day_folder,
+    count_month_size,
+    touch_key_by_content,
+    TagHelper,
+)
+
+from .message_utils import sort_keywords_by_marked
+from . import dao, message_tag, message_search
+from .dao import MessageDao
+from handlers.message import message_utils
+import handlers.message.dao as msg_dao
+
+MSG_DAO = xutils.DAO("message")
+# 消息处理规则
+MSG_RULES = []
+# 默认的标签
+DEFAULT_TAG = "log"
+MAX_LIST_LIMIT = 1000
+# 系统标签
+SYSTEM_TAG_TUPLE = ("book", "people", "file", "phone", "link")
+
+LIST_VIEW_TPL = "message/page/message_list_view.html"
+
+def get_current_message_stat():
+    user_name = xauth.current_name()
+    message_stat = MessageDao.get_message_stat(user_name)
+    return format_message_stat(message_stat)
+
+
+def update_keyword_amount(tag_info: msg_dao.MsgTagInfo, user_name="", key=""):
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    amount = dao.MsgTagBindDao.count_by_key(user_id=user_id, key=key)
+    tag_info.amount = amount
+    if amount == 0:
+        msg_dao.MsgTagInfoDao.delete(tag_info)
+    else:
+        msg_dao.MsgTagInfoDao.update(tag_info)
+    logging.info("user:%s,key:%s,amount:%s", user_name, key, amount)
+
+
+@xutils.timeit(name="message.refresh", logfile=True)
+def refresh_key_amount():
+    pass
+
+
+def refresh_message_index():
+    """刷新随手记的索引"""
+    pass
+
+
+def get_page_max(amount, pagesize=None):
+    if pagesize is None:
+        pagesize = xconfig.PAGE_SIZE
+    return math.ceil(amount / pagesize)
+
+
+def get_offset_from_page(page, pagesize=None):
+    if pagesize is None:
+        pagesize = xconfig.PAGE_SIZE
+
+    offset = (page - 1) * pagesize
+    return max(offset, 0)
+
+
+def after_message_create_or_update(msg_item):
+    assert isinstance(msg_item, dao.MessageDO)
+    process_message(msg_item)
+
+    if get_length(msg_item.full_keywords) == 0:
+        msg_item.no_tag = True
+        msg_item.keywords = None
+        MessageDao.update(msg_item)
+    else:
+        MessageDao.update_user_tags(msg_item)
+
+    after_upsert(msg_item)
+
+def after_message_delete(msg_item):
+    process_message(msg_item)
+    after_upsert(msg_item)
+
+def after_upsert(msg_item):
+    """插入或者更新异步处理"""
+    user_name = msg_item.user
+
+    for keyword in safe_list(msg_item.keywords):
+        # 只自动创建标准的tag
+        if not message_utils.is_standard_tag(keyword):
+            continue
+        message = get_or_create_keyword(user_name, keyword, msg_item.ip)
+        update_keyword_amount(message, user_name, keyword)
+
+class ListAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        pagesize = xutils.get_argument_int("pagesize", xconfig.PAGE_SIZE)
+        page = xutils.get_argument_int("page", 1)
+        tag = xutils.get_argument_str("tag", "task")
+        format = xutils.get_argument_str("format")
+        offset = get_offset_from_page(page, pagesize)
+
+        assert isinstance(tag, str)
+
+        user_name = xauth.get_current_name()
+
+        chatlist, amount = self.do_list_message(
+            user_name, tag, offset, pagesize)
+
+        page_max = get_page_max(amount, pagesize)
+
+        parser = MessageListParser(chatlist, tag=tag)
+        parser.parse()
+        chatlist = parser.get_message_list()
+
+        if format == "html":
+            return self.do_get_html(chatlist, page, page_max, tag)
+
+        return dict(code="success", message="",
+                    data=chatlist,
+                    keywords=parser.get_keywords(),
+                    amount=amount,
+                    page_max=page_max,
+                    pagesize=pagesize,
+                    current_user=xauth.current_name())
+
+    def do_list_message(self, user_name, tag, offset, pagesize):
+        key = xutils.get_argument_str("key", "")
+        date = xutils.get_argument_str("date", "")
+        filter_date = xutils.get_argument_str("filterDate", "")
+
+        if tag == "task.search":
+            return self.do_search(user_name, key, offset, pagesize,search_tags=["task"])
+        
+        if tag == "done.search":
+            return self.do_search(user_name, key, offset, pagesize, search_tags=["done"])
+
+        if (tag in ("search", "log.search")) or (key != "" and key != None):
+            # 搜索
+            return self.do_search(user_name, key, offset, pagesize, search_tags=["log"])
+
+        if tag in ("date", "log.date"):
+            # 日期
+            return self.do_list_by_date(user_name, date, offset, pagesize)
+
+        if filter_date != "":
+            return self.do_list_by_date(user_name, filter_date, offset, pagesize)
+
+        if tag == "task":
+            return self.do_list_task(user_name, offset, pagesize)
+
+        if tag == "key":
+            orderby = xutils.get_argument_str("orderby", "amount_desc")
+            return message_tag.list_message_tags(user_name, offset, pagesize, orderby = orderby, only_standard=True)
+
+        list_func = xutils.lookup_func("message.list_%s" % tag)
+        if list_func != None:
+            return list_func(user_name, offset, pagesize)
+        else:
+            return msg_dao.list_by_tag(user_name, tag, offset, pagesize)
+
+    def do_get_html(self, msg_list, page: int, page_max: int, tag="task"):
+        show_todo_check = True
+        show_edit_btn = True
+        show_to_log_btn = False
+        display_tag = xutils.get_argument("displayTag", "")
+        date = xutils.get_argument("date", "")
+        key = xutils.get_argument("key", "")
+        filter_key = xutils.get_argument("filterKey", "")
+        orderby = xutils.get_argument("orderby", "")
+        p = xutils.get_argument("p", "")
+        xutils.get_argument_bool("show_marked_tag", True)
+
+        show_edit_btn = (p != "done")
+
+        if tag == "todo" or tag == "task":
+            show_todo_check = True
+            show_to_log_btn = True
+
+        if tag == "done":
+            show_to_log_btn = True
+
+        if tag == "key":
+            show_edit_btn = False
+
+        if tag == "key":
+            template_file = "message/ajax/message_tag_ajax.html"
+        else:
+            template_file = "message/ajax/message_ajax.html"
+
+        params = dict(
+            tag=tag,
+            displayTag=display_tag,
+            key=key,
+            date=date,
+            filterKey=filter_key,
+            orderby=orderby,
+            p=p,
+        )
+
+        page_url = "?" + \
+            netutil.build_query_string(
+                params=params, skip_empty_value=True) + "&page="
+
+        kw = Storage(
+            show_todo_check=show_todo_check,
+            show_edit_btn=show_edit_btn,
+            show_to_log_btn=show_to_log_btn,
+            page=page,
+            page_url=page_url,
+            page_max=page_max,
+            item_list=msg_list
+        )
+
+        if tag == "key":
+            user_name = xauth.current_name()
+            assert isinstance(user_name, str)
+            kw.top_keywords = []
+            if orderby == "amount_desc" and page == 1:
+                kw.recent_keywords = message_tag.get_recent_keywords(user_name, tag = tag)
+                
+        return xtemplate.render(template_file, **kw)
+    
+    def get_top_keywords(self, msg_list):
+        """返回热门的标签"""
+        result = []
+        for item in msg_list:
+            if item.is_marked:
+                result.append(item)
+        return result
+
+    def do_search(self, user_name, key, offset, pagesize, search_tags=None):
+        # 搜索
+        no_tag = False
+
+        input_search_tags = xutils.get_argument_str("searchTags")
+        input_no_tag = xutils.get_argument("noTag", "false")
+        p = xutils.get_argument("p", "")
+        date = xutils.get_argument_str("date")
+
+        if search_tags == None:
+            if input_search_tags != "":
+                search_tags = input_search_tags.split(",")
+            if p == "task":
+                search_tags = ["task"]
+            if p == "done":
+                search_tags = ["done"]
+            if p == "log":
+                search_tags = ["log"]
+
+        if input_no_tag == "true":
+            no_tag = True
+
+        searcher = message_search.SearchHandler()
+        return searcher.get_ajax_data(user_name=user_name, key=key, offset=offset,
+                                      limit=pagesize, search_tags=search_tags,
+                                      no_tag=no_tag, date=date)
+
+    def do_list_task(self, user_name, offset, limit):
+        p = xutils.get_argument("p", "")
+        filter_key = xutils.get_argument("filterKey", "")
+        status = xutils.get_argument("status", "")
+
+        if p == "done":
+            return msg_dao.list_task_done(user_name, offset, limit)
+
+        if filter_key != "":
+            msg_list, amount = msg_dao.list_task(
+                user_name, offset=0, limit=MAX_LIST_LIMIT)
+            msg_list = filter_msg_list_by_key(msg_list, filter_key)
+            return msg_list[offset:offset+limit], len(msg_list)
+        else:
+            return msg_dao.list_task(user_name, offset, limit)
+
+    def do_list_by_date(self, user_name, date, offset, pagesize):
+        filter_key = xutils.get_argument_str("filterKey", "")
+
+        if filter_key != "":
+            msg_list, amount = msg_dao.list_by_date(
+                user_name, date, 0, MAX_LIST_LIMIT)
+            msg_list = filter_msg_list_by_key(msg_list, filter_key)
+            return msg_list[offset:offset+pagesize], len(msg_list)
+        else:
+            return msg_dao.list_by_date(user_name, date, offset, pagesize)
+
+
+def update_message_status(id, status):
+    user_name = xauth.current_name()
+    data = MessageDao.get_by_id(id)
+    if data and data.user == user_name:
+        data.status = status
+        data.mtime = xutils.format_datetime()
+
+        MessageDao.update(data)
+        MessageDao.refresh_message_stat(user_name, ["task", "done"])
+
+        event = Storage(id=id, user=user_name,
+                        status=status, content=data.content)
+        xmanager.fire("message.updated", event)
+        xmanager.fire("message.update", event)
+        return dict(code="success")
+    else:
+        return failure(message="无操作权限")
+
+
+def update_message_content(id, user_name, content):
+    data = MessageDao.get_by_id(id)
+    if data and data.user == user_name:
+        if data.user_id == 0:
+            data.user_id = xauth.UserDao.get_id_by_name(user_name)
+            
+        # 先保存历史
+        MessageDao.add_history(data)
+        
+        data.content = content
+        data.mtime = xutils.format_datetime()
+        data.version = data.get('version', 0) + 1
+        MessageDao.update(data)
+
+        xmanager.fire("message.update", dict(
+            id=id, user=user_name, content=content))
+
+        after_message_create_or_update(data)
+
+
+def create_done_message(old_message):
+    old_id = old_message['id']
+
+    new_message = dao.MessageDO()
+    new_message.ref = old_id
+    new_message.tag = 'done'
+    new_message.user = old_message['user']
+    new_message.ctime = xutils.format_datetime()
+    MessageDao.create(new_message)
+
+
+def update_message_tag(id, tag):
+    """更新message的tag字段"""
+    user_name = xauth.current_name()
+    data = MessageDao.get_by_id(id)
+    if data == None:
+        return webutil.FailedResult(message="数据不存在")
+    if data.user != user_name:
+        return webutil.FailedResult(message="无权操作")
+    
+    # 修复status数据，全部采用tag
+    data.pop("status", None)
+    data.tag = tag
+    data.mtime = xutils.format_datetime()
+    data.sort_value = data.mtime
+    need_update = True
+    
+    if tag == "done":
+        # 任务完成时除了标记原来任务的完成时间，还要新建一条消息
+        data.done_time = xutils.format_datetime()
+        data.mtime = xutils.format_datetime()
+        data.append_comment("$mark_task_done$")
+    
+    if tag == "task":
+        # 重新开启任务
+        data.append_comment("$reopen_task$")
+
+        ref = data.ref
+        origin_data = MessageDao.get_by_id(ref)
+        if origin_data != None:
+            # 更新原始任务后删除当前的完成记录
+            origin_data.append_comment("$reopen_task$")
+            MessageDao.update_tag(origin_data, tag, sort_value = origin_data.sort_value)
+            MessageDao.delete_by_key(data.id)
+            need_update = False
+    
+    if need_update:    
+        MessageDao.update_tag(data, tag, sort_value=data.sort_value)
+
+    xmanager.fire("message.updated", Storage(
+        id=id, user=user_name, tag=tag, content=data.content))
+
+    return webutil.SuccessResult()
+
+
+class FinishMessageAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument("id")
+        if id == "":
+            return
+        return update_message_tag(id, "done")
+
+
+class OpenMessageAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument("id")
+        if id == "":
+            return
+        return update_message_tag(id, "task")
+
+
+class UpdateTagAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id")
+        tag = xutils.get_argument_str("tag")
+        if id == "":
+            return webutil.FailedResult(code="404", message="id为空")
+
+        if tag in ("task", "cron", "log", "key", "done"):
+            return update_message_tag(id, tag)
+        else:
+            return webutil.FailedResult(message="无效的标签: %s" % tag)
+
+class TouchAjaxHandler:
+
+    def do_touch_by_id(self, id):
+        msg = MessageDao.get_by_id(id)
+        if msg is None:
+            return failure(message="message not found, id:%s" % id)
+        if msg.user != xauth.current_name():
+            return failure(message="not authorized")
+        msg.mtime = xutils.format_datetime()
+        MessageDao.update(msg)
+        return success()
+
+    def do_touch_by_key(self, key):
+        user_name = xauth.current_name()
+        touch_key_by_content(user_name, "key", key)
+        return success()
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument("id")
+        key = xutils.get_argument("key")
+
+        if id != None and id != "":
+            return self.do_touch_by_id(id)
+        elif key != "":
+            return self.do_touch_by_key(key)
+        else:
+            return failure(message="id or key is missing")
+
+
+class DeleteAjaxHandler:
+
+    def delete_msg(self, msg: msg_dao.MessageDO):
+        if msg.user != xauth.current_name():
+            return dict(code="fail", message="no permission")
+
+        # 先保存历史
+        MessageDao.add_history(msg)
+
+        # 删除并刷新统计信息
+        MessageDao.delete_by_key(msg.id)
+        if msg.tag == "done" and msg.ref != None:
+            MessageDao.delete_by_key(msg.ref)
+            
+        MessageDao.refresh_message_stat(msg.user, [msg.tag])
+        after_message_delete(msg)
+
+        return webutil.SuccessResult()
+    
+    def delete_tag(self, tag_info: msg_dao.MsgTagInfo):
+        if tag_info.user != xauth.current_name_str():
+            return webutil.FailedResult(message="no permission")
+        
+        msg_dao.MsgTagInfoDao.delete(tag_info)
+        return webutil.SuccessResult()
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id")
+        if id == "":
+            return failure(message="id为空")
+
+        try:
+            msg = MessageDao.get_by_id(id)
+            if msg != None:
+                return self.delete_msg(msg)
+            tag_info = msg_dao.MsgTagInfoDao.get_by_key(id)
+            if tag_info != None:
+                return self.delete_tag(tag_info)
+            return webutil.FailedResult(message="数据不存在")
+        except:
+            xutils.print_exc()
+            return webutil.FailedResult(message="删除失败")
+
+
+class CalendarRule(BaseRule):
+
+    def execute(self, ctx, date, month, day):
+        print(date, month, day)
+        ctx.type = "calendar"
+
+
+def create_message(user_name, tag, content, ip):
+    assert isinstance(user_name, str)
+    assert isinstance(tag, str)
+    assert isinstance(content, str)
+
+    date = xutils.get_argument_str("date", xutils.format_date())
+    content = content.strip()
+    ctime = xutils.format_datetime()
+
+    message = dao.MessageDO()
+    message.user = user_name
+    message.user_id = xauth.UserDao.get_id_by_name(user_name)
+    message.tag = tag
+    message.ip = ip
+    message.date = date
+    message.ctime = ctime
+    message.mtime = ctime
+    message.content = content
+    message.sort_value = ctime
+    
+    id = MessageDao.create(message)
+    MessageDao.refresh_message_stat(user_name, [message.tag])
+
+    created_msg = MessageDao.get_by_id(id)
+    assert created_msg != None
+    
+    after_message_create_or_update(created_msg)
+
+    create_event = dict(id=id, user=user_name, content=content, ctime=ctime)
+    xmanager.fire('message.add', create_event)
+    xmanager.fire('message.create', create_event)
+
+    return message
+
+def get_or_create_keyword(user_name, content="", ip=""):
+    return msg_dao.MsgTagInfoDao.get_or_create(user_name, content)
+
+class SaveAjaxHandler:
+
+    def apply_rules(self, user_name, id, tag, content):
+        global MSG_RULES
+        ctx = Storage(id=id, content=content, user=user_name, type="")
+        for rule in MSG_RULES:
+            rule.match_execute(ctx, content)
+
+    @xauth.login_required()
+    def do_post(self):
+        id = xutils.get_argument("id")
+        content = xutils.get_argument_str("content")
+        tag = xutils.get_argument_str("tag", DEFAULT_TAG)
+        location = xutils.get_argument_str("location", "")
+        user_name = xauth.get_current_name()
+        ip = get_remote_ip()
+
+        if content == "":
+            return dict(code="fail", message="输入内容为空!")
+        
+        tag = TagHelper.get_create_tag(tag)
+
+        # 对消息进行语义分析处理，后期优化把所有规则统一管理起来
+        self.apply_rules(user_name, id, tag, content)
+
+        if id == "" or id is None:
+            message = create_message(user_name, tag, content, ip)
+            return webutil.SuccessResult(data=message)
+        else:
+            update_message_content(id, user_name, content)
+        return webutil.SuccessResult(data=dict(id=id))
+
+    def POST(self):
+        try:
+            return self.do_post()
+        except Exception as e:
+            xutils.print_exc()
+            return webutil.FailedResult(code="fail", message=str(e))
+
+
+class DateAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        date = xutils.get_argument_str("date", "")
+        page = xutils.get_argument("page", 1, type=int)
+        filter_key = xutils.get_argument_str("filterKey")
+        user_id = xauth.current_user_id()
+
+        if date == "":
+            return xtemplate.render("error.html", error="date参数为空")
+
+        offset = get_offset_from_page(page)
+        limit = xconfig.PAGE_SIZE
+
+        msg_list, msg_count = message_utils.list_by_date_and_key(
+            user_id=user_id, month=date, offset=offset, limit=limit, filter_key=filter_key)
+
+        parser = MessageListParser(msg_list)
+        parser.parse()
+
+        page_max = get_page_max(msg_count, xconfig.PAGE_SIZE)
+
+        return xtemplate.render("message/ajax/message_ajax.html",
+                                page_max=page_max,
+                                page=page,
+                                page_url=f"?date={date}&filterKey={quote(filter_key)}&page=",
+                                item_list=msg_list)
+
+class MessageListHandler:
+
+    @xauth.login_required()
+    def do_get(self, tag="task"):
+        """随手记/待办的入口
+        xxx_page 返回页面
+        xxx_data 返回数据
+        """
+        user = xauth.current_name()
+        key = xutils.get_argument("key", "")
+        from_ = xutils.get_argument("from", "")
+        type_ = xutils.get_argument("type", "")
+        show_tab = xutils.get_argument_bool("show_tab", True)
+        op = xutils.get_argument("op", "")
+        date = xutils.get_argument("date", "")
+        p = xutils.get_argument("p", "")
+
+        # 记录日志
+        assert isinstance(user, str)
+        xmanager.add_visit_log(user, "/message?tag=%s" % tag)
+
+        if tag == "month_tags":
+            return self.do_view_month_tags()
+
+        if tag in ("date", "log.date"):
+            return self.do_view_by_date(date)
+
+        if tag == "key" and op == "select":
+            return self.do_select_key()
+
+        if tag == "api.tag_list":
+            return self.get_tag_list()
+
+        if tag == "key":
+            return self.get_log_tags_page()
+
+        if tag == "task":
+            return self.get_task_page()
+
+        if tag == "task.tags":
+            return TaskListHandler.get_task_taglist_page()
+
+        if tag in ("search", "task.search", "done.search") or type_ == "search":
+            return message_search.SearchHandler().get_page()
+
+        if tag == "log.tags":
+            return self.get_log_tags_page()
+        
+        return self.get_log_page()
+
+    def do_select_key(self):
+        user_name = xauth.current_name()
+        offset = 0
+        msg_list, amount = dao.list_by_tag(
+            user_name, "key", offset, MAX_LIST_LIMIT)
+
+        return xtemplate.render("message/page/message_tag_select.html",
+                                msg_list=msg_list,
+                                show_nav=False)
+    
+    def get_tag_list(self):
+        return message_tag.get_tag_list()
+
+    def get_log_tags_page(self):
+        sys_tag = xutils.get_argument_str("sys_tag")
+        if sys_tag in SYSTEM_TAG_TUPLE:
+            return self.get_system_tag_page(sys_tag)
+
+        return message_tag.get_log_tags_page()
+
+    def get_system_tag_page(self, tag):
+        kw = Storage(
+            message_tag=tag,
+            search_type="message",
+            show_input_box=False,
+            show_side_tags=False,
+        )
+
+        return xtemplate.render("message/page/message_list_view.html", **kw)
+
+    def get_task_kw(self):
+        return TaskListHandler.get_task_kw()
+
+    def get_task_page(self):
+        filter_key = xutils.get_argument_str("filterKey", "")
+        page_name = xutils.get_argument_str("p", "")
+
+        if page_name == "create":
+            return TaskListHandler.get_task_create_page()
+
+        if page_name == "done":
+            return TaskListHandler.get_task_done_page()
+
+        if page_name == "taglist":
+            return TaskListHandler.get_task_taglist_page()
+
+        if filter_key != "":
+            return TaskListHandler.get_task_by_keyword_page(filter_key)
+        else:
+            # 任务的首页
+            return TaskListHandler.get_task_create_page()
+
+    def get_task_home_page(self):
+        return TaskListHandler.get_task_create_page()
+
+    def do_view_month_tags(self):
+        user_name = xauth.current_name()
+        date = xutils.get_argument_str("date")
+
+        year, month, mday = do_split_date(date)
+
+        msg_list, amount = msg_dao.list_by_date(
+            user_name, date, limit=MAX_LIST_LIMIT)
+
+        tag_list = get_tags_from_message_list(msg_list, "date", date)
+
+        return xtemplate.render("message/page/message_tag_view.html",
+                                year=year,
+                                month=month,
+                                message_tag="calendar",
+                                search_type="message",
+                                show_back_btn=True,
+                                tag_list=tag_list,
+                                html_title=T("待办任务"),
+                                message_placeholder="添加待办任务")
+
+    def get_log_page(self):
+        key = xutils.get_argument("key", "")
+        input_tag = xutils.get_argument("tag", "log")
+        p = xutils.get_argument("p", "")
+        user_name = xauth.current_name()
+        default_content = filter_key(key)
+
+        kw = Storage(
+            tag=input_tag,
+            message_tag=input_tag,
+            search_type="message",
+            show_system_tag=False,
+            show_side_system_tags=True,
+            show_sub_link=False,
+            html_title=T("随手记"),
+            default_content=default_content,
+            show_back_btn=False,
+            message_tab="log",
+            message_placeholder="记录发生的事情/产生的想法",
+            side_tags=message_utils.list_hot_tags(user_name, 20),
+        )
+
+        kw.search_ext_dict = dict(tag="log.search")
+
+        return xtemplate.render("message/page/message_list_view.html", **kw)
+
+    def do_view_by_date(self, date):
+        kw = Storage()
+        kw.message_placeholder = "补充%s发生的事情" % date
+
+        filter_key = xutils.get_argument("filterKey", "")
+        if filter_key != "":
+            kw.show_input_box = False
+
+        return xtemplate.render("message/page/message_list_view.html",
+                                tag="date",
+                                message_tag="date",
+                                search_type="message",
+                                show_system_tag=False,
+                                show_sub_link=False,
+                                html_title=T("随手记"),
+                                show_back_btn=True,
+                                **kw)
+
+    def GET(self):
+        tag = xutils.get_argument_str("tag")
+        return self.do_get(tag)
+
+class MessageDetailAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        id = xutils.get_argument_str("id")
+        user_name = xauth.current_name_str()
+        detail = msg_dao.get_message_by_id(id, user_name=user_name)
+        if detail == None:
+            return webutil.FailedResult(message="数据不存在")
+
+        if detail.ref != None:
+            detail = msg_dao.get_message_by_id(detail.ref, user_name=user_name)
+        
+        return dict(code="success", data = detail)
+
+class CalendarHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_id = xauth.current_user_id()
+        date = xutils.get_argument("date")
+
+        year, month, mday = do_split_date(date)
+
+        date = "%s-%02d" % (year, month)
+
+        kw = Storage()
+        kw.tag = "log.date"
+        kw.year = year
+        kw.month = month
+        kw.date = date
+        kw.html_title = T("随手记")
+        kw.search_type = "message"
+        kw.tag_list = message_tag.get_tag_list_by_month(user_id=user_id, month=date)
+
+        return xtemplate.render("message/page/message_calendar.html", **kw)
+
+
+class StatAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user = xauth.current_name_str()
+        stat = msg_dao.get_message_stat(user)
+        format_message_stat(stat)
+        return stat
+
+
+class MessageHandler(MessageListHandler):
+    pass
+
+
+class MessageLogHandler(MessageHandler):
+
+    def GET(self):
+        return self.do_get("log")
+
+
+class TodoHandler(MessageHandler):
+
+    @xauth.login_required()
+    def do_get(self, tag="todo", title="待办任务", show_input_box=True):
+        user_name = xauth.current_name()
+        assert isinstance(user_name, str)
+        message_stat = msg_dao.get_message_stat(user_name)
+        xmanager.add_visit_log(user_name, "/message/todo")
+
+        return xtemplate.render("message/page/message_todo.html",
+                                search_type="task",
+                                tag=tag,
+                                title=T(title),
+                                show_input_box=show_input_box,
+                                message_stat=message_stat)
+
+    def GET(self):
+        return self.do_get("todo")
+
+
+class TodoDoneHandler(TodoHandler):
+
+    def GET(self):
+        return self.do_get("done", "已完成任务", show_input_box=False)
+
+
+class TodoCanceledHandler(TodoHandler):
+
+    def GET(self):
+        return self.do_get("canceled", "已取消任务", show_input_box=False)
+
+
+def get_default_year_and_month():
+    return dateutil.format_date(None, "%Y-%m")
+
+
+class MessageListByDayHandler():
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name()
+        date = xutils.get_argument("date", "")
+        show_empty = xutils.get_argument("show_empty", True, type=bool)
+
+        if date == "":
+            date = get_default_year_and_month()
+
+        year, month, day = do_split_date(date)
+
+        item_list, amount = msg_dao.list_by_date(
+            user_name, date, limit=MAX_LIST_LIMIT)
+        message_list = convert_message_list_to_day_folder(
+            item_list, date, True)
+        
+        kw = Storage()
+        kw.tag = "log.date"
+        kw.search_type = "message"
+        kw.search_ext_dict = dict(tag="log.search")
+
+        return xtemplate.render("message/page/message_list_by_day.html",
+                                date=date,
+                                year=year,
+                                month=month,
+                                message_list=message_list,
+                                show_empty=show_empty,
+                                show_back_btn=True,
+                                month_size=count_month_size(message_list),
+                                **kw)
+
+
+class MessageRefreshHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        refresh_key_amount()
+        refresh_message_index()
+        return "success"
+
+
+class MessageKeywordAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        keyword = xutils.get_argument_str("keyword")
+        action = xutils.get_argument_str("action")
+
+        assert keyword != ""
+        assert action != ""
+
+        if action in ("mark", "unmark"):
+            return self.do_mark_or_unmark(keyword, action)
+
+        return dict(code="404", message="指定动作不存在")
+
+    def do_mark_or_unmark(self, keyword, action):
+        user_name = xauth.current_name_str()
+        tag_info = msg_dao.MsgTagInfoDao.get_or_create(user=user_name, content=keyword)
+        assert tag_info != None
+
+        if action == "unmark":
+            tag_info.is_marked = False
+        else:
+            tag_info.is_marked = True
+
+        msg_dao.MsgTagInfoDao.update(tag_info)
+        
+        return dict(code="success")
+
+xutils.register_func("message.process_message", process_message)
+xutils.register_func("message.get_current_message_stat",
+                     get_current_message_stat)
+xutils.register_func("url:/message/log", MessageLogHandler)
+
+
+MSG_RULES = [
+    CalendarRule(r"(\d+)年(\d+)月(\d+)日"),
+]
+
+class CreateCommentHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id")
+        content = xutils.get_argument_str("content")
+
+        if content == "":
+            return webutil.FailedResult(message="备注内容不能为空")
+
+        user_name = xauth.current_name_str()
+        msg = dao.get_message_by_id(id, user_name=user_name)
+        if msg == None:
+            return webutil.FailedResult(message="随手记不存在")
+        comment = dao.MessageComment()
+        comment.content = content
+        msg.comments.append(comment)
+        
+        dao.update_message(msg)
+        return webutil.SuccessResult()
+
+
+class DeleteCommentHandler:
+    
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id")
+        time_str = xutils.get_argument_str("time")
+
+        if time_str == "":
+            return webutil.FailedResult(message="备注时间不能为空")
+        user_name = xauth.current_name_str()
+        msg = dao.get_message_by_id(id, user_name=user_name)
+        if msg == None:
+            return webutil.FailedResult(message="随手记不存在")
+        
+        new_comments = []
+        for comment in msg.comments:
+            if comment.get("time") != time_str:
+                new_comments.append(comment)
+        
+        msg.comments = new_comments
+        dao.update_message(msg)
+        return webutil.SuccessResult()
+    
+class ListCommentHandler:
+    
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id")
+        user_name = xauth.current_name_str()
+        msg = dao.get_message_by_id(id, user_name=user_name)
+        if msg == None:
+            return webutil.FailedResult(message="随手记不存在")
+        
+        comments = list(reversed(msg.comments))
+        return webutil.SuccessResult(data=comments)
+
+
+xurls = (
+    r"/message", MessageHandler,
+    r"/message/calendar", CalendarHandler,
+    r"/message/todo", TodoHandler,
+    r"/message/log", MessageLogHandler,
+    r"/message/done", TodoDoneHandler,
+    r"/message/canceled", TodoCanceledHandler,
+    r"/message/detail", MessageDetailAjaxHandler,
+
+    # 日记
+    r"/message/dairy", MessageListByDayHandler,
+    r"/message/list_by_day", MessageListByDayHandler,
+
+    r"/message/refresh", MessageRefreshHandler,
+    
+    # Ajax处理
+    r"/message/list", ListAjaxHandler,
+    r"/message/date", DateAjaxHandler,
+    r"/message/stat", StatAjaxHandler,
+    r"/message/save", SaveAjaxHandler,
+    r"/message/delete", DeleteAjaxHandler,
+    r"/message/update", SaveAjaxHandler,
+    r"/message/open", OpenMessageAjaxHandler,
+    r"/message/finish", FinishMessageAjaxHandler,
+    r"/message/touch", TouchAjaxHandler,
+    r"/message/tag", UpdateTagAjaxHandler,
+    r"/message/keyword", MessageKeywordAjaxHandler,
+    r"/message/comment/create", CreateCommentHandler,
+    r"/message/comment/delete", DeleteCommentHandler,
+    r"/message/comment/list", ListCommentHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/message/message_model.py` & `xnote-web-0.1.1/handlers/message/message_model.py`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,38 +1,38 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/10/06 12:24:41
-# @modified 2022/04/09 22:10:00
-# @filename message_model.py
-
-from xutils import Storage
-
-"""消息模型相关的内容
-任务：默认按照修改时间排序
-记事/日记：默认按照创建时间排序
-"""
-
-class MessageFolder(Storage):
-
-    def __init__(self):
-        self.date = ""
-        self.wday = ""
-        self.item_list = []
-
-class MessageTag(Storage):
-
-    def __init__(self, 
-            name = "", 
-            tag = "", 
-            amount = 0, 
-            url = "", 
-            mtime = "", **kw):
-        self.name = name
-        self.content = name
-        self.amount = amount
-        self.url = url
-        self.mtime = mtime
-        self.badge_info = ""
-        self.update(kw)
-
-def is_task_tag(tag):
-    return tag in ("task", "done", "task.search", "done.search")
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/10/06 12:24:41
+# @modified 2022/04/09 22:10:00
+# @filename message_model.py
+
+from xutils import Storage
+
+"""消息模型相关的内容
+任务：默认按照修改时间排序
+记事/日记：默认按照创建时间排序
+"""
+
+class MessageFolder(Storage):
+
+    def __init__(self):
+        self.date = ""
+        self.wday = ""
+        self.item_list = []
+
+class MessageTag(Storage):
+
+    def __init__(self, 
+            name = "", 
+            tag = "", 
+            amount = 0, 
+            url = "", 
+            mtime = "", **kw):
+        self.name = name
+        self.content = name
+        self.amount = amount
+        self.url = url
+        self.mtime = mtime
+        self.badge_info = ""
+        self.update(kw)
+
+def is_task_tag(tag):
+    return tag in ("task", "done", "task.search", "done.search")
```

### Comparing `xnote-web-0.1.0/handlers/message/message_search.py` & `xnote-web-0.1.1/handlers/message/message_search.py`

 * *Ordering differences only*

 * *Files 17% similar despite different names*

```diff
@@ -1,118 +1,118 @@
-# encoding=utf-8
-
-import time
-import xutils
-from xnote.core import xmanager, xconfig, xauth, xtemplate
-
-from . import dao, message_utils
-from xutils import SearchResult, u, Storage, functions
-
-@xmanager.searchable()
-def on_search_message(ctx):
-    if ctx.search_message is False:
-        return
-
-    key = ctx.key
-    message_utils.touch_key_by_content(ctx.user_name, 'key', key)
-    max_len = xconfig.SEARCH_SUMMARY_LEN
-
-    messages, count = dao.search_message(ctx.user_name, key, 0, 3)
-    search_result = []
-    for message in messages:
-        item = SearchResult()
-        if message.content != None and len(message.content) > max_len:
-            message.content = message.content[:max_len] + "......"
-        message_utils.process_message(message)
-        item.tag_name = u("记事")
-        item.tag_class = "orange"
-        item.name = u('记事 - ') + message.ctime
-        item.html = message.html
-        item.icon = "hide"
-        search_result.append(item)
-        # print(message)
-
-    show_message_detail = xconfig.get_user_config(
-        ctx.user_name, "search_message_detail_show")
-
-    if show_message_detail == "false":
-        search_result = []
-
-    if count > 0:
-        more = SearchResult()
-        more.name = "搜索到[%s]条记事" % count
-        more.url = "/message?key=" + ctx.key
-        more.icon = "fa-file-text-o"
-        more.show_more_link = True
-        search_result.insert(0, more)
-
-    if len(search_result) > 0:
-        ctx.messages += search_result
-
-
-
-
-class SearchContext:
-
-    def __init__(self, key):
-        self.key = key
-
-
-
-class SearchHandler:
-    """搜索逻辑处理"""
-
-    def get_page(self):
-        user_name = xauth.current_name()
-        key = xutils.get_argument_str("key", "")
-        tag = xutils.get_argument_str("tag", "search")
-
-        kw = Storage()
-        kw.tag = tag
-        kw.key = key
-        kw.keyword = key
-        kw.default_content = message_utils.filter_key(key)
-        kw.side_tags = message_utils.list_hot_tags(user_name, 20)
-        kw.create_tag = self.get_create_tag()
-        kw.show_create_on_tag = kw.create_tag != "forbidden"
-        kw.is_keyword_marked = message_utils.is_marked_keyword(user_name, key)
-        kw.is_task_tag = message_utils.is_task_tag(tag)
-        kw.search_type = message_utils.TagHelper.get_search_type(tag)
-        kw.search_ext_dict = dict(tag = tag)
-
-        return xtemplate.render("message/page/message_search.html", **kw)
-
-    def get_ajax_data(self, *, user_name="", key="", offset=0,
-                      limit=20, search_tags=None, no_tag=False, date=""):
-        start_time = time.time()
-        chatlist, amount = dao.search_message(
-            user_name, key, offset, limit,
-            search_tags=search_tags, no_tag=no_tag, date=date)
-
-        # 搜索扩展
-        xmanager.fire("message.search", SearchContext(key))
-
-        # 自动置顶
-        message_utils.touch_key_by_content(user_name, "key", key)
-        similar_key = message_utils.get_similar_key(key)
-        if key != similar_key:
-            message_utils.touch_key_by_content(user_name, "key", similar_key)
-
-        cost_time = functions.second_to_ms(time.time() - start_time)
-
-        dao.add_search_history(user_name, key, cost_time)
-
-        return chatlist, amount
-
-    def search_items(self, user_name, key):
-        pass
-
-    def get_create_tag(self):
-        p = xutils.get_argument("p", "")
-        if p == "task":
-            return "task"
-
-        if p == "log":
-            return "log"
-
-        return "forbidden"
-
+# encoding=utf-8
+
+import time
+import xutils
+from xnote.core import xmanager, xconfig, xauth, xtemplate
+
+from . import dao, message_utils
+from xutils import SearchResult, u, Storage, functions
+
+@xmanager.searchable()
+def on_search_message(ctx):
+    if ctx.search_message is False:
+        return
+
+    key = ctx.key
+    message_utils.touch_key_by_content(ctx.user_name, 'key', key)
+    max_len = xconfig.SEARCH_SUMMARY_LEN
+
+    messages, count = dao.search_message(ctx.user_name, key, 0, 3)
+    search_result = []
+    for message in messages:
+        item = SearchResult()
+        if message.content != None and len(message.content) > max_len:
+            message.content = message.content[:max_len] + "......"
+        message_utils.process_message(message)
+        item.tag_name = u("记事")
+        item.tag_class = "orange"
+        item.name = u('记事 - ') + message.ctime
+        item.html = message.html
+        item.icon = "hide"
+        search_result.append(item)
+        # print(message)
+
+    show_message_detail = xconfig.get_user_config(
+        ctx.user_name, "search_message_detail_show")
+
+    if show_message_detail == "false":
+        search_result = []
+
+    if count > 0:
+        more = SearchResult()
+        more.name = "搜索到[%s]条记事" % count
+        more.url = "/message?key=" + ctx.key
+        more.icon = "fa-file-text-o"
+        more.show_more_link = True
+        search_result.insert(0, more)
+
+    if len(search_result) > 0:
+        ctx.messages += search_result
+
+
+
+
+class SearchContext:
+
+    def __init__(self, key):
+        self.key = key
+
+
+
+class SearchHandler:
+    """搜索逻辑处理"""
+
+    def get_page(self):
+        user_name = xauth.current_name()
+        key = xutils.get_argument_str("key", "")
+        tag = xutils.get_argument_str("tag", "search")
+
+        kw = Storage()
+        kw.tag = tag
+        kw.key = key
+        kw.keyword = key
+        kw.default_content = message_utils.filter_key(key)
+        kw.side_tags = message_utils.list_hot_tags(user_name, 20)
+        kw.create_tag = self.get_create_tag()
+        kw.show_create_on_tag = kw.create_tag != "forbidden"
+        kw.is_keyword_marked = message_utils.is_marked_keyword(user_name, key)
+        kw.is_task_tag = message_utils.is_task_tag(tag)
+        kw.search_type = message_utils.TagHelper.get_search_type(tag)
+        kw.search_ext_dict = dict(tag = tag)
+
+        return xtemplate.render("message/page/message_search.html", **kw)
+
+    def get_ajax_data(self, *, user_name="", key="", offset=0,
+                      limit=20, search_tags=None, no_tag=False, date=""):
+        start_time = time.time()
+        chatlist, amount = dao.search_message(
+            user_name, key, offset, limit,
+            search_tags=search_tags, no_tag=no_tag, date=date)
+
+        # 搜索扩展
+        xmanager.fire("message.search", SearchContext(key))
+
+        # 自动置顶
+        message_utils.touch_key_by_content(user_name, "key", key)
+        similar_key = message_utils.get_similar_key(key)
+        if key != similar_key:
+            message_utils.touch_key_by_content(user_name, "key", similar_key)
+
+        cost_time = functions.second_to_ms(time.time() - start_time)
+
+        dao.add_search_history(user_name, key, cost_time)
+
+        return chatlist, amount
+
+    def search_items(self, user_name, key):
+        pass
+
+    def get_create_tag(self):
+        p = xutils.get_argument("p", "")
+        if p == "task":
+            return "task"
+
+        if p == "log":
+            return "log"
+
+        return "forbidden"
+
```

### Comparing `xnote-web-0.1.0/handlers/message/message_tag.py` & `xnote-web-0.1.1/handlers/message/message_tag.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,94 +1,94 @@
-# encoding=utf-8
-
-import xutils
-from xnote.core import xauth, xtemplate, xconfig
-from xutils import Storage, webutil, dateutil
-from xutils.textutil import quote
-from . import dao as msg_dao
-from . import message_utils
-from .message_model import MessageTag
-
-"""
-随手记的标签处理
-页面对应的是 ajax/message_tag_ajax.html 
-"""
-MAX_LIST_LIMIT = 1000
-
-
-def get_tag_list():
-    user_name = xauth.current_name()
-    offset = 0
-    msg_list, amount = msg_dao.list_by_tag(
-        user_name, "key", offset, MAX_LIST_LIMIT)
-    return webutil.SuccessResult(data=msg_list)
-
-def get_tag_list_by_msg_list(msg_list, date=""):
-    p = message_utils.MessageListParser(msg_list)
-    p.parse()
-    result = p.get_keywords()
-    server_home = xconfig.WebConfig.server_home
-    for tag_info in result:
-        tag_name = tag_info.name
-        tag_info.url = f"{server_home}/message/calendar?tag=log.date&date={date}&filterKey={quote(tag_name)}"
-        tag_info.badge_info = f"{tag_info.amount}"
-    result.sort(key = lambda x:x.amount, reverse=True)
-    return result
-
-def get_tag_list_by_month(user_id=0, month="2000-01"):
-    date_start = month + "-01"
-    date_end = dateutil.date_str_add(date_start, months=1)
-    msg_list, amount = msg_dao.list_by_date_range(user_id=user_id, date_start=date_start, date_end=date_end)
-    result = get_tag_list_by_msg_list(msg_list, date=month)
-    return result
-
-def get_log_tags_page():
-    """随手记的话题标签页面"""
-    orderby = xutils.get_argument("orderby", "")
-
-    kw = Storage(
-        tag="key",
-        search_type="message",
-        show_tag_btn=False,
-        show_attachment_btn=False,
-        show_system_tag=True,
-        message_placeholder="添加标签/关键字/话题",
-        show_side_tags=False,
-    )
-
-    kw.show_input_box = False
-    kw.show_sub_link = False
-    kw.orderby = orderby
-    kw.search_ext_dict = dict(tag="search")
-
-    return xtemplate.render("message/page/message_list_view.html", **kw)
-
-
-def filter_standard_msg_list(msg_list):
-    result = []
-    for item in msg_list:
-        if message_utils.is_standard_tag(item.content):
-            result.append(item)
-    return result
-
-def list_message_tags(user_name, offset, limit, *, orderby = "amount_desc", only_standard=False):
-    msg_list, amount = msg_dao.list_by_tag(
-        user_name, "key", 0, MAX_LIST_LIMIT)
-    
-    if only_standard:
-        msg_list = filter_standard_msg_list(msg_list)
-
-    p = message_utils.MessageKeyWordProcessor(msg_list)
-    p.process()
-    p.sort(orderby)
-
-    return msg_list[offset:offset+limit], len(msg_list)
-
-def get_recent_keywords(user_name: str, tag: str):
-    """获取最近访问的标签"""
-    msg_list, amount = list_message_tags(user_name, 0, 20, orderby = "recent", only_standard=True)
-    parser = message_utils.MessageListParser(msg_list, tag=tag)
-    parser.parse()
-    result = parser.get_message_list()
-    for item in result:
-        item.badge_info = ""
-    return result
+# encoding=utf-8
+
+import xutils
+from xnote.core import xauth, xtemplate, xconfig
+from xutils import Storage, webutil, dateutil
+from xutils.textutil import quote
+from . import dao as msg_dao
+from . import message_utils
+from .message_model import MessageTag
+
+"""
+随手记的标签处理
+页面对应的是 ajax/message_tag_ajax.html 
+"""
+MAX_LIST_LIMIT = 1000
+
+
+def get_tag_list():
+    user_name = xauth.current_name()
+    offset = 0
+    msg_list, amount = msg_dao.list_by_tag(
+        user_name, "key", offset, MAX_LIST_LIMIT)
+    return webutil.SuccessResult(data=msg_list)
+
+def get_tag_list_by_msg_list(msg_list, date=""):
+    p = message_utils.MessageListParser(msg_list)
+    p.parse()
+    result = p.get_keywords()
+    server_home = xconfig.WebConfig.server_home
+    for tag_info in result:
+        tag_name = tag_info.name
+        tag_info.url = f"{server_home}/message/calendar?tag=log.date&date={date}&filterKey={quote(tag_name)}"
+        tag_info.badge_info = f"{tag_info.amount}"
+    result.sort(key = lambda x:x.amount, reverse=True)
+    return result
+
+def get_tag_list_by_month(user_id=0, month="2000-01"):
+    date_start = month + "-01"
+    date_end = dateutil.date_str_add(date_start, months=1)
+    msg_list, amount = msg_dao.list_by_date_range(user_id=user_id, date_start=date_start, date_end=date_end)
+    result = get_tag_list_by_msg_list(msg_list, date=month)
+    return result
+
+def get_log_tags_page():
+    """随手记的话题标签页面"""
+    orderby = xutils.get_argument("orderby", "")
+
+    kw = Storage(
+        tag="key",
+        search_type="message",
+        show_tag_btn=False,
+        show_attachment_btn=False,
+        show_system_tag=True,
+        message_placeholder="添加标签/关键字/话题",
+        show_side_tags=False,
+    )
+
+    kw.show_input_box = False
+    kw.show_sub_link = False
+    kw.orderby = orderby
+    kw.search_ext_dict = dict(tag="search")
+
+    return xtemplate.render("message/page/message_list_view.html", **kw)
+
+
+def filter_standard_msg_list(msg_list):
+    result = []
+    for item in msg_list:
+        if message_utils.is_standard_tag(item.content):
+            result.append(item)
+    return result
+
+def list_message_tags(user_name, offset, limit, *, orderby = "amount_desc", only_standard=False):
+    msg_list, amount = msg_dao.list_by_tag(
+        user_name, "key", 0, MAX_LIST_LIMIT)
+    
+    if only_standard:
+        msg_list = filter_standard_msg_list(msg_list)
+
+    p = message_utils.MessageKeyWordProcessor(msg_list)
+    p.process()
+    p.sort(orderby)
+
+    return msg_list[offset:offset+limit], len(msg_list)
+
+def get_recent_keywords(user_name: str, tag: str):
+    """获取最近访问的标签"""
+    msg_list, amount = list_message_tags(user_name, 0, 20, orderby = "recent", only_standard=True)
+    parser = message_utils.MessageListParser(msg_list, tag=tag)
+    parser.parse()
+    result = parser.get_message_list()
+    for item in result:
+        item.badge_info = ""
+    return result
```

### Comparing `xnote-web-0.1.0/handlers/message/message_task.py` & `xnote-web-0.1.1/handlers/message/message_task.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,76 +1,76 @@
-# encoding=utf-8
-
-import xutils
-from xutils import Storage
-from xnote.core import xtemplate, xauth
-from xnote.core.xtemplate import T
-import handlers.message.dao as msg_dao
-from handlers.message.message_utils import list_task_tags, get_tags_from_message_list, is_marked_keyword, sort_keywords_by_marked
-
-class TaskListHandler:
-    
-    @staticmethod
-    def get_task_kw():
-        kw = Storage()
-        kw.title = T("待办任务")
-        kw.html_title = T("待办任务")
-        kw.search_type = "task"
-        kw.show_back_btn = True
-        kw.tag = "task"
-        kw.message_placeholder = T("添加待办任务")
-        kw.message_tab = "task"
-        return kw
-    
-    @classmethod
-    def get_task_create_page(cls):
-        kw = cls.get_task_kw()
-        kw.show_input_box = True
-        kw.show_system_tag = False
-        side_tags = list_task_tags(xauth.current_name())
-        for tag in side_tags:
-            tag.url = f"/message?tag=task&filterKey={xutils.quote(tag.content)}"
-        kw.side_tag_tab_key = "filterKey"
-        kw.side_tags = side_tags
-        kw.default_content = xutils.get_argument_str("filterKey")
-        kw.search_type = "task"
-        kw.search_placeholder = "搜索待办"
-        kw.search_ext_dict = dict(tag = "task.search")
-        return xtemplate.render("message/page/task_index.html", **kw)
-
-    @classmethod
-    def get_task_by_keyword_page(cls, filter_key):
-        return cls.get_task_create_page()
-
-    @classmethod
-    def get_task_taglist_page(cls):
-        user_name = xauth.current_name()
-        msg_list, amount = msg_dao.list_task(user_name, 0, 1000)
-
-        tag_list = get_tags_from_message_list(
-            msg_list, "task", display_tag="taglist", search_tag="task")
-
-        for tag in tag_list:
-            tag.is_marked = is_marked_keyword(user_name, tag.name)
-
-        sort_keywords_by_marked(tag_list)
-
-        kw = cls.get_task_kw()
-        kw.tag_list = tag_list
-        kw.html_title = T("待办任务")
-        kw.message_placeholder = T("添加待办任务")
-
-        kw.show_sub_link = False
-        kw.show_task_create_entry = True
-        kw.show_task_done_entry = True
-        kw.search_type = "task"
-        kw.search_ext_dict = dict(tag="task.search")
-
-        return xtemplate.render("message/page/message_tag_view.html", **kw)
-
-    @classmethod
-    def get_task_done_page(cls):
-        kw = cls.get_task_kw()
-        kw.show_system_tag = False
-        kw.show_input_box = False
-        kw.show_side_tags = False
-        return xtemplate.render("message/page/message_list_view.html", **kw)
+# encoding=utf-8
+
+import xutils
+from xutils import Storage
+from xnote.core import xtemplate, xauth
+from xnote.core.xtemplate import T
+import handlers.message.dao as msg_dao
+from handlers.message.message_utils import list_task_tags, get_tags_from_message_list, is_marked_keyword, sort_keywords_by_marked
+
+class TaskListHandler:
+    
+    @staticmethod
+    def get_task_kw():
+        kw = Storage()
+        kw.title = T("待办任务")
+        kw.html_title = T("待办任务")
+        kw.search_type = "task"
+        kw.show_back_btn = True
+        kw.tag = "task"
+        kw.message_placeholder = T("添加待办任务")
+        kw.message_tab = "task"
+        return kw
+    
+    @classmethod
+    def get_task_create_page(cls):
+        kw = cls.get_task_kw()
+        kw.show_input_box = True
+        kw.show_system_tag = False
+        side_tags = list_task_tags(xauth.current_name())
+        for tag in side_tags:
+            tag.url = f"/message?tag=task&filterKey={xutils.quote(tag.content)}"
+        kw.side_tag_tab_key = "filterKey"
+        kw.side_tags = side_tags
+        kw.default_content = xutils.get_argument_str("filterKey")
+        kw.search_type = "task"
+        kw.search_placeholder = "搜索待办"
+        kw.search_ext_dict = dict(tag = "task.search")
+        return xtemplate.render("message/page/task_index.html", **kw)
+
+    @classmethod
+    def get_task_by_keyword_page(cls, filter_key):
+        return cls.get_task_create_page()
+
+    @classmethod
+    def get_task_taglist_page(cls):
+        user_name = xauth.current_name()
+        msg_list, amount = msg_dao.list_task(user_name, 0, 1000)
+
+        tag_list = get_tags_from_message_list(
+            msg_list, "task", display_tag="taglist", search_tag="task")
+
+        for tag in tag_list:
+            tag.is_marked = is_marked_keyword(user_name, tag.name)
+
+        sort_keywords_by_marked(tag_list)
+
+        kw = cls.get_task_kw()
+        kw.tag_list = tag_list
+        kw.html_title = T("待办任务")
+        kw.message_placeholder = T("添加待办任务")
+
+        kw.show_sub_link = False
+        kw.show_task_create_entry = True
+        kw.show_task_done_entry = True
+        kw.search_type = "task"
+        kw.search_ext_dict = dict(tag="task.search")
+
+        return xtemplate.render("message/page/message_tag_view.html", **kw)
+
+    @classmethod
+    def get_task_done_page(cls):
+        kw = cls.get_task_kw()
+        kw.show_system_tag = False
+        kw.show_input_box = False
+        kw.show_side_tags = False
+        return xtemplate.render("message/page/message_list_view.html", **kw)
```

### Comparing `xnote-web-0.1.0/handlers/message/page/message.html` & `xnote-web-0.1.1/handlers/message/page/message.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/page/message_calendar.html` & `xnote-web-0.1.1/handlers/message/page/message_calendar.html`

 * *Ordering differences only*

 * *Files 25% similar despite different names*

```diff
@@ -1,76 +1,76 @@
-{% extends base %}
-
-{% block head %}
-
-<link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/webuploader/webuploader.css">
-<script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
-<script type="text/javascript" src="{{_server_home}}/_static/js/message/message.js"></script>
-
-{% end %}
-
-{% block body_left %}
-    {% init tag_list = [] %}
-
-    {% include message/component/message_title.html %}
-    <!-- Tab页 -->
-    {% include message/component/message_tab_log.html %}
-
-    <!-- 月份选择器 -->
-    {% include common/date/month_picker.html %}
-
-    <!-- 二级目录 -->
-    {% include message/component/message_sub_link.html %}
-
-    <!-- 当月的标签 -->
-    <div class="card">
-        <h3 class="card-title">标签</h3>
-        <span class="tag-span">
-            <a class="link" href="/message/calendar?date={{date}}">全部</a>
-        </span>
-        
-        {% for item in tag_list %}
-            <span class="tag-span">
-                <span>
-                    <a class="link" href="{{item.url}}">{{item.name}}</a>
-                    <span class="black">{{item.badge_info}}</span>
-                </span>
-            </span>
-        {% end %}
-    </div>
-
-    
-    <!-- 文字区域 -->
-    {% include message/component/message_list.html %}
-
-    <!-- 编辑 -->
-    {% include message/component/message_edit.html %}
-
-    <script type="text/javascript">
-        $(function (e) {
-            var date = "{{date}}";
-
-            function getPage() {
-                var page = getUrlParam("page");
-                if (page == undefined) {
-                    return 1;
-                } else {
-                    return parseInt(page);
-                }
-            }
-
-            function onMonthSelected(event) {
-                var date = event.target;
-                window.location.href = "?date=" + date;
-            }
-
-            xnote.on("date.month.selected", onMonthSelected);
-
-            refreshMessageList(date);
-        })
-    </script>
-
-{% end %}
-  
-{% block body_right %}
-    {% include message/component/message_date_right.html %}
-{% end %}
+{% extends base %}
+
+{% block head %}
+
+<link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/webuploader/webuploader.css">
+<script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
+<script type="text/javascript" src="{{_server_home}}/_static/js/message/message.js"></script>
+
+{% end %}
+
+{% block body_left %}
+    {% init tag_list = [] %}
+
+    {% include message/component/message_title.html %}
+    <!-- Tab页 -->
+    {% include message/component/message_tab_log.html %}
+
+    <!-- 月份选择器 -->
+    {% include common/date/month_picker.html %}
+
+    <!-- 二级目录 -->
+    {% include message/component/message_sub_link.html %}
+
+    <!-- 当月的标签 -->
+    <div class="card">
+        <h3 class="card-title">标签</h3>
+        <span class="tag-span">
+            <a class="link" href="/message/calendar?date={{date}}">全部</a>
+        </span>
+        
+        {% for item in tag_list %}
+            <span class="tag-span">
+                <span>
+                    <a class="link" href="{{item.url}}">{{item.name}}</a>
+                    <span class="black">{{item.badge_info}}</span>
+                </span>
+            </span>
+        {% end %}
+    </div>
+
+    
+    <!-- 文字区域 -->
+    {% include message/component/message_list.html %}
+
+    <!-- 编辑 -->
+    {% include message/component/message_edit.html %}
+
+    <script type="text/javascript">
+        $(function (e) {
+            var date = "{{date}}";
+
+            function getPage() {
+                var page = getUrlParam("page");
+                if (page == undefined) {
+                    return 1;
+                } else {
+                    return parseInt(page);
+                }
+            }
+
+            function onMonthSelected(event) {
+                var date = event.target;
+                window.location.href = "?date=" + date;
+            }
+
+            xnote.on("date.month.selected", onMonthSelected);
+
+            refreshMessageList(date);
+        })
+    </script>
+
+{% end %}
+  
+{% block body_right %}
+    {% include message/component/message_date_right.html %}
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/message/page/message_list_view.html` & `xnote-web-0.1.1/handlers/message/page/message_list_view.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/page/message_search.html` & `xnote-web-0.1.1/handlers/message/page/message_search.html`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,127 +1,127 @@
-{% extends base %}
-
-{% block body_top %}
-
-    {% init default_content = "" %}
-    {% init show_tab = True %}
-
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/webuploader/webuploader.css">
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/js/message/message.js?ts={{_ts}}"></script>
-
-    <input class="msg-search-key" type="hidden" value="{{key}}"/>
-    <input class="default-content-input" type="hidden" value="{{default_content}}"/>
-{% end %}
-
-{% block body_left %}
-    <!-- 编辑 -->
-    {% include message/component/message_edit.html %}
-
-    {% init message_tag = "" %}
-    {% init p = "" %}
-    <!-- Tab页 -->
-    {% init message_tab = "log" %}
-    {% init default_content = "" %}
-    {% init date = "" %}
-    {% init is_task_tag = False %}
-    
-    <div class="card">    
-        <div class="card-title btn-line-height">
-            {% if is_task_tag %}
-                <span>搜索待办</span>
-            {% else %}
-                <span>搜索随手记</span>
-            {% end %}
-
-            <div class="float-right">
-                {% if is_task_tag %}
-                    <a class="btn btn-default" href="{{_server_home}}/message?tag=task">待办</a>
-                {% else %}
-                    <a class="btn btn-default" href="{{_server_home}}/message?tag=log">随手记</a>
-                {% end %}
-                {% include common/button/back_button.html %}
-            </div>
-        </div>
-    </div>
-
-    {% if is_task_tag %}
-    <div class="card x-tab-box" data-tab-key="tag" data-tab-default="all">
-        <a class="x-tab" href="{{_server_home}}/message?tag=task.search&key={{quote(key)}}" data-tab-value="task.search">
-            待办
-        </a>
-        <a class="x-tab" href="{{_server_home}}/message?tag=done.search&key={{quote(key)}}" data-tab-value="done.search">
-            已完成
-        </a>
-    </div>
-    {% end %}
-
-    <!-- 事件转换 -->
-    {% include message/component/message_event.html %}
-
-    {% include message/component/message_keyword_info.html %}
-
-    {% if date != "" %}
-    <div class="card btn-line-height">
-        <span class="tag info">日期</span>
-        <span>{{date}}</span>
-    </div>
-    {% end %}
-
-    <!-- 内容区域 -->
-    {% include message/component/message_list.html %}
-
-    <script type="text/javascript">
-
-        xnote.state.message.messageTag = "{{message_tag}}";
-        xnote.state.message.tag = "{{tag}}";
-
-        $(function (e) {
-            function getParamTag() {
-                return xnote.getUrlParam("tag", "search");
-            }
-
-            function getParamPage() {
-                var page = getUrlParam("page");
-                if (page == undefined) {
-                    return 1;
-                } else {
-                    return page;
-                }
-            }
-
-            function getParamKey() {
-                // getUrlParam 获取参数空格会被处理成`+`
-                return $(".msg-search-key").val();
-            }
-
-            function onMessageRefresh() {
-                var params = getUrlParams();
-
-                params.tag  = getParamTag();
-                params.page = getParamPage();
-                params.key = getParamKey();
-
-                window.doRefreshMessageList(params);
-            }
-
-            function onMessageCreated() {
-                onMessageRefresh();
-            }
-
-            xnote.on("message.updated", onMessageRefresh);
-            xnote.on("message.created", onMessageCreated);
-
-            // 触发更新事件
-            xnote.fire("message.updated");
-        });
-    </script>
-
-{% end %}
-
-
-{% block body_right %}
-    <div class="desktop-only">
-        {% include note/component/group_special_folder.html %}
-        {% include message/component/right/tags.html %}
-    </div>
-{% end %}
+{% extends base %}
+
+{% block body_top %}
+
+    {% init default_content = "" %}
+    {% init show_tab = True %}
+
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/webuploader/webuploader.css">
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/js/message/message.js?ts={{_ts}}"></script>
+
+    <input class="msg-search-key" type="hidden" value="{{key}}"/>
+    <input class="default-content-input" type="hidden" value="{{default_content}}"/>
+{% end %}
+
+{% block body_left %}
+    <!-- 编辑 -->
+    {% include message/component/message_edit.html %}
+
+    {% init message_tag = "" %}
+    {% init p = "" %}
+    <!-- Tab页 -->
+    {% init message_tab = "log" %}
+    {% init default_content = "" %}
+    {% init date = "" %}
+    {% init is_task_tag = False %}
+    
+    <div class="card">    
+        <div class="card-title btn-line-height">
+            {% if is_task_tag %}
+                <span>搜索待办</span>
+            {% else %}
+                <span>搜索随手记</span>
+            {% end %}
+
+            <div class="float-right">
+                {% if is_task_tag %}
+                    <a class="btn btn-default" href="{{_server_home}}/message?tag=task">待办</a>
+                {% else %}
+                    <a class="btn btn-default" href="{{_server_home}}/message?tag=log">随手记</a>
+                {% end %}
+                {% include common/button/back_button.html %}
+            </div>
+        </div>
+    </div>
+
+    {% if is_task_tag %}
+    <div class="card x-tab-box" data-tab-key="tag" data-tab-default="all">
+        <a class="x-tab" href="{{_server_home}}/message?tag=task.search&key={{quote(key)}}" data-tab-value="task.search">
+            待办
+        </a>
+        <a class="x-tab" href="{{_server_home}}/message?tag=done.search&key={{quote(key)}}" data-tab-value="done.search">
+            已完成
+        </a>
+    </div>
+    {% end %}
+
+    <!-- 事件转换 -->
+    {% include message/component/message_event.html %}
+
+    {% include message/component/message_keyword_info.html %}
+
+    {% if date != "" %}
+    <div class="card btn-line-height">
+        <span class="tag info">日期</span>
+        <span>{{date}}</span>
+    </div>
+    {% end %}
+
+    <!-- 内容区域 -->
+    {% include message/component/message_list.html %}
+
+    <script type="text/javascript">
+
+        xnote.state.message.messageTag = "{{message_tag}}";
+        xnote.state.message.tag = "{{tag}}";
+
+        $(function (e) {
+            function getParamTag() {
+                return xnote.getUrlParam("tag", "search");
+            }
+
+            function getParamPage() {
+                var page = getUrlParam("page");
+                if (page == undefined) {
+                    return 1;
+                } else {
+                    return page;
+                }
+            }
+
+            function getParamKey() {
+                // getUrlParam 获取参数空格会被处理成`+`
+                return $(".msg-search-key").val();
+            }
+
+            function onMessageRefresh() {
+                var params = getUrlParams();
+
+                params.tag  = getParamTag();
+                params.page = getParamPage();
+                params.key = getParamKey();
+
+                window.doRefreshMessageList(params);
+            }
+
+            function onMessageCreated() {
+                onMessageRefresh();
+            }
+
+            xnote.on("message.updated", onMessageRefresh);
+            xnote.on("message.created", onMessageCreated);
+
+            // 触发更新事件
+            xnote.fire("message.updated");
+        });
+    </script>
+
+{% end %}
+
+
+{% block body_right %}
+    <div class="desktop-only">
+        {% include note/component/group_special_folder.html %}
+        {% include message/component/right/tags.html %}
+    </div>
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/message/page/message_tag_select.html` & `xnote-web-0.1.1/handlers/message/page/message_tag_select.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/page/message_tag_view.html` & `xnote-web-0.1.1/handlers/note/page/detail/note_detail.html`

 * *Files 22% similar despite different names*

```diff
@@ -1,59 +1,60 @@
 {% extends base %}
 
-<!-- 查看标签视图 -->
+{% block head %}
+    <script type="text/javascript" src="/static/lib/marked/marked.js"></script>
+    <script type="text/javascript" src="/static/js/marked-ext.js?ts={{_ts}}"></script>
+
+    {% include note/component/view_css.html %}
+
+{% end %}
+
 
 {% block body_left %}
-    {% include message/component/message_title.html %}
+    {% include note/component/editor/editor_default_vars.html %}
+    {# 收藏一下这个符号 › #}
+
+    <!-- comment 如果有新类型的文件，继续增加file_type即可，后台实现不用变更 -->
+    {% if file_type in ("md", "text", "log", "plan") %}
+        {% include note/component/editor/markdown.html %}
+    {% elif file_type == "gallery" %}
+        {% include note/component/editor/gallery.html %}
+    {% else %}
+        {% include note/component/editor/post.html %}
+    {% end %}
 
-    {% include message/component/message_tab_task.html %}
+    {# 文章信息 #}
+    {% include note/component/note_ext_info.html %}
 
-    {% include message/component/message_sub_link.html %}
+    {# 评论功能 #}
+    {% if file_type != "group" and show_comment %}
+        {% include note/page/comment.html %}
+    {% end %}
 
-    {% if message_tag == "calendar" %}
-        <!-- 月份选择器 -->
-        {% include common/date/month_picker.html %}
+    {# 分页 #}
+    {% if show_pagination and "page" in globals() %}
+        <div class="card">
+            {% include mod_pagenation.html %}
+        </div>
     {% end %}
 
-    {% include message/component/message_tag_list.html %}
+{% include note/component/script/delete_script.html %}
+{% include note/component/script/rename_script.html %}
 
-    <script type="text/javascript">
-        $(function (e) {
-            
-            function getInputTag() {
-                return getUrlParam("tag", "");
-            }
-
-            function getDisplayTag() {
-                return getUrlParam("displayTag", "");
-            }
-
-            function copyFromUrl() {
-                var url = "?"
-                for (var i = 0; i < arguments.length; i++) {
-                    var key = arguments[i];
-                    var value = getUrlParam(key, "");
-                    if (i !== 0) {
-                        url += "&";
-                    }
-                    url += key + "=" + value;
-                }
-                return url;
-            }
-
-            function onMonthSelected(event) {
-                var date = event.target;
-                window.location.href = copyFromUrl("tag", "displayTag", "orderby") + "&date=" + date;
-            }
-
-            xnote.on("date.month.selected", onMonthSelected);
-        })
-    </script>
+<script type="text/javascript">
 
+$(function () {
+    window.adjustTable();
+})
+</script>
 
 {% end %}
 
-{% block body_right %}
-    {% include message/component/message_date_right.html %}
-{% end %}
 
-  
+{% block body_right %}
+<div class="desktop-only">
+    {% include common/sidebar/app_index.html %}
+    {% init show_sidebar_group_entry = False %}
+    {% init show_sidebar_note_brothers = True %}
+    {% include note/component/sidebar/note_sidebar.html %}
+</div>
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/message/page/old/dairy.html` & `xnote-web-0.1.1/handlers/message/page/old/dairy.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/page/old/message_calendar_old.html` & `xnote-web-0.1.1/handlers/message/page/old/message_calendar_old.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/message/page/task_index.html` & `xnote-web-0.1.1/handlers/message/page/task_index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/mod_fs_path.html` & `xnote-web-0.1.1/handlers/mod_fs_path.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/ajax/comment_edit_dialog.html` & `xnote-web-0.1.1/handlers/note/ajax/comment_edit_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/ajax/comment_list.html` & `xnote-web-0.1.1/handlers/note/ajax/comment_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/ajax/edit_symbol_dialog.html` & `xnote-web-0.1.1/handlers/note/ajax/edit_symbol_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/ajax/group_option_dialog.html` & `xnote-web-0.1.1/handlers/note/ajax/group_option_dialog.html`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,94 +1,94 @@
-<!-- {#
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-10-27 21:17:40
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-16 16:59:43
-@FilePath     : /xnote/handlers/note/ajax/group_option_dialog.html
-@Description  : 描述
- #} -->
-{% comment 这是在笔记本详情页里面点击选项弹出的对话框 %}
-
-{% init share_to_list = [] %}
-{% init show_delete_btn = False %}
-
-<div class="card">
-    <div class="list-item">
-        <span>状态</span>
-        <div class="float-right">
-            <select value="{{file.level}}"
-                data-id="{{file.id}}"
-                onchange="xnote.api.note.changeStatus(this)">
-                <option value="1">置顶</option>
-                <option value="0">活跃</option>
-                <option value="-1">归档</option>
-            </select>
-        </div>
-    </div>
-
-    <div class="list-item">
-        <span class="btn-line-height">排序</span>
-        <div class="float-right">
-            <select class="orderby-select" 
-                onchange="xnote.note.changeOrderBy(this)"
-                data-id="{{file.id}}" value="{{file.orderby}}">
-                <option value="ctime_desc">最近创建</option>
-                <option value="name_asc">名称</option>
-                <option value="hot_desc">访问热度</option>
-            </select>
-        </div>
-    </div>
-
-    <div class="list-item">
-        <span>重命名</span>
-        <div class="float-right">
-            <a class="btn btn-default" 
-                data-id="{{file.id}}" 
-                data-name="{{file.name}}" 
-                onclick="renameNoteByAttr(this);">重命名</a>
-        </div>
-    </div>
-
-    <div class="list-item">
-        <span>分享</span>
-        <div class="float-right">
-            {% if file.is_public %}
-                <a class="btn btn-default" 
-                    data-id="{{file.id}}"
-                    onclick="xnote.api.note.cancelPublicShare(this)">取消分享</a>
-            {% else %}
-                <a class="btn btn-default" 
-                    data-id="{{file.id}}"
-                    onclick="xnote.api.note.shareToPublic(this)">分享</a>
-            {% end %}
-        </div>
-    </div>
-
-    <div class="list-item">
-        <span>批量操作</span>
-        <div class="float-right">
-            <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">进入</a>
-        </div>
-    </div>
-
-    <div class="list-item">
-        <span>移动</span>
-        <div class="float-right">
-            <a class="btn btn-default" onclick="xnote.note.openDialogToMoveByElement(this);" data-id="{{file.id}}">移动</a>
-        </div>
-    </div>
-
-    {% if show_delete_btn %}
-        <div class="list-item btn-line-height">
-            <span>删除</span>
-            <div class="float-right">
-                <a class="btn btn-danger" href="javascript:remove('{{file.id}}', '{{file.name}}')">删除</a>
-            </div>
-        </div>
-    {% end %}
-</div>
-
-<script>
-    // 初始化一些默认值
-    xnote.refresh();
+<!-- {#
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-10-27 21:17:40
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-16 16:59:43
+@FilePath     : /xnote/handlers/note/ajax/group_option_dialog.html
+@Description  : 描述
+ #} -->
+{% comment 这是在笔记本详情页里面点击选项弹出的对话框 %}
+
+{% init share_to_list = [] %}
+{% init show_delete_btn = False %}
+
+<div class="card">
+    <div class="list-item">
+        <span>状态</span>
+        <div class="float-right">
+            <select value="{{file.level}}"
+                data-id="{{file.id}}"
+                onchange="xnote.api.note.changeStatus(this)">
+                <option value="1">置顶</option>
+                <option value="0">活跃</option>
+                <option value="-1">归档</option>
+            </select>
+        </div>
+    </div>
+
+    <div class="list-item">
+        <span class="btn-line-height">排序</span>
+        <div class="float-right">
+            <select class="orderby-select" 
+                onchange="xnote.note.changeOrderBy(this)"
+                data-id="{{file.id}}" value="{{file.orderby}}">
+                <option value="ctime_desc">最近创建</option>
+                <option value="name_asc">名称</option>
+                <option value="hot_desc">访问热度</option>
+            </select>
+        </div>
+    </div>
+
+    <div class="list-item">
+        <span>重命名</span>
+        <div class="float-right">
+            <a class="btn btn-default" 
+                data-id="{{file.id}}" 
+                data-name="{{file.name}}" 
+                onclick="renameNoteByAttr(this);">重命名</a>
+        </div>
+    </div>
+
+    <div class="list-item">
+        <span>分享</span>
+        <div class="float-right">
+            {% if file.is_public %}
+                <a class="btn btn-default" 
+                    data-id="{{file.id}}"
+                    onclick="xnote.api.note.cancelPublicShare(this)">取消分享</a>
+            {% else %}
+                <a class="btn btn-default" 
+                    data-id="{{file.id}}"
+                    onclick="xnote.api.note.shareToPublic(this)">分享</a>
+            {% end %}
+        </div>
+    </div>
+
+    <div class="list-item">
+        <span>批量操作</span>
+        <div class="float-right">
+            <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">进入</a>
+        </div>
+    </div>
+
+    <div class="list-item">
+        <span>移动</span>
+        <div class="float-right">
+            <a class="btn btn-default" onclick="xnote.note.openDialogToMoveByElement(this);" data-id="{{file.id}}">移动</a>
+        </div>
+    </div>
+
+    {% if show_delete_btn %}
+        <div class="list-item btn-line-height">
+            <span>删除</span>
+            <div class="float-right">
+                <a class="btn btn-danger" href="javascript:remove('{{file.id}}', '{{file.name}}')">删除</a>
+            </div>
+        </div>
+    {% end %}
+</div>
+
+<script>
+    // 初始化一些默认值
+    xnote.refresh();
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/note/ajax/share_group_dialog.html` & `xnote-web-0.1.1/handlers/note/ajax/share_group_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/ajax/share_note_dialog.html` & `xnote-web-0.1.1/handlers/note/ajax/share_note_dialog.html`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,16 +1,16 @@
-<div class="card">
-    <p>说明：公开分享所有人可见，链接分享仅获取链接的人可见</p>
-    {% if file.is_public %}
-        <a class="btn btn-default" onclick="javascript:visitAndRefresh(this)" 
-            data-href="{{_server_home}}/note/share/cancel?id={{file.id}}">取消公开分享</a>
-    {% else %}
-        <a class="btn btn-default" onclick="javascript:visitAndRefresh(this)" 
-            data-href="{{_server_home}}/note/share?id={{file.id}}">公开分享</a>
-    {% end %}
-
-    <a class="btn btn-default note-share-link-btn" href="javascript:note_share_by_link(this)" 
-        data-clipboard-text="">链接分享</a>
-    
-</div>
-
-{% include note/ajax/share_group_dialog.html %}
+<div class="card">
+    <p>说明：公开分享所有人可见，链接分享仅获取链接的人可见</p>
+    {% if file.is_public %}
+        <a class="btn btn-default" onclick="javascript:visitAndRefresh(this)" 
+            data-href="{{_server_home}}/note/share/cancel?id={{file.id}}">取消公开分享</a>
+    {% else %}
+        <a class="btn btn-default" onclick="javascript:visitAndRefresh(this)" 
+            data-href="{{_server_home}}/note/share?id={{file.id}}">公开分享</a>
+    {% end %}
+
+    <a class="btn btn-default note-share-link-btn" href="javascript:note_share_by_link(this)" 
+        data-clipboard-text="">链接分享</a>
+    
+</div>
+
+{% include note/ajax/share_group_dialog.html %}
```

### Comparing `xnote-web-0.1.0/handlers/note/card/hot_notes.html` & `xnote-web-0.1.1/handlers/note/card/hot_notes.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/note_contents_left.html` & `xnote-web-0.1.1/handlers/note/card/note_contents_left.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/note_date_picker.html` & `xnote-web-0.1.1/handlers/note/card/note_date_picker.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/note_groups.html` & `xnote-web-0.1.1/handlers/note/card/note_groups.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/note_types.html` & `xnote-web-0.1.1/handlers/note/card/note_types.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/plan_note_card.html` & `xnote-web-0.1.1/handlers/note/card/plan_note_card.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/plan_sidebar.html` & `xnote-web-0.1.1/handlers/note/card/plan_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/recent_created_notes.html` & `xnote-web-0.1.1/handlers/note/card/recent_created_notes.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/recent_update_groups.html` & `xnote-web-0.1.1/handlers/note/card/recent_update_groups.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/recent_update_notes.html` & `xnote-web-0.1.1/handlers/note/card/recent_update_notes.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/sticky_notes.html` & `xnote-web-0.1.1/handlers/note/card/sticky_notes.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/card/task_memo.html` & `xnote-web-0.1.1/handlers/note/card/task_memo.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/comment.py` & `xnote-web-0.1.1/handlers/note/comment.py`

 * *Ordering differences only*

 * *Files 11% similar despite different names*

```diff
@@ -1,253 +1,253 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2019/08/10 23:44:48
-# @modified 2022/04/16 22:36:45
-import math
-from xnote.core import xconfig
-import xutils
-from xnote.core import xauth
-from xnote.core import xtemplate
-from xnote.core import xmanager
-from xutils import DAO
-from xutils import Storage
-from xutils import quote
-from xutils import textutil
-from xnote.core.xtemplate import T
-from . import dao as note_dao
-from . import dao_comment
-from xutils import webutil
-
-from .dao_comment import search_comment
-
-NOTE_DAO = DAO("note")
-
-def get_page_max(count):
-    return int(math.ceil(count/xconfig.PAGE_SIZE))
-
-
-def search_translator(parser, key0):
-    key = key0.lstrip("")
-    key = key.rstrip("")
-    quoted_key = textutil.quote(key)
-    value = textutil.escape_html(key0)
-    fmt = "<a class=\"link\" href=\"/search?search_type=comment&key={quoted_key}\">{value}</a>"
-    return fmt.format(quoted_key=quoted_key, value=value)
-
-def mark_text(content):
-    from xutils.text_parser import TextParser
-    from xutils.text_parser import set_img_file_ext
-    # 设置图片文集后缀
-    set_img_file_ext(xconfig.FS_IMG_EXT_LIST)
-
-    parser = TextParser()
-    parser.set_topic_translator(search_translator)
-    parser.set_search_translator(search_translator)
-
-    tokens = parser.parse(content)
-    return "".join(tokens)
-
-def process_comments(comments, show_note = False):
-    for comment in comments:
-        if comment.content is None:
-            continue
-        comment.html = mark_text(comment.content)
-
-        if show_note:
-            note = note_dao.get_by_id(comment.note_id, False)
-            if note != None:
-                comment.note_name = note.name
-                comment.note_url  = note.url
-
-def search_comment_summary(ctx):
-    comments = dao_comment.search_comment(user_name = ctx.user_name, keywords = ctx.words)
-    if len(comments) > 0:
-        result = Storage()
-        result.name = "搜索到[%s]条评论" % len(comments)
-        result.url  = "/search?key=%s&search_type=comment" % quote(ctx.key)
-        result.icon = "fa-comments-o"
-        result.show_more_link = True
-        ctx.messages.append(result)
-
-def search_comment_detail(ctx):
-    """搜索评论详细列表接口
-    @param {SearchContext} ctx 搜索上下文
-    @return None
-    """
-    result = []
-    comments = dao_comment.search_comment(user_name = ctx.user_name, keywords = ctx.words)
-
-    process_comments(comments, show_note = True)
-
-    for item in comments:
-        item.icon = "fa-comment-o"
-        item.name = "#评论 %s" % item.note_name
-        item.url  = item.note_url
-        item.mtime = item.ctime
-        result.append(item)
-
-    ctx.messages += result
-
-@xmanager.searchable(r".+")
-def on_search_comments(ctx):
-    if ctx.category == "default":
-        search_comment_summary(ctx)
-
-    if ctx.category == "comment":
-        search_comment_detail(ctx)
-
-def convert_to_html(comments, show_note = False, page = 1, page_max = 1, show_edit = False):
-    return xtemplate.render("note/ajax/comment_list.html", 
-        show_comment_edit = show_edit,
-        page = page,
-        page_max = page_max,
-        comments = comments, 
-        show_note = show_note)
-
-class CommentListAjaxHandler:
-
-    def GET(self):
-        note_id   = xutils.get_argument_str("note_id")
-        list_type = xutils.get_argument_str("list_type")
-        resp_type = xutils.get_argument_str("resp_type")
-        list_date = xutils.get_argument_str("list_date")
-        show_note = xutils.get_argument_bool("show_note")
-        show_edit = xutils.get_argument_bool("show_edit")
-        page = xutils.get_argument_int("page", 1)
-        page_max  = 1
-        page_size = xconfig.PAGE_SIZE
-        user_name = xauth.current_name_str()
-        offset = max(0, page-1) * xconfig.PAGE_SIZE
-
-        if list_type == "user":
-            count  = dao_comment.count_comments_by_user(user_name, list_date)
-            comments = dao_comment.list_comments_by_user(user_name, 
-                date = list_date, offset = offset, 
-                limit = page_size)
-        elif list_type == "search":
-            comments = self.search_comments(user_name)
-            count = len(comments)
-        else:
-            assert note_id != None and note_id != ""
-            comments  = dao_comment.list_comments(note_id, offset = offset, limit = page_size, user_name=user_name)
-            count = dao_comment.count_comment_by_note(note_id)
-        
-        page_max = get_page_max(count)
-
-        # 处理评论列表
-        process_comments(comments, show_note)
-
-        if resp_type == "html":
-            return convert_to_html(comments, show_note, 
-                page = page, page_max = page_max, show_edit = show_edit)
-        else:
-            return comments
-    
-    def search_comments(self, user_name):
-        key = xutils.get_argument("key", "")
-        note_id = xutils.get_argument("note_id", "")
-        keywords = textutil.split_words(key)
-        return search_comment(user_name = user_name, keywords = keywords, limit=1000, note_id = note_id)
-
-class SaveCommentAjaxHandler:
-
-    @xauth.login_required()
-    def POST(self):
-        note_id = xutils.get_argument_int("note_id")
-        content = xutils.get_argument_str("content")
-        type = xutils.get_argument_str("type")
-        user_info = xauth.current_user()
-
-        if user_info == None:
-            return webutil.FailedResult(code="403", message="请登录进行操作~")
-
-        if note_id == "":
-            return webutil.FailedResult(message="note_id参数为空")
-        
-        if content == "":
-            return dict(code = "400", message = "content参数为空")
-
-        comment = dao_comment.CommentDO()
-        comment.user = user_info.name
-        comment.user_id = user_info.id
-        comment.type = type
-        comment.content = content
-        comment.note_id = note_id
-
-        dao_comment.create_comment(comment)
-        
-        return dict(code = "success", success = True)
-
-class DeleteCommentAjaxHandler:
-
-    def GET(self):
-        return self.POST()
-
-    @xauth.login_required()
-    def POST(self):
-        comment_id = xutils.get_argument_str("comment_id")
-        user       = xauth.current_name()
-        comment    = dao_comment.get_comment(comment_id)
-        if comment is None:
-            dao_comment.delete_index(comment_id)
-            return webutil.SuccessResult()
-        if user != comment.user:
-            return dict(success = False, message = "unauthorized")
-        dao_comment.delete_comment(comment_id)
-        return dict(success = True, code = "success")
-
-class MyCommentsHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(user_name, "/note/comment/mine")
-        date = xutils.get_argument("date", "")
-
-        return xtemplate.render("note/page/comment_user_page.html", 
-            show_comment_title = False,
-            show_comment_create = False,
-            show_comment_note = True,
-            comment_list_date = date,
-            comment_list_type = "user")
-
-class CommentAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        p = xutils.get_argument("p")
-        user_name = xauth.current_name()
-        comment_id = xutils.get_argument_str("comment_id", "")
-
-        if p == "edit":
-            comment = dao_comment.get_comment(comment_id)
-            if comment == None:
-                return "评论不存在"
-            if comment.user != user_name:
-                return "无操作权限"
-            return xtemplate.render("note/ajax/comment_edit_dialog.html", comment = comment)
-        
-        if p == "update":
-            comment = dao_comment.get_comment(comment_id)
-            if comment == None:
-                return dict(code = "404", message = "评论不存在")
-            if comment.user != user_name:
-                return dict(code = "403", message = "无权限操作")
-            content = xutils.get_argument_str("content", "")
-            comment.content = content
-            dao_comment.update_comment(comment)
-            return dict(code = "success")
-        return "未知的操作"
-
-    def POST(self):
-        return self.GET()
-
-xutils.register_func("note.search_comment_detail", search_comment_detail)
-
-xurls = (
-    r"/note/comment", CommentAjaxHandler,
-    r"/note/comments", CommentListAjaxHandler,
-    r"/note/comment/list", CommentListAjaxHandler,
-    r"/note/comment/save", SaveCommentAjaxHandler,
-    r"/note/comment/delete", DeleteCommentAjaxHandler,
-    r"/note/comment/mine", MyCommentsHandler,
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2019/08/10 23:44:48
+# @modified 2022/04/16 22:36:45
+import math
+from xnote.core import xconfig
+import xutils
+from xnote.core import xauth
+from xnote.core import xtemplate
+from xnote.core import xmanager
+from xutils import DAO
+from xutils import Storage
+from xutils import quote
+from xutils import textutil
+from xnote.core.xtemplate import T
+from . import dao as note_dao
+from . import dao_comment
+from xutils import webutil
+
+from .dao_comment import search_comment
+
+NOTE_DAO = DAO("note")
+
+def get_page_max(count):
+    return int(math.ceil(count/xconfig.PAGE_SIZE))
+
+
+def search_translator(parser, key0):
+    key = key0.lstrip("")
+    key = key.rstrip("")
+    quoted_key = textutil.quote(key)
+    value = textutil.escape_html(key0)
+    fmt = "<a class=\"link\" href=\"/search?search_type=comment&key={quoted_key}\">{value}</a>"
+    return fmt.format(quoted_key=quoted_key, value=value)
+
+def mark_text(content):
+    from xutils.text_parser import TextParser
+    from xutils.text_parser import set_img_file_ext
+    # 设置图片文集后缀
+    set_img_file_ext(xconfig.FS_IMG_EXT_LIST)
+
+    parser = TextParser()
+    parser.set_topic_translator(search_translator)
+    parser.set_search_translator(search_translator)
+
+    tokens = parser.parse(content)
+    return "".join(tokens)
+
+def process_comments(comments, show_note = False):
+    for comment in comments:
+        if comment.content is None:
+            continue
+        comment.html = mark_text(comment.content)
+
+        if show_note:
+            note = note_dao.get_by_id(comment.note_id, False)
+            if note != None:
+                comment.note_name = note.name
+                comment.note_url  = note.url
+
+def search_comment_summary(ctx):
+    comments = dao_comment.search_comment(user_name = ctx.user_name, keywords = ctx.words)
+    if len(comments) > 0:
+        result = Storage()
+        result.name = "搜索到[%s]条评论" % len(comments)
+        result.url  = "/search?key=%s&search_type=comment" % quote(ctx.key)
+        result.icon = "fa-comments-o"
+        result.show_more_link = True
+        ctx.messages.append(result)
+
+def search_comment_detail(ctx):
+    """搜索评论详细列表接口
+    @param {SearchContext} ctx 搜索上下文
+    @return None
+    """
+    result = []
+    comments = dao_comment.search_comment(user_name = ctx.user_name, keywords = ctx.words)
+
+    process_comments(comments, show_note = True)
+
+    for item in comments:
+        item.icon = "fa-comment-o"
+        item.name = "#评论 %s" % item.note_name
+        item.url  = item.note_url
+        item.mtime = item.ctime
+        result.append(item)
+
+    ctx.messages += result
+
+@xmanager.searchable(r".+")
+def on_search_comments(ctx):
+    if ctx.category == "default":
+        search_comment_summary(ctx)
+
+    if ctx.category == "comment":
+        search_comment_detail(ctx)
+
+def convert_to_html(comments, show_note = False, page = 1, page_max = 1, show_edit = False):
+    return xtemplate.render("note/ajax/comment_list.html", 
+        show_comment_edit = show_edit,
+        page = page,
+        page_max = page_max,
+        comments = comments, 
+        show_note = show_note)
+
+class CommentListAjaxHandler:
+
+    def GET(self):
+        note_id   = xutils.get_argument_str("note_id")
+        list_type = xutils.get_argument_str("list_type")
+        resp_type = xutils.get_argument_str("resp_type")
+        list_date = xutils.get_argument_str("list_date")
+        show_note = xutils.get_argument_bool("show_note")
+        show_edit = xutils.get_argument_bool("show_edit")
+        page = xutils.get_argument_int("page", 1)
+        page_max  = 1
+        page_size = xconfig.PAGE_SIZE
+        user_name = xauth.current_name_str()
+        offset = max(0, page-1) * xconfig.PAGE_SIZE
+
+        if list_type == "user":
+            count  = dao_comment.count_comments_by_user(user_name, list_date)
+            comments = dao_comment.list_comments_by_user(user_name, 
+                date = list_date, offset = offset, 
+                limit = page_size)
+        elif list_type == "search":
+            comments = self.search_comments(user_name)
+            count = len(comments)
+        else:
+            assert note_id != None and note_id != ""
+            comments  = dao_comment.list_comments(note_id, offset = offset, limit = page_size, user_name=user_name)
+            count = dao_comment.count_comment_by_note(note_id)
+        
+        page_max = get_page_max(count)
+
+        # 处理评论列表
+        process_comments(comments, show_note)
+
+        if resp_type == "html":
+            return convert_to_html(comments, show_note, 
+                page = page, page_max = page_max, show_edit = show_edit)
+        else:
+            return comments
+    
+    def search_comments(self, user_name):
+        key = xutils.get_argument("key", "")
+        note_id = xutils.get_argument("note_id", "")
+        keywords = textutil.split_words(key)
+        return search_comment(user_name = user_name, keywords = keywords, limit=1000, note_id = note_id)
+
+class SaveCommentAjaxHandler:
+
+    @xauth.login_required()
+    def POST(self):
+        note_id = xutils.get_argument_int("note_id")
+        content = xutils.get_argument_str("content")
+        type = xutils.get_argument_str("type")
+        user_info = xauth.current_user()
+
+        if user_info == None:
+            return webutil.FailedResult(code="403", message="请登录进行操作~")
+
+        if note_id == "":
+            return webutil.FailedResult(message="note_id参数为空")
+        
+        if content == "":
+            return dict(code = "400", message = "content参数为空")
+
+        comment = dao_comment.CommentDO()
+        comment.user = user_info.name
+        comment.user_id = user_info.id
+        comment.type = type
+        comment.content = content
+        comment.note_id = note_id
+
+        dao_comment.create_comment(comment)
+        
+        return dict(code = "success", success = True)
+
+class DeleteCommentAjaxHandler:
+
+    def GET(self):
+        return self.POST()
+
+    @xauth.login_required()
+    def POST(self):
+        comment_id = xutils.get_argument_str("comment_id")
+        user       = xauth.current_name()
+        comment    = dao_comment.get_comment(comment_id)
+        if comment is None:
+            dao_comment.delete_index(comment_id)
+            return webutil.SuccessResult()
+        if user != comment.user:
+            return dict(success = False, message = "unauthorized")
+        dao_comment.delete_comment(comment_id)
+        return dict(success = True, code = "success")
+
+class MyCommentsHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(user_name, "/note/comment/mine")
+        date = xutils.get_argument("date", "")
+
+        return xtemplate.render("note/page/comment_user_page.html", 
+            show_comment_title = False,
+            show_comment_create = False,
+            show_comment_note = True,
+            comment_list_date = date,
+            comment_list_type = "user")
+
+class CommentAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        p = xutils.get_argument("p")
+        user_name = xauth.current_name()
+        comment_id = xutils.get_argument_str("comment_id", "")
+
+        if p == "edit":
+            comment = dao_comment.get_comment(comment_id)
+            if comment == None:
+                return "评论不存在"
+            if comment.user != user_name:
+                return "无操作权限"
+            return xtemplate.render("note/ajax/comment_edit_dialog.html", comment = comment)
+        
+        if p == "update":
+            comment = dao_comment.get_comment(comment_id)
+            if comment == None:
+                return dict(code = "404", message = "评论不存在")
+            if comment.user != user_name:
+                return dict(code = "403", message = "无权限操作")
+            content = xutils.get_argument_str("content", "")
+            comment.content = content
+            dao_comment.update_comment(comment)
+            return dict(code = "success")
+        return "未知的操作"
+
+    def POST(self):
+        return self.GET()
+
+xutils.register_func("note.search_comment_detail", search_comment_detail)
+
+xurls = (
+    r"/note/comment", CommentAjaxHandler,
+    r"/note/comments", CommentListAjaxHandler,
+    r"/note/comment/list", CommentListAjaxHandler,
+    r"/note/comment/save", SaveCommentAjaxHandler,
+    r"/note/comment/delete", DeleteCommentAjaxHandler,
+    r"/note/comment/mine", MyCommentsHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/note/component/attribute/note_category.html` & `xnote-web-0.1.1/handlers/note/component/attribute/note_category.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/batch_move.html` & `xnote-web-0.1.1/handlers/note/component/batch_move.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/create_note_header.html` & `xnote-web-0.1.1/handlers/note/component/create_note_header.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/css/edit_css.html` & `xnote-web-0.1.1/handlers/note/component/css/edit_css.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/css/gallery_css.html` & `xnote-web-0.1.1/handlers/note/component/css/gallery_css.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/detail_left.html` & `xnote-web-0.1.1/handlers/note/component/detail_left.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/editor_default_vars.html` & `xnote-web-0.1.1/handlers/note/component/editor/editor_default_vars.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/gallery.html` & `xnote-web-0.1.1/handlers/system/page/cache_admin.html`

 * *Files 26% similar despite different names*

```diff
@@ -1,97 +1,100 @@
+<!-- {#
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-09-12 20:43:45
+@LastEditors  : xupingmao
+@LastEditTime : 2023-07-01 10:28:56
+@FilePath     : /xnote/handlers/system/page/cache_admin.html
+@Description  : 描述
+ #} -->
+{% extends base %}
+
+{% block body_left %}
+
+<style>
+    .cache-table th {
+        width: 33%;
+    }
+    .cache-table td {
+        text-overflow: ellipsis;
+        max-height: 50px;
+    }
+</style>
 
-{% import xutils.textutil as textutil %}
-{% init parent_path = None %}
-
-{% include note/component/css/gallery_css.html %}
-
-<div class="card">
-    {% include note/component/view_header.html %}
+<div class="col-md-12 grid-card">
+    <h3 class="card-title btn-line-height">
+        <span>缓存信息</span>
+        <div class="float-right">
+            <!-- 不推荐脚本+配置来创建定时任务，直接通过插件来设置
+            <input class="dialog-btn" type="button" value="新增任务" dialog-url="/system/crontab/edit" />
+            -->
+            {% include common/button/back_button.html %}
+        </div>
+    </h3>
 </div>
 
 <div class="card">
-    {% include note/component/note_path.html %}
+    <div class="x-tab-box" data-tab-key="type" data-tab-default="local">
+        <a class="x-tab" href="{{_server_home}}/system/cache?type=local" data-tab-value="local">单机缓存</a>
+        <a class="x-tab" href="{{_server_home}}/system/cache?type=db" data-tab-value="db">数据库缓存</a>
+    </div>
 </div>
 
 <div class="card btn-line-height">
-    {% include note/component/view_header_tag.html %}
+    <span>缓存总数: {{cache_count}}</span>
+    <span>缓存大小: {{cache_size}}</span>
 </div>
 
-<style id="gallery-css" type="text/css"></style>
-
-<script type="text/javascript">
-xnote.execute(function () {
-    $("#noteIdInput").val("{{file.id}}");
-    function updateSize() { 
-        console.log("updateSize");
-        var listWidth = xnote.device.contentLeftWidth - 10;
-        var photoWidth = 150; // PC的默认值
-
-        if (xnote.device.isMobile) {
-            photoWidth = 100;
-            listWidth = listWidth - 20; // 移动端有一个padding
-        }
-
-        var cols = parseInt(listWidth / photoWidth);
-        photoWidth = parseInt(listWidth / cols);
-
-        console.log("photoWidth:", photoWidth);
-
-        var cssText = ".gallery-item{ width: ${width}px; height:${width}px;}";
-        cssText = xnote.renderTemplate(cssText, {width: photoWidth});
+<div class="card">
+    <table class="table cache-table">
+        <tr>
+            <th>Key</th>
+            <th>Value</th>
+            <th>Expire</th>
+        </tr>
+        {% for item in cache_list %}
+            <tr>
+                <td>{{item.key}}</td>
+                <td>
+                    <span>{{item.value_short}}</span>
+                    {% if item.value != item.value_short %}
+                        <br/><a class="toggle-text" data-close=true data-full="{{item.value}}" data-short="{{item.value_short}}">展开</a>
+                    {% end %}
+                </td>
+                <td>{{item.expire}}</td>
+            </tr>
+        {% end %}
+    </table>
+</div>
 
-        $("#gallery-css").html(cssText);
-        // 采用读写分离的方式，阅读和编辑使用两个不同的视图
-    }
+<div class="card">
+    {% include common/pagination.html %}
+</div>
 
-    xnote.events.onUploadPrepareEvent(function (event) {
-        console.log("onUploadPrepareEvent", event);
-        if (event.target.uploadType == "fs") {
-            $.post("/note/touch", {id: "{{file.id}}", resp_type: "json"}, function (resp) {
-                console.log(resp);
-            });
+<script>
+$(function () {
+    $(".toggle-text").click(function () {
+        var isClose = $(this).attr("data-close") === "true";
+        var newText = "";
+        var linkText = "";
+
+        if (isClose) {
+            newText = $(this).attr("data-full");
+            linkText = "收起";
+        } else {
+            newText = $(this).attr("data-short");
+            linkText = "展开";
         }
-    });
-
-    updateSize();
-    $(window).on("resize", updateSize);
-});
+        console.log(newText);
+        $(this).attr("data-close", !isClose);
+        $(this).text(linkText);
+        $(this).parent().find("span").text(newText);
+    })
+})
 </script>
 
-<div class="card">
-    <!-- 上传文件组件 -->
-    {% if file.creator == _user_name %} 
-        {% include fs/mod_fs_upload.html %}
-    {% end %}
-
-
-    <div class="file-list">
-        {% for item in filelist %}
-            {# 隐藏文件 #}
-            {% if item.name == "" %}
-                {% continue %}
-            {% end %}
-            
-            {% if xconfig.FS_HIDE_FILES and (item.name[0] == "." or item.name.endswith((".pyc", ".class"))) %}
-                {% continue %}
-            {% end %}
-
-            {% if not item.name.startswith("._") %}
-                <div class="gallery-item context-menu-one">
-                    <div class="icon-box">
-                        {% if item.type == "dir" %}
-                            <img class="fs-icon" src="/static/image/folder2.png">
-                        {% elif xutils.is_img_file(item.path) %}
-                            <img class="x-photo" src="/data/files/{{quote(item.path)}}?mode=thumbnail" 
-                                data-src="/data/files/{{quote(item.path)}}" loading="lazy">
-                        {% elif xutils.is_text_file(item.path) %}
-                            <img class="fs-icon" src="/static/image/icon_txt.png">
-                        {% else %}
-                            <img class="fs-icon" src="/static/image/file2.png">
-                        {% end %}
-                    </div>
-                </div>
-            {% end %}
-        {% end %}
-    </div>
-</div>
+{% end %}
 
+{% block body_right %}
+    {% include system/component/admin_nav.html %}
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/markdown.html` & `xnote-web-0.1.1/handlers/note/component/editor/markdown.html`

 * *Ordering differences only*

 * *Files 21% similar despite different names*

```diff
@@ -1,172 +1,172 @@
-{% init can_edit = False %}
-{% init edit_token = "" %}
-{% init show_draft_edit = False %}
-
-<!-- 解析CSV依赖 -->
-<script type="text/javascript" src="{{_server_home}}/_static/lib/csv.js/csv.js"></script>
-<!-- 代码高亮highlight依赖 -->
-<link rel="stylesheet" href="{{_server_home}}/_static/lib/highlight.js/11.6.0/styles/default.min.css">
-<link rel="stylesheet" href="{{_server_home}}/_static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css">
-<script src="{{_server_home}}/_static/lib/highlight.js/11.6.0/highlight.min.js"></script>
-<!-- csv编辑依赖 -->
-<script type="text/javascript" src="{{_server_home}}/_static/js/editor-csv.js"></script>
-
-<div class="card">
-    {% include "note/component/view_header.html" %}
-</div>
-
-<div class="card">
-    {% include note/component/note_path.html %}
-</div>
-
-<div class="card btn-line-height">
-    {% include note/component/view_header_tag.html %}
-</div>
-
-{% if show_draft_edit %}
-<div class="card btn-line-height">
-    <span>发现未提交的草稿</span>
-    <a href="{{_server_home}}/note/edit?id={{file.id}}&is_iframe={{is_iframe}}&load_draft=true">前往编辑</a>
-</div>
-{% end %}
-
-<div class="card col-md-12">
-    {% if file.content == "" %}
-        {% include common/text/empty_text.html %}
-    {% end %}
-    
-    <div class="row">
-        <div id="markdown-input-div" class="col-md-6 hide">
-            <textarea id="markdown-input" class="form-control" name="content" rows=50>{{file.content}}</textarea>
-        </div>
-
-        <div id="markdown-output-div" class="col-md-12 markdown-output-div">
-
-        </div>
-    </div>
-</div>
-
-<script type="text/javascript">
-    $(function () {
-
-        function trimText(text) {
-            text = text.trimLeft();
-            if (text.indexOf("<ul>") >= 0) {
-                return text.split("<ul>")[0];
-            }
-            if (text.indexOf("<ol>") >= 0) {
-                return text.split("<ol>")[0];
-            }
-            return text;
-        }
-
-        function convertTextToNew(text) {
-            var newText = text;
-            if (newText.startsWith("[]")) {
-                return "[x]" + newText.substring(2);
-            }
-            if (newText.startsWith("[x]") || newText.startsWith("[X]")) {
-                return "[]" + newText.substring(3);
-            }
-            return newText;
-        }
-
-        // 编辑csv事件
-        xnote.note.openEditCsvDialog = function(target) {
-            var oldCode = $(target).attr("data-code");
-            var codeIndex = parseInt($(target).attr("data-index"));
-            var lang = $(target).attr("data-lang");
-            var formattedCode = xnote.csv.formatCode(oldCode);
-
-            xnote.showTextDialog("编辑csv", formattedCode, ["更新", "取消"], function (index, layero, dialogInfo) {
-                var newCode = $(layero).find("textarea").val().trim();
-                // xnote.alert("newCode:" + newCode);
-
-                if (newCode === oldCode) {
-                    return;
-                }
-
-                var fenceLeft = "```" + lang + "\n";
-                var fenceRight = "\n```";
-
-                oldCode = fenceLeft + oldCode + fenceRight;
-                newCode = fenceLeft + newCode + fenceRight;
-
-                var oldContent = $("#markdown-input").val();
-                if (oldContent.indexOf(oldCode) < 0) {
-                    console.log("text not match:", oldCode);
-                    xnote.alert("笔记内容有变化，请刷新页面");
-                    return false;
-                }
-
-                var newContent = xnote.string.replaceByIndex(oldContent, oldCode, newCode, codeIndex);
-                console.log("newContent", newContent);
-
-                var params = {};
-                params.id = "{{file.id}}";
-                params.content = newContent;
-                params.resp_type = "json";
-                params.edit_token = "{{edit_token}}";
-                params.version = "{{file.version}}";
-
-                xnote.http.post("/note/update", params, function (resp) {
-                    if (resp.code == "success") {                    
-                        xnote.toast("更新成功，正在刷新页面");
-                        window.location.reload();
-                    } else {
-                        xnote.toast("更新失败:" + resp.message);
-                    }
-                });
-
-                return false;
-            }, ["large"]);
-        }
-        
-        function onCheckboxClicked(e) {
-            // 按下单选项的行为
-            var text = $(e.target).attr("data-text");
-            var index = parseInt($(e.target).attr("data-index"));
-            console.log("onCheckboxClicked", text);
-            text = trimText(text);
-            
-            var newText = convertTextToNew(text);
-
-            var oldContent = $("#markdown-input").val();
-            if (oldContent.indexOf(text) < 0) {
-                console.log("text not match:", text);
-                xnote.alert("标记任务失败，请刷新后重试");
-                return;
-            }
-
-            // console.log("text:", text, "newText:", newText);
-
-            // TODO: 先简单用replace处理一下
-            var newContent = xnote.string.replaceByIndex(oldContent, text, newText, index);
-            var params = {};
-            params.id = "{{file.id}}";
-            params.content = newContent;
-            params.resp_type = "json";
-            params.edit_token = "{{edit_token}}";
-            params.version = "{{file.version}}";
-
-            console.log("newContent:", newContent);
-
-            xnote.http.post("/note/update", params, function (resp) {
-                if (resp.code == "success") {                    
-                    xnote.toast("更新成功，正在刷新页面");
-                    window.location.reload();
-                } else {
-                    xnote.toast("更新失败:" + resp.message);
-                }
-            });
-        }
-
-        var input = $("#markdown-input").val();
-
-        // 扩展选项
-        var options = {};
-        options.onCheckboxClicked = onCheckboxClicked;
-        options.csvEditFunc = "xnote.note.openEditCsvDialog";
-        marked.parseAndRender(input, "#markdown-output-div", options);
-    });
-</script>
+{% init can_edit = False %}
+{% init edit_token = "" %}
+{% init show_draft_edit = False %}
+
+<!-- 解析CSV依赖 -->
+<script type="text/javascript" src="{{_server_home}}/_static/lib/csv.js/csv.js"></script>
+<!-- 代码高亮highlight依赖 -->
+<link rel="stylesheet" href="{{_server_home}}/_static/lib/highlight.js/11.6.0/styles/default.min.css">
+<link rel="stylesheet" href="{{_server_home}}/_static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css">
+<script src="{{_server_home}}/_static/lib/highlight.js/11.6.0/highlight.min.js"></script>
+<!-- csv编辑依赖 -->
+<script type="text/javascript" src="{{_server_home}}/_static/js/editor-csv.js"></script>
+
+<div class="card">
+    {% include "note/component/view_header.html" %}
+</div>
+
+<div class="card">
+    {% include note/component/note_path.html %}
+</div>
+
+<div class="card btn-line-height">
+    {% include note/component/view_header_tag.html %}
+</div>
+
+{% if show_draft_edit %}
+<div class="card btn-line-height">
+    <span>发现未提交的草稿</span>
+    <a href="{{_server_home}}/note/edit?id={{file.id}}&is_iframe={{is_iframe}}&load_draft=true">前往编辑</a>
+</div>
+{% end %}
+
+<div class="card col-md-12">
+    {% if file.content == "" %}
+        {% include common/text/empty_text.html %}
+    {% end %}
+    
+    <div class="row">
+        <div id="markdown-input-div" class="col-md-6 hide">
+            <textarea id="markdown-input" class="form-control" name="content" rows=50>{{file.content}}</textarea>
+        </div>
+
+        <div id="markdown-output-div" class="col-md-12 markdown-output-div">
+
+        </div>
+    </div>
+</div>
+
+<script type="text/javascript">
+    $(function () {
+
+        function trimText(text) {
+            text = text.trimLeft();
+            if (text.indexOf("<ul>") >= 0) {
+                return text.split("<ul>")[0];
+            }
+            if (text.indexOf("<ol>") >= 0) {
+                return text.split("<ol>")[0];
+            }
+            return text;
+        }
+
+        function convertTextToNew(text) {
+            var newText = text;
+            if (newText.startsWith("[]")) {
+                return "[x]" + newText.substring(2);
+            }
+            if (newText.startsWith("[x]") || newText.startsWith("[X]")) {
+                return "[]" + newText.substring(3);
+            }
+            return newText;
+        }
+
+        // 编辑csv事件
+        xnote.note.openEditCsvDialog = function(target) {
+            var oldCode = $(target).attr("data-code");
+            var codeIndex = parseInt($(target).attr("data-index"));
+            var lang = $(target).attr("data-lang");
+            var formattedCode = xnote.csv.formatCode(oldCode);
+
+            xnote.showTextDialog("编辑csv", formattedCode, ["更新", "取消"], function (index, layero, dialogInfo) {
+                var newCode = $(layero).find("textarea").val().trim();
+                // xnote.alert("newCode:" + newCode);
+
+                if (newCode === oldCode) {
+                    return;
+                }
+
+                var fenceLeft = "```" + lang + "\n";
+                var fenceRight = "\n```";
+
+                oldCode = fenceLeft + oldCode + fenceRight;
+                newCode = fenceLeft + newCode + fenceRight;
+
+                var oldContent = $("#markdown-input").val();
+                if (oldContent.indexOf(oldCode) < 0) {
+                    console.log("text not match:", oldCode);
+                    xnote.alert("笔记内容有变化，请刷新页面");
+                    return false;
+                }
+
+                var newContent = xnote.string.replaceByIndex(oldContent, oldCode, newCode, codeIndex);
+                console.log("newContent", newContent);
+
+                var params = {};
+                params.id = "{{file.id}}";
+                params.content = newContent;
+                params.resp_type = "json";
+                params.edit_token = "{{edit_token}}";
+                params.version = "{{file.version}}";
+
+                xnote.http.post("/note/update", params, function (resp) {
+                    if (resp.code == "success") {                    
+                        xnote.toast("更新成功，正在刷新页面");
+                        window.location.reload();
+                    } else {
+                        xnote.toast("更新失败:" + resp.message);
+                    }
+                });
+
+                return false;
+            }, ["large"]);
+        }
+        
+        function onCheckboxClicked(e) {
+            // 按下单选项的行为
+            var text = $(e.target).attr("data-text");
+            var index = parseInt($(e.target).attr("data-index"));
+            console.log("onCheckboxClicked", text);
+            text = trimText(text);
+            
+            var newText = convertTextToNew(text);
+
+            var oldContent = $("#markdown-input").val();
+            if (oldContent.indexOf(text) < 0) {
+                console.log("text not match:", text);
+                xnote.alert("标记任务失败，请刷新后重试");
+                return;
+            }
+
+            // console.log("text:", text, "newText:", newText);
+
+            // TODO: 先简单用replace处理一下
+            var newContent = xnote.string.replaceByIndex(oldContent, text, newText, index);
+            var params = {};
+            params.id = "{{file.id}}";
+            params.content = newContent;
+            params.resp_type = "json";
+            params.edit_token = "{{edit_token}}";
+            params.version = "{{file.version}}";
+
+            console.log("newContent:", newContent);
+
+            xnote.http.post("/note/update", params, function (resp) {
+                if (resp.code == "success") {                    
+                    xnote.toast("更新成功，正在刷新页面");
+                    window.location.reload();
+                } else {
+                    xnote.toast("更新失败:" + resp.message);
+                }
+            });
+        }
+
+        var input = $("#markdown-input").val();
+
+        // 扩展选项
+        var options = {};
+        options.onCheckboxClicked = onCheckboxClicked;
+        options.csvEditFunc = "xnote.note.openEditCsvDialog";
+        marked.parseAndRender(input, "#markdown-output-div", options);
+    });
+</script>
```

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/markdown_edit.html` & `xnote-web-0.1.1/handlers/note/component/editor/markdown_edit.html`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,422 +1,422 @@
-{% extends base.html %} 
-
-{% block head %}
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.css">
-    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/monokai.min.css">
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/mode/markdown.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/keymap/sublime.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/csv.js/csv.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/marked/marked.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/js/upload.js"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/js/marked-ext.js?ts={{_ts}}"></script>
-    <script type="text/javascript" src="{{_server_home}}/_static/js/editor.js?ts={{_ts}}"></script>
-    {% include note/component/css/edit_css.html %}
-{% end %} 
-
-{% block body_left %} 
-
-{% init error = "" %} 
-{% init download_csv = False %}
-{% init edit_token = "" %}
-
-<div class="alert">
-    {{error}}
-</div>
-
-<form id="mainFrame" action="/note/update" enctype="multipart/form-data" method="POST" class="col-md-12">
-    <div class="card">
-        <!-- note-edit-header -->
-        <div class="col-md-12" id="submit-div">
-            <div>
-                <span id="fileId" class="hide">{{file.id}}</span>
-            </div>
-            <div class="grid-title btn-line-height">
-                <span>文档编辑器</span>
-                <div class="float-right">
-                    <button class="inline-btn save-note-btn">保存</button>
-                    {% include common/button/back_button.html %}
-                </div>
-            </div>
-        </div>
-    </div>
-
-    <div class="card">
-        <!-- note-edit-body -->
-        <div class="col-md-12 note-edit-body">
-            <span id="result" style="color:green"></span>
-            <div class="col-md-12 toolbox">
-                <input type="button" id="insertCode" class="toolbox-btn" value="代码" />
-                <input type="button" id="insertStrong" class="toolbox-btn" value="加粗" />
-                <input type="button" id="insertDel" class="toolbox-btn" value="删除线" />
-                <input type="file" id="file" name="file" class="hidden-file" />
-                <input type="button" id="uploadBtn" class="toolbox-btn" value="文件" />
-                <input type="button" id="insertNoteLink" class="toolbox-btn" value="笔记链接" />
-                <input type="button" class="toolbox-btn" value="格式化" onclick="xnote.editor.formatMarkdownTable()" />
-                <div class="float-right">
-                    <div class="float-left">
-                        <span id="uploadProgress" class="upload-progress"></span>
-                        <span id="autosaveResult" class="hide float-left">自动保存草稿成功</span>
-                        <input type="button" class="toolbox-btn right btn-primary" 
-                            onclick="togglePreview(this)" value="预览" />
-                    </div>
-                </div>
-            </div>
-
-            <div class="col-md-12" id="editor-area">
-                <div id="edit-div">
-                    <input class="hide" name="id" value="{{file.id}}" />
-                    <input type="text" name="version" value="{{file.version}}" class="hide" />
-                    <input type="text" name="type" value="md" class="hide" />
-                    <input type="hidden" name="edit_token", value="{{edit_token}}">
-                </div>
-
-                <div class="col-md-12">
-                    <div id="editor" class="col-md-12" style="height: auto; ">
-                        <div id="markdown-input-div" class="col-md-12">
-                            <textarea id="markdown-input" class="form-control" name="content" rows=50>{{file.content}}</textarea>
-                        </div>
-
-                        <div id="markdown-output-div" class="col-md-6 hide"></div>
-                    </div>
-                </div>
-            </div>
-            
-        </div>
-    </div>
-</form>
-
-<script type="text/javascript">
-    function codeInsert(code) {
-        codeMirror.replaceSelection(code, 'around');
-    }
-
-    // 注册到xnote的接口中
-    xnote.editor.codeInsert = codeInsert;
-    xnote.editor.lastKeyUpTime = 0;
-    xnote.state.reloadDraft = false;
-
-    function initMdCodeMirror() {
-        if (window.codeMirror) {
-            return;
-        }
-        var height = Math.max(500, $("#markdown-output-div").height());
-        var editor = $("#markdown-input")[0];
-
-        if ($("#markdown-input").text() == "") {
-            $("#markdown-input").text("\n\n\n\n\n");
-        }
-
-        window.codeMirror = initCodeMirror("#markdown-input", {
-            mode: "text/x-markdown",
-            height: "auto"
-        });
-
-        xnote.codeMirror = window.codeMirror;
-    }
-
-    function initEditor() {
-        var clientWidth = document.body.clientWidth;
-        if (clientWidth < 1000) {
-            // 至少需要500px方便编写
-            mobileEdit();
-            return;
-        }
-        initMdCodeMirror();
-    }
-
-    function mobileEdit() {
-        window.location.href = "/note/edit?id={{file.id}}&device=mobile";
-    }
-
-    function togglePreview(target) {
-        if ($("#markdown-input-div").hasClass("col-md-12")) {
-            // 开启预览
-            // 全屏模式
-            $("#markdown-input-div").addClass("col-md-6").removeClass("col-md-12");
-            $("#markdown-output-div").removeClass("hide");
-            $(target).val("关闭预览");
-
-            // 强制刷新页面
-            updatePreview(true);
-        } else {
-            // 半屏模式
-            $("#markdown-input-div").removeClass("col-md-6").addClass("col-md-12");
-            $("#markdown-output-div").addClass("hide");
-            $(target).val("预览");
-        }
-        // 重新初始化codeMirror
-        codeMirror.setSize("auto", "auto");
-    }
-
-    $(document).ready(function () {
-        var oldContent = $("#markdown-input").val();
-        var lastSaved = $("#markdown-input").val();
-        var fileId = $("#fileId").text();
-        var updatePreviewIntervalId = null;
-
-        function contentUnchanged() {
-            var input = $("#markdown-input").val();
-            return input == oldContent;
-        }
-
-        window.updatePreview = function(force) {
-            var input = $("#markdown-input").val();
-
-            if (force === undefined) {
-                force = false;
-            }
-            
-            if (!force && contentUnchanged()) {
-                return;
-            }
-
-            if ($("#markdown-output-div").hasClass("hide")) {
-                return;
-            }
-            oldContent = input;
-            var options = { hideMenu: true };
-            marked.parseAndRender(input, "#markdown-output-div", options);
-            $("#markdown-output-div").height($("#editor").height());
-
-            xnote.fire("editor.change", {});
-        }
-
-        function autoSave(force) {
-            var input = $("#markdown-input").val();
-            // not modified
-            if (force != true && input == lastSaved) {
-                return;
-            }
-
-            lastSaved = input;
-            var params = {
-                action: "lock_and_save",
-                id: fileId,
-                content: input,
-                token: "{{edit_token}}",
-                version: "{{file.version}}"
-            };
-
-            xnote.http.post("/note/draft", params, function (resp) {
-                console.log(resp);
-                if (resp.code == "success") {
-                    $("#autosaveResult").show().fadeOut(1000);
-                } else if (resp.code == "conflict") {
-                    xnote.codeMirror.options.readOnly = "nocursor"; // 不允许编辑了
-                    xnote.confirm(resp.message, function () {
-                        // 偷锁编辑
-                        stealLockAndEdit();
-                    });
-                } else if (resp.code == "version_too_low") {
-                    xnote.codeMirror.options.readOnly = "nocursor"; // 不允许编辑了
-                    xnote.confirm(resp.message, function() {
-                        // 重新加载草稿
-                        reloadDraft();
-                    })
-                } else {
-                    xnote.toast(resp.message)
-                };
-            });
-
-            xnote.fire("editor.change", {});
-        };
-
-        function stealLockAndEdit() {
-            var params = {
-                action: "steal_lock",
-                id: fileId,
-                token: "{{edit_token}}"
-            }
-            xnote.http.post("/note/draft", params, function (resp) {
-                if (resp.code == "success") {
-                    if (resp.data != null) {
-                        xnote.codeMirror.setValue(resp.data);
-                    }
-                    xnote.codeMirror.options.readOnly = false; // 开启编辑
-                } else {
-                    xnote.alert(resp.message);
-                }
-            });
-        }
-
-        function reloadDraft() {
-            xnote.state.reloadDraft = true;
-            window.location.reload();
-        }
-
-        $("#insertCode").on("click", function () {
-            var selection = codeMirror.getSelection();
-            if (selection != "" && selection != null) {
-                if (selection.indexOf('\n') >= 0) {
-                    codeMirror.replaceSelection("```" + selection + "```", "around");
-                } else {
-                    codeMirror.replaceSelection("`" + selection + "`", "around");
-                }
-            } else {
-                codeInsert("```\n[代码]\n```");
-            }
-        });
-
-        function toggleSurround(chars) {
-            var selection = codeMirror.getSelection();
-            if (selection.startsWith(chars) && selection.endsWith(chars)) {
-                codeMirror.replaceSelection(selection.substring(chars.length, selection.length - chars.length), "around");
-            } else {
-                codeMirror.replaceSelection(chars + selection + chars, "around");
-            }
-        }
-
-        $("#insertStrong").on("click", function () {
-            toggleSurround("**");
-        });
-
-        $("#insertDel").click(function () {
-            toggleSurround("~~");
-        });
-
-        $("#insertNoteLink").click(function () {
-            // showAjaxDialog是异步的，没有返回值
-            xnote.showAjaxDialog("选择笔记", "/search/dialog?search_type=note&callback=insertNoteLinkCallback");
-
-            window.insertNoteLinkCallback = function (param) {
-                var link = "[" + param.name + "](" + param.url + ")";
-                codeInsert(link);
-                xnote.closeDialog("last");
-            };
-        });
-
-        // 格式化表格
-        xnote.editor.formatMarkdownTable = function () {
-            var cursor = codeMirror.getCursor();
-            var oldValue = codeMirror.doc.getValue();
-            var formatedText = formatMarkdownTable(oldValue);
-            // codeMirror.replaceSelection(formatedText, "around");
-            if (oldValue != formatedText) {
-                // console.log(formatedText);
-                codeMirror.doc.setValue(formatedText);
-                codeMirror.setCursor(cursor);
-            }
-        };
-
-        // 文件上传
-        $("#uploadBtn").click(function () {
-            console.log("准备上传文件...");
-            xnote.requestUpload("#file", false, function (resp) {
-                console.log("上传文件:", resp);
-                var fileLink = resp.link;
-                codeInsert(fileLink);
-            });
-        });
-
-        // 通过剪切板上传
-        $(document).on("paste", function (e) {
-            e.preventDefault();
-            xnote.requestUploadByClip(e, '', function (respJson) {
-                console.log(respJson);
-                var link = respJson.link;
-                codeInsert(link);
-            });
-        });
-
-        function serverSaveNote() {
-            var input = $("#markdown-input").val();
-            var params = {
-                id: fileId,
-                content: input,
-                type: "md",
-                edit_token: "{{edit_token}}",
-                version: "{{file.version}}"
-            };
-
-
-            xnote.http.post("/note/save", params, function (resp) {
-                if (resp.code == "success") {
-                    window.SUBMIT_FORM = true;
-                    xnote.toast("保存成功");
-                    window.location.href = "/note/view/" + fileId;
-                } else {
-                    xnote.alert("保存失败:" + resp.message);
-                }
-            }).fail(function (err) {
-                xnote.alert("保存失败:" + err);
-            });
-        }
-
-        // 保存笔记操作
-        $(".save-note-btn").click(function (e) {
-            e.preventDefault();
-            if (xnote.state.system.nodeRole == "follower") {
-                xnote.confirm("当前是从节点运行, 保存后可能被覆盖, 确认保存?", function (resp) {
-                    serverSaveNote();
-                })
-            } else {
-                serverSaveNote();
-            }
-        });
-
-        // 退出确认的询问
-        window.onbeforeunload=function(e){
-            if (contentUnchanged()) {
-                return;
-            }
-            
-            if (xnote.state.reloadDraft) {
-                console.log("reload draft");
-                return;
-            }
-
-            if (window.SUBMIT_FORM) {
-                console.log("form is submit");
-                return;
-            }
-            
-            var e = window.event||e;  
-            e.returnValue = "确定离开当前页面吗？";
-        };
-
-        function onPageLoad() {
-            initEditor();
-
-            if ("{{_user_config.show_md_preview}}" == "true") {
-                togglePreview();
-                updatePreview(true);
-            } else {
-                // do nothing
-            }
-
-            updatePreviewIntervalId = setInterval(updatePreview, 200);
-            // 调整高度
-            adjustHeight("#editor-area", 30);
-            window.SUBMIT_FORM = false;
-
-            setInterval(autoSave, 500);
-
-            // 强制执行一次
-            autoSave(true);
-        };
-
-        function autoFormat() {
-            // 体验不行, 先关闭
-            // if (!xnote.isTyping()) {
-            //     xnote.editor.formatMarkdownTable();
-            // }
-            // setTimeout(autoFormat, 1000);
-        }
-
-        onPageLoad();
-
-        // 自动格式化
-        autoFormat();
-    });
-
-</script>
-
-<!-- GROUPS: {{file.groups}} -->
-{% end %}
-
-
-{% block body_right %}
-    {% include note/component/sidebar/markdown_edit_sidebar.html %}
-{% end %}
+{% extends base.html %} 
+
+{% block head %}
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.css">
+    <link rel="stylesheet" type="text/css" href="{{_server_home}}/_static/lib/codemirror/theme/monokai.min.css">
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/5.65.12/codemirror.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/mode/markdown.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/codemirror/keymap/sublime.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/csv.js/csv.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/marked/marked.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/lib/webuploader/webuploader.nolog.min.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/js/upload.js"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/js/marked-ext.js?ts={{_ts}}"></script>
+    <script type="text/javascript" src="{{_server_home}}/_static/js/editor.js?ts={{_ts}}"></script>
+    {% include note/component/css/edit_css.html %}
+{% end %} 
+
+{% block body_left %} 
+
+{% init error = "" %} 
+{% init download_csv = False %}
+{% init edit_token = "" %}
+
+<div class="alert">
+    {{error}}
+</div>
+
+<form id="mainFrame" action="/note/update" enctype="multipart/form-data" method="POST" class="col-md-12">
+    <div class="card">
+        <!-- note-edit-header -->
+        <div class="col-md-12" id="submit-div">
+            <div>
+                <span id="fileId" class="hide">{{file.id}}</span>
+            </div>
+            <div class="grid-title btn-line-height">
+                <span>文档编辑器</span>
+                <div class="float-right">
+                    <button class="inline-btn save-note-btn">保存</button>
+                    {% include common/button/back_button.html %}
+                </div>
+            </div>
+        </div>
+    </div>
+
+    <div class="card">
+        <!-- note-edit-body -->
+        <div class="col-md-12 note-edit-body">
+            <span id="result" style="color:green"></span>
+            <div class="col-md-12 toolbox">
+                <input type="button" id="insertCode" class="toolbox-btn" value="代码" />
+                <input type="button" id="insertStrong" class="toolbox-btn" value="加粗" />
+                <input type="button" id="insertDel" class="toolbox-btn" value="删除线" />
+                <input type="file" id="file" name="file" class="hidden-file" />
+                <input type="button" id="uploadBtn" class="toolbox-btn" value="文件" />
+                <input type="button" id="insertNoteLink" class="toolbox-btn" value="笔记链接" />
+                <input type="button" class="toolbox-btn" value="格式化" onclick="xnote.editor.formatMarkdownTable()" />
+                <div class="float-right">
+                    <div class="float-left">
+                        <span id="uploadProgress" class="upload-progress"></span>
+                        <span id="autosaveResult" class="hide float-left">自动保存草稿成功</span>
+                        <input type="button" class="toolbox-btn right btn-primary" 
+                            onclick="togglePreview(this)" value="预览" />
+                    </div>
+                </div>
+            </div>
+
+            <div class="col-md-12" id="editor-area">
+                <div id="edit-div">
+                    <input class="hide" name="id" value="{{file.id}}" />
+                    <input type="text" name="version" value="{{file.version}}" class="hide" />
+                    <input type="text" name="type" value="md" class="hide" />
+                    <input type="hidden" name="edit_token", value="{{edit_token}}">
+                </div>
+
+                <div class="col-md-12">
+                    <div id="editor" class="col-md-12" style="height: auto; ">
+                        <div id="markdown-input-div" class="col-md-12">
+                            <textarea id="markdown-input" class="form-control" name="content" rows=50>{{file.content}}</textarea>
+                        </div>
+
+                        <div id="markdown-output-div" class="col-md-6 hide"></div>
+                    </div>
+                </div>
+            </div>
+            
+        </div>
+    </div>
+</form>
+
+<script type="text/javascript">
+    function codeInsert(code) {
+        codeMirror.replaceSelection(code, 'around');
+    }
+
+    // 注册到xnote的接口中
+    xnote.editor.codeInsert = codeInsert;
+    xnote.editor.lastKeyUpTime = 0;
+    xnote.state.reloadDraft = false;
+
+    function initMdCodeMirror() {
+        if (window.codeMirror) {
+            return;
+        }
+        var height = Math.max(500, $("#markdown-output-div").height());
+        var editor = $("#markdown-input")[0];
+
+        if ($("#markdown-input").text() == "") {
+            $("#markdown-input").text("\n\n\n\n\n");
+        }
+
+        window.codeMirror = initCodeMirror("#markdown-input", {
+            mode: "text/x-markdown",
+            height: "auto"
+        });
+
+        xnote.codeMirror = window.codeMirror;
+    }
+
+    function initEditor() {
+        var clientWidth = document.body.clientWidth;
+        if (clientWidth < 1000) {
+            // 至少需要500px方便编写
+            mobileEdit();
+            return;
+        }
+        initMdCodeMirror();
+    }
+
+    function mobileEdit() {
+        window.location.href = "/note/edit?id={{file.id}}&device=mobile";
+    }
+
+    function togglePreview(target) {
+        if ($("#markdown-input-div").hasClass("col-md-12")) {
+            // 开启预览
+            // 全屏模式
+            $("#markdown-input-div").addClass("col-md-6").removeClass("col-md-12");
+            $("#markdown-output-div").removeClass("hide");
+            $(target).val("关闭预览");
+
+            // 强制刷新页面
+            updatePreview(true);
+        } else {
+            // 半屏模式
+            $("#markdown-input-div").removeClass("col-md-6").addClass("col-md-12");
+            $("#markdown-output-div").addClass("hide");
+            $(target).val("预览");
+        }
+        // 重新初始化codeMirror
+        codeMirror.setSize("auto", "auto");
+    }
+
+    $(document).ready(function () {
+        var oldContent = $("#markdown-input").val();
+        var lastSaved = $("#markdown-input").val();
+        var fileId = $("#fileId").text();
+        var updatePreviewIntervalId = null;
+
+        function contentUnchanged() {
+            var input = $("#markdown-input").val();
+            return input == oldContent;
+        }
+
+        window.updatePreview = function(force) {
+            var input = $("#markdown-input").val();
+
+            if (force === undefined) {
+                force = false;
+            }
+            
+            if (!force && contentUnchanged()) {
+                return;
+            }
+
+            if ($("#markdown-output-div").hasClass("hide")) {
+                return;
+            }
+            oldContent = input;
+            var options = { hideMenu: true };
+            marked.parseAndRender(input, "#markdown-output-div", options);
+            $("#markdown-output-div").height($("#editor").height());
+
+            xnote.fire("editor.change", {});
+        }
+
+        function autoSave(force) {
+            var input = $("#markdown-input").val();
+            // not modified
+            if (force != true && input == lastSaved) {
+                return;
+            }
+
+            lastSaved = input;
+            var params = {
+                action: "lock_and_save",
+                id: fileId,
+                content: input,
+                token: "{{edit_token}}",
+                version: "{{file.version}}"
+            };
+
+            xnote.http.post("/note/draft", params, function (resp) {
+                console.log(resp);
+                if (resp.code == "success") {
+                    $("#autosaveResult").show().fadeOut(1000);
+                } else if (resp.code == "conflict") {
+                    xnote.codeMirror.options.readOnly = "nocursor"; // 不允许编辑了
+                    xnote.confirm(resp.message, function () {
+                        // 偷锁编辑
+                        stealLockAndEdit();
+                    });
+                } else if (resp.code == "version_too_low") {
+                    xnote.codeMirror.options.readOnly = "nocursor"; // 不允许编辑了
+                    xnote.confirm(resp.message, function() {
+                        // 重新加载草稿
+                        reloadDraft();
+                    })
+                } else {
+                    xnote.toast(resp.message)
+                };
+            });
+
+            xnote.fire("editor.change", {});
+        };
+
+        function stealLockAndEdit() {
+            var params = {
+                action: "steal_lock",
+                id: fileId,
+                token: "{{edit_token}}"
+            }
+            xnote.http.post("/note/draft", params, function (resp) {
+                if (resp.code == "success") {
+                    if (resp.data != null) {
+                        xnote.codeMirror.setValue(resp.data);
+                    }
+                    xnote.codeMirror.options.readOnly = false; // 开启编辑
+                } else {
+                    xnote.alert(resp.message);
+                }
+            });
+        }
+
+        function reloadDraft() {
+            xnote.state.reloadDraft = true;
+            window.location.reload();
+        }
+
+        $("#insertCode").on("click", function () {
+            var selection = codeMirror.getSelection();
+            if (selection != "" && selection != null) {
+                if (selection.indexOf('\n') >= 0) {
+                    codeMirror.replaceSelection("```" + selection + "```", "around");
+                } else {
+                    codeMirror.replaceSelection("`" + selection + "`", "around");
+                }
+            } else {
+                codeInsert("```\n[代码]\n```");
+            }
+        });
+
+        function toggleSurround(chars) {
+            var selection = codeMirror.getSelection();
+            if (selection.startsWith(chars) && selection.endsWith(chars)) {
+                codeMirror.replaceSelection(selection.substring(chars.length, selection.length - chars.length), "around");
+            } else {
+                codeMirror.replaceSelection(chars + selection + chars, "around");
+            }
+        }
+
+        $("#insertStrong").on("click", function () {
+            toggleSurround("**");
+        });
+
+        $("#insertDel").click(function () {
+            toggleSurround("~~");
+        });
+
+        $("#insertNoteLink").click(function () {
+            // showAjaxDialog是异步的，没有返回值
+            xnote.showAjaxDialog("选择笔记", "/search/dialog?search_type=note&callback=insertNoteLinkCallback");
+
+            window.insertNoteLinkCallback = function (param) {
+                var link = "[" + param.name + "](" + param.url + ")";
+                codeInsert(link);
+                xnote.closeDialog("last");
+            };
+        });
+
+        // 格式化表格
+        xnote.editor.formatMarkdownTable = function () {
+            var cursor = codeMirror.getCursor();
+            var oldValue = codeMirror.doc.getValue();
+            var formatedText = formatMarkdownTable(oldValue);
+            // codeMirror.replaceSelection(formatedText, "around");
+            if (oldValue != formatedText) {
+                // console.log(formatedText);
+                codeMirror.doc.setValue(formatedText);
+                codeMirror.setCursor(cursor);
+            }
+        };
+
+        // 文件上传
+        $("#uploadBtn").click(function () {
+            console.log("准备上传文件...");
+            xnote.requestUpload("#file", false, function (resp) {
+                console.log("上传文件:", resp);
+                var fileLink = resp.link;
+                codeInsert(fileLink);
+            });
+        });
+
+        // 通过剪切板上传
+        $(document).on("paste", function (e) {
+            e.preventDefault();
+            xnote.requestUploadByClip(e, '', function (respJson) {
+                console.log(respJson);
+                var link = respJson.link;
+                codeInsert(link);
+            });
+        });
+
+        function serverSaveNote() {
+            var input = $("#markdown-input").val();
+            var params = {
+                id: fileId,
+                content: input,
+                type: "md",
+                edit_token: "{{edit_token}}",
+                version: "{{file.version}}"
+            };
+
+
+            xnote.http.post("/note/save", params, function (resp) {
+                if (resp.code == "success") {
+                    window.SUBMIT_FORM = true;
+                    xnote.toast("保存成功");
+                    window.location.href = "/note/view/" + fileId;
+                } else {
+                    xnote.alert("保存失败:" + resp.message);
+                }
+            }).fail(function (err) {
+                xnote.alert("保存失败:" + err);
+            });
+        }
+
+        // 保存笔记操作
+        $(".save-note-btn").click(function (e) {
+            e.preventDefault();
+            if (xnote.state.system.nodeRole == "follower") {
+                xnote.confirm("当前是从节点运行, 保存后可能被覆盖, 确认保存?", function (resp) {
+                    serverSaveNote();
+                })
+            } else {
+                serverSaveNote();
+            }
+        });
+
+        // 退出确认的询问
+        window.onbeforeunload=function(e){
+            if (contentUnchanged()) {
+                return;
+            }
+            
+            if (xnote.state.reloadDraft) {
+                console.log("reload draft");
+                return;
+            }
+
+            if (window.SUBMIT_FORM) {
+                console.log("form is submit");
+                return;
+            }
+            
+            var e = window.event||e;  
+            e.returnValue = "确定离开当前页面吗？";
+        };
+
+        function onPageLoad() {
+            initEditor();
+
+            if ("{{_user_config.show_md_preview}}" == "true") {
+                togglePreview();
+                updatePreview(true);
+            } else {
+                // do nothing
+            }
+
+            updatePreviewIntervalId = setInterval(updatePreview, 200);
+            // 调整高度
+            adjustHeight("#editor-area", 30);
+            window.SUBMIT_FORM = false;
+
+            setInterval(autoSave, 500);
+
+            // 强制执行一次
+            autoSave(true);
+        };
+
+        function autoFormat() {
+            // 体验不行, 先关闭
+            // if (!xnote.isTyping()) {
+            //     xnote.editor.formatMarkdownTable();
+            // }
+            // setTimeout(autoFormat, 1000);
+        }
+
+        onPageLoad();
+
+        // 自动格式化
+        autoFormat();
+    });
+
+</script>
+
+<!-- GROUPS: {{file.groups}} -->
+{% end %}
+
+
+{% block body_right %}
+    {% include note/component/sidebar/markdown_edit_sidebar.html %}
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/markdown_edit.mobile.html` & `xnote-web-0.1.1/handlers/note/component/editor/markdown_edit.mobile.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/post.html` & `xnote-web-0.1.1/handlers/note/component/editor/post.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/table_lang.html` & `xnote-web-0.1.1/handlers/note/component/editor/table_lang.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/editor/table_myexcel.html` & `xnote-web-0.1.1/handlers/note/component/editor/table_myexcel.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/filter/group_tag_filter.html` & `xnote-web-0.1.1/handlers/note/component/filter/group_tag_filter.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/filter/note_tag_filter.html` & `xnote-web-0.1.1/handlers/note/component/filter/note_tag_filter.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/filter/type_filter.html` & `xnote-web-0.1.1/handlers/note/component/filter/type_filter.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/group_select.html` & `xnote-web-0.1.1/handlers/note/component/group_select.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/group_select_tree.html` & `xnote-web-0.1.1/handlers/note/component/group_select_tree.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/header/common_header.html` & `xnote-web-0.1.1/handlers/note/component/header/common_header.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/header/group_detail_header.html` & `xnote-web-0.1.1/handlers/note/component/header/group_detail_header.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/mobile/group_category_switch.html` & `xnote-web-0.1.1/handlers/note/component/mobile/group_category_switch.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/mod_aside.html` & `xnote-web-0.1.1/handlers/note/component/mod_aside.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/note_orderby_select.html` & `xnote-web-0.1.1/handlers/note/component/note_orderby_select.html`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,18 +1,18 @@
-{# <!--
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2021-10-31 11:54:18
-@LastEditors  : xupingmao
-@LastEditTime : 2022-06-05 12:17:15
-@FilePath     : /xnote/handlers/note/component/note_orderby_select.html
-@Description  : 描述
---> #}
-<div class="row">
-    <span class="btn-line-height">排序</span>
-    <div class="float-right">
-        <select class="orderby-select" data-id="{{file.id}}" value="{{file.orderby}}" onchange="xnote.note.changeOrderBy(this);">
-            <option value="ctime_priority">最近创建</option>
-            <option value="name_priority">名称</option>
-        </select>
-    </div>
+{# <!--
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2021-10-31 11:54:18
+@LastEditors  : xupingmao
+@LastEditTime : 2022-06-05 12:17:15
+@FilePath     : /xnote/handlers/note/component/note_orderby_select.html
+@Description  : 描述
+--> #}
+<div class="row">
+    <span class="btn-line-height">排序</span>
+    <div class="float-right">
+        <select class="orderby-select" data-id="{{file.id}}" value="{{file.orderby}}" onchange="xnote.note.changeOrderBy(this);">
+            <option value="ctime_priority">最近创建</option>
+            <option value="name_priority">名称</option>
+        </select>
+    </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/note/component/option/create_option.html` & `xnote-web-0.1.1/handlers/note/component/option/create_option.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/option/group_option.html` & `xnote-web-0.1.1/handlers/note/component/option/group_option.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/option/note_dropdown.html` & `xnote-web-0.1.1/handlers/note/component/option/note_dropdown.html`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,128 +1,128 @@
-<!-- 笔记的下拉选项 -->
-<script type="text/javascript" src="/static/lib/clipboard/clipboard-2.0.4.min.js"></script>
-
-{% if file != None and _user_name == file.creator and op == "view" %}
-
-{% if file.type == "gallery" %}
-    <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">管理文件</a>
-{% elif file.show_edit == False %}
-    <!-- nothing here -->
-{% else %}
-    <a class="btn" href="{{_server_home}}/note/edit?id={{file.id}}&is_iframe={{is_iframe}}">编辑</a>
-{% end %}
-
-<script type="text/javascript">
-xnote.state.note = {
-    id: "{{file.id}}",
-    name: "{{file.name}}",
-    parentId: "{{file.parentId}}"
-};
-</script>
-
-<div class="dropdown">
-    <span class="dropdown-btn btn btn-default">更多▾</span>
-    <div class="dropdown-mask"></div>
-    <div class="dropdown-content {%if _is_mobile%}mobile{% end %}">
-        <a class="dropdown-option link" href="javascript:rename('{{item.id}}', '{{item.name}}')">重命名</a>
-        
-        <a class="dropdown-option link" data-id="{{item.id}}" data-note-type="{{item.type}}"
-            onclick="xnote.note.openDialogToShare(this)">分享</a>
-
-        <a class="dropdown-option move-btn link">移动</a>
-        <a class="dropdown-option copy-btn link">复制</a>
-
-        {% if file.level > 0 %}
-            <a class="dropdown-option link" href="{{_server_home}}/note/stick?id={{file.id}}&level=0">取消置顶</a>
-        {% else %}
-            <a class="dropdown-option link" href="{{_server_home}}/note/stick?id={{file.id}}&level=1">置顶</a>
-        {% end %}
-
-        {% if file.archived %}
-            <a class="dropdown-option link" href="{{_server_home}}/note/unarchive?id={{file.id}}">取消归档</a>
-        {% end %}
-
-        {% if _is_admin and file.type == "gallery" %}
-            <a class="dropdown-option link" href="{{_server_home}}/fs/{{file.path}}">管理文件</a>
-        {% end %}
-
-        <a class="dropdown-option link" href="{{_server_home}}/note/history?id={{file_id}}">{{T("历史")}}</a>
-        <a class="dropdown-option link" href="{{_server_home}}/note/print?id={{file.id}}" target="_blank">打印</a>
-        {% if _is_admin and xutils.call("note.has_external_image", file) %}
-            <a class="dropdown-option cache-external-option link">缓存外部资源</a>
-        {% end %}
-
-        {% if item.is_deleted %}
-            <a class="dropdown-option-red recover-option" data-id="{{item.id}}">恢复笔记</a>
-        {% else %}
-            <a class="dropdown-option-red" href="javascript:remove('{{item.id}}', '{{item.name}}', '{{item.parent_id}}')">删除</a>
-        {% end %}
-    </div>
-</div>
-{% end %}
-
-<script type="text/javascript">
-$(function () {
-    $(".link-share-option").click(function(event) {
-        /* Act on the event */
-        $.post("/note/link_share", {id: "{{file.id}}"}, function (resp) {
-            if (resp.code == "success") {
-                var link = window.location.protocol + "//" + window.location.host + resp.data;
-                $(".share-link-text").text(link);
-                $(".share-link-btn").attr("data-clipboard-text", link);
-                var html = $(".share-tpl").html();
-                layer.confirm(html, {
-                    btn: [] //按钮
-                });
-                new ClipboardJS('.share-link-btn', {
-                    text: function(trigger) {
-                        xnote.toast("已经复制到粘贴板");
-                        return trigger.getAttribute('data-clipboard-text');
-                    }
-                });
-            } else {
-                xnote.alert("分享失败!");
-            }
-        });
-    });
-
-    $(".copy-link-option").click(function(event) {
-        $(".copy-link-option").attr('data-clipboard-text', window.location.href);
-        new ClipboardJS(".copy-link-option", {
-            text: function (trigger) {
-                xnote.toast("已经复制到粘贴板");
-                return trigger.getAttribute("data-clipboard-text");
-            }
-        });
-    });
-
-    // 缓存外部资源
-    $(".cache-external-option").click(function (event) {
-        var params = {
-            note_id: "{{file.id}}"
-        };
-        var loadIndex = layer.load(2);
-
-        $.post("/note/cache_external", params, function (resp) {
-            layer.close(loadIndex);
-            if (resp.code == "success") {
-                window.location.reload();
-            } else {
-                xnote.alert(resp.message);
-            }
-        }).fail(function (err) {
-            layer.close(loadIndex);
-            xnote.alert("调用接口失败: " + err);
-        })
-    });
-
-    // 恢复笔记
-    $(".recover-option").click(function (e) {
-        var noteId = $(e.target).attr("data-id");
-        xnote.api.note.recover(noteId, function() {
-            window.location.reload();
-        });
-    })
-})
-</script>
-
-{% include note/component/script/note_option_script.html %}
+<!-- 笔记的下拉选项 -->
+<script type="text/javascript" src="/static/lib/clipboard/clipboard-2.0.4.min.js"></script>
+
+{% if file != None and _user_name == file.creator and op == "view" %}
+
+{% if file.type == "gallery" %}
+    <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">管理文件</a>
+{% elif file.show_edit == False %}
+    <!-- nothing here -->
+{% else %}
+    <a class="btn" href="{{_server_home}}/note/edit?id={{file.id}}&is_iframe={{is_iframe}}">编辑</a>
+{% end %}
+
+<script type="text/javascript">
+xnote.state.note = {
+    id: "{{file.id}}",
+    name: "{{file.name}}",
+    parentId: "{{file.parentId}}"
+};
+</script>
+
+<div class="dropdown">
+    <span class="dropdown-btn btn btn-default">更多▾</span>
+    <div class="dropdown-mask"></div>
+    <div class="dropdown-content {%if _is_mobile%}mobile{% end %}">
+        <a class="dropdown-option link" href="javascript:rename('{{item.id}}', '{{item.name}}')">重命名</a>
+        
+        <a class="dropdown-option link" data-id="{{item.id}}" data-note-type="{{item.type}}"
+            onclick="xnote.note.openDialogToShare(this)">分享</a>
+
+        <a class="dropdown-option move-btn link">移动</a>
+        <a class="dropdown-option copy-btn link">复制</a>
+
+        {% if file.level > 0 %}
+            <a class="dropdown-option link" href="{{_server_home}}/note/stick?id={{file.id}}&level=0">取消置顶</a>
+        {% else %}
+            <a class="dropdown-option link" href="{{_server_home}}/note/stick?id={{file.id}}&level=1">置顶</a>
+        {% end %}
+
+        {% if file.archived %}
+            <a class="dropdown-option link" href="{{_server_home}}/note/unarchive?id={{file.id}}">取消归档</a>
+        {% end %}
+
+        {% if _is_admin and file.type == "gallery" %}
+            <a class="dropdown-option link" href="{{_server_home}}/fs/{{file.path}}">管理文件</a>
+        {% end %}
+
+        <a class="dropdown-option link" href="{{_server_home}}/note/history?id={{file_id}}">{{T("历史")}}</a>
+        <a class="dropdown-option link" href="{{_server_home}}/note/print?id={{file.id}}" target="_blank">打印</a>
+        {% if _is_admin and xutils.call("note.has_external_image", file) %}
+            <a class="dropdown-option cache-external-option link">缓存外部资源</a>
+        {% end %}
+
+        {% if item.is_deleted %}
+            <a class="dropdown-option-red recover-option" data-id="{{item.id}}">恢复笔记</a>
+        {% else %}
+            <a class="dropdown-option-red" href="javascript:remove('{{item.id}}', '{{item.name}}', '{{item.parent_id}}')">删除</a>
+        {% end %}
+    </div>
+</div>
+{% end %}
+
+<script type="text/javascript">
+$(function () {
+    $(".link-share-option").click(function(event) {
+        /* Act on the event */
+        $.post("/note/link_share", {id: "{{file.id}}"}, function (resp) {
+            if (resp.code == "success") {
+                var link = window.location.protocol + "//" + window.location.host + resp.data;
+                $(".share-link-text").text(link);
+                $(".share-link-btn").attr("data-clipboard-text", link);
+                var html = $(".share-tpl").html();
+                layer.confirm(html, {
+                    btn: [] //按钮
+                });
+                new ClipboardJS('.share-link-btn', {
+                    text: function(trigger) {
+                        xnote.toast("已经复制到粘贴板");
+                        return trigger.getAttribute('data-clipboard-text');
+                    }
+                });
+            } else {
+                xnote.alert("分享失败!");
+            }
+        });
+    });
+
+    $(".copy-link-option").click(function(event) {
+        $(".copy-link-option").attr('data-clipboard-text', window.location.href);
+        new ClipboardJS(".copy-link-option", {
+            text: function (trigger) {
+                xnote.toast("已经复制到粘贴板");
+                return trigger.getAttribute("data-clipboard-text");
+            }
+        });
+    });
+
+    // 缓存外部资源
+    $(".cache-external-option").click(function (event) {
+        var params = {
+            note_id: "{{file.id}}"
+        };
+        var loadIndex = layer.load(2);
+
+        $.post("/note/cache_external", params, function (resp) {
+            layer.close(loadIndex);
+            if (resp.code == "success") {
+                window.location.reload();
+            } else {
+                xnote.alert(resp.message);
+            }
+        }).fail(function (err) {
+            layer.close(loadIndex);
+            xnote.alert("调用接口失败: " + err);
+        })
+    });
+
+    // 恢复笔记
+    $(".recover-option").click(function (e) {
+        var noteId = $(e.target).attr("data-id");
+        xnote.api.note.recover(noteId, function() {
+            window.location.reload();
+        });
+    })
+})
+</script>
+
+{% include note/component/script/note_option_script.html %}
```

### Comparing `xnote-web-0.1.0/handlers/note/component/root_dropdown.html` & `xnote-web-0.1.1/handlers/note/component/root_dropdown.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/create_script.html` & `xnote-web-0.1.1/handlers/note/component/script/create_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/delete_script.html` & `xnote-web-0.1.1/handlers/note/component/script/delete_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/group_select_script.html` & `xnote-web-0.1.1/handlers/note/component/script/group_select_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/note_copy_script.html` & `xnote-web-0.1.1/handlers/note/component/script/note_copy_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/note_option_script.html` & `xnote-web-0.1.1/static/js/app.js`

 * *Files 25% similar despite different names*

```diff
@@ -1,465 +1,478 @@
-00000000: 0d0a 3c64 6976 2063 6c61 7373 3d22 7368  ..<div class="sh
-00000010: 6172 652d 7470 6c20 6869 6465 223e 0d0a  are-tpl hide">..
-00000020: 2020 2020 3c70 3ee5 8886 e4ba abe9 93be      <p>.........
-00000030: e68e a53a 203c 7370 616e 2063 6c61 7373  ...: <span class
-00000040: 3d22 6e6f 7465 2d73 6861 7265 2d6c 696e  ="note-share-lin
-00000050: 6b2d 7465 7874 223e 3c2f 7370 616e 3e3c  k-text"></span><
-00000060: 2f70 3e0d 0a20 2020 203c 6469 7620 636c  /p>..    <div cl
-00000070: 6173 733d 2272 6f77 223e 0d0a 2020 2020  ass="row">..    
-00000080: 2020 2020 3c62 7574 746f 6e20 636c 6173      <button clas
-00000090: 733d 226e 6f74 652d 7368 6172 652d 6c69  s="note-share-li
-000000a0: 6e6b 2d62 746e 2062 746e 2220 6461 7461  nk-btn btn" data
-000000b0: 2d63 6c69 7062 6f61 7264 2d74 6578 743d  -clipboard-text=
-000000c0: 2222 3ee5 a48d e588 b63c 2f62 7574 746f  "">......</butto
-000000d0: 6e3e 0d0a 2020 2020 3c2f 6469 763e 0d0a  n>..    </div>..
-000000e0: 3c2f 6469 763e 0d0a 0d0a 7b25 2069 6e63  </div>....{% inc
-000000f0: 6c75 6465 206e 6f74 652f 636f 6d70 6f6e  lude note/compon
-00000100: 656e 742f 7363 7269 7074 2f67 726f 7570  ent/script/group
-00000110: 5f73 656c 6563 745f 7363 7269 7074 2e68  _select_script.h
-00000120: 746d 6c20 257d 0d0a 7b25 2069 6e63 6c75  tml %}..{% inclu
-00000130: 6465 206e 6f74 652f 636f 6d70 6f6e 656e  de note/componen
-00000140: 742f 7363 7269 7074 2f6e 6f74 655f 636f  t/script/note_co
-00000150: 7079 5f73 6372 6970 742e 6874 6d6c 2025  py_script.html %
-00000160: 7d0d 0a0d 0a0d 0a3c 7363 7269 7074 2074  }......<script t
-00000170: 7970 653d 2274 6578 742f 6a61 7661 7363  ype="text/javasc
-00000180: 7269 7074 223e 0d0a 2020 2020 2f2f 20e7  ript">..    // .
-00000190: a7bb e58a a8e7 ac94 e8ae b0e7 9a84 e59b  ................
-000001a0: 9ee8 b083 e587 bde6 95b0 0d0a 2020 2020  ............    
-000001b0: 7769 6e64 6f77 2e6d 6f76 654e 6f74 6543  window.moveNoteC
-000001c0: 616c 6c62 6163 6b20 3d20 6675 6e63 7469  allback = functi
-000001d0: 6f6e 2028 7061 7265 6e74 4964 2920 7b0d  on (parentId) {.
-000001e0: 0a20 2020 2020 2020 2076 6172 2073 656c  .        var sel
-000001f0: 6649 6420 3d20 227b 7b66 696c 652e 6964  fId = "{{file.id
-00000200: 7d7d 223b 0d0a 2020 2020 2020 2020 242e  }}";..        $.
-00000210: 706f 7374 2822 2f6e 6f74 652f 6d6f 7665  post("/note/move
-00000220: 222c 207b 6964 3a73 656c 6649 642c 2070  ", {id:selfId, p
-00000230: 6172 656e 745f 6964 3a20 7061 7265 6e74  arent_id: parent
-00000240: 4964 7d2c 2066 756e 6374 696f 6e20 2872  Id}, function (r
-00000250: 6573 7029 7b0d 0a20 2020 2020 2020 2020  esp){..         
-00000260: 2020 2020 2063 6f6e 736f 6c65 2e6c 6f67       console.log
-00000270: 2872 6573 7029 3b0d 0a20 2020 2020 2020  (resp);..       
-00000280: 2020 2020 2020 2077 696e 646f 772e 6c6f         window.lo
-00000290: 6361 7469 6f6e 2e72 656c 6f61 6428 293b  cation.reload();
-000002a0: 0d0a 2020 2020 2020 2020 7d29 3b0d 0a20  ..        });.. 
-000002b0: 2020 207d 0d0a 0d0a 2020 2020 7769 6e64     }....    wind
-000002c0: 6f77 2e76 6973 6974 416e 6452 6566 7265  ow.visitAndRefre
-000002d0: 7368 203d 2066 756e 6374 696f 6e20 2865  sh = function (e
-000002e0: 6c29 207b 0d0a 2020 2020 2020 2020 7661  l) {..        va
-000002f0: 7220 7572 6c20 3d20 2428 656c 292e 6174  r url = $(el).at
-00000300: 7472 2822 6461 7461 2d68 7265 6622 293b  tr("data-href");
-00000310: 0d0a 2020 2020 2020 2020 242e 6765 7428  ..        $.get(
-00000320: 7572 6c2c 2066 756e 6374 696f 6e20 2829  url, function ()
-00000330: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-00000340: 7769 6e64 6f77 2e6c 6f63 6174 696f 6e2e  window.location.
-00000350: 7265 6c6f 6164 2829 3b0d 0a20 2020 2020  reload();..     
-00000360: 2020 207d 293b 0d0a 2020 2020 7d0d 0a0d     });..    }...
-00000370: 0a20 2020 2066 756e 6374 696f 6e20 7265  .    function re
-00000380: 6e61 6d65 4e6f 7465 2869 642c 206f 6c64  nameNote(id, old
-00000390: 4e61 6d65 2920 7b0d 0a20 2020 2020 2020  Name) {..       
-000003a0: 2078 6e6f 7465 2e70 726f 6d70 7428 22e6   xnote.prompt(".
-000003b0: 96b0 e590 8de7 a7b0 222c 206f 6c64 4e61  ........", oldNa
-000003c0: 6d65 2c20 6675 6e63 7469 6f6e 2028 6e65  me, function (ne
-000003d0: 774e 616d 6529 207b 0d0a 2020 2020 2020  wName) {..      
-000003e0: 2020 2020 2020 636f 6e73 6f6c 652e 6c6f        console.lo
-000003f0: 6728 6e65 774e 616d 6529 3b0d 0a20 2020  g(newName);..   
-00000400: 2020 2020 2020 2020 2069 6620 286e 6577           if (new
-00000410: 4e61 6d65 2021 3d20 2222 2026 2620 6e65  Name != "" && ne
-00000420: 774e 616d 6520 213d 206e 756c 6c29 207b  wName != null) {
-00000430: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00000440: 2020 242e 706f 7374 2822 2f6e 6f74 652f    $.post("/note/
-00000450: 7265 6e61 6d65 222c 207b 6964 3a69 642c  rename", {id:id,
-00000460: 206e 616d 653a 6e65 774e 616d 657d 2c20   name:newName}, 
-00000470: 6675 6e63 7469 6f6e 2028 7265 7370 2920  function (resp) 
-00000480: 7b0d 0a20 2020 2020 2020 2020 2020 2020  {..             
-00000490: 2020 2020 2020 2076 6172 2063 6f64 6520         var code 
-000004a0: 3d20 7265 7370 2e63 6f64 653b 0d0a 2020  = resp.code;..  
-000004b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000004c0: 2020 6966 2028 636f 6465 2021 3d20 2273    if (code != "s
-000004d0: 7563 6365 7373 2229 207b 0d0a 2020 2020  uccess") {..    
-000004e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000004f0: 2020 2020 616c 6572 7428 7265 7370 2e6d      alert(resp.m
-00000500: 6573 7361 6765 293b 0d0a 2020 2020 2020  essage);..      
-00000510: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00000520: 656c 7365 207b 0d0a 2020 2020 2020 2020  else {..        
-00000530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000540: 2f2f 2024 2822 2366 696c 652d 222b 6964  // $("#file-"+id
-00000550: 292e 7465 7874 286e 6577 4e61 6d65 293b  ).text(newName);
-00000560: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00000570: 2020 2020 2020 2020 2020 7769 6e64 6f77            window
-00000580: 2e6c 6f63 6174 696f 6e2e 7265 6c6f 6164  .location.reload
-00000590: 2829 3b0d 0a20 2020 2020 2020 2020 2020  ();..           
-000005a0: 2020 2020 2020 2020 207d 0d0a 2020 2020           }..    
-000005b0: 2020 2020 2020 2020 2020 2020 7d29 0d0a              })..
-000005c0: 2020 2020 2020 2020 2020 2020 7d0d 0a20              }.. 
-000005d0: 2020 2020 2020 207d 293b 0d0a 2020 2020         });..    
-000005e0: 7d0d 0a0d 0a20 2020 2066 756e 6374 696f  }....    functio
-000005f0: 6e20 7265 6e61 6d65 4e6f 7465 4279 4174  n renameNoteByAt
-00000600: 7472 2874 6172 6765 7429 207b 0d0a 2020  tr(target) {..  
-00000610: 2020 2020 2020 7661 7220 6964 203d 2024        var id = $
-00000620: 2874 6172 6765 7429 2e61 7474 7228 2264  (target).attr("d
-00000630: 6174 612d 6964 2229 3b0d 0a20 2020 2020  ata-id");..     
-00000640: 2020 2076 6172 206f 6c64 4e61 6d65 203d     var oldName =
-00000650: 2024 2874 6172 6765 7429 2e61 7474 7228   $(target).attr(
-00000660: 2264 6174 612d 6e61 6d65 2229 3b0d 0a20  "data-name");.. 
-00000670: 2020 2020 2020 2069 6620 2869 6420 3d3d         if (id ==
-00000680: 2075 6e64 6566 696e 6564 207c 7c20 6964   undefined || id
-00000690: 203d 3d20 2222 2920 7b0d 0a20 2020 2020   == "") {..     
-000006a0: 2020 2020 2020 2078 6e6f 7465 2e61 6c65         xnote.ale
-000006b0: 7274 2822 6461 7461 2d69 64e4 b8ba e7a9  rt("data-id.....
-000006c0: ba22 293b 0d0a 2020 2020 2020 2020 2020  .");..          
-000006d0: 2020 7265 7475 726e 3b0d 0a20 2020 2020    return;..     
-000006e0: 2020 207d 0d0a 0d0a 2020 2020 2020 2020     }....        
-000006f0: 6966 2028 6f6c 644e 616d 6520 3d3d 2075  if (oldName == u
-00000700: 6e64 6566 696e 6564 207c 7c20 6f6c 644e  ndefined || oldN
-00000710: 616d 6520 3d3d 2022 2229 207b 0d0a 2020  ame == "") {..  
-00000720: 2020 2020 2020 2020 2020 786e 6f74 652e            xnote.
-00000730: 616c 6572 7428 2264 6174 612d 6e61 6d65  alert("data-name
-00000740: e4b8 bae7 a9ba 2229 3b0d 0a20 2020 2020  ......");..     
-00000750: 2020 2020 2020 2072 6574 7572 6e3b 0d0a         return;..
-00000760: 2020 2020 2020 2020 7d0d 0a0d 0a20 2020          }....   
-00000770: 2020 2020 2072 656e 616d 654e 6f74 6528       renameNote(
-00000780: 6964 2c20 6f6c 644e 616d 6529 3b0d 0a20  id, oldName);.. 
-00000790: 2020 207d 0d0a 0d0a 2020 2020 6675 6e63     }....    func
-000007a0: 7469 6f6e 2063 6865 636b 4e6f 7445 6d70  tion checkNotEmp
-000007b0: 7479 286f 626a 6563 742c 206d 6573 7361  ty(object, messa
-000007c0: 6765 2920 7b0d 0a20 2020 2020 2020 2069  ge) {..        i
-000007d0: 6620 286f 626a 6563 7420 3d3d 3d20 756e  f (object === un
-000007e0: 6465 6669 6e65 6420 7c7c 206f 626a 6563  defined || objec
-000007f0: 7420 3d3d 3d20 6e75 6c6c 207c 7c20 6f62  t === null || ob
-00000800: 6a65 6374 203d 3d3d 2022 2229 207b 0d0a  ject === "") {..
-00000810: 2020 2020 2020 2020 2020 2020 786e 6f74              xnot
-00000820: 652e 616c 6572 7428 6d65 7373 6167 6529  e.alert(message)
-00000830: 3b0d 0a20 2020 2020 2020 2020 2020 2074  ;..            t
-00000840: 6872 6f77 206e 6577 2045 7272 6f72 286d  hrow new Error(m
-00000850: 6573 7361 6765 293b 0d0a 2020 2020 2020  essage);..      
-00000860: 2020 7d0d 0a20 2020 207d 0d0a 0d0a 2020    }..    }....  
-00000870: 2020 6675 6e63 7469 6f6e 2063 616c 6c5f    function call_
-00000880: 786e 6f74 655f 6170 6928 6170 692c 2070  xnote_api(api, p
-00000890: 6172 616d 7329 207b 0d0a 2020 2020 2020  arams) {..      
-000008a0: 2020 242e 706f 7374 2861 7069 2c20 7061    $.post(api, pa
-000008b0: 7261 6d73 2c20 6675 6e63 7469 6f6e 2028  rams, function (
-000008c0: 7265 7370 2920 7b0d 0a20 2020 2020 2020  resp) {..       
-000008d0: 2020 2020 2069 6620 2872 6573 702e 636f       if (resp.co
-000008e0: 6465 2021 3d20 2273 7563 6365 7373 2229  de != "success")
-000008f0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-00000900: 2020 2020 786e 6f74 652e 616c 6572 7428      xnote.alert(
-00000910: 7265 7370 2e6d 6573 7361 6765 293b 0d0a  resp.message);..
-00000920: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-00000930: 7365 207b 0d0a 2020 2020 2020 2020 2020  se {..          
-00000940: 2020 2020 2020 786e 6f74 652e 746f 6173        xnote.toas
-00000950: 7428 7265 7370 2e6d 6573 7361 6765 293b  t(resp.message);
-00000960: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00000970: 2020 7769 6e64 6f77 2e6c 6f63 6174 696f    window.locatio
-00000980: 6e2e 7265 6c6f 6164 2829 3b0d 0a20 2020  n.reload();..   
-00000990: 2020 2020 2020 2020 207d 0d0a 2020 2020           }..    
-000009a0: 2020 2020 7d29 2e66 6169 6c28 6675 6e63      }).fail(func
-000009b0: 7469 6f6e 2028 6572 726f 7229 207b 0d0a  tion (error) {..
-000009c0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000009d0: 6f6c 652e 6572 726f 7228 6572 726f 7229  ole.error(error)
-000009e0: 3b0d 0a20 2020 2020 2020 2020 2020 2078  ;..            x
-000009f0: 6e6f 7465 2e61 6c65 7274 2822 e68e a5e5  note.alert("....
-00000a00: 8fa3 e8b0 83e7 94a8 e5a4 b1e8 b4a5 3a22  ..............:"
-00000a10: 202b 2065 7272 6f72 2e73 7461 7475 7320   + error.status 
-00000a20: 2b20 222c 2220 2b20 6572 726f 722e 7374  + "," + error.st
-00000a30: 6174 7573 5465 7874 293b 0d0a 2020 2020  atusText);..    
-00000a40: 2020 2020 7d29 0d0a 2020 2020 7d0d 0a0d      })..    }...
-00000a50: 0a20 2020 2024 2866 756e 6374 696f 6e20  .    $(function 
-00000a60: 2829 207b 0d0a 0d0a 2020 2020 2020 2020  () {....        
-00000a70: 6675 6e63 7469 6f6e 206f 6e4e 6f74 6552  function onNoteR
-00000a80: 656e 616d 6545 7665 6e74 2865 7665 6e74  enameEvent(event
-00000a90: 2920 7b0d 0a20 2020 2020 2020 2020 2020  ) {..           
-00000aa0: 2063 6f6e 736f 6c65 2e6c 6f67 2822 7265   console.log("re
-00000ab0: 6e61 6d65 2229 3b0d 0a20 2020 2020 2020  name");..       
-00000ac0: 2020 2020 2076 6172 2074 6172 6765 7420       var target 
-00000ad0: 3d20 6576 656e 742e 7461 7267 6574 3b0d  = event.target;.
-00000ae0: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
-00000af0: 616d 654e 6f74 6542 7941 7474 7228 7461  ameNoteByAttr(ta
-00000b00: 7267 6574 293b 0d0a 2020 2020 2020 2020  rget);..        
-00000b10: 7d0d 0a20 2020 2020 2020 200d 0a20 2020  }..        ..   
-00000b20: 2020 2020 2024 2822 2e72 656e 616d 652d       $(".rename-
-00000b30: 6274 6e22 292e 636c 6963 6b28 6675 6e63  btn").click(func
-00000b40: 7469 6f6e 2865 7665 6e74 2920 7b0d 0a20  tion(event) {.. 
-00000b50: 2020 2020 2020 2020 2020 206f 6e4e 6f74             onNot
-00000b60: 6552 656e 616d 6545 7665 6e74 2865 7665  eRenameEvent(eve
-00000b70: 6e74 293b 0d0a 2020 2020 2020 2020 7d29  nt);..        })
-00000b80: 3b0d 0a0d 0a20 2020 2020 2020 2024 2822  ;....        $("
-00000b90: 2e6e 6f74 652d 7265 6e61 6d65 2d62 746e  .note-rename-btn
-00000ba0: 2229 2e63 6c69 636b 2866 756e 6374 696f  ").click(functio
-00000bb0: 6e28 6576 656e 7429 207b 0d0a 2020 2020  n(event) {..    
-00000bc0: 2020 2020 2020 2020 6f6e 4e6f 7465 5265          onNoteRe
-00000bd0: 6e61 6d65 4576 656e 7428 6576 656e 7429  nameEvent(event)
-00000be0: 3b0d 0a20 2020 2020 2020 207d 293b 0d0a  ;..        });..
-00000bf0: 0d0a 2020 2020 2020 2020 2428 222e 7374  ..        $(".st
-00000c00: 6174 7573 2d62 746e 2229 2e65 6163 6828  atus-btn").each(
-00000c10: 6675 6e63 7469 6f6e 2028 696e 6465 782c  function (index,
-00000c20: 2065 6c65 6d65 6e74 2920 7b0d 0a20 2020   element) {..   
-00000c30: 2020 2020 2020 2020 2076 6172 2073 7461           var sta
-00000c40: 7475 7320 3d20 2428 656c 656d 656e 7429  tus = $(element)
-00000c50: 2e61 7474 7228 2264 6174 612d 7374 6174  .attr("data-stat
-00000c60: 7573 2229 3b0d 0a20 2020 2020 2020 2020  us");..         
-00000c70: 2020 2069 6620 2873 7461 7475 7320 3d3d     if (status ==
-00000c80: 2022 7b7b 6669 6c65 2e70 7269 6f72 6974   "{{file.priorit
-00000c90: 797d 7d22 2920 7b0d 0a20 2020 2020 2020  y}}") {..       
-00000ca0: 2020 2020 2020 2020 2024 2865 6c65 6d65           $(eleme
-00000cb0: 6e74 292e 6164 6443 6c61 7373 2822 782d  nt).addClass("x-
-00000cc0: 7461 622d 6274 6e2d 6163 7469 7665 2229  tab-btn-active")
-00000cd0: 3b0d 0a20 2020 2020 2020 2020 2020 207d  ;..            }
-00000ce0: 0d0a 2020 2020 2020 2020 7d29 3b0d 0a0d  ..        });...
-00000cf0: 0a20 2020 2020 2020 2024 2822 2e73 7461  .        $(".sta
-00000d00: 7475 732d 6274 6e22 292e 636c 6963 6b28  tus-btn").click(
-00000d10: 6675 6e63 7469 6f6e 2865 7665 6e74 2920  function(event) 
-00000d20: 7b0d 0a20 2020 2020 2020 2020 2020 2076  {..            v
-00000d30: 6172 2069 6420 3d20 2428 6576 656e 742e  ar id = $(event.
-00000d40: 7461 7267 6574 292e 6174 7472 2822 6461  target).attr("da
-00000d50: 7461 2d69 6422 293b 0d0a 2020 2020 2020  ta-id");..      
-00000d60: 2020 2020 2020 7661 7220 7374 6174 7573        var status
-00000d70: 203d 2024 2865 7665 6e74 2e74 6172 6765   = $(event.targe
-00000d80: 7429 2e61 7474 7228 2264 6174 612d 7374  t).attr("data-st
-00000d90: 6174 7573 2229 3b0d 0a0d 0a20 2020 2020  atus");....     
-00000da0: 2020 2020 2020 2063 6865 636b 4e6f 7445         checkNotE
-00000db0: 6d70 7479 2869 642c 2022 6461 7461 2d69  mpty(id, "data-i
-00000dc0: 64e4 b8ba e7a9 ba22 293b 0d0a 2020 2020  d......");..    
-00000dd0: 2020 2020 2020 2020 6368 6563 6b4e 6f74          checkNot
-00000de0: 456d 7074 7928 7374 6174 7573 2c20 2264  Empty(status, "d
-00000df0: 6174 612d 7374 6174 7573 e4b8 bae7 a9ba  ata-status......
-00000e00: 2229 3b0d 0a0d 0a20 2020 2020 2020 2020  ");....         
-00000e10: 2020 2078 6e6f 7465 2e68 7474 702e 706f     xnote.http.po
-00000e20: 7374 2822 2f6e 6f74 652f 7374 6174 7573  st("/note/status
-00000e30: 222c 207b 6964 3a20 6964 2c20 7374 6174  ", {id: id, stat
-00000e40: 7573 3a20 7374 6174 7573 7d2c 2066 756e  us: status}, fun
-00000e50: 6374 696f 6e20 2872 6573 7029 207b 0d0a  ction (resp) {..
-00000e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000e70: 7661 7220 636f 6465 203d 2072 6573 702e  var code = resp.
-00000e80: 636f 6465 3b0d 0a20 2020 2020 2020 2020  code;..         
-00000e90: 2020 2020 2020 2069 6620 2863 6f64 6520         if (code 
-00000ea0: 213d 2022 7375 6363 6573 7322 2920 7b0d  != "success") {.
-00000eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000ec0: 2020 2020 2078 6e6f 7465 2e61 6c65 7274       xnote.alert
-00000ed0: 2872 6573 702e 6d65 7373 6167 6529 3b0d  (resp.message);.
-00000ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000ef0: 207d 2065 6c73 6520 7b0d 0a20 2020 2020   } else {..     
-00000f00: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-00000f10: 6e6f 7465 2e74 6f61 7374 2872 6573 702e  note.toast(resp.
-00000f20: 6d65 7373 6167 6529 3b0d 0a20 2020 2020  message);..     
-00000f30: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00000f40: 696e 646f 772e 6c6f 6361 7469 6f6e 2e72  indow.location.r
-00000f50: 656c 6f61 6428 293b 0d0a 2020 2020 2020  eload();..      
-00000f60: 2020 2020 2020 2020 2020 7d0d 0a20 2020            }..   
-00000f70: 2020 2020 2020 2020 207d 290d 0a20 2020           })..   
-00000f80: 2020 2020 207d 293b 0d0a 0d0a 2020 2020       });....    
-00000f90: 2020 2020 2428 222e 6f72 6465 7262 792d      $(".orderby-
-00000fa0: 6274 6e22 292e 6561 6368 2866 756e 6374  btn").each(funct
-00000fb0: 696f 6e20 2869 6e64 6578 2c20 656c 656d  ion (index, elem
-00000fc0: 656e 7429 207b 0d0a 2020 2020 2020 2020  ent) {..        
-00000fd0: 2020 2020 7661 7220 6f72 6465 7262 7920      var orderby 
-00000fe0: 3d20 2428 656c 656d 656e 7429 2e61 7474  = $(element).att
-00000ff0: 7228 2264 6174 612d 6f72 6465 7262 7922  r("data-orderby"
-00001000: 293b 0d0a 2020 2020 2020 2020 2020 2020  );..            
-00001010: 6966 2028 6f72 6465 7262 7920 3d3d 2022  if (orderby == "
-00001020: 7b7b 6669 6c65 2e6f 7264 6572 6279 7d7d  {{file.orderby}}
-00001030: 2229 207b 0d0a 2020 2020 2020 2020 2020  ") {..          
-00001040: 2020 2020 2020 2428 656c 656d 656e 7429        $(element)
-00001050: 2e61 6464 436c 6173 7328 2278 2d74 6162  .addClass("x-tab
-00001060: 2d62 746e 2d61 6374 6976 6522 293b 0d0a  -btn-active");..
-00001070: 2020 2020 2020 2020 2020 2020 7d0d 0a20              }.. 
-00001080: 2020 2020 2020 207d 293b 0d0a 0d0a 2020         });....  
-00001090: 2020 2020 2020 2428 222e 6f72 6465 7262        $(".orderb
-000010a0: 792d 6274 6e22 292e 636c 6963 6b28 6675  y-btn").click(fu
-000010b0: 6e63 7469 6f6e 2028 6576 656e 7429 207b  nction (event) {
-000010c0: 0d0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-000010d0: 7220 6964 203d 2024 2865 7665 6e74 2e74  r id = $(event.t
-000010e0: 6172 6765 7429 2e61 7474 7228 2264 6174  arget).attr("dat
-000010f0: 612d 6964 2229 3b0d 0a20 2020 2020 2020  a-id");..       
-00001100: 2020 2020 2076 6172 206f 7264 6572 6279       var orderby
-00001110: 203d 2024 2865 7665 6e74 2e74 6172 6765   = $(event.targe
-00001120: 7429 2e61 7474 7228 2264 6174 612d 6f72  t).attr("data-or
-00001130: 6465 7262 7922 293b 0d0a 0d0a 2020 2020  derby");....    
-00001140: 2020 2020 2020 2020 6368 6563 6b4e 6f74          checkNot
-00001150: 456d 7074 7928 6964 2c20 2264 6174 612d  Empty(id, "data-
-00001160: 6964 e4b8 bae7 a9ba 2229 3b0d 0a20 2020  id......");..   
-00001170: 2020 2020 2020 2020 2063 6865 636b 4e6f           checkNo
-00001180: 7445 6d70 7479 286f 7264 6572 6279 2c20  tEmpty(orderby, 
-00001190: 2264 6174 612d 6f72 6465 7262 79e4 b8ba  "data-orderby...
-000011a0: e7a9 ba22 293b 0d0a 0d0a 2020 2020 2020  ...");....      
-000011b0: 2020 2020 2020 786e 6f74 652e 6874 7470        xnote.http
-000011c0: 2e70 6f73 7428 222f 6e6f 7465 2f6f 7264  .post("/note/ord
-000011d0: 6572 6279 222c 207b 6964 3a20 6964 2c20  erby", {id: id, 
-000011e0: 6f72 6465 7262 793a 206f 7264 6572 6279  orderby: orderby
-000011f0: 7d2c 2066 756e 6374 696f 6e20 2872 6573  }, function (res
-00001200: 7029 207b 0d0a 2020 2020 2020 2020 2020  p) {..          
-00001210: 2020 2020 2020 7661 7220 636f 6465 203d        var code =
-00001220: 2072 6573 702e 636f 6465 3b0d 0a20 2020   resp.code;..   
-00001230: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00001240: 2863 6f64 6520 213d 2022 7375 6363 6573  (code != "succes
-00001250: 7322 2920 7b0d 0a20 2020 2020 2020 2020  s") {..         
-00001260: 2020 2020 2020 2020 2020 2078 6e6f 7465             xnote
-00001270: 2e61 6c65 7274 2872 6573 702e 6d65 7373  .alert(resp.mess
-00001280: 6167 6529 3b0d 0a20 2020 2020 2020 2020  age);..         
-00001290: 2020 2020 2020 207d 2065 6c73 6520 7b0d         } else {.
-000012a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000012b0: 2020 2020 2078 6e6f 7465 2e74 6f61 7374       xnote.toast
-000012c0: 2872 6573 702e 6d65 7373 6167 6529 3b0d  (resp.message);.
-000012d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000012e0: 2020 2020 2077 696e 646f 772e 6c6f 6361       window.loca
-000012f0: 7469 6f6e 2e72 656c 6f61 6428 293b 0d0a  tion.reload();..
-00001300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001310: 7d0d 0a20 2020 2020 2020 2020 2020 207d  }..            }
-00001320: 290d 0a20 2020 2020 2020 207d 293b 0d0a  )..        });..
-00001330: 0d0a 2020 2020 2020 2020 6675 6e63 7469  ..        functi
-00001340: 6f6e 206e 6f74 655f 7368 6172 655f 6279  on note_share_by
-00001350: 5f6c 696e 6b28 7461 7267 6574 2920 7b0d  _link(target) {.
-00001360: 0a20 2020 2020 2020 2020 2020 202f 2a20  .            /* 
-00001370: 4163 7420 6f6e 2074 6865 2065 7665 6e74  Act on the event
-00001380: 202a 2f0d 0a20 2020 2020 2020 2020 2020   */..           
-00001390: 2024 2e70 6f73 7428 222f 6e6f 7465 2f6c   $.post("/note/l
-000013a0: 696e 6b5f 7368 6172 6522 2c20 7b69 643a  ink_share", {id:
-000013b0: 2022 7b7b 6669 6c65 2e69 647d 7d22 7d2c   "{{file.id}}"},
-000013c0: 2066 756e 6374 696f 6e20 2872 6573 7029   function (resp)
-000013d0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-000013e0: 2020 2020 6966 2028 7265 7370 2e63 6f64      if (resp.cod
-000013f0: 6520 3d3d 2022 7375 6363 6573 7322 2920  e == "success") 
-00001400: 7b0d 0a20 2020 2020 2020 2020 2020 2020  {..             
-00001410: 2020 2020 2020 2076 6172 206c 696e 6b20         var link 
-00001420: 3d20 7769 6e64 6f77 2e6c 6f63 6174 696f  = window.locatio
-00001430: 6e2e 7072 6f74 6f63 6f6c 202b 2022 2f2f  n.protocol + "//
-00001440: 2220 2b20 7769 6e64 6f77 2e6c 6f63 6174  " + window.locat
-00001450: 696f 6e2e 686f 7374 202b 2072 6573 702e  ion.host + resp.
-00001460: 6461 7461 3b0d 0a20 2020 2020 2020 2020  data;..         
-00001470: 2020 2020 2020 2020 2020 2024 2822 2e6e             $(".n
-00001480: 6f74 652d 7368 6172 652d 6c69 6e6b 2d74  ote-share-link-t
-00001490: 6578 7422 292e 7465 7874 286c 696e 6b29  ext").text(link)
-000014a0: 3b0d 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000014b0: 2020 2020 2020 2024 2822 2e6e 6f74 652d         $(".note-
-000014c0: 7368 6172 652d 6c69 6e6b 2d62 746e 2229  share-link-btn")
-000014d0: 2e61 7474 7228 2264 6174 612d 636c 6970  .attr("data-clip
-000014e0: 626f 6172 642d 7465 7874 222c 206c 696e  board-text", lin
-000014f0: 6b29 3b0d 0a0d 0a20 2020 2020 2020 2020  k);....         
-00001500: 2020 2020 2020 2020 2020 2076 6172 2068             var h
-00001510: 746d 6c20 3d20 2428 222e 7368 6172 652d  tml = $(".share-
-00001520: 7470 6c22 292e 6874 6d6c 2829 3b0d 0a20  tpl").html();.. 
-00001530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001540: 2020 206c 6179 6572 2e63 6f6e 6669 726d     layer.confirm
-00001550: 2868 746d 6c2c 207b 0d0a 2020 2020 2020  (html, {..      
-00001560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001570: 2020 6274 6e3a 205b 5d20 2f2f e68c 89e9    btn: [] //....
-00001580: 92ae 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00001590: 2020 2020 2020 2020 7d29 3b0d 0a20 2020          });..   
-000015a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000015b0: 206e 6577 2043 6c69 7062 6f61 7264 4a53   new ClipboardJS
-000015c0: 2827 2e6e 6f74 652d 7368 6172 652d 6c69  ('.note-share-li
-000015d0: 6e6b 2d62 746e 272c 207b 0d0a 2020 2020  nk-btn', {..    
-000015e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000015f0: 2020 2020 7465 7874 3a20 6675 6e63 7469      text: functi
-00001600: 6f6e 2874 7269 6767 6572 2920 7b0d 0a20  on(trigger) {.. 
-00001610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001620: 2020 2020 2020 2020 2020 2078 6e6f 7465             xnote
-00001630: 2e74 6f61 7374 2822 e5b7 b2e7 bb8f e5a4  .toast("........
-00001640: 8de5 88b6 e588 b0e7 b298 e8b4 b4e6 9dbf  ................
-00001650: 2229 3b0d 0a20 2020 2020 2020 2020 2020  ");..           
-00001660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001670: 2072 6574 7572 6e20 7472 6967 6765 722e   return trigger.
-00001680: 6765 7441 7474 7269 6275 7465 2827 6461  getAttribute('da
-00001690: 7461 2d63 6c69 7062 6f61 7264 2d74 6578  ta-clipboard-tex
-000016a0: 7427 293b 0d0a 2020 2020 2020 2020 2020  t');..          
-000016b0: 2020 2020 2020 2020 2020 2020 2020 7d0d                }.
-000016c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000016d0: 2020 2020 207d 293b 0d0a 2020 2020 2020       });..      
-000016e0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-000016f0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-00001700: 2020 2020 2020 2020 786e 6f74 652e 616c          xnote.al
-00001710: 6572 7428 22e5 8886 e4ba abe5 a4b1 e8b4  ert("...........
-00001720: a521 2229 3b0d 0a20 2020 2020 2020 2020  .!");..         
-00001730: 2020 2020 2020 207d 0d0a 2020 2020 2020         }..      
-00001740: 2020 2020 2020 7d29 3b0d 0a20 2020 2020        });..     
-00001750: 2020 207d 0d0a 0d0a 2020 2020 2020 2020     }....        
-00001760: 7769 6e64 6f77 2e6e 6f74 655f 7368 6172  window.note_shar
-00001770: 655f 6279 5f6c 696e 6b20 3d20 6e6f 7465  e_by_link = note
-00001780: 5f73 6861 7265 5f62 795f 6c69 6e6b 3b0d  _share_by_link;.
-00001790: 0a0d 0a20 2020 2020 2020 2024 2822 2e63  ...        $(".c
-000017a0: 6f70 792d 6c69 6e6b 2d6f 7074 696f 6e22  opy-link-option"
-000017b0: 292e 636c 6963 6b28 6675 6e63 7469 6f6e  ).click(function
-000017c0: 2865 7665 6e74 2920 7b0d 0a20 2020 2020  (event) {..     
-000017d0: 2020 2020 2020 2024 2822 2e63 6f70 792d         $(".copy-
-000017e0: 6c69 6e6b 2d6f 7074 696f 6e22 292e 6174  link-option").at
-000017f0: 7472 2827 6461 7461 2d63 6c69 7062 6f61  tr('data-clipboa
-00001800: 7264 2d74 6578 7427 2c20 7769 6e64 6f77  rd-text', window
-00001810: 2e6c 6f63 6174 696f 6e2e 6872 6566 293b  .location.href);
-00001820: 0d0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
-00001830: 7720 436c 6970 626f 6172 644a 5328 222e  w ClipboardJS(".
-00001840: 636f 7079 2d6c 696e 6b2d 6f70 7469 6f6e  copy-link-option
-00001850: 222c 207b 0d0a 2020 2020 2020 2020 2020  ", {..          
-00001860: 2020 2020 2020 7465 7874 3a20 6675 6e63        text: func
-00001870: 7469 6f6e 2028 7472 6967 6765 7229 207b  tion (trigger) {
-00001880: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00001890: 2020 2020 2020 786e 6f74 652e 746f 6173        xnote.toas
-000018a0: 7428 22e5 b7b2 e7bb 8fe5 a48d e588 b6e5  t(".............
-000018b0: 88b0 e7b2 98e8 b4b4 e69d bf22 293b 0d0a  ...........");..
-000018c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000018d0: 2020 2020 7265 7475 726e 2074 7269 6767      return trigg
-000018e0: 6572 2e67 6574 4174 7472 6962 7574 6528  er.getAttribute(
-000018f0: 2264 6174 612d 636c 6970 626f 6172 642d  "data-clipboard-
-00001900: 7465 7874 2229 3b0d 0a20 2020 2020 2020  text");..       
-00001910: 2020 2020 2020 2020 207d 0d0a 2020 2020           }..    
-00001920: 2020 2020 2020 2020 7d29 3b0d 0a20 2020          });..   
-00001930: 2020 2020 207d 293b 0d0a 0d0a 2020 2020       });....    
-00001940: 2020 2020 2f2f 20e6 98be e7a4 bae7 9bae      // .........
-00001950: e5bd 95e5 bcb9 e7aa 970d 0a20 2020 2020  ...........     
-00001960: 2020 2024 2822 2e6e 6f74 652d 636f 6e74     $(".note-cont
-00001970: 656e 7473 2d62 746e 2229 2e63 6c69 636b  ents-btn").click
-00001980: 2866 756e 6374 696f 6e20 2865 2920 7b0d  (function (e) {.
-00001990: 0a20 2020 2020 2020 2020 2020 2076 6172  .            var
-000019a0: 2070 6172 656e 7449 6420 3d20 2428 652e   parentId = $(e.
-000019b0: 7461 7267 6574 292e 6174 7472 2822 6461  target).attr("da
-000019c0: 7461 2d70 6172 656e 7422 293b 0d0a 2020  ta-parent");..  
-000019d0: 2020 2020 2020 2020 2020 786e 6f74 652e            xnote.
-000019e0: 7368 6f77 416a 6178 4469 616c 6f67 2822  showAjaxDialog("
-000019f0: e980 89e6 8ba9 e7ac 94e8 aeb0 222c 2022  ............", "
-00001a00: 2f6e 6f74 652f 2220 2b20 7061 7265 6e74  /note/" + parent
-00001a10: 4964 202b 2022 3f64 6961 6c6f 673d 7472  Id + "?dialog=tr
-00001a20: 7565 2229 3b0d 0a20 2020 2020 2020 207d  ue");..        }
-00001a30: 293b 0d0a 0d0a 2020 2020 2020 2020 2f2f  );....        //
-00001a40: 20e7 a7bb e58a a8e7 ac94 e8ae b00d 0a20   .............. 
-00001a50: 2020 2020 2020 2024 2822 2e6d 6f76 652d         $(".move-
-00001a60: 6274 6e22 292e 636c 6963 6b28 6675 6e63  btn").click(func
-00001a70: 7469 6f6e 2028 6529 207b 0d0a 2020 2020  tion (e) {..    
-00001a80: 2020 2020 2020 2020 7661 7220 7265 7120          var req 
-00001a90: 3d20 7b7d 3b0d 0a20 2020 2020 2020 2020  = {};..         
-00001aa0: 2020 2072 6571 2e63 616c 6c62 6163 6b20     req.callback 
-00001ab0: 3d20 6675 6e63 7469 6f6e 2028 7061 7265  = function (pare
-00001ac0: 6e74 4964 2920 7b0d 0a20 2020 2020 2020  ntId) {..       
-00001ad0: 2020 2020 2020 2020 2069 6620 2870 6172           if (par
-00001ae0: 656e 7449 6420 3d3d 3d20 756e 6465 6669  entId === undefi
-00001af0: 6e65 6420 7c7c 2070 6172 656e 7449 6420  ned || parentId 
-00001b00: 3d3d 2022 2229 207b 0d0a 2020 2020 2020  == "") {..      
-00001b10: 2020 2020 2020 2020 2020 2020 2020 786e                xn
-00001b20: 6f74 652e 616c 6572 7428 2270 6172 656e  ote.alert("paren
-00001b30: 7449 6420 6973 2075 6e64 6566 696e 6564  tId is undefined
-00001b40: 2229 3b0d 0a20 2020 2020 2020 2020 2020  ");..           
-00001b50: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
-00001b60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00001b70: 2020 7d0d 0a20 2020 2020 2020 2020 2020    }..           
-00001b80: 2020 2020 2076 6172 206e 6f74 6549 6420       var noteId 
-00001b90: 3d20 227b 7b66 696c 652e 6964 7d7d 223b  = "{{file.id}}";
-00001ba0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00001bb0: 2020 786e 6f74 652e 6874 7470 2e70 6f73    xnote.http.pos
-00001bc0: 7428 222f 6e6f 7465 2f6d 6f76 6522 2c20  t("/note/move", 
-00001bd0: 7b20 6964 3a20 6e6f 7465 4964 2c20 7061  { id: noteId, pa
-00001be0: 7265 6e74 5f69 643a 2070 6172 656e 7449  rent_id: parentI
-00001bf0: 6420 7d2c 2066 756e 6374 696f 6e20 2872  d }, function (r
-00001c00: 6573 7029 207b 0d0a 2020 2020 2020 2020  esp) {..        
-00001c10: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00001c20: 6f6c 652e 6c6f 6728 7265 7370 293b 0d0a  ole.log(resp);..
-00001c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c40: 2020 2020 7769 6e64 6f77 2e6c 6f63 6174      window.locat
-00001c50: 696f 6e2e 7265 6c6f 6164 2829 3b0d 0a20  ion.reload();.. 
-00001c60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00001c70: 293b 0d0a 2020 2020 2020 2020 2020 2020  );..            
-00001c80: 7d3b 0d0a 2020 2020 2020 2020 2020 2020  };..            
-00001c90: 786e 6f74 652e 6e6f 7465 2e73 656c 6563  xnote.note.selec
-00001ca0: 7447 726f 7570 466c 6174 2872 6571 293b  tGroupFlat(req);
-00001cb0: 0d0a 2020 2020 2020 2020 7d29 3b0d 0a20  ..        });.. 
-00001cc0: 2020 207d 290d 0a3c 2f73 6372 6970 743e     })..</script>
-00001cd0: 0d0a 0d0a 7b25 2069 6e63 6c75 6465 206e  ....{% include n
-00001ce0: 6f74 652f 636f 6d70 6f6e 656e 742f 7363  ote/component/sc
-00001cf0: 7269 7074 2f64 656c 6574 655f 7363 7269  ript/delete_scri
-00001d00: 7074 2e68 746d 6c20 257d                 pt.html %}
+00000000: 2f2a 2a0a 2a20 e980 9ae7 94a8 e79a 84e6  /**.* ..........
+00000010: 938d e4bd 9ce5 87bd e695 b00a 2a2f 0a24  ............*/.$
+00000020: 2866 756e 6374 696f 6e20 2829 207b 0a20  (function () {. 
+00000030: 200a 2020 7769 6e64 6f77 2e6d 6f76 6554   .  window.moveT
+00000040: 6f20 3d20 6675 6e63 7469 6f6e 2028 7365  o = function (se
+00000050: 6c66 4964 2c20 7061 7265 6e74 4964 2920  lfId, parentId) 
+00000060: 7b0a 2020 2020 242e 706f 7374 2822 2f6e  {.    $.post("/n
+00000070: 6f74 652f 6d6f 7665 222c 0a20 2020 207b  ote/move",.    {
+00000080: 2069 643a 2073 656c 6649 642c 2070 6172   id: selfId, par
+00000090: 656e 745f 6964 3a20 7061 7265 6e74 4964  ent_id: parentId
+000000a0: 207d 2c0a 2020 2020 6675 6e63 7469 6f6e   },.    function
+000000b0: 2028 7265 7370 2920 7b0a 2020 2020 2020   (resp) {.      
+000000c0: 636f 6e73 6f6c 652e 6c6f 6728 7265 7370  console.log(resp
+000000d0: 293b 0a20 2020 2020 2077 696e 646f 772e  );.      window.
+000000e0: 6c6f 6361 7469 6f6e 2e72 656c 6f61 6428  location.reload(
+000000f0: 293b 0a20 2020 207d 293b 0a20 207d 0a20  );.    });.  }. 
+00000100: 200a 2020 6675 6e63 7469 6f6e 2073 686f   .  function sho
+00000110: 7753 6964 6542 6172 2829 207b 0a20 2020  wSideBar() {.   
+00000120: 2024 2822 2e6e 6176 4d65 6e75 626f 7822   $(".navMenubox"
+00000130: 292e 616e 696d 6174 6528 7b20 226d 6172  ).animate({ "mar
+00000140: 6769 6e2d 6c65 6674 223a 2022 3070 7822  gin-left": "0px"
+00000150: 207d 293b 0a20 2020 2024 2822 2370 6f77   });.    $("#pow
+00000160: 6572 6564 4279 2229 2e73 686f 7728 293b  eredBy").show();
+00000170: 0a20 207d 0a20 200a 2020 6675 6e63 7469  .  }.  .  functi
+00000180: 6f6e 2068 6964 6553 6964 6542 6172 2829  on hideSideBar()
+00000190: 207b 0a20 2020 2024 2822 2e6e 6176 4d65   {.    $(".navMe
+000001a0: 6e75 626f 7822 292e 616e 696d 6174 6528  nubox").animate(
+000001b0: 7b20 226d 6172 6769 6e2d 6c65 6674 223a  { "margin-left":
+000001c0: 2022 2d32 3030 7078 2220 7d29 3b0a 2020   "-200px" });.  
+000001d0: 2020 2428 2223 706f 7765 7265 6442 7922    $("#poweredBy"
+000001e0: 292e 6869 6465 2829 3b0a 2020 7d0a 2020  ).hide();.  }.  
+000001f0: 0a20 2066 756e 6374 696f 6e20 6368 6563  .  function chec
+00000200: 6b52 6573 697a 6528 2920 7b0a 2020 2020  kResize() {.    
+00000210: 6966 2028 2428 222e 6e61 764d 656e 7562  if ($(".navMenub
+00000220: 6f78 2229 2e69 7328 223a 616e 696d 6174  ox").is(":animat
+00000230: 6564 2229 2920 7b0a 2020 2020 2020 7265  ed")) {.      re
+00000240: 7475 726e 3b0a 2020 2020 7d0a 2020 2020  turn;.    }.    
+00000250: 6966 2028 7769 6e64 6f77 2e69 6e6e 6572  if (window.inner
+00000260: 5769 6474 6820 3c20 3630 3029 207b 0a20  Width < 600) {. 
+00000270: 2020 2020 202f 2f20 e7a7 bbe5 8aa8 e7ab       // ........
+00000280: afef bc8c e585 bce5 aeb9 e4b8 8be4 b88d  ................
+00000290: e694 afe6 8c81 406d 6564 6961 e79a 84e6  ......@media....
+000002a0: b58f e8a7 88e5 99a8 200a 2020 2020 2020  ........ .      
+000002b0: 6869 6465 5369 6465 4261 7228 293b 0a20  hideSideBar();. 
+000002c0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+000002d0: 2020 7368 6f77 5369 6465 4261 7228 293b    showSideBar();
+000002e0: 0a20 2020 207d 0a20 207d 0a20 200a 2020  .    }.  }.  .  
+000002f0: 6675 6e63 7469 6f6e 2074 6f67 676c 654d  function toggleM
+00000300: 656e 7528 2920 7b0a 2020 2020 7661 7220  enu() {.    var 
+00000310: 6d61 7267 696e 4c65 6674 203d 2024 2822  marginLeft = $("
+00000320: 2e6e 6176 4d65 6e75 626f 7822 292e 6373  .navMenubox").cs
+00000330: 7328 226d 6172 6769 6e2d 6c65 6674 2229  s("margin-left")
+00000340: 3b0a 2020 2020 6966 2028 6d61 7267 696e  ;.    if (margin
+00000350: 4c65 6674 203d 3d20 2230 7078 2229 207b  Left == "0px") {
+00000360: 0a20 2020 2020 2068 6964 6553 6964 6542  .      hideSideB
+00000370: 6172 2829 3b0a 2020 2020 7d20 656c 7365  ar();.    } else
+00000380: 207b 0a20 2020 2020 2073 686f 7753 6964   {.      showSid
+00000390: 6542 6172 2829 3b0a 2020 2020 7d0a 2020  eBar();.    }.  
+000003a0: 7d0a 2020 0a20 2024 2822 2e74 6f67 676c  }.  .  $(".toggl
+000003b0: 654d 656e 7522 292e 6f6e 2822 636c 6963  eMenu").on("clic
+000003c0: 6b22 2c20 6675 6e63 7469 6f6e 2028 2920  k", function () 
+000003d0: 7b0a 2020 2020 746f 6767 6c65 4d65 6e75  {.    toggleMenu
+000003e0: 2829 3b0a 2020 7d29 3b0a 7d29 3b0a 0a2f  ();.  });.});../
+000003f0: 2a2a 0a2a 20e5 a484 e790 86e6 82ac e6b5  **.* ...........
+00000400: aee6 8ea7 e4bb b60a 2a2f 0a24 2866 756e  ........*/.$(fun
+00000410: 6374 696f 6e20 2829 207b 0a20 2076 6172  ction () {.  var
+00000420: 2077 6964 7468 203d 2039 3630 3b0a 2020   width = 960;.  
+00000430: 7661 7220 6d61 7857 6964 7468 203d 2024  var maxWidth = $
+00000440: 2877 696e 646f 7729 2e77 6964 7468 2829  (window).width()
+00000450: 3b0a 2020 7661 7220 6d61 7848 6569 6768  ;.  var maxHeigh
+00000460: 7420 3d20 2428 7769 6e64 6f77 292e 6865  t = $(window).he
+00000470: 6967 6874 2829 3b0a 2020 7661 7220 6c65  ight();.  var le
+00000480: 6674 5061 7274 5769 6474 6820 3d20 3230  ftPartWidth = 20
+00000490: 303b 0a20 200a 2020 7661 7220 6274 6e52  0;.  .  var btnR
+000004a0: 6967 6874 203d 2028 6d61 7857 6964 7468  ight = (maxWidth
+000004b0: 202d 2077 6964 7468 2920 2f20 3220 2b20   - width) / 2 + 
+000004c0: 3230 3b0a 2020 6966 2028 6274 6e52 6967  20;.  if (btnRig
+000004d0: 6874 203c 2030 2920 7b0a 2020 2020 6274  ht < 0) {.    bt
+000004e0: 6e52 6967 6874 203d 2032 303b 0a20 207d  nRight = 20;.  }
+000004f0: 0a20 2076 6172 2062 6f74 4865 6967 6874  .  var botHeight
+00000500: 203d 2022 3130 3025 223b 0a20 2076 6172   = "100%";.  var
+00000510: 2062 6f74 5769 6474 6820 3d20 6d61 7857   botWidth = maxW
+00000520: 6964 7468 202f 2032 3b0a 2020 0a20 2076  idth / 2;.  .  v
+00000530: 6172 2062 6f74 7320 3d20 7b7d 3b0a 2020  ar bots = {};.  
+00000540: 0a20 2066 756e 6374 696f 6e20 6372 6561  .  function crea
+00000550: 7465 4966 7261 6d65 2873 7263 2920 7b0a  teIframe(src) {.
+00000560: 2020 2020 7265 7475 726e 2024 2822 3c69      return $("<i
+00000570: 6672 616d 653e 2229 0a20 2020 202e 6164  frame>").    .ad
+00000580: 6443 6c61 7373 2822 6469 616c 6f67 2d69  dClass("dialog-i
+00000590: 6672 616d 6522 290a 2020 2020 2e61 7474  frame").    .att
+000005a0: 7228 2273 7263 222c 2073 7263 290a 2020  r("src", src).  
+000005b0: 2020 2e61 7474 7228 2269 6422 2c20 2262    .attr("id", "b
+000005c0: 6f74 4966 7261 6d65 2229 3b0a 2020 7d0a  otIframe");.  }.
+000005d0: 2020 0a20 2066 756e 6374 696f 6e20 6372    .  function cr
+000005e0: 6561 7465 436c 6f73 6542 746e 2829 207b  eateCloseBtn() {
+000005f0: 0a20 2020 2072 6574 7572 6e20 2428 223c  .    return $("<
+00000600: 7370 616e 3e22 292e 7465 7874 2822 436c  span>").text("Cl
+00000610: 6f73 6522 292e 6164 6443 6c61 7373 2822  ose").addClass("
+00000620: 6469 616c 6f67 2d63 6c6f 7365 2d62 746e  dialog-close-btn
+00000630: 2229 3b0a 2020 7d0a 2020 0a20 2066 756e  ");.  }.  .  fun
+00000640: 6374 696f 6e20 6372 6561 7465 5469 746c  ction createTitl
+00000650: 6528 2920 7b0a 2020 2020 7661 7220 6274  e() {.    var bt
+00000660: 6e31 203d 2024 2822 3c73 7061 6e3e 2229  n1 = $("<span>")
+00000670: 2e74 6578 7428 2248 6f6d 6522 292e 6164  .text("Home").ad
+00000680: 6443 6c61 7373 2822 6469 616c 6f67 2d74  dClass("dialog-t
+00000690: 6974 6c65 2d62 746e 2064 6961 6c6f 672d  itle-btn dialog-
+000006a0: 686f 6d65 2d62 746e 2229 3b0a 2020 2020  home-btn");.    
+000006b0: 7661 7220 6274 6e32 203d 2024 2822 3c73  var btn2 = $("<s
+000006c0: 7061 6e3e 2229 2e74 6578 7428 2254 6f6f  pan>").text("Too
+000006d0: 6c73 2229 2e61 6464 436c 6173 7328 2264  ls").addClass("d
+000006e0: 6961 6c6f 672d 7469 746c 652d 6274 6e20  ialog-title-btn 
+000006f0: 6469 616c 6f67 2d74 6f6f 6c73 2d62 746e  dialog-tools-btn
+00000700: 2229 3b0a 2020 2020 7661 7220 6274 6e33  ");.    var btn3
+00000710: 203d 2024 2822 3c73 7061 6e3e 2229 2e74   = $("<span>").t
+00000720: 6578 7428 2252 6566 7265 7368 2229 2e61  ext("Refresh").a
+00000730: 6464 436c 6173 7328 2264 6961 6c6f 672d  ddClass("dialog-
+00000740: 7469 746c 652d 6274 6e20 6469 616c 6f67  title-btn dialog
+00000750: 2d72 6566 7265 7368 2d62 746e 2229 3b0a  -refresh-btn");.
+00000760: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+00000770: 2428 223c 6469 763e 2229 2e61 6464 436c  $("<div>").addCl
+00000780: 6173 7328 2264 6961 6c6f 672d 7469 746c  ass("dialog-titl
+00000790: 6522 290a 2020 2020 2e61 7070 656e 6428  e").    .append(
+000007a0: 6372 6561 7465 436c 6f73 6542 746e 2829  createCloseBtn()
+000007b0: 290a 2020 2020 2e61 7070 656e 6428 6274  ).    .append(bt
+000007c0: 6e31 292e 6170 7065 6e64 2862 746e 3229  n1).append(btn2)
+000007d0: 2e61 7070 656e 6428 6274 6e33 293b 0a20  .append(btn3);. 
+000007e0: 207d 0a20 200a 2020 6675 6e63 7469 6f6e   }.  .  function
+000007f0: 2067 6574 426f 7474 6f6d 426f 7428 2920   getBottomBot() 
+00000800: 7b0a 2020 2020 6966 2028 626f 7473 2e62  {.    if (bots.b
+00000810: 6f74 746f 6d29 207b 0a20 2020 2020 2072  ottom) {.      r
+00000820: 6574 7572 6e20 626f 7473 2e62 6f74 746f  eturn bots.botto
+00000830: 6d3b 0a20 2020 207d 0a20 2020 2076 6172  m;.    }.    var
+00000840: 2062 6f74 203d 2024 2822 3c64 6976 3e22   bot = $("<div>"
+00000850: 292e 6373 7328 7b0a 2020 2020 2020 2270  ).css({.      "p
+00000860: 6f73 6974 696f 6e22 3a20 2266 6978 6564  osition": "fixed
+00000870: 222c 0a20 2020 2020 2022 7769 6474 6822  ",.      "width"
+00000880: 3a20 2231 3030 2522 2c0a 2020 2020 2020  : "100%",.      
+00000890: 2268 6569 6768 7422 3a20 2238 3025 222c  "height": "80%",
+000008a0: 0a20 2020 2020 2022 6261 636b 6772 6f75  .      "backgrou
+000008b0: 6e64 2d63 6f6c 6f72 223a 2022 2366 6666  nd-color": "#fff
+000008c0: 222c 0a20 2020 2020 2022 626f 7264 6572  ",.      "border
+000008d0: 223a 2022 3170 7820 736f 6c69 6420 2363  ": "1px solid #c
+000008e0: 6363 222c 0a20 2020 2020 2022 626f 7474  cc",.      "bott
+000008f0: 6f6d 223a 2022 3070 7822 2c0a 2020 2020  om": "0px",.    
+00000900: 2020 2272 6967 6874 223a 2022 3070 7822    "right": "0px"
+00000910: 2c0a 2020 2020 2020 227a 2d69 6e64 6578  ,.      "z-index
+00000920: 223a 2035 300a 2020 2020 7d29 2e61 7070  ": 50.    }).app
+00000930: 656e 6428 6372 6561 7465 4966 7261 6d65  end(createIframe
+00000940: 2822 2f22 2929 3b0a 2020 2020 626f 742e  ("/"));.    bot.
+00000950: 6869 6465 2829 3b0a 2020 2020 626f 742e  hide();.    bot.
+00000960: 6174 7472 2822 6964 222c 2022 782d 626f  attr("id", "x-bo
+00000970: 7422 293b 0a20 2020 2024 2864 6f63 756d  t");.    $(docum
+00000980: 656e 742e 626f 6479 292e 6170 7065 6e64  ent.body).append
+00000990: 2862 6f74 293b 0a20 2020 2062 6f74 732e  (bot);.    bots.
+000009a0: 626f 7474 6f6d 203d 2062 6f74 3b0a 2020  bottom = bot;.  
+000009b0: 2020 7265 7475 726e 2062 6f74 3b0a 2020    return bot;.  
+000009c0: 7d0a 2020 0a20 2066 756e 6374 696f 6e20  }.  .  function 
+000009d0: 6765 7449 6672 616d 6544 6961 6c6f 6728  getIframeDialog(
+000009e0: 2920 7b0a 2020 2020 6966 2028 626f 7473  ) {.    if (bots
+000009f0: 2e64 6961 6c6f 6729 207b 0a20 2020 2020  .dialog) {.     
+00000a00: 2072 6574 7572 6e20 626f 7473 2e64 6961   return bots.dia
+00000a10: 6c6f 673b 0a20 2020 207d 0a20 2020 2076  log;.    }.    v
+00000a20: 6172 206d 6169 6e57 6964 7468 203d 2024  ar mainWidth = $
+00000a30: 2822 2e72 6f6f 7422 292e 7769 6474 6828  (".root").width(
+00000a40: 293b 0a20 2020 2076 6172 2062 6f74 203d  );.    var bot =
+00000a50: 2024 2822 3c64 6976 3e22 292e 6373 7328   $("<div>").css(
+00000a60: 7b0a 2020 2020 2020 2270 6f73 6974 696f  {.      "positio
+00000a70: 6e22 3a20 2266 6978 6564 222c 0a20 2020  n": "fixed",.   
+00000a80: 2020 2022 7769 6474 6822 3a20 6d61 696e     "width": main
+00000a90: 5769 6474 682c 0a20 2020 2020 2022 6865  Width,.      "he
+00000aa0: 6967 6874 223a 2022 3830 2522 2c0a 2020  ight": "80%",.  
+00000ab0: 2020 2020 2262 6163 6b67 726f 756e 642d      "background-
+00000ac0: 636f 6c6f 7222 3a20 2223 6666 6622 2c0a  color": "#fff",.
+00000ad0: 2020 2020 2020 2262 6f72 6465 7222 3a20        "border": 
+00000ae0: 2231 7078 2073 6f6c 6964 2023 6363 6322  "1px solid #ccc"
+00000af0: 2c0a 2020 2020 2020 2262 6f74 746f 6d22  ,.      "bottom"
+00000b00: 3a20 2230 7078 222c 0a20 2020 2020 2022  : "0px",.      "
+00000b10: 7269 6768 7422 3a20 2230 7078 222c 0a20  right": "0px",. 
+00000b20: 2020 2020 2022 7a2d 696e 6465 7822 3a20       "z-index": 
+00000b30: 3530 0a20 2020 207d 292e 6170 7065 6e64  50.    }).append
+00000b40: 2863 7265 6174 6549 6672 616d 6528 222f  (createIframe("/
+00000b50: 2229 293b 0a20 2020 2062 6f74 2e68 6964  "));.    bot.hid
+00000b60: 6528 293b 0a20 2020 2024 2864 6f63 756d  e();.    $(docum
+00000b70: 656e 742e 626f 6479 292e 6170 7065 6e64  ent.body).append
+00000b80: 2862 6f74 293b 0a20 2020 2062 6f74 732e  (bot);.    bots.
+00000b90: 6469 616c 6f67 203d 2062 6f74 3b0a 2020  dialog = bot;.  
+00000ba0: 2020 7265 7475 726e 2062 6f74 3b0a 2020    return bot;.  
+00000bb0: 7d0a 2020 0a20 2066 756e 6374 696f 6e20  }.  .  function 
+00000bc0: 696e 6974 4576 656e 7448 616e 646c 6572  initEventHandler
+00000bd0: 7328 2920 7b0a 2020 2020 2f2f 2063 6c6f  s() {.    // clo
+00000be0: 7365 2062 7574 746f 6e20 6576 656e 740a  se button event.
+00000bf0: 2020 2020 636f 6e73 6f6c 652e 6c6f 6728      console.log(
+00000c00: 2269 6e69 7422 293b 0a20 2020 2024 2822  "init");.    $("
+00000c10: 626f 6479 2229 2e6f 6e28 2263 6c69 636b  body").on("click
+00000c20: 222c 2022 2e64 6961 6c6f 672d 636c 6f73  ", ".dialog-clos
+00000c30: 652d 6274 6e22 2c20 6675 6e63 7469 6f6e  e-btn", function
+00000c40: 2028 2920 7b0a 2020 2020 2020 6765 7452   () {.      getR
+00000c50: 6967 6874 426f 7428 292e 6661 6465 4f75  ightBot().fadeOu
+00000c60: 7428 3230 3029 3b0a 2020 2020 7d29 3b0a  t(200);.    });.
+00000c70: 2020 2020 2428 2262 6f64 7922 292e 6f6e      $("body").on
+00000c80: 2822 636c 6963 6b22 2c20 222e 6469 616c  ("click", ".dial
+00000c90: 6f67 2d68 6f6d 652d 6274 6e22 2c20 6675  og-home-btn", fu
+00000ca0: 6e63 7469 6f6e 2028 2920 7b0a 2020 2020  nction () {.    
+00000cb0: 2020 2428 222e 7269 6768 742d 626f 7420    $(".right-bot 
+00000cc0: 6966 7261 6d65 2229 2e61 7474 7228 2273  iframe").attr("s
+00000cd0: 7263 222c 2022 2f22 293b 0a20 2020 207d  rc", "/");.    }
+00000ce0: 293b 0a20 2020 2024 2822 626f 6479 2229  );.    $("body")
+00000cf0: 2e6f 6e28 2263 6c69 636b 222c 2022 2e64  .on("click", ".d
+00000d00: 6961 6c6f 672d 746f 6f6c 732d 6274 6e22  ialog-tools-btn"
+00000d10: 2c20 6675 6e63 7469 6f6e 2028 2920 7b0a  , function () {.
+00000d20: 2020 2020 2020 2428 222e 7269 6768 742d        $(".right-
+00000d30: 626f 7420 6966 7261 6d65 2229 2e61 7474  bot iframe").att
+00000d40: 7228 2273 7263 222c 2022 2f66 735f 6170  r("src", "/fs_ap
+00000d50: 692f 706c 7567 696e 7322 293b 0a20 2020  i/plugins");.   
+00000d60: 207d 293b 0a20 2020 2024 2822 626f 6479   });.    $("body
+00000d70: 2229 2e6f 6e28 2263 6c69 636b 222c 2022  ").on("click", "
+00000d80: 2e64 6961 6c6f 672d 7265 6672 6573 682d  .dialog-refresh-
+00000d90: 6274 6e22 2c20 6675 6e63 7469 6f6e 2028  btn", function (
+00000da0: 2920 7b0a 2020 2020 2020 2428 222e 7269  ) {.      $(".ri
+00000db0: 6768 742d 626f 7420 6966 7261 6d65 2229  ght-bot iframe")
+00000dc0: 5b30 5d2e 636f 6e74 656e 7457 696e 646f  [0].contentWindo
+00000dd0: 772e 6c6f 6361 7469 6f6e 2e72 656c 6f61  w.location.reloa
+00000de0: 6428 293b 0a20 2020 207d 293b 0a20 2020  d();.    });.   
+00000df0: 2024 2822 626f 6479 2229 2e6f 6e28 2263   $("body").on("c
+00000e00: 6c69 636b 222c 2022 2e6c 6179 6572 2d62  lick", ".layer-b
+00000e10: 746e 222c 2066 756e 6374 696f 6e20 2865  tn", function (e
+00000e20: 7665 6e74 2920 7b0a 2020 2020 2020 636f  vent) {.      co
+00000e30: 6e73 6f6c 652e 6c6f 6728 2263 6c69 636b  nsole.log("click
+00000e40: 2229 3b0a 2020 2020 2020 7661 7220 7461  ");.      var ta
+00000e50: 7267 6574 203d 2065 7665 6e74 2e74 6172  rget = event.tar
+00000e60: 6765 743b 0a20 2020 2020 2076 6172 2075  get;.      var u
+00000e70: 726c 203d 2024 2874 6172 6765 7429 2e61  rl = $(target).a
+00000e80: 7474 7228 2264 6174 612d 7572 6c22 293b  ttr("data-url");
+00000e90: 0a20 2020 2020 206f 7065 6e44 6961 6c6f  .      openDialo
+00000ea0: 6728 7572 6c29 3b0a 2020 2020 7d29 3b0a  g(url);.    });.
+00000eb0: 2020 2020 636f 6e73 6f6c 652e 6c6f 6728      console.log(
+00000ec0: 2269 6e69 7420 646f 6e65 2229 3b0a 2020  "init done");.  
+00000ed0: 7d0a 2020 0a20 2066 756e 6374 696f 6e20  }.  .  function 
+00000ee0: 6765 7452 6967 6874 426f 7428 2920 7b0a  getRightBot() {.
+00000ef0: 2020 2020 6966 2028 626f 7473 2e72 6967      if (bots.rig
+00000f00: 6874 2920 7b0a 2020 2020 2020 7265 7475  ht) {.      retu
+00000f10: 726e 2062 6f74 732e 7269 6768 743b 0a20  rn bots.right;. 
+00000f20: 2020 207d 0a20 2020 2076 6172 2077 6964     }.    var wid
+00000f30: 7468 203d 2022 3530 2522 3b0a 2020 2020  th = "50%";.    
+00000f40: 6966 2028 6d61 7857 6964 7468 203c 2036  if (maxWidth < 6
+00000f50: 3030 2920 7b0a 2020 2020 2020 7769 6474  00) {.      widt
+00000f60: 6820 3d20 2231 3030 2522 3b0a 2020 2020  h = "100%";.    
+00000f70: 7d0a 2020 2020 7661 7220 7269 6768 7442  }.    var rightB
+00000f80: 6f74 203d 2024 2822 3c64 6976 3e22 292e  ot = $("<div>").
+00000f90: 6373 7328 7b0a 2020 2020 2020 2270 6f73  css({.      "pos
+00000fa0: 6974 696f 6e22 3a20 2266 6978 6564 222c  ition": "fixed",
+00000fb0: 0a20 2020 2020 2022 7769 6474 6822 3a20  .      "width": 
+00000fc0: 7769 6474 682c 0a20 2020 2020 2022 7269  width,.      "ri
+00000fd0: 6768 7422 3a20 2230 7078 222c 0a20 2020  ght": "0px",.   
+00000fe0: 2020 2022 626f 7474 6f6d 223a 2022 3070     "bottom": "0p
+00000ff0: 7822 2c0a 2020 2020 2020 2274 6f70 223a  x",.      "top":
+00001000: 2022 3070 7822 2c0a 2020 2020 2020 2262   "0px",.      "b
+00001010: 6163 6b67 726f 756e 642d 636f 6c6f 7222  ackground-color"
+00001020: 3a20 2223 6666 6622 2c0a 2020 2020 2020  : "#fff",.      
+00001030: 2262 6f72 6465 7222 3a20 2273 6f6c 6964  "border": "solid
+00001040: 2031 7078 2023 6363 6322 2c0a 2020 2020   1px #ccc",.    
+00001050: 2020 227a 2d69 6e64 6578 223a 2035 302c    "z-index": 50,
+00001060: 0a20 2020 207d 292e 6170 7065 6e64 2863  .    }).append(c
+00001070: 7265 6174 6554 6974 6c65 2829 290a 2020  reateTitle()).  
+00001080: 2020 2e61 7070 656e 6428 6372 6561 7465    .append(create
+00001090: 4966 7261 6d65 2822 2f73 7973 7465 6d2f  Iframe("/system/
+000010a0: 696e 6465 7822 2929 0a20 2020 202e 6164  index")).    .ad
+000010b0: 6443 6c61 7373 2822 7269 6768 742d 626f  dClass("right-bo
+000010c0: 7422 293b 0a20 2020 2072 6967 6874 426f  t");.    rightBo
+000010d0: 742e 6869 6465 2829 3b0a 2020 2020 2428  t.hide();.    $(
+000010e0: 646f 6375 6d65 6e74 2e62 6f64 7929 2e61  document.body).a
+000010f0: 7070 656e 6428 7269 6768 7442 6f74 293b  ppend(rightBot);
+00001100: 0a20 2020 2062 6f74 732e 7269 6768 7420  .    bots.right 
+00001110: 3d20 7269 6768 7442 6f74 3b0a 2020 2020  = rightBot;.    
+00001120: 7265 7475 726e 2072 6967 6874 426f 743b  return rightBot;
+00001130: 0a20 207d 0a20 200a 2020 6675 6e63 7469  .  }.  .  functi
+00001140: 6f6e 2069 6e69 7453 6561 7263 6842 6f78  on initSearchBox
+00001150: 5769 6474 6828 2920 7b0a 2020 2020 6966  Width() {.    if
+00001160: 2028 7769 6e64 6f77 2e53 484f 575f 4153   (window.SHOW_AS
+00001170: 4944 4520 3d3d 2022 4661 6c73 6522 2920  IDE == "False") 
+00001180: 7b0a 2020 2020 2020 2428 222e 6e61 762d  {.      $(".nav-
+00001190: 6c65 6674 2d73 6561 7263 6822 292e 6373  left-search").cs
+000011a0: 7328 2277 6964 7468 222c 2022 3130 3025  s("width", "100%
+000011b0: 2229 3b0a 2020 2020 7d0a 2020 7d0a 2020  ");.    }.  }.  
+000011c0: 0a20 2066 756e 6374 696f 6e20 696e 6974  .  function init
+000011d0: 2829 207b 0a20 2020 202f 2f20 7661 7220  () {.    // var 
+000011e0: 626f 7442 746e 203d 2024 2822 3c64 6976  botBtn = $("<div
+000011f0: 3e22 292e 7465 7874 2822 e5b7 a5e5 85b7  >").text("......
+00001200: 2229 2e63 7373 2822 7269 6768 7422 2c20  ").css("right", 
+00001210: 6274 6e52 6967 6874 292e 6164 6443 6c61  btnRight).addCla
+00001220: 7373 2822 626f 742d 6274 6e22 293b 0a20  ss("bot-btn");. 
+00001230: 2020 202f 2f20 2428 646f 6375 6d65 6e74     // $(document
+00001240: 2e62 6f64 7929 2e61 7070 656e 6428 626f  .body).append(bo
+00001250: 7442 746e 293b 0a20 2020 2024 2822 2e62  tBtn);.    $(".b
+00001260: 6f74 2d62 746e 2229 2e63 6c69 636b 2866  ot-btn").click(f
+00001270: 756e 6374 696f 6e20 2829 207b 0a20 2020  unction () {.   
+00001280: 2020 2067 6574 5269 6768 7442 6f74 2829     getRightBot()
+00001290: 2e66 6164 6554 6f67 676c 6528 3230 3029  .fadeToggle(200)
+000012a0: 3b0a 2020 2020 7d29 3b0a 2020 2020 696e  ;.    });.    in
+000012b0: 6974 5365 6172 6368 426f 7857 6964 7468  itSearchBoxWidth
+000012c0: 2829 3b0a 2020 2020 696e 6974 4576 656e  ();.    initEven
+000012d0: 7448 616e 646c 6572 7328 293b 0a20 207d  tHandlers();.  }
+000012e0: 0a20 200a 2020 6675 6e63 7469 6f6e 2073  .  .  function s
+000012f0: 686f 7749 6672 616d 6544 6961 6c6f 6728  howIframeDialog(
+00001300: 7372 6329 207b 0a20 2020 2067 6574 5269  src) {.    getRi
+00001310: 6768 7442 6f74 2829 2e66 6164 6549 6e28  ghtBot().fadeIn(
+00001320: 3230 3029 3b0a 2020 2020 2428 2223 626f  200);.    $("#bo
+00001330: 7449 6672 616d 6522 292e 6174 7472 2822  tIframe").attr("
+00001340: 7372 6322 2c20 7372 6329 3b0a 2020 7d0a  src", src);.  }.
+00001350: 2020 0a20 2066 756e 6374 696f 6e20 6869    .  function hi
+00001360: 6465 4966 7261 6d65 4469 616c 6f67 2829  deIframeDialog()
+00001370: 207b 0a20 2020 2067 6574 5269 6768 7442   {.    getRightB
+00001380: 6f74 2829 2e66 6164 654f 7574 2832 3030  ot().fadeOut(200
+00001390: 293b 0a20 207d 0a20 200a 2020 7769 6e64  );.  }.  .  wind
+000013a0: 6f77 2e6f 7065 6e44 6961 6c6f 6720 3d20  ow.openDialog = 
+000013b0: 6675 6e63 7469 6f6e 2028 7572 6c29 207b  function (url) {
+000013c0: 0a20 2020 2076 6172 2077 6964 7468 203d  .    var width =
+000013d0: 2024 2822 2e72 6f6f 7422 292e 7769 6474   $(".root").widt
+000013e0: 6828 2920 2d20 3430 3b0a 2020 2020 7661  h() - 40;.    va
+000013f0: 7220 6172 6561 3b0a 2020 2020 0a20 2020  r area;.    .   
+00001400: 2069 6620 2869 734d 6f62 696c 6528 2929   if (isMobile())
+00001410: 207b 0a20 2020 2020 2061 7265 6120 3d20   {.      area = 
+00001420: 5b27 3130 3025 272c 2027 3130 3025 275d  ['100%', '100%']
+00001430: 3b0a 2020 2020 7d20 656c 7365 207b 0a20  ;.    } else {. 
+00001440: 2020 2020 2061 7265 6120 3d20 5b77 6964       area = [wid
+00001450: 7468 202b 2027 7078 272c 2027 3830 2527  th + 'px', '80%'
+00001460: 5d3b 0a20 2020 207d 0a20 2020 200a 2020  ];.    }.    .  
+00001470: 2020 6c61 7965 722e 6f70 656e 287b 0a20    layer.open({. 
+00001480: 2020 2020 2074 7970 653a 2032 2c0a 2020       type: 2,.  
+00001490: 2020 2020 7368 6164 6543 6c6f 7365 3a20      shadeClose: 
+000014a0: 7472 7565 2c0a 2020 2020 2020 7469 746c  true,.      titl
+000014b0: 653a 2027 e5ad 90e9 a1b5 e99d a227 2c0a  e: '.........',.
+000014c0: 2020 2020 2020 6d61 786d 696e 3a20 7472        maxmin: tr
+000014d0: 7565 2c0a 2020 2020 2020 6172 6561 3a20  ue,.      area: 
+000014e0: 6172 6561 2c0a 2020 2020 2020 636f 6e74  area,.      cont
+000014f0: 656e 743a 2075 726c 2c0a 2020 2020 2020  ent: url,.      
+00001500: 7363 726f 6c6c 6261 723a 2066 616c 7365  scrollbar: false
+00001510: 0a20 2020 207d 293b 0a20 207d 0a20 200a  .    });.  }.  .
+00001520: 2020 7769 6e64 6f77 2e73 686f 7749 6672    window.showIfr
+00001530: 616d 6544 6961 6c6f 6720 3d20 7368 6f77  ameDialog = show
+00001540: 4966 7261 6d65 4469 616c 6f67 3b0a 2020  IframeDialog;.  
+00001550: 7769 6e64 6f77 2e68 6964 6549 6672 616d  window.hideIfram
+00001560: 6544 6961 6c6f 6720 3d20 6869 6465 4966  eDialog = hideIf
+00001570: 7261 6d65 4469 616c 6f67 3b0a 2020 0a20  rameDialog;.  . 
+00001580: 2077 696e 646f 772e 746f 6767 6c65 4d65   window.toggleMe
+00001590: 6e75 203d 2066 756e 6374 696f 6e20 2829  nu = function ()
+000015a0: 207b 0a20 2020 2024 2822 2e61 7369 6465   {.    $(".aside
+000015b0: 2d62 6163 6b67 726f 756e 6422 292e 746f  -background").to
+000015c0: 6767 6c65 2829 3b0a 2020 2020 2428 222e  ggle();.    $(".
+000015d0: 6173 6964 6522 292e 746f 6767 6c65 2835  aside").toggle(5
+000015e0: 3030 293b 0a20 207d 0a20 200a 2020 2f2a  00);.  }.  .  /*
+000015f0: 2a0a 2020 2a20 e8b0 83e6 95b4 e9ab 98e5  *.  * ..........
+00001600: baa6 efbc 8ce9 809a e8bf 870a 2020 2a20  ............  * 
+00001610: 4070 6172 616d 207b 7374 7269 6e67 7d20  @param {string} 
+00001620: 7365 6c65 6374 6f72 20e9 8089 e68b a9e5  selector .......
+00001630: 99a8 0a20 202a 2040 7061 7261 6d20 7b6e  ...  * @param {n
+00001640: 756d 6265 727d 2062 6f74 746f 6d20 e8b7  umber} bottom ..
+00001650: 9de7 a6bb e7aa 97e5 8fa3 e5ba 95e9 83a8  ................
+00001660: e79a 84e8 b79d e7a6 bb0a 2020 2a2f 0a20  ..........  */. 
+00001670: 2077 696e 646f 772e 6164 6a75 7374 4865   window.adjustHe
+00001680: 6967 6874 203d 2066 756e 6374 696f 6e20  ight = function 
+00001690: 2873 656c 6563 746f 722c 2062 6f74 746f  (selector, botto
+000016a0: 6d2c 206f 7074 696f 6e73 2920 7b0a 2020  m, options) {.  
+000016b0: 2020 626f 7474 6f6d 203d 2062 6f74 746f    bottom = botto
+000016c0: 6d20 7c7c 2030 3b0a 2020 2020 7661 7220  m || 0;.    var 
+000016d0: 6865 6967 6874 203d 2067 6574 5769 6e64  height = getWind
+000016e0: 6f77 4865 6967 6874 2829 202d 2024 2873  owHeight() - $(s
+000016f0: 656c 6563 746f 7229 2e6f 6666 7365 7428  elector).offset(
+00001700: 292e 746f 7020 2d20 626f 7474 6f6d 3b0a  ).top - bottom;.
+00001710: 2020 2020 2428 7365 6c65 6374 6f72 292e      $(selector).
+00001720: 6373 7328 2268 6569 6768 7422 2c20 6865  css("height", he
+00001730: 6967 6874 292e 6373 7328 226f 7665 7266  ight).css("overf
+00001740: 6c6f 7722 2c20 2261 7574 6f22 293b 0a20  low", "auto");. 
+00001750: 2020 200a 2020 2020 6966 2028 6f70 7469     .    if (opti
+00001760: 6f6e 7320 213d 2075 6e64 6566 696e 6564  ons != undefined
+00001770: 2920 7b0a 2020 2020 2020 6966 2028 6f70  ) {.      if (op
+00001780: 7469 6f6e 732e 6f76 6572 666c 6f77 2920  tions.overflow) 
+00001790: 7b0a 2020 2020 2020 2020 2428 7365 6c65  {.        $(sele
+000017a0: 6374 6f72 292e 6373 7328 226f 7665 7266  ctor).css("overf
+000017b0: 6c6f 7722 2c20 6f70 7469 6f6e 732e 6f76  low", options.ov
+000017c0: 6572 666c 6f77 293b 0a20 2020 2020 207d  erflow);.      }
+000017d0: 0a20 2020 207d 0a20 2020 200a 2020 2020  .    }.    .    
+000017e0: 7265 7475 726e 2068 6569 6768 743b 0a20  return height;. 
+000017f0: 207d 0a20 200a 2020 2f2a 2a0a 2020 2a20   }.  .  /**.  * 
+00001800: e8b0 83e6 95b4 e5af bce8 88aa e6a0 8fef  ................
+00001810: bc8c e5a6 82e6 9e9c e59c a869 6672 616d  ...........ifram
+00001820: 65e4 b8ad efbc 8ce5 8899 e4b8 8de6 98be  e...............
+00001830: e7a4 bae8 8f9c e58d 950a 2020 2a2f 0a20  ..........  */. 
+00001840: 2077 696e 646f 772e 6164 6a75 7374 4e61   window.adjustNa
+00001850: 7620 3d20 6675 6e63 7469 6f6e 2028 2920  v = function () 
+00001860: 7b0a 2020 2020 6966 2028 7365 6c66 2021  {.    if (self !
+00001870: 3d20 746f 7029 207b 0a20 2020 2020 2024  = top) {.      $
+00001880: 2822 2e6e 6176 2229 2e68 6964 6528 293b  (".nav").hide();
+00001890: 0a20 2020 2020 2024 2822 2e72 6f6f 7422  .      $(".root"
+000018a0: 292e 6373 7328 2270 6164 6469 6e67 222c  ).css("padding",
+000018b0: 2022 3130 7078 2229 3b0a 2020 2020 7d0a   "10px");.    }.
+000018c0: 2020 7d0a 2020 0a20 2077 696e 646f 772e    }.  .  window.
+000018d0: 6164 6a75 7374 5461 626c 6520 3d20 6675  adjustTable = fu
+000018e0: 6e63 7469 6f6e 2028 2920 7b0a 2020 2020  nction () {.    
+000018f0: 2428 2274 6162 6c65 2229 2e65 6163 6828  $("table").each(
+00001900: 6675 6e63 7469 6f6e 2028 696e 6465 782c  function (index,
+00001910: 2065 6c65 6d65 6e74 2920 7b0a 2020 2020   element) {.    
+00001920: 2020 7661 7220 636f 756e 7420 3d20 2428    var count = $(
+00001930: 656c 656d 656e 7429 2e66 696e 6428 2274  element).find("t
+00001940: 6822 292e 6c65 6e67 7468 3b0a 2020 2020  h").length;.    
+00001950: 2020 6966 2028 636f 756e 7420 3e20 3029    if (count > 0)
+00001960: 207b 0a20 2020 2020 2020 2024 2865 6c65   {.        $(ele
+00001970: 6d65 6e74 292e 6669 6e64 2822 7468 2229  ment).find("th")
+00001980: 2e63 7373 2822 7769 6474 6822 2c20 3130  .css("width", 10
+00001990: 3020 2f20 636f 756e 7420 2b20 2725 2729  0 / count + '%')
+000019a0: 3b0a 2020 2020 2020 7d0a 2020 2020 7d29  ;.      }.    })
+000019b0: 3b0a 2020 7d0a 2020 0a20 2024 2822 2e61  ;.  }.  .  $(".a
+000019c0: 7369 6465 2d62 6163 6b67 726f 756e 6422  side-background"
+000019d0: 292e 6f6e 2827 636c 6963 6b27 2c20 6675  ).on('click', fu
+000019e0: 6e63 7469 6f6e 2028 2920 7b0a 2020 2020  nction () {.    
+000019f0: 746f 6767 6c65 4d65 6e75 2829 3b0a 2020  toggleMenu();.  
+00001a00: 7d29 3b0a 2020 0a20 200a 2020 6966 2028  });.  .  .  if (
+00001a10: 7769 6e64 6f77 2e50 4147 455f 4f50 454e  window.PAGE_OPEN
+00001a20: 203d 3d20 2264 6961 6c6f 6722 2920 7b0a   == "dialog") {.
+00001a30: 2020 2020 2f2f 20e4 bdbf e794 a8e5 afb9      // .........
+00001a40: e8af 9de6 a186 e6b5 8fe8 a788 e7ac 94e8  ................
+00001a50: aeb0 0a20 2020 2024 2822 2e64 6961 6c6f  ...    $(".dialo
+00001a60: 672d 6c69 6e6b 2229 2e63 6c69 636b 2866  g-link").click(f
+00001a70: 756e 6374 696f 6e20 2865 2920 7b0a 2020  unction (e) {.  
+00001a80: 2020 2020 652e 7072 6576 656e 7444 6566      e.preventDef
+00001a90: 6175 6c74 2829 3b0a 2020 2020 2020 7661  ault();.      va
+00001aa0: 7220 7572 6c20 3d20 2428 7468 6973 292e  r url = $(this).
+00001ab0: 6174 7472 2822 6872 6566 2229 3b0a 2020  attr("href");.  
+00001ac0: 2020 2020 7661 7220 7769 6474 6820 3d20      var width = 
+00001ad0: 2428 222e 726f 6f74 2229 2e77 6964 7468  $(".root").width
+00001ae0: 2829 3b0a 2020 2020 2020 6c61 7965 722e  ();.      layer.
+00001af0: 6f70 656e 287b 0a20 2020 2020 2020 2074  open({.        t
+00001b00: 7970 653a 2032 2c0a 2020 2020 2020 2020  ype: 2,.        
+00001b10: 7469 746c 653a 2022 e69f a5e7 9c8b 222c  title: "......",
+00001b20: 0a20 2020 2020 2020 2073 6861 6465 436c  .        shadeCl
+00001b30: 6f73 653a 2074 7275 652c 0a20 2020 2020  ose: true,.     
+00001b40: 2020 2073 6861 6465 3a20 302e 382c 0a20     shade: 0.8,. 
+00001b50: 2020 2020 2020 2061 7265 613a 205b 7769         area: [wi
+00001b60: 6474 6820 2b20 2270 7822 2c20 2239 3025  dth + "px", "90%
+00001b70: 225d 2c0a 2020 2020 2020 2020 7363 726f  "],.        scro
+00001b80: 6c6c 6261 723a 2066 616c 7365 2c0a 2020  llbar: false,.  
+00001b90: 2020 2020 2020 636f 6e74 656e 743a 2075        content: u
+00001ba0: 726c 0a20 2020 2020 207d 293b 0a20 2020  rl.      });.   
+00001bb0: 207d 293b 0a20 207d 0a20 200a 2020 6675   });.  }.  .  fu
+00001bc0: 6e63 7469 6f6e 2070 726f 6365 7373 496e  nction processIn
+00001bd0: 4966 7261 6d65 2829 207b 0a20 2020 200a  Iframe() {.    .
+00001be0: 2020 7d0a 2020 0a20 2069 6620 2873 656c    }.  .  if (sel
+00001bf0: 6620 213d 2074 6f70 2920 7b0a 2020 2020  f != top) {.    
+00001c00: 7072 6f63 6573 7349 6e49 6672 616d 6528  processInIframe(
+00001c10: 293b 0a20 207d 0a20 200a 2020 696e 6974  );.  }.  .  init
+00001c20: 2829 3b0a 7d29 3b0a 0a0a 786e 6f74 652e  ();.});...xnote.
+00001c30: 6576 656e 7473 2e66 6972 6555 706c 6f61  events.fireUploa
+00001c40: 6445 7665 6e74 203d 2066 756e 6374 696f  dEvent = functio
+00001c50: 6e20 2865 7665 6e74 2920 7b0a 2020 786e  n (event) {.  xn
+00001c60: 6f74 652e 6669 7265 2822 6673 2e75 706c  ote.fire("fs.upl
+00001c70: 6f61 6422 2c20 6576 656e 7429 3b0a 7d3b  oad", event);.};
+00001c80: 0a0a 786e 6f74 652e 6576 656e 7473 2e6f  ..xnote.events.o
+00001c90: 6e55 706c 6f61 6445 7665 6e74 203d 2066  nUploadEvent = f
+00001ca0: 756e 6374 696f 6e20 286c 6973 7465 6e65  unction (listene
+00001cb0: 7229 207b 0a20 2078 6e6f 7465 2e6f 6e28  r) {.  xnote.on(
+00001cc0: 2266 732e 7570 6c6f 6164 222c 206c 6973  "fs.upload", lis
+00001cd0: 7465 6e65 7229 3b0a 7d3b 0a0a 0a78 6e6f  tener);.};...xno
+00001ce0: 7465 2e65 7665 6e74 732e 6669 7265 5570  te.events.fireUp
+00001cf0: 6c6f 6164 5072 6570 6172 6545 7665 6e74  loadPrepareEvent
+00001d00: 203d 2066 756e 6374 696f 6e20 2865 7665   = function (eve
+00001d10: 6e74 2920 7b0a 2020 636f 6e73 6f6c 652e  nt) {.  console.
+00001d20: 6c6f 6728 2266 6972 6555 706c 6f61 6450  log("fireUploadP
+00001d30: 7265 7061 7265 4576 656e 7422 2c20 6576  repareEvent", ev
+00001d40: 656e 7429 3b0a 2020 786e 6f74 652e 6669  ent);.  xnote.fi
+00001d50: 7265 2822 6673 2e75 706c 6f61 642e 7072  re("fs.upload.pr
+00001d60: 6570 6172 6522 2c20 6576 656e 7429 3b0a  epare", event);.
+00001d70: 7d3b 0a0a 786e 6f74 652e 6576 656e 7473  };..xnote.events
+00001d80: 2e6f 6e55 706c 6f61 6450 7265 7061 7265  .onUploadPrepare
+00001d90: 4576 656e 7420 3d20 6675 6e63 7469 6f6e  Event = function
+00001da0: 2028 6c69 7374 656e 6572 2920 7b0a 2020   (listener) {.  
+00001db0: 786e 6f74 652e 6f6e 2822 6673 2e75 706c  xnote.on("fs.upl
+00001dc0: 6f61 642e 7072 6570 6172 6522 2c20 6c69  oad.prepare", li
+00001dd0: 7374 656e 6572 293b 0a7d 3b0a            stener);.};.
```

### Comparing `xnote-web-0.1.0/handlers/note/component/script/rename_script.html` & `xnote-web-0.1.1/handlers/note/component/script/rename_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/share_script.html` & `xnote-web-0.1.1/handlers/note/component/script/share_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/status_script.html` & `xnote-web-0.1.1/handlers/note/component/script/status_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/tag_manage_script.html` & `xnote-web-0.1.1/handlers/note/component/script/tag_manage_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/script/tag_script.html` & `xnote-web-0.1.1/handlers/note/component/script/tag_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/share_dialog.html` & `xnote-web-0.1.1/handlers/note/component/share_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/sidebar/group_list_sidebar.html` & `xnote-web-0.1.1/handlers/note/page/note_tools.html`

 * *Files 24% similar despite different names*

```diff
@@ -1,74 +1,81 @@
-00000000: 3c21 2d2d 207b 230d 0a40 4175 7468 6f72  <!-- {#..@Author
-00000010: 2020 2020 2020 203a 2078 7570 696e 676d         : xupingm
-00000020: 616f 0d0a 4065 6d61 696c 2020 2020 2020  ao..@email      
-00000030: 2020 3a20 3537 3837 3439 3334 3140 7171    : 578749341@qq
-00000040: 2e63 6f6d 0d0a 4044 6174 6520 2020 2020  .com..@Date     
-00000050: 2020 2020 3a20 3230 3232 2d30 372d 3137      : 2022-07-17
-00000060: 2031 303a 3239 3a32 330d 0a40 4c61 7374   10:29:23..@Last
-00000070: 4564 6974 6f72 7320 203a 2078 7570 696e  Editors  : xupin
-00000080: 676d 616f 0d0a 404c 6173 7445 6469 7454  gmao..@LastEditT
-00000090: 696d 6520 3a20 3230 3234 2d30 312d 3237  ime : 2024-01-27
-000000a0: 2031 343a 3034 3a34 360d 0a40 4669 6c65   14:04:46..@File
-000000b0: 5061 7468 2020 2020 203a 202f 786e 6f74  Path     : /xnot
-000000c0: 652f 6861 6e64 6c65 7273 2f6e 6f74 652f  e/handlers/note/
-000000d0: 636f 6d70 6f6e 656e 742f 7369 6465 6261  component/sideba
-000000e0: 722f 6772 6f75 705f 6c69 7374 5f73 6964  r/group_list_sid
-000000f0: 6562 6172 2e68 746d 6c0d 0a40 4465 7363  ebar.html..@Desc
-00000100: 7269 7074 696f 6e20 203a 20e6 8f8f e8bf  ription  : .....
-00000110: b00d 0a23 7d20 2d2d 3e0d 0a0d 0a3c 6469  ...#} -->....<di
-00000120: 7620 636c 6173 733d 2264 6573 6b74 6f70  v class="desktop
-00000130: 2d6f 6e6c 7922 3e0d 0a20 2020 207b 2520  -only">..    {% 
-00000140: 696e 636c 7564 6520 636f 6d6d 6f6e 2f73  include common/s
-00000150: 6964 6562 6172 2f61 7070 5f69 6e64 6578  idebar/app_index
-00000160: 2e68 746d 6c20 257d 0d0a 2020 2020 7b25  .html %}..    {%
-00000170: 2069 6e63 6c75 6465 206e 6f74 652f 636f   include note/co
-00000180: 6d70 6f6e 656e 742f 7369 6465 6261 722f  mponent/sidebar/
-00000190: 6e6f 7465 5f73 6964 6562 6172 2e68 746d  note_sidebar.htm
-000001a0: 6c20 257d 0d0a 2020 2020 7b25 2069 6e63  l %}..    {% inc
-000001b0: 6c75 6465 206e 6f74 652f 6361 7264 2f6e  lude note/card/n
-000001c0: 6f74 655f 7479 7065 732e 6874 6d6c 2025  ote_types.html %
-000001d0: 7d0d 0a0d 0a20 2020 207b 2520 696e 6974  }....    {% init
-000001e0: 2063 6174 6567 6f72 795f 6c69 7374 203d   category_list =
-000001f0: 205b 5d20 257d 0d0a 0d0a 2020 2020 7b25   [] %}....    {%
-00000200: 2069 6620 6c65 6e28 6361 7465 676f 7279   if len(category
-00000210: 5f6c 6973 7429 203e 2030 2025 7d0d 0a20  _list) > 0 %}.. 
-00000220: 2020 203c 6469 7620 636c 6173 733d 2263     <div class="c
-00000230: 6172 6422 3e0d 0a20 2020 2020 2020 203c  ard">..        <
-00000240: 6469 7620 636c 6173 733d 226c 6973 742d  div class="list-
-00000250: 626f 7822 3e0d 0a20 2020 2020 2020 2020  box">..         
-00000260: 2020 207b 2520 666f 7220 745f 6361 7420     {% for t_cat 
-00000270: 696e 2063 6174 6567 6f72 795f 6c69 7374  in category_list
-00000280: 2025 7d0d 0a20 2020 2020 2020 2020 2020   %}..           
-00000290: 2020 2020 203c 6120 6872 6566 3d22 7b7b       <a href="{{
-000002a0: 5f73 6572 7665 725f 686f 6d65 7d7d 2f6e  _server_home}}/n
-000002b0: 6f74 652f 6772 6f75 705f 6c69 7374 3f6e  ote/group_list?n
-000002c0: 6f74 655f 6361 7465 676f 7279 3d7b 7b74  ote_category={{t
-000002d0: 5f63 6174 2e63 6f64 657d 7d22 2063 6c61  _cat.code}}" cla
-000002e0: 7373 3d22 6c69 7374 2d69 7465 6d22 3e0d  ss="list-item">.
-000002f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000300: 2020 2020 203c 6920 636c 6173 733d 2266       <i class="f
-00000310: 6120 6661 2d74 682d 6c61 7267 6522 3e3c  a fa-th-large"><
-00000320: 2f69 3e0d 0a20 2020 2020 2020 2020 2020  /i>..           
-00000330: 2020 2020 2020 2020 203c 7370 616e 3e7b           <span>{
-00000340: 7b74 5f63 6174 2e6e 616d 657d 7d3c 2f73  {t_cat.name}}</s
-00000350: 7061 6e3e 0d0a 2020 2020 2020 2020 2020  pan>..          
-00000360: 2020 2020 2020 2020 2020 3c64 6976 2063            <div c
-00000370: 6c61 7373 3d22 666c 6f61 742d 7269 6768  lass="float-righ
-00000380: 7422 3e0d 0a20 2020 2020 2020 2020 2020  t">..           
-00000390: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-000003a0: 616e 2063 6c61 7373 3d22 626f 6f6b 2d73  an class="book-s
-000003b0: 697a 652d 7370 616e 223e 7b7b 745f 6361  ize-span">{{t_ca
-000003c0: 742e 6772 6f75 705f 636f 756e 747d 7d3c  t.group_count}}<
-000003d0: 2f73 7061 6e3e 0d0a 2020 2020 2020 2020  /span>..        
-000003e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000003f0: 3c69 2063 6c61 7373 3d22 6661 2066 612d  <i class="fa fa-
-00000400: 6368 6576 726f 6e2d 7269 6768 7422 3e3c  chevron-right"><
-00000410: 2f69 3e0d 0a20 2020 2020 2020 2020 2020  /i>..           
-00000420: 2020 2020 2020 2020 203c 2f64 6976 3e0d           </div>.
-00000430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000440: 203c 2f61 3e0d 0a20 2020 2020 2020 2020   </a>..         
-00000450: 2020 207b 2520 656e 6420 257d 0d0a 2020     {% end %}..  
-00000460: 2020 2020 2020 3c2f 6469 763e 0d0a 2020        </div>..  
-00000470: 2020 3c2f 6469 763e 0d0a 2020 2020 7b25    </div>..    {%
-00000480: 2065 6e64 2025 7d0d 0a0d 0a3c 2f64 6976   end %}....</div
-00000490: 3e0d 0a0d 0a                             >....
+00000000: 7b25 2065 7874 656e 6473 2062 6173 6520  {% extends base 
+00000010: 257d 0a0a 7b25 2062 6c6f 636b 2062 6f64  %}..{% block bod
+00000020: 7920 257d 0a0a 3c64 6976 2063 6c61 7373  y %}..<div class
+00000030: 3d22 6361 7264 223e 0a20 2020 203c 6833  ="card">.    <h3
+00000040: 2063 6c61 7373 3d22 6361 7264 2d74 6974   class="card-tit
+00000050: 6c65 2062 746e 2d6c 696e 652d 6865 6967  le btn-line-heig
+00000060: 6874 223e 0a20 2020 2020 2020 203c 7370  ht">.        <sp
+00000070: 616e 3ee7 ac94 e8ae b0e5 ba94 e794 a83c  an>............<
+00000080: 2f73 7061 6e3e 0a20 2020 2020 2020 203c  /span>.        <
+00000090: 6469 7620 636c 6173 733d 2266 6c6f 6174  div class="float
+000000a0: 2d72 6967 6874 223e 0a20 2020 2020 2020  -right">.       
+000000b0: 2020 2020 203c 6120 636c 6173 733d 2262       <a class="b
+000000c0: 746e 2062 746e 2d64 6566 6175 6c74 2220  tn btn-default" 
+000000d0: 6872 6566 3d22 7b7b 5f73 6572 7665 725f  href="{{_server_
+000000e0: 686f 6d65 7d7d 2f6e 6f74 652f 6372 6561  home}}/note/crea
+000000f0: 7465 223e e696 b0e5 bbba 3c2f 613e 0a20  te">......</a>. 
+00000100: 2020 2020 2020 2020 2020 203c 6120 636c             <a cl
+00000110: 6173 733d 2262 746e 2062 746e 2d64 6566  ass="btn btn-def
+00000120: 6175 6c74 2220 6872 6566 3d22 7b7b 5f73  ault" href="{{_s
+00000130: 6572 7665 725f 686f 6d65 7d7d 2f6e 6f74  erver_home}}/not
+00000140: 652f 6772 6f75 7022 3ee7 ac94 e8ae b0e6  e/group">.......
+00000150: 9cac 3c2f 613e 0a20 2020 2020 2020 203c  ..</a>.        <
+00000160: 2f64 6976 3e0a 2020 2020 3c2f 6833 3e0a  /div>.    </h3>.
+00000170: 3c2f 6469 763e 0a0a 7b25 2069 6e63 6c75  </div>..{% inclu
+00000180: 6465 2070 6c75 6769 6e2f 6865 6164 6572  de plugin/header
+00000190: 2f70 6c75 6769 6e5f 6361 7465 676f 7279  /plugin_category
+000001a0: 2e68 746d 6c20 257d 0a0a 3c64 6976 2063  .html %}..<div c
+000001b0: 6c61 7373 3d22 6361 7264 223e 0a20 2020  lass="card">.   
+000001c0: 203c 6469 7620 636c 6173 733d 2270 6c75   <div class="plu
+000001d0: 6769 6e2d 6c69 7374 2063 6f6c 2d6d 642d  gin-list col-md-
+000001e0: 3132 223e 0a20 2020 2020 2020 207b 2520  12">.        {% 
+000001f0: 666f 7220 696e 6465 782c 206c 696e 6b20  for index, link 
+00000200: 696e 2065 6e75 6d65 7261 7465 2870 6c75  in enumerate(plu
+00000210: 6769 6e73 2920 257d 0a20 2020 2020 2020  gins) %}.       
+00000220: 2020 2020 203c 6120 636c 6173 733d 226c       <a class="l
+00000230: 6973 742d 6c69 6e6b 2220 6872 6566 3d22  ist-link" href="
+00000240: 7b7b 6c69 6e6b 2e6c 696e 6b20 2b20 6c69  {{link.link + li
+00000250: 6e6b 2e75 726c 5f71 7565 7279 7d7d 223e  nk.url_query}}">
+00000260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000270: 203c 6920 636c 6173 733d 2266 6120 7b7b   <i class="fa {{
+00000280: 6c69 6e6b 2e69 636f 6e7d 7d22 3e3c 2f69  link.icon}}"></i
+00000290: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000002a0: 2020 3c73 7061 6e3e 7b7b 6c69 6e6b 2e74    <span>{{link.t
+000002b0: 6974 6c65 7d7d 3c2f 7370 616e 3e0a 0a20  itle}}</span>.. 
+000002c0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+000002d0: 6469 7620 636c 6173 733d 2270 6c75 6769  div class="plugi
+000002e0: 6e2d 7269 6768 742d 626f 7822 3e0a 2020  n-right-box">.  
+000002f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000300: 2020 7b25 2069 6620 6c69 6e6b 2e73 697a    {% if link.siz
+00000310: 6520 213d 204e 6f6e 6520 257d 0a20 2020  e != None %}.   
+00000320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000330: 2020 2020 203c 7370 616e 2063 6c61 7373       <span class
+00000340: 3d22 706c 7567 696e 2d72 6967 6874 2d73  ="plugin-right-s
+00000350: 7061 6e22 3e7b 7b6c 696e 6b2e 7369 7a65  pan">{{link.size
+00000360: 7d7d 3c2f 7370 616e 3e0a 2020 2020 2020  }}</span>.      
+00000370: 2020 2020 2020 2020 2020 2020 2020 7b25                {%
+00000380: 2065 6e64 2025 7d0a 2020 2020 2020 2020   end %}.        
+00000390: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+000003a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000003b0: 207b 2520 6966 206c 696e 6b2e 7669 7369   {% if link.visi
+000003c0: 745f 636e 7420 213d 204e 6f6e 6520 257d  t_cnt != None %}
+000003d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000003e0: 2020 2020 2020 2020 203c 6920 636c 6173           <i clas
+000003f0: 733d 2266 6120 6661 2d65 7965 2d6f 223e  s="fa fa-eye-o">
+00000400: 3c2f 693e 0a20 2020 2020 2020 2020 2020  </i>.           
+00000410: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+00000420: 616e 2063 6c61 7373 3d22 706c 7567 696e  an class="plugin
+00000430: 2d72 6967 6874 2d73 7061 6e22 3ee7 83ad  -right-span">...
+00000440: e5ba a63a 207b 7b6c 696e 6b2e 7669 7369  ...: {{link.visi
+00000450: 745f 636e 747d 7d3c 2f73 7061 6e3e 0a20  t_cnt}}</span>. 
+00000460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000470: 2020 207b 2520 656e 6420 257d 0a0a 2020     {% end %}..  
+00000480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000490: 2020 3c69 2063 6c61 7373 3d22 6661 2066    <i class="fa f
+000004a0: 612d 6368 6576 726f 6e2d 7269 6768 7422  a-chevron-right"
+000004b0: 3e3c 2f69 3e0a 2020 2020 2020 2020 2020  ></i>.          
+000004c0: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+000004d0: 2020 2020 2020 2020 203c 2f61 3e0a 2020           </a>.  
+000004e0: 2020 2020 2020 7b25 2065 6e64 2025 7d0a        {% end %}.
+000004f0: 2020 2020 3c2f 6469 763e 0a3c 2f64 6976      </div>.</div
+00000500: 3e0a 7b25 2065 6e64 2025 7d0a            >.{% end %}.
```

### Comparing `xnote-web-0.1.0/handlers/note/component/sidebar/group_manage_sidebar.html` & `xnote-web-0.1.1/handlers/note/component/sidebar/group_manage_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/sidebar/group_sidebar.html` & `xnote-web-0.1.1/handlers/note/component/sidebar/group_sidebar.html`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,42 +1,42 @@
-{% include common/sidebar/app_index.html %}
-
-<div class="card group-option-card">
-    <div class="row">
-        <span class="btn-line-height">状态</span>
-        <div class="float-right">
-            <select data-id="{{file.id}}" value="{{file.level}}" onchange="xnote.note.changeLevel(this)">
-                <option value="1">置顶</option>
-                <option value="0">活跃</option>
-                <option value="-1">归档</option>
-            </select>
-        </div>
-    </div>
-
-    {% comment include note/component/note_orderby_select.html %}
-
-    <div class="pad5 group-detail-btn-box">
-        <a class="btn btn-default" data-id="{{file.id}}" data-note-type="{{file.type}}"
-            onclick="xnote.note.openDialogToShare(this)">分享</a>
-        <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">批量管理</a>
-        <a class="btn btn-default" onclick="xnote.note.openDialogToMoveByElement(this);" data-id="{{file.id}}">移动</a>
-    </div>
-</div>
-
-<div class="card">
-    <div class="card-title">
-        <span>简介</span>
-        <div class="float-right">
-            <a href="{{_server_home}}/note/edit?id={{file.id}}">编辑</a>
-        </div>
-    </div>
-    {% if file.content == None or file.content == "" %}
-        <p class="align-center">暂无简介</p>
-    {% else %}
-        {% try %}
-            {% import markdown %}
-            <div class="pad5 markdown-box">{% raw markdown.markdown(file.content) %}</div>
-        {% except %}
-            <div class="pad5 markdown-box">抱歉,markdown解析出错!</div>
-        {% end %}
-    {% end %}
-</div>
+{% include common/sidebar/app_index.html %}
+
+<div class="card group-option-card">
+    <div class="row">
+        <span class="btn-line-height">状态</span>
+        <div class="float-right">
+            <select data-id="{{file.id}}" value="{{file.level}}" onchange="xnote.note.changeLevel(this)">
+                <option value="1">置顶</option>
+                <option value="0">活跃</option>
+                <option value="-1">归档</option>
+            </select>
+        </div>
+    </div>
+
+    {% comment include note/component/note_orderby_select.html %}
+
+    <div class="pad5 group-detail-btn-box">
+        <a class="btn btn-default" data-id="{{file.id}}" data-note-type="{{file.type}}"
+            onclick="xnote.note.openDialogToShare(this)">分享</a>
+        <a class="btn btn-default" href="{{_server_home}}/note/management?parent_id={{file.id}}">批量管理</a>
+        <a class="btn btn-default" onclick="xnote.note.openDialogToMoveByElement(this);" data-id="{{file.id}}">移动</a>
+    </div>
+</div>
+
+<div class="card">
+    <div class="card-title">
+        <span>简介</span>
+        <div class="float-right">
+            <a href="{{_server_home}}/note/edit?id={{file.id}}">编辑</a>
+        </div>
+    </div>
+    {% if file.content == None or file.content == "" %}
+        <p class="align-center">暂无简介</p>
+    {% else %}
+        {% try %}
+            {% import markdown %}
+            <div class="pad5 markdown-box">{% raw markdown.markdown(file.content) %}</div>
+        {% except %}
+            <div class="pad5 markdown-box">抱歉,markdown解析出错!</div>
+        {% end %}
+    {% end %}
+</div>
```

### Comparing `xnote-web-0.1.0/handlers/note/component/sidebar/markdown_edit_sidebar.html` & `xnote-web-0.1.1/handlers/note/component/sidebar/markdown_edit_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/sidebar/note_sidebar.html` & `xnote-web-0.1.1/handlers/note/component/sidebar/note_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/sort/note_sort_tab.html` & `xnote-web-0.1.1/handlers/note/component/sort/note_sort_tab.html`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,20 +1,20 @@
-<!-- {#
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-07-13 20:18:28
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-02 13:19:18
-@FilePath     : /xnote/handlers/note/component/sort/note_sort_tab.html
-@Description  : 描述
- #} -->
-
-
-{% init orderby = "name_asc" %}
-<div class="row">
-    <div class="x-tab-box" data-tab-default="{{orderby}}" data-tab-key="orderby">
-        <a class="x-tab" data-tab-value="name_asc">名称排序</a>
-        <a class="x-tab" data-tab-value="hot_desc">热门</a>
-        <a class="x-tab" data-tab-value="size_desc">大小</a>
-        <a class="x-tab" data-tab-value="ctime_desc">最新</a>
-    </div>
+<!-- {#
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-07-13 20:18:28
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-02 13:19:18
+@FilePath     : /xnote/handlers/note/component/sort/note_sort_tab.html
+@Description  : 描述
+ #} -->
+
+
+{% init orderby = "name_asc" %}
+<div class="row">
+    <div class="x-tab-box" data-tab-default="{{orderby}}" data-tab-key="orderby">
+        <a class="x-tab" data-tab-value="name_asc">名称排序</a>
+        <a class="x-tab" data-tab-value="hot_desc">热门</a>
+        <a class="x-tab" data-tab-value="size_desc">大小</a>
+        <a class="x-tab" data-tab-value="ctime_desc">最新</a>
+    </div>
 </div>
```

### Comparing `xnote-web-0.1.0/handlers/note/component/timeline/timeline_body.html` & `xnote-web-0.1.1/handlers/note/component/timeline/timeline_body.html`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,159 +1,159 @@
-{% init key = "" %}
-{% init show_orderby = False %}
-{% init url_type = "timeline" %}
-{% init parent_id = 0 %}
-{% init type = "default" %}
-
-<script src="/static/lib/vue/vue-2.2.6.min.js"></script>
-
-{% if show_orderby %}
-<div class="card">
-  <!-- 排序功能 -->
-  {% include note/component/sort/note_sort_tab.html %}
-</div>
-
-{% include note/component/filter/note_tag_filter.html %}
-{% end %}
-
-<div id="app" class="content card">
-  <div class="note-timeline-body">
-    <article v-if="itemList.length == 0">
-      {% include common/text/empty_text.html %}
-    </article>
-
-    <article class="row" v-for="item in itemList">
-      <h3 class="card-title-2">{{!item.title}}</h3>
-      <section v-for="file in item.files">
-        <span class="point-time point-green"></span>
-        <time datetime="">
-          <span>{{!item.ctime}}</span>
-        </time>
-        <aside>
-          <p class="things">
-            <!-- <input type="checkbox" class="icon-check" v-if="file.type == 'gallery'"/> -->
-            <i class="fa" v-bind:class="file.icon"></i>
-            <a v-bind:href="file.url">{{!file.name}}</a>
-            <span class="tag lightblue" v-for="tag_info in file.tag_info_list">{{!tag_info.name}}</span>
-            <span v-if="file.is_public == 1" class="tag info">分享</span>
-            <span v-if="file.type=='group' || file.type=='system'"
-              class="float-right gray-text">{{!file.children_count}}</span>
-          </p>
-          <p class="brief"><span class="text-green"></span></p>
-        </aside>
-      </section>
-    </article>
-  </div>
-</div>
-
-<header class="site-footer card">
-  <div class="wrapper">
-    {% if type != "root" %}
-    <a id="loadMore" href="javascript:void(0)">加载更多</a>
-    {% end %}
-  </div>
-</header>
-
-<script type="text/javascript">
-  // 全局变量
-  var QUERY_LIMIT = 100;
-
-  var itemList = {};
-
-  var app = new Vue({
-    el: "#app",
-    data: {
-      itemList: itemList,
-      offset: 0
-    },
-    isLoading: false
-  });
-
-  app.itemList = [];
-  app.offset = 0;
-
-  function mergeFiles(list, key, files) {
-    for (var i = 0; i < list.length; i++) {
-      var item = list[i];
-      if (item.title == key) {
-        item.files = item.files.concat(files);
-        return;
-      }
-    }
-    list.push({ title: key, files: files });
-  }
-
-  /** 加载更多笔记
-   * @param {boolean} showToast 是否展示toast信息
-   */
-  function loadMore(showToast) {
-    if (app.isLoading) {
-      return;
-    }
-
-    var param = {};
-    param.type = "{{type}}" || getUrlParam("type");
-    param.parent_id = getUrlParam("parent_id", "{{parent_id}}");
-    param.search_tag = getUrlParam("search_tag");
-    param.filter_tag = getUrlParam("tag");
-    param.key = "{{quote(key)}}";
-    param.orderby = xnote.getUrlParam("orderby", "ctime_desc");
-    param.offset = app.offset;
-    param.limit = QUERY_LIMIT;
-    param.url_type = "{{url_type}}";
-
-    var loadingNoteIndex;
-    layer.ready(function () {
-      // 等待layer的资源加载完再显示，不然样式会漂移
-      loadingNoteIndex = layer.load(2);
-    });
-
-    app.isLoading = true;
-    xnote.http.get("/note/api/timeline?_type=json", param,
-      function (resp, status) {
-        app.isLoading = false;
-        layer.close(loadingNoteIndex);
-        var data = resp.data;
-        if (data.length == 0) {
-          // alert("没有更多了");
-          if (showToast) {
-            layer.msg("没有更多了");
-          }
-          return;
-        }
-        var resp = data;
-        // app.itemList = [];
-        var count = 0;
-        for (var i = 0; i < data.length; i++) {
-          // console.log(key, resp[key]);
-          var item = data[i];
-          var files = item.children;
-          var title = item.title;
-          app.offset += files.length;
-          mergeFiles(app.itemList, title, files);
-          count++;
-          // app.itemList.push({title: key, files: files});
-        }
-        if (count == 0) {
-          // alert("没有更多了");
-          if (showToast) {
-            layer.msg("没有更多了");
-          }
-          return;
-        }
-      }).fail(function (error) {
-        app.isLoading = false;
-        layer.close(loadingNoteIndex);
-      });
-  }
-
-
-  $("#loadMore").on("click", function () {
-    loadMore(true);
-  })
-
-  layer.ready(function () {
-    // 等待layer资源加载
-    loadMore(false);
-  });
-
+{% init key = "" %}
+{% init show_orderby = False %}
+{% init url_type = "timeline" %}
+{% init parent_id = 0 %}
+{% init type = "default" %}
+
+<script src="/static/lib/vue/vue-2.2.6.min.js"></script>
+
+{% if show_orderby %}
+<div class="card">
+  <!-- 排序功能 -->
+  {% include note/component/sort/note_sort_tab.html %}
+</div>
+
+{% include note/component/filter/note_tag_filter.html %}
+{% end %}
+
+<div id="app" class="content card">
+  <div class="note-timeline-body">
+    <article v-if="itemList.length == 0">
+      {% include common/text/empty_text.html %}
+    </article>
+
+    <article class="row" v-for="item in itemList">
+      <h3 class="card-title-2">{{!item.title}}</h3>
+      <section v-for="file in item.files">
+        <span class="point-time point-green"></span>
+        <time datetime="">
+          <span>{{!item.ctime}}</span>
+        </time>
+        <aside>
+          <p class="things">
+            <!-- <input type="checkbox" class="icon-check" v-if="file.type == 'gallery'"/> -->
+            <i class="fa" v-bind:class="file.icon"></i>
+            <a v-bind:href="file.url">{{!file.name}}</a>
+            <span class="tag lightblue" v-for="tag_info in file.tag_info_list">{{!tag_info.name}}</span>
+            <span v-if="file.is_public == 1" class="tag info">分享</span>
+            <span v-if="file.type=='group' || file.type=='system'"
+              class="float-right gray-text">{{!file.children_count}}</span>
+          </p>
+          <p class="brief"><span class="text-green"></span></p>
+        </aside>
+      </section>
+    </article>
+  </div>
+</div>
+
+<header class="site-footer card">
+  <div class="wrapper">
+    {% if type != "root" %}
+    <a id="loadMore" href="javascript:void(0)">加载更多</a>
+    {% end %}
+  </div>
+</header>
+
+<script type="text/javascript">
+  // 全局变量
+  var QUERY_LIMIT = 100;
+
+  var itemList = {};
+
+  var app = new Vue({
+    el: "#app",
+    data: {
+      itemList: itemList,
+      offset: 0
+    },
+    isLoading: false
+  });
+
+  app.itemList = [];
+  app.offset = 0;
+
+  function mergeFiles(list, key, files) {
+    for (var i = 0; i < list.length; i++) {
+      var item = list[i];
+      if (item.title == key) {
+        item.files = item.files.concat(files);
+        return;
+      }
+    }
+    list.push({ title: key, files: files });
+  }
+
+  /** 加载更多笔记
+   * @param {boolean} showToast 是否展示toast信息
+   */
+  function loadMore(showToast) {
+    if (app.isLoading) {
+      return;
+    }
+
+    var param = {};
+    param.type = "{{type}}" || getUrlParam("type");
+    param.parent_id = getUrlParam("parent_id", "{{parent_id}}");
+    param.search_tag = getUrlParam("search_tag");
+    param.filter_tag = getUrlParam("tag");
+    param.key = "{{quote(key)}}";
+    param.orderby = xnote.getUrlParam("orderby", "ctime_desc");
+    param.offset = app.offset;
+    param.limit = QUERY_LIMIT;
+    param.url_type = "{{url_type}}";
+
+    var loadingNoteIndex;
+    layer.ready(function () {
+      // 等待layer的资源加载完再显示，不然样式会漂移
+      loadingNoteIndex = layer.load(2);
+    });
+
+    app.isLoading = true;
+    xnote.http.get("/note/api/timeline?_type=json", param,
+      function (resp, status) {
+        app.isLoading = false;
+        layer.close(loadingNoteIndex);
+        var data = resp.data;
+        if (data.length == 0) {
+          // alert("没有更多了");
+          if (showToast) {
+            layer.msg("没有更多了");
+          }
+          return;
+        }
+        var resp = data;
+        // app.itemList = [];
+        var count = 0;
+        for (var i = 0; i < data.length; i++) {
+          // console.log(key, resp[key]);
+          var item = data[i];
+          var files = item.children;
+          var title = item.title;
+          app.offset += files.length;
+          mergeFiles(app.itemList, title, files);
+          count++;
+          // app.itemList.push({title: key, files: files});
+        }
+        if (count == 0) {
+          // alert("没有更多了");
+          if (showToast) {
+            layer.msg("没有更多了");
+          }
+          return;
+        }
+      }).fail(function (error) {
+        app.isLoading = false;
+        layer.close(loadingNoteIndex);
+      });
+  }
+
+
+  $("#loadMore").on("click", function () {
+    loadMore(true);
+  })
+
+  layer.ready(function () {
+    // 等待layer资源加载
+    loadMore(false);
+  });
+
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/note/component/timeline/timeline_create_option.html` & `xnote-web-0.1.1/handlers/note/component/timeline/timeline_create_option.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/view_css.html` & `xnote-web-0.1.1/handlers/note/component/view_css.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/view_footer.html` & `xnote-web-0.1.1/handlers/note/component/view_footer.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/view_header.html` & `xnote-web-0.1.1/handlers/note/component/view_header.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/component/view_header_tag.html` & `xnote-web-0.1.1/handlers/note/component/view_header_tag.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/constant.py` & `xnote-web-0.1.1/handlers/note/constant.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao.py` & `xnote-web-0.1.1/handlers/note/dao.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,1999 +1,1999 @@
-# encoding=utf-8
-# Created by xupingmao on 2017/04/16
-# @modified 2022/03/16 19:07:21
-# @filename dao.py
-
-"""资料的DAO操作集合
-DAO层只做最基础的数据库交互，不做权限校验（空校验要做），业务状态检查之类的工作
-
-一些表的说明
-note_full:<note_id>              = 笔记的内容，包含一些属性（部分属性比如访问时间、访问次数不是实时更新的）
-note_index:<note_id>             = 笔记索引，不包含内容
-note_tiny:<user>:<note_id>       = 用户维度的笔记索引
-notebook:<user>:<note_id>        = 用户维度的笔记本(项目)索引
-token:<uuid>                     = 用于链接分享的令牌
-note_history:<note_id>:<version> = 笔记的历史版本
-note_comment:<note_id>:<timeseq> = 笔记的评论
-comment_index:<user>:<timeseq>   = 用户维度的评论索引
-search_history:<id>  = 用户维度的搜索历史
-note_public:<note_id>            = 公开的笔记索引
-"""
-import time
-import os
-from xnote.core import xconfig
-import xutils
-from xnote.core import xmanager
-import logging
-from xnote.core import xauth
-from xnote.core import xtables
-import pdb
-import enum
-from xutils import Storage
-from xutils import dateutil, dbutil, textutil, fsutil
-from xutils import cacheutil
-from .dao_api import NoteDao
-from . import dao_log
-from xutils.db.dbutil_helper import new_from_dict
-from xutils import lists
-from web.db import SQLLiteral
-
-def register_note_table(name, description, check_user=False, user_attr=None):
-    dbutil.register_table(name, description, category="note",
-                          check_user=check_user, user_attr=user_attr)
-    
-register_note_table("notebook", "笔记分组", check_user=True, user_attr="creator")
-register_note_table("token", "用于分享的令牌")
-
-NOTE_DAO = xutils.DAO("note")
-
-_full_db = dbutil.get_table("note_full")
-_search_history_db = dbutil.get_table("search_history")
-
-_note_history_db = dbutil.get_hash_table("note_history")
-_note_history_index_db = dbutil.get_hash_table("note_history_index")
-_public_db = dbutil.get_table("note_public")
-_token_db = dbutil.get_table("token")
-
-DB_PATH = xconfig.DB_PATH
-MAX_STICKY_SIZE = 1000
-MAX_SEARCH_SIZE = 1000
-MAX_SEARCH_KEY_LENGTH = 20
-MAX_LIST_SIZE = 1000
-DEFAULT_DATETIME = "1970-01-01 00:00:00"
-
-# 排序的枚举
-ORDER_BY_SET = set([
-    "ctime_desc", "ctime_priority", 
-    "name", "name_asc", "name_desc", "name_priority", 
-    "hot_index", "hot_desc",
-])
-
-NOTE_ICON_DICT = {
-    "group": "fa-folder",
-
-    "post": "fa-file-word-o",  # 废弃
-    "html": "fa-file-word-o",  # 废弃
-    "gallery": "fa-photo",
-    "list": "fa-list",
-    "plan": "fa-calendar-check-o",
-
-    # 表格类
-    "csv": "fa-table",  # 废弃
-    "table": "fa-table",  # 废弃
-    "form": "fa-table",  # 开发中
-}
-
-class NoteLevelEnum(enum.Enum):
-    """笔记等级"""
-    archived = -1 # 归档
-    normal = 0 # 普通
-    sticky = 1 # 置顶
-
-class NoteIndexDO(Storage):
-    def __init__(self, **kw):
-        self.id = 0
-        self.name = ""
-        self.creator = ""
-        self.creator_id = 0
-        self.type = ""
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.dtime = DEFAULT_DATETIME
-        self.parent_id = 0
-        self.size = 0
-        self.children_count = 0
-        self.version = 0
-        self.is_deleted = 0
-        self.is_public = 0
-        self.level = 0 # 等级 (-1)-归档 0-正常, 1-置顶
-        self.tag_str = ""
-        self.visit_cnt = 0
-        self.update(kw)
-
-    @staticmethod
-    def from_dict(dict_value):
-        return new_from_dict(NoteIndexDO, dict_value)
-    
-    def before_save(self, index_do):
-        # type: (NoteDO) -> None
-        tags = index_do.tags
-        if tags == None:
-            tags = []
-        self.tag_str = " ".join(tags)
-
-class NoteDO(Storage):
-    def __init__(self):
-        self.id = 0 # 笔记ID
-        self.name = ""
-        self.path = ""
-        self.creator = ""
-        self.creator_id = 0
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.atime = dateutil.format_datetime()
-        self.dtime = DEFAULT_DATETIME # 删除时间
-        self.type = "md"
-        self.category = "" # 废弃
-        self.size = 0
-        self.children_count = 0
-        self.parent_id = 0 # 默认挂在根目录下
-        self.content = ""
-        self.data = ""
-        self.is_deleted = 0 # 0-正常， 1-删除
-        self.is_public = 0  # 0-不公开, 1-公开
-        self.token = ""
-        self.priority = 0 # (-1):归档, 0-正常, 1-置顶
-        self.level = 0 # 等级 (-1):归档, 0-正常, 1-置顶
-        self.visit_cnt = 0
-        self.visited_cnt = 0
-        self.orderby = ""
-        # 热门指数
-        self.hot_index = 0
-        # 版本
-        self.version = 0
-        self.tags = []
-
-        # 假的属性
-        self.url = ""
-        self.icon = ""
-        self.show_edit = True
-        self.badge_info = ""
-        self.create_date = ""
-        self.update_date = ""
-
-    @classmethod
-    def from_dict(cls, dict_value):
-        result = NoteDO()
-        result.update(dict_value)
-        return result
-    
-    def before_save(self):
-        remove_virtual_fields(self)
-
-def remove_virtual_fields(note):
-    del_dict_key(note, "url")
-    del_dict_key(note, "icon")
-    del_dict_key(note, "show_edit")
-    del_dict_key(note, "create_date")
-    del_dict_key(note, "badge_info")
-    del_dict_key(note, "create_date")
-    del_dict_key(note, "update_date")
-    del_dict_key(note, "tag_info_list")
-
-
-def format_note_id(id):
-    return str(id)
-
-
-def format_date(date):
-    return dateutil.format_date(date)
-
-
-class NoteIndexDao:
-    db = xtables.get_table_by_name("note_index")
-
-    @classmethod
-    def insert(cls, note_do: NoteDO):
-        # type: (NoteDO) -> int
-        assert note_do.creator_id != 0
-        index_do = NoteIndexDO()
-        for key in index_do:
-            index_do[key] = note_do.get(key)
-        index_do.pop("id", None)
-        index_do.before_save(note_do)
-        return cls.db.insert(**index_do)
-    
-    @classmethod
-    def update(cls, note_do: NoteDO):
-        assert note_do.creator_id != 0
-        index_do = NoteIndexDO()
-        for key in index_do:
-            value = note_do.get(key)
-            if value != None:
-                index_do[key] = value
-        index_do.before_save(note_do)
-        note_id = int(note_do.id)
-        return cls.db.update(where=dict(id=note_id), **index_do)
-
-    @classmethod
-    def update_visit_cnt(cls, note_id=0, user_id=0, visit_cnt=0):
-        # TODO 待定中: visit_cnt是记录所有的访问量还是当前用户的访问量
-        return cls.db.update(where=dict(id=note_id, user_id=user_id), visit_cnt=visit_cnt)
-    
-    @classmethod
-    def incr_visit_cnt(cls, note_id=0):
-        if not cls.db.writable:
-            return
-        return cls.db.update(where=dict(id=note_id), visit_cnt=SQLLiteral("visit_cnt+1"))
-
-    @classmethod
-    def update_level(cls, note_id=0, level=0):
-        return cls.db.update(where=dict(id=note_id), level=level, mtime=xutils.format_datetime())
-
-    @classmethod
-    def get_by_id(cls, id=0):
-        note_id = int(id)
-        first = cls.db.select_first(where=dict(id=note_id))
-        if first != None:
-            cls.compat_old(first)
-        return first
-
-    @classmethod
-    def get_by_name(cls, creator_id=0, name=""):
-        result = cls.db.select_first(where=dict(creator_id=creator_id, name=name))
-        if result != None:
-            result = NoteIndexDO(**result)
-            cls.compat_old(result)
-        return result
-
-    @classmethod
-    def compat_old(cls, item: NoteIndexDO):
-        item.tags = item.tag_str.split()
-        item.priority = item.level
-        item.content = ""
-        item.data = ""
-        item.visited_cnt = item.visit_cnt
-        item.orderby = ""
-        item.category = ""
-        item.hot_index = item.visit_cnt
-        item.badge_info = ""
-        item.show_next = False
-        item.archived = (item.level<0)
-        item.atime = DEFAULT_DATETIME
-    
-    @classmethod
-    def fix_result(cls, result=[]):
-        for item in result:
-            cls.compat_old(item)
-            build_note_info(item)
-        return result
-    
-    @classmethod
-    def fix_single_result(cls, result):
-        if result == None:
-            return
-        cls.compat_old(result)
-        build_note_info(result)
-        return result
-
-    @classmethod
-    def get_by_id_list(cls, id_list=[]):
-        if len(id_list) == 0:
-            return []
-        int_list = []
-        for id_str in id_list:
-            int_list.append(int(id_str))
-        result = cls.db.select(where="id in $id_list", vars=dict(id_list=int_list))
-        return cls.fix_result(result)
-    
-    @classmethod
-    def list(cls, creator_id=0, parent_id=0, offset=0, limit=20, type=None, type_list=[], is_deleted=0, 
-            level=None, date=None, date_start=None, date_end=None, name_like=None, query_root=False, order="id desc"):
-        if order=="dtime_asc":
-            order = "dtime"
-        if order=="ctime_desc":
-            order = "ctime desc"
-
-        if type == "table":
-            type = None
-            type_list = ["csv", "table"]
-        
-        date_like = ""
-        where = "1=1"
-        if creator_id != 0:
-            where += " AND creator_id=$creator_id"
-        else:
-            # TODO 这里还是有问题
-            where += " AND is_public = 1"
-        if parent_id != 0 and parent_id != None:
-            where += " AND parent_id=$parent_id"
-        if query_root:
-            where += " AND parent_id=0"
-        if type != None and type != "all":
-            where += " AND type=$type"
-        if level != None:
-            where += " AND level=$level"
-        if is_deleted != None:
-            where += " AND is_deleted=$is_deleted"
-
-        if date != None:
-            date_like = date + "%"
-            where += " AND ctime LIKE $date_like"
-        if date_start != None:
-            where += " AND ctime >= $date_start"
-        if date_end != None:
-            where += " AND ctime < $date_end"
-
-        if name_like != None:
-            where += " AND name LIKE $name_like"
-        if len(type_list) > 0:
-            where += " AND type IN $type_list"
-        vars = dict(creator_id=creator_id, parent_id=parent_id, type=type, level=level, 
-                    is_deleted=is_deleted, date_like=date_like, name_like=name_like, 
-                    type_list=type_list, date_start=date_start, date_end=date_end)
-        result = cls.db.select(where=where, vars=vars, offset=offset, limit=limit, order=order)
-        return cls.fix_result(result)
-    
-    @classmethod
-    def iter_batch(cls, creator_id=0, batch_size=20):
-        where = "AND creator_id=$creator_id"
-        vars = dict(creator_id=creator_id)
-        for batch_records in cls.db.iter_batch(batch_size=batch_size, where = where, vars=vars):
-            yield batch_records
-
-    @classmethod
-    def count(cls, creator_id=0, type=None, type_list=[], level=None, is_deleted=0, parent_id=0, is_not_group=False, query_root=False):
-        if type == "table":
-            type = None
-            type_list = ["csv", "table"]
-        where = "1=1"
-        if creator_id != 0:
-            where += " AND creator_id=$creator_id"
-        if type != None and type != "all":
-            where += " AND type=$type"
-        if level != None:
-            where += " AND level=$level"
-        if is_deleted != None:
-            where += " AND is_deleted=$is_deleted"
-        if parent_id != 0:
-            where += " AND parent_id = $parent_id"
-        if is_not_group:
-            where += " AND type != $group_type"
-        if len(type_list)>0:
-            where += " AND type IN $type_list"
-        if query_root:
-            where += " AND parent_id=0"
-        
-        vars = dict(creator_id=creator_id, type=type, level=level, is_deleted=is_deleted, 
-        parent_id=parent_id, group_type="group", type_list=type_list)
-        return cls.db.count(where=where, vars=vars)
-    
-    @classmethod
-    def list_float_notes(cls, creator_id=0, offset=0, limit=20, order="id desc"):
-        """查询漂浮的笔记"""
-        where = "creator_id=$creator_id AND parent_id=0 AND type!=$group_type AND is_deleted=0"
-        vars = dict(creator_id=creator_id, group_type="group")
-        result = cls.db.select(where=where, vars=vars, offset=offset, limit=limit,order=order)
-        return cls.fix_result(result)
-    
-    @classmethod
-    def delete_by_id(cls, note_id=0):
-        return cls.db.delete(where=dict(id=note_id))
-    
-    @classmethod
-    def find_prev(cls, creator_id=0, parent_id=0, name=""):
-        where_sql = "creator_id = $creator_id AND parent_id = $parent_id AND name < $name"
-        vars = dict(creator_id=creator_id, parent_id=parent_id, name=name)
-        result = cls.db.select_first(where=where_sql, vars=vars, order="name desc", limit=1)
-        return cls.fix_single_result(result)
-    
-    @classmethod
-    def find_next(cls, creator_id=0, parent_id=0, name=""):
-        where_sql = "creator_id = $creator_id AND parent_id = $parent_id AND name > $name"
-        vars = dict(creator_id=creator_id, parent_id=parent_id, name=name)
-        result = cls.db.select_first(where=where_sql, vars=vars, order="name", limit=1)
-        return cls.fix_single_result(result)
-
-class ShareTypeEnum(enum.Enum):
-    note_public = "note_public"
-    note_to_user = "note_to_user"
-
-class ShareInfoDO(Storage):
-    def __init__(self):
-        self.ctime = dateutil.format_datetime()
-        # 分享类型 {note_public, note_to_user}
-        self.share_type = ""
-        self.target_id = 0
-        self.from_id = 0
-        self.to_id = 0
-        self.visit_cnt = 0
-
-class ShareInfoDao:
-    db = xtables.get_table_by_name("share_info")
-
-    @classmethod
-    def insert(cls, share_info: ShareInfoDO):
-        return cls.db.insert(**share_info)
-    
-    @classmethod
-    def insert_ignore(cls, share_info: ShareInfoDO):
-        share_type = share_info.share_type
-        target_id = share_info.target_id
-
-        old = cls.db.select_first(where=dict(share_type=share_type, target_id=target_id))
-        if old == None:
-            cls.insert(share_info)
-
-    @classmethod
-    def incr_visit_cnt(cls, target_id=0):
-        if not cls.db.writable:
-            return
-        where = dict(target_id=target_id)
-        cls.db.update(where=where, visit_cnt=SQLLiteral("visit_cnt + 1"))
-
-    @classmethod
-    def delete_by_target(cls, share_type="", target_id=0):
-        return cls.db.delete(where=dict(share_type=share_type, target_id=target_id))
-
-    @classmethod
-    def list(cls, share_type="", offset=0, limit=20, order="id desc"):
-        where=dict(share_type=share_type)
-        result = cls.db.select(where=where, offset=offset,limit=limit,order=order)
-        return result
-    
-    @classmethod
-    def count(cls, share_type=""):
-        where=dict(share_type=share_type)
-        return cls.db.count(where=where)
-
-
-def get_root(creator=None):
-    if creator == None:
-        creator = xauth.current_name()
-
-    assert creator != None
-    root = NoteDO()
-    root.creator = creator
-    root.name = "根目录"
-    root.type = "group"
-    root.parent_id = 0
-    build_note_info(root)
-    root.url = "/note/group"
-    return root
-
-
-def is_root_id(id):
-    return id in (None, "", "0", 0)
-
-
-def get_default_group():
-    group = NoteDO()
-    group.name = "默认分组"
-    group.type = "group"
-    group.id = 0
-    group.parent_id = 0
-    build_note_info(group)
-    group.url = "/note/default"
-    return group
-
-
-def get_archived_group():
-    group = NoteDO()
-    group.name = "归档分组"
-    group.type = "group"
-    group.id = 0
-    group.parent_id = 0
-    group.content = ""
-    group.priority = 0
-    build_note_info(group)
-    group.url = "/note/archived"
-    return group
-
-def get_note_public_table():
-    return _public_db
-
-
-def batch_query_dict(id_list):
-    result = dict()
-    index_list = NoteIndexDao.get_by_id_list(id_list)
-
-    for note in index_list:
-        note_id = note.id
-        result[note_id] = note
-        build_note_info(note)
-    return result
-
-batch_query = batch_query_dict
-
-def batch_query_list(id_list):
-    result = []
-    index_list = NoteIndexDao.get_by_id_list(id_list)
-    for note in index_list:
-        build_note_info(note)
-        result.append(note)
-    return result
-
-
-def sort_by_name(notes):
-    notes.sort(key=lambda x: x.name)
-    sort_by_priority(notes)
-
-
-def sort_by_name_desc(notes):
-    notes.sort(key=lambda x: x.name, reverse=True)
-    sort_by_priority(notes)
-
-
-def sort_by_name_priority(notes):
-    sort_by_name(notes)
-    sort_by_priority(notes)
-
-
-def sort_by_mtime_desc(notes):
-    notes.sort(key=lambda x: x.mtime, reverse=True)
-
-
-def sort_by_ctime_desc(notes):
-    notes.sort(key=lambda x: x.ctime, reverse=True)
-    sort_by_priority(notes)
-
-
-def sort_by_atime_desc(notes):
-    notes.sort(key=lambda x: x.atime, reverse=True)
-
-
-def sort_by_priority(notes):
-    # 置顶笔记
-    notes.sort(key=lambda x: x.priority, reverse=True)
-
-
-def sort_by_default(notes):
-    # 先按照名称排序
-    sort_by_name(notes)
-
-    # 置顶笔记
-    sort_by_priority(notes)
-
-    # 文件夹放在前面
-    sort_by_type(notes)
-
-
-def sort_by_ctime_priority(notes):
-    # 先按照名称排序
-    sort_by_ctime_desc(notes)
-
-    # 置顶笔记
-    sort_by_priority(notes)
-
-    # 文件夹放在前面
-    sort_by_type(notes)
-
-
-def sort_by_type(notes):
-    # 文件夹放在前面
-    notes.sort(key=lambda x: 0 if x.type == "group" else 1)
-
-
-def sort_by_type_mtime_desc(notes):
-    sort_by_mtime_desc(notes)
-    sort_by_type(notes)
-
-
-def sort_by_type_ctime_desc(notes):
-    sort_by_ctime_desc(notes)
-    sort_by_type(notes)
-
-
-def sort_by_dtime_desc(notes):
-    notes.sort(key=lambda x: x.dtime, reverse=True)
-
-
-def sort_by_dtime_asc(notes):
-    notes.sort(key=lambda x: x.dtime)
-
-
-def sort_by_hot_index(notes):
-    notes.sort(key=lambda x: x.hot_index or 0, reverse=True)
-    sort_by_priority(notes)
-
-    for note in notes:
-        note.badge_info = "热度(%d)" % note.hot_index
-
-def sort_by_size_desc(notes):
-    notes.sort(key=lambda x:x.size or 0, reverse=True)
-    sort_by_priority(notes)
-    
-    for note in notes:
-        note.badge_info = "%s" % note.size
-
-SORT_FUNC_DICT = {
-    "name": sort_by_name,
-    "name_asc": sort_by_name,
-    "name_desc": sort_by_name_desc,
-    "name_priority": sort_by_name_priority,
-    "mtime_desc": sort_by_mtime_desc,
-    "ctime_desc": sort_by_ctime_desc,
-    "ctime_priority": sort_by_ctime_priority,
-    "atime_desc": sort_by_atime_desc,
-    "type_mtime_desc": sort_by_type_mtime_desc,
-    "type_ctime_desc": sort_by_type_ctime_desc,
-    "dtime_desc": sort_by_dtime_desc,
-    "dtime_asc": sort_by_dtime_asc,
-    "hot_index": sort_by_hot_index,
-    "hot_desc": sort_by_hot_index,
-    "size_desc": sort_by_size_desc,
-    "default": sort_by_default,
-}
-
-
-def sort_notes(notes, orderby="name"):
-    if orderby is None:
-        orderby = "name"
-
-    sort_func = SORT_FUNC_DICT.get(orderby, sort_by_mtime_desc)
-    build_note_list_info(notes, orderby)
-    sort_func(notes)
-
-
-def build_note_list_info(notes, orderby=None):
-    for note in notes:
-        build_note_info(note, orderby)
-
-
-def build_note_info(note, orderby=None):
-    if note is None:
-        return None
-
-    # note.url = "/note/view?id={}".format(note["id"])
-    note.url = "/note/view/{}".format(note["id"])
-
-    if note.priority is None:
-        note.priority = 0
-
-    if note.content is None:
-        note.content = ''
-
-    if note.data is None:
-        note.data = ''
-    # process icon
-    note.icon = NOTE_ICON_DICT.get(note.type, "fa-file-text-o")
-    note.id = int(note.id)
-
-    if note.type in ("list", "csv"):
-        note.show_edit = False
-
-    if note.visited_cnt is None:
-        note.visited_cnt = 0
-
-    if note.orderby is None:
-        note.orderby = "ctime_desc"
-
-    if note.hot_index is None:
-        note.hot_index = 0
-
-    if note.ctime != None:
-        note.create_date = format_date(note.ctime)
-
-    if note.mtime != None:
-        note.update_date = format_date(note.mtime)
-
-    # 处理删除时间
-    if note.is_deleted == 1 and note.dtime == None:
-        note.dtime = note.mtime
-
-    if orderby == "hot_index":
-        note.badge_info = "热度: %s" % note.hot_index
-    
-    if orderby == "mtime_desc":
-        note.badge_info = format_date(note.mtime)
-
-    if orderby == "ctime_desc":
-        note.badge_info = format_date(note.ctime)
-
-    if note.badge_info in (None, ""):
-        note.badge_info = note.create_date
-
-    if note.type == "group":
-        _build_book_default_info(note)
-
-    from . import dao_tag
-    dao_tag.handle_tag_for_note(note)
-
-    return note
-
-
-def _build_book_default_info(note):
-    if note.children_count == None:
-        note.children_count = 0
-
-
-def convert_to_path_item(note):
-    return Storage(name=note.name, url=note.url, id=note.id,
-                   type=note.type, priority=note.priority, is_public=note.is_public)
-
-
-@xutils.timeit(name="NoteDao.ListPath:leveldb", logfile=True)
-def list_path(file, limit=5):
-    assert file != None
-
-    pathlist = []
-    while file is not None:
-        pathlist.insert(0, convert_to_path_item(file))
-        file.url = "/note/%s" % file.id
-        if len(pathlist) >= limit:
-            break
-        
-        if str(file.id) == "0":
-            break
-
-        parent_id = str(file.parent_id)
-        # 处理根目录
-        if parent_id == "0":
-            if file.type != "group":
-                pathlist.insert(0, get_default_group())
-            elif file.archived:
-                pathlist.insert(0, get_archived_group())
-            pathlist.insert(0, convert_to_path_item(get_root(file.creator)))
-            break
-
-        file = get_by_id(parent_id, include_full=False)
-    return pathlist
-
-
-def get_full_by_id(id):
-    if isinstance(id, int):
-        id = str(id)
-    return _full_db.get_by_id(id)
-
-@xutils.timeit(name="NoteDao.GetById:leveldb", logfile=True)
-def get_by_id(id, include_full=True, creator=None):
-    if id == "" or id is None:
-        return None
-    id = str(id)
-    if id == "0":
-        return get_root(creator)
-
-    id_int = int(id)
-    note_index = NoteIndexDao.get_by_id(id_int)
-    if note_index != None:
-        note_index = NoteDO.from_dict(note_index)
-
-    if not include_full and note_index != None:
-        build_note_info(note_index)
-        return note_index
-
-    note = get_full_by_id(id)
-    if note != None:
-        note = NoteDO.from_dict(note)
-    
-    if note and not include_full:
-        del note.content
-        del note.data
-
-    if note != None and note_index != None:
-        note.name = note_index.name
-        note.mtime = note_index.mtime
-        note.atime = note_index.atime
-        note.size = note_index.size
-        note.tags = note_index.tags
-        note.parent_id = note_index.parent_id
-        note.visited_cnt = note_index.visit_cnt
-        note.visit_cnt = note_index.visit_cnt
-        note.hot_index = note_index.hot_index
-        note.children_count = note_index.children_count
-        note.path = note_index.path
-        note.level = note_index.level
-        note.creator_id = note_index.creator_id
-
-    build_note_info(note)
-    return note
-
-def get_by_id_creator(id, creator, db=None):
-    note = get_by_id(id, creator=creator)
-    if note and note.creator == creator:
-        return note
-    return None
-
-
-def get_by_token(token):
-    token_info = _token_db.get_by_id(token)
-    if token_info != None and token_info.type == "note":
-        return get_by_id(token_info.id)
-    return None
-
-
-def get_by_user_skey(user_name, skey):
-    return None
-
-def delete_note_skey(note):
-    # 使用的是note_index的索引,不需要处理
-    pass
-
-
-def get_or_create_note(skey, creator, creator_id=0):
-    """根据skey查询或者创建笔记
-    @param {string} skey 笔记的特殊key，用户维度唯一
-    @param {string} creator 笔记的创建者
-    @throws {exception} 创建异常
-    """
-    assert creator_id != 0
-    if skey is None or skey == "":
-        return None
-    skey = skey.replace("-", "_")
-
-    note = get_by_user_skey(creator, skey)
-    if note != None:
-        return note
-
-    # 检查笔记名称
-    check_by_name(creator, skey)
-
-    note_dict = NoteDO()
-    note_dict.name = skey
-    note_dict.skey = skey
-    note_dict.creator = creator
-    note_dict.creator_id = creator_id
-    note_dict.content = ""
-    note_dict.data = ""
-    note_dict.type = "md"
-    note_dict.sub_type = "log"
-    note_dict.parent_id = 0
-
-    note_id = create_note(note_dict)
-
-    return get_by_id(note_id)
-
-
-def create_note_base(note_dict, date_str=None, note_id=None):
-    """创建笔记的基础部分，无锁"""
-    # 真实的创建时间
-    ctime0 = dateutil.format_datetime()
-    note_dict["ctime0"] = ctime0
-    note_dict["atime"] = ctime0
-    note_dict["mtime"] = ctime0
-    note_dict["ctime"] = ctime0
-    note_dict["version"] = 1
-
-    if note_id is not None:
-        # 指定id创建笔记
-        note_dict["id"] = note_id
-        put_note_to_db(note_id, note_dict)
-        # 创建日志
-        add_create_log(note_dict)
-        return note_id
-    elif date_str is None or date_str == "":
-        # 默认创建规则
-        note_id = NoteIndexDao.insert(note_dict)
-        note_dict["id"] = note_id
-        put_note_to_db(note_id, note_dict)
-        # 创建日志
-        add_create_log(note_dict)
-        return note_id
-    else:
-        # 指定日期创建
-        date_str = date_str.replace(".", "-")
-        if date_str == dateutil.format_date():
-            # 当天创建的，保留秒级
-            timestamp = int(time.time() * 1000)
-        else:
-            timestamp = int(dateutil.parse_date_to_timestamp(date_str) * 1000)
-
-        note_dict["ctime"] = dateutil.format_datetime(timestamp/1000)
-        note_id = NoteIndexDao.insert(note_dict)
-        note_dict["id"] = note_id
-        put_note_to_db(note_id, note_dict)
-
-        # 创建日志
-        add_create_log(note_dict)
-        return note_id
-
-
-def is_not_empty(value):
-    return xutils.is_str(value) and value != ""
-
-
-def create_note(note_dict, date_str=None, note_id=None, check_name=True):
-    assert isinstance(note_dict, NoteDO)
-    assert note_dict.creator_id != 0
-    assert isinstance(note_dict.level, int)
-
-    content = note_dict.content
-    creator = note_dict.creator
-    name = note_dict.name
-    
-    # 标签去重
-    tags = note_dict.tags
-    tags = lists.get_uniq_list(tags)
-    note_dict.tags = tags
-    
-    assert is_not_empty(name), "笔记名称不能为空"
-
-    if "parent_id" not in note_dict:
-        note_dict["parent_id"] = 0
-    if "priority" not in note_dict:
-        note_dict["priority"] = 0
-    if "data" not in note_dict:
-        note_dict["data"] = ""
-
-    with dbutil.get_write_lock(name):
-        # 检查名称是否冲突
-        if check_name:
-            check_by_name(creator, name)
-
-        # 创建笔记的基础信息
-        note_id = create_note_base(note_dict, date_str, note_id)
-    
-    if content != "":
-        # 如果内部不为空，创建一个历史记录
-        add_history(note_id, note_dict.version, note_dict)
-
-    # 更新分组下面页面的数量
-    update_children_count(note_dict.parent_id)
-
-    # 创建对应的文件夹
-    if type == "gallery":
-        dirname = os.path.join(xconfig.UPLOAD_DIR, creator, str(note_id))
-        xutils.makedirs(dirname)
-
-    # 处理标签
-    if tags != None and len(tags) > 0:
-        from . import dao_tag
-        dao_tag.TagBindDao.bind_tag(user_name = creator, note_id = note_id, tags=tags)
-
-    # 最后发送创建笔记成功的消息
-    create_msg = dict(name=name, type=type, id=note_id)
-    xmanager.fire("note.add", create_msg)
-    xmanager.fire("note.create", create_msg)
-
-    return note_id
-
-
-def create_token(type, note_id=""):
-    uuid = textutil.generate_uuid()
-    token_info = Storage(type=type, id=note_id)
-    dbutil.put("token:%s" % uuid, token_info)
-    return uuid
-
-def check_and_create_default_book(user_name="", default_book_name="默认笔记本"):
-    """检查并且创建默认笔记本"""
-    assert user_name != None
-    creator_id = xauth.UserDao.get_id_by_name(user_name)
-    
-    with dbutil.get_write_lock():
-        result = NoteIndexDao.get_by_name(creator_id=creator_id, name=default_book_name)
-        if result == None:
-            default_book = NoteDO()
-            default_book.ctime = dateutil.format_datetime()
-            default_book.mtime = dateutil.format_datetime()
-            default_book.name = default_book_name
-            default_book.content = ""
-            default_book.creator = user_name
-            default_book.creator_id = creator_id
-            default_book.is_public = 0
-            default_book.type = "group"
-            default_book.priority = 1
-            default_book.children_count = 0
-            default_book.size = 0
-            default_book.is_deleted = 0
-            default_book_id = create_note(default_book, check_name=False)
-        else:
-            note_info = result
-            default_book_id = note_info.id
-            update_kw = NoteDO()
-            update_kw.type = "group"
-            update_kw.priority = 1
-            update_kw.is_public = 0
-            update_kw.children_count = 0
-            update_kw.is_deleted = 0
-            update_kw.size = 0
-
-            update_note(default_book_id, **update_kw)
-        
-        for note in list_default_notes(user_name):
-            move_note(note, default_book_id)
-    
-        return default_book_id
-
-def add_create_log(note):
-    dao_log.add_create_log(note.creator, note)
-
-
-def add_visit_log(user_name, note):
-    dao_log.add_visit_log(user_name, note)
-
-
-def put_note_to_db(note_id, note):
-    assert isinstance(note, NoteDO)
-    assert note.creator_id != 0
-    
-    creator = note.creator
-    # 增加编辑日志
-    dao_log.add_edit_log(creator, note)
-
-    # 删除不需要持久化的数据
-    remove_virtual_fields(note)
-
-    # 保存到DB
-    _full_db.put_by_id(note_id, note)
-
-    # 更新索引
-    update_index(note)
-
-def touch_note(note_id):
-    if is_root_id(note_id):
-        return
-
-    note = get_by_id(note_id)
-    if note != None:
-        note.mtime = dateutil.format_datetime()
-        update_index(note)
-
-
-def del_dict_key(dict, key):
-    if key in dict:
-        del dict[key]
-
-
-def convert_to_index(note):
-    note_index = Storage(**note)
-
-    # 删除虚拟字段
-    remove_virtual_fields(note_index)
-
-    # 删除内容字段
-    del_dict_key(note_index, 'data')
-    del_dict_key(note_index, 'content')
-
-    note_index.parent_id = str(note_index.parent_id)
-
-    return note_index
-
-
-def update_index(note):
-    """更新索引的时候也会更新用户维度的索引(note_tiny)"""
-    id = note['id']
-
-    if is_root_id(id):
-        # 根目录，不需要更新
-        return
-    NoteIndexDao.update(note)
-
-def update_note(note_id, **kw):
-    # 这里只更新基本字段，移动笔记使用 move_note
-    logging.info("update_note, note_id=%s, kw=%s", note_id, kw)
-
-    parent_id = kw.get("parent_id")
-    content = kw.get('content')
-    data = kw.get('data')
-    priority = kw.get('priority')
-    name = kw.get("name")
-    atime = kw.get("atime")
-    is_public = kw.get("is_public")
-    tags = kw.get("tags")
-    orderby = kw.get("orderby")
-    archived = kw.get("archived")
-    size = kw.get("size")
-    token = kw.get("token")
-    visited_cnt = kw.get("visited_cnt")
-    creator_id = kw.get("creator_id", 0)
-
-    note = get_by_id(note_id)
-    if note is None:
-        raise Exception("笔记不存在,id=%s" % note_id)
-    
-    if parent_id != None and parent_id != note.parent_id:
-        raise Exception(
-            "[note.dao.update_note] can not update `parent_id`, please use `note.dao.move_note`")
-
-    if content:
-        note.content = content
-    if data:
-        note.data = data
-    if priority != None:
-        note.priority = priority
-    if name:
-        note.name = name
-    if atime:
-        note.atime = atime
-
-    # 分享相关的更新
-    if is_public != None:
-        note.is_public = is_public
-    if is_public == 1:
-        note.share_time = dateutil.format_time()
-    if is_public == 0:
-        note.share_time = None
-
-    if tags != None:
-        note.tags = tags
-    if orderby != None:
-        note.orderby = orderby
-    if archived != None:
-        note.archived = archived
-    if size != None:
-        note.size = size
-    if token != None:
-        note.token = token
-    if visited_cnt != None:
-        note.visited_cnt = visited_cnt
-
-    if note.version is None:
-        note.version = 1
-
-    old_version = note.version
-    note.mtime = xutils.format_time()
-    note.version += 1
-
-    # 只修改优先级
-    if len(kw) == 1 and kw.get('priority') != None:
-        note.version = old_version
-    # 只修改名称
-    if len(kw) == 1 and kw.get('name') != None:
-        note.version = old_version
-
-    if creator_id != 0:
-        note.creator_id = creator_id
-
-    put_note_to_db(note_id, note)
-    return 1
-
-
-def move_note(note, new_parent_id):
-    # type: (NoteDO, int) -> None
-    new_parent_id = int(new_parent_id)
-
-    old_parent_id = note.parent_id
-    note.parent_id = new_parent_id
-
-    if old_parent_id == new_parent_id:
-        return
-    
-    new_parent = get_by_id(new_parent_id)
-    
-    if new_parent != None:
-        parent_path = new_parent.path or new_parent.name
-        assert parent_path != None
-        note.path = parent_path + " - " + note.name
-    
-    # 没有更新内容，只需要更新索引数据
-    note.mtime = dateutil.format_datetime()
-    update_index(note)
-
-    # 更新文件夹的容量
-    update_children_count(old_parent_id)
-    update_children_count(new_parent_id, parent_note=new_parent)
-
-def update0(note):
-    """更新基本信息，比如name、mtime、content、items、priority等,不处理parent_id更新"""
-    current = get_by_id(note.id)
-    if current is None:
-        return
-    # 更新各种字段
-    current_time = xutils.format_datetime()
-    note.version = current.version + 1
-    note.mtime = current_time
-    note.atime = current_time
-    put_note_to_db(note.id, note)
-
-
-def get_by_name(creator, name):
-    assert creator != None, "get_by_name:creator is None"
-    assert name != None, "get_by_name: name is None"
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    note = NoteIndexDao.get_by_name(creator_id=creator_id, name=name)
-    if note != None:
-        return get_by_id(note.id)
-    return None
-
-
-def check_by_name(creator, name):
-    note_by_name = get_by_name(creator, name)
-    if note_by_name != None:
-        raise Exception("笔记【%s】已存在" % name)
-
-
-def visit_note(user_name, id):
-    note = get_by_id(id)
-    if note is None:
-        return
-
-    note.atime = xutils.format_datetime()
-    # 访问的总字数
-    if note.visited_cnt is None:
-        note.visited_cnt = 0
-    note.visited_cnt += 1
-    note.visit_cnt = note.visited_cnt
-
-    # 全局访问热度
-    if note.hot_index is None:
-        note.hot_index = 0
-    note.hot_index += 1
-
-    add_visit_log(user_name, note)
-
-    # TODO 延迟更新索引
-    # update_index(note)
-    NoteIndexDao.incr_visit_cnt(note.id)
-
-def visit_public(note_id):
-    ShareInfoDao.incr_visit_cnt(target_id=note_id)
-
-def update_children_count(parent_id, db=None, parent_note=None):
-    print(f"update_children_count({parent_id})")
-
-    if is_root_id(parent_id):
-        return
-
-    if parent_note == None:
-        parent_note = get_by_id(parent_id)
-    
-    if parent_note is None:
-        return
-
-    creator_id = parent_note.creator_id
-    count = 0
-    children_items = list_by_parent(creator_id=creator_id, parent_id=parent_id)
-    
-    print(f"len(children_items)={len(children_items)}")
-
-    for child in children_items:
-        if child.type == "group":
-            count += child.children_count
-        else:
-            count += 1
-
-    parent_note.children_count = count
-    update_index(parent_note)
-
-
-def fill_parent_name(files):
-    id_list = []
-    for item in files:
-        build_note_info(item)
-        id_list.append(item.parent_id)
-
-    note_dict = batch_query_dict(id_list)
-    for item in files:
-        parent = note_dict.get(item.parent_id)
-        if parent != None:
-            item.parent_name = parent.name
-        else:
-            item.parent_name = None
-
-
-def check_group_status(status):
-    if status is None:
-        return
-    if status not in ("all", "active", "archived"):
-        raise Exception("[check_group_status] invalid status: %s" % status)
-
-
-@xutils.timeit(name="NoteDao.ListGroup:leveldb", logfile=True)
-def list_group_with_count(creator=None,
-               orderby="mtime_desc",
-               skip_archived=False,
-               status="all", **kw):
-    """查询笔记本列表"""
-
-    offset = kw.get("offset", 0)
-    limit = kw.get("limit", 1000)
-    parent_id = kw.get("parent_id")
-    category = kw.get("category")
-    tags = kw.get("tags")
-    search_name = kw.get("search_name")
-    count_total = kw.get("count_total", False)
-    count_only = kw.get("count_only", False)
-    creator_id = kw.get("creator_id", 0)
-    query_root = kw.get("query_root", False)
-
-    if creator == None and creator_id == 0:
-        raise Exception("creator和creator_id不能同时为空")
-    
-    check_group_status(status)
-    if creator_id == 0:
-        assert isinstance(creator, str)
-        creator_id = xauth.UserDao.get_id_by_name(creator)
-
-    q_tags = tags
-    if tags != None and len(tags) == 0:
-        q_tags = None
-
-    q_name = search_name
-    if q_name == "":
-        q_name = None
-
-    if q_name != None:
-        q_name = q_name.lower()
-    
-    if category == "all":
-        category = None
-
-    def filter_group_func(value):
-        # print(f"note_id={value.id}, archived={value.archived}")
-
-        if skip_archived and value.archived:
-            return False
-        
-        if q_tags != None:
-            if not isinstance(value.tags, list):
-                return False
-            if not textutil.contains_any(value.tags, q_tags):
-                return False
-
-        if q_name != None:
-            if q_name not in value.name.lower():
-                return False
-        
-        if category != None and value.category != category:
-            return False
-        
-        if status == "archived":
-            return value.archived
-
-        if status == "active":
-            return not value.archived
-
-        return True
-    
-    where_dict = dict(
-        creator_id=creator_id,
-        type="group",
-        parent_id=parent_id,
-        query_root=query_root,
-    )
-
-    notes = NoteIndexDao.list(
-        **where_dict, limit=limit)
-
-    notes = list(filter(filter_group_func, notes))
-    
-    if count_only:
-        # TODO 其他筛选条件
-        return [],len(notes)
-
-    
-    sort_notes(notes, orderby)
-    result = notes[offset:offset + limit]
-
-    if count_total:
-        if len(notes) < limit:
-            return result, len(notes)
-        return result, len(notes)
-    else:
-        return result, 0
-
-
-def list_group(*args, **kw):
-    """@deprecated 废弃的方法, 替代方法
-    - list_group_v2
-    - list_group_with_count
-    """
-    list, count = list_group_with_count(*args, **kw)
-    if kw.get("count_only") == True:
-        return count
-    if kw.get("count_total") == True:
-        return list, count
-    return list
-
-def list_group_v2(*args, **kw):
-    """查询笔记本列表"""
-    list, count = list_group_with_count(*args, **kw)
-    return list
-
-@cacheutil.kw_cache_deco(prefix="note.count_group")
-def count_group(creator, status=None, query_root=False):
-    check_group_status(status)
-    value = count_group_by_db(creator, status, query_root=query_root)
-    return value
-
-
-def count_group_by_db(creator, status=None, query_root=False):
-    if status is None:
-        creator_id = xauth.UserDao.get_id_by_name(creator)
-        return NoteIndexDao.count(creator_id=creator_id, type="group", query_root=query_root)
-
-    data, count = list_group_with_count(creator, status = status, count_only=True, query_root=query_root)
-    return count
-
-
-@xutils.timeit(name="NoteDao.ListRootGroup:leveldb", logfile=True)
-def list_root_group(creator=None, orderby="name"):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list(creator_id=creator_id, parent_id=0, type="group")
-    sort_notes(notes, orderby)
-    return notes
-
-
-def list_default_notes(creator, offset=0, limit=1000, orderby="mtime desc"):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list_float_notes(creator_id=creator_id, offset=offset, limit=limit)
-    sort_notes(notes, orderby)
-    return notes[offset:offset+limit]
-
-
-def list_public(offset, limit, orderby="ctime_desc"):
-    order="id desc"
-    if orderby == "hot":
-        order = "visit_cnt desc"
-    else:
-        order = "ctime desc"
-
-    public_notes = ShareInfoDao.list(share_type="note_public", offset=offset,limit=limit,order=order)
-    note_ids = []
-    for note in public_notes:
-        note_ids.append(note.target_id)
-
-    batch_result = batch_query_dict(note_ids)
-    
-    # print("batch_result: ", batch_result)
-
-    result = []
-    for share_info in public_notes:
-        note_info = batch_result.get(share_info.target_id)
-        if note_info == None:
-            logging.warning("笔记已删除:%s", share_info)
-        else:
-            note_info.url = "/note/view/public?id=%s" % note_info.id
-            if orderby == "hot":
-                note_info.badge_info = share_info.visit_cnt
-            else:
-                note_info.badge_info = dateutil.format_date(share_info.ctime)
-            result.append(note_info)
-    return result
-
-
-def count_public():
-    return ShareInfoDao.count(share_type="note_public")
-
-
-@xutils.timeit_deco(name="NoteDao.ListNote:leveldb", logfile=True, logargs=True)
-def list_by_parent(creator="", parent_id=None, offset=0, limit=1000,
-                   orderby="name",
-                   skip_group=False,
-                   include_public=True,
-                   *,
-                   creator_id=0,
-                   tags=None):
-    """通过父级节点ID查询笔记列表"""
-    if parent_id is None:
-        raise Exception("list_by_parent: parent_id is None")
-
-    if creator_id == 0:
-        creator_id = xauth.UserDao.get_id_by_name(creator)
-
-    # 只要一个标签匹配即可
-    q_tags = tags
-    if q_tags != None and len(q_tags) == 0:
-        q_tags = None
-
-    parent_id_int = int(parent_id)
-    parent_id = str(parent_id)
-
-    def filter_note_func(value):
-        if skip_group and value.type == "group":
-            return False
-
-        if q_tags != None:
-            if value.tags == None:
-                return False
-            if not textutil.contains_any(value.tags, q_tags):
-                return False
-        return True
-    
-    # TODO 优化其他筛选条件
-    notes = NoteIndexDao.list(parent_id=parent_id_int, offset=offset, limit=1000, creator_id=creator_id)
-    build_note_list_info(notes, orderby=orderby)
-    notes = list(filter(filter_note_func, notes))
-    if orderby == "db":
-        note = get_by_id_creator(parent_id, creator)
-        if note == None:
-            raise Exception("笔记不存在:%s" % parent_id)
-        orderby = note.orderby
-
-    sort_notes(notes, orderby)
-    return notes[offset:offset+limit]
-
-
-def list_by_date(field, creator, date, orderby="ctime desc"):
-    user = creator
-    if user is None:
-        user = "public"
-
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    files = NoteIndexDao.list(creator_id=creator_id, date=date, order=orderby)
-    fill_parent_name(files)
-    sort_notes(files, orderby)
-    return files
-
-
-@xutils.timeit(name="NoteDao.CountNote", logfile=True, logargs=True, logret=True)
-def count_by_creator(creator):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    return NoteIndexDao.count(creator_id=creator_id, is_not_group=True)
-
-
-def count_user_note(creator):
-    return count_by_creator(creator)
-
-
-def count_ungrouped(creator):
-    return count_by_parent(creator, 0)
-
-
-@xutils.timeit(name="NoteDao.CountNoteByParent", logfile=True, logargs=True, logret=True)
-def count_by_parent(creator, parent_id):
-    """统计笔记数量
-    @param {string} creator 创建者
-    @param {string|number} parent_id 父级节点ID
-    """
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    return NoteIndexDao.count(creator_id=creator_id, parent_id=parent_id)
-
-
-@xutils.timeit(name="NoteDao.CountDict", logfile=True, logargs=True, logret=True)
-def count_dict(user_name):
-    import xtables
-    return xtables.get_dict_table().count()
-
-
-@xutils.timeit(name="NoteDao.FindPrev", logfile=True)
-def find_prev_note(note, user_name):
-    assert isinstance(note, NoteDO)
-    parent_id = int(note.parent_id)
-    return NoteIndexDao.find_prev(creator_id=note.creator_id, name = note.name, parent_id=parent_id)
-
-
-@xutils.timeit(name="NoteDao.FindNext", logfile=True)
-def find_next_note(note, user_name):
-    assert isinstance(note, NoteDO)
-    parent_id = int(note.parent_id)
-    return NoteIndexDao.find_next(creator_id=note.creator_id, name = note.name, parent_id=parent_id)
-
-class NoteHistoryIndexDO(xutils.Storage):
-    def __init__(self, **kw):
-        self.note_id = 0
-        self.name = ""
-        self.version = 0
-        self.mtime = DEFAULT_DATETIME
-        self.update(kw)
-
-def add_history_index(note_id, version, new_note):
-    brief = NoteHistoryIndexDO()
-    brief.note_id = note_id
-    brief.name = new_note.get("name")
-    brief.version = version
-    brief.mtime = new_note.get("mtime")
-
-    version_str = str(version)
-    _note_history_index_db.with_user(str(note_id)).put(version_str, brief)
-
-def add_history(note_id, version, new_note):
-    # type: (int, int, dict) -> None
-    """version是新的版本"""
-    assert version != None
-
-    # 先记录索引
-    add_history_index(note_id, version, new_note)
-
-    version_str = str(version)
-    note_copy = dict(**new_note)
-    note_copy['note_id'] = note_id
-    _note_history_db.with_user(str(note_id)).put(version_str, note_copy)
-
-def list_history(note_id, limit=1000):
-    """获取笔记历史的列表"""
-    result_list = _note_history_index_db.with_user(str(note_id)).list(limit=limit, reverse = True)
-    history_list = [y for x,y in result_list]
-    history_list = sorted(
-        history_list, key=lambda x: x.mtime or "", reverse=True)
-    return history_list
-
-def delete_history(note_id, version=None):
-    pass
-
-
-def get_history(note_id, version):
-    """获取笔记历史的详情"""
-    note_id = str(note_id)
-    version_str = str(version)
-    return _note_history_db.with_user(note_id).get(version_str)
-
-
-def search_name(words, creator="", parent_id=0, orderby="hot_index", limit=1000):
-    # TODO 搜索排序使用索引
-    assert isinstance(words, list)
-
-    words = [word.lower() for word in words]
-
-    name_like = ""
-    if len(words) > 0:
-        name_like = "%" + "%".join(words) + "%"
-    
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    result = NoteIndexDao.list(creator_id=creator_id, parent_id=parent_id, limit=limit, 
-                               name_like=name_like)
-
-    # 补全信息
-    build_note_list_info(result)
-
-    # 对笔记进行排序
-    sort_notes(result, orderby)
-    sort_by_priority(result)
-    return result
-
-
-def search_content(words, creator="", orderby="hot_index", limit=1000):
-    # TODO 全文搜索排序使用索引
-    assert isinstance(words, list)
-    words = [word.lower() for word in words]
-
-    def is_match(value):
-        if value.content is None:
-            return False
-        return (value.creator == creator or value.is_public) \
-            and textutil.contains_all(value.content.lower(), words)
-
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    result = []
-
-    for index_list in NoteIndexDao.iter_batch(creator_id=creator_id, batch_size=20):
-        id_list = [str(x.id) for x in index_list]
-        batch_result = _full_db.batch_get_by_id(id_list)
-        for key in batch_result:
-            value = batch_result[key]
-            if is_match(value):
-                value.content = ""
-                value.data = ""
-                result.append(value)
-            if len(result) > limit:
-                break
-
-    # 补全信息
-    build_note_list_info(result)
-
-    # 对笔记进行排序
-    sort_notes(result, orderby)
-    return result
-
-
-def search_public(words):
-    assert isinstance(words, list)
-    words = [word.lower() for word in words]
-
-    def search_public_func(key, value):
-        if value.content is None:
-            return False
-        if not value.is_public:
-            return False
-        return textutil.contains_all(value.name.lower(), words)
-    result = _full_db.list(filter_func=search_public_func,
-                           offset=0, limit=MAX_SEARCH_SIZE)
-    notes = [build_note_info(item) for item in result]
-    sort_notes(notes)
-    return notes
-
-def count_removed(creator):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    return NoteIndexDao.count(creator_id=creator_id, is_deleted=1)
-
-
-def list_removed(creator, offset, limit, orderby="ctime desc"):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list(is_deleted=1, creator_id=creator_id, order=orderby)
-    return notes[offset: offset + limit]
-
-
-def document_filter_func(key, value):
-    return value.type in ("md", "text", "html", "post", "log", "plan") and value.is_deleted == 0
-
-
-def table_filter_func(key, value):
-    return value.type in ("csv", "table") and value.is_deleted == 0
-
-
-def get_filter_func(type, default_filter_func):
-    if type == "document" or type == "doc":
-        return document_filter_func
-    if type in ("csv", "table"):
-        return table_filter_func
-    return default_filter_func
-
-
-def list_by_type(creator, type, offset=0, limit=20, orderby="name desc", skip_archived=False):
-    """按照类型查询笔记列表
-    @param {str} creator 笔记作者
-    @param {str|None} type  笔记类型
-    @param {int} offset 下标
-    @param {int} limit 返回的最大列数
-    @param {str} orderby 排序
-    @param {bool} skip_archived 是否跳过归档笔记
-    """
-
-    assert type != None, "note.dao.list_by_type: type is None"
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list(creator_id=creator_id, offset=offset, limit=limit, type=type, order=orderby)
-    sort_notes(notes, orderby)
-    return notes
-
-
-def count_by_type(creator, type):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    return NoteIndexDao.count(creator_id=creator_id, type=type)
-
-
-def count_sticky(creator):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    return NoteIndexDao.count(creator_id=creator_id, level=1)
-
-
-
-def list_sticky(creator, offset=0, limit=1000, orderby="ctime_desc"):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list(creator_id=creator_id, level=1, offset=offset, limit=limit)
-    sort_notes(notes, orderby=orderby)
-    return notes[offset:offset+limit]
-
-
-def list_archived(creator, offset=0, limit=100):
-    creator_id = xauth.UserDao.get_id_by_name(creator)
-    notes = NoteIndexDao.list(creator_id=creator_id, level=-1)
-    sort_notes(notes)
-    return notes
-
-class SearchHistory(Storage):
-
-    def __init__(self) -> None:
-        self.user = ""
-        self.key = ""
-        self.category = "default"
-        self.cost_time = 0.0
-        self.ctime = dateutil.format_datetime()
-
-def add_search_history(user, search_key: str, category="default", cost_time=0.0):
-    if user == None:
-        user = "public"
-    
-    if len(search_key) > MAX_SEARCH_KEY_LENGTH:
-        return
-    
-    expire_search_history(user)
-    
-    value = SearchHistory()
-    value.user = user
-    value.key = search_key
-    value.category = category
-    value.cost_time = cost_time
-
-    return _search_history_db.insert(value, max_retry=100)
-
-
-def list_search_history(user, limit=1000, orderby="time_desc"):
-    if user is None or user == "":
-        return []
-    result = []
-    for value in _search_history_db.list(limit = limit, reverse=True, where = dict(user=user)):
-        if value.ctime == None:
-            value.ctime = ""
-        result.append(value)
-    
-    result.sort(key = lambda x:x.ctime, reverse = True)
-    return result
-
-
-def clear_search_history(user_name):
-    assert user_name != None
-    assert user_name != ""
-    db = _search_history_db
-    for item in db.list(where = dict(user=user_name), reverse=True, limit=1000):
-        db.delete(item)
-
-def expire_search_history(user_name, limit=1000):
-    db = _search_history_db
-    count = _search_history_db.count(where = dict(user = user_name))
-
-    if count > limit:
-        list_limit = min(20, count - limit)
-        with dbutil.get_write_lock(user_name):
-            obj_list = db.list(where = dict(user=user_name), limit = list_limit, reverse=False)
-            db.batch_delete(obj_list)
-
-
-class NoteStatDO(Storage):
-
-    def __init__(self):
-        self.total = 0
-        self.group_count = 0
-        self.doc_count = 0
-        self.gallery_count = 0
-        self.list_count = 0
-        self.table_count = 0
-        self.plan_count = 0
-        self.log_count = 0
-        self.sticky_count = 0
-        self.removed_count = 0
-        self.dict_count = 0
-        self.comment_count = 0
-        self.tag_count = 0
-        self.update_time = 0.0
-
-    def is_expired(self):
-        expire_time = 60 * 60 # 1小时
-        return time.time() - self.update_time > expire_time
-
-    @classmethod
-    def from_dict(cls, dict_value):
-        result=NoteStatDO()
-        result.update(dict_value)
-        return result
-
-@xutils.async_func_deco()
-def refresh_note_stat_async(user_name):
-    """异步刷新笔记统计"""
-    refresh_note_stat(user_name)
-
-@xutils.timeit_deco(name="NOTE_DAO:refresh_note_stat")
-def refresh_note_stat(user_name):
-    assert user_name != None, "[refresh_note_stat.assert] user_name != None"
-
-    with dbutil.get_write_lock(user_name):
-        stat = NoteStatDO()
-        if user_name is None:
-            return stat
-
-        stat.total = count_by_creator(user_name)
-        stat.group_count = count_group(user_name)
-        stat.doc_count = count_by_type(user_name, "doc")
-        stat.gallery_count = count_by_type(user_name, "gallery")
-        stat.list_count = count_by_type(user_name, "list")
-        stat.table_count = count_by_type(user_name, "table")
-        stat.plan_count = count_by_type(user_name, "plan")
-        stat.log_count = count_by_type(user_name, "log")
-        stat.sticky_count = count_sticky(user_name)
-        stat.removed_count = count_removed(user_name)
-        stat.dict_count = count_dict(user_name)
-        stat.comment_count = NoteDao.count_comment(user_name)
-        stat.tag_count = NoteDao.count_tag(user_name)
-        stat.update_time = time.time()
-
-        dbutil.put("user_stat:%s:note" % user_name, stat)
-        return stat
-
-def get_empty_note_stat():
-    stat = NoteStatDO()
-    stat.total = 0
-    stat.group_count = 0
-    return stat
-
-
-def get_note_stat(user_name):
-    if user_name == None:
-        return get_empty_note_stat()
-    stat = dbutil.get("user_stat:%s:note" % user_name)
-    if stat is None:
-        stat = refresh_note_stat(user_name)
-    else:
-        stat = NoteStatDO.from_dict(stat)
-        if stat.is_expired():
-            stat = refresh_note_stat(user_name)
-    if stat.tag_count == None:
-        stat.tag_count = 0
-    return stat
-
-
-def get_gallery_path(note):
-    from xnote.core import xconfig
-    # 新的位置, 增加一级子目录（100个，二级子目录取决于文件系统
-    # 最少的255个，最多无上限，也就是最少2.5万个相册，对于一个用户应该够用了）
-    note_id = str(note.id)
-    if len(note_id) < 2:
-        second_dir = ("00" + note_id)[-2:]
-    else:
-        second_dir = note_id[-2:]
-    standard_dir = os.path.join(
-        xconfig.UPLOAD_DIR, note.creator, "gallery", second_dir, note_id)
-    if os.path.exists(standard_dir):
-        return standard_dir
-    # TODO 归档的位置
-    # 老的位置
-    fpath = os.path.join(xconfig.UPLOAD_DIR, note.creator,
-                         str(note.parent_id), note_id)
-    if os.path.exists(fpath):
-        # 修复数据另外通过工具实现
-        return fpath
-
-    # 如果依然不存在，创建一个地址
-    fsutil.makedirs(standard_dir)
-    return standard_dir
-
-def get_virtual_group(user_name, name):
-    if name == "ungrouped":
-        creator_id = xauth.UserDao.get_id_by_name(user_name)
-        files_count = NoteIndexDao.count(creator_id=creator_id, query_root=True, is_not_group=True)
-        group = NoteDO()
-        group.name = "未分类笔记"
-        group.url = "/note/default"
-        group.size = files_count
-        group.children_count = files_count
-        group.icon = "fa-folder"
-        group.priority = 0
-        return group
-    else:
-        raise Exception("[get_virtual_group] invalid name: %s" % name)
-
-
-def check_not_empty(value, method_name):
-    if value == None or value == "":
-        raise Exception("[%s] can not be empty" % method_name)
-
-
-# write functions
-xutils.register_func("note.create", create_note)
-xutils.register_func("note.update", update_note)
-xutils.register_func("note.update0", update0)
-xutils.register_func("note.move", move_note)
-xutils.register_func("note.visit",  visit_note)
-xutils.register_func("note.touch",  touch_note)
-xutils.register_func("note.create_token", create_token)
-
-# 内部更新索引的接口，外部不要使用
-xutils.register_func("note.update_index", update_index)
-
-# query functions
-xutils.register_func("note.get_root", get_root)
-xutils.register_func("note.get_default_group", get_default_group)
-xutils.register_func("note.get_by_id", get_by_id)
-xutils.register_func("note.get_by_token", get_by_token)
-xutils.register_func("note.get_by_id_creator", get_by_id_creator)
-xutils.register_func("note.get_by_name", get_by_name)
-xutils.register_func("note.get_or_create", get_or_create_note)
-xutils.register_func("note.get_virtual_group", get_virtual_group)
-xutils.register_func("note.search_name", search_name)
-xutils.register_func("note.search_content", search_content)
-xutils.register_func("note.search_public", search_public)
-xutils.register_func("note.batch_query_list", batch_query_list)
-
-# list functions
-xutils.register_func("note.list_path", list_path)
-xutils.register_func("note.list_group", list_group)
-xutils.register_func("note.list_default_notes", list_default_notes)
-xutils.register_func("note.list_root_group", list_root_group)
-xutils.register_func("note.list_by_parent", list_by_parent)
-xutils.register_func("note.list_by_date", list_by_date)
-xutils.register_func("note.list_by_type", list_by_type)
-xutils.register_func("note.list_removed", list_removed)
-xutils.register_func("note.list_sticky",  list_sticky)
-xutils.register_func("note.list_archived", list_archived)
-xutils.register_func("note.list_public", list_public)
-
-# count functions
-xutils.register_func("note.count_public", count_public)
-xutils.register_func("note.count_recent_edit", count_user_note)
-xutils.register_func("note.count_user_note", count_user_note)
-xutils.register_func("note.count_ungrouped", count_ungrouped)
-xutils.register_func("note.count_removed", count_removed)
-xutils.register_func("note.count_by_type", count_by_type)
-xutils.register_func("note.count_by_parent",  count_by_parent)
-xutils.register_func("note.count_group", count_group)
-
-# others
-xutils.register_func("note.find_prev_note", find_prev_note)
-xutils.register_func("note.find_next_note", find_next_note)
-
-# history
-xutils.register_func("note.add_history", add_history)
-xutils.register_func("note.list_history", list_history)
-xutils.register_func("note.get_history", get_history)
-xutils.register_func("note.add_search_history", add_search_history)
-xutils.register_func("note.list_search_history", list_search_history)
-xutils.register_func("note.clear_search_history", clear_search_history)
-xutils.register_func("note.expire_search_history", expire_search_history)
-
-# stat
-xutils.register_func("note.get_note_stat", get_note_stat)
-xutils.register_func("note.get_gallery_path", get_gallery_path)
-xutils.register_func("note.refresh_note_stat_async", refresh_note_stat_async)
-
-NoteDao.get_by_id_creator = get_by_id_creator
-NoteDao.get_root = get_root
-NoteDao.batch_query_list = batch_query_list
-NoteDao.get_note_stat = get_note_stat
+# encoding=utf-8
+# Created by xupingmao on 2017/04/16
+# @modified 2022/03/16 19:07:21
+# @filename dao.py
+
+"""资料的DAO操作集合
+DAO层只做最基础的数据库交互，不做权限校验（空校验要做），业务状态检查之类的工作
+
+一些表的说明
+note_full:<note_id>              = 笔记的内容，包含一些属性（部分属性比如访问时间、访问次数不是实时更新的）
+note_index:<note_id>             = 笔记索引，不包含内容
+note_tiny:<user>:<note_id>       = 用户维度的笔记索引
+notebook:<user>:<note_id>        = 用户维度的笔记本(项目)索引
+token:<uuid>                     = 用于链接分享的令牌
+note_history:<note_id>:<version> = 笔记的历史版本
+note_comment:<note_id>:<timeseq> = 笔记的评论
+comment_index:<user>:<timeseq>   = 用户维度的评论索引
+search_history:<id>  = 用户维度的搜索历史
+note_public:<note_id>            = 公开的笔记索引
+"""
+import time
+import os
+from xnote.core import xconfig
+import xutils
+from xnote.core import xmanager
+import logging
+from xnote.core import xauth
+from xnote.core import xtables
+import pdb
+import enum
+from xutils import Storage
+from xutils import dateutil, dbutil, textutil, fsutil
+from xutils import cacheutil
+from .dao_api import NoteDao
+from . import dao_log
+from xutils.db.dbutil_helper import new_from_dict
+from xutils import lists
+from web.db import SQLLiteral
+
+def register_note_table(name, description, check_user=False, user_attr=None):
+    dbutil.register_table(name, description, category="note",
+                          check_user=check_user, user_attr=user_attr)
+    
+register_note_table("notebook", "笔记分组", check_user=True, user_attr="creator")
+register_note_table("token", "用于分享的令牌")
+
+NOTE_DAO = xutils.DAO("note")
+
+_full_db = dbutil.get_table("note_full")
+_search_history_db = dbutil.get_table("search_history")
+
+_note_history_db = dbutil.get_hash_table("note_history")
+_note_history_index_db = dbutil.get_hash_table("note_history_index")
+_public_db = dbutil.get_table("note_public")
+_token_db = dbutil.get_table("token")
+
+DB_PATH = xconfig.DB_PATH
+MAX_STICKY_SIZE = 1000
+MAX_SEARCH_SIZE = 1000
+MAX_SEARCH_KEY_LENGTH = 20
+MAX_LIST_SIZE = 1000
+DEFAULT_DATETIME = "1970-01-01 00:00:00"
+
+# 排序的枚举
+ORDER_BY_SET = set([
+    "ctime_desc", "ctime_priority", 
+    "name", "name_asc", "name_desc", "name_priority", 
+    "hot_index", "hot_desc",
+])
+
+NOTE_ICON_DICT = {
+    "group": "fa-folder",
+
+    "post": "fa-file-word-o",  # 废弃
+    "html": "fa-file-word-o",  # 废弃
+    "gallery": "fa-photo",
+    "list": "fa-list",
+    "plan": "fa-calendar-check-o",
+
+    # 表格类
+    "csv": "fa-table",  # 废弃
+    "table": "fa-table",  # 废弃
+    "form": "fa-table",  # 开发中
+}
+
+class NoteLevelEnum(enum.Enum):
+    """笔记等级"""
+    archived = -1 # 归档
+    normal = 0 # 普通
+    sticky = 1 # 置顶
+
+class NoteIndexDO(Storage):
+    def __init__(self, **kw):
+        self.id = 0
+        self.name = ""
+        self.creator = ""
+        self.creator_id = 0
+        self.type = ""
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.dtime = DEFAULT_DATETIME
+        self.parent_id = 0
+        self.size = 0
+        self.children_count = 0
+        self.version = 0
+        self.is_deleted = 0
+        self.is_public = 0
+        self.level = 0 # 等级 (-1)-归档 0-正常, 1-置顶
+        self.tag_str = ""
+        self.visit_cnt = 0
+        self.update(kw)
+
+    @staticmethod
+    def from_dict(dict_value):
+        return new_from_dict(NoteIndexDO, dict_value)
+    
+    def before_save(self, index_do):
+        # type: (NoteDO) -> None
+        tags = index_do.tags
+        if tags == None:
+            tags = []
+        self.tag_str = " ".join(tags)
+
+class NoteDO(Storage):
+    def __init__(self):
+        self.id = 0 # 笔记ID
+        self.name = ""
+        self.path = ""
+        self.creator = ""
+        self.creator_id = 0
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.atime = dateutil.format_datetime()
+        self.dtime = DEFAULT_DATETIME # 删除时间
+        self.type = "md"
+        self.category = "" # 废弃
+        self.size = 0
+        self.children_count = 0
+        self.parent_id = 0 # 默认挂在根目录下
+        self.content = ""
+        self.data = ""
+        self.is_deleted = 0 # 0-正常， 1-删除
+        self.is_public = 0  # 0-不公开, 1-公开
+        self.token = ""
+        self.priority = 0 # (-1):归档, 0-正常, 1-置顶
+        self.level = 0 # 等级 (-1):归档, 0-正常, 1-置顶
+        self.visit_cnt = 0
+        self.visited_cnt = 0
+        self.orderby = ""
+        # 热门指数
+        self.hot_index = 0
+        # 版本
+        self.version = 0
+        self.tags = []
+
+        # 假的属性
+        self.url = ""
+        self.icon = ""
+        self.show_edit = True
+        self.badge_info = ""
+        self.create_date = ""
+        self.update_date = ""
+
+    @classmethod
+    def from_dict(cls, dict_value):
+        result = NoteDO()
+        result.update(dict_value)
+        return result
+    
+    def before_save(self):
+        remove_virtual_fields(self)
+
+def remove_virtual_fields(note):
+    del_dict_key(note, "url")
+    del_dict_key(note, "icon")
+    del_dict_key(note, "show_edit")
+    del_dict_key(note, "create_date")
+    del_dict_key(note, "badge_info")
+    del_dict_key(note, "create_date")
+    del_dict_key(note, "update_date")
+    del_dict_key(note, "tag_info_list")
+
+
+def format_note_id(id):
+    return str(id)
+
+
+def format_date(date):
+    return dateutil.format_date(date)
+
+
+class NoteIndexDao:
+    db = xtables.get_table_by_name("note_index")
+
+    @classmethod
+    def insert(cls, note_do: NoteDO):
+        # type: (NoteDO) -> int
+        assert note_do.creator_id != 0
+        index_do = NoteIndexDO()
+        for key in index_do:
+            index_do[key] = note_do.get(key)
+        index_do.pop("id", None)
+        index_do.before_save(note_do)
+        return cls.db.insert(**index_do)
+    
+    @classmethod
+    def update(cls, note_do: NoteDO):
+        assert note_do.creator_id != 0
+        index_do = NoteIndexDO()
+        for key in index_do:
+            value = note_do.get(key)
+            if value != None:
+                index_do[key] = value
+        index_do.before_save(note_do)
+        note_id = int(note_do.id)
+        return cls.db.update(where=dict(id=note_id), **index_do)
+
+    @classmethod
+    def update_visit_cnt(cls, note_id=0, user_id=0, visit_cnt=0):
+        # TODO 待定中: visit_cnt是记录所有的访问量还是当前用户的访问量
+        return cls.db.update(where=dict(id=note_id, user_id=user_id), visit_cnt=visit_cnt)
+    
+    @classmethod
+    def incr_visit_cnt(cls, note_id=0):
+        if not cls.db.writable:
+            return
+        return cls.db.update(where=dict(id=note_id), visit_cnt=SQLLiteral("visit_cnt+1"))
+
+    @classmethod
+    def update_level(cls, note_id=0, level=0):
+        return cls.db.update(where=dict(id=note_id), level=level, mtime=xutils.format_datetime())
+
+    @classmethod
+    def get_by_id(cls, id=0):
+        note_id = int(id)
+        first = cls.db.select_first(where=dict(id=note_id))
+        if first != None:
+            cls.compat_old(first)
+        return first
+
+    @classmethod
+    def get_by_name(cls, creator_id=0, name=""):
+        result = cls.db.select_first(where=dict(creator_id=creator_id, name=name))
+        if result != None:
+            result = NoteIndexDO(**result)
+            cls.compat_old(result)
+        return result
+
+    @classmethod
+    def compat_old(cls, item: NoteIndexDO):
+        item.tags = item.tag_str.split()
+        item.priority = item.level
+        item.content = ""
+        item.data = ""
+        item.visited_cnt = item.visit_cnt
+        item.orderby = ""
+        item.category = ""
+        item.hot_index = item.visit_cnt
+        item.badge_info = ""
+        item.show_next = False
+        item.archived = (item.level<0)
+        item.atime = DEFAULT_DATETIME
+    
+    @classmethod
+    def fix_result(cls, result=[]):
+        for item in result:
+            cls.compat_old(item)
+            build_note_info(item)
+        return result
+    
+    @classmethod
+    def fix_single_result(cls, result):
+        if result == None:
+            return
+        cls.compat_old(result)
+        build_note_info(result)
+        return result
+
+    @classmethod
+    def get_by_id_list(cls, id_list=[]):
+        if len(id_list) == 0:
+            return []
+        int_list = []
+        for id_str in id_list:
+            int_list.append(int(id_str))
+        result = cls.db.select(where="id in $id_list", vars=dict(id_list=int_list))
+        return cls.fix_result(result)
+    
+    @classmethod
+    def list(cls, creator_id=0, parent_id=0, offset=0, limit=20, type=None, type_list=[], is_deleted=0, 
+            level=None, date=None, date_start=None, date_end=None, name_like=None, query_root=False, order="id desc"):
+        if order=="dtime_asc":
+            order = "dtime"
+        if order=="ctime_desc":
+            order = "ctime desc"
+
+        if type == "table":
+            type = None
+            type_list = ["csv", "table"]
+        
+        date_like = ""
+        where = "1=1"
+        if creator_id != 0:
+            where += " AND creator_id=$creator_id"
+        else:
+            # TODO 这里还是有问题
+            where += " AND is_public = 1"
+        if parent_id != 0 and parent_id != None:
+            where += " AND parent_id=$parent_id"
+        if query_root:
+            where += " AND parent_id=0"
+        if type != None and type != "all":
+            where += " AND type=$type"
+        if level != None:
+            where += " AND level=$level"
+        if is_deleted != None:
+            where += " AND is_deleted=$is_deleted"
+
+        if date != None:
+            date_like = date + "%"
+            where += " AND ctime LIKE $date_like"
+        if date_start != None:
+            where += " AND ctime >= $date_start"
+        if date_end != None:
+            where += " AND ctime < $date_end"
+
+        if name_like != None:
+            where += " AND name LIKE $name_like"
+        if len(type_list) > 0:
+            where += " AND type IN $type_list"
+        vars = dict(creator_id=creator_id, parent_id=parent_id, type=type, level=level, 
+                    is_deleted=is_deleted, date_like=date_like, name_like=name_like, 
+                    type_list=type_list, date_start=date_start, date_end=date_end)
+        result = cls.db.select(where=where, vars=vars, offset=offset, limit=limit, order=order)
+        return cls.fix_result(result)
+    
+    @classmethod
+    def iter_batch(cls, creator_id=0, batch_size=20):
+        where = "AND creator_id=$creator_id"
+        vars = dict(creator_id=creator_id)
+        for batch_records in cls.db.iter_batch(batch_size=batch_size, where = where, vars=vars):
+            yield batch_records
+
+    @classmethod
+    def count(cls, creator_id=0, type=None, type_list=[], level=None, is_deleted=0, parent_id=0, is_not_group=False, query_root=False):
+        if type == "table":
+            type = None
+            type_list = ["csv", "table"]
+        where = "1=1"
+        if creator_id != 0:
+            where += " AND creator_id=$creator_id"
+        if type != None and type != "all":
+            where += " AND type=$type"
+        if level != None:
+            where += " AND level=$level"
+        if is_deleted != None:
+            where += " AND is_deleted=$is_deleted"
+        if parent_id != 0:
+            where += " AND parent_id = $parent_id"
+        if is_not_group:
+            where += " AND type != $group_type"
+        if len(type_list)>0:
+            where += " AND type IN $type_list"
+        if query_root:
+            where += " AND parent_id=0"
+        
+        vars = dict(creator_id=creator_id, type=type, level=level, is_deleted=is_deleted, 
+        parent_id=parent_id, group_type="group", type_list=type_list)
+        return cls.db.count(where=where, vars=vars)
+    
+    @classmethod
+    def list_float_notes(cls, creator_id=0, offset=0, limit=20, order="id desc"):
+        """查询漂浮的笔记"""
+        where = "creator_id=$creator_id AND parent_id=0 AND type!=$group_type AND is_deleted=0"
+        vars = dict(creator_id=creator_id, group_type="group")
+        result = cls.db.select(where=where, vars=vars, offset=offset, limit=limit,order=order)
+        return cls.fix_result(result)
+    
+    @classmethod
+    def delete_by_id(cls, note_id=0):
+        return cls.db.delete(where=dict(id=note_id))
+    
+    @classmethod
+    def find_prev(cls, creator_id=0, parent_id=0, name=""):
+        where_sql = "creator_id = $creator_id AND parent_id = $parent_id AND name < $name"
+        vars = dict(creator_id=creator_id, parent_id=parent_id, name=name)
+        result = cls.db.select_first(where=where_sql, vars=vars, order="name desc", limit=1)
+        return cls.fix_single_result(result)
+    
+    @classmethod
+    def find_next(cls, creator_id=0, parent_id=0, name=""):
+        where_sql = "creator_id = $creator_id AND parent_id = $parent_id AND name > $name"
+        vars = dict(creator_id=creator_id, parent_id=parent_id, name=name)
+        result = cls.db.select_first(where=where_sql, vars=vars, order="name", limit=1)
+        return cls.fix_single_result(result)
+
+class ShareTypeEnum(enum.Enum):
+    note_public = "note_public"
+    note_to_user = "note_to_user"
+
+class ShareInfoDO(Storage):
+    def __init__(self):
+        self.ctime = dateutil.format_datetime()
+        # 分享类型 {note_public, note_to_user}
+        self.share_type = ""
+        self.target_id = 0
+        self.from_id = 0
+        self.to_id = 0
+        self.visit_cnt = 0
+
+class ShareInfoDao:
+    db = xtables.get_table_by_name("share_info")
+
+    @classmethod
+    def insert(cls, share_info: ShareInfoDO):
+        return cls.db.insert(**share_info)
+    
+    @classmethod
+    def insert_ignore(cls, share_info: ShareInfoDO):
+        share_type = share_info.share_type
+        target_id = share_info.target_id
+
+        old = cls.db.select_first(where=dict(share_type=share_type, target_id=target_id))
+        if old == None:
+            cls.insert(share_info)
+
+    @classmethod
+    def incr_visit_cnt(cls, target_id=0):
+        if not cls.db.writable:
+            return
+        where = dict(target_id=target_id)
+        cls.db.update(where=where, visit_cnt=SQLLiteral("visit_cnt + 1"))
+
+    @classmethod
+    def delete_by_target(cls, share_type="", target_id=0):
+        return cls.db.delete(where=dict(share_type=share_type, target_id=target_id))
+
+    @classmethod
+    def list(cls, share_type="", offset=0, limit=20, order="id desc"):
+        where=dict(share_type=share_type)
+        result = cls.db.select(where=where, offset=offset,limit=limit,order=order)
+        return result
+    
+    @classmethod
+    def count(cls, share_type=""):
+        where=dict(share_type=share_type)
+        return cls.db.count(where=where)
+
+
+def get_root(creator=None):
+    if creator == None:
+        creator = xauth.current_name()
+
+    assert creator != None
+    root = NoteDO()
+    root.creator = creator
+    root.name = "根目录"
+    root.type = "group"
+    root.parent_id = 0
+    build_note_info(root)
+    root.url = "/note/group"
+    return root
+
+
+def is_root_id(id):
+    return id in (None, "", "0", 0)
+
+
+def get_default_group():
+    group = NoteDO()
+    group.name = "默认分组"
+    group.type = "group"
+    group.id = 0
+    group.parent_id = 0
+    build_note_info(group)
+    group.url = "/note/default"
+    return group
+
+
+def get_archived_group():
+    group = NoteDO()
+    group.name = "归档分组"
+    group.type = "group"
+    group.id = 0
+    group.parent_id = 0
+    group.content = ""
+    group.priority = 0
+    build_note_info(group)
+    group.url = "/note/archived"
+    return group
+
+def get_note_public_table():
+    return _public_db
+
+
+def batch_query_dict(id_list):
+    result = dict()
+    index_list = NoteIndexDao.get_by_id_list(id_list)
+
+    for note in index_list:
+        note_id = note.id
+        result[note_id] = note
+        build_note_info(note)
+    return result
+
+batch_query = batch_query_dict
+
+def batch_query_list(id_list):
+    result = []
+    index_list = NoteIndexDao.get_by_id_list(id_list)
+    for note in index_list:
+        build_note_info(note)
+        result.append(note)
+    return result
+
+
+def sort_by_name(notes):
+    notes.sort(key=lambda x: x.name)
+    sort_by_priority(notes)
+
+
+def sort_by_name_desc(notes):
+    notes.sort(key=lambda x: x.name, reverse=True)
+    sort_by_priority(notes)
+
+
+def sort_by_name_priority(notes):
+    sort_by_name(notes)
+    sort_by_priority(notes)
+
+
+def sort_by_mtime_desc(notes):
+    notes.sort(key=lambda x: x.mtime, reverse=True)
+
+
+def sort_by_ctime_desc(notes):
+    notes.sort(key=lambda x: x.ctime, reverse=True)
+    sort_by_priority(notes)
+
+
+def sort_by_atime_desc(notes):
+    notes.sort(key=lambda x: x.atime, reverse=True)
+
+
+def sort_by_priority(notes):
+    # 置顶笔记
+    notes.sort(key=lambda x: x.priority, reverse=True)
+
+
+def sort_by_default(notes):
+    # 先按照名称排序
+    sort_by_name(notes)
+
+    # 置顶笔记
+    sort_by_priority(notes)
+
+    # 文件夹放在前面
+    sort_by_type(notes)
+
+
+def sort_by_ctime_priority(notes):
+    # 先按照名称排序
+    sort_by_ctime_desc(notes)
+
+    # 置顶笔记
+    sort_by_priority(notes)
+
+    # 文件夹放在前面
+    sort_by_type(notes)
+
+
+def sort_by_type(notes):
+    # 文件夹放在前面
+    notes.sort(key=lambda x: 0 if x.type == "group" else 1)
+
+
+def sort_by_type_mtime_desc(notes):
+    sort_by_mtime_desc(notes)
+    sort_by_type(notes)
+
+
+def sort_by_type_ctime_desc(notes):
+    sort_by_ctime_desc(notes)
+    sort_by_type(notes)
+
+
+def sort_by_dtime_desc(notes):
+    notes.sort(key=lambda x: x.dtime, reverse=True)
+
+
+def sort_by_dtime_asc(notes):
+    notes.sort(key=lambda x: x.dtime)
+
+
+def sort_by_hot_index(notes):
+    notes.sort(key=lambda x: x.hot_index or 0, reverse=True)
+    sort_by_priority(notes)
+
+    for note in notes:
+        note.badge_info = "热度(%d)" % note.hot_index
+
+def sort_by_size_desc(notes):
+    notes.sort(key=lambda x:x.size or 0, reverse=True)
+    sort_by_priority(notes)
+    
+    for note in notes:
+        note.badge_info = "%s" % note.size
+
+SORT_FUNC_DICT = {
+    "name": sort_by_name,
+    "name_asc": sort_by_name,
+    "name_desc": sort_by_name_desc,
+    "name_priority": sort_by_name_priority,
+    "mtime_desc": sort_by_mtime_desc,
+    "ctime_desc": sort_by_ctime_desc,
+    "ctime_priority": sort_by_ctime_priority,
+    "atime_desc": sort_by_atime_desc,
+    "type_mtime_desc": sort_by_type_mtime_desc,
+    "type_ctime_desc": sort_by_type_ctime_desc,
+    "dtime_desc": sort_by_dtime_desc,
+    "dtime_asc": sort_by_dtime_asc,
+    "hot_index": sort_by_hot_index,
+    "hot_desc": sort_by_hot_index,
+    "size_desc": sort_by_size_desc,
+    "default": sort_by_default,
+}
+
+
+def sort_notes(notes, orderby="name"):
+    if orderby is None:
+        orderby = "name"
+
+    sort_func = SORT_FUNC_DICT.get(orderby, sort_by_mtime_desc)
+    build_note_list_info(notes, orderby)
+    sort_func(notes)
+
+
+def build_note_list_info(notes, orderby=None):
+    for note in notes:
+        build_note_info(note, orderby)
+
+
+def build_note_info(note, orderby=None):
+    if note is None:
+        return None
+
+    # note.url = "/note/view?id={}".format(note["id"])
+    note.url = "/note/view/{}".format(note["id"])
+
+    if note.priority is None:
+        note.priority = 0
+
+    if note.content is None:
+        note.content = ''
+
+    if note.data is None:
+        note.data = ''
+    # process icon
+    note.icon = NOTE_ICON_DICT.get(note.type, "fa-file-text-o")
+    note.id = int(note.id)
+
+    if note.type in ("list", "csv"):
+        note.show_edit = False
+
+    if note.visited_cnt is None:
+        note.visited_cnt = 0
+
+    if note.orderby is None:
+        note.orderby = "ctime_desc"
+
+    if note.hot_index is None:
+        note.hot_index = 0
+
+    if note.ctime != None:
+        note.create_date = format_date(note.ctime)
+
+    if note.mtime != None:
+        note.update_date = format_date(note.mtime)
+
+    # 处理删除时间
+    if note.is_deleted == 1 and note.dtime == None:
+        note.dtime = note.mtime
+
+    if orderby == "hot_index":
+        note.badge_info = "热度: %s" % note.hot_index
+    
+    if orderby == "mtime_desc":
+        note.badge_info = format_date(note.mtime)
+
+    if orderby == "ctime_desc":
+        note.badge_info = format_date(note.ctime)
+
+    if note.badge_info in (None, ""):
+        note.badge_info = note.create_date
+
+    if note.type == "group":
+        _build_book_default_info(note)
+
+    from . import dao_tag
+    dao_tag.handle_tag_for_note(note)
+
+    return note
+
+
+def _build_book_default_info(note):
+    if note.children_count == None:
+        note.children_count = 0
+
+
+def convert_to_path_item(note):
+    return Storage(name=note.name, url=note.url, id=note.id,
+                   type=note.type, priority=note.priority, is_public=note.is_public)
+
+
+@xutils.timeit(name="NoteDao.ListPath:leveldb", logfile=True)
+def list_path(file, limit=5):
+    assert file != None
+
+    pathlist = []
+    while file is not None:
+        pathlist.insert(0, convert_to_path_item(file))
+        file.url = "/note/%s" % file.id
+        if len(pathlist) >= limit:
+            break
+        
+        if str(file.id) == "0":
+            break
+
+        parent_id = str(file.parent_id)
+        # 处理根目录
+        if parent_id == "0":
+            if file.type != "group":
+                pathlist.insert(0, get_default_group())
+            elif file.archived:
+                pathlist.insert(0, get_archived_group())
+            pathlist.insert(0, convert_to_path_item(get_root(file.creator)))
+            break
+
+        file = get_by_id(parent_id, include_full=False)
+    return pathlist
+
+
+def get_full_by_id(id):
+    if isinstance(id, int):
+        id = str(id)
+    return _full_db.get_by_id(id)
+
+@xutils.timeit(name="NoteDao.GetById:leveldb", logfile=True)
+def get_by_id(id, include_full=True, creator=None):
+    if id == "" or id is None:
+        return None
+    id = str(id)
+    if id == "0":
+        return get_root(creator)
+
+    id_int = int(id)
+    note_index = NoteIndexDao.get_by_id(id_int)
+    if note_index != None:
+        note_index = NoteDO.from_dict(note_index)
+
+    if not include_full and note_index != None:
+        build_note_info(note_index)
+        return note_index
+
+    note = get_full_by_id(id)
+    if note != None:
+        note = NoteDO.from_dict(note)
+    
+    if note and not include_full:
+        del note.content
+        del note.data
+
+    if note != None and note_index != None:
+        note.name = note_index.name
+        note.mtime = note_index.mtime
+        note.atime = note_index.atime
+        note.size = note_index.size
+        note.tags = note_index.tags
+        note.parent_id = note_index.parent_id
+        note.visited_cnt = note_index.visit_cnt
+        note.visit_cnt = note_index.visit_cnt
+        note.hot_index = note_index.hot_index
+        note.children_count = note_index.children_count
+        note.path = note_index.path
+        note.level = note_index.level
+        note.creator_id = note_index.creator_id
+
+    build_note_info(note)
+    return note
+
+def get_by_id_creator(id, creator, db=None):
+    note = get_by_id(id, creator=creator)
+    if note and note.creator == creator:
+        return note
+    return None
+
+
+def get_by_token(token):
+    token_info = _token_db.get_by_id(token)
+    if token_info != None and token_info.type == "note":
+        return get_by_id(token_info.id)
+    return None
+
+
+def get_by_user_skey(user_name, skey):
+    return None
+
+def delete_note_skey(note):
+    # 使用的是note_index的索引,不需要处理
+    pass
+
+
+def get_or_create_note(skey, creator, creator_id=0):
+    """根据skey查询或者创建笔记
+    @param {string} skey 笔记的特殊key，用户维度唯一
+    @param {string} creator 笔记的创建者
+    @throws {exception} 创建异常
+    """
+    assert creator_id != 0
+    if skey is None or skey == "":
+        return None
+    skey = skey.replace("-", "_")
+
+    note = get_by_user_skey(creator, skey)
+    if note != None:
+        return note
+
+    # 检查笔记名称
+    check_by_name(creator, skey)
+
+    note_dict = NoteDO()
+    note_dict.name = skey
+    note_dict.skey = skey
+    note_dict.creator = creator
+    note_dict.creator_id = creator_id
+    note_dict.content = ""
+    note_dict.data = ""
+    note_dict.type = "md"
+    note_dict.sub_type = "log"
+    note_dict.parent_id = 0
+
+    note_id = create_note(note_dict)
+
+    return get_by_id(note_id)
+
+
+def create_note_base(note_dict, date_str=None, note_id=None):
+    """创建笔记的基础部分，无锁"""
+    # 真实的创建时间
+    ctime0 = dateutil.format_datetime()
+    note_dict["ctime0"] = ctime0
+    note_dict["atime"] = ctime0
+    note_dict["mtime"] = ctime0
+    note_dict["ctime"] = ctime0
+    note_dict["version"] = 1
+
+    if note_id is not None:
+        # 指定id创建笔记
+        note_dict["id"] = note_id
+        put_note_to_db(note_id, note_dict)
+        # 创建日志
+        add_create_log(note_dict)
+        return note_id
+    elif date_str is None or date_str == "":
+        # 默认创建规则
+        note_id = NoteIndexDao.insert(note_dict)
+        note_dict["id"] = note_id
+        put_note_to_db(note_id, note_dict)
+        # 创建日志
+        add_create_log(note_dict)
+        return note_id
+    else:
+        # 指定日期创建
+        date_str = date_str.replace(".", "-")
+        if date_str == dateutil.format_date():
+            # 当天创建的，保留秒级
+            timestamp = int(time.time() * 1000)
+        else:
+            timestamp = int(dateutil.parse_date_to_timestamp(date_str) * 1000)
+
+        note_dict["ctime"] = dateutil.format_datetime(timestamp/1000)
+        note_id = NoteIndexDao.insert(note_dict)
+        note_dict["id"] = note_id
+        put_note_to_db(note_id, note_dict)
+
+        # 创建日志
+        add_create_log(note_dict)
+        return note_id
+
+
+def is_not_empty(value):
+    return xutils.is_str(value) and value != ""
+
+
+def create_note(note_dict, date_str=None, note_id=None, check_name=True):
+    assert isinstance(note_dict, NoteDO)
+    assert note_dict.creator_id != 0
+    assert isinstance(note_dict.level, int)
+
+    content = note_dict.content
+    creator = note_dict.creator
+    name = note_dict.name
+    
+    # 标签去重
+    tags = note_dict.tags
+    tags = lists.get_uniq_list(tags)
+    note_dict.tags = tags
+    
+    assert is_not_empty(name), "笔记名称不能为空"
+
+    if "parent_id" not in note_dict:
+        note_dict["parent_id"] = 0
+    if "priority" not in note_dict:
+        note_dict["priority"] = 0
+    if "data" not in note_dict:
+        note_dict["data"] = ""
+
+    with dbutil.get_write_lock(name):
+        # 检查名称是否冲突
+        if check_name:
+            check_by_name(creator, name)
+
+        # 创建笔记的基础信息
+        note_id = create_note_base(note_dict, date_str, note_id)
+    
+    if content != "":
+        # 如果内部不为空，创建一个历史记录
+        add_history(note_id, note_dict.version, note_dict)
+
+    # 更新分组下面页面的数量
+    update_children_count(note_dict.parent_id)
+
+    # 创建对应的文件夹
+    if type == "gallery":
+        dirname = os.path.join(xconfig.UPLOAD_DIR, creator, str(note_id))
+        xutils.makedirs(dirname)
+
+    # 处理标签
+    if tags != None and len(tags) > 0:
+        from . import dao_tag
+        dao_tag.TagBindDao.bind_tag(user_name = creator, note_id = note_id, tags=tags)
+
+    # 最后发送创建笔记成功的消息
+    create_msg = dict(name=name, type=type, id=note_id)
+    xmanager.fire("note.add", create_msg)
+    xmanager.fire("note.create", create_msg)
+
+    return note_id
+
+
+def create_token(type, note_id=""):
+    uuid = textutil.generate_uuid()
+    token_info = Storage(type=type, id=note_id)
+    dbutil.put("token:%s" % uuid, token_info)
+    return uuid
+
+def check_and_create_default_book(user_name="", default_book_name="默认笔记本"):
+    """检查并且创建默认笔记本"""
+    assert user_name != None
+    creator_id = xauth.UserDao.get_id_by_name(user_name)
+    
+    with dbutil.get_write_lock():
+        result = NoteIndexDao.get_by_name(creator_id=creator_id, name=default_book_name)
+        if result == None:
+            default_book = NoteDO()
+            default_book.ctime = dateutil.format_datetime()
+            default_book.mtime = dateutil.format_datetime()
+            default_book.name = default_book_name
+            default_book.content = ""
+            default_book.creator = user_name
+            default_book.creator_id = creator_id
+            default_book.is_public = 0
+            default_book.type = "group"
+            default_book.priority = 1
+            default_book.children_count = 0
+            default_book.size = 0
+            default_book.is_deleted = 0
+            default_book_id = create_note(default_book, check_name=False)
+        else:
+            note_info = result
+            default_book_id = note_info.id
+            update_kw = NoteDO()
+            update_kw.type = "group"
+            update_kw.priority = 1
+            update_kw.is_public = 0
+            update_kw.children_count = 0
+            update_kw.is_deleted = 0
+            update_kw.size = 0
+
+            update_note(default_book_id, **update_kw)
+        
+        for note in list_default_notes(user_name):
+            move_note(note, default_book_id)
+    
+        return default_book_id
+
+def add_create_log(note):
+    dao_log.add_create_log(note.creator, note)
+
+
+def add_visit_log(user_name, note):
+    dao_log.add_visit_log(user_name, note)
+
+
+def put_note_to_db(note_id, note):
+    assert isinstance(note, NoteDO)
+    assert note.creator_id != 0
+    
+    creator = note.creator
+    # 增加编辑日志
+    dao_log.add_edit_log(creator, note)
+
+    # 删除不需要持久化的数据
+    remove_virtual_fields(note)
+
+    # 保存到DB
+    _full_db.put_by_id(note_id, note)
+
+    # 更新索引
+    update_index(note)
+
+def touch_note(note_id):
+    if is_root_id(note_id):
+        return
+
+    note = get_by_id(note_id)
+    if note != None:
+        note.mtime = dateutil.format_datetime()
+        update_index(note)
+
+
+def del_dict_key(dict, key):
+    if key in dict:
+        del dict[key]
+
+
+def convert_to_index(note):
+    note_index = Storage(**note)
+
+    # 删除虚拟字段
+    remove_virtual_fields(note_index)
+
+    # 删除内容字段
+    del_dict_key(note_index, 'data')
+    del_dict_key(note_index, 'content')
+
+    note_index.parent_id = str(note_index.parent_id)
+
+    return note_index
+
+
+def update_index(note):
+    """更新索引的时候也会更新用户维度的索引(note_tiny)"""
+    id = note['id']
+
+    if is_root_id(id):
+        # 根目录，不需要更新
+        return
+    NoteIndexDao.update(note)
+
+def update_note(note_id, **kw):
+    # 这里只更新基本字段，移动笔记使用 move_note
+    logging.info("update_note, note_id=%s, kw=%s", note_id, kw)
+
+    parent_id = kw.get("parent_id")
+    content = kw.get('content')
+    data = kw.get('data')
+    priority = kw.get('priority')
+    name = kw.get("name")
+    atime = kw.get("atime")
+    is_public = kw.get("is_public")
+    tags = kw.get("tags")
+    orderby = kw.get("orderby")
+    archived = kw.get("archived")
+    size = kw.get("size")
+    token = kw.get("token")
+    visited_cnt = kw.get("visited_cnt")
+    creator_id = kw.get("creator_id", 0)
+
+    note = get_by_id(note_id)
+    if note is None:
+        raise Exception("笔记不存在,id=%s" % note_id)
+    
+    if parent_id != None and parent_id != note.parent_id:
+        raise Exception(
+            "[note.dao.update_note] can not update `parent_id`, please use `note.dao.move_note`")
+
+    if content:
+        note.content = content
+    if data:
+        note.data = data
+    if priority != None:
+        note.priority = priority
+    if name:
+        note.name = name
+    if atime:
+        note.atime = atime
+
+    # 分享相关的更新
+    if is_public != None:
+        note.is_public = is_public
+    if is_public == 1:
+        note.share_time = dateutil.format_time()
+    if is_public == 0:
+        note.share_time = None
+
+    if tags != None:
+        note.tags = tags
+    if orderby != None:
+        note.orderby = orderby
+    if archived != None:
+        note.archived = archived
+    if size != None:
+        note.size = size
+    if token != None:
+        note.token = token
+    if visited_cnt != None:
+        note.visited_cnt = visited_cnt
+
+    if note.version is None:
+        note.version = 1
+
+    old_version = note.version
+    note.mtime = xutils.format_time()
+    note.version += 1
+
+    # 只修改优先级
+    if len(kw) == 1 and kw.get('priority') != None:
+        note.version = old_version
+    # 只修改名称
+    if len(kw) == 1 and kw.get('name') != None:
+        note.version = old_version
+
+    if creator_id != 0:
+        note.creator_id = creator_id
+
+    put_note_to_db(note_id, note)
+    return 1
+
+
+def move_note(note, new_parent_id):
+    # type: (NoteDO, int) -> None
+    new_parent_id = int(new_parent_id)
+
+    old_parent_id = note.parent_id
+    note.parent_id = new_parent_id
+
+    if old_parent_id == new_parent_id:
+        return
+    
+    new_parent = get_by_id(new_parent_id)
+    
+    if new_parent != None:
+        parent_path = new_parent.path or new_parent.name
+        assert parent_path != None
+        note.path = parent_path + " - " + note.name
+    
+    # 没有更新内容，只需要更新索引数据
+    note.mtime = dateutil.format_datetime()
+    update_index(note)
+
+    # 更新文件夹的容量
+    update_children_count(old_parent_id)
+    update_children_count(new_parent_id, parent_note=new_parent)
+
+def update0(note):
+    """更新基本信息，比如name、mtime、content、items、priority等,不处理parent_id更新"""
+    current = get_by_id(note.id)
+    if current is None:
+        return
+    # 更新各种字段
+    current_time = xutils.format_datetime()
+    note.version = current.version + 1
+    note.mtime = current_time
+    note.atime = current_time
+    put_note_to_db(note.id, note)
+
+
+def get_by_name(creator, name):
+    assert creator != None, "get_by_name:creator is None"
+    assert name != None, "get_by_name: name is None"
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    note = NoteIndexDao.get_by_name(creator_id=creator_id, name=name)
+    if note != None:
+        return get_by_id(note.id)
+    return None
+
+
+def check_by_name(creator, name):
+    note_by_name = get_by_name(creator, name)
+    if note_by_name != None:
+        raise Exception("笔记【%s】已存在" % name)
+
+
+def visit_note(user_name, id):
+    note = get_by_id(id)
+    if note is None:
+        return
+
+    note.atime = xutils.format_datetime()
+    # 访问的总字数
+    if note.visited_cnt is None:
+        note.visited_cnt = 0
+    note.visited_cnt += 1
+    note.visit_cnt = note.visited_cnt
+
+    # 全局访问热度
+    if note.hot_index is None:
+        note.hot_index = 0
+    note.hot_index += 1
+
+    add_visit_log(user_name, note)
+
+    # TODO 延迟更新索引
+    # update_index(note)
+    NoteIndexDao.incr_visit_cnt(note.id)
+
+def visit_public(note_id):
+    ShareInfoDao.incr_visit_cnt(target_id=note_id)
+
+def update_children_count(parent_id, db=None, parent_note=None):
+    print(f"update_children_count({parent_id})")
+
+    if is_root_id(parent_id):
+        return
+
+    if parent_note == None:
+        parent_note = get_by_id(parent_id)
+    
+    if parent_note is None:
+        return
+
+    creator_id = parent_note.creator_id
+    count = 0
+    children_items = list_by_parent(creator_id=creator_id, parent_id=parent_id)
+    
+    print(f"len(children_items)={len(children_items)}")
+
+    for child in children_items:
+        if child.type == "group":
+            count += child.children_count
+        else:
+            count += 1
+
+    parent_note.children_count = count
+    update_index(parent_note)
+
+
+def fill_parent_name(files):
+    id_list = []
+    for item in files:
+        build_note_info(item)
+        id_list.append(item.parent_id)
+
+    note_dict = batch_query_dict(id_list)
+    for item in files:
+        parent = note_dict.get(item.parent_id)
+        if parent != None:
+            item.parent_name = parent.name
+        else:
+            item.parent_name = None
+
+
+def check_group_status(status):
+    if status is None:
+        return
+    if status not in ("all", "active", "archived"):
+        raise Exception("[check_group_status] invalid status: %s" % status)
+
+
+@xutils.timeit(name="NoteDao.ListGroup:leveldb", logfile=True)
+def list_group_with_count(creator=None,
+               orderby="mtime_desc",
+               skip_archived=False,
+               status="all", **kw):
+    """查询笔记本列表"""
+
+    offset = kw.get("offset", 0)
+    limit = kw.get("limit", 1000)
+    parent_id = kw.get("parent_id")
+    category = kw.get("category")
+    tags = kw.get("tags")
+    search_name = kw.get("search_name")
+    count_total = kw.get("count_total", False)
+    count_only = kw.get("count_only", False)
+    creator_id = kw.get("creator_id", 0)
+    query_root = kw.get("query_root", False)
+
+    if creator == None and creator_id == 0:
+        raise Exception("creator和creator_id不能同时为空")
+    
+    check_group_status(status)
+    if creator_id == 0:
+        assert isinstance(creator, str)
+        creator_id = xauth.UserDao.get_id_by_name(creator)
+
+    q_tags = tags
+    if tags != None and len(tags) == 0:
+        q_tags = None
+
+    q_name = search_name
+    if q_name == "":
+        q_name = None
+
+    if q_name != None:
+        q_name = q_name.lower()
+    
+    if category == "all":
+        category = None
+
+    def filter_group_func(value):
+        # print(f"note_id={value.id}, archived={value.archived}")
+
+        if skip_archived and value.archived:
+            return False
+        
+        if q_tags != None:
+            if not isinstance(value.tags, list):
+                return False
+            if not textutil.contains_any(value.tags, q_tags):
+                return False
+
+        if q_name != None:
+            if q_name not in value.name.lower():
+                return False
+        
+        if category != None and value.category != category:
+            return False
+        
+        if status == "archived":
+            return value.archived
+
+        if status == "active":
+            return not value.archived
+
+        return True
+    
+    where_dict = dict(
+        creator_id=creator_id,
+        type="group",
+        parent_id=parent_id,
+        query_root=query_root,
+    )
+
+    notes = NoteIndexDao.list(
+        **where_dict, limit=limit)
+
+    notes = list(filter(filter_group_func, notes))
+    
+    if count_only:
+        # TODO 其他筛选条件
+        return [],len(notes)
+
+    
+    sort_notes(notes, orderby)
+    result = notes[offset:offset + limit]
+
+    if count_total:
+        if len(notes) < limit:
+            return result, len(notes)
+        return result, len(notes)
+    else:
+        return result, 0
+
+
+def list_group(*args, **kw):
+    """@deprecated 废弃的方法, 替代方法
+    - list_group_v2
+    - list_group_with_count
+    """
+    list, count = list_group_with_count(*args, **kw)
+    if kw.get("count_only") == True:
+        return count
+    if kw.get("count_total") == True:
+        return list, count
+    return list
+
+def list_group_v2(*args, **kw):
+    """查询笔记本列表"""
+    list, count = list_group_with_count(*args, **kw)
+    return list
+
+@cacheutil.kw_cache_deco(prefix="note.count_group")
+def count_group(creator, status=None, query_root=False):
+    check_group_status(status)
+    value = count_group_by_db(creator, status, query_root=query_root)
+    return value
+
+
+def count_group_by_db(creator, status=None, query_root=False):
+    if status is None:
+        creator_id = xauth.UserDao.get_id_by_name(creator)
+        return NoteIndexDao.count(creator_id=creator_id, type="group", query_root=query_root)
+
+    data, count = list_group_with_count(creator, status = status, count_only=True, query_root=query_root)
+    return count
+
+
+@xutils.timeit(name="NoteDao.ListRootGroup:leveldb", logfile=True)
+def list_root_group(creator=None, orderby="name"):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list(creator_id=creator_id, parent_id=0, type="group")
+    sort_notes(notes, orderby)
+    return notes
+
+
+def list_default_notes(creator, offset=0, limit=1000, orderby="mtime desc"):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list_float_notes(creator_id=creator_id, offset=offset, limit=limit)
+    sort_notes(notes, orderby)
+    return notes[offset:offset+limit]
+
+
+def list_public(offset, limit, orderby="ctime_desc"):
+    order="id desc"
+    if orderby == "hot":
+        order = "visit_cnt desc"
+    else:
+        order = "ctime desc"
+
+    public_notes = ShareInfoDao.list(share_type="note_public", offset=offset,limit=limit,order=order)
+    note_ids = []
+    for note in public_notes:
+        note_ids.append(note.target_id)
+
+    batch_result = batch_query_dict(note_ids)
+    
+    # print("batch_result: ", batch_result)
+
+    result = []
+    for share_info in public_notes:
+        note_info = batch_result.get(share_info.target_id)
+        if note_info == None:
+            logging.warning("笔记已删除:%s", share_info)
+        else:
+            note_info.url = "/note/view/public?id=%s" % note_info.id
+            if orderby == "hot":
+                note_info.badge_info = share_info.visit_cnt
+            else:
+                note_info.badge_info = dateutil.format_date(share_info.ctime)
+            result.append(note_info)
+    return result
+
+
+def count_public():
+    return ShareInfoDao.count(share_type="note_public")
+
+
+@xutils.timeit_deco(name="NoteDao.ListNote:leveldb", logfile=True, logargs=True)
+def list_by_parent(creator="", parent_id=None, offset=0, limit=1000,
+                   orderby="name",
+                   skip_group=False,
+                   include_public=True,
+                   *,
+                   creator_id=0,
+                   tags=None):
+    """通过父级节点ID查询笔记列表"""
+    if parent_id is None:
+        raise Exception("list_by_parent: parent_id is None")
+
+    if creator_id == 0:
+        creator_id = xauth.UserDao.get_id_by_name(creator)
+
+    # 只要一个标签匹配即可
+    q_tags = tags
+    if q_tags != None and len(q_tags) == 0:
+        q_tags = None
+
+    parent_id_int = int(parent_id)
+    parent_id = str(parent_id)
+
+    def filter_note_func(value):
+        if skip_group and value.type == "group":
+            return False
+
+        if q_tags != None:
+            if value.tags == None:
+                return False
+            if not textutil.contains_any(value.tags, q_tags):
+                return False
+        return True
+    
+    # TODO 优化其他筛选条件
+    notes = NoteIndexDao.list(parent_id=parent_id_int, offset=offset, limit=1000, creator_id=creator_id)
+    build_note_list_info(notes, orderby=orderby)
+    notes = list(filter(filter_note_func, notes))
+    if orderby == "db":
+        note = get_by_id_creator(parent_id, creator)
+        if note == None:
+            raise Exception("笔记不存在:%s" % parent_id)
+        orderby = note.orderby
+
+    sort_notes(notes, orderby)
+    return notes[offset:offset+limit]
+
+
+def list_by_date(field, creator, date, orderby="ctime desc"):
+    user = creator
+    if user is None:
+        user = "public"
+
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    files = NoteIndexDao.list(creator_id=creator_id, date=date, order=orderby)
+    fill_parent_name(files)
+    sort_notes(files, orderby)
+    return files
+
+
+@xutils.timeit(name="NoteDao.CountNote", logfile=True, logargs=True, logret=True)
+def count_by_creator(creator):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    return NoteIndexDao.count(creator_id=creator_id, is_not_group=True)
+
+
+def count_user_note(creator):
+    return count_by_creator(creator)
+
+
+def count_ungrouped(creator):
+    return count_by_parent(creator, 0)
+
+
+@xutils.timeit(name="NoteDao.CountNoteByParent", logfile=True, logargs=True, logret=True)
+def count_by_parent(creator, parent_id):
+    """统计笔记数量
+    @param {string} creator 创建者
+    @param {string|number} parent_id 父级节点ID
+    """
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    return NoteIndexDao.count(creator_id=creator_id, parent_id=parent_id)
+
+
+@xutils.timeit(name="NoteDao.CountDict", logfile=True, logargs=True, logret=True)
+def count_dict(user_name):
+    import xtables
+    return xtables.get_dict_table().count()
+
+
+@xutils.timeit(name="NoteDao.FindPrev", logfile=True)
+def find_prev_note(note, user_name):
+    assert isinstance(note, NoteDO)
+    parent_id = int(note.parent_id)
+    return NoteIndexDao.find_prev(creator_id=note.creator_id, name = note.name, parent_id=parent_id)
+
+
+@xutils.timeit(name="NoteDao.FindNext", logfile=True)
+def find_next_note(note, user_name):
+    assert isinstance(note, NoteDO)
+    parent_id = int(note.parent_id)
+    return NoteIndexDao.find_next(creator_id=note.creator_id, name = note.name, parent_id=parent_id)
+
+class NoteHistoryIndexDO(xutils.Storage):
+    def __init__(self, **kw):
+        self.note_id = 0
+        self.name = ""
+        self.version = 0
+        self.mtime = DEFAULT_DATETIME
+        self.update(kw)
+
+def add_history_index(note_id, version, new_note):
+    brief = NoteHistoryIndexDO()
+    brief.note_id = note_id
+    brief.name = new_note.get("name")
+    brief.version = version
+    brief.mtime = new_note.get("mtime")
+
+    version_str = str(version)
+    _note_history_index_db.with_user(str(note_id)).put(version_str, brief)
+
+def add_history(note_id, version, new_note):
+    # type: (int, int, dict) -> None
+    """version是新的版本"""
+    assert version != None
+
+    # 先记录索引
+    add_history_index(note_id, version, new_note)
+
+    version_str = str(version)
+    note_copy = dict(**new_note)
+    note_copy['note_id'] = note_id
+    _note_history_db.with_user(str(note_id)).put(version_str, note_copy)
+
+def list_history(note_id, limit=1000):
+    """获取笔记历史的列表"""
+    result_list = _note_history_index_db.with_user(str(note_id)).list(limit=limit, reverse = True)
+    history_list = [y for x,y in result_list]
+    history_list = sorted(
+        history_list, key=lambda x: x.mtime or "", reverse=True)
+    return history_list
+
+def delete_history(note_id, version=None):
+    pass
+
+
+def get_history(note_id, version):
+    """获取笔记历史的详情"""
+    note_id = str(note_id)
+    version_str = str(version)
+    return _note_history_db.with_user(note_id).get(version_str)
+
+
+def search_name(words, creator="", parent_id=0, orderby="hot_index", limit=1000):
+    # TODO 搜索排序使用索引
+    assert isinstance(words, list)
+
+    words = [word.lower() for word in words]
+
+    name_like = ""
+    if len(words) > 0:
+        name_like = "%" + "%".join(words) + "%"
+    
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    result = NoteIndexDao.list(creator_id=creator_id, parent_id=parent_id, limit=limit, 
+                               name_like=name_like)
+
+    # 补全信息
+    build_note_list_info(result)
+
+    # 对笔记进行排序
+    sort_notes(result, orderby)
+    sort_by_priority(result)
+    return result
+
+
+def search_content(words, creator="", orderby="hot_index", limit=1000):
+    # TODO 全文搜索排序使用索引
+    assert isinstance(words, list)
+    words = [word.lower() for word in words]
+
+    def is_match(value):
+        if value.content is None:
+            return False
+        return (value.creator == creator or value.is_public) \
+            and textutil.contains_all(value.content.lower(), words)
+
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    result = []
+
+    for index_list in NoteIndexDao.iter_batch(creator_id=creator_id, batch_size=20):
+        id_list = [str(x.id) for x in index_list]
+        batch_result = _full_db.batch_get_by_id(id_list)
+        for key in batch_result:
+            value = batch_result[key]
+            if is_match(value):
+                value.content = ""
+                value.data = ""
+                result.append(value)
+            if len(result) > limit:
+                break
+
+    # 补全信息
+    build_note_list_info(result)
+
+    # 对笔记进行排序
+    sort_notes(result, orderby)
+    return result
+
+
+def search_public(words):
+    assert isinstance(words, list)
+    words = [word.lower() for word in words]
+
+    def search_public_func(key, value):
+        if value.content is None:
+            return False
+        if not value.is_public:
+            return False
+        return textutil.contains_all(value.name.lower(), words)
+    result = _full_db.list(filter_func=search_public_func,
+                           offset=0, limit=MAX_SEARCH_SIZE)
+    notes = [build_note_info(item) for item in result]
+    sort_notes(notes)
+    return notes
+
+def count_removed(creator):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    return NoteIndexDao.count(creator_id=creator_id, is_deleted=1)
+
+
+def list_removed(creator, offset, limit, orderby="ctime desc"):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list(is_deleted=1, creator_id=creator_id, order=orderby)
+    return notes[offset: offset + limit]
+
+
+def document_filter_func(key, value):
+    return value.type in ("md", "text", "html", "post", "log", "plan") and value.is_deleted == 0
+
+
+def table_filter_func(key, value):
+    return value.type in ("csv", "table") and value.is_deleted == 0
+
+
+def get_filter_func(type, default_filter_func):
+    if type == "document" or type == "doc":
+        return document_filter_func
+    if type in ("csv", "table"):
+        return table_filter_func
+    return default_filter_func
+
+
+def list_by_type(creator, type, offset=0, limit=20, orderby="name desc", skip_archived=False):
+    """按照类型查询笔记列表
+    @param {str} creator 笔记作者
+    @param {str|None} type  笔记类型
+    @param {int} offset 下标
+    @param {int} limit 返回的最大列数
+    @param {str} orderby 排序
+    @param {bool} skip_archived 是否跳过归档笔记
+    """
+
+    assert type != None, "note.dao.list_by_type: type is None"
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list(creator_id=creator_id, offset=offset, limit=limit, type=type, order=orderby)
+    sort_notes(notes, orderby)
+    return notes
+
+
+def count_by_type(creator, type):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    return NoteIndexDao.count(creator_id=creator_id, type=type)
+
+
+def count_sticky(creator):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    return NoteIndexDao.count(creator_id=creator_id, level=1)
+
+
+
+def list_sticky(creator, offset=0, limit=1000, orderby="ctime_desc"):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list(creator_id=creator_id, level=1, offset=offset, limit=limit)
+    sort_notes(notes, orderby=orderby)
+    return notes[offset:offset+limit]
+
+
+def list_archived(creator, offset=0, limit=100):
+    creator_id = xauth.UserDao.get_id_by_name(creator)
+    notes = NoteIndexDao.list(creator_id=creator_id, level=-1)
+    sort_notes(notes)
+    return notes
+
+class SearchHistory(Storage):
+
+    def __init__(self) -> None:
+        self.user = ""
+        self.key = ""
+        self.category = "default"
+        self.cost_time = 0.0
+        self.ctime = dateutil.format_datetime()
+
+def add_search_history(user, search_key: str, category="default", cost_time=0.0):
+    if user == None:
+        user = "public"
+    
+    if len(search_key) > MAX_SEARCH_KEY_LENGTH:
+        return
+    
+    expire_search_history(user)
+    
+    value = SearchHistory()
+    value.user = user
+    value.key = search_key
+    value.category = category
+    value.cost_time = cost_time
+
+    return _search_history_db.insert(value, max_retry=100)
+
+
+def list_search_history(user, limit=1000, orderby="time_desc"):
+    if user is None or user == "":
+        return []
+    result = []
+    for value in _search_history_db.list(limit = limit, reverse=True, where = dict(user=user)):
+        if value.ctime == None:
+            value.ctime = ""
+        result.append(value)
+    
+    result.sort(key = lambda x:x.ctime, reverse = True)
+    return result
+
+
+def clear_search_history(user_name):
+    assert user_name != None
+    assert user_name != ""
+    db = _search_history_db
+    for item in db.list(where = dict(user=user_name), reverse=True, limit=1000):
+        db.delete(item)
+
+def expire_search_history(user_name, limit=1000):
+    db = _search_history_db
+    count = _search_history_db.count(where = dict(user = user_name))
+
+    if count > limit:
+        list_limit = min(20, count - limit)
+        with dbutil.get_write_lock(user_name):
+            obj_list = db.list(where = dict(user=user_name), limit = list_limit, reverse=False)
+            db.batch_delete(obj_list)
+
+
+class NoteStatDO(Storage):
+
+    def __init__(self):
+        self.total = 0
+        self.group_count = 0
+        self.doc_count = 0
+        self.gallery_count = 0
+        self.list_count = 0
+        self.table_count = 0
+        self.plan_count = 0
+        self.log_count = 0
+        self.sticky_count = 0
+        self.removed_count = 0
+        self.dict_count = 0
+        self.comment_count = 0
+        self.tag_count = 0
+        self.update_time = 0.0
+
+    def is_expired(self):
+        expire_time = 60 * 60 # 1小时
+        return time.time() - self.update_time > expire_time
+
+    @classmethod
+    def from_dict(cls, dict_value):
+        result=NoteStatDO()
+        result.update(dict_value)
+        return result
+
+@xutils.async_func_deco()
+def refresh_note_stat_async(user_name):
+    """异步刷新笔记统计"""
+    refresh_note_stat(user_name)
+
+@xutils.timeit_deco(name="NOTE_DAO:refresh_note_stat")
+def refresh_note_stat(user_name):
+    assert user_name != None, "[refresh_note_stat.assert] user_name != None"
+
+    with dbutil.get_write_lock(user_name):
+        stat = NoteStatDO()
+        if user_name is None:
+            return stat
+
+        stat.total = count_by_creator(user_name)
+        stat.group_count = count_group(user_name)
+        stat.doc_count = count_by_type(user_name, "doc")
+        stat.gallery_count = count_by_type(user_name, "gallery")
+        stat.list_count = count_by_type(user_name, "list")
+        stat.table_count = count_by_type(user_name, "table")
+        stat.plan_count = count_by_type(user_name, "plan")
+        stat.log_count = count_by_type(user_name, "log")
+        stat.sticky_count = count_sticky(user_name)
+        stat.removed_count = count_removed(user_name)
+        stat.dict_count = count_dict(user_name)
+        stat.comment_count = NoteDao.count_comment(user_name)
+        stat.tag_count = NoteDao.count_tag(user_name)
+        stat.update_time = time.time()
+
+        dbutil.put("user_stat:%s:note" % user_name, stat)
+        return stat
+
+def get_empty_note_stat():
+    stat = NoteStatDO()
+    stat.total = 0
+    stat.group_count = 0
+    return stat
+
+
+def get_note_stat(user_name):
+    if user_name == None:
+        return get_empty_note_stat()
+    stat = dbutil.get("user_stat:%s:note" % user_name)
+    if stat is None:
+        stat = refresh_note_stat(user_name)
+    else:
+        stat = NoteStatDO.from_dict(stat)
+        if stat.is_expired():
+            stat = refresh_note_stat(user_name)
+    if stat.tag_count == None:
+        stat.tag_count = 0
+    return stat
+
+
+def get_gallery_path(note):
+    from xnote.core import xconfig
+    # 新的位置, 增加一级子目录（100个，二级子目录取决于文件系统
+    # 最少的255个，最多无上限，也就是最少2.5万个相册，对于一个用户应该够用了）
+    note_id = str(note.id)
+    if len(note_id) < 2:
+        second_dir = ("00" + note_id)[-2:]
+    else:
+        second_dir = note_id[-2:]
+    standard_dir = os.path.join(
+        xconfig.UPLOAD_DIR, note.creator, "gallery", second_dir, note_id)
+    if os.path.exists(standard_dir):
+        return standard_dir
+    # TODO 归档的位置
+    # 老的位置
+    fpath = os.path.join(xconfig.UPLOAD_DIR, note.creator,
+                         str(note.parent_id), note_id)
+    if os.path.exists(fpath):
+        # 修复数据另外通过工具实现
+        return fpath
+
+    # 如果依然不存在，创建一个地址
+    fsutil.makedirs(standard_dir)
+    return standard_dir
+
+def get_virtual_group(user_name, name):
+    if name == "ungrouped":
+        creator_id = xauth.UserDao.get_id_by_name(user_name)
+        files_count = NoteIndexDao.count(creator_id=creator_id, query_root=True, is_not_group=True)
+        group = NoteDO()
+        group.name = "未分类笔记"
+        group.url = "/note/default"
+        group.size = files_count
+        group.children_count = files_count
+        group.icon = "fa-folder"
+        group.priority = 0
+        return group
+    else:
+        raise Exception("[get_virtual_group] invalid name: %s" % name)
+
+
+def check_not_empty(value, method_name):
+    if value == None or value == "":
+        raise Exception("[%s] can not be empty" % method_name)
+
+
+# write functions
+xutils.register_func("note.create", create_note)
+xutils.register_func("note.update", update_note)
+xutils.register_func("note.update0", update0)
+xutils.register_func("note.move", move_note)
+xutils.register_func("note.visit",  visit_note)
+xutils.register_func("note.touch",  touch_note)
+xutils.register_func("note.create_token", create_token)
+
+# 内部更新索引的接口，外部不要使用
+xutils.register_func("note.update_index", update_index)
+
+# query functions
+xutils.register_func("note.get_root", get_root)
+xutils.register_func("note.get_default_group", get_default_group)
+xutils.register_func("note.get_by_id", get_by_id)
+xutils.register_func("note.get_by_token", get_by_token)
+xutils.register_func("note.get_by_id_creator", get_by_id_creator)
+xutils.register_func("note.get_by_name", get_by_name)
+xutils.register_func("note.get_or_create", get_or_create_note)
+xutils.register_func("note.get_virtual_group", get_virtual_group)
+xutils.register_func("note.search_name", search_name)
+xutils.register_func("note.search_content", search_content)
+xutils.register_func("note.search_public", search_public)
+xutils.register_func("note.batch_query_list", batch_query_list)
+
+# list functions
+xutils.register_func("note.list_path", list_path)
+xutils.register_func("note.list_group", list_group)
+xutils.register_func("note.list_default_notes", list_default_notes)
+xutils.register_func("note.list_root_group", list_root_group)
+xutils.register_func("note.list_by_parent", list_by_parent)
+xutils.register_func("note.list_by_date", list_by_date)
+xutils.register_func("note.list_by_type", list_by_type)
+xutils.register_func("note.list_removed", list_removed)
+xutils.register_func("note.list_sticky",  list_sticky)
+xutils.register_func("note.list_archived", list_archived)
+xutils.register_func("note.list_public", list_public)
+
+# count functions
+xutils.register_func("note.count_public", count_public)
+xutils.register_func("note.count_recent_edit", count_user_note)
+xutils.register_func("note.count_user_note", count_user_note)
+xutils.register_func("note.count_ungrouped", count_ungrouped)
+xutils.register_func("note.count_removed", count_removed)
+xutils.register_func("note.count_by_type", count_by_type)
+xutils.register_func("note.count_by_parent",  count_by_parent)
+xutils.register_func("note.count_group", count_group)
+
+# others
+xutils.register_func("note.find_prev_note", find_prev_note)
+xutils.register_func("note.find_next_note", find_next_note)
+
+# history
+xutils.register_func("note.add_history", add_history)
+xutils.register_func("note.list_history", list_history)
+xutils.register_func("note.get_history", get_history)
+xutils.register_func("note.add_search_history", add_search_history)
+xutils.register_func("note.list_search_history", list_search_history)
+xutils.register_func("note.clear_search_history", clear_search_history)
+xutils.register_func("note.expire_search_history", expire_search_history)
+
+# stat
+xutils.register_func("note.get_note_stat", get_note_stat)
+xutils.register_func("note.get_gallery_path", get_gallery_path)
+xutils.register_func("note.refresh_note_stat_async", refresh_note_stat_async)
+
+NoteDao.get_by_id_creator = get_by_id_creator
+NoteDao.get_root = get_root
+NoteDao.batch_query_list = batch_query_list
+NoteDao.get_note_stat = get_note_stat
```

### Comparing `xnote-web-0.1.0/handlers/note/dao_api.py` & `xnote-web-0.1.1/handlers/note/dao_api.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_book.py` & `xnote-web-0.1.1/handlers/note/dao_book.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_category.py` & `xnote-web-0.1.1/handlers/note/dao_category.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_comment.py` & `xnote-web-0.1.1/handlers/note/dao_comment.py`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,206 +1,206 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/12/04 22:07:44
-# @modified 2022/04/16 21:57:34
-# @filename dao_comment.py
-
-
-import xutils
-from xnote.core import xconfig
-from xnote.core import xmanager
-from xnote.core import xauth
-from xutils import dbutil
-from xutils import textutil
-from xutils import dateutil
-from xutils.db.dbutil_helper import PageBuilder, batch_iter
-from .dao_api import NoteDao
-from . import dao as note_dao
-from xnote.service import CommentService
-
-NOTE_DAO = xutils.DAO("note")
-
-_comment_db = dbutil.get_table("comment")
-
-comment_service = CommentService()
-
-class CommentDO(xutils.Storage):
-    def __init__(self, **kw):
-        self.user = ""
-        self.user_id = 0
-        self.note_id = 0
-        self.type = ""
-        self.content = ""
-        self.ctime = dateutil.format_datetime()
-        self.update(kw)
-
-
-class CommentDao:
-
-    valid_type_set = set(["", None, "list_item"])
-    
-    @classmethod
-    def check(cls, comment):
-        assert comment != None, "comment is None"
-        assert comment.user != None, "comment.user is None"
-        assert comment.type in cls.valid_type_set, "comment.type is invalid"
-        assert comment.note_id != None
-        assert comment.content != None
-        assert comment.content != ""
-    
-    @classmethod
-    def create(cls, comment):
-        assert isinstance(comment, CommentDO)
-        check_comment(comment)
-        comment.ctime = dateutil.format_datetime()
-        index_id = comment_service.create(type=comment.type, user_id=comment.user_id, target_id=int(comment.note_id))
-        _comment_db.update_by_id(str(index_id), comment)
-        xmanager.fire("comment.create", comment)
-        return index_id
-        
-    @classmethod
-    def update(cls, comment):
-        assert comment != None
-        assert comment.user != None
-        assert comment.note_id != None
-        comment.mtime = dateutil.format_datetime()
-
-        _comment_db.update(comment)
-        xmanager.fire("comment.update", comment)
-
-        
-    @classmethod
-    def delete_by_id(cls, comment_id):
-        comment = get_comment(comment_id)
-        if comment != None:
-            _comment_db.delete(comment)
-            xmanager.fire("comment.delete", comment)
-        comment_service.delete_by_id(int(comment_id))
-
-
-
-def list_comments_by_idx_list(idx_list, user_name=""):
-    """通过索引查询评论
-    :param {list} idx_list: 索引对象列表
-    :param {str} user_name: 用于处理删除数据的user_name, 可以不传
-    """
-    id_list = [str(item.id) for item in idx_list]
-    comment_dict = _comment_db.batch_get_by_id(id_list)
-    result = []
-    for id in id_list:
-        item = comment_dict.get(id)
-        if item != None:
-            item.id = id
-            result.append(item)
-        else:
-            item = CommentDO()
-            item.id = id
-            item.user = user_name
-            item.content = "[数据被删除]"
-            result.append(item)
-    return result
-
-def list_comments(note_id, offset=0, limit=100, user_name=""):
-    index_list = comment_service.list(target_id=int(note_id), offset=offset,limit=limit)
-    return list_comments_by_idx_list(index_list, user_name=user_name)
-
-def handle_comments_by_user(handle_type, user_name, date=None, offset=0, limit=100):
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    if handle_type == "count":
-        return comment_service.count(user_id=user_id, date=date)
-    idx_list = comment_service.list(user_id=user_id,date=date,offset=offset,limit=limit,order="ctime desc")
-    return list_comments_by_idx_list(idx_list, user_name=user_name)
-
-
-def list_comments_by_user(*args, **kw):
-    result = []
-    for value in handle_comments_by_user("list", *args, **kw):
-        result.append(value)
-    return result
-
-
-def count_comments_by_user(*args, **kw):
-    return handle_comments_by_user("count", *args, **kw)
-
-
-def get_comment(comment_id = ""):
-    """通过comment_id实际上是根据key获取comment"""
-    value = _comment_db.get_by_id(comment_id)
-    if value != None:
-        value.id = comment_id
-        return CommentDO(**value)
-    return None
-
-
-def check_comment(comment):
-    return CommentDao.check(comment)
-
-def create_comment(comment):
-    return CommentDao.create(comment)
-
-def update_comment(comment):
-    return CommentDao.update(comment)
-
-def delete_comment(comment_id):
-    return CommentDao.delete_by_id(comment_id)
-
-def delete_index(comment_id):
-    comment_service.delete_by_id(int(comment_id))
-
-def count_comment(user_name):
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    return comment_service.count(user_id=user_id)
-
-
-def count_comment_by_note(note_id):
-    try:
-        return comment_service.count(target_id=int(note_id))
-    except:
-        return 0
-
-def search_comment(user_name, *, keywords=[], offset=0, limit=xconfig.PAGE_SIZE, note_id=None):
-    assert user_name != None, "user_name can not be None"
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    target_id=0
-    if note_id != None:
-        target_id=int(note_id)
-    
-    idx_list = comment_service.list(what="id", user_id=user_id, target_id=target_id, limit=10000)
-    page_builder = PageBuilder(offset=offset,limit=limit)
-    for sub_idx_list in batch_iter(idx_list, batch_size=20):
-        comments = list_comments_by_idx_list(sub_idx_list)
-        for comment in comments:
-            content = comment.content.lower()
-            if textutil.contains_all(content, keywords):
-                page_builder.add_record(comment)
-                if len(page_builder.records) >= limit:
-                    break
-
-    return page_builder.records
-
-
-def drop_comment_table():
-    _comment_db.drop_index("user")
-    _comment_db.drop_index("note_id")
-    
-    for item in _comment_db.iter(-1):
-        _comment_db.delete(item)
-
-
-def fix_comment(comment):
-    _comment_db.insert(comment)
-
-
-# comments
-xutils.register_func("note.save_comment", create_comment)
-xutils.register_func("note.delete_comment", delete_comment)
-xutils.register_func("note.update_comment", update_comment)
-xutils.register_func("note.search_comment", search_comment)
-xutils.register_func("note.get_comment",  get_comment)
-
-xutils.register_func("note.list_comments", list_comments)
-xutils.register_func("note.list_comments_by_user", list_comments_by_user)
-xutils.register_func("note.count_comment", count_comment)
-xutils.register_func("note.count_comment_by_user", count_comments_by_user)
-xutils.register_func("note.count_comment_by_note", count_comment_by_note)
-
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/12/04 22:07:44
+# @modified 2022/04/16 21:57:34
+# @filename dao_comment.py
+
+
+import xutils
+from xnote.core import xconfig
+from xnote.core import xmanager
+from xnote.core import xauth
+from xutils import dbutil
+from xutils import textutil
+from xutils import dateutil
+from xutils.db.dbutil_helper import PageBuilder, batch_iter
+from .dao_api import NoteDao
+from . import dao as note_dao
+from xnote.service import CommentService
+
+NOTE_DAO = xutils.DAO("note")
+
+_comment_db = dbutil.get_table("comment")
+
+comment_service = CommentService()
+
+class CommentDO(xutils.Storage):
+    def __init__(self, **kw):
+        self.user = ""
+        self.user_id = 0
+        self.note_id = 0
+        self.type = ""
+        self.content = ""
+        self.ctime = dateutil.format_datetime()
+        self.update(kw)
+
+
+class CommentDao:
+
+    valid_type_set = set(["", None, "list_item"])
+    
+    @classmethod
+    def check(cls, comment):
+        assert comment != None, "comment is None"
+        assert comment.user != None, "comment.user is None"
+        assert comment.type in cls.valid_type_set, "comment.type is invalid"
+        assert comment.note_id != None
+        assert comment.content != None
+        assert comment.content != ""
+    
+    @classmethod
+    def create(cls, comment):
+        assert isinstance(comment, CommentDO)
+        check_comment(comment)
+        comment.ctime = dateutil.format_datetime()
+        index_id = comment_service.create(type=comment.type, user_id=comment.user_id, target_id=int(comment.note_id))
+        _comment_db.update_by_id(str(index_id), comment)
+        xmanager.fire("comment.create", comment)
+        return index_id
+        
+    @classmethod
+    def update(cls, comment):
+        assert comment != None
+        assert comment.user != None
+        assert comment.note_id != None
+        comment.mtime = dateutil.format_datetime()
+
+        _comment_db.update(comment)
+        xmanager.fire("comment.update", comment)
+
+        
+    @classmethod
+    def delete_by_id(cls, comment_id):
+        comment = get_comment(comment_id)
+        if comment != None:
+            _comment_db.delete(comment)
+            xmanager.fire("comment.delete", comment)
+        comment_service.delete_by_id(int(comment_id))
+
+
+
+def list_comments_by_idx_list(idx_list, user_name=""):
+    """通过索引查询评论
+    :param {list} idx_list: 索引对象列表
+    :param {str} user_name: 用于处理删除数据的user_name, 可以不传
+    """
+    id_list = [str(item.id) for item in idx_list]
+    comment_dict = _comment_db.batch_get_by_id(id_list)
+    result = []
+    for id in id_list:
+        item = comment_dict.get(id)
+        if item != None:
+            item.id = id
+            result.append(item)
+        else:
+            item = CommentDO()
+            item.id = id
+            item.user = user_name
+            item.content = "[数据被删除]"
+            result.append(item)
+    return result
+
+def list_comments(note_id, offset=0, limit=100, user_name=""):
+    index_list = comment_service.list(target_id=int(note_id), offset=offset,limit=limit)
+    return list_comments_by_idx_list(index_list, user_name=user_name)
+
+def handle_comments_by_user(handle_type, user_name, date=None, offset=0, limit=100):
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    if handle_type == "count":
+        return comment_service.count(user_id=user_id, date=date)
+    idx_list = comment_service.list(user_id=user_id,date=date,offset=offset,limit=limit,order="ctime desc")
+    return list_comments_by_idx_list(idx_list, user_name=user_name)
+
+
+def list_comments_by_user(*args, **kw):
+    result = []
+    for value in handle_comments_by_user("list", *args, **kw):
+        result.append(value)
+    return result
+
+
+def count_comments_by_user(*args, **kw):
+    return handle_comments_by_user("count", *args, **kw)
+
+
+def get_comment(comment_id = ""):
+    """通过comment_id实际上是根据key获取comment"""
+    value = _comment_db.get_by_id(comment_id)
+    if value != None:
+        value.id = comment_id
+        return CommentDO(**value)
+    return None
+
+
+def check_comment(comment):
+    return CommentDao.check(comment)
+
+def create_comment(comment):
+    return CommentDao.create(comment)
+
+def update_comment(comment):
+    return CommentDao.update(comment)
+
+def delete_comment(comment_id):
+    return CommentDao.delete_by_id(comment_id)
+
+def delete_index(comment_id):
+    comment_service.delete_by_id(int(comment_id))
+
+def count_comment(user_name):
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    return comment_service.count(user_id=user_id)
+
+
+def count_comment_by_note(note_id):
+    try:
+        return comment_service.count(target_id=int(note_id))
+    except:
+        return 0
+
+def search_comment(user_name, *, keywords=[], offset=0, limit=xconfig.PAGE_SIZE, note_id=None):
+    assert user_name != None, "user_name can not be None"
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    target_id=0
+    if note_id != None:
+        target_id=int(note_id)
+    
+    idx_list = comment_service.list(what="id", user_id=user_id, target_id=target_id, limit=10000)
+    page_builder = PageBuilder(offset=offset,limit=limit)
+    for sub_idx_list in batch_iter(idx_list, batch_size=20):
+        comments = list_comments_by_idx_list(sub_idx_list)
+        for comment in comments:
+            content = comment.content.lower()
+            if textutil.contains_all(content, keywords):
+                page_builder.add_record(comment)
+                if len(page_builder.records) >= limit:
+                    break
+
+    return page_builder.records
+
+
+def drop_comment_table():
+    _comment_db.drop_index("user")
+    _comment_db.drop_index("note_id")
+    
+    for item in _comment_db.iter(-1):
+        _comment_db.delete(item)
+
+
+def fix_comment(comment):
+    _comment_db.insert(comment)
+
+
+# comments
+xutils.register_func("note.save_comment", create_comment)
+xutils.register_func("note.delete_comment", delete_comment)
+xutils.register_func("note.update_comment", update_comment)
+xutils.register_func("note.search_comment", search_comment)
+xutils.register_func("note.get_comment",  get_comment)
+
+xutils.register_func("note.list_comments", list_comments)
+xutils.register_func("note.list_comments_by_user", list_comments_by_user)
+xutils.register_func("note.count_comment", count_comment)
+xutils.register_func("note.count_comment_by_user", count_comments_by_user)
+xutils.register_func("note.count_comment_by_note", count_comment_by_note)
+
 NoteDao.count_comment = count_comment
```

### Comparing `xnote-web-0.1.0/handlers/note/dao_delete.py` & `xnote-web-0.1.1/handlers/note/dao_delete.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_draft.py` & `xnote-web-0.1.1/handlers/note/dao_draft.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_edit.py` & `xnote-web-0.1.1/handlers/note/dao_edit.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_log.py` & `xnote-web-0.1.1/handlers/note/dao_log.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_read.py` & `xnote-web-0.1.1/handlers/note/dao_read.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/dao_share.py` & `xnote-web-0.1.1/handlers/note/dao_share.py`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,120 +1,120 @@
-# -*- coding:utf-8 -*-
-# @author mark
-# @since 2022/03/12 18:57:19
-# @modified 2022/03/12 23:21:48
-# @filename dao_share.py
-
-import json
-import xutils
-from xnote.core import xauth, xconfig, xtables
-
-from xutils import Storage
-from xutils import dbutil
-from xutils import logutil
-import handlers.note.dao as note_dao
-from handlers.note.dao import ShareTypeEnum, ShareInfoDO
-from .dao import sort_notes, batch_query_list
-
-def check_not_empty(value, method_name):
-    if value == None or value == "":
-        raise Exception("[%s] can not be empty" % method_name)
-
-def args_convert_func(note_id, from_user, to_user):
-    obj = Storage(note_id = note_id, from_user = from_user, to_user = to_user)
-    return json.dumps(obj)
-
-class NoteShareDao:
-    db = xtables.get_table_by_name("share_info")
-    user_dao = xauth.UserDao
-    share_type = ShareTypeEnum.note_to_user.value
-
-    @classmethod
-    def get_by_note_and_to_user(cls, note_id, to_id):
-        where = dict(share_type="note_to_user", target_id = int(note_id), to_id = to_id)
-        return cls.db.select_first(where=where)
-    
-    @classmethod
-    def delete_by_id(cls, id):
-        return cls.db.delete(where=dict(id=id))
-
-    @classmethod
-    def share_note_to(cls, target_id=0, from_id=0, to_id=0):
-        record = cls.get_by_note_and_to_user(note_id=target_id, to_id=to_id)
-        if record != None:
-            # 已经分享了
-            return
-
-        record = ShareInfoDO()
-        record.share_type = cls.share_type
-        record.target_id = target_id
-        record.from_id = from_id
-        record.to_id = to_id
-        return cls.db.insert(**record)
-
-    @classmethod
-    def count(cls, to_id=0):
-        where = dict(share_type = cls.share_type)
-        if to_id != 0:
-            where["to_id"] = to_id
-        return cls.db.count(where=where)
-    
-    @classmethod
-    def list(cls, target_id=0, to_id=0, offset=0, limit=20, order="id desc"):
-        where = dict(share_type = cls.share_type)
-        if to_id != 0:
-            where["to_id"] = to_id
-        if target_id != 0:
-            where["target_id"] = target_id
-        return cls.db.select(where=where, offset=offset, limit=limit, order=order)
-
-def get_share_by_note_and_to_user(note_id=0, to_user=""):
-    to_id = xauth.UserDao.get_id_by_name(to_user)
-    return NoteShareDao.get_by_note_and_to_user(note_id, to_id=to_id)
-
-
-@logutil.log_deco("share_note_to", log_args = True, args_convert_func = args_convert_func)
-def share_note_to(note_id, from_user, to_user):
-    from_id = xauth.UserDao.get_id_by_name(from_user)
-    to_id = xauth.UserDao.get_id_by_name(to_user)
-    return NoteShareDao.share_note_to(target_id=note_id, from_id=from_id, to_id=to_id)
-
-@logutil.log_deco("delete_share", log_args = True)
-def delete_share(note_id, to_user=""):
-    record = get_share_by_note_and_to_user(note_id, to_user)
-    if record != None:
-        NoteShareDao.delete_by_id(record.id)
-
-def list_share_to(to_user, offset = 0, limit = None, orderby = None):
-    if limit is None:
-        limit = xconfig.PAGE_SIZE
-
-    to_id = xauth.UserDao.get_id_by_name(to_user)
-    records = NoteShareDao.list(to_id=to_id, offset=offset, limit=limit, order="ctime desc")
-    id_list = list(map(lambda x:x.target_id, records))
-    notes = batch_query_list(id_list)
-    return notes
-
-def list_share_by_note_id(note_id):
-    result = NoteShareDao.list(target_id = note_id)
-    idset = set()
-    for item in result:
-        idset.add(item.to_id)
-    user_name_dict = xauth.UserDao.batch_get_name_by_ids(ids=idset)
-    for item in result:
-        item.to_user = user_name_dict.get(item.to_id)
-    return result
-
-def count_share_to(to_user):
-    to_id = xauth.UserDao.get_id_by_name(to_user)
-    return NoteShareDao.count(to_id=to_id)
-
-
-def get_share_to(to_user, note_id):
-    return get_share_by_note_and_to_user(note_id, to_user)
-
-xutils.register_func("note.share_to", share_note_to)
-xutils.register_func("note.delete_share", delete_share)
-xutils.register_func("note.list_share_to", list_share_to)
-xutils.register_func("note.get_share_to", get_share_to)
-xutils.register_func("note.count_share_to", count_share_to)
+# -*- coding:utf-8 -*-
+# @author mark
+# @since 2022/03/12 18:57:19
+# @modified 2022/03/12 23:21:48
+# @filename dao_share.py
+
+import json
+import xutils
+from xnote.core import xauth, xconfig, xtables
+
+from xutils import Storage
+from xutils import dbutil
+from xutils import logutil
+import handlers.note.dao as note_dao
+from handlers.note.dao import ShareTypeEnum, ShareInfoDO
+from .dao import sort_notes, batch_query_list
+
+def check_not_empty(value, method_name):
+    if value == None or value == "":
+        raise Exception("[%s] can not be empty" % method_name)
+
+def args_convert_func(note_id, from_user, to_user):
+    obj = Storage(note_id = note_id, from_user = from_user, to_user = to_user)
+    return json.dumps(obj)
+
+class NoteShareDao:
+    db = xtables.get_table_by_name("share_info")
+    user_dao = xauth.UserDao
+    share_type = ShareTypeEnum.note_to_user.value
+
+    @classmethod
+    def get_by_note_and_to_user(cls, note_id, to_id):
+        where = dict(share_type="note_to_user", target_id = int(note_id), to_id = to_id)
+        return cls.db.select_first(where=where)
+    
+    @classmethod
+    def delete_by_id(cls, id):
+        return cls.db.delete(where=dict(id=id))
+
+    @classmethod
+    def share_note_to(cls, target_id=0, from_id=0, to_id=0):
+        record = cls.get_by_note_and_to_user(note_id=target_id, to_id=to_id)
+        if record != None:
+            # 已经分享了
+            return
+
+        record = ShareInfoDO()
+        record.share_type = cls.share_type
+        record.target_id = target_id
+        record.from_id = from_id
+        record.to_id = to_id
+        return cls.db.insert(**record)
+
+    @classmethod
+    def count(cls, to_id=0):
+        where = dict(share_type = cls.share_type)
+        if to_id != 0:
+            where["to_id"] = to_id
+        return cls.db.count(where=where)
+    
+    @classmethod
+    def list(cls, target_id=0, to_id=0, offset=0, limit=20, order="id desc"):
+        where = dict(share_type = cls.share_type)
+        if to_id != 0:
+            where["to_id"] = to_id
+        if target_id != 0:
+            where["target_id"] = target_id
+        return cls.db.select(where=where, offset=offset, limit=limit, order=order)
+
+def get_share_by_note_and_to_user(note_id=0, to_user=""):
+    to_id = xauth.UserDao.get_id_by_name(to_user)
+    return NoteShareDao.get_by_note_and_to_user(note_id, to_id=to_id)
+
+
+@logutil.log_deco("share_note_to", log_args = True, args_convert_func = args_convert_func)
+def share_note_to(note_id, from_user, to_user):
+    from_id = xauth.UserDao.get_id_by_name(from_user)
+    to_id = xauth.UserDao.get_id_by_name(to_user)
+    return NoteShareDao.share_note_to(target_id=note_id, from_id=from_id, to_id=to_id)
+
+@logutil.log_deco("delete_share", log_args = True)
+def delete_share(note_id, to_user=""):
+    record = get_share_by_note_and_to_user(note_id, to_user)
+    if record != None:
+        NoteShareDao.delete_by_id(record.id)
+
+def list_share_to(to_user, offset = 0, limit = None, orderby = None):
+    if limit is None:
+        limit = xconfig.PAGE_SIZE
+
+    to_id = xauth.UserDao.get_id_by_name(to_user)
+    records = NoteShareDao.list(to_id=to_id, offset=offset, limit=limit, order="ctime desc")
+    id_list = list(map(lambda x:x.target_id, records))
+    notes = batch_query_list(id_list)
+    return notes
+
+def list_share_by_note_id(note_id):
+    result = NoteShareDao.list(target_id = note_id)
+    idset = set()
+    for item in result:
+        idset.add(item.to_id)
+    user_name_dict = xauth.UserDao.batch_get_name_by_ids(ids=idset)
+    for item in result:
+        item.to_user = user_name_dict.get(item.to_id)
+    return result
+
+def count_share_to(to_user):
+    to_id = xauth.UserDao.get_id_by_name(to_user)
+    return NoteShareDao.count(to_id=to_id)
+
+
+def get_share_to(to_user, note_id):
+    return get_share_by_note_and_to_user(note_id, to_user)
+
+xutils.register_func("note.share_to", share_note_to)
+xutils.register_func("note.delete_share", delete_share)
+xutils.register_func("note.list_share_to", list_share_to)
+xutils.register_func("note.get_share_to", get_share_to)
+xutils.register_func("note.count_share_to", count_share_to)
 xutils.register_func("note.list_share_by_note_id", list_share_by_note_id)
```

### Comparing `xnote-web-0.1.0/handlers/note/dao_tag.py` & `xnote-web-0.1.1/handlers/note/dao_tag.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/html_importer.py` & `xnote-web-0.1.1/handlers/note/html_importer.py`

 * *Files 2% similar despite different names*

```diff
@@ -177,17 +177,17 @@
 
         return xtemplate.render(self.template_path,
                                 show_aside=False, **kw)
 
     @xauth.login_required()
     def POST(self):
         try:
-            file = xutils.get_argument("file", {})
-            address = xutils.get_argument("url", "")
-            name = xutils.get_argument("name", "")
+            file = xutils.get_argument_field_storage("file")
+            address = xutils.get_argument_str("url", "")
+            name = xutils.get_argument_str("name", "")
             filename = ""
 
             if hasattr(file, "filename"):
                 filename = file.filename
 
             if not isempty(address):
                 address = address.strip()
@@ -195,16 +195,15 @@
                 filename = address
             else:
                 # 读取文件
                 html = ""
                 for chunk in file.file:
                     html += chunk.decode("utf-8")
 
-            logging.info("import html, filename={}, length={}, type={}".format(
-                filename, len(html), type(html)))
+            logging.info("import html, filename=%s, length=%s, type=%s", filename, len(html), type(html))
 
             result = import_from_html(html, address)
 
             if name != "" and name != None:
                 save_to_archive_dir(name)
 
             kw = self.get_kw()
@@ -247,15 +246,15 @@
     def download(self, url, fpath):
         try:
             return netutil.http_download(url, destpath=fpath)
         except Exception as e:
             logging.error("download (%s) failed", url)
             raise e
 
-    def handle_image(self, url, user_name):
+    def handle_image(self, url: str, user_name: str):
         # TODO 注意越权问题 host不能是内部地址
         # 1. host不能是内网地址
         # 2. 防止缓存数据过大拖垮服务器
 
         url = url.replace("\r", "")
         url = url.replace("\n", "")
 
@@ -265,14 +264,18 @@
         if url.startswith("/"):
             # 已经是本地地址
             return url
         
         if url.startswith("data:"):
             # 数据编码
             return url
+
+        if not url.startswith(("https://", "http://")):
+            # 无效的网址
+            return url
         
         if self.check_only:
             # 仅校验，不处理
             self._has_external_image = True
             return url
         
         if url.strip() == "":
```

### Comparing `xnote-web-0.1.0/handlers/note/note_api.py` & `xnote-web-0.1.1/handlers/note/note_api.py`

 * *Ordering differences only*

 * *Files 20% similar despite different names*

```diff
@@ -1,76 +1,76 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2020/01/05 21:00:07
-# @modified 2021/07/24 17:51:17
-import xutils
-from xnote.core import xauth
-from handlers.note import dao
-import handlers.note.dao_log as dao_log
-from handlers.note.note_helper import assemble_notes_by_date
-
-NOTE_DAO = xutils.DAO("note")
-
-
-class GroupApiHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        id = xutils.get_argument_int("id", 0)
-        list_type = xutils.get_argument("list_type", "")
-        orderby = xutils.get_argument_str("orderby", "mtime_desc")
-
-        user_name = xauth.current_name_str()
-        if list_type == "all":
-            notes = self.list_all_group(user_name, orderby=orderby)
-        else:
-            notes = dao.list_by_parent(
-                user_name, parent_id=id, offset=0, limit=1000, orderby="name")
-        notes = list(filter(lambda x: x.type == "group", notes))
-
-        parent_id = 0
-        if id != 0:
-            parent = dao.get_by_id(id)
-            if parent != None:
-                parent_id = parent.parent_id
-
-        return dict(code="success", data=notes, parent_id=parent_id)
-    
-    def list_all_group(self, user_name, orderby=""):
-        return dao.list_group_v2(user_name, limit=1000, orderby=orderby)
-
-
-def list_recent_groups(limit=5):
-    creator = xauth.current_name()
-    return dao.list_group(creator, orderby="mtime_desc", limit=5)
-
-
-def list_recent_notes(limit=5):
-    creator = xauth.current_name()
-    return dao_log.list_recent_edit(creator, limit=limit)
-
-
-def get_date_by_type(note, type):
-    if type == "ddate":
-        dtime = note.dtime
-        if dtime is None:
-            return note.mtime.split()[0]
-        return dtime.split()[0]
-    return note.ctime.split()[0]
-
-class StatApiHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name_str()
-        return dict(code="success", data=dao.get_note_stat(user_name=user_name))
-
-
-xutils.register_func("page.list_recent_groups", list_recent_groups)
-xutils.register_func("page.list_recent_notes", list_recent_notes)
-xutils.register_func("note.get_date_by_type", get_date_by_type)
-xutils.register_func("note.assemble_notes_by_date", assemble_notes_by_date)
-
-xurls = (
-    r"/note/api/group", GroupApiHandler,
-    r"/note/api/stat", StatApiHandler,
-)
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2020/01/05 21:00:07
+# @modified 2021/07/24 17:51:17
+import xutils
+from xnote.core import xauth
+from handlers.note import dao
+import handlers.note.dao_log as dao_log
+from handlers.note.note_helper import assemble_notes_by_date
+
+NOTE_DAO = xutils.DAO("note")
+
+
+class GroupApiHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        id = xutils.get_argument_int("id", 0)
+        list_type = xutils.get_argument("list_type", "")
+        orderby = xutils.get_argument_str("orderby", "mtime_desc")
+
+        user_name = xauth.current_name_str()
+        if list_type == "all":
+            notes = self.list_all_group(user_name, orderby=orderby)
+        else:
+            notes = dao.list_by_parent(
+                user_name, parent_id=id, offset=0, limit=1000, orderby="name")
+        notes = list(filter(lambda x: x.type == "group", notes))
+
+        parent_id = 0
+        if id != 0:
+            parent = dao.get_by_id(id)
+            if parent != None:
+                parent_id = parent.parent_id
+
+        return dict(code="success", data=notes, parent_id=parent_id)
+    
+    def list_all_group(self, user_name, orderby=""):
+        return dao.list_group_v2(user_name, limit=1000, orderby=orderby)
+
+
+def list_recent_groups(limit=5):
+    creator = xauth.current_name()
+    return dao.list_group(creator, orderby="mtime_desc", limit=5)
+
+
+def list_recent_notes(limit=5):
+    creator = xauth.current_name()
+    return dao_log.list_recent_edit(creator, limit=limit)
+
+
+def get_date_by_type(note, type):
+    if type == "ddate":
+        dtime = note.dtime
+        if dtime is None:
+            return note.mtime.split()[0]
+        return dtime.split()[0]
+    return note.ctime.split()[0]
+
+class StatApiHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name_str()
+        return dict(code="success", data=dao.get_note_stat(user_name=user_name))
+
+
+xutils.register_func("page.list_recent_groups", list_recent_groups)
+xutils.register_func("page.list_recent_notes", list_recent_notes)
+xutils.register_func("note.get_date_by_type", get_date_by_type)
+xutils.register_func("note.assemble_notes_by_date", assemble_notes_by_date)
+
+xurls = (
+    r"/note/api/group", GroupApiHandler,
+    r"/note/api/stat", StatApiHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/note/note_category.py` & `xnote-web-0.1.1/handlers/note/note_category.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/note_checklist.py` & `xnote-web-0.1.1/handlers/note/note_checklist.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/note_group.py` & `xnote-web-0.1.1/handlers/note/note_group.py`

 * *Ordering differences only*

 * *Files 17% similar despite different names*

```diff
@@ -1,975 +1,975 @@
-# encoding=utf-8
-# @since 2016/12
-# @modified 2022/04/22 23:30:02
-import math
-import time
-import json
-import logging
-try:
-    import cProfile as profile
-except ImportError:
-    import profile
-from .dao_book import SmartGroupService
-
-import web
-import xutils
-from xnote.core import xtemplate
-from xnote.core import xauth
-from xnote.core import xconfig
-from xnote.core import xmanager
-from xutils import Storage
-from xutils import dateutil, fsutil
-from xnote.core.xtemplate import T
-from .dao_category import list_category, get_category_by_code
-from . import dao_tag
-from . import dao
-from . import dao_book
-from . import dao_share
-from . import dao_log
-from .dao_api import NoteDao
-import handlers.note.dao as note_dao
-import handlers.message.dao as msg_dao
-
-VIEW_TPL = "note/page/view.html"
-TYPES_NAME = "笔记索引"
-NOTE_DAO = xutils.DAO("note")
-MSG_DAO = xutils.DAO("message")
-PLUGIN = xutils.Module("plugin")
-
-
-class PathNode(Storage):
-
-    def __init__(self, name, url, type="note"):
-        self.name = name
-        self.url = url
-        self.type = type
-        self.priority = 0
-        self.icon = type
-
-
-class GroupLink(Storage):
-    """笔记本的类型"""
-
-    def __init__(self, name, url, size=None, type="group"):
-        self.type = type
-        self.priority = 0
-        self.name = name
-        self.url = url
-        self.size = size
-        self.mtime = ""
-        self.ctime = ""
-        self.show_next = True
-        self.icon = "fa-folder orange"
-
-
-class SystemLink(GroupLink):
-    """系统列表项"""
-
-    def __init__(self, name, url, size=None):
-        GroupLink.__init__(self, name, url, size, "system")
-        self.icon = "icon-folder-system"
-
-
-class NoteLink:
-    def __init__(self, name, url, icon="fa-cube", size=None, roles=None, category="000", priority=0):
-        self.type = "link"
-        self.name = T(name)
-        self.url = url
-        self.icon = icon
-        self.size = size
-        self.priority = priority
-        self.ctime = ""
-        self.hide = False
-        self.show_next = True
-        self.is_deleted = 0
-        self.category = category
-        self.badge_info = ""
-
-        # 角色
-        if roles is None:
-            roles = ("admin", "user")
-        self.roles = roles
-
-    def __str__(self):
-        return str(self.__dict__)
-
-
-class DictEntryLink(NoteLink):
-    def __init__(self, size):
-        NoteLink.__init__(self, "词典", "/note/dict",  "icon-dict", size=size)
-        self.hide = xconfig.HIDE_DICT_ENTRY
-
-
-class NoteCard:
-
-    def __init__(self, title, rows):
-        self.title = title
-        self.rows = rows
-
-
-class RecentGroup:
-
-    def __init__(self, user_name):
-        self.name = u"最近"
-        self.size = None
-        self.url = "/note/recent?orderby=create"
-        self.icon = "fa-history"
-        self.priority = 0
-        self.show_next = True
-        self.is_deleted = 0
-
-
-def type_node_path(name, url):
-    parent = PathNode(TYPES_NAME, "/note/types")
-    return [parent, GroupLink(T(name), url)]
-
-
-class DefaultListHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        page = xutils.get_argument("page", 1, type=int)
-
-        assert isinstance(page, int)
-
-        user_name = xauth.get_current_name()
-        pagesize = xconfig.PAGE_SIZE
-        offset = (page-1) * pagesize
-        files = note_dao.list_default_notes(user_name, offset, pagesize)
-        amount = note_dao.count_by_parent(user_name, 0)
-
-        return xtemplate.render("note/page/note_default.html",
-                                notes=files,
-                                page=page,
-                                page_max=math.ceil(amount / pagesize),
-                                page_url="/note/default?page=")
-
-
-class ShareListHandler:
-
-    share_type = "public"
-    title = T("公开分享")
-
-    def list_notes(self, user_name, offset, limit):
-        orderby = xutils.get_argument_str("tab", "ctime_desc")
-        notes = note_dao.list_public(offset, limit, orderby)
-        return notes
-
-    def count_notes(self, user_name):
-        return note_dao.count_public()
-
-    def GET(self):
-        page = xutils.get_argument("page", 1, type=int)
-        tab = xutils.get_argument("tab", "")
-        assert isinstance(page, int)
-
-        user_name = xauth.current_name_str()
-        limit = xconfig.PAGE_SIZE
-        offset = (page-1) * limit
-
-        files = self.list_notes(user_name, offset, limit)
-        amount = self.count_notes(user_name)
-
-        xmanager.add_visit_log(user_name, "/note/%s" % self.share_type)
-        page_url = "/note/{share_type}?tab={tab}&page=".format(
-            share_type=self.share_type, tab=tab)
-
-        return xtemplate.render("note/page/note_share.html",
-                                title=self.title,
-                                notes=files,
-                                page=page,
-                                page_max=math.ceil(amount / limit),
-                                page_url=page_url)
-
-
-class PublicListHandler(ShareListHandler):
-    pass
-
-
-class ShareToMeListHandler(ShareListHandler):
-
-    share_type = "share_to_me"
-    title = T("分享给我")
-
-    def count_notes(self, user_name):
-        return dao_share.count_share_to(user_name)
-
-    def list_notes(self, user_name, offset, limit):
-        return dao_share.list_share_to(user_name, offset, limit)
-
-
-class GroupListHandler:
-
-    def load_category(self, kw, user_name):
-        kw.category_list = list(
-            filter(lambda x: x.group_count != 0, list_category(user_name)))
-
-    def load_group_list(self, user_name, status, kw):
-        parent_id = xutils.get_argument_int("parent_id")
-
-        if status in ("active", "archived"):
-            query_root = (status == "active")
-            notes = dao.list_group_v2(user_name,
-                                   status=status,
-                                   orderby="default",
-                                   parent_id=parent_id,
-                                   query_root=query_root,
-                                   tags=kw.q_tags)
-        else:
-            notes = SmartGroupService.list_smart_group(user_name)
-
-        if status == "active":
-            group = note_dao.get_virtual_group(user_name, "ungrouped")
-            if group.size > 0:
-                notes.insert(0, group)
-
-        return notes
-
-    def handle_badge_info(self, notes, tab):
-        if tab in ("active", "archived"):
-            for note in notes:
-                note.badge_info = note.children_count
-
-    def sort_notes(self, notes, kw):
-        tab = kw.tab
-        orderby = kw.orderby
-
-        if tab == "smart":
-            return
-
-        kw.show_orderby = True
-
-        if orderby == "name_desc":
-            notes.sort(key=lambda x: x.name, reverse=True)
-
-        if orderby == "name_asc":
-            notes.sort(key=lambda x: x.name)
-
-        if orderby == "hot_desc":
-            for note in notes:
-                note.hot_index = note.hot_index or 0
-                note.badge_info = "热度(%s)" % note.hot_index
-            notes.sort(key=lambda x: x.hot_index, reverse=True)
-
-        if orderby == "size_desc":
-            for note in notes:
-                note.badge_info = note.children_count
-
-            notes.sort(key=lambda x: x.children_count or 0, reverse=True)
-
-        if orderby == "ctime_desc":
-            for note in notes:
-                note.ctime = note.ctime or ""
-                note.badge_info = note.create_date
-            notes.sort(key=lambda x: x.ctime, reverse=True)
-
-        notes.sort(key=lambda x: x.priority, reverse=True)
-
-    def GET(self):
-        flag = xutils.get_argument_bool("profile")
-        if flag:
-            p = profile.Profile()
-            r = [0]
-            stats = p.runctx("r[0] = self.do_get()", globals(), locals())
-            # 排序字段 stdname/calls/time/cumulative
-            stats.print_stats(sort="cumulative")
-            return r[0]
-        else:
-            return self.do_get()
-
-    @xauth.login_required()
-    def do_get(self):
-        user_name = xauth.current_name()
-        assert isinstance(user_name, str)
-
-        orderby_default = xconfig.get_user_config(
-            user_name, "group_list_order_by", "name_asc")
-        logging.debug("orderby_default:%s", orderby_default)
-
-        category = xutils.get_argument("note_category", "all")
-        tab = xutils.get_argument("tab", "active")
-        orderby = xutils.get_argument("orderby", orderby_default)
-
-        show_back = xutils.get_argument("show_back", type=bool)
-        q_tag_name = xutils.get_argument("tag_name", "")
-        q_tags = []
-        if q_tag_name != "":
-            q_tags = [q_tag_name]
-
-        xmanager.add_visit_log(user_name, "/note/group")
-
-        if orderby != orderby_default:
-            xconfig.update_user_config(
-                user_name, "group_list_order_by", orderby)
-
-        root = note_dao.get_root()
-        kw = Storage()
-        kw.tab = tab
-        kw.orderby = orderby
-        kw.title = T("我的笔记本")
-        kw.note_category = category
-        kw.category_info = get_category_by_code(user_name, category)
-        kw.q_tags = q_tags
-
-        notes = self.load_group_list(user_name, tab, kw)
-
-        kw.file = root
-        kw.groups = notes
-        kw.parent_id = 0
-        kw.show_back = show_back
-        kw.show_sort = (tab != "smart")
-        kw.archived_count = dao.count_group(user_name, status="archived")
-        kw.active_count = dao.count_group(user_name, status="active", query_root=True)
-        kw.smart_count = SmartGroupService.count_smart_group()
-        kw.tag_meta_list = dao_tag.list_tag_meta(user_name, tag_type="group")
-
-        self.handle_badge_info(notes, tab=tab)
-        self.sort_notes(notes, kw)
-
-        if tab == "smart":
-            kw.show_note_types = False
-
-        return xtemplate.render("note/page/group_list.html", **kw)
-
-
-class GroupManageHandler:
-
-    def handle_root(self, kw):
-        page = xutils.get_argument_int("page", 1)
-        orderby = xutils.get_argument_str("orderby", "default")
-        category_code = xutils.get_argument("note_category", "all")
-        q_key = xutils.get_argument("key", "")
-        q_tags_str = xutils.get_argument_str("tags", "[]")
-
-        q_tags = json.loads(q_tags_str)
-
-        assert page > 0
-        limit = 1000
-        offset = (page-1) * limit
-
-        user_name = kw.user_name
-        user_id = kw.get("user_id", 0)
-        parent_note = note_dao.get_root()
-
-        list_group_kw = Storage()
-        list_group_kw.tags = q_tags
-        list_group_kw.search_name = q_key
-        list_group_kw.count_total = True
-        list_group_kw.category = category_code
-
-        notes, total = note_dao.list_group_with_count(creator_id=user_id, orderby=orderby, offset=offset,
-                                           limit=limit, **list_group_kw)
-        
-        kw.parent_note = parent_note
-        kw.notes = notes
-        kw.page_totalsize = total
-        kw.page_size = limit
-        kw.page_url = "?note_category={category}&orderby={orderby}&page=".format(
-            category=category_code, orderby=orderby)
-        kw.template = "note/page/batch/group_manage.html"
-        kw.category_list = list_category(user_name)
-        kw.q_tags = q_tags
-        kw.q_key = q_key
-        kw.search_type = "group_manage"
-
-        cat_info = get_category_by_code(user_name, category_code)
-        if cat_info != None:
-            kw.category_code = cat_info.code
-            kw.category_name = cat_info.name
-        else:
-            kw.category_code = "unknown"
-            kw.category_name = "未知"
-
-        kw.show_category_edit = (category_code != "all")
-        kw.note_tags = dao_tag.batch_get_tags_by_notes(kw.notes)
-
-    @xauth.login_required()
-    def GET(self):
-        parent_id = xutils.get_argument("parent_id", "0")
-        user_info = xauth.current_user()
-        assert user_info != None
-
-        xmanager.add_visit_log(user_info.name, "/note/group_list/edit")
-        kw = Storage(user_name=user_info.name, parent_id=parent_id, user_id=user_info.id)
-
-        self.handle_root(kw)
-        kw.current = Storage(url="#", name="整理")
-        return xtemplate.render(kw.template, **kw)
-
-
-def load_note_index(user_name):
-    msg_stat = msg_dao.get_message_stat(user_name)
-    note_stat = note_dao.get_note_stat(user_name)
-
-    return [
-        NoteCard("分类", [
-            NoteLink("任务", "/message?tag=task",
-                     "fa-calendar-check-o", size=msg_stat.task_count),
-            NoteLink("备忘", "/message?tag=log",
-                     "fa-sticky-note", size=msg_stat.log_count),
-            NoteLink("项目", "/note/group", "fa-folder",
-                     size=note_stat.group_count),
-            NoteLink("文档", "/note/document", "fa-file-text",
-                     size=note_stat.doc_count),
-            NoteLink("相册", "/note/gallery", "fa-image",
-                     size=note_stat.gallery_count),
-            NoteLink("清单", "/note/list", "fa-list", size=note_stat.list_count),
-            NoteLink("表格", "/note/table", "fa-table",
-                     size=note_stat.table_count),
-            NoteLink("日志", "/note/log", "fa-file-text",
-                     size=note_stat.log_count),
-            DictEntryLink(size=note_stat.dict_count),
-            NoteLink("插件", "/plugins_list", "fa-th-large",
-                     size=len(xconfig.PLUGINS_DICT), roles=["admin"]),
-        ]),
-
-        NoteCard(u"工具", [
-            NoteLink("置顶笔记", "/note/sticky", "fa-thumb-tack",
-                     size=note_stat.sticky_count),
-            NoteLink("搜索历史", "/search", "fa-search", size=None),
-            NoteLink("导入笔记", "/note/html_importer", "fa-internet-explorer"),
-            NoteLink("时间视图", "/note/date", "fa-calendar"),
-            NoteLink("数据统计", "/note/stat", "fa-bar-chart"),
-            NoteLink("上传管理", "/fs_upload", "fa-upload"),
-            NoteLink("回收站", "/note/removed", "fa-trash",
-                     size=note_stat.removed_count),
-        ])
-    ]
-
-
-def load_category(user_name, include_system=False):
-    data = note_dao.list_group_v2(user_name, orderby="name")
-    sticky_groups = list(filter(lambda x: x.priority !=
-                         None and x.priority > 0, data))
-    archived_groups = list(filter(lambda x: x.archived == True, data))
-    normal_groups = list(
-        filter(lambda x: x not in sticky_groups and x not in archived_groups, data))
-    groups_tuple = [
-        ("置顶", sticky_groups),
-        ("普通", normal_groups),
-        ("归档", archived_groups)
-    ]
-
-    if include_system:
-        system_folders = [
-            NoteLink("笔记", "/note/add", "fa-file-text-o"),
-            NoteLink("相册", "/note/add?type=gallery", "fa-photo"),
-            NoteLink("表格", "/note/add?type=csv", "fa-table"),
-            NoteLink("分组", "/note/add?type=group", "fa-folder")
-        ]
-
-        default_book_count = note_dao.count_by_parent(user_name, 0)
-        if default_book_count > 0:
-            sticky_groups.insert(0, SystemLink(
-                "默认分组", "/note/default", default_book_count))
-        sticky_groups.insert(0, NoteLink(
-            "时光轴", "/note/tools/timeline", "cube"))
-
-        groups_tuple = [
-            ("新建", system_folders),
-            ("置顶", sticky_groups),
-            ("分组", normal_groups),
-            ("已归档", archived_groups),
-        ]
-
-    return groups_tuple
-
-
-class GroupSelectHandler:
-    @xauth.login_required()
-    def GET(self):
-        id = xutils.get_argument("id", "")
-        callback = xutils.get_argument("callback")
-        user_name = xauth.current_name()
-        view = xutils.get_argument("view", "")
-        parent_id = xutils.get_argument("parent_id", "0")
-        q_parent_id = None
-
-        groups_tuple = load_category(xauth.current_name())
-        web.header("Content-Type", "text/html; charset=utf-8")
-
-        template = "note/component/group_select.html"
-        if view == "tree":
-            template = "note/component/group_select_tree.html"
-            q_parent_id = parent_id
-        else:
-            # view == flat
-            q_parent_id = None
-
-        files = note_dao.list_group(
-            user_name, orderby="default", parent_id=q_parent_id)
-
-        parent = note_dao.get_by_id_creator(parent_id, user_name)
-        kw = Storage()
-        kw.id = id
-        kw.groups_tuple = groups_tuple
-        kw.callback = callback
-        kw.parent_id = parent_id
-        kw.parent = parent
-        kw.files = files
-        return xtemplate.render(template, **kw)
-
-class BaseListHandler:
-
-    note_type = "gallery"
-    title = "相册"
-    orderby = "ctime desc"
-    create_type = ""
-    create_text = T("创建笔记")
-    date_type = "cdate"
-    show_ext_info = True
-
-    def count_notes(self, user_name):
-        return note_dao.count_by_type(user_name, self.note_type)
-
-    def list_notes(self, user_name, offset, limit):
-        return note_dao.list_by_type(user_name, self.note_type, offset, limit, self.orderby)
-
-    def map_notes(self, notes):
-        for note in notes:
-            note.badge_info = dateutil.format_date(note.ctime)
-
-        return notes
-    
-    def get_type_list(self):
-        return [
-            Storage(url="/note/all", name="全部", tag_code="all"),
-            Storage(url="/note/all?type=md", name="文档", tag_code="md"),
-            Storage(url="/note/all?type=gallery", name="相册", tag_code="gallery"),
-            Storage(url="/note/all?type=list", name="清单", tag_code="list"),
-            Storage(url="/note/all?type=table", name="表格", tag_code="table"),
-        ]
-
-    @xauth.login_required()
-    def GET(self):
-        page = xutils.get_argument("page", 1, type=int)
-        user_name = xauth.current_name()
-
-        assert isinstance(page, int)
-
-        limit = xconfig.PAGE_SIZE
-        offset = (page-1)*limit
-
-        self.note_type = xutils.get_argument_str("type", self.note_type)
-        assert isinstance(self.note_type, str)
-
-        amount = self.count_notes(user_name)
-        notes = self.list_notes(user_name, offset, limit)
-        notes = self.map_notes(notes)
-
-        kw = Storage()
-        kw.show_ext_info = self.show_ext_info
-        kw.show_pagination = True
-        kw.page = page
-        kw.page_max = math.ceil(amount / xconfig.PAGE_SIZE)
-        kw.page_url = "/note/%s?page=" % self.note_type
-        kw.notes = notes
-        kw.group_type = self.note_type
-        kw.note_type = self.note_type
-        kw.title = self.title
-        kw.date_type = self.date_type
-        kw.type_list = self.get_type_list()
-        kw.show_path = False
-        kw.file_type = "group"
-
-        # 上级菜单
-        parent = PathNode(T("根目录"), "/note/group")
-        kw.pathlist = [parent, PathNode(self.title, "/note/" + self.note_type)]
-        
-        return xtemplate.render("note/page/note_list.html",
-                                show_group_option=False,
-                                create_text=self.create_text,
-                                create_type=self.create_type,
-                                **kw)
-
-
-class TextListHandler(BaseListHandler):
-
-    note_type = "text"
-    title = "文本"
-
-
-class AddressBookListHandler(BaseListHandler):
-
-    note_type = "address"
-    title = "通讯录"
-
-
-class DocumentListHandler(BaseListHandler):
-
-    note_type = "md"
-    create_type = "md"
-    create_text = T("创建文档")
-    title = "我的文档"
-
-
-class GalleryListHandler(BaseListHandler):
-
-    note_type = "gallery"
-    create_type = "gallery"
-    create_text = "创建相册"
-    title = "我的相册"
-
-
-class CheckListHandler(BaseListHandler):
-
-    note_type = "list"
-    create_type = "list"
-    create_text = T("创建清单")
-    title = T("我的清单")
-
-
-class TableListHandler(BaseListHandler):
-
-    note_type = "table"
-    create_type = "csv"
-    create_text = T("创建表格")
-    title = T("我的表格")
-
-
-class RemovedListHandler(BaseListHandler):
-
-    note_type = "removed"
-    title = T("回收站")
-
-    def count_notes(self, user_name):
-        return note_dao.count_removed(user_name)
-
-    def list_notes(self, user_name, offset, limit):
-        return note_dao.list_removed(user_name, offset, limit, self.orderby)
-
-    def map_notes(self, notes):
-        for note in notes:
-            note.badge_info = dateutil.format_date(note.dtime)
-        return notes
-
-
-class StickyListHandler(BaseListHandler):
-
-    note_type = "sticky"
-    title = T("我的置顶")
-
-    def count_notes(self, user_name):
-        note_stat = note_dao.get_note_stat(user_name)
-        if note_stat:
-            return note_stat.sticky_count
-        else:
-            return 0
-
-    def list_notes(self, user_name, offset, limit):
-        return note_dao.list_sticky(user_name, offset, limit)
-
-
-class LogListHandler(BaseListHandler):
-
-    note_type = "log"
-    title = T("我的日志")
-
-
-class HtmlListHandler(BaseListHandler):
-
-    note_type = "html"
-    title = T("我的富文本")
-
-
-class FormListHandler(BaseListHandler):
-
-    note_type = "form"
-    title = T("我的表单")
-
-
-class AllNoteListHandler(BaseListHandler):
-
-    note_type = "all"
-    title = T("我的笔记")
-    show_ext_info = False
-
-    def count_notes(self, user_name):
-        note_stat = note_dao.get_note_stat(user_name)
-        if note_stat:
-            return note_stat.total
-        else:
-            return 0
-
-
-class NotePluginHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        raise web.found("/plugin_list?category=note&show_back=true")
-
-
-class RecentHandler:
-    """最近的笔记/常用的笔记"""
-
-    def count_note(self, user_name, orderby):
-        return dao_log.count_visit_log(user_name)
-
-    def list_notes(self, creator, offset, limit, orderby):
-        if orderby == "all":
-            return dao_log.list_recent_events(creator, offset, limit)
-        elif orderby == "view":
-            return dao_log.list_recent_viewed(creator, offset, limit)
-        elif orderby == "create":
-            return dao_log.list_recent_created(creator, offset, limit)
-        elif orderby == "myhot":
-            return dao_log.list_hot(creator, offset, limit)
-
-        # 最近更新的
-        notes = dao_log.list_recent_edit(creator, offset, limit)
-        for note in notes:
-            note.badge_info = dateutil.format_date(note.mtime, "/")
-        return notes
-
-    def get_html_title(self, orderby):
-        if orderby == "all":
-            return "All"
-
-        if orderby == "view":
-            return "Recent Viewed"
-
-        if orderby == "create":
-            return "Recent Created"
-
-        if orderby == "myhot":
-            return "Hot"
-
-        return "Recent Updated"
-
-    def GET(self, show_notice=True):
-        if not xauth.has_login():
-            raise web.seeother("/note/public")
-        if xutils.sqlite3 is None:
-            raise web.seeother("/fs_list")
-
-        page = xutils.get_argument("page", 1, type=int)
-        pagesize = xutils.get_argument("pagesize", xconfig.PAGE_SIZE, type=int)
-        orderby = xutils.get_argument("orderby", "create")
-
-        assert isinstance(page, int)
-        assert isinstance(pagesize, int)
-
-        page = max(1, page)
-        offset = max(0, (page-1) * pagesize)
-        limit = pagesize
-        dir_type = "recent_edit"
-        creator = xauth.current_name_str()
-
-        xmanager.add_visit_log(creator, "/note/recent?orderby=%s" % orderby)
-
-        html_title = self.get_html_title(orderby)
-        files = self.list_notes(creator, offset, limit, orderby)
-        count = self.count_note(creator, orderby)
-
-        kw = Storage()
-        kw.pathlist = type_node_path(html_title, "")
-        kw.html_title = html_title
-        kw.file_type = "group"
-        kw.dir_type = dir_type
-        kw.search_type = "note"
-        kw.files = files
-        kw.show_aside = False
-        kw.show_side = False
-        kw.page = page
-        kw.show_next = False
-        kw.page_max = math.ceil(count/xconfig.PAGE_SIZE)
-        kw.page_url = "/note/recent?orderby=%s&page=" % orderby
-        kw.sticky_position = "right"
-
-        return xtemplate.render("note/page/note_recent.html", **kw)
-
-
-class ArchivedHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        raise web.found("/note/group?tab=archived")
-
-
-class ManagementHandler:
-    """批量管理处理器"""
-
-    def handle_group(self, kw):
-        q_tags_str = xutils.get_argument_str("tags", "[]")
-        q_tags = json.loads(q_tags_str)
-
-        parent_id = kw.parent_id
-        user_name = kw.user_name
-
-        parent_note = NoteDao.get_by_id(parent_id)
-        if parent_note == None:
-            raise web.notfound()
-
-        notes = note_dao.list_by_parent(user_name, parent_id,
-                                        offset=0, limit=200, 
-                                        orderby=parent_note.orderby, tags=q_tags)
-
-        parent = Storage(url="/note/%s" % parent_id,
-                         name=parent_note.name)
-
-        dao_tag.batch_get_tags_by_notes(notes)
-        kw.parent_note = parent_note
-        kw.parent = parent
-        kw.notes = notes
-
-    def handle_default(self, kw):
-        user_name = kw.user_name
-        parent_note = note_dao.get_default_group()
-        notes = note_dao.list_default_notes(user_name)
-
-        kw.parent_note = parent_note
-        kw.notes = notes
-
-    @xauth.login_required()
-    def GET(self):
-        parent_id = xutils.get_argument("parent_id", "0")
-        user_name = xauth.current_name_str()
-
-        xmanager.add_visit_log(user_name, "/note/manage")
-
-        kw = Storage(user_name=user_name, parent_id=parent_id)
-        kw.template = "note/page/batch/note_manage.html"
-
-        if parent_id == "0" or parent_id is None:
-            raise web.found("/note/group/manage")
-        elif parent_id == "default":
-            self.handle_default(kw)
-        else:
-            self.handle_group(kw)
-
-        parent_note = kw.parent_note
-        notes = kw.notes
-
-        if parent_note is None:
-            raise web.seeother("/unauthorized")
-
-        if parent_note.type == "gallery":
-            fpath = note_dao.get_gallery_path(parent_note)
-            pathlist = fsutil.listdir_abs(fpath, False)
-            return xtemplate.render("note/page/batch/gallery_manage.html",
-                                    note=parent_note,
-                                    dirname=fpath,
-                                    pathlist=pathlist)
-
-        current = Storage(url="#", name="整理")
-        return xtemplate.render(kw.template,
-                                pathlist=note_dao.list_path(parent_note),
-                                files=notes,
-                                show_path=True,
-                                current=current, **kw)
-
-
-class NoteIndexHandler:
-
-    def find_class(self):
-        user_name = xauth.current_name()
-        home_path = xconfig.get_user_config(user_name, "HOME_PATH")
-        if xutils.is_mobile_client():
-            home_path = xconfig.get_user_config(user_name, "HOME_PATH_MOBILE")
-        clazz = xutils.lookup_func("url:" + home_path)
-        if clazz is None:
-            return GroupListHandler
-        return clazz
-
-    def GET(self):
-        clazz = self.find_class()
-        return clazz().GET()
-
-    def POST(self):
-        clazz = self.find_class()
-        return clazz().POST()
-
-
-class DateListHandler:
-
-    type_order_dict = {
-        "group":  0,
-        "gallery": 10,
-        "list": 20,
-        "table": 30,
-        "csv": 30,
-        "md": 90,
-    }
-
-    def sort_notes(self, notes):
-        notes.sort(key=lambda x: self.type_order_dict.get(x.type, 100))
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name_str()
-        show_back = xutils.get_argument("show_back", "")
-
-        xmanager.add_visit_log(user_name, "/note/date")
-
-        date = xutils.get_argument_str("date", time.strftime("%Y-%m"))
-        parts = date.split("-")
-        if len(parts) == 2:
-            year = int(parts[0])
-            month = int(parts[1])
-        else:
-            year = int(parts[0])
-            month = dateutil.get_current_month()
-
-        notes = []
-        # 待办任务
-        notes.append(msg_dao.get_message_tag(user_name, "task", priority=2))
-        notes.append(msg_dao.get_message_tag(user_name, "log",  priority=2))
-        notes_new = note_dao.list_by_date(
-            "ctime", user_name, date, orderby="ctime desc")
-        for note in notes_new:
-            note.badge_info = dateutil.format_date(note.ctime)
-
-        notes = notes + notes_new
-        notes_by_date = [("置顶", notes)]
-        # notes_by_date = NOTE_DAO.assemble_notes_by_date(notes)
-
-        return xtemplate.render("note/page/list_by_date.html",
-                                html_title=T("我的笔记"),
-                                date=date,
-                                year=year,
-                                month=month,
-                                notes_by_date=notes_by_date,
-                                show_back=show_back,
-                                search_type="default")
-
-
-xutils.register_func("url:/note/group", GroupListHandler)
-xutils.register_func("url:/note/tools", NotePluginHandler)
-xutils.register_func("url:/note/date",  DateListHandler)
-xutils.register_func("url:/note/all", AllNoteListHandler)
-
-xurls = (
-    r"/note/group", GroupListHandler,
-    r"/note/group_list", GroupListHandler,
-    r"/note/group/manage", GroupManageHandler,
-    r"/note/books", GroupListHandler,
-    r"/note/default", DefaultListHandler,
-    r"/note/ungrouped", DefaultListHandler,
-    r"/note/archived", ArchivedHandler,
-    r"/note/recent_edit", RecentHandler,
-    r"/note/recent", RecentHandler,
-    r"/note/recent_(created)", RecentHandler,
-    r"/note/recent_(viewed)", RecentHandler,
-    r"/note/group/select", GroupSelectHandler,
-    r"/note/management", ManagementHandler,
-    r"/note/manage", ManagementHandler,
-    r"/note/public", ShareListHandler,
-    r"/note/document", DocumentListHandler,
-    r"/note/md", DocumentListHandler,
-    r"/note/gallery", GalleryListHandler,
-    r"/note/list", CheckListHandler,
-    r"/note/table", TableListHandler,
-    r"/note/removed", RemovedListHandler,
-    r"/note/sticky", StickyListHandler,
-    r"/note/log", LogListHandler,
-    r"/note/all", AllNoteListHandler,
-    r"/note/html", HtmlListHandler,
-    r"/note/form", FormListHandler,
-    r"/note/date", DateListHandler,
-    r"/note/share_to_me", ShareToMeListHandler,
-
-    r"/note/text", TextListHandler,
-    r"/note/tools", NotePluginHandler,
-    r"/note/types", NotePluginHandler,
-    r"/note/index", NoteIndexHandler,
-)
+# encoding=utf-8
+# @since 2016/12
+# @modified 2022/04/22 23:30:02
+import math
+import time
+import json
+import logging
+try:
+    import cProfile as profile
+except ImportError:
+    import profile
+from .dao_book import SmartGroupService
+
+import web
+import xutils
+from xnote.core import xtemplate
+from xnote.core import xauth
+from xnote.core import xconfig
+from xnote.core import xmanager
+from xutils import Storage
+from xutils import dateutil, fsutil
+from xnote.core.xtemplate import T
+from .dao_category import list_category, get_category_by_code
+from . import dao_tag
+from . import dao
+from . import dao_book
+from . import dao_share
+from . import dao_log
+from .dao_api import NoteDao
+import handlers.note.dao as note_dao
+import handlers.message.dao as msg_dao
+
+VIEW_TPL = "note/page/view.html"
+TYPES_NAME = "笔记索引"
+NOTE_DAO = xutils.DAO("note")
+MSG_DAO = xutils.DAO("message")
+PLUGIN = xutils.Module("plugin")
+
+
+class PathNode(Storage):
+
+    def __init__(self, name, url, type="note"):
+        self.name = name
+        self.url = url
+        self.type = type
+        self.priority = 0
+        self.icon = type
+
+
+class GroupLink(Storage):
+    """笔记本的类型"""
+
+    def __init__(self, name, url, size=None, type="group"):
+        self.type = type
+        self.priority = 0
+        self.name = name
+        self.url = url
+        self.size = size
+        self.mtime = ""
+        self.ctime = ""
+        self.show_next = True
+        self.icon = "fa-folder orange"
+
+
+class SystemLink(GroupLink):
+    """系统列表项"""
+
+    def __init__(self, name, url, size=None):
+        GroupLink.__init__(self, name, url, size, "system")
+        self.icon = "icon-folder-system"
+
+
+class NoteLink:
+    def __init__(self, name, url, icon="fa-cube", size=None, roles=None, category="000", priority=0):
+        self.type = "link"
+        self.name = T(name)
+        self.url = url
+        self.icon = icon
+        self.size = size
+        self.priority = priority
+        self.ctime = ""
+        self.hide = False
+        self.show_next = True
+        self.is_deleted = 0
+        self.category = category
+        self.badge_info = ""
+
+        # 角色
+        if roles is None:
+            roles = ("admin", "user")
+        self.roles = roles
+
+    def __str__(self):
+        return str(self.__dict__)
+
+
+class DictEntryLink(NoteLink):
+    def __init__(self, size):
+        NoteLink.__init__(self, "词典", "/note/dict",  "icon-dict", size=size)
+        self.hide = xconfig.HIDE_DICT_ENTRY
+
+
+class NoteCard:
+
+    def __init__(self, title, rows):
+        self.title = title
+        self.rows = rows
+
+
+class RecentGroup:
+
+    def __init__(self, user_name):
+        self.name = u"最近"
+        self.size = None
+        self.url = "/note/recent?orderby=create"
+        self.icon = "fa-history"
+        self.priority = 0
+        self.show_next = True
+        self.is_deleted = 0
+
+
+def type_node_path(name, url):
+    parent = PathNode(TYPES_NAME, "/note/types")
+    return [parent, GroupLink(T(name), url)]
+
+
+class DefaultListHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        page = xutils.get_argument("page", 1, type=int)
+
+        assert isinstance(page, int)
+
+        user_name = xauth.get_current_name()
+        pagesize = xconfig.PAGE_SIZE
+        offset = (page-1) * pagesize
+        files = note_dao.list_default_notes(user_name, offset, pagesize)
+        amount = note_dao.count_by_parent(user_name, 0)
+
+        return xtemplate.render("note/page/note_default.html",
+                                notes=files,
+                                page=page,
+                                page_max=math.ceil(amount / pagesize),
+                                page_url="/note/default?page=")
+
+
+class ShareListHandler:
+
+    share_type = "public"
+    title = T("公开分享")
+
+    def list_notes(self, user_name, offset, limit):
+        orderby = xutils.get_argument_str("tab", "ctime_desc")
+        notes = note_dao.list_public(offset, limit, orderby)
+        return notes
+
+    def count_notes(self, user_name):
+        return note_dao.count_public()
+
+    def GET(self):
+        page = xutils.get_argument("page", 1, type=int)
+        tab = xutils.get_argument("tab", "")
+        assert isinstance(page, int)
+
+        user_name = xauth.current_name_str()
+        limit = xconfig.PAGE_SIZE
+        offset = (page-1) * limit
+
+        files = self.list_notes(user_name, offset, limit)
+        amount = self.count_notes(user_name)
+
+        xmanager.add_visit_log(user_name, "/note/%s" % self.share_type)
+        page_url = "/note/{share_type}?tab={tab}&page=".format(
+            share_type=self.share_type, tab=tab)
+
+        return xtemplate.render("note/page/note_share.html",
+                                title=self.title,
+                                notes=files,
+                                page=page,
+                                page_max=math.ceil(amount / limit),
+                                page_url=page_url)
+
+
+class PublicListHandler(ShareListHandler):
+    pass
+
+
+class ShareToMeListHandler(ShareListHandler):
+
+    share_type = "share_to_me"
+    title = T("分享给我")
+
+    def count_notes(self, user_name):
+        return dao_share.count_share_to(user_name)
+
+    def list_notes(self, user_name, offset, limit):
+        return dao_share.list_share_to(user_name, offset, limit)
+
+
+class GroupListHandler:
+
+    def load_category(self, kw, user_name):
+        kw.category_list = list(
+            filter(lambda x: x.group_count != 0, list_category(user_name)))
+
+    def load_group_list(self, user_name, status, kw):
+        parent_id = xutils.get_argument_int("parent_id")
+
+        if status in ("active", "archived"):
+            query_root = (status == "active")
+            notes = dao.list_group_v2(user_name,
+                                   status=status,
+                                   orderby="default",
+                                   parent_id=parent_id,
+                                   query_root=query_root,
+                                   tags=kw.q_tags)
+        else:
+            notes = SmartGroupService.list_smart_group(user_name)
+
+        if status == "active":
+            group = note_dao.get_virtual_group(user_name, "ungrouped")
+            if group.size > 0:
+                notes.insert(0, group)
+
+        return notes
+
+    def handle_badge_info(self, notes, tab):
+        if tab in ("active", "archived"):
+            for note in notes:
+                note.badge_info = note.children_count
+
+    def sort_notes(self, notes, kw):
+        tab = kw.tab
+        orderby = kw.orderby
+
+        if tab == "smart":
+            return
+
+        kw.show_orderby = True
+
+        if orderby == "name_desc":
+            notes.sort(key=lambda x: x.name, reverse=True)
+
+        if orderby == "name_asc":
+            notes.sort(key=lambda x: x.name)
+
+        if orderby == "hot_desc":
+            for note in notes:
+                note.hot_index = note.hot_index or 0
+                note.badge_info = "热度(%s)" % note.hot_index
+            notes.sort(key=lambda x: x.hot_index, reverse=True)
+
+        if orderby == "size_desc":
+            for note in notes:
+                note.badge_info = note.children_count
+
+            notes.sort(key=lambda x: x.children_count or 0, reverse=True)
+
+        if orderby == "ctime_desc":
+            for note in notes:
+                note.ctime = note.ctime or ""
+                note.badge_info = note.create_date
+            notes.sort(key=lambda x: x.ctime, reverse=True)
+
+        notes.sort(key=lambda x: x.priority, reverse=True)
+
+    def GET(self):
+        flag = xutils.get_argument_bool("profile")
+        if flag:
+            p = profile.Profile()
+            r = [0]
+            stats = p.runctx("r[0] = self.do_get()", globals(), locals())
+            # 排序字段 stdname/calls/time/cumulative
+            stats.print_stats(sort="cumulative")
+            return r[0]
+        else:
+            return self.do_get()
+
+    @xauth.login_required()
+    def do_get(self):
+        user_name = xauth.current_name()
+        assert isinstance(user_name, str)
+
+        orderby_default = xconfig.get_user_config(
+            user_name, "group_list_order_by", "name_asc")
+        logging.debug("orderby_default:%s", orderby_default)
+
+        category = xutils.get_argument("note_category", "all")
+        tab = xutils.get_argument("tab", "active")
+        orderby = xutils.get_argument("orderby", orderby_default)
+
+        show_back = xutils.get_argument("show_back", type=bool)
+        q_tag_name = xutils.get_argument("tag_name", "")
+        q_tags = []
+        if q_tag_name != "":
+            q_tags = [q_tag_name]
+
+        xmanager.add_visit_log(user_name, "/note/group")
+
+        if orderby != orderby_default:
+            xconfig.update_user_config(
+                user_name, "group_list_order_by", orderby)
+
+        root = note_dao.get_root()
+        kw = Storage()
+        kw.tab = tab
+        kw.orderby = orderby
+        kw.title = T("我的笔记本")
+        kw.note_category = category
+        kw.category_info = get_category_by_code(user_name, category)
+        kw.q_tags = q_tags
+
+        notes = self.load_group_list(user_name, tab, kw)
+
+        kw.file = root
+        kw.groups = notes
+        kw.parent_id = 0
+        kw.show_back = show_back
+        kw.show_sort = (tab != "smart")
+        kw.archived_count = dao.count_group(user_name, status="archived")
+        kw.active_count = dao.count_group(user_name, status="active", query_root=True)
+        kw.smart_count = SmartGroupService.count_smart_group()
+        kw.tag_meta_list = dao_tag.list_tag_meta(user_name, tag_type="group")
+
+        self.handle_badge_info(notes, tab=tab)
+        self.sort_notes(notes, kw)
+
+        if tab == "smart":
+            kw.show_note_types = False
+
+        return xtemplate.render("note/page/group_list.html", **kw)
+
+
+class GroupManageHandler:
+
+    def handle_root(self, kw):
+        page = xutils.get_argument_int("page", 1)
+        orderby = xutils.get_argument_str("orderby", "default")
+        category_code = xutils.get_argument("note_category", "all")
+        q_key = xutils.get_argument("key", "")
+        q_tags_str = xutils.get_argument_str("tags", "[]")
+
+        q_tags = json.loads(q_tags_str)
+
+        assert page > 0
+        limit = 1000
+        offset = (page-1) * limit
+
+        user_name = kw.user_name
+        user_id = kw.get("user_id", 0)
+        parent_note = note_dao.get_root()
+
+        list_group_kw = Storage()
+        list_group_kw.tags = q_tags
+        list_group_kw.search_name = q_key
+        list_group_kw.count_total = True
+        list_group_kw.category = category_code
+
+        notes, total = note_dao.list_group_with_count(creator_id=user_id, orderby=orderby, offset=offset,
+                                           limit=limit, **list_group_kw)
+        
+        kw.parent_note = parent_note
+        kw.notes = notes
+        kw.page_totalsize = total
+        kw.page_size = limit
+        kw.page_url = "?note_category={category}&orderby={orderby}&page=".format(
+            category=category_code, orderby=orderby)
+        kw.template = "note/page/batch/group_manage.html"
+        kw.category_list = list_category(user_name)
+        kw.q_tags = q_tags
+        kw.q_key = q_key
+        kw.search_type = "group_manage"
+
+        cat_info = get_category_by_code(user_name, category_code)
+        if cat_info != None:
+            kw.category_code = cat_info.code
+            kw.category_name = cat_info.name
+        else:
+            kw.category_code = "unknown"
+            kw.category_name = "未知"
+
+        kw.show_category_edit = (category_code != "all")
+        kw.note_tags = dao_tag.batch_get_tags_by_notes(kw.notes)
+
+    @xauth.login_required()
+    def GET(self):
+        parent_id = xutils.get_argument("parent_id", "0")
+        user_info = xauth.current_user()
+        assert user_info != None
+
+        xmanager.add_visit_log(user_info.name, "/note/group_list/edit")
+        kw = Storage(user_name=user_info.name, parent_id=parent_id, user_id=user_info.id)
+
+        self.handle_root(kw)
+        kw.current = Storage(url="#", name="整理")
+        return xtemplate.render(kw.template, **kw)
+
+
+def load_note_index(user_name):
+    msg_stat = msg_dao.get_message_stat(user_name)
+    note_stat = note_dao.get_note_stat(user_name)
+
+    return [
+        NoteCard("分类", [
+            NoteLink("任务", "/message?tag=task",
+                     "fa-calendar-check-o", size=msg_stat.task_count),
+            NoteLink("备忘", "/message?tag=log",
+                     "fa-sticky-note", size=msg_stat.log_count),
+            NoteLink("项目", "/note/group", "fa-folder",
+                     size=note_stat.group_count),
+            NoteLink("文档", "/note/document", "fa-file-text",
+                     size=note_stat.doc_count),
+            NoteLink("相册", "/note/gallery", "fa-image",
+                     size=note_stat.gallery_count),
+            NoteLink("清单", "/note/list", "fa-list", size=note_stat.list_count),
+            NoteLink("表格", "/note/table", "fa-table",
+                     size=note_stat.table_count),
+            NoteLink("日志", "/note/log", "fa-file-text",
+                     size=note_stat.log_count),
+            DictEntryLink(size=note_stat.dict_count),
+            NoteLink("插件", "/plugins_list", "fa-th-large",
+                     size=len(xconfig.PLUGINS_DICT), roles=["admin"]),
+        ]),
+
+        NoteCard(u"工具", [
+            NoteLink("置顶笔记", "/note/sticky", "fa-thumb-tack",
+                     size=note_stat.sticky_count),
+            NoteLink("搜索历史", "/search", "fa-search", size=None),
+            NoteLink("导入笔记", "/note/html_importer", "fa-internet-explorer"),
+            NoteLink("时间视图", "/note/date", "fa-calendar"),
+            NoteLink("数据统计", "/note/stat", "fa-bar-chart"),
+            NoteLink("上传管理", "/fs_upload", "fa-upload"),
+            NoteLink("回收站", "/note/removed", "fa-trash",
+                     size=note_stat.removed_count),
+        ])
+    ]
+
+
+def load_category(user_name, include_system=False):
+    data = note_dao.list_group_v2(user_name, orderby="name")
+    sticky_groups = list(filter(lambda x: x.priority !=
+                         None and x.priority > 0, data))
+    archived_groups = list(filter(lambda x: x.archived == True, data))
+    normal_groups = list(
+        filter(lambda x: x not in sticky_groups and x not in archived_groups, data))
+    groups_tuple = [
+        ("置顶", sticky_groups),
+        ("普通", normal_groups),
+        ("归档", archived_groups)
+    ]
+
+    if include_system:
+        system_folders = [
+            NoteLink("笔记", "/note/add", "fa-file-text-o"),
+            NoteLink("相册", "/note/add?type=gallery", "fa-photo"),
+            NoteLink("表格", "/note/add?type=csv", "fa-table"),
+            NoteLink("分组", "/note/add?type=group", "fa-folder")
+        ]
+
+        default_book_count = note_dao.count_by_parent(user_name, 0)
+        if default_book_count > 0:
+            sticky_groups.insert(0, SystemLink(
+                "默认分组", "/note/default", default_book_count))
+        sticky_groups.insert(0, NoteLink(
+            "时光轴", "/note/tools/timeline", "cube"))
+
+        groups_tuple = [
+            ("新建", system_folders),
+            ("置顶", sticky_groups),
+            ("分组", normal_groups),
+            ("已归档", archived_groups),
+        ]
+
+    return groups_tuple
+
+
+class GroupSelectHandler:
+    @xauth.login_required()
+    def GET(self):
+        id = xutils.get_argument("id", "")
+        callback = xutils.get_argument("callback")
+        user_name = xauth.current_name()
+        view = xutils.get_argument("view", "")
+        parent_id = xutils.get_argument("parent_id", "0")
+        q_parent_id = None
+
+        groups_tuple = load_category(xauth.current_name())
+        web.header("Content-Type", "text/html; charset=utf-8")
+
+        template = "note/component/group_select.html"
+        if view == "tree":
+            template = "note/component/group_select_tree.html"
+            q_parent_id = parent_id
+        else:
+            # view == flat
+            q_parent_id = None
+
+        files = note_dao.list_group(
+            user_name, orderby="default", parent_id=q_parent_id)
+
+        parent = note_dao.get_by_id_creator(parent_id, user_name)
+        kw = Storage()
+        kw.id = id
+        kw.groups_tuple = groups_tuple
+        kw.callback = callback
+        kw.parent_id = parent_id
+        kw.parent = parent
+        kw.files = files
+        return xtemplate.render(template, **kw)
+
+class BaseListHandler:
+
+    note_type = "gallery"
+    title = "相册"
+    orderby = "ctime desc"
+    create_type = ""
+    create_text = T("创建笔记")
+    date_type = "cdate"
+    show_ext_info = True
+
+    def count_notes(self, user_name):
+        return note_dao.count_by_type(user_name, self.note_type)
+
+    def list_notes(self, user_name, offset, limit):
+        return note_dao.list_by_type(user_name, self.note_type, offset, limit, self.orderby)
+
+    def map_notes(self, notes):
+        for note in notes:
+            note.badge_info = dateutil.format_date(note.ctime)
+
+        return notes
+    
+    def get_type_list(self):
+        return [
+            Storage(url="/note/all", name="全部", tag_code="all"),
+            Storage(url="/note/all?type=md", name="文档", tag_code="md"),
+            Storage(url="/note/all?type=gallery", name="相册", tag_code="gallery"),
+            Storage(url="/note/all?type=list", name="清单", tag_code="list"),
+            Storage(url="/note/all?type=table", name="表格", tag_code="table"),
+        ]
+
+    @xauth.login_required()
+    def GET(self):
+        page = xutils.get_argument("page", 1, type=int)
+        user_name = xauth.current_name()
+
+        assert isinstance(page, int)
+
+        limit = xconfig.PAGE_SIZE
+        offset = (page-1)*limit
+
+        self.note_type = xutils.get_argument_str("type", self.note_type)
+        assert isinstance(self.note_type, str)
+
+        amount = self.count_notes(user_name)
+        notes = self.list_notes(user_name, offset, limit)
+        notes = self.map_notes(notes)
+
+        kw = Storage()
+        kw.show_ext_info = self.show_ext_info
+        kw.show_pagination = True
+        kw.page = page
+        kw.page_max = math.ceil(amount / xconfig.PAGE_SIZE)
+        kw.page_url = "/note/%s?page=" % self.note_type
+        kw.notes = notes
+        kw.group_type = self.note_type
+        kw.note_type = self.note_type
+        kw.title = self.title
+        kw.date_type = self.date_type
+        kw.type_list = self.get_type_list()
+        kw.show_path = False
+        kw.file_type = "group"
+
+        # 上级菜单
+        parent = PathNode(T("根目录"), "/note/group")
+        kw.pathlist = [parent, PathNode(self.title, "/note/" + self.note_type)]
+        
+        return xtemplate.render("note/page/note_list.html",
+                                show_group_option=False,
+                                create_text=self.create_text,
+                                create_type=self.create_type,
+                                **kw)
+
+
+class TextListHandler(BaseListHandler):
+
+    note_type = "text"
+    title = "文本"
+
+
+class AddressBookListHandler(BaseListHandler):
+
+    note_type = "address"
+    title = "通讯录"
+
+
+class DocumentListHandler(BaseListHandler):
+
+    note_type = "md"
+    create_type = "md"
+    create_text = T("创建文档")
+    title = "我的文档"
+
+
+class GalleryListHandler(BaseListHandler):
+
+    note_type = "gallery"
+    create_type = "gallery"
+    create_text = "创建相册"
+    title = "我的相册"
+
+
+class CheckListHandler(BaseListHandler):
+
+    note_type = "list"
+    create_type = "list"
+    create_text = T("创建清单")
+    title = T("我的清单")
+
+
+class TableListHandler(BaseListHandler):
+
+    note_type = "table"
+    create_type = "csv"
+    create_text = T("创建表格")
+    title = T("我的表格")
+
+
+class RemovedListHandler(BaseListHandler):
+
+    note_type = "removed"
+    title = T("回收站")
+
+    def count_notes(self, user_name):
+        return note_dao.count_removed(user_name)
+
+    def list_notes(self, user_name, offset, limit):
+        return note_dao.list_removed(user_name, offset, limit, self.orderby)
+
+    def map_notes(self, notes):
+        for note in notes:
+            note.badge_info = dateutil.format_date(note.dtime)
+        return notes
+
+
+class StickyListHandler(BaseListHandler):
+
+    note_type = "sticky"
+    title = T("我的置顶")
+
+    def count_notes(self, user_name):
+        note_stat = note_dao.get_note_stat(user_name)
+        if note_stat:
+            return note_stat.sticky_count
+        else:
+            return 0
+
+    def list_notes(self, user_name, offset, limit):
+        return note_dao.list_sticky(user_name, offset, limit)
+
+
+class LogListHandler(BaseListHandler):
+
+    note_type = "log"
+    title = T("我的日志")
+
+
+class HtmlListHandler(BaseListHandler):
+
+    note_type = "html"
+    title = T("我的富文本")
+
+
+class FormListHandler(BaseListHandler):
+
+    note_type = "form"
+    title = T("我的表单")
+
+
+class AllNoteListHandler(BaseListHandler):
+
+    note_type = "all"
+    title = T("我的笔记")
+    show_ext_info = False
+
+    def count_notes(self, user_name):
+        note_stat = note_dao.get_note_stat(user_name)
+        if note_stat:
+            return note_stat.total
+        else:
+            return 0
+
+
+class NotePluginHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        raise web.found("/plugin_list?category=note&show_back=true")
+
+
+class RecentHandler:
+    """最近的笔记/常用的笔记"""
+
+    def count_note(self, user_name, orderby):
+        return dao_log.count_visit_log(user_name)
+
+    def list_notes(self, creator, offset, limit, orderby):
+        if orderby == "all":
+            return dao_log.list_recent_events(creator, offset, limit)
+        elif orderby == "view":
+            return dao_log.list_recent_viewed(creator, offset, limit)
+        elif orderby == "create":
+            return dao_log.list_recent_created(creator, offset, limit)
+        elif orderby == "myhot":
+            return dao_log.list_hot(creator, offset, limit)
+
+        # 最近更新的
+        notes = dao_log.list_recent_edit(creator, offset, limit)
+        for note in notes:
+            note.badge_info = dateutil.format_date(note.mtime, "/")
+        return notes
+
+    def get_html_title(self, orderby):
+        if orderby == "all":
+            return "All"
+
+        if orderby == "view":
+            return "Recent Viewed"
+
+        if orderby == "create":
+            return "Recent Created"
+
+        if orderby == "myhot":
+            return "Hot"
+
+        return "Recent Updated"
+
+    def GET(self, show_notice=True):
+        if not xauth.has_login():
+            raise web.seeother("/note/public")
+        if xutils.sqlite3 is None:
+            raise web.seeother("/fs_list")
+
+        page = xutils.get_argument("page", 1, type=int)
+        pagesize = xutils.get_argument("pagesize", xconfig.PAGE_SIZE, type=int)
+        orderby = xutils.get_argument("orderby", "create")
+
+        assert isinstance(page, int)
+        assert isinstance(pagesize, int)
+
+        page = max(1, page)
+        offset = max(0, (page-1) * pagesize)
+        limit = pagesize
+        dir_type = "recent_edit"
+        creator = xauth.current_name_str()
+
+        xmanager.add_visit_log(creator, "/note/recent?orderby=%s" % orderby)
+
+        html_title = self.get_html_title(orderby)
+        files = self.list_notes(creator, offset, limit, orderby)
+        count = self.count_note(creator, orderby)
+
+        kw = Storage()
+        kw.pathlist = type_node_path(html_title, "")
+        kw.html_title = html_title
+        kw.file_type = "group"
+        kw.dir_type = dir_type
+        kw.search_type = "note"
+        kw.files = files
+        kw.show_aside = False
+        kw.show_side = False
+        kw.page = page
+        kw.show_next = False
+        kw.page_max = math.ceil(count/xconfig.PAGE_SIZE)
+        kw.page_url = "/note/recent?orderby=%s&page=" % orderby
+        kw.sticky_position = "right"
+
+        return xtemplate.render("note/page/note_recent.html", **kw)
+
+
+class ArchivedHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        raise web.found("/note/group?tab=archived")
+
+
+class ManagementHandler:
+    """批量管理处理器"""
+
+    def handle_group(self, kw):
+        q_tags_str = xutils.get_argument_str("tags", "[]")
+        q_tags = json.loads(q_tags_str)
+
+        parent_id = kw.parent_id
+        user_name = kw.user_name
+
+        parent_note = NoteDao.get_by_id(parent_id)
+        if parent_note == None:
+            raise web.notfound()
+
+        notes = note_dao.list_by_parent(user_name, parent_id,
+                                        offset=0, limit=200, 
+                                        orderby=parent_note.orderby, tags=q_tags)
+
+        parent = Storage(url="/note/%s" % parent_id,
+                         name=parent_note.name)
+
+        dao_tag.batch_get_tags_by_notes(notes)
+        kw.parent_note = parent_note
+        kw.parent = parent
+        kw.notes = notes
+
+    def handle_default(self, kw):
+        user_name = kw.user_name
+        parent_note = note_dao.get_default_group()
+        notes = note_dao.list_default_notes(user_name)
+
+        kw.parent_note = parent_note
+        kw.notes = notes
+
+    @xauth.login_required()
+    def GET(self):
+        parent_id = xutils.get_argument("parent_id", "0")
+        user_name = xauth.current_name_str()
+
+        xmanager.add_visit_log(user_name, "/note/manage")
+
+        kw = Storage(user_name=user_name, parent_id=parent_id)
+        kw.template = "note/page/batch/note_manage.html"
+
+        if parent_id == "0" or parent_id is None:
+            raise web.found("/note/group/manage")
+        elif parent_id == "default":
+            self.handle_default(kw)
+        else:
+            self.handle_group(kw)
+
+        parent_note = kw.parent_note
+        notes = kw.notes
+
+        if parent_note is None:
+            raise web.seeother("/unauthorized")
+
+        if parent_note.type == "gallery":
+            fpath = note_dao.get_gallery_path(parent_note)
+            pathlist = fsutil.listdir_abs(fpath, False)
+            return xtemplate.render("note/page/batch/gallery_manage.html",
+                                    note=parent_note,
+                                    dirname=fpath,
+                                    pathlist=pathlist)
+
+        current = Storage(url="#", name="整理")
+        return xtemplate.render(kw.template,
+                                pathlist=note_dao.list_path(parent_note),
+                                files=notes,
+                                show_path=True,
+                                current=current, **kw)
+
+
+class NoteIndexHandler:
+
+    def find_class(self):
+        user_name = xauth.current_name()
+        home_path = xconfig.get_user_config(user_name, "HOME_PATH")
+        if xutils.is_mobile_client():
+            home_path = xconfig.get_user_config(user_name, "HOME_PATH_MOBILE")
+        clazz = xutils.lookup_func("url:" + home_path)
+        if clazz is None:
+            return GroupListHandler
+        return clazz
+
+    def GET(self):
+        clazz = self.find_class()
+        return clazz().GET()
+
+    def POST(self):
+        clazz = self.find_class()
+        return clazz().POST()
+
+
+class DateListHandler:
+
+    type_order_dict = {
+        "group":  0,
+        "gallery": 10,
+        "list": 20,
+        "table": 30,
+        "csv": 30,
+        "md": 90,
+    }
+
+    def sort_notes(self, notes):
+        notes.sort(key=lambda x: self.type_order_dict.get(x.type, 100))
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name_str()
+        show_back = xutils.get_argument("show_back", "")
+
+        xmanager.add_visit_log(user_name, "/note/date")
+
+        date = xutils.get_argument_str("date", time.strftime("%Y-%m"))
+        parts = date.split("-")
+        if len(parts) == 2:
+            year = int(parts[0])
+            month = int(parts[1])
+        else:
+            year = int(parts[0])
+            month = dateutil.get_current_month()
+
+        notes = []
+        # 待办任务
+        notes.append(msg_dao.get_message_tag(user_name, "task", priority=2))
+        notes.append(msg_dao.get_message_tag(user_name, "log",  priority=2))
+        notes_new = note_dao.list_by_date(
+            "ctime", user_name, date, orderby="ctime desc")
+        for note in notes_new:
+            note.badge_info = dateutil.format_date(note.ctime)
+
+        notes = notes + notes_new
+        notes_by_date = [("置顶", notes)]
+        # notes_by_date = NOTE_DAO.assemble_notes_by_date(notes)
+
+        return xtemplate.render("note/page/list_by_date.html",
+                                html_title=T("我的笔记"),
+                                date=date,
+                                year=year,
+                                month=month,
+                                notes_by_date=notes_by_date,
+                                show_back=show_back,
+                                search_type="default")
+
+
+xutils.register_func("url:/note/group", GroupListHandler)
+xutils.register_func("url:/note/tools", NotePluginHandler)
+xutils.register_func("url:/note/date",  DateListHandler)
+xutils.register_func("url:/note/all", AllNoteListHandler)
+
+xurls = (
+    r"/note/group", GroupListHandler,
+    r"/note/group_list", GroupListHandler,
+    r"/note/group/manage", GroupManageHandler,
+    r"/note/books", GroupListHandler,
+    r"/note/default", DefaultListHandler,
+    r"/note/ungrouped", DefaultListHandler,
+    r"/note/archived", ArchivedHandler,
+    r"/note/recent_edit", RecentHandler,
+    r"/note/recent", RecentHandler,
+    r"/note/recent_(created)", RecentHandler,
+    r"/note/recent_(viewed)", RecentHandler,
+    r"/note/group/select", GroupSelectHandler,
+    r"/note/management", ManagementHandler,
+    r"/note/manage", ManagementHandler,
+    r"/note/public", ShareListHandler,
+    r"/note/document", DocumentListHandler,
+    r"/note/md", DocumentListHandler,
+    r"/note/gallery", GalleryListHandler,
+    r"/note/list", CheckListHandler,
+    r"/note/table", TableListHandler,
+    r"/note/removed", RemovedListHandler,
+    r"/note/sticky", StickyListHandler,
+    r"/note/log", LogListHandler,
+    r"/note/all", AllNoteListHandler,
+    r"/note/html", HtmlListHandler,
+    r"/note/form", FormListHandler,
+    r"/note/date", DateListHandler,
+    r"/note/share_to_me", ShareToMeListHandler,
+
+    r"/note/text", TextListHandler,
+    r"/note/tools", NotePluginHandler,
+    r"/note/types", NotePluginHandler,
+    r"/note/index", NoteIndexHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/note/note_helper.py` & `xnote-web-0.1.1/handlers/note/note_helper.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/note_stat.py` & `xnote-web-0.1.1/handlers/note/note_stat.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,54 +1,35 @@
 # -*- coding:utf-8 -*-
 # @author xupingmao <578749341@qq.com>
 # @since 2019/08/20 11:02:04
 # @modified 2022/04/20 23:03:49
-import xauth
-import xutils
-import xmanager
+from xnote.core import xauth
+from xnote.core import xmanager
 from xutils import dbutil
-from xtemplate import BasePlugin
+from xnote.plugin.table_plugin import BaseTablePlugin
+from xnote.plugin import DataTable
 import handlers.message.dao as msg_dao
 import handlers.note.dao as note_dao
 
-HTML = """
-<style>
-    .key { width: 75%; }
-    .admin-stat-th { width: 25% }
-</style>
-
-{% if stat_list != None %}
-<div class="card">
-    <table class="table">
-        <tr>
-            <th class="key">项目</th>
-            <th>数量</th>
-        </tr>
-        {% for key, value in stat_list %}
-            <tr>
-                <td>{{key}}</td>
-                <td>{{value}}</td>
-            </tr>
-        {% end %}
-    </table>
-</div>
-{% end %}
-"""
-
-SIDEBAR_HTML = """
-{% include note/component/sidebar/group_list_sidebar.html %}
-"""
-
-class StatHandler(BasePlugin):
+class StatHandler(BaseTablePlugin):
 
     title = "数据统计"
     editable = False
     require_admin = False
     rows = 0
 
+    BODY_HTML = """
+    <div class="card">
+        {% include common/table/table.html %}
+    </div>
+"""
+    SIDEBAR_HTML = """
+{% include note/component/sidebar/group_list_sidebar.html %}
+"""
+
     def get_stat_list(self, user_name):
         stat_list = []
         message_stat = msg_dao.get_message_stat(user_name)
         note_stat = note_dao.get_note_stat(user_name)
         group_count = note_stat.group_count
         note_count = note_stat.total
         comment_count = note_stat.comment_count
@@ -58,43 +39,25 @@
         stat_list.append(["我的笔记", note_count])
         stat_list.append(["我的待办", message_stat.task_count])
         stat_list.append(["我的记事", message_stat.log_count])
         stat_list.append(["搜索记录", search_count])
         stat_list.append(["我的评论", comment_count])
         return stat_list
 
-    def get_admin_stat_list(self, hide_index):
-        admin_stat_list = []
-        if xauth.is_admin():
-            table_dict = dbutil.get_table_dict_copy()
-            table_values = sorted(table_dict.values(), key = lambda x:(x.category,x.name))
-            for table_info in table_values:
-                name = table_info.name
-                if hide_index == "true" and name.startswith("_index"):
-                    continue
-                admin_stat_list.append([table_info.category, 
-                    table_info.name, 
-                    table_info.description, 
-                    dbutil.count_table(name, use_cache = True)])
-        return admin_stat_list
-
-    def handle(self, input):
-        p = xutils.get_argument("p", "")
-        hide_index = xutils.get_argument("hide_index", "true")
-        user_name = xauth.current_name()
-        assert isinstance(user_name, str)
-
+    def handle(self, input=""):
+        user_name = xauth.current_name_str()
         xmanager.add_visit_log(user_name, "/note/stat")
         
-        if p == "system":
-            stat_list = None
-            admin_stat_list = self.get_admin_stat_list(hide_index)
-        else:
-            stat_list = self.get_stat_list(user_name)
-            admin_stat_list = self.get_admin_stat_list(hide_index)
+        table = DataTable()
+        table.add_head("项目", width="60%", field="key")
+        table.add_head("数量", width="40%", field="value")
+
+        for key, value in self.get_stat_list(user_name):
+            row = dict(key=key, value=value)
+            table.add_row(row)
         
-        self.writetemplate(HTML, stat_list = stat_list, admin_stat_list = admin_stat_list)
-        self.write_aside(SIDEBAR_HTML)
+        self.writehtml(self.BODY_HTML, table=table)
+        self.write_aside(self.SIDEBAR_HTML)
 
 xurls = (
     r"/note/stat", StatHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/note/note_tag.py` & `xnote-web-0.1.1/handlers/note/note_tag.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/note_timeline.py` & `xnote-web-0.1.1/handlers/note/note_timeline.py`

 * *Ordering differences only*

 * *Files 27% similar despite different names*

```diff
@@ -1,696 +1,696 @@
-# -*- coding:utf-8 -*-
-# Created by xupingmao on 2017/05/18
-# @modified 2022/01/27 21:40:22
-
-"""时光轴视图"""
-import re
-import xutils
-from xnote.core import xauth
-from xnote.core import xtemplate
-import time
-import web
-from xutils import Storage, dateutil, textutil
-from xutils import webutil
-from xutils.textutil import split_words
-from xnote.core.xtemplate import T
-from handlers.note.constant import *
-from handlers.message.dao import MessageDao
-from handlers.note.dao_api import NoteDao
-from handlers.note import note_helper, dao_share
-import handlers.note.dao as note_dao
-import handlers.note.dao_log as dao_log
-from xnote.core import xmanager
-
-
-class PathLink:
-
-    def __init__(self, name, url):
-        self.name = name
-        self.url = url
-
-class ListContext(Storage):
-    def __init__(self,**kw):
-        self.offset = 0
-        self.limit = 0
-        self.type = ""
-        self.parent_id = 0
-        self.search_key = ""
-        self.orderby = ""
-        self.search_tag = ""
-        self.filter_tag = "" # 笔记过滤的tag
-        self.user_name = ""
-        self.user_id = 0
-        self.url_type = ""
-        self.update(kw)
-
-def get_parent_link(user_name, type, priority=0):
-    if priority < 0:
-        return PathLink(T("Archived_Project"), "/note/archived")
-    if type == "default" or type == "root_notes":
-        return PathLink(u"根目录", "/note/timeline?type=group_list&orderby=name")
-    if type == "public":
-        return None
-    return None
-
-
-class SystemGroup(Storage):
-    def __init__(self, name, url, priority=1, icon="fa fa-file-text-o"):
-        super(SystemGroup, self).__init__()
-        self.user = xauth.current_name()
-        self.type = 'system'
-        self.icon = icon
-        self.name = name
-        self.url = url
-        self.priority = priority
-        self.level = priority
-        self.size = 0
-        self.mtime = dateutil.format_datetime()
-
-
-class TaskGroup(Storage):
-    def __init__(self, name="待办任务"):
-        super(TaskGroup, self).__init__()
-        self.user = xauth.current_name()
-        self.type = 'system'
-        self.name = name
-        self.icon = "fa-calendar-check-o"
-        self.ctime = dateutil.format_time()
-        self.mtime = dateutil.format_time()
-        self.url = "/message?tag=task"
-        self.priority = 1
-        self.level = self.priority
-        self.size = MessageDao.get_message_stat(self.user).task_count
-
-
-class PlanGroup(SystemGroup):
-    """计划类型的笔记, @since 2020/02/16"""
-
-    def __init__(self):
-        super(PlanGroup, self).__init__(u"计划列表", "/note/plan")
-        self.size = NoteDao.get_note_stat(self.user).plan_count
-
-
-class StickyGroup(SystemGroup):
-
-    def __init__(self):
-        super(StickyGroup, self).__init__(u"置顶笔记", "/note/sticky")
-        self.size = NoteDao.get_note_stat(self.user).sticky_count
-        self.icon = "fa fa-thumb-tack"
-
-
-class IndexGroup(SystemGroup):
-
-    def __init__(self):
-        super(IndexGroup, self).__init__(u"笔记索引", "/note/index")
-        self.icon = "fa fa-gear"
-
-
-class DefaultProjectGroup(SystemGroup):
-
-    def __init__(self, notes):
-        super(DefaultProjectGroup, self).__init__(u"默认项目", "/project/default")
-        self.icon = "fa fa-th-large"
-        self.size = len(notes)
-
-
-def search_group(user_name, words):
-    rows, count = note_dao.list_group_with_count(user_name)
-    result = []
-    for row in rows:
-        if textutil.contains_all(row.name, words):
-            result.append(row)
-    return result
-
-def build_note_info_for_timeline(note, url_type=""):
-    if url_type == "default":
-        return
-    
-    if note.type == "group":
-        note.url = "/note/timeline?type=default&parent_id=%s" % note.id
-
-
-def build_date_result(rows, orderby='ctime', sticky_title=False, group_title=False, archived_title=False, url_type="timeline"):
-    tmp_result = dict()
-    sticky_notes = []
-    archived_notes = []
-    group_notes = []
-
-    for row in rows:
-        if row.level == None:
-            # 可能是虚拟的对象
-            row.level = 0
-
-        build_note_info_for_timeline(row, url_type)
-        if sticky_title and row.level > 0:
-            sticky_notes.append(row)
-            continue
-
-        if archived_title and row.archived == True:
-            archived_notes.append(row)
-            continue
-
-        if group_title and row.type == "group":
-            group_notes.append(row)
-            continue
-
-        if orderby == "mtime":
-            date_time = row.mtime
-        else:
-            date_time = row.ctime
-        
-        # MySQL返回 datetime 类型
-        date_time = str(date_time)
-        title = date_time.split()[0]
-        # 优化返回数据大小
-        row.content = ""
-        if title not in tmp_result:
-            tmp_result[title] = []
-        tmp_result[title].append(row)
-
-    tmp_sorted_result = []
-    for key in tmp_result:
-        items = tmp_result[key]
-        items.sort(key=lambda x: x[orderby], reverse=True)
-        tmp_sorted_result.append(dict(title=key, children=items))
-    tmp_sorted_result.sort(key=lambda x: x['title'], reverse=True)
-
-    result = []
-
-    if len(sticky_notes) > 0:
-        # sticky_notes.sort(key = lambda x:x[orderby])
-        sticky_notes.sort(key = lambda x: x.name)
-        result.append(dict(title=u'置顶', children=sticky_notes))
-
-    if len(group_notes) > 0:
-        # group_notes.sort(key = lambda x:x[orderby])
-        group_notes.sort(key = lambda x: x.name)
-        result.append(dict(title=u'笔记本', children=group_notes))
-
-    result += tmp_sorted_result
-
-    if len(archived_notes) > 0:
-        archived_notes.sort(key = lambda x:x[orderby])
-        result.append(dict(title=u'归档', children=archived_notes))
-
-    return dict(code='success', data=result)
-
-
-def list_search_func(context: ListContext):
-    # 主要是搜索
-    offset = context['offset']
-    limit = context['limit']
-    search_key = context['search_key']
-    type = context['type']
-    user_name = context['user_name']
-    search_tag = context["search_tag"]
-    parent_id = xutils.get_argument_int("parent_id")
-    words = None
-    rows = []
-
-    start_time = time.time()
-    if search_key != None and search_key != "":
-        # TODO 公共笔记的搜索
-        search_key = xutils.unquote(search_key)
-        words = split_words(search_key)
-
-        if search_tag == "public":
-            rows = note_dao.search_public(words)
-        else:
-            rows = note_dao.search_name(words, user_name, parent_id=parent_id)
-
-        rows = rows[offset: offset + limit]
-        cost_time = time.time() - start_time
-        note_dao.add_search_history(user_name, search_key, "note", cost_time)
-
-    return build_date_result(rows, orderby='ctime', sticky_title=True, group_title=True)
-
-
-def insert_default_project(rows, user_name):
-    root_notes = note_dao.list_by_parent(
-        user_name, parent_id="0", offset=0, limit=1000, skip_group=True)
-    if len(root_notes) > 0:
-        rows.insert(0, DefaultProjectGroup(root_notes))
-
-
-def insert_task_project(rows, user_name):
-    rows.insert(0, TaskGroup())
-
-
-def list_project_func(context):
-    offset = context['offset']
-    user_name = context['user_name']
-    parent_id = context['parent_id']
-
-    if offset > 0:
-        rows = []
-    else:
-        rows = note_dao.list_group(user_name, parent_id=parent_id, orderby="name")
-        # 处理默认项目
-        insert_default_project(rows, user_name)
-        # 处理备忘录
-        insert_task_project(rows, user_name)
-
-    return build_date_result(rows, 'name', sticky_title=True, group_title=True, archived_title=True)
-
-def list_root_func(context):
-    offset = context['offset']
-    user_name = context['user_name']
-    if offset > 0:
-        rows = []
-    else:
-        rows = note_dao.list_group(user_name, parent_id=0)
-        # 处理默认项目
-        insert_default_project(rows, user_name)
-        # 处理备忘录
-        insert_task_project(rows, user_name)
-
-    return build_date_result(rows, 'mtime', sticky_title=True, group_title=True, archived_title=True)
-
-def list_public_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    rows = note_dao.list_public(offset, limit)
-    return build_date_result(rows, 'ctime')
-
-
-def list_sticky_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = note_dao.list_sticky(user_name, offset, limit)
-    return build_date_result(rows, 'ctime', group_title=False)
-
-
-def list_removed_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = note_dao.list_removed(user_name, offset, limit)
-    return build_date_result(rows, 'ctime')
-
-
-def list_archived_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = note_dao.list_archived(user_name, offset, limit)
-    return build_date_result(rows, 'ctime')
-
-
-def list_by_type_func(context):
-    type = context['type']
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    if type == "group_list":
-        type = "group"
-
-    rows = note_dao.list_by_type(user_name, type, offset, limit, orderby="ctime_desc")
-    return build_date_result(rows, 'ctime')
-
-
-def list_plan_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = note_dao.list_by_type(user_name, 'plan', offset, limit)
-    old_task = TaskGroup("待办任务(旧版)")
-    if old_task.size > 0:
-        rows.append(old_task)
-    return build_date_result(rows, 'ctime')
-
-
-def list_all_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = dao_log.list_recent_created(user_name, offset, limit)
-    return build_date_result(rows, 'ctime')
-
-
-def list_recent_edit_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = dao_log.list_recent_edit(user_name, offset, limit)
-    return build_date_result(rows, 'mtime')
-
-
-def default_list_func(context: ListContext):
-    offset = context.offset
-    limit = context.limit
-    user_name = context['user_name']
-    parent_id = context.parent_id
-    tags = None
-    
-    if context.filter_tag != "":
-        tags = [context.filter_tag]
-    
-    note_info = note_dao.get_by_id(parent_id)
-    if note_info == None:
-        return webutil.FailedResult(code="404", message="笔记不存在")
-    
-    if note_info.creator != user_name:
-        # 分享模式
-        share_info = dao_share.get_share_by_note_and_to_user(parent_id, user_name)
-        if share_info == None:
-            return webutil.FailedResult(code="403", message="无查看权限")
-    
-    rows = note_dao.list_by_parent(creator_id=note_info.creator_id, parent_id=parent_id, offset=offset, limit=limit, orderby = 'ctime_desc', tags=tags)
-    
-    orderby = "ctime"
-    if context.orderby == "name":
-        orderby = "name"
-    url_type = context.url_type
-    return build_date_result(rows, orderby=orderby, sticky_title=True, group_title=True, url_type=url_type)
-
-
-def list_root_notes_func(context):
-    offset = context['offset']
-    limit = context['limit']
-    user_name = context['user_name']
-    rows = note_dao.list_by_parent(
-        user_name, 0, offset, limit, orderby='ctime_desc', skip_group=True)
-    return build_date_result(rows, 'ctime', sticky_title=True, group_title=True)
-
-
-LIST_FUNC_DICT = {
-    'root': list_root_func,
-    'group': list_project_func,
-    'public': list_public_func,
-    'sticky': list_sticky_func,
-    'removed': list_removed_func,
-    'archived': list_archived_func,
-    'root_notes': list_root_notes_func,
-
-    'recent_edit': list_recent_edit_func,
-
-    'md': list_by_type_func,
-    'gallery': list_by_type_func,
-    'document': list_by_type_func,
-    'html': list_by_type_func,
-    'list': list_by_type_func,
-    'table': list_by_type_func,
-    'csv': list_by_type_func,
-    'log': list_by_type_func,
-    "group_list": list_by_type_func,
-
-    'plan': list_plan_func,
-    'all': list_all_func,
-    "search": list_search_func,
-}
-
-class TimelineAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        offset = xutils.get_argument_int("offset", 0)
-        limit = xutils.get_argument_int("limit", 20)
-        type = xutils.get_argument_str("type", "root")
-        parent_id = xutils.get_argument_int("parent_id")
-        search_key = xutils.get_argument_str("key")
-        orderby = xutils.get_argument_str("orderby", "mtime_desc")
-        search_tag = xutils.get_argument_str("search_tag")
-        user_info = xauth.current_user()
-        url_type = xutils.get_argument_str("url_type", "timeline")
-        assert user_info != None
-
-        kw = ListContext()
-        kw.offset = offset
-        kw.limit = limit
-        kw.type = type
-        kw.parent_id = parent_id
-        kw.search_key = search_key
-        kw.orderby = orderby
-        kw.search_tag = search_tag
-        kw.user_name = user_info.name
-        kw.user_id = user_info.id
-        kw.url_type = url_type
-        kw.filter_tag = xutils.get_argument_str("filter_tag")
-
-        list_func = LIST_FUNC_DICT.get(type, default_list_func)
-        return list_func(kw)
-
-
-class DateTimelineAjaxHandler:
-    @xauth.login_required()
-    def GET(self):
-        year = xutils.get_argument_str("year", "")
-        month = xutils.get_argument_str("month", "")
-        if len(month) == 1:
-            month = "0" + month
-        user_name = xauth.current_name()
-        rows = note_dao.list_by_date(
-            "ctime", user_name, "%s-%s" % (year, month))
-        result = dict()
-        for row in rows:
-            date = re.match(r"\d+\-\d+", row.ctime).group(0)
-            # 优化数据大小
-            row.content = ""
-            if date not in result:
-                result[date] = []
-            result[date].append(row)
-        return result
-
-
-class BaseTimelineHandler:
-
-    note_type = "group"
-    search_type = "note"
-    show_create = True
-    check_login = True
-    show_recent_btn = False
-    show_back_btn = False
-    show_create_btn = False
-    show_group_btn = False
-
-    def GET(self):
-        self.before_get()
-        return self.do_get()
-
-    def before_get(self):
-        pass
-
-    def handle_type_all(self):
-        self.show_create_btn = False
-        self.show_group_btn = True
-    
-    def handle_type_group_list(self):
-        self.show_create_btn = False
-
-    def get_handle_by_type(self, type):
-        if type == "all":
-            return self.handle_type_all
-        if type == "group_list":
-            return self.handle_type_group_list
-        return None
-
-    def do_get(self):
-        type = xutils.get_argument_str("type", self.note_type)
-        parent_id = xutils.get_argument_str("parent_id", "0")
-        key = xutils.get_argument_str("key", "")
-        title = u"最新笔记"
-
-        # 检查登录态
-        if self.check_login:
-            xauth.check_login()
-
-        if type == "search" and key == "":
-            raise web.found("/search")
-
-        user_name = xauth.current_name_str()
-        title = NOTE_TYPE_DICT.get(type, u"最新笔记")
-        title_link = None
-        note_priority = 0
-        file = NoteDao.get_by_id(parent_id)
-    
-        handle = self.get_handle_by_type(type)
-        if handle != None:
-            handle()
-
-        xmanager.add_visit_log(user_name, webutil.get_request_path())
-
-        if file != None:
-            title = T("笔记列表")
-            title_link = PathLink(file.name, file.url)
-            note_priority = file.priority
-
-        pathlist = []
-        parent_link = get_parent_link(user_name, type, note_priority)
-
-        if parent_link != None:
-            pathlist.append(parent_link)
-
-        if title_link != None:
-            pathlist.append(title_link)
-
-        kw = Storage()
-        kw.show_aside = False
-        kw.show_recent_btn = self.show_recent_btn
-        kw.show_back_btn = self.show_back_btn
-        kw.show_create_btn = self.show_create_btn
-        kw.show_group_btn = self.show_group_btn
-        if parent_id == "0":
-            kw.show_rename_btn = False
-        kw.type = type
-        kw.file = file
-        kw.title = title
-        kw.title_link = title_link
-        kw.parent_link = parent_link
-        kw.show_create = self.show_create
-        kw.search_type = self.search_type
-        kw.search_ext_dict = dict(parent_id=parent_id)
-        kw.key = key
-        kw.pathlist = pathlist
-        kw.CREATE_BTN_TEXT_DICT = CREATE_BTN_TEXT_DICT
-
-        return xtemplate.render("note/page/timeline/timeline.html",**kw)
-
-
-class TimelineHandler(BaseTimelineHandler):
-    note_type = "group"
-    show_create_btn = True
-
-    def before_get(self):
-        parent_id = xutils.get_argument_int("parent_id")
-        if parent_id == 0:
-            self.show_recent_btn = True
-
-
-class TimelineRecentHandler(BaseTimelineHandler):
-    note_type = "all"
-    show_recent_btn = False
-    show_back_btn = True
-    show_create_btn = False
-
-
-class PublicTimelineHandler(TimelineHandler):
-    """公共笔记的时光轴视图"""
-    note_type = "public"
-    check_login = False
-    show_create = False
-    search_type = "note.public"
-
-
-class GalleryListHandler(BaseTimelineHandler):
-    note_type = "gallery"
-
-
-class TableListHandler(BaseTimelineHandler):
-    note_type = "csv"
-
-
-class HtmlListHandler(BaseTimelineHandler):
-    note_type = "html"
-
-
-class MarkdownListHandler(BaseTimelineHandler):
-    note_type = "md"
-
-
-class DocumentListHandler(BaseTimelineHandler):
-    note_type = "document"
-
-
-class LogListHandler(BaseTimelineHandler):
-    note_type = "log"
-
-
-class ListNoteHandler(BaseTimelineHandler):
-    note_type = "list"
-
-
-class PlanListHandler(BaseTimelineHandler):
-    note_type = "plan"
-
-
-class StickyHandler(BaseTimelineHandler):
-    note_type = "sticky"
-
-
-class RemovedHandler(BaseTimelineHandler):
-    note_type = "removed"
-
-
-class DefaultProjectHandler(BaseTimelineHandler):
-    note_type = "root_notes"
-    show_create = False
-
-
-class DateHandler:
-
-    type_order_dict = {
-        "group":  0,
-        "gallery": 10,
-        "list": 20,
-        "table": 30,
-        "csv": 30,
-        "md": 90,
-    }
-
-    def sort_notes(self, notes):
-        notes.sort(key=lambda x: self.type_order_dict.get(x.type, 100))
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name()
-        show_back = xutils.get_argument("show_back", "")
-        date = xutils.get_argument("date", time.strftime("%Y-%m"))
-
-        assert isinstance(user_name, str)
-        assert isinstance(date, str)
-
-        xmanager.add_visit_log(
-            user_name, "/note/date?show_back=%s" % show_back)
-
-        parts = date.split("-")
-        if len(parts) == 2:
-            year = int(parts[0])
-            month = int(parts[1])
-        else:
-            year = int(parts[0])
-            month = dateutil.get_current_month()
-
-        notes = []
-        # 待办任务
-        notes.append(MessageDao.get_message_tag(user_name, "task", priority=2))
-        notes.append(MessageDao.get_message_tag(user_name, "log",  priority=2))
-        notes.append(SystemGroup(
-            "我的人生", "/note/view?skey=my_life", priority=2))
-        notes.append(SystemGroup("我的年报:%s" % year, "/note/view?skey=year_%s" % year,
-                                 priority=2))
-        notes.append(SystemGroup("我的月报:%s" % date, "/note/view?skey=month_%s" % date,
-                                 priority=2))
-
-        notes_new = note_dao.list_by_date("ctime", user_name, date)
-        notes = notes + notes_new
-        notes_by_date = note_helper.assemble_notes_by_date(notes)
-
-        kw = Storage()
-        kw.html_title = T("我的笔记")
-        kw.date = date
-        kw.year = year
-        kw.month = month
-        kw.notes_by_date = notes_by_date
-        kw.show_back = show_back
-        kw.search_type = "default"
-
-        return xtemplate.render("note/page/list_by_date.html", **kw)
-
-
-xutils.register_func("note.build_date_result", build_date_result)
-
-xurls = (
-    r"/note/api/timeline", TimelineAjaxHandler,
-
-    # 时光轴视图
-    r"/note/timeline", TimelineHandler,
-    r"/note/timeline/recent", TimelineRecentHandler,
-    r"/note/timeline/month", DateTimelineAjaxHandler,
-    
-    r"/note/plan", PlanListHandler,
-    r"/project/default", DefaultProjectHandler,
-
-    # 日期视图
-    r"/note/monthly", DateHandler,
-)
+# -*- coding:utf-8 -*-
+# Created by xupingmao on 2017/05/18
+# @modified 2022/01/27 21:40:22
+
+"""时光轴视图"""
+import re
+import xutils
+from xnote.core import xauth
+from xnote.core import xtemplate
+import time
+import web
+from xutils import Storage, dateutil, textutil
+from xutils import webutil
+from xutils.textutil import split_words
+from xnote.core.xtemplate import T
+from handlers.note.constant import *
+from handlers.message.dao import MessageDao
+from handlers.note.dao_api import NoteDao
+from handlers.note import note_helper, dao_share
+import handlers.note.dao as note_dao
+import handlers.note.dao_log as dao_log
+from xnote.core import xmanager
+
+
+class PathLink:
+
+    def __init__(self, name, url):
+        self.name = name
+        self.url = url
+
+class ListContext(Storage):
+    def __init__(self,**kw):
+        self.offset = 0
+        self.limit = 0
+        self.type = ""
+        self.parent_id = 0
+        self.search_key = ""
+        self.orderby = ""
+        self.search_tag = ""
+        self.filter_tag = "" # 笔记过滤的tag
+        self.user_name = ""
+        self.user_id = 0
+        self.url_type = ""
+        self.update(kw)
+
+def get_parent_link(user_name, type, priority=0):
+    if priority < 0:
+        return PathLink(T("Archived_Project"), "/note/archived")
+    if type == "default" or type == "root_notes":
+        return PathLink(u"根目录", "/note/timeline?type=group_list&orderby=name")
+    if type == "public":
+        return None
+    return None
+
+
+class SystemGroup(Storage):
+    def __init__(self, name, url, priority=1, icon="fa fa-file-text-o"):
+        super(SystemGroup, self).__init__()
+        self.user = xauth.current_name()
+        self.type = 'system'
+        self.icon = icon
+        self.name = name
+        self.url = url
+        self.priority = priority
+        self.level = priority
+        self.size = 0
+        self.mtime = dateutil.format_datetime()
+
+
+class TaskGroup(Storage):
+    def __init__(self, name="待办任务"):
+        super(TaskGroup, self).__init__()
+        self.user = xauth.current_name()
+        self.type = 'system'
+        self.name = name
+        self.icon = "fa-calendar-check-o"
+        self.ctime = dateutil.format_time()
+        self.mtime = dateutil.format_time()
+        self.url = "/message?tag=task"
+        self.priority = 1
+        self.level = self.priority
+        self.size = MessageDao.get_message_stat(self.user).task_count
+
+
+class PlanGroup(SystemGroup):
+    """计划类型的笔记, @since 2020/02/16"""
+
+    def __init__(self):
+        super(PlanGroup, self).__init__(u"计划列表", "/note/plan")
+        self.size = NoteDao.get_note_stat(self.user).plan_count
+
+
+class StickyGroup(SystemGroup):
+
+    def __init__(self):
+        super(StickyGroup, self).__init__(u"置顶笔记", "/note/sticky")
+        self.size = NoteDao.get_note_stat(self.user).sticky_count
+        self.icon = "fa fa-thumb-tack"
+
+
+class IndexGroup(SystemGroup):
+
+    def __init__(self):
+        super(IndexGroup, self).__init__(u"笔记索引", "/note/index")
+        self.icon = "fa fa-gear"
+
+
+class DefaultProjectGroup(SystemGroup):
+
+    def __init__(self, notes):
+        super(DefaultProjectGroup, self).__init__(u"默认项目", "/project/default")
+        self.icon = "fa fa-th-large"
+        self.size = len(notes)
+
+
+def search_group(user_name, words):
+    rows, count = note_dao.list_group_with_count(user_name)
+    result = []
+    for row in rows:
+        if textutil.contains_all(row.name, words):
+            result.append(row)
+    return result
+
+def build_note_info_for_timeline(note, url_type=""):
+    if url_type == "default":
+        return
+    
+    if note.type == "group":
+        note.url = "/note/timeline?type=default&parent_id=%s" % note.id
+
+
+def build_date_result(rows, orderby='ctime', sticky_title=False, group_title=False, archived_title=False, url_type="timeline"):
+    tmp_result = dict()
+    sticky_notes = []
+    archived_notes = []
+    group_notes = []
+
+    for row in rows:
+        if row.level == None:
+            # 可能是虚拟的对象
+            row.level = 0
+
+        build_note_info_for_timeline(row, url_type)
+        if sticky_title and row.level > 0:
+            sticky_notes.append(row)
+            continue
+
+        if archived_title and row.archived == True:
+            archived_notes.append(row)
+            continue
+
+        if group_title and row.type == "group":
+            group_notes.append(row)
+            continue
+
+        if orderby == "mtime":
+            date_time = row.mtime
+        else:
+            date_time = row.ctime
+        
+        # MySQL返回 datetime 类型
+        date_time = str(date_time)
+        title = date_time.split()[0]
+        # 优化返回数据大小
+        row.content = ""
+        if title not in tmp_result:
+            tmp_result[title] = []
+        tmp_result[title].append(row)
+
+    tmp_sorted_result = []
+    for key in tmp_result:
+        items = tmp_result[key]
+        items.sort(key=lambda x: x[orderby], reverse=True)
+        tmp_sorted_result.append(dict(title=key, children=items))
+    tmp_sorted_result.sort(key=lambda x: x['title'], reverse=True)
+
+    result = []
+
+    if len(sticky_notes) > 0:
+        # sticky_notes.sort(key = lambda x:x[orderby])
+        sticky_notes.sort(key = lambda x: x.name)
+        result.append(dict(title=u'置顶', children=sticky_notes))
+
+    if len(group_notes) > 0:
+        # group_notes.sort(key = lambda x:x[orderby])
+        group_notes.sort(key = lambda x: x.name)
+        result.append(dict(title=u'笔记本', children=group_notes))
+
+    result += tmp_sorted_result
+
+    if len(archived_notes) > 0:
+        archived_notes.sort(key = lambda x:x[orderby])
+        result.append(dict(title=u'归档', children=archived_notes))
+
+    return dict(code='success', data=result)
+
+
+def list_search_func(context: ListContext):
+    # 主要是搜索
+    offset = context['offset']
+    limit = context['limit']
+    search_key = context['search_key']
+    type = context['type']
+    user_name = context['user_name']
+    search_tag = context["search_tag"]
+    parent_id = xutils.get_argument_int("parent_id")
+    words = None
+    rows = []
+
+    start_time = time.time()
+    if search_key != None and search_key != "":
+        # TODO 公共笔记的搜索
+        search_key = xutils.unquote(search_key)
+        words = split_words(search_key)
+
+        if search_tag == "public":
+            rows = note_dao.search_public(words)
+        else:
+            rows = note_dao.search_name(words, user_name, parent_id=parent_id)
+
+        rows = rows[offset: offset + limit]
+        cost_time = time.time() - start_time
+        note_dao.add_search_history(user_name, search_key, "note", cost_time)
+
+    return build_date_result(rows, orderby='ctime', sticky_title=True, group_title=True)
+
+
+def insert_default_project(rows, user_name):
+    root_notes = note_dao.list_by_parent(
+        user_name, parent_id="0", offset=0, limit=1000, skip_group=True)
+    if len(root_notes) > 0:
+        rows.insert(0, DefaultProjectGroup(root_notes))
+
+
+def insert_task_project(rows, user_name):
+    rows.insert(0, TaskGroup())
+
+
+def list_project_func(context):
+    offset = context['offset']
+    user_name = context['user_name']
+    parent_id = context['parent_id']
+
+    if offset > 0:
+        rows = []
+    else:
+        rows = note_dao.list_group(user_name, parent_id=parent_id, orderby="name")
+        # 处理默认项目
+        insert_default_project(rows, user_name)
+        # 处理备忘录
+        insert_task_project(rows, user_name)
+
+    return build_date_result(rows, 'name', sticky_title=True, group_title=True, archived_title=True)
+
+def list_root_func(context):
+    offset = context['offset']
+    user_name = context['user_name']
+    if offset > 0:
+        rows = []
+    else:
+        rows = note_dao.list_group(user_name, parent_id=0)
+        # 处理默认项目
+        insert_default_project(rows, user_name)
+        # 处理备忘录
+        insert_task_project(rows, user_name)
+
+    return build_date_result(rows, 'mtime', sticky_title=True, group_title=True, archived_title=True)
+
+def list_public_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    rows = note_dao.list_public(offset, limit)
+    return build_date_result(rows, 'ctime')
+
+
+def list_sticky_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = note_dao.list_sticky(user_name, offset, limit)
+    return build_date_result(rows, 'ctime', group_title=False)
+
+
+def list_removed_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = note_dao.list_removed(user_name, offset, limit)
+    return build_date_result(rows, 'ctime')
+
+
+def list_archived_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = note_dao.list_archived(user_name, offset, limit)
+    return build_date_result(rows, 'ctime')
+
+
+def list_by_type_func(context):
+    type = context['type']
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    if type == "group_list":
+        type = "group"
+
+    rows = note_dao.list_by_type(user_name, type, offset, limit, orderby="ctime_desc")
+    return build_date_result(rows, 'ctime')
+
+
+def list_plan_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = note_dao.list_by_type(user_name, 'plan', offset, limit)
+    old_task = TaskGroup("待办任务(旧版)")
+    if old_task.size > 0:
+        rows.append(old_task)
+    return build_date_result(rows, 'ctime')
+
+
+def list_all_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = dao_log.list_recent_created(user_name, offset, limit)
+    return build_date_result(rows, 'ctime')
+
+
+def list_recent_edit_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = dao_log.list_recent_edit(user_name, offset, limit)
+    return build_date_result(rows, 'mtime')
+
+
+def default_list_func(context: ListContext):
+    offset = context.offset
+    limit = context.limit
+    user_name = context['user_name']
+    parent_id = context.parent_id
+    tags = None
+    
+    if context.filter_tag != "":
+        tags = [context.filter_tag]
+    
+    note_info = note_dao.get_by_id(parent_id)
+    if note_info == None:
+        return webutil.FailedResult(code="404", message="笔记不存在")
+    
+    if note_info.creator != user_name:
+        # 分享模式
+        share_info = dao_share.get_share_by_note_and_to_user(parent_id, user_name)
+        if share_info == None:
+            return webutil.FailedResult(code="403", message="无查看权限")
+    
+    rows = note_dao.list_by_parent(creator_id=note_info.creator_id, parent_id=parent_id, offset=offset, limit=limit, orderby = 'ctime_desc', tags=tags)
+    
+    orderby = "ctime"
+    if context.orderby == "name":
+        orderby = "name"
+    url_type = context.url_type
+    return build_date_result(rows, orderby=orderby, sticky_title=True, group_title=True, url_type=url_type)
+
+
+def list_root_notes_func(context):
+    offset = context['offset']
+    limit = context['limit']
+    user_name = context['user_name']
+    rows = note_dao.list_by_parent(
+        user_name, 0, offset, limit, orderby='ctime_desc', skip_group=True)
+    return build_date_result(rows, 'ctime', sticky_title=True, group_title=True)
+
+
+LIST_FUNC_DICT = {
+    'root': list_root_func,
+    'group': list_project_func,
+    'public': list_public_func,
+    'sticky': list_sticky_func,
+    'removed': list_removed_func,
+    'archived': list_archived_func,
+    'root_notes': list_root_notes_func,
+
+    'recent_edit': list_recent_edit_func,
+
+    'md': list_by_type_func,
+    'gallery': list_by_type_func,
+    'document': list_by_type_func,
+    'html': list_by_type_func,
+    'list': list_by_type_func,
+    'table': list_by_type_func,
+    'csv': list_by_type_func,
+    'log': list_by_type_func,
+    "group_list": list_by_type_func,
+
+    'plan': list_plan_func,
+    'all': list_all_func,
+    "search": list_search_func,
+}
+
+class TimelineAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        offset = xutils.get_argument_int("offset", 0)
+        limit = xutils.get_argument_int("limit", 20)
+        type = xutils.get_argument_str("type", "root")
+        parent_id = xutils.get_argument_int("parent_id")
+        search_key = xutils.get_argument_str("key")
+        orderby = xutils.get_argument_str("orderby", "mtime_desc")
+        search_tag = xutils.get_argument_str("search_tag")
+        user_info = xauth.current_user()
+        url_type = xutils.get_argument_str("url_type", "timeline")
+        assert user_info != None
+
+        kw = ListContext()
+        kw.offset = offset
+        kw.limit = limit
+        kw.type = type
+        kw.parent_id = parent_id
+        kw.search_key = search_key
+        kw.orderby = orderby
+        kw.search_tag = search_tag
+        kw.user_name = user_info.name
+        kw.user_id = user_info.id
+        kw.url_type = url_type
+        kw.filter_tag = xutils.get_argument_str("filter_tag")
+
+        list_func = LIST_FUNC_DICT.get(type, default_list_func)
+        return list_func(kw)
+
+
+class DateTimelineAjaxHandler:
+    @xauth.login_required()
+    def GET(self):
+        year = xutils.get_argument_str("year", "")
+        month = xutils.get_argument_str("month", "")
+        if len(month) == 1:
+            month = "0" + month
+        user_name = xauth.current_name()
+        rows = note_dao.list_by_date(
+            "ctime", user_name, "%s-%s" % (year, month))
+        result = dict()
+        for row in rows:
+            date = re.match(r"\d+\-\d+", row.ctime).group(0)
+            # 优化数据大小
+            row.content = ""
+            if date not in result:
+                result[date] = []
+            result[date].append(row)
+        return result
+
+
+class BaseTimelineHandler:
+
+    note_type = "group"
+    search_type = "note"
+    show_create = True
+    check_login = True
+    show_recent_btn = False
+    show_back_btn = False
+    show_create_btn = False
+    show_group_btn = False
+
+    def GET(self):
+        self.before_get()
+        return self.do_get()
+
+    def before_get(self):
+        pass
+
+    def handle_type_all(self):
+        self.show_create_btn = False
+        self.show_group_btn = True
+    
+    def handle_type_group_list(self):
+        self.show_create_btn = False
+
+    def get_handle_by_type(self, type):
+        if type == "all":
+            return self.handle_type_all
+        if type == "group_list":
+            return self.handle_type_group_list
+        return None
+
+    def do_get(self):
+        type = xutils.get_argument_str("type", self.note_type)
+        parent_id = xutils.get_argument_str("parent_id", "0")
+        key = xutils.get_argument_str("key", "")
+        title = u"最新笔记"
+
+        # 检查登录态
+        if self.check_login:
+            xauth.check_login()
+
+        if type == "search" and key == "":
+            raise web.found("/search")
+
+        user_name = xauth.current_name_str()
+        title = NOTE_TYPE_DICT.get(type, u"最新笔记")
+        title_link = None
+        note_priority = 0
+        file = NoteDao.get_by_id(parent_id)
+    
+        handle = self.get_handle_by_type(type)
+        if handle != None:
+            handle()
+
+        xmanager.add_visit_log(user_name, webutil.get_request_path())
+
+        if file != None:
+            title = T("笔记列表")
+            title_link = PathLink(file.name, file.url)
+            note_priority = file.priority
+
+        pathlist = []
+        parent_link = get_parent_link(user_name, type, note_priority)
+
+        if parent_link != None:
+            pathlist.append(parent_link)
+
+        if title_link != None:
+            pathlist.append(title_link)
+
+        kw = Storage()
+        kw.show_aside = False
+        kw.show_recent_btn = self.show_recent_btn
+        kw.show_back_btn = self.show_back_btn
+        kw.show_create_btn = self.show_create_btn
+        kw.show_group_btn = self.show_group_btn
+        if parent_id == "0":
+            kw.show_rename_btn = False
+        kw.type = type
+        kw.file = file
+        kw.title = title
+        kw.title_link = title_link
+        kw.parent_link = parent_link
+        kw.show_create = self.show_create
+        kw.search_type = self.search_type
+        kw.search_ext_dict = dict(parent_id=parent_id)
+        kw.key = key
+        kw.pathlist = pathlist
+        kw.CREATE_BTN_TEXT_DICT = CREATE_BTN_TEXT_DICT
+
+        return xtemplate.render("note/page/timeline/timeline.html",**kw)
+
+
+class TimelineHandler(BaseTimelineHandler):
+    note_type = "group"
+    show_create_btn = True
+
+    def before_get(self):
+        parent_id = xutils.get_argument_int("parent_id")
+        if parent_id == 0:
+            self.show_recent_btn = True
+
+
+class TimelineRecentHandler(BaseTimelineHandler):
+    note_type = "all"
+    show_recent_btn = False
+    show_back_btn = True
+    show_create_btn = False
+
+
+class PublicTimelineHandler(TimelineHandler):
+    """公共笔记的时光轴视图"""
+    note_type = "public"
+    check_login = False
+    show_create = False
+    search_type = "note.public"
+
+
+class GalleryListHandler(BaseTimelineHandler):
+    note_type = "gallery"
+
+
+class TableListHandler(BaseTimelineHandler):
+    note_type = "csv"
+
+
+class HtmlListHandler(BaseTimelineHandler):
+    note_type = "html"
+
+
+class MarkdownListHandler(BaseTimelineHandler):
+    note_type = "md"
+
+
+class DocumentListHandler(BaseTimelineHandler):
+    note_type = "document"
+
+
+class LogListHandler(BaseTimelineHandler):
+    note_type = "log"
+
+
+class ListNoteHandler(BaseTimelineHandler):
+    note_type = "list"
+
+
+class PlanListHandler(BaseTimelineHandler):
+    note_type = "plan"
+
+
+class StickyHandler(BaseTimelineHandler):
+    note_type = "sticky"
+
+
+class RemovedHandler(BaseTimelineHandler):
+    note_type = "removed"
+
+
+class DefaultProjectHandler(BaseTimelineHandler):
+    note_type = "root_notes"
+    show_create = False
+
+
+class DateHandler:
+
+    type_order_dict = {
+        "group":  0,
+        "gallery": 10,
+        "list": 20,
+        "table": 30,
+        "csv": 30,
+        "md": 90,
+    }
+
+    def sort_notes(self, notes):
+        notes.sort(key=lambda x: self.type_order_dict.get(x.type, 100))
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name()
+        show_back = xutils.get_argument("show_back", "")
+        date = xutils.get_argument("date", time.strftime("%Y-%m"))
+
+        assert isinstance(user_name, str)
+        assert isinstance(date, str)
+
+        xmanager.add_visit_log(
+            user_name, "/note/date?show_back=%s" % show_back)
+
+        parts = date.split("-")
+        if len(parts) == 2:
+            year = int(parts[0])
+            month = int(parts[1])
+        else:
+            year = int(parts[0])
+            month = dateutil.get_current_month()
+
+        notes = []
+        # 待办任务
+        notes.append(MessageDao.get_message_tag(user_name, "task", priority=2))
+        notes.append(MessageDao.get_message_tag(user_name, "log",  priority=2))
+        notes.append(SystemGroup(
+            "我的人生", "/note/view?skey=my_life", priority=2))
+        notes.append(SystemGroup("我的年报:%s" % year, "/note/view?skey=year_%s" % year,
+                                 priority=2))
+        notes.append(SystemGroup("我的月报:%s" % date, "/note/view?skey=month_%s" % date,
+                                 priority=2))
+
+        notes_new = note_dao.list_by_date("ctime", user_name, date)
+        notes = notes + notes_new
+        notes_by_date = note_helper.assemble_notes_by_date(notes)
+
+        kw = Storage()
+        kw.html_title = T("我的笔记")
+        kw.date = date
+        kw.year = year
+        kw.month = month
+        kw.notes_by_date = notes_by_date
+        kw.show_back = show_back
+        kw.search_type = "default"
+
+        return xtemplate.render("note/page/list_by_date.html", **kw)
+
+
+xutils.register_func("note.build_date_result", build_date_result)
+
+xurls = (
+    r"/note/api/timeline", TimelineAjaxHandler,
+
+    # 时光轴视图
+    r"/note/timeline", TimelineHandler,
+    r"/note/timeline/recent", TimelineRecentHandler,
+    r"/note/timeline/month", DateTimelineAjaxHandler,
+    
+    r"/note/plan", PlanListHandler,
+    r"/project/default", DefaultProjectHandler,
+
+    # 日期视图
+    r"/note/monthly", DateHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/note/note_workspace.py` & `xnote-web-0.1.1/handlers/note/note_workspace.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/batch/gallery_manage.html` & `xnote-web-0.1.1/handlers/note/page/batch/gallery_manage.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/batch/group_manage.html` & `xnote-web-0.1.1/handlers/note/page/batch/group_manage.html`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,229 +1,229 @@
-{% extends base.html %}
-<!--
-@author xupingmao
-@since 2020/01/06
-@modified 2021/07/31 10:38:21
--->
-
-{% block body_left %}
-
-{% init show_note_path = True %}
-{% init note_tags = dict() %}
-{% include note/component/script/create_script.html %}
-{% include note/component/script/tag_script.html %}
-
-<!-- 顶层控制区域的模板 -->
-<script type="text/template" id="tagTopTemplate">
-    <div class="card btn-line-height">
-        <div class="row">
-            <span>标签</span>
-            <a href="?" class="tag lightgray large {% if len(q_tags) == 0 %}active{%end%}" onclick="onClickTagFilter(this);">全部</a>
-            {{! each tagList tag }}
-                <a class="tag lightgray meta large {{!tag.active}}" onclick="onClickTagFilter(this);">{{! tag.tag_name }}</a>
-            {{!/each}}
-        </div>
-
-        <div class="row top-offset-1">
-            <button class="create-tag-btn btn-default">创建新标签</button>
-            <button class="delete-tag-btn btn danger" onclick="xnote.action.note.deleteTagMeta(xnote.note.tagList)">删除标签</button>
-        </div>
-    </div>
-</script>
-
-{% include note/component/script/note_template.html %}
-
-<div class="card note-list">
-
-    <!-- header -->
-    <div class="row card-title btn-line-height">
-        <span>笔记本管理</span>
-        <div class="float-right">
-            <button class="btn btn-default" onclick="xnote.createNotebook()">新建笔记本</button>
-            {% include common/button/back_button.html %}
-        </div>
-    </div>
-</div>
-
-<div class="tag-top"></div>
-
-<div class="card">
-    {% if len(notes) == 0 %}
-        {% include common/text/empty_text.html %}
-    {% end %}
-    
-    {% for item in notes %}
-        <div class="book-item">
-            <div class="row">
-                {% if item.priority>0 %}
-                    <span class="tag orange">置顶</span>
-                {% end %}
-
-                {% if item.priority==0 %}
-                    <span class="tag info">活跃</span>
-                {% end %}
-            
-                {% if item.priority<0 %}
-                    <span class="tag system">归档</span>
-                {% end %}
-
-                <i class="fa {{item.icon}} fa-{{item.icon}} black"></i>
-                <a class="link2" href="{{_server_home}}{{item.url}}">{{item.name}}</a>
-                
-                <span class="float-right">
-                    <a class="item-option" data-id="{{item.id}}" data-name="{{item.name}}" 
-                        onclick="renameNoteByAttr(this);" href="javascript:void(0);">重命名</a>
-                    <input type="checkbox" data-id="{{item.id}}" data-name="{{item.name}}"/>
-                </span>
-            </div>
-
-            <div class="row">
-                <span>标签</span>
-                {% for tag in item.tag_info_list %}
-                    <a class="tag lightgray">{{tag.name}}</a>
-                {% end %}
-                <button class="btn btn-default bind-tag-btn"
-                    data-parent-id="{{item.parent_id}}"
-                    data-tag-type="group"
-                    data-id="{{item.id}}"
-                    data-tags="{{item.tags_json}}"
-                    onclick="xnote.action.note.editNoteTag(this);">+标签</button>
-                
-            </div>
-        </div>
-    {% end %}
-</div>
-
-{% include note/component/script/rename_script.html %}
-
-<script type="text/javascript">
-(function() {
-    var tagList = [];
-
-    function renderTagTop(tagList) {
-        var html = $("#tagTopTemplate").render({
-            tagList: tagList,
-        });
-
-        $(".tag-top").html(html);
-    }
-
-    function refreshTagTop() {
-        var filterTags = JSON.parse(xnote.getUrlParam("tags", "[]"));
-
-        xnote.http.get("/note/tag/list?tag_type=group", function (resp) {
-            console.log("resp", resp);
-            if (resp.code != "success") {
-                xnote.alert(resp.message);
-            } else {
-                // self.tagList = resp.data;
-                tagList = resp.data;
-                xnote.note.tagList = tagList;
-                for (var i=0; i < tagList.length; i++) {
-                    var item = tagList[i];
-                    if (filterTags.indexOf(item.tag_name)>=0) {
-                        item.active = "active";
-                    } else {
-                        item.active = "";
-                    }
-                }
-                renderTagTop(tagList);
-            }
-        });
-    };
-
-    refreshTagTop();
-
-    window.onClickTagFilter = function(target) {
-        var me = $(target);
-        var tagName = me.text();
-        var tagId = me.attr("data-id");
-
-        me.toggleClass("active");
-
-        if (me.hasClass("meta")) {
-            // 筛选模式
-            // 筛选模式使用单选更好
-            var filterTags = [tagName];
-            location.href = xnote.addUrlParam(location.href, "tags", JSON.stringify(filterTags));
-        }
-
-    };
-
-    $(".update-category").change(function (e) {
-        var noteId = $(this).attr("data-id");
-        var newCat = $(this).val();
-        xnote.updateNoteCategory({
-            noteId: noteId,
-            value: newCat,
-            doRefresh: true,
-        });
-    });
-
-    $(".switch-category").change(function(e) {
-        var selected = $(this).val();
-        var url = window.location.href;
-        url = xnote.addUrlParam(url, "category", selected);
-        window.location.href = url;
-    });
-
-    $(".bind-tag-btn-old").click(function (e) {
-        var selectedNameList = JSON.parse($(e.target).attr("data-tags"));
-        var html = $("#bindTagTemplate").render({
-            tagList: tagList,
-            selectedNames: selectedNameList
-        });
-
-        var group_id = $(e.target).attr("data-id");
-
-        console.log("bind-tag-dialog", html);
-
-        xnote.openDialog("添加标签", html, ["确定", "取消"], function () {
-            var selectedNames = [];
-            $(".tag.bind.active").each(function (idx, ele) {
-                var tagName = $(ele).text().trim();
-                selectedNames.push(tagName);
-            });
-
-            var bindParams = {
-                tag_type:"group",
-                group_id:group_id,
-                tag_names: JSON.stringify(selectedNames),
-            };
-
-            xnote.http.post("/note/tag/bind", bindParams, function (resp) {
-                if (resp.code != "success") {
-                    xnote.alert(resp.message);
-                } else {
-                    xnote.toast("添加标签成功");
-                }
-                location.reload();
-            });
-        });
-    });
-
-    $("body").on("click", ".create-tag-btn", function (e) {
-        xnote.prompt("创建新标签", "", function (text) {
-            var params = {
-                tag_type: "group",
-                tag_name: text
-            };
-            $.post("/note/tag/create", params, function (resp) {
-                if (resp.code != "success") {
-                    xnote.alert(resp.message);
-                } else {
-                    xnote.toast("创建成功");
-                }
-                refreshTagTop();
-            });
-        });
-    });
-})();
-
-</script>
-
-{% end %}
-
-
-{% block body_right %}
-    {% include note/component/sidebar/group_manage_sidebar.html %}
+{% extends base.html %}
+<!--
+@author xupingmao
+@since 2020/01/06
+@modified 2021/07/31 10:38:21
+-->
+
+{% block body_left %}
+
+{% init show_note_path = True %}
+{% init note_tags = dict() %}
+{% include note/component/script/create_script.html %}
+{% include note/component/script/tag_script.html %}
+
+<!-- 顶层控制区域的模板 -->
+<script type="text/template" id="tagTopTemplate">
+    <div class="card btn-line-height">
+        <div class="row">
+            <span>标签</span>
+            <a href="?" class="tag lightgray large {% if len(q_tags) == 0 %}active{%end%}" onclick="onClickTagFilter(this);">全部</a>
+            {{! each tagList tag }}
+                <a class="tag lightgray meta large {{!tag.active}}" onclick="onClickTagFilter(this);">{{! tag.tag_name }}</a>
+            {{!/each}}
+        </div>
+
+        <div class="row top-offset-1">
+            <button class="create-tag-btn btn-default">创建新标签</button>
+            <button class="delete-tag-btn btn danger" onclick="xnote.action.note.deleteTagMeta(xnote.note.tagList)">删除标签</button>
+        </div>
+    </div>
+</script>
+
+{% include note/component/script/note_template.html %}
+
+<div class="card note-list">
+
+    <!-- header -->
+    <div class="row card-title btn-line-height">
+        <span>笔记本管理</span>
+        <div class="float-right">
+            <button class="btn btn-default" onclick="xnote.createNotebook()">新建笔记本</button>
+            {% include common/button/back_button.html %}
+        </div>
+    </div>
+</div>
+
+<div class="tag-top"></div>
+
+<div class="card">
+    {% if len(notes) == 0 %}
+        {% include common/text/empty_text.html %}
+    {% end %}
+    
+    {% for item in notes %}
+        <div class="book-item">
+            <div class="row">
+                {% if item.priority>0 %}
+                    <span class="tag orange">置顶</span>
+                {% end %}
+
+                {% if item.priority==0 %}
+                    <span class="tag info">活跃</span>
+                {% end %}
+            
+                {% if item.priority<0 %}
+                    <span class="tag system">归档</span>
+                {% end %}
+
+                <i class="fa {{item.icon}} fa-{{item.icon}} black"></i>
+                <a class="link2" href="{{_server_home}}{{item.url}}">{{item.name}}</a>
+                
+                <span class="float-right">
+                    <a class="item-option" data-id="{{item.id}}" data-name="{{item.name}}" 
+                        onclick="renameNoteByAttr(this);" href="javascript:void(0);">重命名</a>
+                    <input type="checkbox" data-id="{{item.id}}" data-name="{{item.name}}"/>
+                </span>
+            </div>
+
+            <div class="row">
+                <span>标签</span>
+                {% for tag in item.tag_info_list %}
+                    <a class="tag lightgray">{{tag.name}}</a>
+                {% end %}
+                <button class="btn btn-default bind-tag-btn"
+                    data-parent-id="{{item.parent_id}}"
+                    data-tag-type="group"
+                    data-id="{{item.id}}"
+                    data-tags="{{item.tags_json}}"
+                    onclick="xnote.action.note.editNoteTag(this);">+标签</button>
+                
+            </div>
+        </div>
+    {% end %}
+</div>
+
+{% include note/component/script/rename_script.html %}
+
+<script type="text/javascript">
+(function() {
+    var tagList = [];
+
+    function renderTagTop(tagList) {
+        var html = $("#tagTopTemplate").render({
+            tagList: tagList,
+        });
+
+        $(".tag-top").html(html);
+    }
+
+    function refreshTagTop() {
+        var filterTags = JSON.parse(xnote.getUrlParam("tags", "[]"));
+
+        xnote.http.get("/note/tag/list?tag_type=group", function (resp) {
+            console.log("resp", resp);
+            if (resp.code != "success") {
+                xnote.alert(resp.message);
+            } else {
+                // self.tagList = resp.data;
+                tagList = resp.data;
+                xnote.note.tagList = tagList;
+                for (var i=0; i < tagList.length; i++) {
+                    var item = tagList[i];
+                    if (filterTags.indexOf(item.tag_name)>=0) {
+                        item.active = "active";
+                    } else {
+                        item.active = "";
+                    }
+                }
+                renderTagTop(tagList);
+            }
+        });
+    };
+
+    refreshTagTop();
+
+    window.onClickTagFilter = function(target) {
+        var me = $(target);
+        var tagName = me.text();
+        var tagId = me.attr("data-id");
+
+        me.toggleClass("active");
+
+        if (me.hasClass("meta")) {
+            // 筛选模式
+            // 筛选模式使用单选更好
+            var filterTags = [tagName];
+            location.href = xnote.addUrlParam(location.href, "tags", JSON.stringify(filterTags));
+        }
+
+    };
+
+    $(".update-category").change(function (e) {
+        var noteId = $(this).attr("data-id");
+        var newCat = $(this).val();
+        xnote.updateNoteCategory({
+            noteId: noteId,
+            value: newCat,
+            doRefresh: true,
+        });
+    });
+
+    $(".switch-category").change(function(e) {
+        var selected = $(this).val();
+        var url = window.location.href;
+        url = xnote.addUrlParam(url, "category", selected);
+        window.location.href = url;
+    });
+
+    $(".bind-tag-btn-old").click(function (e) {
+        var selectedNameList = JSON.parse($(e.target).attr("data-tags"));
+        var html = $("#bindTagTemplate").render({
+            tagList: tagList,
+            selectedNames: selectedNameList
+        });
+
+        var group_id = $(e.target).attr("data-id");
+
+        console.log("bind-tag-dialog", html);
+
+        xnote.openDialog("添加标签", html, ["确定", "取消"], function () {
+            var selectedNames = [];
+            $(".tag.bind.active").each(function (idx, ele) {
+                var tagName = $(ele).text().trim();
+                selectedNames.push(tagName);
+            });
+
+            var bindParams = {
+                tag_type:"group",
+                group_id:group_id,
+                tag_names: JSON.stringify(selectedNames),
+            };
+
+            xnote.http.post("/note/tag/bind", bindParams, function (resp) {
+                if (resp.code != "success") {
+                    xnote.alert(resp.message);
+                } else {
+                    xnote.toast("添加标签成功");
+                }
+                location.reload();
+            });
+        });
+    });
+
+    $("body").on("click", ".create-tag-btn", function (e) {
+        xnote.prompt("创建新标签", "", function (text) {
+            var params = {
+                tag_type: "group",
+                tag_name: text
+            };
+            $.post("/note/tag/create", params, function (resp) {
+                if (resp.code != "success") {
+                    xnote.alert(resp.message);
+                } else {
+                    xnote.toast("创建成功");
+                }
+                refreshTagTop();
+            });
+        });
+    });
+})();
+
+</script>
+
+{% end %}
+
+
+{% block body_right %}
+    {% include note/component/sidebar/group_manage_sidebar.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/note/page/batch/group_manage_category.html` & `xnote-web-0.1.1/handlers/note/page/batch/group_manage_category.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/batch/note_manage.html` & `xnote-web-0.1.1/handlers/note/page/batch/note_manage.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/category.html` & `xnote-web-0.1.1/handlers/note/page/category.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/comment.html` & `xnote-web-0.1.1/handlers/note/page/comment.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/create.html` & `xnote-web-0.1.1/handlers/note/page/create.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/detail/checklist_detail.html` & `xnote-web-0.1.1/handlers/note/page/detail/checklist_detail.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/detail/form_detail.html` & `xnote-web-0.1.1/handlers/note/page/detail/form_detail.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/detail/group_detail_body.html` & `xnote-web-0.1.1/handlers/note/page/detail/group_detail_body.html`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,43 +1,43 @@
-<!-- 
-@since 2018/03/06
-@modified 2021/07/31 10:11:51
--->
-
-{% init files = [] %}
-{% init show_opts = True %}
-{% init show_size = False %}
-{% init show_cdate = False %}
-{% init show_mdate = False %}
-{% init show_adate = False %}
-{% init show_next  = False %}
-{% init file = None %}
-{% init dir_type = "" %}
-{% init tags = "" %}
-{% init show_parent_link = True %}
-
-{% if show_orderby %}
-  <div class="card">
-    <!-- 排序功能 -->
-    {% include note/component/sort/note_sort_tab.html %}
-  </div>
-{% end %}
-
-{% include note/component/filter/note_tag_filter.html %}
-
-<div class="grid-row note-list">
-    {% if _has_login and show_parent_link and file.id != 0 %}
-        <a class="dialog-link" href="{{_server_home}}/note/{{file.parent_id}}">
-            <div class="book-item">
-                <i class="fa fa-mail-reply black"></i>
-                
-                <span>上级目录</span>
-                <span class="book-size">
-                    <i class="fa fa-chevron-right"></i>
-                </span>
-            </div>
-        </a>
-    {% end %}
-
-    {% include note/component/note_list_component.html %}
-</div>
-
+<!-- 
+@since 2018/03/06
+@modified 2021/07/31 10:11:51
+-->
+
+{% init files = [] %}
+{% init show_opts = True %}
+{% init show_size = False %}
+{% init show_cdate = False %}
+{% init show_mdate = False %}
+{% init show_adate = False %}
+{% init show_next  = False %}
+{% init file = None %}
+{% init dir_type = "" %}
+{% init tags = "" %}
+{% init show_parent_link = True %}
+
+{% if show_orderby %}
+  <div class="card">
+    <!-- 排序功能 -->
+    {% include note/component/sort/note_sort_tab.html %}
+  </div>
+{% end %}
+
+{% include note/component/filter/note_tag_filter.html %}
+
+<div class="grid-row note-list">
+    {% if _has_login and show_parent_link and file.id != 0 %}
+        <a class="dialog-link" href="{{_server_home}}/note/{{file.parent_id}}">
+            <div class="book-item">
+                <i class="fa fa-mail-reply black"></i>
+                
+                <span>上级目录</span>
+                <span class="book-size">
+                    <i class="fa fa-chevron-right"></i>
+                </span>
+            </div>
+        </a>
+    {% end %}
+
+    {% include note/component/note_list_component.html %}
+</div>
+
```

### Comparing `xnote-web-0.1.0/handlers/note/page/detail/table_detail.html` & `xnote-web-0.1.1/handlers/note/page/detail/table_detail.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/group_list.html` & `xnote-web-0.1.1/handlers/note/page/group_list.html`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,50 +1,50 @@
-{% extends base %}
-
-{% block body_left %}
-    {% init ext_groups = None %}
-    {% init show_sort = True %}
-    {% include note/component/view_css.html %}
-
-    <div class="card">
-        <div class="card-title">
-            <span>{{title}}</span>
-            <div class="float-right">
-                <a class="btn btn-default" href="{{_server_home}}/note/group/manage">管理笔记本</a>
-                <a class="btn btn-default" href="{{_server_home}}/note/tools?category=note">工具</a>
-                {% if show_back %}
-                    {% include common/button/back_button.html %}
-                {% end %}
-            </div>
-        </div>
-
-        {% include note/component/script/create_script.html %}
-    </div>
-
-    {% if _is_mobile %}
-        {% include note/page/group_list_nav_mobile.html %}
-    {% else %}
-        {% include note/page/group_list_nav_desktop.html %}
-    {% end %}
-
-    {% if show_sort %}
-        <!-- 排序功能 -->
-        <div class="card">
-            {% include note/component/sort/note_sort_tab.html %}
-        </div>
-    {% end %}
-
-    <!-- 笔记本列表 -->
-    {% set files = groups %}
-    {% include note/component/note_list_component.html %}
-
-    <script>
-        $.get("{{_server_home}}/note/api/stat", function (resp) {
-            console.log("note stat:", resp);
-        });
-    </script>
-{% end %}
-
-{% block body_right %}
-    {% include note/component/sidebar/group_list_sidebar.html %}
-{% end %}
-
+{% extends base %}
+
+{% block body_left %}
+    {% init ext_groups = None %}
+    {% init show_sort = True %}
+    {% include note/component/view_css.html %}
+
+    <div class="card">
+        <div class="card-title">
+            <span>{{title}}</span>
+            <div class="float-right">
+                <a class="btn btn-default" href="{{_server_home}}/note/group/manage">管理笔记本</a>
+                <a class="btn btn-default" href="{{_server_home}}/note/tools?category=note">工具</a>
+                {% if show_back %}
+                    {% include common/button/back_button.html %}
+                {% end %}
+            </div>
+        </div>
+
+        {% include note/component/script/create_script.html %}
+    </div>
+
+    {% if _is_mobile %}
+        {% include note/page/group_list_nav_mobile.html %}
+    {% else %}
+        {% include note/page/group_list_nav_desktop.html %}
+    {% end %}
+
+    {% if show_sort %}
+        <!-- 排序功能 -->
+        <div class="card">
+            {% include note/component/sort/note_sort_tab.html %}
+        </div>
+    {% end %}
+
+    <!-- 笔记本列表 -->
+    {% set files = groups %}
+    {% include note/component/note_list_component.html %}
+
+    <script>
+        $.get("{{_server_home}}/note/api/stat", function (resp) {
+            console.log("note stat:", resp);
+        });
+    </script>
+{% end %}
+
+{% block body_right %}
+    {% include note/component/sidebar/group_list_sidebar.html %}
+{% end %}
+
```

### Comparing `xnote-web-0.1.0/handlers/note/page/group_list_nav_desktop.html` & `xnote-web-0.1.1/handlers/note/page/group_list_nav_desktop.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/group_list_nav_mobile.html` & `xnote-web-0.1.1/handlers/note/page/group_list_nav_mobile.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/history_list.html` & `xnote-web-0.1.1/handlers/note/page/history_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/html_importer.html` & `xnote-web-0.1.1/handlers/note/page/html_importer.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/index/note_index.html` & `xnote-web-0.1.1/handlers/note/page/index/note_index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/index/note_workspace.html` & `xnote-web-0.1.1/handlers/note/page/index/note_workspace.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/index/note_workspace.mobile.html` & `xnote-web-0.1.1/handlers/note/page/index/note_workspace.mobile.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/index/note_workspace2.html` & `xnote-web-0.1.1/handlers/note/page/index/note_workspace2.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/list_by_date.html` & `xnote-web-0.1.1/handlers/note/page/list_by_date.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/note_calendar.html` & `xnote-web-0.1.1/handlers/note/page/note_calendar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/note_default.html` & `xnote-web-0.1.1/handlers/note/page/note_default.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/note_list.html` & `xnote-web-0.1.1/handlers/note/page/note_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/note_recent.html` & `xnote-web-0.1.1/handlers/note/page/note_recent.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/note_tools.html` & `xnote-web-0.1.1/handlers/note/page/taglist.html`

 * *Files 25% similar despite different names*

```diff
@@ -1,40 +1,54 @@
 {% extends base %}
 
-{% block body %}
-
+{% block body_left %}
 <div class="card">
-    <h3 class="card-title btn-line-height">
-        <span>笔记应用</span>
-        <div class="float-right">
-            <a class="btn btn-default" href="{{_server_home}}/note/create">新建</a>
-            <a class="btn btn-default" href="{{_server_home}}/note/group">笔记本</a>
-        </div>
-    </h3>
+    <div class="card-title btn-line-height">
+        {{T("Tag List")}}
+
+        {% include common/back.html %}
+    </div>
 </div>
 
-{% include plugin/header/plugin_category.html %}
+{% init system_tag_list = [] %}
 
 <div class="card">
-    <div class="plugin-list col-md-12">
-        {% for index, link in enumerate(plugins) %}
-            <a class="list-link" href="{{link.link + link.url_query}}">
-                <i class="fa {{link.icon}}"></i>
-                <span>{{link.title}}</span>
-
-                <div class="plugin-right-box">
-                    {% if link.size != None %}
-                        <span class="plugin-right-span">{{link.size}}</span>
-                    {% end %}
-                    
-                    {% if link.visit_cnt != None %}
-                        <i class="fa fa-eye-o"></i>
-                        <span class="plugin-right-span">热度: {{link.visit_cnt}}</span>
-                    {% end %}
-
-                    <i class="fa fa-chevron-right"></i>
-                </div>
-            </a>
+    <div class="split-title">
+        系统标签
+    </div>
+
+    <div class="row">
+        {% for tag_info in system_tag_list %}
+            <span class="tag-span">
+                <a class="tag-link" href="{{_server_home}}/note/tagname/{{tag_info.code}}">{{tag_info.name}}</a>
+                {{tag_info.amount}}
+            </span>
+        {% end %}
+    </div>
+
+    <div class="split-title top-offset-1">
+        自定义标签
+    </div>
+    <div class="row">
+        {% if len(tag_list) == 0 %}
+            {% include common/text/empty_text.html %}
+        {% end %}
+
+        {% for tag_info in tag_list %}
+            <span class="tag-span">
+                <a class="tag-link" href="{{_server_home}}/note/tagname/{{tag_info.name}}">{{tag_info.name}}</a>
+                {{tag_info.amount}}
+            </span>
         {% end %}
     </div>
 </div>
 {% end %}
+
+{% block aside %}
+    {% include note/component/mod_aside.html %}
+{% end %}
+
+
+{% block body_right %}
+    {% include note/component/sidebar/group_list_sidebar.html %}
+{% end %}
+
```

### Comparing `xnote-web-0.1.0/handlers/note/page/old/category_old.html` & `xnote-web-0.1.1/handlers/note/page/old/category_old.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/old/create_log.html` & `xnote-web-0.1.1/handlers/note/page/old/create_log.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/old/group_list_archived.html` & `xnote-web-0.1.1/handlers/note/page/old/group_list_archived.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/old/list_by_date_old.html` & `xnote-web-0.1.1/handlers/note/page/old/list_by_date_old.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/old/project_list_old.html` & `xnote-web-0.1.1/handlers/note/page/old/project_list_old.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/old/upload_file.html` & `xnote-web-0.1.1/handlers/note/page/old/upload_file.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/print.html` & `xnote-web-0.1.1/handlers/note/page/print.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/tagname.html` & `xnote-web-0.1.1/handlers/note/page/tagname.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/note/page/timeline/timeline.html` & `xnote-web-0.1.1/handlers/note/page/timeline/timeline.html`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,64 +1,64 @@
-﻿{% extends base %}
-
-{% block body_left %}
-
-{% init parent_link = None %}
-{% init title_link = None %}
-{% init type = "ctime" %}
-{% init base_path = "/note/timeline" %}
-{% init key = "" %}
-{% init show_old_create = False %}
-{% init show_create_btn = False %}
-{% init show_recent_btn = False %}
-{% init show_back_btn = False %}
-{% init show_group_btn = False %}
-
-<div class="card">
-  <div class="note-header card-title">
-    <span class="note-header-span">{{title}}</span>
-
-    <div class="float-right">
-        {% if show_old_create %}
-          <!-- 原来使用 create_option.html 弹窗创建并没有预期的方便，而且不好做扩展 -->
-          {% include note/component/timeline/timeline_create_option.html %}
-        {% end %}
-
-        {% if show_create_btn %}
-          <a class="btn" href="{{_server_home}}/note/create?parent_id={{parent_id}}">新建笔记</a>
-        {% end %}
-
-        {% if show_group_btn %}
-          <a href="{{_server_home}}/note/timeline?type=group_list&orderby=name" class="btn btn-default">笔记本</a>
-        {% end %}
-
-        {% if show_recent_btn %}
-          <a href="{{_server_home}}/note/timeline/recent" class="btn btn-default">最新笔记</a>
-        {% end %}
-
-        {% if type == "default" %}
-          {% include note/component/option/group_option.html %}
-        {% elif type == "public" %}
-          {% include note/component/share_dialog.html %}
-        {% end %}
-
-        {% if show_back_btn %}
-          {% include common/button/back_button.html %}
-        {% end %}
-    </div>
-  </div>
-</div>
-
-{% if len(pathlist) > 1 %}
-<div class="card">
-  {% include note/component/note_path.html %}
-</div>
-{% end %}
-
-
-{% include note/component/timeline/timeline_body.html %}
-
-{% end %}
-
-{% block body_right %}
-    {% include note/component/sidebar/group_list_sidebar.html %}
+﻿{% extends base %}
+
+{% block body_left %}
+
+{% init parent_link = None %}
+{% init title_link = None %}
+{% init type = "ctime" %}
+{% init base_path = "/note/timeline" %}
+{% init key = "" %}
+{% init show_old_create = False %}
+{% init show_create_btn = False %}
+{% init show_recent_btn = False %}
+{% init show_back_btn = False %}
+{% init show_group_btn = False %}
+
+<div class="card">
+  <div class="note-header card-title">
+    <span class="note-header-span">{{title}}</span>
+
+    <div class="float-right">
+        {% if show_old_create %}
+          <!-- 原来使用 create_option.html 弹窗创建并没有预期的方便，而且不好做扩展 -->
+          {% include note/component/timeline/timeline_create_option.html %}
+        {% end %}
+
+        {% if show_create_btn %}
+          <a class="btn" href="{{_server_home}}/note/create?parent_id={{parent_id}}">新建笔记</a>
+        {% end %}
+
+        {% if show_group_btn %}
+          <a href="{{_server_home}}/note/timeline?type=group_list&orderby=name" class="btn btn-default">笔记本</a>
+        {% end %}
+
+        {% if show_recent_btn %}
+          <a href="{{_server_home}}/note/timeline/recent" class="btn btn-default">最新笔记</a>
+        {% end %}
+
+        {% if type == "default" %}
+          {% include note/component/option/group_option.html %}
+        {% elif type == "public" %}
+          {% include note/component/share_dialog.html %}
+        {% end %}
+
+        {% if show_back_btn %}
+          {% include common/button/back_button.html %}
+        {% end %}
+    </div>
+  </div>
+</div>
+
+{% if len(pathlist) > 1 %}
+<div class="card">
+  {% include note/component/note_path.html %}
+</div>
+{% end %}
+
+
+{% include note/component/timeline/timeline_body.html %}
+
+{% end %}
+
+{% block body_right %}
+    {% include note/component/sidebar/group_list_sidebar.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/plan/dao.py` & `xnote-web-0.1.1/handlers/plan/dao.py`

 * *Ordering differences only*

 * *Files 17% similar despite different names*

```diff
@@ -1,74 +1,74 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-02-12 00:00:00
-@LastEditors  : xupingmao
-@LastEditTime : 2023-06-24 10:10:33
-@FilePath     : /xnote/handlers/plan/dao.py
-@Description  : 计划管理
-"""
-import time
-from xnote.core import xauth
-from xutils import dbutil, Storage
-
-class MonthPlanRecord(Storage):
-
-    def __init__(self, **kw):
-        self.user = ""
-        self.user_id = 0
-        self.month = ""
-        self.notes = []
-        self.note_ids = []
-        self.create_notes = []
-        self.update_notes = []
-        self.update(kw)
-    
-    def save(self):
-        MonthPlanDao.update(self)
-
-class MonthPlanDao:
-
-    db = dbutil.get_table_v2("month_plan")
-
-    @classmethod
-    def get_or_create(cls, user_info: xauth.UserDO, month = "2020-03"):
-        db = cls.db
-        if month == "now":
-            month = time.strftime("%Y-%m")
-        user_id = user_info.id
-        user_name = user_info.name
-
-        record = db.select_first(where = dict(user_id=user_id, month = month))
-        if record == None:
-            record = MonthPlanRecord()
-            record.user_id = user_id
-            record.user = user_name
-            record.month = month
-            id = db.insert(record)
-            record = db.get_by_id(id)
-        
-        assert isinstance(record, dict)
-        return MonthPlanRecord(**record)
-
-    @classmethod
-    def get_by_id(cls, user_id = 0, id = ""):
-        db = cls.db
-        record = db.get_by_id(id)
-        if record == None:
-            return None
-        if record.user_id != user_id:
-            return None
-        return MonthPlanRecord(**record)
-    
-    @classmethod
-    def get_by_month(cls, user_id = 0, month = "2020-03"):
-        db = cls.db
-        record = db.select_first(where = dict(user_id=user_id, month = month))
-        if record == None:
-            return None
-        return MonthPlanRecord(**record)
-    
-    @classmethod
-    def update(cls, record: MonthPlanRecord):
-        return cls.db.update(record)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-02-12 00:00:00
+@LastEditors  : xupingmao
+@LastEditTime : 2023-06-24 10:10:33
+@FilePath     : /xnote/handlers/plan/dao.py
+@Description  : 计划管理
+"""
+import time
+from xnote.core import xauth
+from xutils import dbutil, Storage
+
+class MonthPlanRecord(Storage):
+
+    def __init__(self, **kw):
+        self.user = ""
+        self.user_id = 0
+        self.month = ""
+        self.notes = []
+        self.note_ids = []
+        self.create_notes = []
+        self.update_notes = []
+        self.update(kw)
+    
+    def save(self):
+        MonthPlanDao.update(self)
+
+class MonthPlanDao:
+
+    db = dbutil.get_table_v2("month_plan")
+
+    @classmethod
+    def get_or_create(cls, user_info: xauth.UserDO, month = "2020-03"):
+        db = cls.db
+        if month == "now":
+            month = time.strftime("%Y-%m")
+        user_id = user_info.id
+        user_name = user_info.name
+
+        record = db.select_first(where = dict(user_id=user_id, month = month))
+        if record == None:
+            record = MonthPlanRecord()
+            record.user_id = user_id
+            record.user = user_name
+            record.month = month
+            id = db.insert(record)
+            record = db.get_by_id(id)
+        
+        assert isinstance(record, dict)
+        return MonthPlanRecord(**record)
+
+    @classmethod
+    def get_by_id(cls, user_id = 0, id = ""):
+        db = cls.db
+        record = db.get_by_id(id)
+        if record == None:
+            return None
+        if record.user_id != user_id:
+            return None
+        return MonthPlanRecord(**record)
+    
+    @classmethod
+    def get_by_month(cls, user_id = 0, month = "2020-03"):
+        db = cls.db
+        record = db.select_first(where = dict(user_id=user_id, month = month))
+        if record == None:
+            return None
+        return MonthPlanRecord(**record)
+    
+    @classmethod
+    def update(cls, record: MonthPlanRecord):
+        return cls.db.update(record)
```

### Comparing `xnote-web-0.1.0/handlers/plan/plan.py` & `xnote-web-0.1.1/handlers/plan/plan.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,103 +1,103 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-02-12 00:00:00
-@LastEditors  : xupingmao
-@LastEditTime : 2023-11-05 22:54:32
-@FilePath     : /xnote/handlers/plan/plan.py
-@Description  : 计划管理
-"""
-from xnote.core import xauth, xtemplate
-import xutils
-import datetime
-from xutils import Storage
-from handlers.plan.dao import MonthPlanDao
-from handlers.note import dao as note_dao
-from xutils import functions, dateutil
-
-class MonthPlanHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        kw = Storage()
-        user_info = xauth.current_user()
-        assert user_info != None
-        
-        date = xutils.get_argument_str("date", "now")
-        date = date.replace("/", "-")
-        record = MonthPlanDao.get_or_create(user_info, date)
-
-        if len(record.note_ids) > 0:
-            note_ids = list(filter(lambda x:x!="", record.note_ids))
-            record.notes = note_dao.batch_query_list(note_ids)
-            record.notes.sort(key = lambda x:x.name)
-
-        year, month = record.month.split("-")
-        int_year = int(year)
-        int_month = int(month)
-        user_id = user_info.id
-
-        kw.record = record
-        kw.year = int_year
-        kw.month = int_month
-
-        next_year = int_year
-        next_month = int_month + 1
-        if next_month == 13:
-            next_year += 1
-            next_month = 1
-
-        date_start = datetime.datetime(year=int_year, month=int_month, day=1)
-        date_end = datetime.datetime(year=next_year, month=next_month, day=1)
-        kw.created_notes = note_dao.NoteIndexDao.list(creator_id=user_id, 
-                                                      date_start=dateutil.format_datetime(date_start), 
-                                                      date_end=dateutil.format_datetime(date_end))
-        return xtemplate.render("plan/page/month_plan.html", **kw)
-
-
-class MonthPlanAddAjaxHandler:
-    @xauth.login_required()
-    def POST(self):
-        plan_id = xutils.get_argument_str("id", "")
-        note_ids_str = xutils.get_argument_str("note_ids", "")
-        note_ids = note_ids_str.split(",")
-        if plan_id == "":
-            return dict(code="400", message="参数id不能为空")
-
-        user_id = xauth.current_user_id()
-        record = MonthPlanDao.get_by_id(user_id, plan_id)
-        if record != None:
-            assert isinstance(note_ids, list)
-            for id in note_ids:
-                if id not in record.note_ids:
-                    record.note_ids.append(id)
-            record.save()
-            return dict(code="success")
-        else:
-            return dict(code="500", message="计划不存在")
-
-class MonthPlanRemoveAjaxHandler:
-    @xauth.login_required()
-    def POST(self):
-        id = xutils.get_argument_str("id", "")
-        note_id = xutils.get_argument_str("note_id", "")
-        if id == "":
-            return dict(code="400", message="参数id不能为空")
-        if note_id == "":
-            return dict(code="400", message="参数note_id不能为空")
-
-        user_id = xauth.current_user_id()
-        record = MonthPlanDao.get_by_id(user_id, id)
-        if record != None:
-            functions.listremove(record.note_ids, note_id)
-            record.save()
-            return dict(code="success")
-        else:
-            return dict(code="500", message="计划不存在")
-
-xurls = (
-    r"/plan/month", MonthPlanHandler,
-    r"/plan/month/add", MonthPlanAddAjaxHandler,
-    r"/plan/month/remove", MonthPlanRemoveAjaxHandler,
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-02-12 00:00:00
+@LastEditors  : xupingmao
+@LastEditTime : 2023-11-05 22:54:32
+@FilePath     : /xnote/handlers/plan/plan.py
+@Description  : 计划管理
+"""
+from xnote.core import xauth, xtemplate
+import xutils
+import datetime
+from xutils import Storage
+from handlers.plan.dao import MonthPlanDao
+from handlers.note import dao as note_dao
+from xutils import functions, dateutil
+
+class MonthPlanHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        kw = Storage()
+        user_info = xauth.current_user()
+        assert user_info != None
+        
+        date = xutils.get_argument_str("date", "now")
+        date = date.replace("/", "-")
+        record = MonthPlanDao.get_or_create(user_info, date)
+
+        if len(record.note_ids) > 0:
+            note_ids = list(filter(lambda x:x!="", record.note_ids))
+            record.notes = note_dao.batch_query_list(note_ids)
+            record.notes.sort(key = lambda x:x.name)
+
+        year, month = record.month.split("-")
+        int_year = int(year)
+        int_month = int(month)
+        user_id = user_info.id
+
+        kw.record = record
+        kw.year = int_year
+        kw.month = int_month
+
+        next_year = int_year
+        next_month = int_month + 1
+        if next_month == 13:
+            next_year += 1
+            next_month = 1
+
+        date_start = datetime.datetime(year=int_year, month=int_month, day=1)
+        date_end = datetime.datetime(year=next_year, month=next_month, day=1)
+        kw.created_notes = note_dao.NoteIndexDao.list(creator_id=user_id, 
+                                                      date_start=dateutil.format_datetime(date_start), 
+                                                      date_end=dateutil.format_datetime(date_end))
+        return xtemplate.render("plan/page/month_plan.html", **kw)
+
+
+class MonthPlanAddAjaxHandler:
+    @xauth.login_required()
+    def POST(self):
+        plan_id = xutils.get_argument_str("id", "")
+        note_ids_str = xutils.get_argument_str("note_ids", "")
+        note_ids = note_ids_str.split(",")
+        if plan_id == "":
+            return dict(code="400", message="参数id不能为空")
+
+        user_id = xauth.current_user_id()
+        record = MonthPlanDao.get_by_id(user_id, plan_id)
+        if record != None:
+            assert isinstance(note_ids, list)
+            for id in note_ids:
+                if id not in record.note_ids:
+                    record.note_ids.append(id)
+            record.save()
+            return dict(code="success")
+        else:
+            return dict(code="500", message="计划不存在")
+
+class MonthPlanRemoveAjaxHandler:
+    @xauth.login_required()
+    def POST(self):
+        id = xutils.get_argument_str("id", "")
+        note_id = xutils.get_argument_str("note_id", "")
+        if id == "":
+            return dict(code="400", message="参数id不能为空")
+        if note_id == "":
+            return dict(code="400", message="参数note_id不能为空")
+
+        user_id = xauth.current_user_id()
+        record = MonthPlanDao.get_by_id(user_id, id)
+        if record != None:
+            functions.listremove(record.note_ids, note_id)
+            record.save()
+            return dict(code="success")
+        else:
+            return dict(code="500", message="计划不存在")
+
+xurls = (
+    r"/plan/month", MonthPlanHandler,
+    r"/plan/month/add", MonthPlanAddAjaxHandler,
+    r"/plan/month/remove", MonthPlanRemoveAjaxHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/plugin/base/base_form_plugin.html` & `xnote-web-0.1.1/handlers/plugin/base/base_form_plugin.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/base/base_plugin.html` & `xnote-web-0.1.1/handlers/plugin/base/base_plugin.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/base/base_plugin_title.html` & `xnote-web-0.1.1/handlers/plugin/base/base_plugin_title.html`

 * *Files 12% similar despite different names*

```diff
@@ -1,55 +1,57 @@
-{% init category_url = xutils.call("plugin.get_category_url_by_code", model.category) %}
-
-
-{% if model.html_header != None %}
-    <!-- 自定义Header -->
-    {% raw model.html_header %}
-{% elif model.show_title %}
-    <!-- 插件默认的header -->
-    <div class="plugin-head card">
-        <div class="card-title btn-line-height">
-            {% if model.show_category and model.category %}
-                <a class="link2" href="{{category_url}}">{{model.category_name}}</a>
-                <span>/</span>
-            {% end %}
-            <span>{{title}}</span>
-            <span class="float-right">
-                {% if _is_admin and model.show_edit and model.editable %}
-                    <a class="btn" href="{{_server_home}}/code/edit?path={{fpath}}">编辑</a>
-                {% end %}
-                <a class="btn btn-default" href="javascript:history.back();">返回</a>
-            </span>
-        </div>
-    </div>
-
-    {% if description != "" or error != "" or rows > 0 %}
-        <div class="card">
-            {% if description != "" %}
-                <pre class="col-md-12 plugin-description">{{description}}</pre>
-            {% end %}
-
-            {% if error != "" %}
-                <pre class="col-md-12 error">{{error}}</pre>
-            {% end %}
-
-            {% if rows > 0 %}
-                <div class="row">
-                    <form method="{{method}}">
-                        <!-- 输入框区域 BEGIN -->
-                        {% if rows == 1 %}
-                            <input type="text" class="plugin-input" name="input" value="{{input}}" placeholder="{{model.placeholder}}"/>
-                        {% else %}
-                            <textarea class="col-md-12 code" name="input" rows={{rows}} placeholder="{{model.placeholder}}">{{input}}</textarea>
-                        {% end %}
-                        <!-- 输入框区域 END -->
-
-                        <!-- 按钮区域 BEGIN -->
-                        <button>{{model.btn_text}}</button>
-                        <!-- 按钮区域 END -->
-                    </form>
-                </div>
-            {% end %}
-        </div>
-    {% end %}
-    
-{% end %}
+{% init category_url = xutils.call("plugin.get_category_url_by_code", model.category) %}
+
+
+{% if model.header_html != "" %}
+    <!-- 自定义Header -->
+    {% raw model.header_html %}
+{% elif model.show_title %}
+    <!-- 插件默认的header -->
+    <div class="plugin-head card">
+        <div class="card-title btn-line-height">
+            {% if model.show_category and model.category %}
+                <a class="link2" href="{{category_url}}">{{model.category_name}}</a>
+                <span>/</span>
+            {% end %}
+            <span>{{title}}</span>
+            <span class="float-right">
+                {% raw model.option_html %}
+
+                {% if _is_admin and model.show_edit and model.editable %}
+                    <a class="btn" href="{{_server_home}}/code/edit?path={{fpath}}">编辑</a>
+                {% end %}
+                <a class="btn btn-default" href="javascript:history.back();">返回</a>
+            </span>
+        </div>
+    </div>
+
+    {% if description != "" or error != "" or rows > 0 %}
+        <div class="card">
+            {% if description != "" %}
+                <pre class="col-md-12 plugin-description">{{description}}</pre>
+            {% end %}
+
+            {% if error != "" %}
+                <pre class="col-md-12 error">{{error}}</pre>
+            {% end %}
+
+            {% if rows > 0 %}
+                <div class="row">
+                    <form method="{{method}}">
+                        <!-- 输入框区域 BEGIN -->
+                        {% if rows == 1 %}
+                            <input type="text" class="plugin-input" name="input" value="{{input}}" placeholder="{{model.placeholder}}"/>
+                        {% else %}
+                            <textarea class="col-md-12 code" name="input" rows={{rows}} placeholder="{{model.placeholder}}">{{input}}</textarea>
+                        {% end %}
+                        <!-- 输入框区域 END -->
+
+                        <!-- 按钮区域 BEGIN -->
+                        <button>{{model.btn_text}}</button>
+                        <!-- 按钮区域 END -->
+                    </form>
+                </div>
+            {% end %}
+        </div>
+    {% end %}
+    
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/plugin/dao.py` & `xnote-web-0.1.1/handlers/plugin/dao.py`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,97 +1,97 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-01-29 12:21:04
-@LastEditors  : xupingmao
-@LastEditTime : 2024-02-14 20:53:48
-@FilePath     : /xnote/handlers/plugin/dao.py
-@Description  : 描述
-"""
-import xutils
-from xnote.core import xtables
-from xnote.core import xauth
-from xutils import dateutil
-from xutils import Storage
-
-class PageVisitLogDO(Storage):
-    def __init__(self, **kw):
-        self.user_id = 0
-        self.url = ""
-        self.args = ""
-        self.visit_cnt = 0
-        self.visit_time = dateutil.format_datetime()
-        self.update(kw)
-
-class PageVisitDao:
-    
-    db = xtables.get_table_by_name("page_visit_log")
-    
-    @classmethod
-    def format_url(cls, url=""):
-        return url[:256]
-    
-    @classmethod
-    def create(cls, log: PageVisitLogDO):
-        log.url = cls.format_url(log.url)
-        return cls.db.insert(**log)
-    
-    @classmethod
-    def find_one(cls, user_id=0, url=""):
-        url = cls.format_url(url)
-        result = cls.db.select_first(where = dict(user_id=user_id, url=url))
-        if result != None:
-            return PageVisitLogDO(**result)
-        return None
-    
-    @classmethod
-    def list_logs(cls, user_id=0, offset=0, limit=1000, order="visit_time desc"):
-        results = []
-        for item0 in cls.db.select(where=dict(user_id=user_id), offset=offset, limit=limit, order=order):
-            item = PageVisitLogDO(**item0)
-            results.append(item)
-        return results
-        
-    
-    @classmethod
-    def update(cls, log: PageVisitLogDO):
-        log.url = cls.format_url(log.url)
-        return cls.db.update(where=dict(id=log.id), **log)
-    
-    @classmethod
-    def delete_by_id(cls, log_id):
-        return cls.db.delete(where=dict(id=log_id))
-    
-def list_visit_logs(user_name, offset = 0, limit = -1):
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    return PageVisitDao.list_logs(user_id=user_id, offset=offset, limit=limit, order="visit_time desc")
-
-def delete_visit_log(user_name="", name="", url=""):
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    exist_log = PageVisitDao.find_one(user_id=user_id, url=url)
-    if exist_log != None:
-        PageVisitDao.delete_by_id(exist_log.id)
-
-
-def add_visit_log(user_name="", url="", name = "", args = ""):
-    if user_name == None:
-        user_name = "guest"
-        
-    user_id = xauth.UserDao.get_id_by_name(user_name)
-    
-    exist_log = PageVisitDao.find_one(user_id=user_id, url=url)
-    if exist_log != None:
-        exist_log.visit_cnt += 1
-        exist_log.visit_time = dateutil.format_datetime()
-        PageVisitDao.update(exist_log)
-        return
-
-    log = PageVisitLogDO()
-    log.user_id = user_id
-    log.url  = url
-    log.args = args
-    log.visit_time = dateutil.format_datetime()
-    log.visit_cnt = 1
-    PageVisitDao.create(log)
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-01-29 12:21:04
+@LastEditors  : xupingmao
+@LastEditTime : 2024-02-14 20:53:48
+@FilePath     : /xnote/handlers/plugin/dao.py
+@Description  : 描述
+"""
+import xutils
+from xnote.core import xtables
+from xnote.core import xauth
+from xutils import dateutil
+from xutils import Storage
+
+class PageVisitLogDO(Storage):
+    def __init__(self, **kw):
+        self.user_id = 0
+        self.url = ""
+        self.args = ""
+        self.visit_cnt = 0
+        self.visit_time = dateutil.format_datetime()
+        self.update(kw)
+
+class PageVisitDao:
+    
+    db = xtables.get_table_by_name("page_visit_log")
+    
+    @classmethod
+    def format_url(cls, url=""):
+        return url[:256]
+    
+    @classmethod
+    def create(cls, log: PageVisitLogDO):
+        log.url = cls.format_url(log.url)
+        return cls.db.insert(**log)
+    
+    @classmethod
+    def find_one(cls, user_id=0, url=""):
+        url = cls.format_url(url)
+        result = cls.db.select_first(where = dict(user_id=user_id, url=url))
+        if result != None:
+            return PageVisitLogDO(**result)
+        return None
+    
+    @classmethod
+    def list_logs(cls, user_id=0, offset=0, limit=1000, order="visit_time desc"):
+        results = []
+        for item0 in cls.db.select(where=dict(user_id=user_id), offset=offset, limit=limit, order=order):
+            item = PageVisitLogDO(**item0)
+            results.append(item)
+        return results
+        
+    
+    @classmethod
+    def update(cls, log: PageVisitLogDO):
+        log.url = cls.format_url(log.url)
+        return cls.db.update(where=dict(id=log.id), **log)
+    
+    @classmethod
+    def delete_by_id(cls, log_id):
+        return cls.db.delete(where=dict(id=log_id))
+    
+def list_visit_logs(user_name, offset = 0, limit = -1):
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    return PageVisitDao.list_logs(user_id=user_id, offset=offset, limit=limit, order="visit_time desc")
+
+def delete_visit_log(user_name="", name="", url=""):
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    exist_log = PageVisitDao.find_one(user_id=user_id, url=url)
+    if exist_log != None:
+        PageVisitDao.delete_by_id(exist_log.id)
+
+
+def add_visit_log(user_name="", url="", name = "", args = ""):
+    if user_name == None:
+        user_name = "guest"
+        
+    user_id = xauth.UserDao.get_id_by_name(user_name)
+    
+    exist_log = PageVisitDao.find_one(user_id=user_id, url=url)
+    if exist_log != None:
+        exist_log.visit_cnt += 1
+        exist_log.visit_time = dateutil.format_datetime()
+        PageVisitDao.update(exist_log)
+        return
+
+    log = PageVisitLogDO()
+    log.user_id = user_id
+    log.url  = url
+    log.args = args
+    log.visit_time = dateutil.format_datetime()
+    log.visit_cnt = 1
+    PageVisitDao.create(log)
+
 xutils.register_func("plugin.add_visit_log", add_visit_log)
```

### Comparing `xnote-web-0.1.0/handlers/plugin/header/plugin_category.html` & `xnote-web-0.1.1/handlers/plugin/header/plugin_category.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/header/plugin_header_normal.html` & `xnote-web-0.1.1/handlers/plugin/header/plugin_header_normal.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/page/grid.html` & `xnote-web-0.1.1/handlers/plugin/page/grid.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/page/plugins_v1.html` & `xnote-web-0.1.1/handlers/plugin/page/plugins_v1.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/page/plugins_v2.html` & `xnote-web-0.1.1/handlers/plugin/page/plugins_v2.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/page/plugins_v3.html` & `xnote-web-0.1.1/handlers/plugin/page/plugins_v3.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/plugin/plugin_create.py` & `xnote-web-0.1.1/handlers/plugin/plugin_create.py`

 * *Ordering differences only*

 * *Files 20% similar despite different names*

```diff
@@ -1,129 +1,129 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2020/08/28 00:22:51
-# @modified 2020/12/05 21:29:26
-
-"""插件创建的工具，基于插件开发，但是其实已经不用了，实际创建插件的实现参考 fs/fs_add.py"""
-
-import xutils
-import os
-import web
-from xnote.core import xauth, xconfig
-from xnote.core.xtemplate import BasePlugin
-from xutils import History
-from xutils import cacheutil
-from xutils import Storage
-from xutils import fsutil
-from xutils import textutil, SearchResult, dateutil, dbutil, u
-from . import dao as dao_visit_log
-
-
-PLUGIN_API = xutils.Module("plugin")
-
-DEFAULT_PLUGIN_TEMPLATE = '''# -*- coding:utf-8 -*-
-# @since $since
-# @author $author
-# @plugin_id $plugin_id
-import os
-import re
-import math
-import time
-import web
-import xconfig
-import xutils
-import xauth
-import xmanager
-import xtables
-import xtemplate
-from xtemplate import BasePlugin
-
-HTML = """
-<!-- Html -->
-"""
-
-class Main(BasePlugin):
-
-    title = "PluginName"
-    # 提示内容
-    description = ""
-    # 访问权限
-    required_role = "admin"
-    # 插件分类 {note, dir, system, network, develop}
-    category = None
-    
-    def handle(self, input):
-        # 输入框的行数
-        self.rows = 5
-        self.writehtml(HTML)
-
-    def on_init(self, context=None):
-        # 插件初始化操作
-        pass
-'''
-
-class NewPluginHandler(BasePlugin):
-    """默认的插件声明入口，定义一个叫做Main的类"""
-
-    def handle(self, input):
-        self.description = '''请输入插件名称'''
-        self.title = '通过模板创建插件'
-        self.btn_text = '创建'
-        self.rows = 1
-        self.editable = False
-        if input != '':
-            name = os.path.join(xconfig.PLUGINS_DIR, input)
-            if not name.endswith(".py"):
-                name += ".py"
-            if os.path.exists(name):
-                return u("文件[%s]已经存在!") % u(name)
-            user_name = xauth.current_name_str()
-            code = xconfig.get_str("NEW_PLUGIN_TEMPLATE", DEFAULT_PLUGIN_TEMPLATE)
-            code = code.replace("$since", xutils.format_datetime())
-            code = code.replace("$author", user_name)
-            code = code.replace("$plugin_id", xutils.create_uuid())
-            xutils.writefile(name, code)
-            # 添加一个访问记录，使得新增的插件排在前面
-            basename = os.path.basename(name)
-            dao_visit_log.add_visit_log(user_name, "/plugins/" + basename)
-            raise web.seeother('/code/edit?path=%s' % name)
-
-
-DEFAULT_COMMAND_TEMPLATE = '''# -*- coding:utf-8 -*-
-# @since $since
-# @author $author
-import os
-import xutils
-
-def main(path = "", confirmed = False, **kw):
-    # your code here
-    pass
-'''
-
-class NewCommandPlugin(BasePlugin):
-    """【不推荐】默认的插件声明入口，定义一个叫做Main的类
-    已经不推荐使用命令扩展"""
-
-    def handle(self, input):
-        self.title = '通过模板创建命令扩展'
-        self.description = '''请输入命令扩展名称'''
-        self.btn_text = '创建'
-        self.rows = 1
-        self.editable = False
-        if input != '':
-            name = os.path.join(xconfig.COMMANDS_DIR, input)
-            if not name.endswith(".py"):
-                name += ".py"
-            if os.path.exists(name):
-                return u("文件[%s]已经存在!") % u(name)
-            user_name = xauth.current_name_str()
-            code = xconfig.get_str("NEW_COMMAND_TEMPLATE", DEFAULT_COMMAND_TEMPLATE)
-            code = code.replace("$since", xutils.format_datetime())
-            code = code.replace("$author", user_name)
-            xutils.writefile(name, code)
-            raise web.seeother('/code/edit?path=%s' % name)
-
-
-xurls = (
-    r"/plugins_new/command", NewCommandPlugin,
-    r"/plugins_new", NewPluginHandler
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2020/08/28 00:22:51
+# @modified 2020/12/05 21:29:26
+
+"""插件创建的工具，基于插件开发，但是其实已经不用了，实际创建插件的实现参考 fs/fs_add.py"""
+
+import xutils
+import os
+import web
+from xnote.core import xauth, xconfig
+from xnote.core.xtemplate import BasePlugin
+from xutils import History
+from xutils import cacheutil
+from xutils import Storage
+from xutils import fsutil
+from xutils import textutil, SearchResult, dateutil, dbutil, u
+from . import dao as dao_visit_log
+
+
+PLUGIN_API = xutils.Module("plugin")
+
+DEFAULT_PLUGIN_TEMPLATE = '''# -*- coding:utf-8 -*-
+# @since $since
+# @author $author
+# @plugin_id $plugin_id
+import os
+import re
+import math
+import time
+import web
+import xconfig
+import xutils
+import xauth
+import xmanager
+import xtables
+import xtemplate
+from xtemplate import BasePlugin
+
+HTML = """
+<!-- Html -->
+"""
+
+class Main(BasePlugin):
+
+    title = "PluginName"
+    # 提示内容
+    description = ""
+    # 访问权限
+    required_role = "admin"
+    # 插件分类 {note, dir, system, network, develop}
+    category = None
+    
+    def handle(self, input):
+        # 输入框的行数
+        self.rows = 5
+        self.writehtml(HTML)
+
+    def on_init(self, context=None):
+        # 插件初始化操作
+        pass
+'''
+
+class NewPluginHandler(BasePlugin):
+    """默认的插件声明入口，定义一个叫做Main的类"""
+
+    def handle(self, input):
+        self.description = '''请输入插件名称'''
+        self.title = '通过模板创建插件'
+        self.btn_text = '创建'
+        self.rows = 1
+        self.editable = False
+        if input != '':
+            name = os.path.join(xconfig.PLUGINS_DIR, input)
+            if not name.endswith(".py"):
+                name += ".py"
+            if os.path.exists(name):
+                return u("文件[%s]已经存在!") % u(name)
+            user_name = xauth.current_name_str()
+            code = xconfig.get_str("NEW_PLUGIN_TEMPLATE", DEFAULT_PLUGIN_TEMPLATE)
+            code = code.replace("$since", xutils.format_datetime())
+            code = code.replace("$author", user_name)
+            code = code.replace("$plugin_id", xutils.create_uuid())
+            xutils.writefile(name, code)
+            # 添加一个访问记录，使得新增的插件排在前面
+            basename = os.path.basename(name)
+            dao_visit_log.add_visit_log(user_name, "/plugins/" + basename)
+            raise web.seeother('/code/edit?path=%s' % name)
+
+
+DEFAULT_COMMAND_TEMPLATE = '''# -*- coding:utf-8 -*-
+# @since $since
+# @author $author
+import os
+import xutils
+
+def main(path = "", confirmed = False, **kw):
+    # your code here
+    pass
+'''
+
+class NewCommandPlugin(BasePlugin):
+    """【不推荐】默认的插件声明入口，定义一个叫做Main的类
+    已经不推荐使用命令扩展"""
+
+    def handle(self, input):
+        self.title = '通过模板创建命令扩展'
+        self.description = '''请输入命令扩展名称'''
+        self.btn_text = '创建'
+        self.rows = 1
+        self.editable = False
+        if input != '':
+            name = os.path.join(xconfig.COMMANDS_DIR, input)
+            if not name.endswith(".py"):
+                name += ".py"
+            if os.path.exists(name):
+                return u("文件[%s]已经存在!") % u(name)
+            user_name = xauth.current_name_str()
+            code = xconfig.get_str("NEW_COMMAND_TEMPLATE", DEFAULT_COMMAND_TEMPLATE)
+            code = code.replace("$since", xutils.format_datetime())
+            code = code.replace("$author", user_name)
+            xutils.writefile(name, code)
+            raise web.seeother('/code/edit?path=%s' % name)
+
+
+xurls = (
+    r"/plugins_new/command", NewCommandPlugin,
+    r"/plugins_new", NewPluginHandler
 )
```

### Comparing `xnote-web-0.1.0/handlers/plugin/plugin_page.py` & `xnote-web-0.1.1/handlers/plugin/plugin_page.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,888 +1,888 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2018/09/30 20:53:38
-# @modified 2022/03/04 23:02:45
-import os
-import xutils
-import web
-import copy
-
-from xnote.core import xconfig
-from xnote.core import xtemplate
-from xnote.core import xauth
-from xnote.core import xmanager
-from xnote.core import xnote_hooks
-
-from xnote.core.xtemplate import T
-from xutils import Storage
-from xutils import fsutil
-from xutils import logutil
-from xutils import textutil, SearchResult, dateutil, u
-from xutils import attrget
-from xutils import mem_util
-from xutils.imports import ConfigParser
-from handlers.plugin.dao import (
-    add_visit_log, list_visit_logs, PageVisitLogDO)
-
-
-from xnote.plugin import load_plugin_file, PluginContext
-
-"""xnote插件模块，由于插件的权限较大，开发权限只开放给管理员，普通用户可以使用
-
-插件的模型：插件包含两部分，程序和数据，程序部分存储在插件目录中的文件，数据存储在数据库或者文件中，
-使用dbutil/fsutil接口操作数据
-- 插件名称、描述、文件名、文件路径
-- 插件的主类
-- 插件的分类
-- 插件的访问权限
-
-插件的生命周期
-- 插件的注册：debug模式下实时注册，非debug模式：初始化注册+按需注册
-- 插件的卸载：退出应用
-- 插件的刷新：刷新系统的时候重新加载
-- 插件的删除：删除插件文件
-
-插件日志：
-- 日志关系：每个用户保留一个插件访问记录，记录最近访问的时间，访问的总次数
-- 日志的创建：访问的时候创建
-- 日志的更新：访问的时候更新
-- 日志的删除：暂无
-
-"""
-
-PLUGIN_CATEGORY_LIST = list()
-
-CONFIG_TOOLS = list()
-
-PLUGINS_STATUS = "loading"
-
-DEFAULT_PLUGIN_ICON_CLASS = "fa fa-cube"
-
-
-def get_current_platform():
-    return xtemplate.get_device_platform()
-
-
-class PluginCategory:
-    """插件分类"""
-    required_roles = None
-    icon_class = "fa fa-cube"
-
-    def __init__(self, code, name, url=None, required_roles=None):
-        self.code = code
-        self.name = name
-        self.required_roles = required_roles
-        self.platforms = None
-        if url is None:
-            self.url = "/plugin_list?category=%s" % self.code
-        else:
-            self.url = url
-
-    def is_visible(self):
-        return self.is_visible_by_roles() and self.is_visible_by_platform()
-
-    def is_visible_by_platform(self):
-        if self.platforms is None:
-            return True
-        return get_current_platform() in self.platforms
-
-    def is_visible_by_roles(self):
-        if self.required_roles is None:
-            return True
-        return xauth.current_role() in self.required_roles
-
-
-def define_plugin_category(code,
-                           name,
-                           url=None,
-                           raise_duplication=True,
-                           required_roles=None,
-                           platforms=None,
-                           icon_class=None):
-    global PLUGIN_CATEGORY_LIST
-    for item in PLUGIN_CATEGORY_LIST:
-        if item.code == code:
-            if raise_duplication:
-                raise Exception("code: %s is defined" % code)
-            else:
-                return
-        if item.name == name:
-            if raise_duplication:
-                raise Exception("name: %s is defined" % name)
-            else:
-                return
-    category = PluginCategory(code, name, url, required_roles)
-    category.platforms = platforms
-    if icon_class != None:
-        category.icon_class = icon_class
-    PLUGIN_CATEGORY_LIST.append(category)
-
-
-def get_plugin_category_list():
-    global PLUGIN_CATEGORY_LIST
-    return PLUGIN_CATEGORY_LIST
-
-
-def get_category_url_by_code(code):
-    if code is None:
-        return "/plugin_list?category=all"
-    for item in PLUGIN_CATEGORY_LIST:
-        if item.code == code:
-            return item.url
-    return "/plugin_list?category=%s" % code
-
-
-def get_category_name_by_code(code):
-    category = get_category_by_code(code)
-    if category != None:
-        return category.name
-
-    # 如果没有定义，就返回code
-    return code
-
-xnote_hooks.get_category_name_by_code = get_category_name_by_code
-
-def get_category_by_code(code):
-    for item in PLUGIN_CATEGORY_LIST:
-        if item.code == code:
-            return item
-    return None
-
-
-def get_category_icon_class_by_code(code):
-    category = get_category_by_code(code)
-    if category is None:
-        return DEFAULT_PLUGIN_ICON_CLASS
-    return category.icon_class
-
-
-def check_and_load_class(plugin):
-    if plugin.clazz is not None:
-        return
-
-    load_plugin_file(plugin.fpath)
-
-
-def load_inner_plugins():
-    for tool in INNER_TOOLS:
-        xconfig.PLUGINS_DICT[tool.url] = tool
-
-
-def load_plugin_dir(dirname=None):
-    """加载插件目录"""
-    if dirname is None:
-        dirname = xconfig.PLUGINS_DIR
-
-    xconfig.PLUGINS_DICT = {}
-    for root, dirs, files in os.walk(dirname):
-        for fname in files:
-            fpath = os.path.join(root, fname)
-            load_plugin_file(fpath)
-
-    load_inner_plugins()
-
-
-def can_visit_by_role(plugin, current_role):
-    if current_role == "admin":
-        return True
-
-    # permitted_role_list 优先级更高
-    if current_role in plugin.permitted_role_list:
-        return True
-
-    if plugin.require_admin:
-        return False
-
-    if plugin.required_role is None:
-        return True
-
-    if plugin.required_role == current_role:
-        return True
-
-    return False
-
-
-@xutils.timeit(logfile=True, logargs=True, name="FindPlugins")
-def find_plugins(category, orderby=None):
-    current_role = xauth.get_current_role()
-    user_name = xauth.current_name()
-    plugins = []
-
-    if current_role is None:
-        # not logged in
-        return plugins
-
-    if category == "None":
-        category = "other"
-
-    for fname in xconfig.PLUGINS_DICT:
-        p = xconfig.PLUGINS_DICT.get(fname)
-        if p and category in p.category_list:
-            if can_visit_by_role(p, current_role):
-                plugins.append(p)
-    return sorted_plugins(user_name, plugins, orderby)
-
-
-def inner_plugin(name, url, category="inner", url_query="", icon=None):
-    context = PluginContext()
-    context.name = name
-    context.title = name
-    context.url = url
-    context.url_query = url_query
-    context.editable = False
-    context.category = category
-    context.icon_class = "fa fa-cube"
-    context.permitted_role_list = ["admin", "user"]
-    context.require_admin = False
-    context.icon = icon
-    context.icon_class = icon
-    context.build()
-    return context
-
-
-def note_plugin(name, url, icon=None, size=None, required_role="user", url_query=""):
-    context = PluginContext()
-    context.name = name
-    context.title = name
-    context.url = url
-    context.url_query = url_query
-    context.icon = icon
-    context.icon_class = "fa %s" % icon
-    context.size = size
-    context.editable = False
-    context.category = "note"
-    context.require_admin = False
-    context.required_role = required_role
-    context.permitted_role_list = ["admin", "user"]
-    context.build()
-    return context
-
-
-def index_plugin(name, url, url_query=""):
-    return inner_plugin(name, url, "index", url_query=url_query)
-
-
-def file_plugin(name, url, icon=None):
-    return inner_plugin(name, url, "dir", icon=icon)
-
-
-def dev_plugin(name, url):
-    return inner_plugin(name, url, "develop")
-
-
-def system_plugin(name, url):
-    return inner_plugin(name, url, "system")
-
-
-def load_inner_tools():
-    pass
-
-
-INNER_TOOLS = [
-    # 工具集/插件集
-    # index_plugin("笔记工具", "/plugin_list?category=note", url_query = "&show_back=true"),
-    # index_plugin("文件工具", "/plugin_list?category=dir" , url_query = "&show_back=true"),
-    # index_plugin("开发工具", "/plugin_list?category=develop", url_query = "&show_back=true"),
-    # index_plugin("网络工具", "/plugin_list?category=network", url_query = "&show_back=true"),
-    # index_plugin("系统工具", "/plugin_list?category=system" , url_query = "&show_back=true"),
-
-    # 开发工具
-    dev_plugin("浏览器信息", "/tools/browser_info"),
-
-    # 文本
-    dev_plugin("文本对比", "/tools/text_diff"),
-    dev_plugin("文本转换", "/tools/text_convert"),
-    dev_plugin("随机字符串", "/tools/random_string"),
-
-    # 图片
-    dev_plugin("图片合并", "/tools/img_merge"),
-    dev_plugin("图片拆分", "/tools/img_split"),
-    dev_plugin("图像灰度化", "/tools/img2gray"),
-
-    # 编解码
-    dev_plugin("base64", "/tools/base64"),
-    dev_plugin("HEX转换", "/tools/hex"),
-    dev_plugin("md5签名", "/tools/md5"),
-    dev_plugin("sha1签名", "/tools/sha1"),
-    dev_plugin("URL编解码", "/tools/urlcoder"),
-    dev_plugin("条形码", "/tools/barcode"),
-    dev_plugin("二维码", "/tools/qrcode"),
-
-    # 其他工具
-    inner_plugin("分屏模式", "/tools/multi_win"),
-    inner_plugin("RunJS", "/tools/runjs"),
-    inner_plugin("摄像头", "/tools/camera"),
-
-    # 笔记工具
-    note_plugin("新建笔记", "/note/create", "fa-plus-square"),
-    note_plugin("我的置顶", "/note/sticky", "fa-thumb-tack"),
-    note_plugin("搜索历史", "/search/history", "fa-search"),
-    note_plugin("导入笔记", "/note/html_importer",
-                "fa-internet-explorer", required_role="admin"),
-    note_plugin("时间视图", "/note/date", "fa-clock-o",
-                url_query="?show_back=true"),
-    note_plugin("数据统计", "/note/stat", "fa-bar-chart"),
-    note_plugin("上传管理", "/fs_upload", "fa-upload"),
-    note_plugin("笔记批量管理", "/note/management", "fa-gear"),
-    note_plugin("回收站", "/note/removed", "fa-trash"),
-    note_plugin("笔记本", "/note/group", "fa-th-large"),
-    note_plugin("待办任务", "/message?tag=task", "fa-calendar-check-o"),
-    note_plugin("随手记", "/message?tag=log", "fa-file-text-o"),
-    note_plugin("我的相册", "/note/gallery", "fa-photo"),
-    note_plugin("我的清单", "/note/list", "fa-list"),
-    note_plugin("我的日志", "/note/log", "fa-file-text-o"),
-    note_plugin("我的评论", "/note/comment/mine", "fa-comments"),
-    note_plugin("标签列表", "/note/taglist", "fa-tags"),
-    note_plugin("常用笔记", "/note/recent?orderby=hot", "fa-file-text-o"),
-    note_plugin("词典", "/note/dict", "icon-dict"),
-    note_plugin("时光轴", "/note/timeline", "fa-clock-o"),
-
-    # 文件工具
-    file_plugin("文件索引", "/fs_index"),
-    file_plugin("我的收藏夹", "/fs_bookmark", icon="fa fa-folder"),
-
-    # 系统工具
-    system_plugin("系统日志", "/system/log"),
-]
-
-
-def get_inner_tool_name(url):
-    for tool in INNER_TOOLS:
-        if tool.url == url:
-            return tool.name
-    return url
-
-
-def build_inner_tools(user_name=None):
-    if user_name is None:
-        user_name = xauth.current_name()
-    tools_copy = copy.copy(INNER_TOOLS)
-    sort_plugins(user_name, tools_copy)
-    return tools_copy
-
-
-def convert_plugins_to_links(plugins):
-    return plugins
-
-
-def get_plugin_values():
-    values = xconfig.PLUGINS_DICT.values()
-    return list(values)
-
-
-class PluginSort:
-
-    def __init__(self, user_name):
-        self.user_name = user_name
-        self.logs = list_visit_logs(user_name)
-
-    def get_log_by_url(self, url):
-        for log in self.logs:
-            if log.url == url:
-                assert isinstance(log, PageVisitLogDO)
-                return log
-        return None
-
-    def sort_by_visit_cnt_desc(self, plugins):
-        for p in plugins:
-            log = self.get_log_by_url(p.url)
-            if log:
-                p.visit_cnt = log.visit_cnt
-            else:
-                p.visit_cnt = 0
-        plugins.sort(key=lambda x: x.visit_cnt, reverse=True)
-
-    def sort_by_recent(self, plugins):
-        for p in plugins:
-            log = self.get_log_by_url(p.url)
-            if log:
-                p.visit_time = log.visit_time
-            else:
-                p.visit_time = ""
-
-        plugins.sort(key=lambda x: x.visit_time, reverse=True)
-
-
-def sort_plugins(user_name, plugins, orderby=None):
-    sort_obj = PluginSort(user_name)
-    if orderby is None or orderby == "":
-        sort_obj.sort_by_visit_cnt_desc(plugins)
-    elif orderby == "recent":
-        sort_obj.sort_by_recent(plugins)
-    else:
-        raise Exception("invalid orderby:%s" % orderby)
-
-    return plugins
-
-
-def sorted_plugins(user_name, plugins, orderby=None):
-    sort_plugins(user_name, plugins, orderby)
-    return plugins
-
-
-def debug_print_plugins(plugins, ctx=None):
-    if False:
-        print("\n" * 5)
-        print(ctx)
-        for p in plugins:
-            print(p)
-
-
-@logutil.timeit_deco(name="list_all_plugins")
-def list_all_plugins(user_name, sort=True, orderby=None):
-    links = get_plugin_values()
-
-    if sort:
-        return sorted_plugins(user_name, links, orderby)
-
-    return links
-
-
-def list_other_plugins(user_name, sort=True):
-    return find_plugins("other")
-
-
-@logutil.timeit_deco(name="list_plugins")
-def list_plugins(category, sort=True, orderby=None):
-    user_name = xauth.current_name()
-
-    if category == "other":
-        plugins = list_other_plugins(user_name)
-    elif category and category != "all":
-        # 某个分类的插件
-        plugins = find_plugins(category)
-    else:
-        # 所有插件
-        plugins = list_all_plugins(user_name)
-
-    links = convert_plugins_to_links(plugins)
-    if sort:
-        return sorted_plugins(user_name, links, orderby=orderby)
-    return links
-
-
-def find_plugin_by_url(url, plugins):
-    for p in plugins:
-        if u(p.url) == u(url):
-            return p
-    return None
-
-
-@logutil.timeit_deco(name="list_recent_plugins")
-def list_recent_plugins():
-    user_name = xauth.current_name()
-    plugins = list_all_plugins(user_name, sort=False)
-    links = convert_plugins_to_links(plugins)
-
-    sort_plugins(user_name, links, "recent")
-    return links
-
-
-@xmanager.searchable()
-def on_search_plugins(ctx):
-    if not xauth.is_admin():
-        return
-
-    if not ctx.search_tool:
-        return
-
-    if ctx.search_dict:
-        return
-
-    global PLUGINS_STATUS
-    if PLUGINS_STATUS == "loading":
-        result = Storage()
-        result.name = "插件加载中，暂时不可用"
-        result.icon = "fa-th-large"
-        result.url = "#"
-
-        ctx.tools.append(result)
-        return
-
-    user_name = ctx.user_name
-    result_list = []
-    temp_result = []
-
-    for plugin in search_plugins(ctx.key):
-        result = SearchResult()
-        result.category = "plugin"
-        result.icon = "fa-cube"
-        result.name = u(plugin.name)
-        result.name = u(plugin.title + "(" + plugin.name + ")")
-        result.url = u(plugin.url)
-        result.edit_link = plugin.edit_link
-        temp_result.append(result)
-
-    result_count = len(temp_result)
-    if ctx.category != "plugin" and len(temp_result) > 0:
-        more = SearchResult()
-        more.name = u("搜索到[%s]个插件") % result_count
-        more.icon = "fa-th-large"
-        more.url = "/plugins_list?category=plugin&key=" + ctx.key
-        more.show_more_link = True
-        result_list.append(more)
-
-    if xconfig.get_user_config(user_name, "search_plugin_detail_show") == "true":
-        result_list += temp_result[:3]
-
-    ctx.tools += result_list
-
-
-def is_plugin_matched(p, words):
-    return textutil.contains_all(p.title, words) \
-        or textutil.contains_all(p.url, words) \
-        or textutil.contains_all(p.fname, words)
-
-
-def search_plugins(key):
-    from xutils.functions import dictvalues
-    user_name = xauth.current_name()
-    words = textutil.split_words(key)
-    plugins = list_all_plugins(user_name, True)
-    result = dict()
-    for p in plugins:
-        if is_plugin_matched(p, words):
-            result[p.url] = p
-    return dictvalues(result)
-
-
-def get_template_by_version(version):
-    if version == "1":
-        return "plugin/page/plugins_v1.html"
-    if version == "2":
-        return "plugin/page/plugins_v2.html"
-
-    # 最新版本
-    return "plugin/page/plugins_v3.html"
-
-
-def filter_plugins_by_role(plugins, user_role):
-    result = []
-    for p in plugins:
-        if user_role in p.permitted_role_list:
-            result.append(p)
-    return result
-
-
-def fill_plugins_badge_info(plugins, orderby):
-    if orderby == "" or orderby is None:
-        # 默认按热度访问
-        for p in plugins:
-            p.badge_info = "热度: %s" % p.visit_cnt
-    else:
-        # 最近访问的
-        for p in plugins:
-            p.badge_info = dateutil.format_date(p.visit_time)
-
-
-class PluginListHandler:
-
-    @logutil.timeit_deco(name="PluginListHandler")
-    @xauth.login_required()
-    def GET(self):
-        global PLUGINS_STATUS
-        category = xutils.get_argument("category", "")
-        key = xutils.get_argument("key", "")
-        header = xutils.get_argument("header", "")
-        version = xutils.get_argument("version", "")
-        show_back = xutils.get_argument("show_back", "")
-        orderby = xutils.get_argument("orderby", "")
-
-        context = Storage()
-        context.category = category
-        context.category_name = get_category_name_by_code(category)
-        context.html_title = "插件"
-        context.header = header
-        context.show_back = show_back
-
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(
-            user_name, "/plugin_list?category=%s" % category)
-
-        if category == "recent":
-            category = "all"
-            orderby = "recent"
-
-        if xauth.is_admin():
-            if key != "" and key != None:
-                plugins = search_plugins(key)
-                context.show_category = False
-                context.show_back = "true"
-                context.title = T("搜索插件")
-            else:
-                plugins = list_plugins(category, orderby=orderby)
-        else:
-            # 普通用户插件访问
-            user_role = xauth.current_role()
-            plugins = list_plugins(category)
-            plugins = filter_plugins_by_role(plugins, user_role)
-
-        fill_plugins_badge_info(plugins, orderby)
-
-        context.plugins = plugins
-        context.plugins_status = PLUGINS_STATUS
-
-        if category == "":
-            context.plugin_category = "all"
-
-        template_file = get_template_by_version(version)
-        return xtemplate.render(template_file, **context)
-
-
-class PluginCategoryListHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        version = xutils.get_argument_str("version")
-        current_role = xauth.current_role()
-        total_count = 0
-        count_dict = dict()
-
-        for k in xconfig.PLUGINS_DICT:
-            p = xconfig.PLUGINS_DICT[k]
-            if not can_visit_by_role(p, current_role):
-                continue
-
-            total_count += 1
-            for category in p.category_list:
-                count = count_dict.get(category, 0)
-                count += 1
-                count_dict[category] = count
-
-        sorted_items = sorted(count_dict.items(),
-                              key=lambda x: x[1], reverse=True)
-        category_keys = list(map(lambda x: x[0], sorted_items))
-
-        plugins = []
-
-        # 全部插件
-        root = PluginContext()
-        root.title = T("全部")
-        root.url = "/plugin_list?category=all&show_back=true"
-        root.badge_info = total_count
-        root.icon_class = DEFAULT_PLUGIN_ICON_CLASS
-        plugins.append(root)
-
-        for key in category_keys:
-            if key == "":
-                continue
-            p = PluginContext()
-            p.title = get_category_name_by_code(key)
-            url = get_category_url_by_code(key)
-            url = textutil.add_url_param(url, "show_back", "true")
-            p.url = url
-            p.icon_class = get_category_icon_class_by_code(key)
-            p.badge_info = count_dict[key]
-            plugins.append(p)
-
-        template_file = get_template_by_version(version)
-        return xtemplate.render(template_file, plugins=plugins, plugin_category="index")
-
-
-def get_plugin_category(category):
-    plugin_categories = []
-
-    recent = list_recent_plugins()
-    plugins = list_plugins(category)
-    note_plugins = list_plugins("note")
-    dev_plugins = list_plugins("develop")
-    sys_plugins = list_plugins("system")
-    dir_plugins = list_plugins("dir")
-    net_plugins = list_plugins("network")
-    other_plugins = list(filter(lambda x: x.category not in (
-        "inner", "note", "develop", "system", "dir", "network"), plugins))
-
-    plugin_categories.append(["最近", recent])
-    plugin_categories.append(["默认工具", build_inner_tools()])
-    plugin_categories.append(["笔记", note_plugins])
-    plugin_categories.append(["开发工具", dev_plugins])
-    plugin_categories.append(["系统", sys_plugins])
-    plugin_categories.append(["文件", dir_plugins])
-    plugin_categories.append(["网络", net_plugins])
-    plugin_categories.append(["其他", other_plugins])
-    return plugin_categories
-
-
-class PluginGridHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        category = xutils.get_argument("category", "")
-        key = xutils.get_argument("key", "")
-        plugin_categories = []
-
-        if xauth.is_admin():
-            if key != None and key != "":
-                plugin_categories.append(["搜索", search_plugins(key)])
-            else:
-                plugin_categories = get_plugin_category(category)
-        else:
-            plugins = build_inner_tools()
-            plugin_categories.append(["默认工具", plugins])
-
-        return xtemplate.render("plugin/page/plugins_v2.html",
-                                category=category,
-                                html_title="插件",
-                                plugin_categories=plugin_categories)
-
-
-class LoadPluginHandler:
-
-    def resolve_force_reload(self):
-        need_reload = xutils.get_argument_bool("_reload", False)
-        return xauth.is_admin() and need_reload
-
-    def load_plugin(self, name, force_reload=False):
-        context = xconfig.PLUGINS_DICT.get(name)
-
-        if context == None or force_reload:
-            fpath = os.path.join(xconfig.PLUGINS_DIR, name)
-            fpath = xutils.get_real_path(fpath)
-            if not os.path.exists(fpath):
-                return None
-            # 发现了新的插件，重新加载一下
-            return load_plugin_file(fpath)
-        else:
-            return context
-
-    def GET(self, name=""):
-        user_name = xauth.current_name()
-        name = xutils.unquote(name)
-        try:
-            url = "/plugin/" + name
-            force_reload = self.resolve_force_reload()
-            plugin = self.load_plugin(name, force_reload)
-            if plugin != None:
-                # 访问日志
-                add_visit_log(user_name, url)
-                check_and_load_class(plugin)
-                # 渲染页面
-                return plugin.clazz().render()
-            else:
-                # 加载插件失败，删除日志，插件开发过程中出现误删，先不处理
-                # delete_visit_log(user_name, name, url)
-                return xtemplate.render("error.html",
-                                        error="插件[%s]不存在!" % name)
-        except:
-            error = xutils.print_exc()
-            return xtemplate.render("error.html", error=error)
-
-    def POST(self, name=""):
-        return self.GET(name)
-
-
-class LoadInnerToolHandler:
-
-    def GET(self, name):
-        user_name = xauth.current_name()
-        url = "/tools/" + name
-        fname = xutils.unquote(name)
-        if not name.endswith(".html"):
-            fname += ".html"
-        # Chrome下面 tools/timeline不能正常渲染
-        web.header("Content-Type", "text/html")
-        fpath = os.path.join(xconfig.HANDLERS_DIR, "tools", fname)
-        if os.path.exists(fpath):
-            if user_name != None:
-                tool_name = get_inner_tool_name(url)
-                add_visit_log(user_name, url)
-            return xtemplate.render("tools/" + fname, show_aside=False)
-        else:
-            raise web.notfound()
-
-    def POST(self, name):
-        return self.GET(name)
-
-
-class PluginLogHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name()
-        logs = list_visit_logs(user_name)
-        return logs
-
-
-@xmanager.listen("sys.reload")
-@mem_util.log_mem_info_deco("reload_plugins")
-def reload_plugins(ctx):
-    global PLUGINS_STATUS
-    PLUGINS_STATUS = "loading"
-
-    reload_plugins_by_config()
-
-    load_plugin_dir()
-
-    PLUGINS_STATUS = "done"
-
-
-@xutils.log_init_deco("reload_plugins_by_config")
-def reload_plugins_by_config(ctx=None):
-    global CONFIG_TOOLS
-    parser = ConfigParser()
-
-    fpath = "config/plugin/plugins.ini"
-    sections = parser.read(fpath, encoding="utf-8")
-
-    tmp_tools = []
-    for section in parser.sections():
-        name = parser.get(section, "name", fallback=None)
-        icon = parser.get(section, "icon", fallback=None)
-        url = parser.get(section, "url", fallback=None)
-        category = parser.get(section, "category", fallback=None)
-        editable = parser.getboolean(section, "editable", fallback=False)
-
-        # 构建上下文
-        context = PluginContext()
-        context.name = name
-        context.title = name
-        context.url = url
-        context.editable = editable
-        context.category = category
-
-        tmp_tools.append(context)
-
-    CONFIG_TOOLS = tmp_tools
-
-
-xutils.register_func("plugin.find_plugins", find_plugins)
-xutils.register_func("plugin.get_category_list", get_plugin_category_list)
-xutils.register_func("plugin.get_category_url_by_code",
-                     get_category_url_by_code)
-xutils.register_func("plugin.get_category_name_by_code",
-                     get_category_name_by_code)
-xutils.register_func("plugin.define_category", define_plugin_category)
-
-define_plugin_category("all",      u"常用", icon_class="fa fa-th-large")
-define_plugin_category("recent",   u"最近")
-define_plugin_category("note",   u"笔记")
-define_plugin_category("dir",      u"文件", required_roles=[
-                       "admin"], icon_class="fa fa-folder")
-define_plugin_category("system",   u"系统", required_roles=["admin"], platforms=[
-                       "desktop"],  icon_class="fa fa-gear")
-define_plugin_category("network",  u"网络", required_roles=["admin"], platforms=[
-                       "desktop"], icon_class="icon-network-14px")
-define_plugin_category("develop",  u"开发", required_roles=[
-                       "admin", "user"], platforms=["desktop"])
-define_plugin_category("datetime", u"日期和时间", platforms=[],
-                       icon_class="fa fa-clock-o")
-define_plugin_category("work",     u"工作", platforms=[
-                       "desktop"], icon_class="icon-work")
-define_plugin_category("inner",    u"内置工具", platforms=[])
-define_plugin_category("money",    u"理财", platforms=["desktop"])
-define_plugin_category("test",     u"测试", platforms=[])
-define_plugin_category("other",    u"其他", platforms=[])
-define_plugin_category(
-    "index",    u"全部分类", url="/plugin_category_list?category=index", icon_class="fa fa-th-large")
-
-xurls = (
-    r"/plugin/(.+)", LoadPluginHandler,
-    r"/plugin_list", PluginListHandler,
-    r"/plugin_category_list", PluginCategoryListHandler,
-
-    r"/plugins_list_new", PluginGridHandler,
-    r"/plugins_list", PluginListHandler,
-    r"/plugins_log", PluginLogHandler,
-    r"/plugins/(.+)", LoadPluginHandler,
-    r"/tools/(.+)", LoadInnerToolHandler,
-)
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2018/09/30 20:53:38
+# @modified 2022/03/04 23:02:45
+import os
+import xutils
+import web
+import copy
+
+from xnote.core import xconfig
+from xnote.core import xtemplate
+from xnote.core import xauth
+from xnote.core import xmanager
+from xnote.core import xnote_hooks
+
+from xnote.core.xtemplate import T
+from xutils import Storage
+from xutils import fsutil
+from xutils import logutil
+from xutils import textutil, SearchResult, dateutil, u
+from xutils import attrget
+from xutils import mem_util
+from xutils.imports import ConfigParser
+from handlers.plugin.dao import (
+    add_visit_log, list_visit_logs, PageVisitLogDO)
+
+
+from xnote.plugin import load_plugin_file, PluginContext
+
+"""xnote插件模块，由于插件的权限较大，开发权限只开放给管理员，普通用户可以使用
+
+插件的模型：插件包含两部分，程序和数据，程序部分存储在插件目录中的文件，数据存储在数据库或者文件中，
+使用dbutil/fsutil接口操作数据
+- 插件名称、描述、文件名、文件路径
+- 插件的主类
+- 插件的分类
+- 插件的访问权限
+
+插件的生命周期
+- 插件的注册：debug模式下实时注册，非debug模式：初始化注册+按需注册
+- 插件的卸载：退出应用
+- 插件的刷新：刷新系统的时候重新加载
+- 插件的删除：删除插件文件
+
+插件日志：
+- 日志关系：每个用户保留一个插件访问记录，记录最近访问的时间，访问的总次数
+- 日志的创建：访问的时候创建
+- 日志的更新：访问的时候更新
+- 日志的删除：暂无
+
+"""
+
+PLUGIN_CATEGORY_LIST = list()
+
+CONFIG_TOOLS = list()
+
+PLUGINS_STATUS = "loading"
+
+DEFAULT_PLUGIN_ICON_CLASS = "fa fa-cube"
+
+
+def get_current_platform():
+    return xtemplate.get_device_platform()
+
+
+class PluginCategory:
+    """插件分类"""
+    required_roles = None
+    icon_class = "fa fa-cube"
+
+    def __init__(self, code, name, url=None, required_roles=None):
+        self.code = code
+        self.name = name
+        self.required_roles = required_roles
+        self.platforms = None
+        if url is None:
+            self.url = "/plugin_list?category=%s" % self.code
+        else:
+            self.url = url
+
+    def is_visible(self):
+        return self.is_visible_by_roles() and self.is_visible_by_platform()
+
+    def is_visible_by_platform(self):
+        if self.platforms is None:
+            return True
+        return get_current_platform() in self.platforms
+
+    def is_visible_by_roles(self):
+        if self.required_roles is None:
+            return True
+        return xauth.current_role() in self.required_roles
+
+
+def define_plugin_category(code: str,
+                           name: str,
+                           url=None,
+                           raise_duplication=True,
+                           required_roles=None,
+                           platforms=None,
+                           icon_class=None):
+    global PLUGIN_CATEGORY_LIST
+    for item in PLUGIN_CATEGORY_LIST:
+        if item.code == code:
+            if raise_duplication:
+                raise Exception("code: %s is defined" % code)
+            else:
+                return
+        if item.name == name:
+            if raise_duplication:
+                raise Exception("name: %s is defined" % name)
+            else:
+                return
+    category = PluginCategory(code, name, url, required_roles)
+    category.platforms = platforms
+    if icon_class != None:
+        category.icon_class = icon_class
+    PLUGIN_CATEGORY_LIST.append(category)
+
+
+def get_plugin_category_list():
+    global PLUGIN_CATEGORY_LIST
+    return PLUGIN_CATEGORY_LIST
+
+
+def get_category_url_by_code(code):
+    if code is None:
+        return "/plugin_list?category=all"
+    for item in PLUGIN_CATEGORY_LIST:
+        if item.code == code:
+            return item.url
+    return "/plugin_list?category=%s" % code
+
+
+def get_category_name_by_code(code: str):
+    category = get_category_by_code(code)
+    if category != None:
+        return category.name
+
+    # 如果没有定义，就返回code
+    return code
+
+xnote_hooks.get_category_name_by_code = get_category_name_by_code
+
+def get_category_by_code(code: str):
+    for item in PLUGIN_CATEGORY_LIST:
+        if item.code == code:
+            return item
+    return None
+
+
+def get_category_icon_class_by_code(code):
+    category = get_category_by_code(code)
+    if category is None:
+        return DEFAULT_PLUGIN_ICON_CLASS
+    return category.icon_class
+
+
+def check_and_load_class(plugin):
+    if plugin.clazz is not None:
+        return
+
+    load_plugin_file(plugin.fpath)
+
+
+def load_inner_plugins():
+    for tool in INNER_TOOLS:
+        xconfig.PLUGINS_DICT[tool.url] = tool
+
+
+def load_plugin_dir(dirname=None):
+    """加载插件目录"""
+    if dirname is None:
+        dirname = xconfig.PLUGINS_DIR
+
+    xconfig.PLUGINS_DICT = {}
+    for root, dirs, files in os.walk(dirname):
+        for fname in files:
+            fpath = os.path.join(root, fname)
+            load_plugin_file(fpath)
+
+    load_inner_plugins()
+
+
+def can_visit_by_role(plugin, current_role):
+    if current_role == "admin":
+        return True
+
+    # permitted_role_list 优先级更高
+    if current_role in plugin.permitted_role_list:
+        return True
+
+    if plugin.require_admin:
+        return False
+
+    if plugin.required_role is None:
+        return True
+
+    if plugin.required_role == current_role:
+        return True
+
+    return False
+
+
+@xutils.timeit(logfile=True, logargs=True, name="FindPlugins")
+def find_plugins(category, orderby=None):
+    current_role = xauth.get_current_role()
+    user_name = xauth.current_name()
+    plugins = []
+
+    if current_role is None:
+        # not logged in
+        return plugins
+
+    if category == "None":
+        category = "other"
+
+    for fname in xconfig.PLUGINS_DICT:
+        p = xconfig.PLUGINS_DICT.get(fname)
+        if p and category in p.category_list:
+            if can_visit_by_role(p, current_role):
+                plugins.append(p)
+    return sorted_plugins(user_name, plugins, orderby)
+
+
+def inner_plugin(name, url, category="inner", url_query="", icon=None):
+    context = PluginContext()
+    context.name = name
+    context.title = name
+    context.url = url
+    context.url_query = url_query
+    context.editable = False
+    context.category = category
+    context.icon_class = "fa fa-cube"
+    context.permitted_role_list = ["admin", "user"]
+    context.require_admin = False
+    context.icon = icon
+    context.icon_class = icon
+    context.build()
+    return context
+
+
+def note_plugin(name, url, icon=None, size=None, required_role="user", url_query=""):
+    context = PluginContext()
+    context.name = name
+    context.title = name
+    context.url = url
+    context.url_query = url_query
+    context.icon = icon
+    context.icon_class = "fa %s" % icon
+    context.size = size
+    context.editable = False
+    context.category = "note"
+    context.require_admin = False
+    context.required_role = required_role
+    context.permitted_role_list = ["admin", "user"]
+    context.build()
+    return context
+
+
+def index_plugin(name, url, url_query=""):
+    return inner_plugin(name, url, "index", url_query=url_query)
+
+
+def file_plugin(name, url, icon=None):
+    return inner_plugin(name, url, "dir", icon=icon)
+
+
+def dev_plugin(name, url):
+    return inner_plugin(name, url, "develop")
+
+
+def system_plugin(name, url):
+    return inner_plugin(name, url, "system")
+
+
+def load_inner_tools():
+    pass
+
+
+INNER_TOOLS = [
+    # 工具集/插件集
+    # index_plugin("笔记工具", "/plugin_list?category=note", url_query = "&show_back=true"),
+    # index_plugin("文件工具", "/plugin_list?category=dir" , url_query = "&show_back=true"),
+    # index_plugin("开发工具", "/plugin_list?category=develop", url_query = "&show_back=true"),
+    # index_plugin("网络工具", "/plugin_list?category=network", url_query = "&show_back=true"),
+    # index_plugin("系统工具", "/plugin_list?category=system" , url_query = "&show_back=true"),
+
+    # 开发工具
+    dev_plugin("浏览器信息", "/tools/browser_info"),
+
+    # 文本
+    dev_plugin("文本对比", "/tools/text_diff"),
+    dev_plugin("文本转换", "/tools/text_convert"),
+    dev_plugin("随机字符串", "/tools/random_string"),
+
+    # 图片
+    dev_plugin("图片合并", "/tools/img_merge"),
+    dev_plugin("图片拆分", "/tools/img_split"),
+    dev_plugin("图像灰度化", "/tools/img2gray"),
+
+    # 编解码
+    dev_plugin("base64", "/tools/base64"),
+    dev_plugin("HEX转换", "/tools/hex"),
+    dev_plugin("md5签名", "/tools/md5"),
+    dev_plugin("sha1签名", "/tools/sha1"),
+    dev_plugin("URL编解码", "/tools/urlcoder"),
+    dev_plugin("条形码", "/tools/barcode"),
+    dev_plugin("二维码", "/tools/qrcode"),
+
+    # 其他工具
+    inner_plugin("分屏模式", "/tools/multi_win"),
+    inner_plugin("RunJS", "/tools/runjs"),
+    inner_plugin("摄像头", "/tools/camera"),
+
+    # 笔记工具
+    note_plugin("新建笔记", "/note/create", "fa-plus-square"),
+    note_plugin("我的置顶", "/note/sticky", "fa-thumb-tack"),
+    note_plugin("搜索历史", "/search/history", "fa-search"),
+    note_plugin("导入笔记", "/note/html_importer",
+                "fa-internet-explorer", required_role="admin"),
+    note_plugin("时间视图", "/note/date", "fa-clock-o",
+                url_query="?show_back=true"),
+    note_plugin("数据统计", "/note/stat", "fa-bar-chart"),
+    note_plugin("上传管理", "/fs_upload", "fa-upload"),
+    note_plugin("笔记批量管理", "/note/management", "fa-gear"),
+    note_plugin("回收站", "/note/removed", "fa-trash"),
+    note_plugin("笔记本", "/note/group", "fa-th-large"),
+    note_plugin("待办任务", "/message?tag=task", "fa-calendar-check-o"),
+    note_plugin("随手记", "/message?tag=log", "fa-file-text-o"),
+    note_plugin("我的相册", "/note/gallery", "fa-photo"),
+    note_plugin("我的清单", "/note/list", "fa-list"),
+    note_plugin("我的日志", "/note/log", "fa-file-text-o"),
+    note_plugin("我的评论", "/note/comment/mine", "fa-comments"),
+    note_plugin("标签列表", "/note/taglist", "fa-tags"),
+    note_plugin("常用笔记", "/note/recent?orderby=hot", "fa-file-text-o"),
+    note_plugin("词典", "/note/dict", "icon-dict"),
+    note_plugin("时光轴", "/note/timeline", "fa-clock-o"),
+
+    # 文件工具
+    file_plugin("文件索引", "/fs_index"),
+    file_plugin("我的收藏夹", "/fs_bookmark", icon="fa fa-folder"),
+
+    # 系统工具
+    system_plugin("系统日志", "/system/log"),
+]
+
+
+def get_inner_tool_name(url):
+    for tool in INNER_TOOLS:
+        if tool.url == url:
+            return tool.name
+    return url
+
+
+def build_inner_tools(user_name=None):
+    if user_name is None:
+        user_name = xauth.current_name()
+    tools_copy = copy.copy(INNER_TOOLS)
+    sort_plugins(user_name, tools_copy)
+    return tools_copy
+
+
+def convert_plugins_to_links(plugins):
+    return plugins
+
+
+def get_plugin_values():
+    values = xconfig.PLUGINS_DICT.values()
+    return list(values)
+
+
+class PluginSort:
+
+    def __init__(self, user_name):
+        self.user_name = user_name
+        self.logs = list_visit_logs(user_name)
+
+    def get_log_by_url(self, url):
+        for log in self.logs:
+            if log.url == url:
+                assert isinstance(log, PageVisitLogDO)
+                return log
+        return None
+
+    def sort_by_visit_cnt_desc(self, plugins):
+        for p in plugins:
+            log = self.get_log_by_url(p.url)
+            if log:
+                p.visit_cnt = log.visit_cnt
+            else:
+                p.visit_cnt = 0
+        plugins.sort(key=lambda x: x.visit_cnt, reverse=True)
+
+    def sort_by_recent(self, plugins):
+        for p in plugins:
+            log = self.get_log_by_url(p.url)
+            if log:
+                p.visit_time = log.visit_time
+            else:
+                p.visit_time = ""
+
+        plugins.sort(key=lambda x: x.visit_time, reverse=True)
+
+
+def sort_plugins(user_name, plugins, orderby=None):
+    sort_obj = PluginSort(user_name)
+    if orderby is None or orderby == "":
+        sort_obj.sort_by_visit_cnt_desc(plugins)
+    elif orderby == "recent":
+        sort_obj.sort_by_recent(plugins)
+    else:
+        raise Exception("invalid orderby:%s" % orderby)
+
+    return plugins
+
+
+def sorted_plugins(user_name, plugins, orderby=None):
+    sort_plugins(user_name, plugins, orderby)
+    return plugins
+
+
+def debug_print_plugins(plugins, ctx=None):
+    if False:
+        print("\n" * 5)
+        print(ctx)
+        for p in plugins:
+            print(p)
+
+
+@logutil.timeit_deco(name="list_all_plugins")
+def list_all_plugins(user_name, sort=True, orderby=None):
+    links = get_plugin_values()
+
+    if sort:
+        return sorted_plugins(user_name, links, orderby)
+
+    return links
+
+
+def list_other_plugins(user_name, sort=True):
+    return find_plugins("other")
+
+
+@logutil.timeit_deco(name="list_plugins")
+def list_plugins(category, sort=True, orderby=None):
+    user_name = xauth.current_name()
+
+    if category == "other":
+        plugins = list_other_plugins(user_name)
+    elif category and category != "all":
+        # 某个分类的插件
+        plugins = find_plugins(category)
+    else:
+        # 所有插件
+        plugins = list_all_plugins(user_name)
+
+    links = convert_plugins_to_links(plugins)
+    if sort:
+        return sorted_plugins(user_name, links, orderby=orderby)
+    return links
+
+
+def find_plugin_by_url(url, plugins):
+    for p in plugins:
+        if u(p.url) == u(url):
+            return p
+    return None
+
+
+@logutil.timeit_deco(name="list_recent_plugins")
+def list_recent_plugins():
+    user_name = xauth.current_name()
+    plugins = list_all_plugins(user_name, sort=False)
+    links = convert_plugins_to_links(plugins)
+
+    sort_plugins(user_name, links, "recent")
+    return links
+
+
+@xmanager.searchable()
+def on_search_plugins(ctx):
+    if not xauth.is_admin():
+        return
+
+    if not ctx.search_tool:
+        return
+
+    if ctx.search_dict:
+        return
+
+    global PLUGINS_STATUS
+    if PLUGINS_STATUS == "loading":
+        result = Storage()
+        result.name = "插件加载中，暂时不可用"
+        result.icon = "fa-th-large"
+        result.url = "#"
+
+        ctx.tools.append(result)
+        return
+
+    user_name = ctx.user_name
+    result_list = []
+    temp_result = []
+
+    for plugin in search_plugins(ctx.key):
+        result = SearchResult()
+        result.category = "plugin"
+        result.icon = "fa-cube"
+        result.name = u(plugin.name)
+        result.name = u(plugin.title + "(" + plugin.name + ")")
+        result.url = u(plugin.url)
+        result.edit_link = plugin.edit_link
+        temp_result.append(result)
+
+    result_count = len(temp_result)
+    if ctx.category != "plugin" and len(temp_result) > 0:
+        more = SearchResult()
+        more.name = u("搜索到[%s]个插件") % result_count
+        more.icon = "fa-th-large"
+        more.url = "/plugins_list?category=plugin&key=" + ctx.key
+        more.show_more_link = True
+        result_list.append(more)
+
+    if xconfig.get_user_config(user_name, "search_plugin_detail_show") == "true":
+        result_list += temp_result[:3]
+
+    ctx.tools += result_list
+
+
+def is_plugin_matched(p, words):
+    return textutil.contains_all(p.title, words) \
+        or textutil.contains_all(p.url, words) \
+        or textutil.contains_all(p.fname, words)
+
+
+def search_plugins(key):
+    from xutils.functions import dictvalues
+    user_name = xauth.current_name()
+    words = textutil.split_words(key)
+    plugins = list_all_plugins(user_name, True)
+    result = dict()
+    for p in plugins:
+        if is_plugin_matched(p, words):
+            result[p.url] = p
+    return dictvalues(result)
+
+
+def get_template_by_version(version):
+    if version == "1":
+        return "plugin/page/plugins_v1.html"
+    if version == "2":
+        return "plugin/page/plugins_v2.html"
+
+    # 最新版本
+    return "plugin/page/plugins_v3.html"
+
+
+def filter_plugins_by_role(plugins, user_role):
+    result = []
+    for p in plugins:
+        if user_role in p.permitted_role_list:
+            result.append(p)
+    return result
+
+
+def fill_plugins_badge_info(plugins, orderby):
+    if orderby == "" or orderby is None:
+        # 默认按热度访问
+        for p in plugins:
+            p.badge_info = "热度: %s" % p.visit_cnt
+    else:
+        # 最近访问的
+        for p in plugins:
+            p.badge_info = dateutil.format_date(p.visit_time)
+
+
+class PluginListHandler:
+
+    @logutil.timeit_deco(name="PluginListHandler")
+    @xauth.login_required()
+    def GET(self):
+        global PLUGINS_STATUS
+        category = xutils.get_argument("category", "")
+        key = xutils.get_argument("key", "")
+        header = xutils.get_argument("header", "")
+        version = xutils.get_argument("version", "")
+        show_back = xutils.get_argument("show_back", "")
+        orderby = xutils.get_argument("orderby", "")
+
+        context = Storage()
+        context.category = category
+        context.category_name = get_category_name_by_code(category)
+        context.html_title = "插件"
+        context.header = header
+        context.show_back = show_back
+
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(
+            user_name, "/plugin_list?category=%s" % category)
+
+        if category == "recent":
+            category = "all"
+            orderby = "recent"
+
+        if xauth.is_admin():
+            if key != "" and key != None:
+                plugins = search_plugins(key)
+                context.show_category = False
+                context.show_back = "true"
+                context.title = T("搜索插件")
+            else:
+                plugins = list_plugins(category, orderby=orderby)
+        else:
+            # 普通用户插件访问
+            user_role = xauth.current_role()
+            plugins = list_plugins(category)
+            plugins = filter_plugins_by_role(plugins, user_role)
+
+        fill_plugins_badge_info(plugins, orderby)
+
+        context.plugins = plugins
+        context.plugins_status = PLUGINS_STATUS
+
+        if category == "":
+            context.plugin_category = "all"
+
+        template_file = get_template_by_version(version)
+        return xtemplate.render(template_file, **context)
+
+
+class PluginCategoryListHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        version = xutils.get_argument_str("version")
+        current_role = xauth.current_role()
+        total_count = 0
+        count_dict = dict()
+
+        for k in xconfig.PLUGINS_DICT:
+            p = xconfig.PLUGINS_DICT[k]
+            if not can_visit_by_role(p, current_role):
+                continue
+
+            total_count += 1
+            for category in p.category_list:
+                count = count_dict.get(category, 0)
+                count += 1
+                count_dict[category] = count
+
+        sorted_items = sorted(count_dict.items(),
+                              key=lambda x: x[1], reverse=True)
+        category_keys = list(map(lambda x: x[0], sorted_items))
+
+        plugins = []
+
+        # 全部插件
+        root = PluginContext()
+        root.title = T("全部")
+        root.url = "/plugin_list?category=all&show_back=true"
+        root.badge_info = total_count
+        root.icon_class = DEFAULT_PLUGIN_ICON_CLASS
+        plugins.append(root)
+
+        for key in category_keys:
+            if key == "":
+                continue
+            p = PluginContext()
+            p.title = get_category_name_by_code(key)
+            url = get_category_url_by_code(key)
+            url = textutil.add_url_param(url, "show_back", "true")
+            p.url = url
+            p.icon_class = get_category_icon_class_by_code(key)
+            p.badge_info = count_dict[key]
+            plugins.append(p)
+
+        template_file = get_template_by_version(version)
+        return xtemplate.render(template_file, plugins=plugins, plugin_category="index")
+
+
+def get_plugin_category(category):
+    plugin_categories = []
+
+    recent = list_recent_plugins()
+    plugins = list_plugins(category)
+    note_plugins = list_plugins("note")
+    dev_plugins = list_plugins("develop")
+    sys_plugins = list_plugins("system")
+    dir_plugins = list_plugins("dir")
+    net_plugins = list_plugins("network")
+    other_plugins = list(filter(lambda x: x.category not in (
+        "inner", "note", "develop", "system", "dir", "network"), plugins))
+
+    plugin_categories.append(["最近", recent])
+    plugin_categories.append(["默认工具", build_inner_tools()])
+    plugin_categories.append(["笔记", note_plugins])
+    plugin_categories.append(["开发工具", dev_plugins])
+    plugin_categories.append(["系统", sys_plugins])
+    plugin_categories.append(["文件", dir_plugins])
+    plugin_categories.append(["网络", net_plugins])
+    plugin_categories.append(["其他", other_plugins])
+    return plugin_categories
+
+
+class PluginGridHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        category = xutils.get_argument("category", "")
+        key = xutils.get_argument("key", "")
+        plugin_categories = []
+
+        if xauth.is_admin():
+            if key != None and key != "":
+                plugin_categories.append(["搜索", search_plugins(key)])
+            else:
+                plugin_categories = get_plugin_category(category)
+        else:
+            plugins = build_inner_tools()
+            plugin_categories.append(["默认工具", plugins])
+
+        return xtemplate.render("plugin/page/plugins_v2.html",
+                                category=category,
+                                html_title="插件",
+                                plugin_categories=plugin_categories)
+
+
+class LoadPluginHandler:
+
+    def resolve_force_reload(self):
+        need_reload = xutils.get_argument_bool("_reload", False)
+        return xauth.is_admin() and need_reload
+
+    def load_plugin(self, name, force_reload=False):
+        context = xconfig.PLUGINS_DICT.get(name)
+
+        if context == None or force_reload:
+            fpath = os.path.join(xconfig.PLUGINS_DIR, name)
+            fpath = xutils.get_real_path(fpath)
+            if not os.path.exists(fpath):
+                return None
+            # 发现了新的插件，重新加载一下
+            return load_plugin_file(fpath)
+        else:
+            return context
+
+    def GET(self, name=""):
+        user_name = xauth.current_name()
+        name = xutils.unquote(name)
+        try:
+            url = "/plugin/" + name
+            force_reload = self.resolve_force_reload()
+            plugin = self.load_plugin(name, force_reload)
+            if plugin != None:
+                # 访问日志
+                add_visit_log(user_name, url)
+                check_and_load_class(plugin)
+                # 渲染页面
+                return plugin.clazz().render()
+            else:
+                # 加载插件失败，删除日志，插件开发过程中出现误删，先不处理
+                # delete_visit_log(user_name, name, url)
+                return xtemplate.render("error.html",
+                                        error="插件[%s]不存在!" % name)
+        except:
+            error = xutils.print_exc()
+            return xtemplate.render("error.html", error=error)
+
+    def POST(self, name=""):
+        return self.GET(name)
+
+
+class LoadInnerToolHandler:
+
+    def GET(self, name):
+        user_name = xauth.current_name()
+        url = "/tools/" + name
+        fname = xutils.unquote(name)
+        if not name.endswith(".html"):
+            fname += ".html"
+        # Chrome下面 tools/timeline不能正常渲染
+        web.header("Content-Type", "text/html")
+        fpath = os.path.join(xconfig.HANDLERS_DIR, "tools", fname)
+        if os.path.exists(fpath):
+            if user_name != None:
+                tool_name = get_inner_tool_name(url)
+                add_visit_log(user_name, url)
+            return xtemplate.render("tools/" + fname, show_aside=False)
+        else:
+            raise web.notfound()
+
+    def POST(self, name):
+        return self.GET(name)
+
+
+class PluginLogHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name()
+        logs = list_visit_logs(user_name)
+        return logs
+
+
+@xmanager.listen("sys.reload")
+@mem_util.log_mem_info_deco("reload_plugins")
+def reload_plugins(ctx):
+    global PLUGINS_STATUS
+    PLUGINS_STATUS = "loading"
+
+    reload_plugins_by_config()
+
+    load_plugin_dir()
+
+    PLUGINS_STATUS = "done"
+
+
+@xutils.log_init_deco("reload_plugins_by_config")
+def reload_plugins_by_config(ctx=None):
+    global CONFIG_TOOLS
+    parser = ConfigParser()
+
+    fpath = "config/plugin/plugins.ini"
+    sections = parser.read(fpath, encoding="utf-8")
+
+    tmp_tools = []
+    for section in parser.sections():
+        name = parser.get(section, "name", fallback=None)
+        icon = parser.get(section, "icon", fallback=None)
+        url = parser.get(section, "url", fallback=None)
+        category = parser.get(section, "category", fallback=None)
+        editable = parser.getboolean(section, "editable", fallback=False)
+
+        # 构建上下文
+        context = PluginContext()
+        context.name = name
+        context.title = name
+        context.url = url
+        context.editable = editable
+        context.category = category
+
+        tmp_tools.append(context)
+
+    CONFIG_TOOLS = tmp_tools
+
+
+xutils.register_func("plugin.find_plugins", find_plugins)
+xutils.register_func("plugin.get_category_list", get_plugin_category_list)
+xutils.register_func("plugin.get_category_url_by_code",
+                     get_category_url_by_code)
+xutils.register_func("plugin.get_category_name_by_code",
+                     get_category_name_by_code)
+xutils.register_func("plugin.define_category", define_plugin_category)
+
+define_plugin_category("all",      u"常用", icon_class="fa fa-th-large")
+define_plugin_category("recent",   u"最近")
+define_plugin_category("note",   u"笔记")
+define_plugin_category("dir",      u"文件", required_roles=[
+                       "admin"], icon_class="fa fa-folder")
+define_plugin_category("system",   u"系统", required_roles=["admin"], platforms=[
+                       "desktop"],  icon_class="fa fa-gear")
+define_plugin_category("network",  u"网络", required_roles=["admin"], platforms=[
+                       "desktop"], icon_class="icon-network-14px")
+define_plugin_category("develop",  u"开发", required_roles=[
+                       "admin", "user"], platforms=["desktop"])
+define_plugin_category("datetime", u"日期和时间", platforms=[],
+                       icon_class="fa fa-clock-o")
+define_plugin_category("work",     u"工作", platforms=[
+                       "desktop"], icon_class="icon-work")
+define_plugin_category("inner",    u"内置工具", platforms=[])
+define_plugin_category("money",    u"理财", platforms=["desktop"])
+define_plugin_category("test",     u"测试", platforms=[])
+define_plugin_category("other",    u"其他", platforms=[])
+define_plugin_category(
+    "index",    u"全部分类", url="/plugin_category_list?category=index", icon_class="fa fa-th-large")
+
+xurls = (
+    r"/plugin/(.+)", LoadPluginHandler,
+    r"/plugin_list", PluginListHandler,
+    r"/plugin_category_list", PluginCategoryListHandler,
+
+    r"/plugins_list_new", PluginGridHandler,
+    r"/plugins_list", PluginListHandler,
+    r"/plugins_log", PluginLogHandler,
+    r"/plugins/(.+)", LoadPluginHandler,
+    r"/tools/(.+)", LoadInnerToolHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/search/ajax/search_dialog.html` & `xnote-web-0.1.1/handlers/search/ajax/search_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/ajax/search_dialog_detail.html` & `xnote-web-0.1.1/handlers/search/ajax/search_dialog_detail.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/api.py` & `xnote-web-0.1.1/handlers/search/api.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/calc.py` & `xnote-web-0.1.1/handlers/search/calc.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/component/search_pagination.html` & `xnote-web-0.1.1/handlers/search/component/search_pagination.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/component/search_sidebar.html` & `xnote-web-0.1.1/handlers/search/component/search_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/component/search_tab.html` & `xnote-web-0.1.1/handlers/search/component/search_tab.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/dictionary.py` & `xnote-web-0.1.1/handlers/search/dictionary.py`

 * *Ordering differences only*

 * *Files 22% similar despite different names*

```diff
@@ -1,114 +1,114 @@
-# -*- coding:utf-8 -*-  
-# Created by xupingmao on 2017/06/11
-# @modified 2021/07/18 19:13:02
-
-"""英汉、汉英词典
-
-dictDTB结构
-    _id integer primary key autoincrement,
-    en text,cn text,
-    symbol text 指音标
-
-"""
-import re
-import os
-import xutils
-from xnote.core import xmanager
-from xnote.core import xconfig
-from xnote.core import xtables
-from xutils import u, Storage, SearchResult, textutil
-from xnote.core.xtemplate import T
-
-def wrap_results(dicts, origin_key):
-    files = []
-    for f0 in dicts:
-        f = SearchResult()
-        f.key = u(f0["key"])
-        f.category = "dict"
-        f.name = u("翻译 - ") + u(f0[origin_key])
-        f.raw = f0["value"].replace("\\n", "\n")
-        f.url = "#"
-        f.icon = "hide"
-        f.id = f0.id
-        files.append(f)
-    return files
-
-def search(ctx, word):
-    """英汉翻译"""
-    word = word.lower()
-    path = os.path.join(xconfig.DATA_PATH, "dictionary.db")
-    if not os.path.exists(path):
-        return []
-    # COLLATE NOCASE是sqlite的方言
-    # 比较通用的做法是冗余字段
-    sql = "SELECT * FROM dictTB WHERE en=? COLLATE NOCASE"
-    dicts = xutils.db_execute(path, sql, (word,))
-    return wrap_results(dicts, "en")
-
-# \u7ffb\u8bd1 翻译
-# \u5b9a\u4e49 定义
-@xmanager.searchable(r"(翻译|定义|define|def|translate)\s+([^\s]+)")
-def do_translate(ctx):
-    key  = ctx.key
-    word = ctx.groups[1]
-    word = word.strip().lower()
-    path = os.path.join(xconfig.DATA_PATH, "dictionary.db")
-    if not os.path.exists(path):
-        return
-    user_name = ctx.user_name
-    table     = xtables.get_dict_table()
-    if textutil.isalpha(word):
-        dicts = table.select(where="`key` LIKE $key",
-            vars = dict(key = word + '%'))
-    else:
-        dicts = table.select(where="value LIKE $value", 
-            vars = dict(value = '%' + word + '%'))
-    ctx.dicts += wrap_results(dicts, "key")
-
-@xmanager.searchable(r".+")
-def do_translate_strict(ctx):
-    if not ctx.search_dict_strict:
-        return
-
-    user_name = ctx.user_name
-    db = xtables.get_dict_table()
-    results = db.select(where="`key` = $key", vars=dict(key=ctx.input_text))
-    for item in results:
-        value = item.value.replace("\\n", "\n")
-
-        result = Storage()
-        result.name = T("search_definition") % item.key
-        result.key = item.key
-        result.raw = value
-        result.url = "#"
-        result.icon = "icon-dict"
-        result.category = "dict"
-        result.id = item.id
-
-        ctx.dicts.append(result)
-
-@xmanager.searchable(r"[a-zA-Z\-]+")
-def translate_english(ctx):
-    """使用词库进行部分模糊匹配"""
-    if not ctx.search_dict:
-        return
-
-    user_name = ctx.user_name
-    db = xtables.get_dict_table()
-    results = db.select(where="key like $key", vars=dict(key=ctx.input_text + "%"))
-    for item in results:
-        value = item.value.replace("\\n", "\n")
-
-        result = Storage()
-        result.name = u("翻译 - %s") % item.key
-        result.key = item.key
-        result.raw = value
-        result.url = "#"
-        result.category = "dict"
-        result.id = item.id
-
-        ctx.dicts.append(result)
-
-
-
-
+# -*- coding:utf-8 -*-  
+# Created by xupingmao on 2017/06/11
+# @modified 2021/07/18 19:13:02
+
+"""英汉、汉英词典
+
+dictDTB结构
+    _id integer primary key autoincrement,
+    en text,cn text,
+    symbol text 指音标
+
+"""
+import re
+import os
+import xutils
+from xnote.core import xmanager
+from xnote.core import xconfig
+from xnote.core import xtables
+from xutils import u, Storage, SearchResult, textutil
+from xnote.core.xtemplate import T
+
+def wrap_results(dicts, origin_key):
+    files = []
+    for f0 in dicts:
+        f = SearchResult()
+        f.key = u(f0["key"])
+        f.category = "dict"
+        f.name = u("翻译 - ") + u(f0[origin_key])
+        f.raw = f0["value"].replace("\\n", "\n")
+        f.url = "#"
+        f.icon = "hide"
+        f.id = f0.id
+        files.append(f)
+    return files
+
+def search(ctx, word):
+    """英汉翻译"""
+    word = word.lower()
+    path = os.path.join(xconfig.DATA_PATH, "dictionary.db")
+    if not os.path.exists(path):
+        return []
+    # COLLATE NOCASE是sqlite的方言
+    # 比较通用的做法是冗余字段
+    sql = "SELECT * FROM dictTB WHERE en=? COLLATE NOCASE"
+    dicts = xutils.db_execute(path, sql, (word,))
+    return wrap_results(dicts, "en")
+
+# \u7ffb\u8bd1 翻译
+# \u5b9a\u4e49 定义
+@xmanager.searchable(r"(翻译|定义|define|def|translate)\s+([^\s]+)")
+def do_translate(ctx):
+    key  = ctx.key
+    word = ctx.groups[1]
+    word = word.strip().lower()
+    path = os.path.join(xconfig.DATA_PATH, "dictionary.db")
+    if not os.path.exists(path):
+        return
+    user_name = ctx.user_name
+    table     = xtables.get_dict_table()
+    if textutil.isalpha(word):
+        dicts = table.select(where="`key` LIKE $key",
+            vars = dict(key = word + '%'))
+    else:
+        dicts = table.select(where="value LIKE $value", 
+            vars = dict(value = '%' + word + '%'))
+    ctx.dicts += wrap_results(dicts, "key")
+
+@xmanager.searchable(r".+")
+def do_translate_strict(ctx):
+    if not ctx.search_dict_strict:
+        return
+
+    user_name = ctx.user_name
+    db = xtables.get_dict_table()
+    results = db.select(where="`key` = $key", vars=dict(key=ctx.input_text))
+    for item in results:
+        value = item.value.replace("\\n", "\n")
+
+        result = Storage()
+        result.name = T("search_definition") % item.key
+        result.key = item.key
+        result.raw = value
+        result.url = "#"
+        result.icon = "icon-dict"
+        result.category = "dict"
+        result.id = item.id
+
+        ctx.dicts.append(result)
+
+@xmanager.searchable(r"[a-zA-Z\-]+")
+def translate_english(ctx):
+    """使用词库进行部分模糊匹配"""
+    if not ctx.search_dict:
+        return
+
+    user_name = ctx.user_name
+    db = xtables.get_dict_table()
+    results = db.select(where="key like $key", vars=dict(key=ctx.input_text + "%"))
+    for item in results:
+        value = item.value.replace("\\n", "\n")
+
+        result = Storage()
+        result.name = u("翻译 - %s") % item.key
+        result.key = item.key
+        result.raw = value
+        result.url = "#"
+        result.category = "dict"
+        result.id = item.id
+
+        ctx.dicts.append(result)
+
+
+
+
```

### Comparing `xnote-web-0.1.0/handlers/search/mute.py` & `xnote-web-0.1.1/handlers/search/mute.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/note.py` & `xnote-web-0.1.1/handlers/search/note.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/page/search_history.html` & `xnote-web-0.1.1/handlers/search/page/search_history.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/page/search_result.html` & `xnote-web-0.1.1/handlers/search/page/search_result.html`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,175 +1,175 @@
-{% extends base.html %}
-<!--
-@author xupingmao
-@since 2017/11/29
-@modified 2022/03/12 11:04:23
--->
-
-{% block body_left %}
-
-{% init recent = [] %}
-{% init tools  = [] %}
-{% init page_max  = 0 %}
-{% init show_path = False %}
-
-<div id="executeResult">
-</div>
-
-{% if show_path %}
-    <div class="card">
-        <h3 class="card-title">
-            <a href="{{parent.url}}" class="link2">{{parent.name}}</a> / 
-            <a href="{{current.url}}" class="link2">{{current.name}}</a>
-        </h3>
-    </div>
-{% end %}
-
-<div class="col-md-12 result-list">
-
-    <div class="card">
-        <div class="card-title">
-            <span>综合搜索</span>
-            <div class="float-right">
-                <a class="btn btn-default" href="{{_server_home}}/system/settings?category=search">设置</a>
-                <a class="btn btn-default" href="{{_server_home}}/search/history">搜索历史</a>
-                {% include common/button/back_button.html %}
-            </div>
-        </div>
-    </div>
-
-    {% include search/component/search_tab.html %}
-
-    {% if len(tools) > 0 %}
-        <div class="card">
-            <h3 class="card-title">脚本</h3>
-            {% for tool in tools %}
-                <a class="tag-span" href="{{tool.url}}">{{tool.name}}</a>
-            {% end %}
-        </div>
-    {% end %}
-
-    {% for i, file in enumerate(files) %}
-    <div class="card"> 
-        <div class="note-body">
-            {# 右侧操作选项 #}
-            <div class="note-visited-cnt">
-                {# 快捷命令 #}
-                {% if file.get("command") != None %}
-                    <input type="button" class="btn execute-btn float-right" value="执行" href="{{file.command}}"/>
-                {% end %}
-
-                {% if file.show_move == True %}
-                    <a class="item-option move-btn" data-id="{{file.id}}">移动</a>
-                {% end %}
-
-                {# 插件 #}
-                {% if file.category == "plugin" %}
-                    <a class="item-option" href="{{file.edit_link}}">编辑</a>
-                {% end %}
-
-                {# 词典 #}
-                {% if _is_admin and file.category == "dict" %}
-                    <a class="item-option" href="{{_server_home}}/dict/update?id={{file.id}}">编辑</a>
-                {% end %}
-
-                {% if file.get("show_more_link") %}
-                    <!-- 分类导航 -->
-                    <a href="{{file.url}}">查看全部</a>
-                {% end %}
-            </div>
-
-            <div class="note-name">
-                {% if file.type == "group" %}
-                    <i class="fa fa-folder orange"></i>
-                {% else %}
-                    <i class="fa {{file.icon}}"></i>
-                {% end %}
-
-                {% if file.category == "note" %}
-                    <a class="dialog-link" href="{{file.url}}">{{file.name}}</a>
-                {% else %}
-                    <a href="{{file.url}}">{{file.name}}</a>
-                {% end %}
-            </div>
-            
-            {% if "raw" in file and file.raw != None %}
-                <pre>{{ file.raw }}</pre>
-            {% end %}
-
-            {% if "html" in file and file.html != None %}
-                {% raw file.html %}
-            {% end %}
-
-            {# 知识库 #}
-            {% if file.category == "note" %}
-                <div class="item-ext-info">
-                    {% if file.priority is not None and file.priority > 0 %}
-                        <span class="tag orange-tag">置顶</span>
-                    {% end %}
-
-                    {% if file.creator != None %}
-                        <span class="tag lightgray">{{file.creator}}</span>
-                    {% end %}
-
-                    {% if file.parent_name not in (None, "") %}
-                        <span class="tag lightgray">
-                            <a class="link" href="{{_server_home}}/note/view?id={{file.parent_id}}">{{file.parent_name}}</a>
-                        </span>
-                    {% end %}
-
-                    {% if file.is_public %}
-                        <span class="tag green-tag">公开</span>
-                    {% end %}
-
-                    <div class="float-right">
-                        {% if file.badge_info %}
-                            <span class="search-badge-info">{{file.badge_info}}</span>
-                        {% end %}
-                    </div>
-                </div>
-            {% end %}
-        </div>
-    </div>
-    {% end %}
-</div>
-
-{% include note/component/script/group_select_script.html %}
-{% include search/component/search_pagination.html %}
-
-<script>
-    $(".execute-btn").on("click", function (e) {
-        console.log(e);
-        var href = $(e.target).attr("href");
-        $.get(href, function (responseText) {
-            var obj = responseText;
-            console.log(obj);
-            if (obj.data) {
-                $("#executeResult").text(JSON.stringify(obj.data));
-            }
-        });
-    });
-
-    // 移动笔记
-    $(".move-btn").click(function (e) {
-        var req = {};
-        var noteId = $(e.target).attr("data-id");
-
-        req.callback = function (parentId) {
-            if (parentId === undefined || parentId == "") {
-                xnote.alert("parentId is undefined");
-                return;
-            }
-            xnote.http.post("/note/move", { id: noteId, parent_id: parentId }, function (resp) {
-                console.log(resp);
-                window.location.reload();
-            });
-        };
-        xnote.api["note.move.dialog"](req);
-    });
-</script>
-
-{% end %}
-
-{% block body_right %}
-    {% include search/component/search_sidebar.html %}
+{% extends base.html %}
+<!--
+@author xupingmao
+@since 2017/11/29
+@modified 2022/03/12 11:04:23
+-->
+
+{% block body_left %}
+
+{% init recent = [] %}
+{% init tools  = [] %}
+{% init page_max  = 0 %}
+{% init show_path = False %}
+
+<div id="executeResult">
+</div>
+
+{% if show_path %}
+    <div class="card">
+        <h3 class="card-title">
+            <a href="{{parent.url}}" class="link2">{{parent.name}}</a> / 
+            <a href="{{current.url}}" class="link2">{{current.name}}</a>
+        </h3>
+    </div>
+{% end %}
+
+<div class="col-md-12 result-list">
+
+    <div class="card">
+        <div class="card-title">
+            <span>综合搜索</span>
+            <div class="float-right">
+                <a class="btn btn-default" href="{{_server_home}}/system/settings?category=search">设置</a>
+                <a class="btn btn-default" href="{{_server_home}}/search/history">搜索历史</a>
+                {% include common/button/back_button.html %}
+            </div>
+        </div>
+    </div>
+
+    {% include search/component/search_tab.html %}
+
+    {% if len(tools) > 0 %}
+        <div class="card">
+            <h3 class="card-title">脚本</h3>
+            {% for tool in tools %}
+                <a class="tag-span" href="{{tool.url}}">{{tool.name}}</a>
+            {% end %}
+        </div>
+    {% end %}
+
+    {% for i, file in enumerate(files) %}
+    <div class="card"> 
+        <div class="note-body">
+            {# 右侧操作选项 #}
+            <div class="note-visited-cnt">
+                {# 快捷命令 #}
+                {% if file.get("command") != None %}
+                    <input type="button" class="btn execute-btn float-right" value="执行" href="{{file.command}}"/>
+                {% end %}
+
+                {% if file.show_move == True %}
+                    <a class="item-option move-btn" data-id="{{file.id}}">移动</a>
+                {% end %}
+
+                {# 插件 #}
+                {% if file.category == "plugin" %}
+                    <a class="item-option" href="{{file.edit_link}}">编辑</a>
+                {% end %}
+
+                {# 词典 #}
+                {% if _is_admin and file.category == "dict" %}
+                    <a class="item-option" href="{{_server_home}}/dict/update?id={{file.id}}">编辑</a>
+                {% end %}
+
+                {% if file.get("show_more_link") %}
+                    <!-- 分类导航 -->
+                    <a href="{{file.url}}">查看全部</a>
+                {% end %}
+            </div>
+
+            <div class="note-name">
+                {% if file.type == "group" %}
+                    <i class="fa fa-folder orange"></i>
+                {% else %}
+                    <i class="fa {{file.icon}}"></i>
+                {% end %}
+
+                {% if file.category == "note" %}
+                    <a class="dialog-link" href="{{file.url}}">{{file.name}}</a>
+                {% else %}
+                    <a href="{{file.url}}">{{file.name}}</a>
+                {% end %}
+            </div>
+            
+            {% if "raw" in file and file.raw != None %}
+                <pre>{{ file.raw }}</pre>
+            {% end %}
+
+            {% if "html" in file and file.html != None %}
+                {% raw file.html %}
+            {% end %}
+
+            {# 知识库 #}
+            {% if file.category == "note" %}
+                <div class="item-ext-info">
+                    {% if file.priority is not None and file.priority > 0 %}
+                        <span class="tag orange-tag">置顶</span>
+                    {% end %}
+
+                    {% if file.creator != None %}
+                        <span class="tag lightgray">{{file.creator}}</span>
+                    {% end %}
+
+                    {% if file.parent_name not in (None, "") %}
+                        <span class="tag lightgray">
+                            <a class="link" href="{{_server_home}}/note/view?id={{file.parent_id}}">{{file.parent_name}}</a>
+                        </span>
+                    {% end %}
+
+                    {% if file.is_public %}
+                        <span class="tag green-tag">公开</span>
+                    {% end %}
+
+                    <div class="float-right">
+                        {% if file.badge_info %}
+                            <span class="search-badge-info">{{file.badge_info}}</span>
+                        {% end %}
+                    </div>
+                </div>
+            {% end %}
+        </div>
+    </div>
+    {% end %}
+</div>
+
+{% include note/component/script/group_select_script.html %}
+{% include search/component/search_pagination.html %}
+
+<script>
+    $(".execute-btn").on("click", function (e) {
+        console.log(e);
+        var href = $(e.target).attr("href");
+        $.get(href, function (responseText) {
+            var obj = responseText;
+            console.log(obj);
+            if (obj.data) {
+                $("#executeResult").text(JSON.stringify(obj.data));
+            }
+        });
+    });
+
+    // 移动笔记
+    $(".move-btn").click(function (e) {
+        var req = {};
+        var noteId = $(e.target).attr("data-id");
+
+        req.callback = function (parentId) {
+            if (parentId === undefined || parentId == "") {
+                xnote.alert("parentId is undefined");
+                return;
+            }
+            xnote.http.post("/note/move", { id: noteId, parent_id: parentId }, function (resp) {
+                console.log(resp);
+                window.location.reload();
+            });
+        };
+        xnote.api["note.move.dialog"](req);
+    });
+</script>
+
+{% end %}
+
+{% block body_right %}
+    {% include search/component/search_sidebar.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/search/pydoc.py` & `xnote-web-0.1.1/handlers/search/pydoc.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/reminder.py` & `xnote-web-0.1.1/handlers/search/reminder.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/scripts.py` & `xnote-web-0.1.1/handlers/search/scripts.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/search.html` & `xnote-web-0.1.1/handlers/search/search.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/search.py` & `xnote-web-0.1.1/handlers/search/search.py`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,525 +1,525 @@
-# encoding=utf-8
-# @author xupingmao
-# @since 2017/02/19
-# @modified 2022/04/16 18:03:13
-
-import re
-import time
-import math
-import web
-import xutils
-from xnote.core import xconfig, xauth, xmanager, xtemplate, xnote_hooks
-import handlers.note.dao as note_dao
-import handlers.dict.dict_dao as dict_dao
-from xutils import textutil, u
-from xutils import Storage
-from xutils import dateutil
-from xutils import mem_util
-from xutils import six
-from xnote.core.xtemplate import T
-
-NOTE_DAO = xutils.DAO("note")
-MSG_DAO  = xutils.DAO("message")
-DICT_DAO = xutils.DAO("dict")
-
-config = xconfig
-SEARCH_TYPE_DICT = dict() # type: dict[str, Storage]
-
-
-def register_search_handler(search_type, placeholder = None, action = None, tag = None):
-    global SEARCH_TYPE_DICT
-
-    if action is None:
-        action = "/search"
-
-    SEARCH_TYPE_DICT[search_type] = Storage(
-        placeholder = placeholder,
-        action = action,
-        tag = tag
-    )
-
-def get_search_handler(search_type) -> Storage:
-    handler = SEARCH_TYPE_DICT.get(search_type)
-    if handler != None:
-        return handler
-
-    return SEARCH_TYPE_DICT.get("default")
-
-# 注册到xtemplate的实现
-xnote_hooks.get_search_handler = get_search_handler
-
-class BaseRule:
-
-    def __init__(self, pattern, func, scope="home"):
-        self.pattern = pattern
-        self.func    = func
-        self.scope   = scope
-
-class SearchContext:
-
-    def __init__(self):
-        # 输入的文本
-        self.key              = ''
-        self.input_text       = ''
-        self.words = [] # 根据key分割的token
-        self.category = "" # 搜索类型
-        # 正则匹配的分组
-        self.groups           = []
-        self.user_name        = ''
-        self.search_message   = False
-        self.search_note      = True
-        self.search_note_content = False
-        self.search_dict      = False
-        # 精确搜索字典
-        self.search_dict_strict = True
-        self.search_tool      = True
-        # 是否继续执行，用于最后兜底的搜索，一般是性能消耗比较大的
-        self.stop             = False
-        
-        # 处理的结果集，优先级: 系统功能 > 字典 > 个人数据
-        self.commands = [] # 命令
-        self.tools    = [] # 工具
-        self.dicts    = [] # 词典 -- 公共
-        self.messages = [] # 待办/记事/通知/评论
-        self.notes    = [] # 笔记
-        self.files    = [] # 文件
-
-        # 分页信息
-        self.offset = 1
-        self.limit = 20
-
-    def join_as_files(self):
-        return self.commands + self.tools + self.dicts + self.messages + self.notes + self.files
-
-def fill_note_info(files):
-    ids = []
-    for file in files:
-        if file.category == "note":
-            ids.append(file.parent_id)
-    
-    note_dict = note_dao.batch_query_dict(ids)
-    for file in files:
-        file.parent_name = ""
-        parent = note_dict.get(file.parent_id)
-        if parent is not None:
-            file.parent_name = parent.name
-        file.show_move = True
-        file.badge_info = "热度:%s" % file.hot_index
-
-def log_search_history(user, key, category = "default", cost_time = 0):
-    note_dao.add_search_history(user, key, category, cost_time)
-
-@xutils.timeit(name = "Search.ListRecent", logargs = True, logfile = True)
-def list_search_history(user_name, limit = -1):
-    raw_history_list = note_dao.list_search_history(user_name)
-    history_list = []
-
-    for item in raw_history_list:
-        if item.key is None:
-            continue
-        if item.key not in history_list:
-            history_list.append(item.key)
-    return history_list
-
-def build_search_context(user_name, category, key):
-    words                   = textutil.split_words(key)
-    ctx                     = SearchContext()
-    ctx.key                 = key
-    ctx.input_text          = key
-    ctx.words               = words
-    ctx.category            = category
-    ctx.search_tool         = True
-    ctx.search_message      = True
-    ctx.search_note         = True
-    ctx.search_note_content = False
-    ctx.search_dict         = False
-    ctx.user_name           = user_name
-
-    if category == "message":
-        ctx.search_message = True
-        ctx.search_note = False
-        ctx.search_note_content = False
-        ctx.search_tool = False
-        ctx.search_dict_strict = False
-
-    if ctx.category == "book":
-        ctx.search_note = False
-        ctx.search_tool = False
-        ctx.search_dict_strict = False
-
-    if category == "dict":
-        ctx.search_dict = True
-        ctx.search_dict_strict = False
-        ctx.search_note = False
-        ctx.search_tool = False
-
-    if category == "content":
-        ctx.search_note_content = True
-        ctx.search_tool         = False
-        ctx.search_message      = False
-        ctx.search_dict_strict = False
-
-    if category == "tool":
-        ctx.search_tool = True
-        ctx.search_dict_strict = False
-
-    return ctx
-
-class SearchHandler:
-
-    def do_search(self, page_ctx, key, offset, limit):
-        category    = xutils.get_argument("category", "")
-        search_type = xutils.get_argument("search_type", "")
-        words      = textutil.split_words(key)
-        user_name  = xauth.get_current_name()
-        ctx        = build_search_context(user_name, category, key)
-
-        logger = mem_util.MemLogger("do_search")
-
-        # 优先使用 search_type
-        if search_type != None and search_type != "" and search_type != "default":
-            ctx.offset = page_ctx.offset
-            ctx.limit  = page_ctx.limit
-            return self.do_search_by_type(ctx, key, search_type)
-        
-        # 阻断性的搜索，比如特定语法的
-        xmanager.fire("search.before", ctx)
-        if ctx.stop:
-            files = ctx.join_as_files()
-            return files, len(files)
-
-        logger.info("after fire search.before")
-
-        # 普通的搜索行为
-        xmanager.fire("search", ctx)
-
-        logger.info("after fire search")
-
-        ctx.files = RuleManager.apply(ctx, key)
-
-        logger.info("after apply_search_rules")
-
-        if ctx.stop:
-            files = ctx.join_as_files()
-            return files, len(files)
-
-        # 慢搜索,如果时间过长,这个服务会被降级
-        # TODO: 异步操作需要其他线程辅助执行
-        xmanager.fire("search.slow", ctx)
-
-        logger.info("after fire search.slow")
-
-        xmanager.fire("search.after", ctx)
-
-        logger.info("after fire search.after")
-
-        page_ctx.tools = []
-        
-        search_result = ctx.join_as_files()
-        
-        fill_note_info(search_result)
-
-        return search_result[offset:offset+limit], len(search_result)
-
-    @mem_util.log_mem_info_deco("do_search_with_profile", log_args = True)
-    def do_search_with_profile(self, page_ctx, key, offset, limit):
-        user_name = xauth.current_name()
-        category  = xutils.get_argument_str("category", "")
-        search_type = xutils.get_argument_str("search_type", "")
-
-        start_time = time.time()
-
-        result = self.do_search(page_ctx, key, offset, limit)
-
-        cost_time = int((time.time() - start_time) * 1000)
-
-        if category == "":
-            category = search_type
-
-        log_search_history(user_name, key, category, cost_time)
-
-        return result
-
-    def do_search_dict(self, ctx, key):
-        offset = ctx.offset
-        limit  = ctx.limit
-        notes, count = dict_dao.search_dict(key, offset, limit)
-        for note in notes:
-            note.raw = note.value
-            note.icon = "hide"
-        return notes, count
-
-    def do_search_note(self, ctx, key):
-        user_name = xauth.current_name_str()
-        parent_id = xutils.get_argument_int("parent_id")
-        words = textutil.split_words(key)
-        notes = note_dao.search_name(words, user_name, parent_id = parent_id)
-        for note in notes:
-            note.category = "note"
-            note.mdate = dateutil.format_date(note.mtime)
-        fill_note_info(notes)
-
-        if parent_id != "" and parent_id != None:
-            ctx.parent_note = note_dao.get_by_id(parent_id)
-
-        offset = ctx.offset
-        limit  = ctx.limit
-        return notes[offset:offset+limit], len(notes)
-
-    def do_search_task(self, ctx, key):
-        user_name = xauth.get_current_name()
-        offset = ctx.offset
-        limit  = ctx.limit
-
-        search_tags = set(["task"])
-        item_list, amount = MSG_DAO.search(user_name, key, offset, limit, search_tags = search_tags)
-
-        for item in item_list:
-            MSG_DAO.process_message(item)
-            prefix = u("待办 - ")
-
-            if item.tag == "done":
-                prefix = u("完成 - ")
-
-            item.name = prefix + item.ctime
-            item.icon = "hide"
-            item.url  = "#"
-        
-        # 统计已完成待办数量
-        temp, done_count = MSG_DAO.search(user_name, key, search_tags = set(["done"]), count_only=True)
-        if done_count > 0:
-            done_summary = Storage()
-            done_summary.icon = "hide"
-            done_summary.name = "已完成任务[%d]" % done_count
-            done_summary.url =  "/message?tag=search&p=done&key=%s" % xutils.quote(key)
-            item_list.insert(0, done_summary)
-
-        return item_list, amount
-
-    def do_search_comment(self, ctx, key):
-        NOTE_DAO.search_comment_detail(ctx)
-        return ctx.messages, len(ctx.messages)
-
-    def do_search_by_type(self, ctx, key, search_type):
-        if search_type == "note":
-            return self.do_search_note(ctx, key)
-        elif search_type == "dict":
-            return self.do_search_dict(ctx, key)
-        elif search_type == "task":
-            return self.do_search_task(ctx, key)
-        elif search_type == "comment":
-            return self.do_search_comment(ctx, key)
-        else:
-            raise Exception("不支持的搜索类型:%s" % search_type)
-
-    def GET(self, path_key = None):
-        """search files by name and content"""
-        RuleManager.load_rules()
-        key         = xutils.get_argument_str("key", "")
-        title       = xutils.get_argument("title", "")
-        category    = xutils.get_argument("category", "default")
-        page        = xutils.get_argument_int("page", 1)
-        search_type = xutils.get_argument("search_type", "")
-        user_name   = xauth.get_current_name()
-        page_url    =  "/search/search?key={key}&category={category}&search_type={search_type}&page=".format(**locals())
-        pagesize    = xconfig.SEARCH_PAGE_SIZE
-        offset      = (page-1) * pagesize
-        limit       = pagesize
-        ctx         = Storage()
-        ctx.offset  = offset
-        ctx.limit   = limit
-
-        if path_key:
-            key = xutils.unquote(path_key)
-
-        if key == "" or key == None:
-            raise web.found("/search/history")
-
-        key = key.strip()
-
-        files, count = self.do_search_with_profile(ctx, key, offset, pagesize)
-
-        return xtemplate.render("search/page/search_result.html", 
-            show_aside = False,
-            key = key,
-            html_title = "Search",
-            category = category,
-            files    = files, 
-            title    = title,
-            page_max = int(math.ceil(count/pagesize)),
-            page_url = page_url,
-            **ctx)
-
-
-class SearchHistoryHandler:
-
-    def fetch_recent_logs(self, raw_history_list):
-        history_list = []
-        for item in raw_history_list:
-            if item.key is None:
-                continue
-            if item.key not in history_list:
-                history_list.append(item.key)
-        return history_list
-    
-    def fetch_hot_logs(self, raw_history_list, top_count = 10):
-        count_dict = dict()
-
-        for item in raw_history_list:
-            count = count_dict.get(item.key, 0)
-            count+=1
-            count_dict[item.key] = count
-        
-        sorted_items = sorted(count_dict.items(), key = lambda x:x[1], reverse=True)
-        return sorted_items[0:top_count]
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(user_name, "/search/history")
-        note_dao.expire_search_history(user_name)
-
-        raw_history_list = note_dao.list_search_history(user_name)
-
-        kw = Storage()
-        kw.show_aside = False
-        kw.files = []
-        kw.html_title = "Search"
-        kw.recent = self.fetch_recent_logs(raw_history_list)
-        kw.hot_logs = self.fetch_hot_logs(raw_history_list)
-        kw.search_type = "default"
-
-        return xtemplate.render("search/page/search_history.html", **kw)
-
-    @xauth.login_required()
-    def POST(self):
-        p = xutils.get_argument("p", "")
-        user_name = xauth.current_name()
-        if p == "clear":
-            note_dao.clear_search_history(user_name)
-            return dict(code = "success")
-
-        return dict(code = "500", message = "无效的操作")
-
-class RuleManager:
-    """搜索规则管理器"""
-
-    is_loaded = False
-    _RULES = []
-
-    @classmethod
-    def add_rule(cls, pattern, func_str):
-        try:
-            mod, func_name = func_str.rsplit('.', 1)
-            # mod = __import__(mod, None, None, [''])
-            mod = six._import_module("handlers.search." + mod)
-            func = getattr(mod, func_name)
-            func.modfunc = func_str
-            rule = BaseRule(r"^%s\Z" % u(pattern), func)
-            rule.func_str = func_str
-            cls._RULES.append(rule)
-        except Exception as e:
-            xutils.print_exc()
-
-    @classmethod
-    def load_rules(cls):
-        if cls.is_loaded:
-            return
-
-        cls.add_rule(r"([^ ]*)",  "api.search")
-        cls.add_rule(r"静音(.*)", "mute.search")
-        cls.add_rule(r"mute(.*)", "mute.search")
-        cls.add_rule(r"取消静音",  "mute.cancel")
-        cls.add_rule(r"(.*)", "note.search")
-        cls.is_loaded = True
-
-    @classmethod
-    def apply(cls, ctx, key):
-        files = []
-        for rule in cls._RULES:
-            pattern = rule.pattern
-            func = rule.func
-            # re.match内部已经实现了缓存
-            m = re.match(pattern, key)
-            if m:
-                try:
-                    logger = mem_util.MemLogger("rule:%r:%r" % (pattern, rule.func_str))
-
-                    start_time0 = time.time()
-                    results     = func(ctx, *m.groups())
-                    cost_time0  = time.time() - start_time0
-                    xutils.trace("SearchHandler", func.modfunc, int(cost_time0*1000))
-                    if results is not None:
-                        files += results
-                    logger.done()
-                except Exception as e:
-                    xutils.print_exc()
-        return files
-
-
-class RulesHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name()
-        rules = list_search_rules(user_name)
-        return xtemplate.render("search/search_rules.html", rules = rules, show_search = False)
-
-def list_search_rules(user_name):
-    list, count = MSG_DAO.list_by_tag(user_name, 'key', 0, 1000)
-
-    for item in list:
-        item.url = "/note/timeline?type=search&key=" + xutils.encode_uri_component(item.content)
-    return list
-
-
-@xmanager.listen("sys.reload")
-def reload_search(ctx = None):
-    do_reload_search(ctx)
-
-@xutils.log_init_deco("reload_search")
-def do_reload_search(ctx = None):
-    register_search_handler("plugin", placeholder = u"搜索插件", action = "/plugins_list")
-    register_search_handler("note.public", placeholder = u"搜索公共笔记", action = "/note/timeline", tag = "public")
-    register_search_handler("dict", placeholder = u"搜索词典", action = "/search")
-    register_search_handler("message", placeholder = u"搜索随手记", action = "/message")
-    register_search_handler("task", placeholder = u"搜索待办", action = "/message")
-    register_search_handler("note", placeholder = u"搜索笔记", action = "/search")
-    register_search_handler("comment", placeholder = u"搜索评论")
-    register_search_handler("default", placeholder = u"综合搜索", action = "/search")
-    register_search_handler("relevant_word", placeholder=u"搜索单词", action = "/dict/relevant/list")
-    register_search_handler("checklist", placeholder=u"搜索清单列表", action="/note/checklist/search")
-    register_search_handler("group_manage", placeholder=u"搜索笔记本", action="/note/group/manage")
-
-class SearchDialogAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        key = xutils.get_argument("key", "")
-        offset = xutils.get_argument("offset", 0, type = int)
-        limit = xutils.get_argument("limit", 100, type = int)
-        xutils.get_argument("callback", "")
-
-        if key != "":
-            searcher = SearchHandler()
-            ctx = Storage()
-            ctx.offset = offset
-            ctx.limit = limit
-            result, length = searcher.do_search(ctx, key, offset, limit)
-            return xtemplate.render("search/ajax/search_dialog_detail.html", 
-                result = result)
-        return xtemplate.render("search/ajax/search_dialog.html")
-
-xutils.register_func("search.list_rules", list_search_rules)
-xutils.register_func("search.list_recent", list_search_history)
-xutils.register_func("search.get_search_handler", get_search_handler)
-
-xurls = (
-    r"/search/search", SearchHandler, 
-    r"/search"       , SearchHandler,
-    r"/s/(.+)"       , SearchHandler,
-    r"/search/history", SearchHistoryHandler,
-    r"/search/rules", RulesHandler,
-    r"/search/dialog", SearchDialogAjaxHandler,
-)
-
+# encoding=utf-8
+# @author xupingmao
+# @since 2017/02/19
+# @modified 2022/04/16 18:03:13
+
+import re
+import time
+import math
+import web
+import xutils
+from xnote.core import xconfig, xauth, xmanager, xtemplate, xnote_hooks
+import handlers.note.dao as note_dao
+import handlers.dict.dict_dao as dict_dao
+from xutils import textutil, u
+from xutils import Storage
+from xutils import dateutil
+from xutils import mem_util
+from xutils import six
+from xnote.core.xtemplate import T
+
+NOTE_DAO = xutils.DAO("note")
+MSG_DAO  = xutils.DAO("message")
+DICT_DAO = xutils.DAO("dict")
+
+config = xconfig
+SEARCH_TYPE_DICT = dict() # type: dict[str, Storage]
+
+
+def register_search_handler(search_type, placeholder = None, action = None, tag = None):
+    global SEARCH_TYPE_DICT
+
+    if action is None:
+        action = "/search"
+
+    SEARCH_TYPE_DICT[search_type] = Storage(
+        placeholder = placeholder,
+        action = action,
+        tag = tag
+    )
+
+def get_search_handler(search_type) -> Storage:
+    handler = SEARCH_TYPE_DICT.get(search_type)
+    if handler != None:
+        return handler
+
+    return SEARCH_TYPE_DICT.get("default")
+
+# 注册到xtemplate的实现
+xnote_hooks.get_search_handler = get_search_handler
+
+class BaseRule:
+
+    def __init__(self, pattern, func, scope="home"):
+        self.pattern = pattern
+        self.func    = func
+        self.scope   = scope
+
+class SearchContext:
+
+    def __init__(self):
+        # 输入的文本
+        self.key              = ''
+        self.input_text       = ''
+        self.words = [] # 根据key分割的token
+        self.category = "" # 搜索类型
+        # 正则匹配的分组
+        self.groups           = []
+        self.user_name        = ''
+        self.search_message   = False
+        self.search_note      = True
+        self.search_note_content = False
+        self.search_dict      = False
+        # 精确搜索字典
+        self.search_dict_strict = True
+        self.search_tool      = True
+        # 是否继续执行，用于最后兜底的搜索，一般是性能消耗比较大的
+        self.stop             = False
+        
+        # 处理的结果集，优先级: 系统功能 > 字典 > 个人数据
+        self.commands = [] # 命令
+        self.tools    = [] # 工具
+        self.dicts    = [] # 词典 -- 公共
+        self.messages = [] # 待办/记事/通知/评论
+        self.notes    = [] # 笔记
+        self.files    = [] # 文件
+
+        # 分页信息
+        self.offset = 1
+        self.limit = 20
+
+    def join_as_files(self):
+        return self.commands + self.tools + self.dicts + self.messages + self.notes + self.files
+
+def fill_note_info(files):
+    ids = []
+    for file in files:
+        if file.category == "note":
+            ids.append(file.parent_id)
+    
+    note_dict = note_dao.batch_query_dict(ids)
+    for file in files:
+        file.parent_name = ""
+        parent = note_dict.get(file.parent_id)
+        if parent is not None:
+            file.parent_name = parent.name
+        file.show_move = True
+        file.badge_info = "热度:%s" % file.hot_index
+
+def log_search_history(user, key, category = "default", cost_time = 0):
+    note_dao.add_search_history(user, key, category, cost_time)
+
+@xutils.timeit(name = "Search.ListRecent", logargs = True, logfile = True)
+def list_search_history(user_name, limit = -1):
+    raw_history_list = note_dao.list_search_history(user_name)
+    history_list = []
+
+    for item in raw_history_list:
+        if item.key is None:
+            continue
+        if item.key not in history_list:
+            history_list.append(item.key)
+    return history_list
+
+def build_search_context(user_name, category, key):
+    words                   = textutil.split_words(key)
+    ctx                     = SearchContext()
+    ctx.key                 = key
+    ctx.input_text          = key
+    ctx.words               = words
+    ctx.category            = category
+    ctx.search_tool         = True
+    ctx.search_message      = True
+    ctx.search_note         = True
+    ctx.search_note_content = False
+    ctx.search_dict         = False
+    ctx.user_name           = user_name
+
+    if category == "message":
+        ctx.search_message = True
+        ctx.search_note = False
+        ctx.search_note_content = False
+        ctx.search_tool = False
+        ctx.search_dict_strict = False
+
+    if ctx.category == "book":
+        ctx.search_note = False
+        ctx.search_tool = False
+        ctx.search_dict_strict = False
+
+    if category == "dict":
+        ctx.search_dict = True
+        ctx.search_dict_strict = False
+        ctx.search_note = False
+        ctx.search_tool = False
+
+    if category == "content":
+        ctx.search_note_content = True
+        ctx.search_tool         = False
+        ctx.search_message      = False
+        ctx.search_dict_strict = False
+
+    if category == "tool":
+        ctx.search_tool = True
+        ctx.search_dict_strict = False
+
+    return ctx
+
+class SearchHandler:
+
+    def do_search(self, page_ctx, key, offset, limit):
+        category    = xutils.get_argument("category", "")
+        search_type = xutils.get_argument("search_type", "")
+        words      = textutil.split_words(key)
+        user_name  = xauth.get_current_name()
+        ctx        = build_search_context(user_name, category, key)
+
+        logger = mem_util.MemLogger("do_search")
+
+        # 优先使用 search_type
+        if search_type != None and search_type != "" and search_type != "default":
+            ctx.offset = page_ctx.offset
+            ctx.limit  = page_ctx.limit
+            return self.do_search_by_type(ctx, key, search_type)
+        
+        # 阻断性的搜索，比如特定语法的
+        xmanager.fire("search.before", ctx)
+        if ctx.stop:
+            files = ctx.join_as_files()
+            return files, len(files)
+
+        logger.info("after fire search.before")
+
+        # 普通的搜索行为
+        xmanager.fire("search", ctx)
+
+        logger.info("after fire search")
+
+        ctx.files = RuleManager.apply(ctx, key)
+
+        logger.info("after apply_search_rules")
+
+        if ctx.stop:
+            files = ctx.join_as_files()
+            return files, len(files)
+
+        # 慢搜索,如果时间过长,这个服务会被降级
+        # TODO: 异步操作需要其他线程辅助执行
+        xmanager.fire("search.slow", ctx)
+
+        logger.info("after fire search.slow")
+
+        xmanager.fire("search.after", ctx)
+
+        logger.info("after fire search.after")
+
+        page_ctx.tools = []
+        
+        search_result = ctx.join_as_files()
+        
+        fill_note_info(search_result)
+
+        return search_result[offset:offset+limit], len(search_result)
+
+    @mem_util.log_mem_info_deco("do_search_with_profile", log_args = True)
+    def do_search_with_profile(self, page_ctx, key, offset, limit):
+        user_name = xauth.current_name()
+        category  = xutils.get_argument_str("category", "")
+        search_type = xutils.get_argument_str("search_type", "")
+
+        start_time = time.time()
+
+        result = self.do_search(page_ctx, key, offset, limit)
+
+        cost_time = int((time.time() - start_time) * 1000)
+
+        if category == "":
+            category = search_type
+
+        log_search_history(user_name, key, category, cost_time)
+
+        return result
+
+    def do_search_dict(self, ctx, key):
+        offset = ctx.offset
+        limit  = ctx.limit
+        notes, count = dict_dao.search_dict(key, offset, limit)
+        for note in notes:
+            note.raw = note.value
+            note.icon = "hide"
+        return notes, count
+
+    def do_search_note(self, ctx, key):
+        user_name = xauth.current_name_str()
+        parent_id = xutils.get_argument_int("parent_id")
+        words = textutil.split_words(key)
+        notes = note_dao.search_name(words, user_name, parent_id = parent_id)
+        for note in notes:
+            note.category = "note"
+            note.mdate = dateutil.format_date(note.mtime)
+        fill_note_info(notes)
+
+        if parent_id != "" and parent_id != None:
+            ctx.parent_note = note_dao.get_by_id(parent_id)
+
+        offset = ctx.offset
+        limit  = ctx.limit
+        return notes[offset:offset+limit], len(notes)
+
+    def do_search_task(self, ctx, key):
+        user_name = xauth.get_current_name()
+        offset = ctx.offset
+        limit  = ctx.limit
+
+        search_tags = set(["task"])
+        item_list, amount = MSG_DAO.search(user_name, key, offset, limit, search_tags = search_tags)
+
+        for item in item_list:
+            MSG_DAO.process_message(item)
+            prefix = u("待办 - ")
+
+            if item.tag == "done":
+                prefix = u("完成 - ")
+
+            item.name = prefix + item.ctime
+            item.icon = "hide"
+            item.url  = "#"
+        
+        # 统计已完成待办数量
+        temp, done_count = MSG_DAO.search(user_name, key, search_tags = set(["done"]), count_only=True)
+        if done_count > 0:
+            done_summary = Storage()
+            done_summary.icon = "hide"
+            done_summary.name = "已完成任务[%d]" % done_count
+            done_summary.url =  "/message?tag=search&p=done&key=%s" % xutils.quote(key)
+            item_list.insert(0, done_summary)
+
+        return item_list, amount
+
+    def do_search_comment(self, ctx, key):
+        NOTE_DAO.search_comment_detail(ctx)
+        return ctx.messages, len(ctx.messages)
+
+    def do_search_by_type(self, ctx, key, search_type):
+        if search_type == "note":
+            return self.do_search_note(ctx, key)
+        elif search_type == "dict":
+            return self.do_search_dict(ctx, key)
+        elif search_type == "task":
+            return self.do_search_task(ctx, key)
+        elif search_type == "comment":
+            return self.do_search_comment(ctx, key)
+        else:
+            raise Exception("不支持的搜索类型:%s" % search_type)
+
+    def GET(self, path_key = None):
+        """search files by name and content"""
+        RuleManager.load_rules()
+        key         = xutils.get_argument_str("key", "")
+        title       = xutils.get_argument("title", "")
+        category    = xutils.get_argument("category", "default")
+        page        = xutils.get_argument_int("page", 1)
+        search_type = xutils.get_argument("search_type", "")
+        user_name   = xauth.get_current_name()
+        page_url    =  "/search/search?key={key}&category={category}&search_type={search_type}&page=".format(**locals())
+        pagesize    = xconfig.SEARCH_PAGE_SIZE
+        offset      = (page-1) * pagesize
+        limit       = pagesize
+        ctx         = Storage()
+        ctx.offset  = offset
+        ctx.limit   = limit
+
+        if path_key:
+            key = xutils.unquote(path_key)
+
+        if key == "" or key == None:
+            raise web.found("/search/history")
+
+        key = key.strip()
+
+        files, count = self.do_search_with_profile(ctx, key, offset, pagesize)
+
+        return xtemplate.render("search/page/search_result.html", 
+            show_aside = False,
+            key = key,
+            html_title = "Search",
+            category = category,
+            files    = files, 
+            title    = title,
+            page_max = int(math.ceil(count/pagesize)),
+            page_url = page_url,
+            **ctx)
+
+
+class SearchHistoryHandler:
+
+    def fetch_recent_logs(self, raw_history_list):
+        history_list = []
+        for item in raw_history_list:
+            if item.key is None:
+                continue
+            if item.key not in history_list:
+                history_list.append(item.key)
+        return history_list
+    
+    def fetch_hot_logs(self, raw_history_list, top_count = 10):
+        count_dict = dict()
+
+        for item in raw_history_list:
+            count = count_dict.get(item.key, 0)
+            count+=1
+            count_dict[item.key] = count
+        
+        sorted_items = sorted(count_dict.items(), key = lambda x:x[1], reverse=True)
+        return sorted_items[0:top_count]
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(user_name, "/search/history")
+        note_dao.expire_search_history(user_name)
+
+        raw_history_list = note_dao.list_search_history(user_name)
+
+        kw = Storage()
+        kw.show_aside = False
+        kw.files = []
+        kw.html_title = "Search"
+        kw.recent = self.fetch_recent_logs(raw_history_list)
+        kw.hot_logs = self.fetch_hot_logs(raw_history_list)
+        kw.search_type = "default"
+
+        return xtemplate.render("search/page/search_history.html", **kw)
+
+    @xauth.login_required()
+    def POST(self):
+        p = xutils.get_argument("p", "")
+        user_name = xauth.current_name()
+        if p == "clear":
+            note_dao.clear_search_history(user_name)
+            return dict(code = "success")
+
+        return dict(code = "500", message = "无效的操作")
+
+class RuleManager:
+    """搜索规则管理器"""
+
+    is_loaded = False
+    _RULES = []
+
+    @classmethod
+    def add_rule(cls, pattern, func_str):
+        try:
+            mod, func_name = func_str.rsplit('.', 1)
+            # mod = __import__(mod, None, None, [''])
+            mod = six._import_module("handlers.search." + mod)
+            func = getattr(mod, func_name)
+            func.modfunc = func_str
+            rule = BaseRule(r"^%s\Z" % u(pattern), func)
+            rule.func_str = func_str
+            cls._RULES.append(rule)
+        except Exception as e:
+            xutils.print_exc()
+
+    @classmethod
+    def load_rules(cls):
+        if cls.is_loaded:
+            return
+
+        cls.add_rule(r"([^ ]*)",  "api.search")
+        cls.add_rule(r"静音(.*)", "mute.search")
+        cls.add_rule(r"mute(.*)", "mute.search")
+        cls.add_rule(r"取消静音",  "mute.cancel")
+        cls.add_rule(r"(.*)", "note.search")
+        cls.is_loaded = True
+
+    @classmethod
+    def apply(cls, ctx, key):
+        files = []
+        for rule in cls._RULES:
+            pattern = rule.pattern
+            func = rule.func
+            # re.match内部已经实现了缓存
+            m = re.match(pattern, key)
+            if m:
+                try:
+                    logger = mem_util.MemLogger("rule:%r:%r" % (pattern, rule.func_str))
+
+                    start_time0 = time.time()
+                    results     = func(ctx, *m.groups())
+                    cost_time0  = time.time() - start_time0
+                    xutils.trace("SearchHandler", func.modfunc, int(cost_time0*1000))
+                    if results is not None:
+                        files += results
+                    logger.done()
+                except Exception as e:
+                    xutils.print_exc()
+        return files
+
+
+class RulesHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name()
+        rules = list_search_rules(user_name)
+        return xtemplate.render("search/search_rules.html", rules = rules, show_search = False)
+
+def list_search_rules(user_name):
+    list, count = MSG_DAO.list_by_tag(user_name, 'key', 0, 1000)
+
+    for item in list:
+        item.url = "/note/timeline?type=search&key=" + xutils.encode_uri_component(item.content)
+    return list
+
+
+@xmanager.listen("sys.reload")
+def reload_search(ctx = None):
+    do_reload_search(ctx)
+
+@xutils.log_init_deco("reload_search")
+def do_reload_search(ctx = None):
+    register_search_handler("plugin", placeholder = u"搜索插件", action = "/plugins_list")
+    register_search_handler("note.public", placeholder = u"搜索公共笔记", action = "/note/timeline", tag = "public")
+    register_search_handler("dict", placeholder = u"搜索词典", action = "/search")
+    register_search_handler("message", placeholder = u"搜索随手记", action = "/message")
+    register_search_handler("task", placeholder = u"搜索待办", action = "/message")
+    register_search_handler("note", placeholder = u"搜索笔记", action = "/search")
+    register_search_handler("comment", placeholder = u"搜索评论")
+    register_search_handler("default", placeholder = u"综合搜索", action = "/search")
+    register_search_handler("relevant_word", placeholder=u"搜索单词", action = "/dict/relevant/list")
+    register_search_handler("checklist", placeholder=u"搜索清单列表", action="/note/checklist/search")
+    register_search_handler("group_manage", placeholder=u"搜索笔记本", action="/note/group/manage")
+
+class SearchDialogAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        key = xutils.get_argument("key", "")
+        offset = xutils.get_argument("offset", 0, type = int)
+        limit = xutils.get_argument("limit", 100, type = int)
+        xutils.get_argument("callback", "")
+
+        if key != "":
+            searcher = SearchHandler()
+            ctx = Storage()
+            ctx.offset = offset
+            ctx.limit = limit
+            result, length = searcher.do_search(ctx, key, offset, limit)
+            return xtemplate.render("search/ajax/search_dialog_detail.html", 
+                result = result)
+        return xtemplate.render("search/ajax/search_dialog.html")
+
+xutils.register_func("search.list_rules", list_search_rules)
+xutils.register_func("search.list_recent", list_search_history)
+xutils.register_func("search.get_search_handler", get_search_handler)
+
+xurls = (
+    r"/search/search", SearchHandler, 
+    r"/search"       , SearchHandler,
+    r"/s/(.+)"       , SearchHandler,
+    r"/search/history", SearchHistoryHandler,
+    r"/search/rules", RulesHandler,
+    r"/search/dialog", SearchDialogAjaxHandler,
+)
+
```

### Comparing `xnote-web-0.1.0/handlers/search/search_rules.html` & `xnote-web-0.1.1/handlers/search/search_rules.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/search/tools.py` & `xnote-web-0.1.1/handlers/search/tools.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/component/admin_settings.html` & `xnote-web-0.1.1/handlers/settings/component/admin_settings.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/component/note_settings.html` & `xnote-web-0.1.1/handlers/settings/component/note_settings.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/component/search_settings.html` & `xnote-web-0.1.1/handlers/settings/component/search_settings.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/component/settings_sidebar.html` & `xnote-web-0.1.1/handlers/settings/component/settings_sidebar.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/page/properties.html` & `xnote-web-0.1.1/handlers/settings/page/properties.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/page/settings.html` & `xnote-web-0.1.1/handlers/settings/page/settings.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/settings/settings.py` & `xnote-web-0.1.1/handlers/settings/settings.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,252 +1,252 @@
-# -*- coding: utf-8 -*-
-# @author xupingmao
-# @since 2017/02/19
-# @modified 2021/12/12 19:46:19
-import web
-import time
-import os
-import sys
-import platform
-import xutils
-import logging
-import json
-import threading
-import re
-import xtemplate
-import xconfig
-import xauth
-import xtables
-import xmanager
-from xutils import sqlite3, Storage, cacheutil
-from xtemplate import T
-from xutils import logutil
-
-try:
-    import psutil
-except ImportError as e:
-    psutil = None
-
-INIT_SCRIPT_URL = "/code/edit?type=script&path=" + str(xconfig.INIT_SCRIPT)
-USER_CONFIG_KEY_SET = xauth.get_user_config_valid_keys()
-
-@logutil.timeit_deco(logargs=True,logret=True)
-def get_xnote_version():
-    return xconfig.get_global_config("system.version")
-
-class Item:
-    def __init__(self, key, value):
-        self.key   = key
-        self.value = value
-
-class SettingsHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        sys_mem_total     = 0
-        thread_cnt        = 0
-
-        thread_cnt = len(threading.enumerate())
-        item_list  = [
-            Item('软件版本',    get_xnote_version()),
-            Item('sqlite版本', sqlite3.sqlite_version if sqlite3 != None else '')
-        ]
-
-        user_name = xauth.current_name()
-        category = xutils.get_argument("category", "")
-
-        def get_user_config(key):
-            return xauth.get_user_config(user_name, key)
-
-        kw = Storage()
-        kw.show_aside = False
-        kw.html_title = T("设置")
-        kw.item_list = item_list
-        kw.sys_mem_total  = xutils.format_size(sys_mem_total)
-        kw.thread_cnt     = thread_cnt
-        kw.xconfig        = xconfig
-        kw.category       = category
-        kw.xnote_version  = get_xnote_version()
-        kw.start_time     = xconfig.START_TIME
-        kw.init_script_url = INIT_SCRIPT_URL
-        kw.show_admin_btn = False
-        kw.show_back_btn = True
-        kw.get_user_config = get_user_config
-
-        if category == "":
-            kw.show_back_btn = False
-
-        if xauth.is_admin() and category == "":
-            kw.show_admin_btn = True
-
-        if category == "search":
-            kw.html_title = T("搜索设置")
-
-        if category == "admin":
-            kw.html_title = T("管理员设置")
-
-        return xtemplate.render("settings/page/settings.html", **kw)
-
-DEFAULT_SETTINGS = '''
-
-# 导航配置
-[NAV_LIST]
-About = /code/wiki/README.md
-
-
-# 索引目录
-[INDEX_DIRS]
-
-
-'''
-
-class PropertiesHandler:
-    """基于缓存的配置"""
-
-    @xauth.login_required("admin")
-    def GET(self):
-        key  = xutils.get_argument("key")
-        user = xauth.get_current_name()
-        default_value = ""
-
-        if key == "settings":
-            default_value = DEFAULT_SETTINGS
-
-        config = Storage(key = key, value = xutils.cache_get("%s@prop_%s" % (user, key), 
-            default_value))
-
-        if config is None:
-            config = Storage(key=key, value="")
-        return xtemplate.render("settings/page/properties.html", 
-            show_aside = False,
-            config = config)
-    
-    @xauth.login_required("admin")
-    def POST(self):
-        key = xutils.get_argument("key")
-        value = xutils.get_argument("value")
-        user = xauth.get_current_name()
-        
-        xutils.cache_put("%s@prop_%s" % (user, key), value)
-
-        if key == "settings":
-            self.update_settings(value)
-        
-        config = Storage(key = key, value = value)
-        return xtemplate.render("settings/page/properties.html", 
-            show_aside = False,
-            config = config)
-
-    def update_settings(self, config_text):
-        from xutils import ConfigParser
-
-        nav_list = []
-
-        cf = ConfigParser()
-        cf.read_string(config_text)
-        names = cf.sections()
-
-        options = cf.options('NAV_LIST')
-        for option in options:
-            value = cf.get('NAV_LIST', option)
-            nav_list.append(Storage(name = option, url = value))
-
-        # 处理导航        
-        xconfig.NAV_LIST = nav_list
-
-
-@xauth.login_required()
-def update_user_config(key, value):
-    if key not in USER_CONFIG_KEY_SET:
-        raise Exception("无效的配置项:%s" % key)
-
-    user_name = xauth.current_name()
-    config_dict = Storage()
-    config_dict[key] = value
-    xauth.update_user_config_dict(user_name, config_dict)
-
-@xauth.login_required("admin")
-def update_sys_config(key, value):
-    setattr(xconfig, key, value)
-
-class ConfigHandler:
-    
-    @xauth.login_required("admin")
-    def POST(self):
-        key   = xutils.get_argument("key")
-        value = xutils.get_argument_str("value", "")
-        type  = xutils.get_argument("type")
-        p     = xutils.get_argument("p")
-
-        update_msg = "%s,%s,%s" % (type, key, value)
-        logging.info(update_msg)
-        xutils.info("UpdateConfig", update_msg)
-
-        if type == "int":
-            value = int(value)
-
-        if type == "bool":
-            value = value.lower() in ("true", "yes", "on")
-
-        if key == "BASE_TEMPLATE":
-            xmanager.reload()
-
-        if key in ("DEV_MODE", "DEBUG"):
-            xconfig.DEBUG = value
-            xconfig.DEV_MODE = value
-            web.config.debug = value
-
-        if key in ("RECENT_SEARCH_LIMIT", "RECENT_SIZE", "PAGE_SIZE", "TRASH_EXPIRE"):
-            value = int(value)
-
-        try:
-            if p == "user" or key in USER_CONFIG_KEY_SET:
-                update_user_config(key, value)
-            else:
-                update_sys_config(key, value)
-        except Exception as e:
-            return dict(code = "fail", message = "设置失败:" + str(e))
-            
-        return dict(code="success")
-
-class HomeEntrySettingsHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        pass
-
-@xmanager.listen("sys.reload")
-def on_reload(ctx = None):
-    keys = (
-        "THEME", 'FS_HIDE_FILES', 'OPTION_STYLE', 
-        'PAGE_OPEN', 'RECENT_SEARCH_LIMIT', 
-        "PAGE_SIZE", "RECENT_SIZE",
-        "TRASH_EXPIRE",
-        "PAGE_WIDTH", "FS_VIEW_MODE",
-        "HIDE_DICT_ENTRY"
-    )
-    for key in keys:
-        value = cacheutil.hget('sys.config', key)
-        xutils.trace("HGET", "key=%s, value=%s" % (key, value))
-        if value is not None:
-            setattr(xconfig, key, value)
-
-    # TODO 优化扩展样式和脚本
-    css_path = os.path.join(xconfig.SCRIPTS_DIR, "user.css")
-    if os.path.exists(css_path): 
-        xconfig.USER_CSS = xutils.readfile(css_path)
-    
-    js_path = os.path.join(xconfig.SCRIPTS_DIR, "user.js")
-    if os.path.exists(js_path):
-        xconfig.USER_JS = xutils.readfile(js_path)
-
-    # 暂时取消多主题
-    # xconfig.THEME = "left"
-
-xurls = (
-    r"/settings/index", SettingsHandler,
-    r"/settings/entry", HomeEntrySettingsHandler,
-
-    r"/system/settings", SettingsHandler,
-    r"/system/properties", PropertiesHandler,
-    r"/system/config",  ConfigHandler,
-)
+# -*- coding: utf-8 -*-
+# @author xupingmao
+# @since 2017/02/19
+# @modified 2021/12/12 19:46:19
+import web
+import time
+import os
+import sys
+import platform
+import xutils
+import logging
+import json
+import threading
+import re
+import xtemplate
+import xconfig
+import xauth
+import xtables
+import xmanager
+from xutils import sqlite3, Storage, cacheutil
+from xtemplate import T
+from xutils import logutil
+
+try:
+    import psutil
+except ImportError as e:
+    psutil = None
+
+INIT_SCRIPT_URL = "/code/edit?type=script&path=" + str(xconfig.INIT_SCRIPT)
+USER_CONFIG_KEY_SET = xauth.get_user_config_valid_keys()
+
+@logutil.timeit_deco(logargs=True,logret=True)
+def get_xnote_version():
+    return xconfig.get_global_config("system.version")
+
+class Item:
+    def __init__(self, key, value):
+        self.key   = key
+        self.value = value
+
+class SettingsHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        sys_mem_total     = 0
+        thread_cnt        = 0
+
+        thread_cnt = len(threading.enumerate())
+        item_list  = [
+            Item('软件版本',    get_xnote_version()),
+            Item('sqlite版本', sqlite3.sqlite_version if sqlite3 != None else '')
+        ]
+
+        user_name = xauth.current_name()
+        category = xutils.get_argument("category", "")
+
+        def get_user_config(key):
+            return xauth.get_user_config(user_name, key)
+
+        kw = Storage()
+        kw.show_aside = False
+        kw.html_title = T("设置")
+        kw.item_list = item_list
+        kw.sys_mem_total  = xutils.format_size(sys_mem_total)
+        kw.thread_cnt     = thread_cnt
+        kw.xconfig        = xconfig
+        kw.category       = category
+        kw.xnote_version  = get_xnote_version()
+        kw.start_time     = xconfig.START_TIME
+        kw.init_script_url = INIT_SCRIPT_URL
+        kw.show_admin_btn = False
+        kw.show_back_btn = True
+        kw.get_user_config = get_user_config
+
+        if category == "":
+            kw.show_back_btn = False
+
+        if xauth.is_admin() and category == "":
+            kw.show_admin_btn = True
+
+        if category == "search":
+            kw.html_title = T("搜索设置")
+
+        if category == "admin":
+            kw.html_title = T("管理员设置")
+
+        return xtemplate.render("settings/page/settings.html", **kw)
+
+DEFAULT_SETTINGS = '''
+
+# 导航配置
+[NAV_LIST]
+About = /code/wiki/README.md
+
+
+# 索引目录
+[INDEX_DIRS]
+
+
+'''
+
+class PropertiesHandler:
+    """基于缓存的配置"""
+
+    @xauth.login_required("admin")
+    def GET(self):
+        key  = xutils.get_argument("key")
+        user = xauth.get_current_name()
+        default_value = ""
+
+        if key == "settings":
+            default_value = DEFAULT_SETTINGS
+
+        config = Storage(key = key, value = xutils.cache_get("%s@prop_%s" % (user, key), 
+            default_value))
+
+        if config is None:
+            config = Storage(key=key, value="")
+        return xtemplate.render("settings/page/properties.html", 
+            show_aside = False,
+            config = config)
+    
+    @xauth.login_required("admin")
+    def POST(self):
+        key = xutils.get_argument("key")
+        value = xutils.get_argument("value")
+        user = xauth.get_current_name()
+        
+        xutils.cache_put("%s@prop_%s" % (user, key), value)
+
+        if key == "settings":
+            self.update_settings(value)
+        
+        config = Storage(key = key, value = value)
+        return xtemplate.render("settings/page/properties.html", 
+            show_aside = False,
+            config = config)
+
+    def update_settings(self, config_text):
+        from xutils import ConfigParser
+
+        nav_list = []
+
+        cf = ConfigParser()
+        cf.read_string(config_text)
+        names = cf.sections()
+
+        options = cf.options('NAV_LIST')
+        for option in options:
+            value = cf.get('NAV_LIST', option)
+            nav_list.append(Storage(name = option, url = value))
+
+        # 处理导航        
+        xconfig.NAV_LIST = nav_list
+
+
+@xauth.login_required()
+def update_user_config(key, value):
+    if key not in USER_CONFIG_KEY_SET:
+        raise Exception("无效的配置项:%s" % key)
+
+    user_name = xauth.current_name()
+    config_dict = Storage()
+    config_dict[key] = value
+    xauth.update_user_config_dict(user_name, config_dict)
+
+@xauth.login_required("admin")
+def update_sys_config(key, value):
+    setattr(xconfig, key, value)
+
+class ConfigHandler:
+    
+    @xauth.login_required("admin")
+    def POST(self):
+        key   = xutils.get_argument("key")
+        value = xutils.get_argument_str("value", "")
+        type  = xutils.get_argument("type")
+        p     = xutils.get_argument("p")
+
+        update_msg = "%s,%s,%s" % (type, key, value)
+        logging.info(update_msg)
+        xutils.info("UpdateConfig", update_msg)
+
+        if type == "int":
+            value = int(value)
+
+        if type == "bool":
+            value = value.lower() in ("true", "yes", "on")
+
+        if key == "BASE_TEMPLATE":
+            xmanager.reload()
+
+        if key in ("DEV_MODE", "DEBUG"):
+            xconfig.DEBUG = value
+            xconfig.DEV_MODE = value
+            web.config.debug = value
+
+        if key in ("RECENT_SEARCH_LIMIT", "RECENT_SIZE", "PAGE_SIZE", "TRASH_EXPIRE"):
+            value = int(value)
+
+        try:
+            if p == "user" or key in USER_CONFIG_KEY_SET:
+                update_user_config(key, value)
+            else:
+                update_sys_config(key, value)
+        except Exception as e:
+            return dict(code = "fail", message = "设置失败:" + str(e))
+            
+        return dict(code="success")
+
+class HomeEntrySettingsHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        pass
+
+@xmanager.listen("sys.reload")
+def on_reload(ctx = None):
+    keys = (
+        "THEME", 'FS_HIDE_FILES', 'OPTION_STYLE', 
+        'PAGE_OPEN', 'RECENT_SEARCH_LIMIT', 
+        "PAGE_SIZE", "RECENT_SIZE",
+        "TRASH_EXPIRE",
+        "PAGE_WIDTH", "FS_VIEW_MODE",
+        "HIDE_DICT_ENTRY"
+    )
+    for key in keys:
+        value = cacheutil.hget('sys.config', key)
+        xutils.trace("HGET", "key=%s, value=%s" % (key, value))
+        if value is not None:
+            setattr(xconfig, key, value)
+
+    # TODO 优化扩展样式和脚本
+    css_path = os.path.join(xconfig.SCRIPTS_DIR, "user.css")
+    if os.path.exists(css_path): 
+        xconfig.USER_CSS = xutils.readfile(css_path)
+    
+    js_path = os.path.join(xconfig.SCRIPTS_DIR, "user.js")
+    if os.path.exists(js_path):
+        xconfig.USER_JS = xutils.readfile(js_path)
+
+    # 暂时取消多主题
+    # xconfig.THEME = "left"
+
+xurls = (
+    r"/settings/index", SettingsHandler,
+    r"/settings/entry", HomeEntrySettingsHandler,
+
+    r"/system/settings", SettingsHandler,
+    r"/system/properties", PropertiesHandler,
+    r"/system/config",  ConfigHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/system/backup.py` & `xnote-web-0.1.1/handlers/system/backup.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,440 +1,440 @@
-# encoding=utf-8
-# @author xupingmao
-# @since 2017/07/29
-# @modified 2022/03/31 12:33:26
-"""备份相关，系统默认会添加到定时任务中，参考system/crontab
-"""
-import zipfile
-import os
-import time
-import sys
-import logging
-import threading
-import sqlite3
-
-import xutils
-from xnote.core import xconfig, xauth, xtemplate
-import web.db
-
-from xutils import Storage
-from xutils import dbutil
-from xutils import fsutil, logutil
-from xutils import dateutil
-from xutils.db.driver_sqlite import SqliteKV
-from xnote.core import xtables
-from xnote.service import JobService, SysJob, JobStatusEnum, DatabaseLockService
-
-config = xconfig
-
-_black_list = [".zip", ".pyc", ".pdf", "__pycache__", ".git"]
-_dirname = "./"
-_zipname = "xnote.zip"
-_dest_path = os.path.join(_dirname, "static", _zipname)
-
-# 删除备份在 cron/diskclean 任务里面
-_import_logger = logutil.new_mem_logger("import_db", size = 20)
-
-def zip_xnote(nameblacklist = [_zipname]):
-    dirname = "./"
-    fp = open(_dest_path, "w")
-    fp.close()
-    zf = zipfile.ZipFile(_dest_path, "w")
-    for root, dirs, files in os.walk(dirname):
-        for fname in files:
-            if fname in nameblacklist:
-                continue
-            name, ext = os.path.splitext(fname)
-            if ext in _black_list or fname in nameblacklist:
-                continue
-            path = os.path.join(root, fname)
-            try:
-                st = os.stat(path)
-                if st.st_size > xconfig.MAX_FILE_SIZE:
-                    continue
-            except:
-                continue
-            arcname = path[len(dirname):]
-            zf.write(path, arcname)
-    zf.close()
-
-def zip_new_xnote():
-    zip_xnote([_zipname, ".db", ".log", ".exe"])
-
-
-def chk_scripts_backup():
-    dirname = xconfig.SCRIPTS_DIR
-    destfile = os.path.join(xconfig.BACKUP_DIR, time.strftime("scripts.%Y-%m-%d.zip"))
-    xutils.zip_dir(dirname, destfile)
-
-class DBBackup:
-    """数据库备份"""
-
-    _progress = 0.0
-    _start_time = -1
-    _total = 0
-    lock_key = "backup_job"
-    expire_seconds = 3600
-
-    def __init__(self):
-        self.db_backup_file = os.path.join(xconfig.TMP_DIR, "temp.db")
-
-    @staticmethod
-    def progress():
-        return "%.2f%%" % (DBBackup._progress * 100.0)
-
-    @staticmethod
-    def run_time():
-        start_time = DBBackup._start_time
-        if start_time < 0:
-            return "-1"
-
-        return "%.2fs" % (time.time() - start_time)
-
-    @staticmethod
-    def rest_time():
-        progress = DBBackup._progress
-        if progress == 0:
-            return "-1"
-
-        cost_time = time.time() - DBBackup._start_time
-        total_time = cost_time / progress
-        rest_time = total_time - cost_time
-        return "%.2fs" % rest_time
-
-    @staticmethod
-    def total():
-        return DBBackup._total
-
-    def clean(self):
-        db_backup_file = self.db_backup_file
-        if os.path.exists(db_backup_file):
-            logging.info("删除db备份文件:%s", db_backup_file)
-            fsutil.rmfile(db_backup_file, hard = True)
-
-        # TODO 删除多余的备份文件
-    
-    def get_backup_logger(self):
-        return logutil.get_mem_logger("backup_db", size = 20, ttl = -1)
-
-    def dump_db(self, backup_kv = True, backup_sql=True):
-        count = 0
-        if backup_kv:
-            count = self.backup_kv_store()
-        if backup_sql:
-            self.backup_sql_tables()
-        return count
-    
-    def backup_sql_tables(self):
-        logger = self.get_backup_logger()
-        db = xtables.MySqliteDB(db = self.db_backup_file)
-        # 备份可以关闭同步，加快速度
-        db.query("PRAGMA synchronous = OFF")
-        db.query("PRAGMA journal_mode = WAL")
-        db.query("PRAGMA page_size = 16384") # 16K
-        batch_size = 100
-
-        try:
-            for table in xtables.get_all_tables():
-                backup_table = xtables.init_backup_table(table.tablename, db)
-                backup_table.writable = True
-                backup_table.log_profile = False # 备份的时候不需要profile
-                
-                total_count = table.count()
-                logger.info("backup table:(%s) count:(%d)", table.tablename, total_count)
-                start_time = time.time()
-                count = 0
-                for records in table.iter_batch(batch_size=batch_size):
-                    batch = []
-                    for record in records:
-                        new_record = table.filter_record(record)
-                        batch.append(new_record)
-                        count += 1
-                    # 只更新结构包含的字段
-                    self.multiple_insert(backup_table, batch)
-                    batch = []
-                    cost_time = time.time() - start_time
-                    qps = calc_qps(count, cost_time)
-                    logger.log("table:(%s), proceed:(%d/%d), qps:(%.2f)" % (backup_table.tablename, count, total_count, qps))
-                cost_time = time.time() - start_time
-                logger.info("backup table:(%s) done! cost_time:(%.2fs)", table.tablename, cost_time)
-        except:
-            err_info = xutils.print_exc()
-            logger.info("backup failed: (%s)" % err_info)
-        finally:
-            db.ctx.db.close()
-            del db
-
-    def multiple_insert(self, db, batch):
-        with db.transaction():
-            for value in batch:
-                db.insert(**value)
-
-    def backup_kv_store(self):
-        logger = self.get_backup_logger()
-
-        total_count = dbutil.count_all()
-        start_time = time.time()
-
-        DBBackup._start_time = time.time()
-        DBBackup._total = total_count
-
-        db2 = SqliteKV(self.db_backup_file, debug = False)
-        count = 0
-        try:
-            batch = dbutil.create_write_batch()
-            for key, value in dbutil.get_instance().RangeIter(include_value = True):
-                # 可能是bytearray
-                key = bytes(key)
-                value = bytes(value)
-                
-                if key.startswith(b"_index$"):
-                    # 索引不需要备份
-                    continue
-
-                batch.put_bytes(key, value)
-                count += 1
-                # 更新进度
-                DBBackup._progress = count / total_count
-                if count % 100 == 0:
-                    db2.Write(batch)
-                    batch = dbutil.create_write_batch()
-
-                    cost_time = time.time() - start_time
-                    progress = count/total_count*100.0
-                    qps = calc_qps(count, cost_time)
-                    logger.log("proceed:(%d), progress:(%.2f%%), qps:(%.2f)" % (count, progress, qps))
-
-            db2.Write(batch)
-            db2.Close()
-
-            logger.log("backup done, total:(%d), cost_time:(%.2fs)", count, time.time()-start_time)
-        except:            
-            stack_info = xutils.print_exc()
-            logger.log("backup failed, err:%s", stack_info)
-        finally:
-            db2 = None
-            DBBackup._start_time = -1
-            DBBackup._count = -1
-            DBBackup._progress = 0.0
-        return count
-
-
-    def execute(self, backup_kv=True):
-        logger = self.get_backup_logger()
-        try:
-            with DatabaseLockService.lock(self.lock_key, self.expire_seconds):
-                self.do_execute(backup_kv=backup_kv)
-            return "backup success"
-        except:
-            logger.log("backup is busy")
-            return "backup is busy"
-
-    def do_execute(self, backup_kv=True):
-        
-        job_info = SysJob()
-        job_info.job_type = "db_backup"
-        
-        with JobService.run_with_job(job_info):
-            # 先做清理工作
-            self.clean()
-
-            start_time = time.time()
-            # 执行备份
-            count = self.dump_db(backup_kv=backup_kv)
-
-            cost_time = (time.time() - start_time) * 1000.0
-            logging.info("数据库记录总数:%s", count)
-
-            # 保存为压缩文件
-            dirname = os.path.join(xconfig.BACKUP_DIR, "db")
-            xutils.makedirs(dirname)
-            
-            destfile = os.path.join(dirname, time.strftime("%Y-%m-%d.db"))
-
-            if os.path.exists(destfile):
-                fsutil.rmfile(destfile)
-
-            fsutil.mvfile(self.db_backup_file, destfile)
-
-            # 再次清理
-            self.clean()
-            
-            job_info.job_status = JobStatusEnum.success
-            job_info.job_result = "备份任务完成"
-            job_info.mtime = dateutil.format_datetime()
-
-            return dict(count = count, cost_time = "%sms" % cost_time)
-
-def chk_db_backup():
-    if not xconfig.get_system_config("db_backup"):
-        return
-    backup = DBBackup()
-    return backup.execute()
-
-def calc_key_size():
-    count = 0
-    key_size = 0
-    mem_db = dict()
-    for key in dbutil.get_instance().RangeIter(include_value = False):
-        key_size += sys.getsizeof(key)
-        mem_db[key] = 1
-        count += 1
-    mem_db_size = sys.getsizeof(mem_db)
-
-    result = Storage()
-    result.count = count
-    result.mem_db_size = xutils.format_size(sys.getsizeof(mem_db))
-    result.key_size = xutils.format_size(key_size)
-    result.avg_key_size = xutils.format_size(key_size // count)
-
-    return result
-
-def calc_qps(count, cost_time):
-    if cost_time > 0:
-        return count/cost_time
-    return -1
-
-
-class DBImporter:
-
-    lock_key = "db_import"
-    expire_seconds = 3600
-
-    def import_db(self, db_file):
-        self.db_backup_file = db_file
-        try:
-            with DatabaseLockService.lock(self.lock_key, self.expire_seconds):
-                self.import_sql(db_file)
-                return self.import_kv(db_file)
-        except:
-            exc_info = xutils.print_exc()
-            _import_logger.info(exc_info)
-            logging.warning("import_db is busy")
-            return "import_db is busy"
-    
-    def get_logger(self):
-        return _import_logger
-
-    def import_sql(self, db_file):
-        logger = self.get_logger()
-        backup_db = xtables.MySqliteDB(db = db_file)
-        batch_size = 100
-
-        try:
-            for table in xtables.get_all_tables():
-                if table.table_name == xconfig.DatabaseConfig.kv_store:
-                    logger.info(f"skip kv_store table: {table.table_name}")
-                    continue
-                backup_table = xtables.init_backup_table(table.tablename, backup_db)
-                total_count = backup_table.count()
-                logger.info("import table:(%s) count:(%d)", table.tablename, total_count)
-                start_time = time.time()
-                count = 0
-                assert isinstance(table, xtables.TableProxy)
-                for records in backup_table.iter_batch(batch_size=batch_size):
-                    with table.transaction():
-                        for record in records:
-                            new_record = table.filter_record(record)
-                            where_dict = dict(id = record.id)
-                            old_record = table.select_first(where=where_dict)
-                            if old_record == None:
-                                table.insert(**new_record)
-                            else:
-                                table.update(where=where_dict, **new_record)
-                            count+=1
-                            cost_time = time.time() - start_time
-                            qps = calc_qps(count, cost_time)
-                        logger.log("table:(%s), proceed:(%d/%d), qps:(%.2f)" % (backup_table.tablename, count, total_count, qps))
-                cost_time = time.time() - start_time
-                logger.info("import table:(%s) done! cost_time:(%.2fs)", table.tablename, cost_time)
-        except Exception as e:
-            err_info = xutils.print_exc()
-            logger.info("import failed: (%s)" % err_info)
-            raise e
-
-    def import_kv(self, db_file):
-        count = 0
-        logger = _import_logger
-        db = sqlite3.connect(db_file)
-        total_count = list(db.execute("SELECT COUNT(1) FROM kv_store"))[0][0]
-
-        if total_count == 0:
-            logger.log("db is empty")
-            return
-
-        sql = "SELECT key, value FROM kv_store ORDER BY key"
-
-        start_time = time.time()
-        batch_size = 100
-
-        write_batch = dbutil.create_write_batch()
-        for key, value in db.execute(sql):
-            write_batch.put_bytes(key, value)
-            count += 1
-            if count % batch_size == 0:
-                write_batch.commit(retries=5)
-                write_batch = dbutil.create_write_batch()
-                cost_time = time.time() - start_time
-                progress = count/total_count*100.0
-                qps = calc_qps(count, cost_time)
-                logger.log("proceed:(%d), progress:(%.2f%%), qps:(%.2f)" % (count, progress, qps))
-
-        write_batch.commit(retries=5)
-
-        logger.log("import record done records:%s", count)
-        for table_name in dbutil.get_table_names():
-            logger.log("repair index for (%s)", table_name)
-            try:
-                dbutil.get_table(table_name).repair_index()
-                logger.log("repair index done for (%s)", table_name)
-            except:
-                xutils.print_exc()
-                logger.log("repair index failed for (%s)", table_name)
-
-        logger.log("import done!")
-        return "records:%s" % count
-
-
-
-def import_db(db_file):
-    importer = DBImporter()
-    return importer.import_db(db_file)
-
-class BackupHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        """触发备份事件"""
-        p = xutils.get_argument("p", "")
-
-        if p == "db_backup_home":
-            return xtemplate.render("system/page/db/db_backup.html", 
-                total = DBBackup.total(),
-                run_time = DBBackup.run_time(),
-                rest_time = DBBackup.rest_time(),
-                progress = DBBackup.progress())
-
-        if p == "db":
-            return chk_db_backup()
-
-        if p == "calc_key_size":
-            return calc_key_size()
-
-        if p == "import_db":
-            path = xutils.get_argument("path", "")
-            return import_db(path)
-
-        if p == "backup_sql":
-            backup = DBBackup()
-            return backup.execute(backup_kv=False)
-
-        # 备份所有的
-        chk_db_backup()
-        chk_scripts_backup()
-        return "OK"
-    
-# chk_backup()
-
-xurls = (
-    r"/system/backup", BackupHandler,
-)
+# encoding=utf-8
+# @author xupingmao
+# @since 2017/07/29
+# @modified 2022/03/31 12:33:26
+"""备份相关，系统默认会添加到定时任务中，参考system/crontab
+"""
+import zipfile
+import os
+import time
+import sys
+import logging
+import threading
+import sqlite3
+
+import xutils
+from xnote.core import xconfig, xauth, xtemplate
+import web.db
+
+from xutils import Storage
+from xutils import dbutil
+from xutils import fsutil, logutil
+from xutils import dateutil
+from xutils.db.driver_sqlite import SqliteKV
+from xnote.core import xtables
+from xnote.service import JobService, SysJob, JobStatusEnum, DatabaseLockService
+
+config = xconfig
+
+_black_list = [".zip", ".pyc", ".pdf", "__pycache__", ".git"]
+_dirname = "./"
+_zipname = "xnote.zip"
+_dest_path = os.path.join(_dirname, "static", _zipname)
+
+# 删除备份在 cron/diskclean 任务里面
+_import_logger = logutil.new_mem_logger("import_db", size = 20)
+
+def zip_xnote(nameblacklist = [_zipname]):
+    dirname = "./"
+    fp = open(_dest_path, "w")
+    fp.close()
+    zf = zipfile.ZipFile(_dest_path, "w")
+    for root, dirs, files in os.walk(dirname):
+        for fname in files:
+            if fname in nameblacklist:
+                continue
+            name, ext = os.path.splitext(fname)
+            if ext in _black_list or fname in nameblacklist:
+                continue
+            path = os.path.join(root, fname)
+            try:
+                st = os.stat(path)
+                if st.st_size > xconfig.MAX_FILE_SIZE:
+                    continue
+            except:
+                continue
+            arcname = path[len(dirname):]
+            zf.write(path, arcname)
+    zf.close()
+
+def zip_new_xnote():
+    zip_xnote([_zipname, ".db", ".log", ".exe"])
+
+
+def chk_scripts_backup():
+    dirname = xconfig.SCRIPTS_DIR
+    destfile = os.path.join(xconfig.BACKUP_DIR, time.strftime("scripts.%Y-%m-%d.zip"))
+    xutils.zip_dir(dirname, destfile)
+
+class DBBackup:
+    """数据库备份"""
+
+    _progress = 0.0
+    _start_time = -1
+    _total = 0
+    lock_key = "backup_job"
+    expire_seconds = 3600
+
+    def __init__(self):
+        self.db_backup_file = os.path.join(xconfig.TMP_DIR, "temp.db")
+
+    @staticmethod
+    def progress():
+        return "%.2f%%" % (DBBackup._progress * 100.0)
+
+    @staticmethod
+    def run_time():
+        start_time = DBBackup._start_time
+        if start_time < 0:
+            return "-1"
+
+        return "%.2fs" % (time.time() - start_time)
+
+    @staticmethod
+    def rest_time():
+        progress = DBBackup._progress
+        if progress == 0:
+            return "-1"
+
+        cost_time = time.time() - DBBackup._start_time
+        total_time = cost_time / progress
+        rest_time = total_time - cost_time
+        return "%.2fs" % rest_time
+
+    @staticmethod
+    def total():
+        return DBBackup._total
+
+    def clean(self):
+        db_backup_file = self.db_backup_file
+        if os.path.exists(db_backup_file):
+            logging.info("删除db备份文件:%s", db_backup_file)
+            fsutil.rmfile(db_backup_file, hard = True)
+
+        # TODO 删除多余的备份文件
+    
+    def get_backup_logger(self):
+        return logutil.get_mem_logger("backup_db", size = 20, ttl = -1)
+
+    def dump_db(self, backup_kv = True, backup_sql=True):
+        count = 0
+        if backup_kv:
+            count = self.backup_kv_store()
+        if backup_sql:
+            self.backup_sql_tables()
+        return count
+    
+    def backup_sql_tables(self):
+        logger = self.get_backup_logger()
+        db = xtables.MySqliteDB(db = self.db_backup_file)
+        # 备份可以关闭同步，加快速度
+        db.query("PRAGMA synchronous = OFF")
+        db.query("PRAGMA journal_mode = WAL")
+        db.query("PRAGMA page_size = 16384") # 16K
+        batch_size = 100
+
+        try:
+            for table in xtables.get_all_tables():
+                backup_table = xtables.init_backup_table(table.tablename, db)
+                backup_table.writable = True
+                backup_table.log_profile = False # 备份的时候不需要profile
+                
+                total_count = table.count()
+                logger.info("backup table:(%s) count:(%d)", table.tablename, total_count)
+                start_time = time.time()
+                count = 0
+                for records in table.iter_batch(batch_size=batch_size):
+                    batch = []
+                    for record in records:
+                        new_record = table.filter_record(record)
+                        batch.append(new_record)
+                        count += 1
+                    # 只更新结构包含的字段
+                    self.multiple_insert(backup_table, batch)
+                    batch = []
+                    cost_time = time.time() - start_time
+                    qps = calc_qps(count, cost_time)
+                    logger.log("table:(%s), proceed:(%d/%d), qps:(%.2f)" % (backup_table.tablename, count, total_count, qps))
+                cost_time = time.time() - start_time
+                logger.info("backup table:(%s) done! cost_time:(%.2fs)", table.tablename, cost_time)
+        except:
+            err_info = xutils.print_exc()
+            logger.info("backup failed: (%s)" % err_info)
+        finally:
+            db.ctx.db.close()
+            del db
+
+    def multiple_insert(self, db, batch):
+        with db.transaction():
+            for value in batch:
+                db.insert(**value)
+
+    def backup_kv_store(self):
+        logger = self.get_backup_logger()
+
+        total_count = dbutil.count_all()
+        start_time = time.time()
+
+        DBBackup._start_time = time.time()
+        DBBackup._total = total_count
+
+        db2 = SqliteKV(self.db_backup_file, debug = False)
+        count = 0
+        try:
+            batch = dbutil.create_write_batch()
+            for key, value in dbutil.get_instance().RangeIter(include_value = True):
+                # 可能是bytearray
+                key = bytes(key)
+                value = bytes(value)
+                
+                if key.startswith(b"_index$"):
+                    # 索引不需要备份
+                    continue
+
+                batch.put_bytes(key, value)
+                count += 1
+                # 更新进度
+                DBBackup._progress = count / total_count
+                if count % 100 == 0:
+                    db2.Write(batch)
+                    batch = dbutil.create_write_batch()
+
+                    cost_time = time.time() - start_time
+                    progress = count/total_count*100.0
+                    qps = calc_qps(count, cost_time)
+                    logger.log("proceed:(%d), progress:(%.2f%%), qps:(%.2f)" % (count, progress, qps))
+
+            db2.Write(batch)
+            db2.Close()
+
+            logger.log("backup done, total:(%d), cost_time:(%.2fs)", count, time.time()-start_time)
+        except:            
+            stack_info = xutils.print_exc()
+            logger.log("backup failed, err:%s", stack_info)
+        finally:
+            db2 = None
+            DBBackup._start_time = -1
+            DBBackup._count = -1
+            DBBackup._progress = 0.0
+        return count
+
+
+    def execute(self, backup_kv=True):
+        logger = self.get_backup_logger()
+        try:
+            with DatabaseLockService.lock(self.lock_key, self.expire_seconds):
+                self.do_execute(backup_kv=backup_kv)
+            return "backup success"
+        except:
+            logger.log("backup is busy")
+            return "backup is busy"
+
+    def do_execute(self, backup_kv=True):
+        
+        job_info = SysJob()
+        job_info.job_type = "db_backup"
+        
+        with JobService.run_with_job(job_info):
+            # 先做清理工作
+            self.clean()
+
+            start_time = time.time()
+            # 执行备份
+            count = self.dump_db(backup_kv=backup_kv)
+
+            cost_time = (time.time() - start_time) * 1000.0
+            logging.info("数据库记录总数:%s", count)
+
+            # 保存为压缩文件
+            dirname = os.path.join(xconfig.BACKUP_DIR, "db")
+            xutils.makedirs(dirname)
+            
+            destfile = os.path.join(dirname, time.strftime("%Y-%m-%d.db"))
+
+            if os.path.exists(destfile):
+                fsutil.rmfile(destfile)
+
+            fsutil.mvfile(self.db_backup_file, destfile)
+
+            # 再次清理
+            self.clean()
+            
+            job_info.job_status = JobStatusEnum.success
+            job_info.job_result = f"备份任务完成, 耗时{int(cost_time)}ms"
+            job_info.mtime = dateutil.format_datetime()
+
+            return dict(count = count, cost_time = "%sms" % cost_time)
+
+def chk_db_backup():
+    if not xconfig.get_system_config("db_backup"):
+        return
+    backup = DBBackup()
+    return backup.execute()
+
+def calc_key_size():
+    count = 0
+    key_size = 0
+    mem_db = dict()
+    for key in dbutil.get_instance().RangeIter(include_value = False):
+        key_size += sys.getsizeof(key)
+        mem_db[key] = 1
+        count += 1
+    mem_db_size = sys.getsizeof(mem_db)
+
+    result = Storage()
+    result.count = count
+    result.mem_db_size = xutils.format_size(sys.getsizeof(mem_db))
+    result.key_size = xutils.format_size(key_size)
+    result.avg_key_size = xutils.format_size(key_size // count)
+
+    return result
+
+def calc_qps(count, cost_time):
+    if cost_time > 0:
+        return count/cost_time
+    return -1
+
+
+class DBImporter:
+
+    lock_key = "db_import"
+    expire_seconds = 3600
+
+    def import_db(self, db_file):
+        self.db_backup_file = db_file
+        try:
+            with DatabaseLockService.lock(self.lock_key, self.expire_seconds):
+                self.import_sql(db_file)
+                return self.import_kv(db_file)
+        except:
+            exc_info = xutils.print_exc()
+            _import_logger.info(exc_info)
+            logging.warning("import_db is busy")
+            return "import_db is busy"
+    
+    def get_logger(self):
+        return _import_logger
+
+    def import_sql(self, db_file):
+        logger = self.get_logger()
+        backup_db = xtables.MySqliteDB(db = db_file)
+        batch_size = 100
+
+        try:
+            for table in xtables.get_all_tables():
+                if table.table_name == xconfig.DatabaseConfig.kv_store:
+                    logger.info(f"skip kv_store table: {table.table_name}")
+                    continue
+                backup_table = xtables.init_backup_table(table.tablename, backup_db)
+                total_count = backup_table.count()
+                logger.info("import table:(%s) count:(%d)", table.tablename, total_count)
+                start_time = time.time()
+                count = 0
+                assert isinstance(table, xtables.TableProxy)
+                for records in backup_table.iter_batch(batch_size=batch_size):
+                    with table.transaction():
+                        for record in records:
+                            new_record = table.filter_record(record)
+                            where_dict = dict(id = record.id)
+                            old_record = table.select_first(where=where_dict)
+                            if old_record == None:
+                                table.insert(**new_record)
+                            else:
+                                table.update(where=where_dict, **new_record)
+                            count+=1
+                            cost_time = time.time() - start_time
+                            qps = calc_qps(count, cost_time)
+                        logger.log("table:(%s), proceed:(%d/%d), qps:(%.2f)" % (backup_table.tablename, count, total_count, qps))
+                cost_time = time.time() - start_time
+                logger.info("import table:(%s) done! cost_time:(%.2fs)", table.tablename, cost_time)
+        except Exception as e:
+            err_info = xutils.print_exc()
+            logger.info("import failed: (%s)" % err_info)
+            raise e
+
+    def import_kv(self, db_file):
+        count = 0
+        logger = _import_logger
+        db = sqlite3.connect(db_file)
+        total_count = list(db.execute("SELECT COUNT(1) FROM kv_store"))[0][0]
+
+        if total_count == 0:
+            logger.log("db is empty")
+            return
+
+        sql = "SELECT key, value FROM kv_store ORDER BY key"
+
+        start_time = time.time()
+        batch_size = 100
+
+        write_batch = dbutil.create_write_batch()
+        for key, value in db.execute(sql):
+            write_batch.put_bytes(key, value)
+            count += 1
+            if count % batch_size == 0:
+                write_batch.commit(retries=5)
+                write_batch = dbutil.create_write_batch()
+                cost_time = time.time() - start_time
+                progress = count/total_count*100.0
+                qps = calc_qps(count, cost_time)
+                logger.log("proceed:(%d), progress:(%.2f%%), qps:(%.2f)" % (count, progress, qps))
+
+        write_batch.commit(retries=5)
+
+        logger.log("import record done records:%s", count)
+        for table_name in dbutil.get_table_names():
+            logger.log("repair index for (%s)", table_name)
+            try:
+                dbutil.get_table(table_name).repair_index()
+                logger.log("repair index done for (%s)", table_name)
+            except:
+                xutils.print_exc()
+                logger.log("repair index failed for (%s)", table_name)
+
+        logger.log("import done!")
+        return "records:%s" % count
+
+
+
+def import_db(db_file):
+    importer = DBImporter()
+    return importer.import_db(db_file)
+
+class BackupHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        """触发备份事件"""
+        p = xutils.get_argument("p", "")
+
+        if p == "db_backup_home":
+            return xtemplate.render("system/page/db/db_backup.html", 
+                total = DBBackup.total(),
+                run_time = DBBackup.run_time(),
+                rest_time = DBBackup.rest_time(),
+                progress = DBBackup.progress())
+
+        if p == "db":
+            return chk_db_backup()
+
+        if p == "calc_key_size":
+            return calc_key_size()
+
+        if p == "import_db":
+            path = xutils.get_argument("path", "")
+            return import_db(path)
+
+        if p == "backup_sql":
+            backup = DBBackup()
+            return backup.execute(backup_kv=False)
+
+        # 备份所有的
+        chk_db_backup()
+        chk_scripts_backup()
+        return "OK"
+    
+# chk_backup()
+
+xurls = (
+    r"/system/backup", BackupHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/system/cache_admin.py` & `xnote-web-0.1.1/handlers/system/cache_admin.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/clipboard.py` & `xnote-web-0.1.1/handlers/system/clipboard.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,16 +1,16 @@
 # -*- coding:utf-8 -*-
 # @author xupingmao <578749341@qq.com>
 # @since 2019/07/18 22:55:08
 # @modified 2019/07/20 22:42:44
 import xutils
-import xmanager
+from xnote.core import xmanager
 import logging
 
-from xtemplate import BasePlugin
+from xnote.core.xtemplate import BasePlugin
 from xutils import dateutil
 from xutils import dbutil
 
 HTML = """
 <!-- Html -->
 <style>
 .th-time {
```

### Comparing `xnote-web-0.1.0/handlers/system/command.py` & `xnote-web-0.1.1/handlers/system/command.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/admin_nav.html` & `xnote-web-0.1.1/handlers/system/component/admin_nav.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/db_kv_nav.html` & `xnote-web-0.1.1/handlers/system/component/db_kv_nav.html`

 * *Ordering differences only*

 * *Files 17% similar despite different names*

```diff
@@ -1,11 +1,11 @@
-<div class="card">
-    <div class="x-tab-box" data-tab-key="p2" data-tab-default="all">
-        <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=active" data-tab-value="active">Table</a>
-        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=index" data-tab-value="index">Index</a> -->
-        <!-- <a class="x-tab" href="{{_server_home}}/system/db_index?p=meta&p2=index_v1" data-tab-value="index_v1">Index-v1</a> -->
-        <a class="x-tab" href="{{_server_home}}/system/db_index?p=meta&p2=index_v2" data-tab-value="index_v2">Index</a>
-        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=set" data-tab-value="set">Set</a> -->
-        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=sorted_set" data-tab-value="sorted_set">SortedSet</a> -->
-        <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=delete" data-tab-value="delete">删除</a>
-    </div>
-</div>
+<div class="card">
+    <div class="x-tab-box" data-tab-key="p2" data-tab-default="all">
+        <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=active" data-tab-value="active">Table</a>
+        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=index" data-tab-value="index">Index</a> -->
+        <!-- <a class="x-tab" href="{{_server_home}}/system/db_index?p=meta&p2=index_v1" data-tab-value="index_v1">Index-v1</a> -->
+        <a class="x-tab" href="{{_server_home}}/system/db_index?p=meta&p2=index_v2" data-tab-value="index_v2">Index</a>
+        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=set" data-tab-value="set">Set</a> -->
+        <!-- <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=sorted_set" data-tab-value="sorted_set">SortedSet</a> -->
+        <a class="x-tab" href="{{_server_home}}/system/db_admin?p=meta&p2=delete" data-tab-value="delete">删除</a>
+    </div>
+</div>
```

### Comparing `xnote-web-0.1.0/handlers/system/component/db_nav.html` & `xnote-web-0.1.1/handlers/system/component/db_nav.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/system_log_tab.html` & `xnote-web-0.1.1/handlers/system/component/system_log_tab.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/system_sync_cluster_info.html` & `xnote-web-0.1.1/handlers/system/component/system_sync_cluster_info.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/system_sync_follower_view.html` & `xnote-web-0.1.1/handlers/system/component/system_sync_follower_view.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/component/thread_nav.html` & `xnote-web-0.1.1/handlers/system/component/thread_nav.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/crontab.py` & `xnote-web-0.1.1/handlers/system/crontab.py`

 * *Files 10% similar despite different names*

```diff
@@ -4,15 +4,14 @@
 
 """xnote定时任务配置"""
 import os
 import web
 import json
 from xutils import webutil
 from xnote.core import xauth
-from xnote.core import xtemplate
 from xnote.core import xmanager
 import xutils
 from xnote.core import xconfig
 from xnote.plugin.table_plugin import BaseTablePlugin
 from xnote.plugin import DataTable, TableActionType, DataForm, FormRowType
 from .dao_cron import CronJobDao
 
@@ -87,24 +86,14 @@
         tm_min  = tm_min,
         message = message,
         sound   = sound,
         webpage = webpage)
     dbutil.put(key, data)
     return id
 
-class CronEditHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        id  = xutils.get_argument("id")
-        key = "schedule:%s" % id
-        sched = dbutil.get(key)
-        return xtemplate.render("system/page/crontab_edit.html", 
-            item = sched, 
-            links = get_cron_links())
 
 class ListHandler(BaseTablePlugin):
 
     title = "定时任务"
     require_admin = True
     show_aside = True
     PAGE_HTML = BaseTablePlugin.TABLE_HTML
@@ -157,14 +146,15 @@
                 task.delete_url = f"?action=delete&id={task.id}"
                 task.delete_msg = f"确认删除任务【{task.display_name}】吗?"
 
             table.add_row(task)
 
         kw = xutils.Storage()
         kw.table = table
+        self.write_aside("""{% include system/component/admin_nav.html %}""")
         return self.response_page(**kw)
     
     def handle_edit(self):
         id  = xutils.get_argument("id")
         key = f"schedule:{id}"
         sched = dbutil.db_get_object(key)
         assert sched != None
@@ -270,25 +260,11 @@
             tm_min=tm_min)
         xmanager.instance().load_tasks()
 
         if format == "json":
             return dict(code = "success", data = dict(id = sched_id))
         raise web.seeother("/system/crontab")
 
-class RemoveHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        id = xutils.get_argument("id")
-        key = "schedule:%s" % id
-        dbutil.delete(key)
-        xmanager.load_tasks()
-        raise web.seeother("/system/crontab")
-
-    def GET(self):
-        return self.POST()
-
 xurls=(
     r"/system/crontab",     ListHandler, 
-    r"/system/crontab/remove", RemoveHandler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/system/db_index.py` & `xnote-web-0.1.1/handlers/system/db_index.py`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,122 +1,122 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-05-14 12:31:02
-@LastEditors  : xupingmao
-@LastEditTime : 2024-02-24 15:25:06
-@FilePath     : /xnote/handlers/system/db_index.py
-@Description  : 数据库索引管理
-"""
-
-from web.utils import Storage
-from xnote.core import xauth
-from xnote.core import xtemplate, xconfig
-from xutils import dbutil
-import xutils
-
-class TableIndex:
-
-    def __init__(self, table_name, index_names):
-        self.table_name = table_name
-        self.index_names = index_names
-        
-class TableInfoVO:
-    
-    def __init__(self, table_name="", index_name=""):
-        self.table_name = table_name
-        self.table_url = ""
-        self.index_name = index_name
-        self.index_url = ""
-        self.index_count = 0
-    
-    @staticmethod
-    def from_table_info(table_info: dbutil.TableInfo):
-        if table_info.index_db is None:
-            raise Exception("index_db is None")
-        
-        result = TableInfoVO()
-        result.table_name = table_info.name
-        result.table_url = xconfig.WebConfig.server_home + f"/system/db_scan?prefix={table_info.name}&reverse=true"
-        result.index_name = table_info.index_db.table_name
-        result.index_url = xconfig.WebConfig.server_home + f"/system/sqldb_detail?name={result.index_name}"
-        result.index_count = table_info.index_db.count()
-        return result
-
-def count_index(table_name, index_name):
-    index_table_name = dbutil.get_index_table_name(table_name, index_name)
-    return dbutil.count_table(index_table_name, use_cache=True)
-
-def count_table(table_name):
-    return dbutil.count_table(table_name, use_cache=True)
-
-class IndexHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        
-        p2 = xutils.get_argument_str("p2")
-        if p2 == "index_v2":
-            return self.get_index_v2()
-        return self.get_index_v1()
-    
-    def get_index_v2(self):
-        table_list = []
-        
-        for table_name in dbutil.get_table_names():
-            table_info = dbutil.get_table_info(table_name)
-            assert table_info != None
-            if table_info.is_deleted:
-                continue
-            index_db = table_info.index_db
-            if index_db != None:
-                info = TableInfoVO.from_table_info(table_info)
-                table_list.append(info)
-
-        kw = Storage()
-        kw.table_list = table_list
-
-        return xtemplate.render("system/page/db/db_index_v2.html", **kw)
-
-    def get_index_v1(self):
-        index_list = []
-        
-        for table_name in dbutil.get_table_names():
-            table_info = dbutil.get_table_info(table_name)
-            assert table_info != None
-            if table_info.is_deleted:
-                continue
-            index_names = dbutil.get_table_index_names(table_name)
-            if len(index_names) > 0:
-                index_list.append(TableIndex(table_name, index_names))
-
-        kw = Storage()
-        kw.index_list = index_list
-        kw.count_index = count_index
-        kw.count_table = count_table
-        kw.get_index_table_name = dbutil.get_index_table_name
-
-        return xtemplate.render("system/page/db/db_index.html", **kw)
-    
-    @xauth.login_required("admin")
-    def POST(self):
-        action = xutils.get_argument("action", "")
-        if action == "rebuild":
-            return self.rebuild_index()
-        return dict(code = "404", message = "未知操作")
-    
-    def rebuild_index(self):
-        table_name = xutils.get_argument("table_name", "")
-
-        db = dbutil.get_table(table_name)
-        try:
-            db.repair_index()
-        except:
-            return dict(code = "fail", message = "重建索引异常")
-            
-        return dict(code = "success")
-
-
-xurls = (
-    r"/system/db_index", IndexHandler
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-05-14 12:31:02
+@LastEditors  : xupingmao
+@LastEditTime : 2024-02-24 15:25:06
+@FilePath     : /xnote/handlers/system/db_index.py
+@Description  : 数据库索引管理
+"""
+
+from web.utils import Storage
+from xnote.core import xauth
+from xnote.core import xtemplate, xconfig
+from xutils import dbutil
+import xutils
+
+class TableIndex:
+
+    def __init__(self, table_name, index_names):
+        self.table_name = table_name
+        self.index_names = index_names
+        
+class TableInfoVO:
+    
+    def __init__(self, table_name="", index_name=""):
+        self.table_name = table_name
+        self.table_url = ""
+        self.index_name = index_name
+        self.index_url = ""
+        self.index_count = 0
+    
+    @staticmethod
+    def from_table_info(table_info: dbutil.TableInfo):
+        if table_info.index_db is None:
+            raise Exception("index_db is None")
+        
+        result = TableInfoVO()
+        result.table_name = table_info.name
+        result.table_url = xconfig.WebConfig.server_home + f"/system/db_scan?prefix={table_info.name}&reverse=true"
+        result.index_name = table_info.index_db.table_name
+        result.index_url = xconfig.WebConfig.server_home + f"/system/sqldb_detail?name={result.index_name}"
+        result.index_count = table_info.index_db.count()
+        return result
+
+def count_index(table_name, index_name):
+    index_table_name = dbutil.get_index_table_name(table_name, index_name)
+    return dbutil.count_table(index_table_name, use_cache=True)
+
+def count_table(table_name):
+    return dbutil.count_table(table_name, use_cache=True)
+
+class IndexHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        
+        p2 = xutils.get_argument_str("p2")
+        if p2 == "index_v2":
+            return self.get_index_v2()
+        return self.get_index_v1()
+    
+    def get_index_v2(self):
+        table_list = []
+        
+        for table_name in dbutil.get_table_names():
+            table_info = dbutil.get_table_info(table_name)
+            assert table_info != None
+            if table_info.is_deleted:
+                continue
+            index_db = table_info.index_db
+            if index_db != None:
+                info = TableInfoVO.from_table_info(table_info)
+                table_list.append(info)
+
+        kw = Storage()
+        kw.table_list = table_list
+
+        return xtemplate.render("system/page/db/db_index_v2.html", **kw)
+
+    def get_index_v1(self):
+        index_list = []
+        
+        for table_name in dbutil.get_table_names():
+            table_info = dbutil.get_table_info(table_name)
+            assert table_info != None
+            if table_info.is_deleted:
+                continue
+            index_names = dbutil.get_table_index_names(table_name)
+            if len(index_names) > 0:
+                index_list.append(TableIndex(table_name, index_names))
+
+        kw = Storage()
+        kw.index_list = index_list
+        kw.count_index = count_index
+        kw.count_table = count_table
+        kw.get_index_table_name = dbutil.get_index_table_name
+
+        return xtemplate.render("system/page/db/db_index.html", **kw)
+    
+    @xauth.login_required("admin")
+    def POST(self):
+        action = xutils.get_argument("action", "")
+        if action == "rebuild":
+            return self.rebuild_index()
+        return dict(code = "404", message = "未知操作")
+    
+    def rebuild_index(self):
+        table_name = xutils.get_argument("table_name", "")
+
+        db = dbutil.get_table(table_name)
+        try:
+            db.repair_index()
+        except:
+            return dict(code = "fail", message = "重建索引异常")
+            
+        return dict(code = "success")
+
+
+xurls = (
+    r"/system/db_index", IndexHandler
 )
```

### Comparing `xnote-web-0.1.0/handlers/system/db_migrate_tools.py` & `xnote-web-0.1.1/handlers/system/db_migrate_tools.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/db_refresh.py` & `xnote-web-0.1.1/handlers/system/db_refresh.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/db_shell.py` & `xnote-web-0.1.1/handlers/system/db_shell.py`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,136 +1,136 @@
-# encoding=utf-8
-# @since 2017/02/19
-# @modified 2022/03/18 23:34:21
-import sqlite3
-import os
-import xutils
-import time
-import logging
-from xnote.core import xauth, xconfig, xtemplate, xtables
-
-from collections import OrderedDict
-
-config = xconfig
-
-def db_execute(path, sql, args = None):
-    """需要保持字段的顺序"""
-    db = sqlite3.connect(path)
-    cursorobj = db.cursor()
-    kv_result = []
-    try:
-        if args is None:
-            cursorobj.execute(sql)
-        else:
-            cursorobj.execute(sql, args)
-        result = cursorobj.fetchall()
-        for single in result:
-            # 保持字段顺序
-            resultMap = OrderedDict()
-            for i, desc in enumerate(cursorobj.description):
-                name = desc[0]
-                resultMap[name] = single[i]
-            kv_result.append(resultMap)
-
-    except Exception as e:
-        raise e
-    finally:
-        db.commit()
-        db.close()
-    return kv_result
-
-class handler:
-
-    def get_result_by_action(self, action, path):
-        if action == "show_tables":
-            return db_execute(path, "SELECT * FROM sqlite_master;")
-        if action == "count_tables":
-            result = []
-            table_names = db_execute(path, "SELECT name FROM sqlite_master WHERE type = ?;", ("table",))
-            for name_row in table_names:
-                name = name_row["name"]
-                amount = db_execute(path, "SELECT COUNT(1) AS amount FROM %s" % name)[0].get("amount")
-                row = OrderedDict()
-                row["name"] = name
-                row["amount"] = amount
-                result.append(row)
-            return result
-
-        return []
-    
-    def do_execute(self):
-        path = xutils.get_argument_str("path")
-        sql = xutils.get_argument_str("sql")
-        action = xutils.get_argument_str("action")
-        result_list = []
-        error = ""
-        logging.info("path:(%s), sql:(%s)", path, sql)
-
-        if sql == "" and path != "":
-            result_list = self.get_result_by_action(action, path)
-        
-        if sql != "" and path != "":
-            try:
-                realpath = path
-                result_list = db_execute(realpath, sql)
-            except Exception as e:
-                xutils.print_exc()
-                error = e
-        if len(result_list) > 0:
-            keys = result_list[0].keys()
-        else:
-            keys = []
-        return keys, result_list, error
-
-    def handle_mysql(self,sql=""):
-        if sql == "":
-            return [], [], ""
-        db = xtables.get_default_db_instance()
-        try:
-            result = db.query(sql)
-        except:
-            error = xutils.print_exc()
-            return [],[],error
-        result_list = []
-
-        for record in result:
-            if len(result_list) > 100:
-                logging.info("too many results")
-                break
-            result_list.append(record)
-
-        return result.names, result_list, ""
-
-
-    @xauth.login_required("admin")
-    def POST(self):
-        sql = xutils.get_argument_str("sql")
-        path = xutils.get_argument_str("path")
-        action = xutils.get_argument_str("action")
-        type = xutils.get_argument_str("type")
-
-        t_start = time.time()
-        if type == "mysql":
-            keys, result_list, error = self.handle_mysql(sql)
-        else:
-            keys, result_list, error = self.do_execute()
-        t_stop = time.time()
-
-
-        kw = xutils.Storage()
-        kw.cols = keys
-        kw.show_right = False
-        kw.result_list = result_list
-        kw.sql = sql
-        kw.error = error
-        kw.cost_time = int((t_stop-t_start)*1000)
-        kw.path = path
-
-        return xtemplate.render("system/page/sqlite.html", **kw)
-
-    def GET(self):
-        return self.POST()
-
-
-xurls = (
-    r"/system/sqlite", handler,
+# encoding=utf-8
+# @since 2017/02/19
+# @modified 2022/03/18 23:34:21
+import sqlite3
+import os
+import xutils
+import time
+import logging
+from xnote.core import xauth, xconfig, xtemplate, xtables
+
+from collections import OrderedDict
+
+config = xconfig
+
+def db_execute(path, sql, args = None):
+    """需要保持字段的顺序"""
+    db = sqlite3.connect(path)
+    cursorobj = db.cursor()
+    kv_result = []
+    try:
+        if args is None:
+            cursorobj.execute(sql)
+        else:
+            cursorobj.execute(sql, args)
+        result = cursorobj.fetchall()
+        for single in result:
+            # 保持字段顺序
+            resultMap = OrderedDict()
+            for i, desc in enumerate(cursorobj.description):
+                name = desc[0]
+                resultMap[name] = single[i]
+            kv_result.append(resultMap)
+
+    except Exception as e:
+        raise e
+    finally:
+        db.commit()
+        db.close()
+    return kv_result
+
+class handler:
+
+    def get_result_by_action(self, action, path):
+        if action == "show_tables":
+            return db_execute(path, "SELECT * FROM sqlite_master;")
+        if action == "count_tables":
+            result = []
+            table_names = db_execute(path, "SELECT name FROM sqlite_master WHERE type = ?;", ("table",))
+            for name_row in table_names:
+                name = name_row["name"]
+                amount = db_execute(path, "SELECT COUNT(1) AS amount FROM %s" % name)[0].get("amount")
+                row = OrderedDict()
+                row["name"] = name
+                row["amount"] = amount
+                result.append(row)
+            return result
+
+        return []
+    
+    def do_execute(self):
+        path = xutils.get_argument_str("path")
+        sql = xutils.get_argument_str("sql")
+        action = xutils.get_argument_str("action")
+        result_list = []
+        error = ""
+        logging.info("path:(%s), sql:(%s)", path, sql)
+
+        if sql == "" and path != "":
+            result_list = self.get_result_by_action(action, path)
+        
+        if sql != "" and path != "":
+            try:
+                realpath = path
+                result_list = db_execute(realpath, sql)
+            except Exception as e:
+                xutils.print_exc()
+                error = e
+        if len(result_list) > 0:
+            keys = result_list[0].keys()
+        else:
+            keys = []
+        return keys, result_list, error
+
+    def handle_mysql(self,sql=""):
+        if sql == "":
+            return [], [], ""
+        db = xtables.get_default_db_instance()
+        try:
+            result = db.query(sql)
+        except:
+            error = xutils.print_exc()
+            return [],[],error
+        result_list = []
+
+        for record in result:
+            if len(result_list) > 100:
+                logging.info("too many results")
+                break
+            result_list.append(record)
+
+        return result.names, result_list, ""
+
+
+    @xauth.login_required("admin")
+    def POST(self):
+        sql = xutils.get_argument_str("sql")
+        path = xutils.get_argument_str("path")
+        action = xutils.get_argument_str("action")
+        type = xutils.get_argument_str("type")
+
+        t_start = time.time()
+        if type == "mysql":
+            keys, result_list, error = self.handle_mysql(sql)
+        else:
+            keys, result_list, error = self.do_execute()
+        t_stop = time.time()
+
+
+        kw = xutils.Storage()
+        kw.cols = keys
+        kw.show_right = False
+        kw.result_list = result_list
+        kw.sql = sql
+        kw.error = error
+        kw.cost_time = int((t_stop-t_start)*1000)
+        kw.path = path
+
+        return xtemplate.render("system/page/sqlite.html", **kw)
+
+    def GET(self):
+        return self.POST()
+
+
+xurls = (
+    r"/system/sqlite", handler,
 )
```

### Comparing `xnote-web-0.1.0/handlers/system/db_upgrade.py` & `xnote-web-0.1.1/handlers/system/db_upgrade.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/develop_controller.py` & `xnote-web-0.1.1/handlers/system/develop_controller.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/handler_profile.py` & `xnote-web-0.1.1/handlers/system/handler_profile.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/mod_aside.html` & `xnote-web-0.1.1/handlers/system/mod_aside.html`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,64 +1,64 @@
-
-{% import xmanager %}
-{% init sys_plugins = xmanager.find_plugins("system") %}
-<div class="aside-item hide">
-    <div class="aside-title">
-        用户
-    </div>
-    <div class="aside-content">
-        <ul>
-            <li>{{_user_name}}</li>
-            <!--
-            <li>日期: <span class="currentDate"></span></li>
-            <li>时间: <span class="currentTime"></span></li>
-            -->
-            {% if _has_login %}
-                <li><a href="{{_server_home}}/logout">登出</a></li>
-            {% else %}
-                <li><a href="{{_server_home}}/login">登陆</a></li>
-            {% end %}
-        </ul>
-    </div>
-</div>
-
-{% if len(sys_plugins) > 0 %}
-    <div class="aside-item">
-        <div class="aside-title">
-            {{T("Options")}}
-        </div>
-        <div class="aside-content">
-            <ul>
-                {% for p in sys_plugins %}
-                    <li><a href="{{_server_home}}/plugins/{{p.name}}">{{p.title}}</a></li>
-                {% end %}
-            </ul>
-        </div>
-    </div>
-{% end %}
-
-<div class="aside-item">
-    <div class="aside-title">{{T("Time")}}</div>
-    <div class="aside-content">
-        <span class="currentDateTime"></span>
-    </div>
-</div>
-
-<script type="text/javascript">
-$(function () {
-    function updateTime () {
-        $(".currentTime").html(new Date().format("HH:mm:ss"));
-        $(".currentDate").html(new Date().format("yyyy-MM-dd"));
-        $(".currentDateTime").html(new Date().format("yyyy-MM-dd HH:mm:ss"));
-        setTimeout(updateTime, 1000);
-    }
-    updateTime();
-})
-
-
-function runCommand(path) {
-    // alert("runCommand "+ path);
-    xnote.http.get("/system/command", {path: path}, function(data, status) {
-        alert(data);
-    })
-}
+
+{% import xmanager %}
+{% init sys_plugins = xmanager.find_plugins("system") %}
+<div class="aside-item hide">
+    <div class="aside-title">
+        用户
+    </div>
+    <div class="aside-content">
+        <ul>
+            <li>{{_user_name}}</li>
+            <!--
+            <li>日期: <span class="currentDate"></span></li>
+            <li>时间: <span class="currentTime"></span></li>
+            -->
+            {% if _has_login %}
+                <li><a href="{{_server_home}}/logout">登出</a></li>
+            {% else %}
+                <li><a href="{{_server_home}}/login">登陆</a></li>
+            {% end %}
+        </ul>
+    </div>
+</div>
+
+{% if len(sys_plugins) > 0 %}
+    <div class="aside-item">
+        <div class="aside-title">
+            {{T("Options")}}
+        </div>
+        <div class="aside-content">
+            <ul>
+                {% for p in sys_plugins %}
+                    <li><a href="{{_server_home}}/plugins/{{p.name}}">{{p.title}}</a></li>
+                {% end %}
+            </ul>
+        </div>
+    </div>
+{% end %}
+
+<div class="aside-item">
+    <div class="aside-title">{{T("Time")}}</div>
+    <div class="aside-content">
+        <span class="currentDateTime"></span>
+    </div>
+</div>
+
+<script type="text/javascript">
+$(function () {
+    function updateTime () {
+        $(".currentTime").html(new Date().format("HH:mm:ss"));
+        $(".currentDate").html(new Date().format("yyyy-MM-dd"));
+        $(".currentDateTime").html(new Date().format("yyyy-MM-dd HH:mm:ss"));
+        setTimeout(updateTime, 1000);
+    }
+    updateTime();
+})
+
+
+function runCommand(path) {
+    // alert("runCommand "+ path);
+    xnote.http.get("/system/command", {path: path}, function(data, status) {
+        alert(data);
+    })
+}
 </script>
```

### Comparing `xnote-web-0.1.0/handlers/system/network_profile.py` & `xnote-web-0.1.1/handlers/system/network_profile.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,21 +1,21 @@
-# encoding=utf-8
-# Created by xupingmao on 2017/04/21
-# @modified 2018/11/08 01:33:45
-# 性能测试使用,可以生成指定大小的数据块
-import xutils
-import random
-from xnote.core import xauth
-
-class handler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        # 100M
-        total_size = xutils.get_argument_int("total_size", 100 * 1024 ** 2)
-        size = 0
-        buf_size = 1024
-
-        while size < total_size:
-            buf = random.choice('0123456789') * buf_size
-            size += buf_size
-            yield buf
+# encoding=utf-8
+# Created by xupingmao on 2017/04/21
+# @modified 2018/11/08 01:33:45
+# 性能测试使用,可以生成指定大小的数据块
+import xutils
+import random
+from xnote.core import xauth
+
+class handler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        # 100M
+        total_size = xutils.get_argument_int("total_size", 100 * 1024 ** 2)
+        size = 0
+        buf_size = 1024
+
+        while size < total_size:
+            buf = random.choice('0123456789') * buf_size
+            size += buf_size
+            yield buf
```

### Comparing `xnote-web-0.1.0/handlers/system/page/crontab.html` & `xnote-web-0.1.1/handlers/system/page/crontab.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/crontab_edit.html` & `xnote-web-0.1.1/handlers/system/page/crontab_edit.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/db/db_backup.html` & `xnote-web-0.1.1/handlers/system/page/db/db_backup.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/db/db_index.html` & `xnote-web-0.1.1/handlers/system/page/db/db_index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/db/db_index_v2.html` & `xnote-web-0.1.1/handlers/system/page/db/db_index_v2.html`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,43 +1,43 @@
-{#
-<!--
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-05-14 12:33:09
-@LastEditors  : xupingmao
-@LastEditTime : 2022-05-14 17:18:33
-@FilePath     : /xnote/handlers/system/page/db/db_index.html
-@Description  : 描述
---> #}
-{% extends base %}
-
-{% block body_left %}
-{% include system/component/db_nav.html %}
-{% include system/component/db_kv_nav.html %}
-
-<div class="card">
-
-    <table class="table">
-        <tr>
-            <th>表名</th>
-            <th>索引</th>
-            <th>记录数</th>
-            <th>操作</th>
-        </tr>
-        {% for table_info in table_list %}
-            <tr class="hover-tr">
-                <td><a href="{{table_info.table_url}}">{{table_info.table_name}}</a></td>
-                <td><a href="{{table_info.index_url}}">{{table_info.index_name}}</a></td>
-                <td>{{table_info.index_count}}</td>
-                <td></td>
-            </tr>
-        {% end %}
-    </table>
-</div>
-
-<a href="{{_server_home}}/system/db_index?p=meta&p2=index_v1">查看老版本索引</a>
-
-{% end %}
-
-{% block body_right %}
-    {% include system/component/admin_nav.html %}
+{#
+<!--
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-05-14 12:33:09
+@LastEditors  : xupingmao
+@LastEditTime : 2022-05-14 17:18:33
+@FilePath     : /xnote/handlers/system/page/db/db_index.html
+@Description  : 描述
+--> #}
+{% extends base %}
+
+{% block body_left %}
+{% include system/component/db_nav.html %}
+{% include system/component/db_kv_nav.html %}
+
+<div class="card">
+
+    <table class="table">
+        <tr>
+            <th>表名</th>
+            <th>索引</th>
+            <th>记录数</th>
+            <th>操作</th>
+        </tr>
+        {% for table_info in table_list %}
+            <tr class="hover-tr">
+                <td><a href="{{table_info.table_url}}">{{table_info.table_name}}</a></td>
+                <td><a href="{{table_info.index_url}}">{{table_info.index_name}}</a></td>
+                <td>{{table_info.index_count}}</td>
+                <td></td>
+            </tr>
+        {% end %}
+    </table>
+</div>
+
+<a href="{{_server_home}}/system/db_index?p=meta&p2=index_v1">查看老版本索引</a>
+
+{% end %}
+
+{% block body_right %}
+    {% include system/component/admin_nav.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/system/page/db/db_meta.html` & `xnote-web-0.1.1/handlers/system/page/db/db_meta.html`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,69 +1,69 @@
-{% extends base %}
-
-{% block body_left %}
-<style>
-    .key { width: 75%; }
-    .admin-stat-th { width: 20% }
-</style>
-
-{% include system/component/db_nav.html %}
-{% init show_delete = False %}
-{% include system/component/db_kv_nav.html %}
-
-<div class="card admin-stat">
-    <!-- <div class="card-title"> 
-        <span>元数据</span>
-
-        <div class="float-right">
-            {% if show_delete == False %}
-                <a class="btn btn-default" href="?p=meta&show_delete=true">查看删除的表</a>
-            {% else %}
-                <a class="btn btn-default" href="?p=meta">查看活跃的表</a>
-            {% end %}
-        </div>
-    </div> -->
-    <table class="table">
-        <tr>
-            <th class="admin-stat-th">类别</th>
-            <th class="admin-stat-th">项目</th>
-            <th class="admin-stat-th">说明</th>
-            <th class="admin-stat-th">数量</th>
-            <th class="admin-stat-th">操作</th>
-        </tr>
-        {% for table_info, table_count in admin_stat_list %}
-            <tr class="hover-tr">
-                <td>{{table_info.category}}</td>
-                <td><a href="{{_server_home}}/system/db_scan?prefix={{table_info.name}}&reverse=true">{{table_info.name}}</a></td>
-                <td>{{table_info.description}}</td>
-                <td>{{table_count}}</td>
-                <td>{% if table_info.is_deleted %}<button class="btn danger" data-name="{{table_info.name}}" 
-                    onclick="xnote.action.clearTable(event)">清空</button>{% end %}</td>
-            </tr>
-        {% end %}
-    </table>
-</div>
-
-<script>
-xnote.action.clearTable = function(event) {
-    var tableName = $(event.target).attr("data-name");
-    xnote.confirm("确定要清空表" + tableName + "吗?", function () {
-        var params = {
-            table_name: tableName
-        };
-        xnote.http.post("/system/db/drop_table", params, function (resp) {
-            if (resp.code=="success") {
-                xnote.toast("清空完成");
-                window.location.reload();
-            } else {
-                xnote.toast("清空失败:" + resp.message);
-            }
-        });
-    });
-};
-</script>
-
-{% end %}
-
-{% block body_right %}
-    {% include system/component/admin_nav.html %}
-{% end %}
+{% extends base %}
+
+{% block body_left %}
+<style>
+    .key { width: 75%; }
+    .admin-stat-th { width: 20% }
+</style>
+
+{% include system/component/db_nav.html %}
+{% init show_delete = False %}
+{% include system/component/db_kv_nav.html %}
+
+<div class="card admin-stat">
+    <!-- <div class="card-title"> 
+        <span>元数据</span>
+
+        <div class="float-right">
+            {% if show_delete == False %}
+                <a class="btn btn-default" href="?p=meta&show_delete=true">查看删除的表</a>
+            {% else %}
+                <a class="btn btn-default" href="?p=meta">查看活跃的表</a>
+            {% end %}
+        </div>
+    </div> -->
+    <table class="table">
+        <tr>
+            <th class="admin-stat-th">类别</th>
+            <th class="admin-stat-th">项目</th>
+            <th class="admin-stat-th">说明</th>
+            <th class="admin-stat-th">数量</th>
+            <th class="admin-stat-th">操作</th>
+        </tr>
+        {% for table_info, table_count in admin_stat_list %}
+            <tr class="hover-tr">
+                <td>{{table_info.category}}</td>
+                <td><a href="{{_server_home}}/system/db_scan?prefix={{table_info.name}}&reverse=true">{{table_info.name}}</a></td>
+                <td>{{table_info.description}}</td>
+                <td>{{table_count}}</td>
+                <td>{% if table_info.is_deleted %}<button class="btn danger" data-name="{{table_info.name}}" 
+                    onclick="xnote.action.clearTable(event)">清空</button>{% end %}</td>
+            </tr>
+        {% end %}
+    </table>
+</div>
+
+<script>
+xnote.action.clearTable = function(event) {
+    var tableName = $(event.target).attr("data-name");
+    xnote.confirm("确定要清空表" + tableName + "吗?", function () {
+        var params = {
+            table_name: tableName
+        };
+        xnote.http.post("/system/db/drop_table", params, function (resp) {
+            if (resp.code=="success") {
+                xnote.toast("清空完成");
+                window.location.reload();
+            } else {
+                xnote.toast("清空失败:" + resp.message);
+            }
+        });
+    });
+};
+</script>
+
+{% end %}
+
+{% block body_right %}
+    {% include system/component/admin_nav.html %}
+{% end %}
```

### Comparing `xnote-web-0.1.0/handlers/system/page/db/db_struct.html` & `xnote-web-0.1.1/handlers/system/page/db/db_struct.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/db/driver_info.html` & `xnote-web-0.1.1/handlers/system/page/db/driver_info.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/db/sqldb_detail.html` & `xnote-web-0.1.1/handlers/system/page/db/sqldb_detail.html`

 * *Ordering differences only*

 * *Files 25% similar despite different names*

```diff
@@ -1,41 +1,41 @@
-{% extends base %}
-
-{% block body_left %}
-{% include system/component/db_nav.html %}
-
-<script src="{{_server_home}}/_static/js/admin.js"></script>
-
-{% init kv_table_name = None %}
-
-<div class="card">
-
-    <table class="table">
-        <tr>
-            <th style="width:20%">ID</th>
-            <th style="width:60%">详情</th>
-            <th style="width:20%">操作</th>
-        </tr>
-        {% for row in db_rows %}
-        <tr class="hover-tr">
-            <td>{{row.get(pk_name)}}</td>
-            <td>{{row}}</td>
-            <td>
-                {% if kv_table_name != None %}
-                    <a data-url="/system/sqldb_detail?method=get_kv_detail&key={{kv_table_name}}:{{row.get(pk_name)}}" 
-                        onclick="xnote.admin.viewMainRecord(this)">查看主数据</a>
-                {% end %}
-            </td>
-        </tr>
-        {% end %}
-    </table>
-</div>
-
-<div class="card">
-    {% include common/pagination.html %}
-</div>
-
-{% end %}
-
-{% block body_right %}
-    {% include system/component/admin_nav.html %}
+{% extends base %}
+
+{% block body_left %}
+{% include system/component/db_nav.html %}
+
+<script src="{{_server_home}}/_static/js/admin.js"></script>
+
+{% init kv_table_name = None %}
+
+<div class="card">
+
+    <table class="table">
+        <tr>
+            <th style="width:20%">ID</th>
+            <th style="width:60%">详情</th>
+            <th style="width:20%">操作</th>
+        </tr>
+        {% for row in db_rows %}
+        <tr class="hover-tr">
+            <td>{{row.get(pk_name)}}</td>
+            <td>{{row}}</td>
+            <td>
+                {% if kv_table_name != None %}
+                    <a data-url="/system/sqldb_detail?method=get_kv_detail&key={{kv_table_name}}:{{row.get(pk_name)}}" 
+                        onclick="xnote.admin.viewMainRecord(this)">查看主数据</a>
+                {% end %}
+            </td>
+        </tr>
+        {% end %}
+    </table>
+</div>
+
+<div class="card">
+    {% include common/pagination.html %}
+</div>
+
+{% end %}
+
+{% block body_right %}
+    {% include system/component/admin_nav.html %}
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/system/page/develop/index.html` & `xnote-web-0.1.1/handlers/system/page/develop/index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/history.html` & `xnote-web-0.1.1/handlers/system/page/history.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/module_list.html` & `xnote-web-0.1.1/handlers/system/page/module_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/script.html` & `xnote-web-0.1.1/handlers/system/page/script.html`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,180 +1,180 @@
-{% extends base.html %}
-
-{% block head %}
-
-<link rel="stylesheet" href="{{_server_home}}/static/lib/codemirror/codemirror.min.css">
-<link rel="stylesheet" type="text/css" href="{{_server_home}}/static/lib/codemirror/theme/monokai.min.css">
-<script type="text/javascript" src="/static/lib/codemirror/codemirror.min.js"></script>
-<script type="text/javascript" src="/static/lib/codemirror/mode/clike/clike.js"></script>
-<script type="text/javascript" src="/static/lib/codemirror/mode/shell.js"></script>
-<script type="text/javascript" src="/static/lib/codemirror/mode/python.js"></script>
-<script type="text/javascript" src="/static/lib/codemirror/keymap/sublime.js"></script>
-<script type="text/javascript" src="/static/js/editor.js"></script>
-
-<style type="text/css">
-    .CodeMirror {
-        border: 1px solid #ccc;
-    }
-
-    #result {
-        border: 1px solid #ccc;
-        padding: 4px;
-        background-color: #eee;
-        box-sizing: border-box;
-    }
-    #scriptName {
-        width: 200px;
-    }
-    #resultDiv {
-        display: none;
-    }
-
-    tr:hover td {
-        background: none;
-    }
-
-    tr:hover {
-        background-color: #eee;
-    }
-
-    .option-td {
-        width: 120px;
-    }
-</style>
-
-{% end %}
-
-{% block body %}
-
-{% init error = "" %}
-{% init shell_list = [] %}
-{% set  index = 1 %}
-{% init op = "list" %}
-
-{% if error != "" and error != None %}
-<div class="col-md-12 error">{{error}}</div>
-{% end %}
-
-{% if op != "edit" %}
-    <div class="card">
-        <div class="card-title">
-            <span>脚本管理</span>
-            <div class="float-right">
-                <form action="/system/script/search" method="GET">
-                    <input type="button" value="添加" id="addBtn"/>
-                </form>
-            </div>
-        </div>
-    </div>
-{% end %}
-
-{% if op == "edit" %}
-    <div class="card">
-        <!-- <h3>{{name}}</h3> -->
-        {% set title = name %}
-        {% include "tools/base_title.html" %}
-        {# 编辑 #}
-        <form method="POST" action="/system/script_admin/save">
-            <div id="editorArea" class="col-md-12">
-                <input type="text" name="name" value="{{name}}" class="hide">
-                <textarea id="editor" class="col-md-12" name="content" rows=10>{{content}}</textarea>
-            </div>
-            <div class="col-md-12">
-                <input type="submit" id="save" class="btn" value="保存"/>
-                <input type="button" id="rename" class="btn renameScript" value="重命名"/>
-                <input type="button" scriptName="{{name}}" class="executeScript btn" value="执行"/>
-            </div>
-        </form>
-
-        <div id="resultDiv" class="col-md-12">
-            <div class="output-title">结果</div>
-            <pre id="result" class="output-body col-md-12">
-            </pre>
-        </div>
-    </div>
-
-    <script>
-        $(function () {
-            initCodeMirror("#editor", {
-                filename: $("input[name=name]").val()
-            })
-        });
-    </script>
-
-{% else %}
-    {% comment 列表 %}
-    <div class="card">
-        <table class="table col-md-12 top-offset-1">
-            {% for index, script in enumerate(shell_list) %}
-                <tr>
-                    <td class="index-td">{{index+1}}</td>
-                    <td>
-                        <a href="{{_server_home}}/system/script/edit?name={{script}}">{{script}}</a>
-                    </td>
-                    <td class="option-td">
-                        <input type="button" value="删除" class="deleteScript btn btn-danger" scriptName="{{script}}"/>
-                        <input type="button" value="执行" class="executeScript btn" scriptName="{{script}}"/> 
-                    </td>
-                </tr>
-            {% end %}
-        </table>
-    </div>
-{% end %}
-
-<script type="text/javascript">
-    $(".executeScript").on("click", function(event) {
-        var scriptName = $(event.target).attr("scriptName")
-        var content = $("[name=content]").val();
-        var path = getUrlParams().path;
-        // console.log(event);
-        // console.log($(event.target).attr("scriptName"))
-        $.post("/system/script_admin/execute?name=" + scriptName, 
-            {   
-                content: content, 
-                path: path
-            } ,
-            function (responseText) {
-                var data = responseText;
-                $("#resultDiv").show();
-                $("#result").show().text(data.data);
-            });
-    })
-
-    $(".deleteScript").on("click", function(event) {
-        var scriptName = $(event.target).attr("scriptName")
-        var check = confirm("确认删除 " + scriptName + " ?")
-        if (check) {        
-            $.post("/system/script_admin/delete?name=" + scriptName, function (data) {
-                location.reload();
-            });
-        }
-    });
-
-    $(".renameScript").click(function (event) {
-        var scriptName = $("input[name=name]").val();
-        var newName = prompt("重命名为", scriptName);
-        if (newName && newName != scriptName) {
-            $.post("/system/script/rename?oldname="+scriptName+"&newname="+newName, function (data) {
-                var code = data.code;
-                if (code != "success") {
-                    alert(data.message);
-                } else {
-                    window.location.href = "/system/script/edit?name=" + newName;
-                }
-            })
-        }
-    })
-
-    $("#addBtn").click(function () {
-        // var name = $("#scriptName").val();
-        var name = prompt("脚本名称");
-        if (name) {        
-            xnote.http.get("/system/script_admin?op=add&name=" + name, function () {
-                location.reload();
-            });
-        }
-    })
-</script>
-
-{% end %}
-
+{% extends base.html %}
+
+{% block head %}
+
+<link rel="stylesheet" href="{{_server_home}}/static/lib/codemirror/codemirror.min.css">
+<link rel="stylesheet" type="text/css" href="{{_server_home}}/static/lib/codemirror/theme/monokai.min.css">
+<script type="text/javascript" src="/static/lib/codemirror/codemirror.min.js"></script>
+<script type="text/javascript" src="/static/lib/codemirror/mode/clike/clike.js"></script>
+<script type="text/javascript" src="/static/lib/codemirror/mode/shell.js"></script>
+<script type="text/javascript" src="/static/lib/codemirror/mode/python.js"></script>
+<script type="text/javascript" src="/static/lib/codemirror/keymap/sublime.js"></script>
+<script type="text/javascript" src="/static/js/editor.js"></script>
+
+<style type="text/css">
+    .CodeMirror {
+        border: 1px solid #ccc;
+    }
+
+    #result {
+        border: 1px solid #ccc;
+        padding: 4px;
+        background-color: #eee;
+        box-sizing: border-box;
+    }
+    #scriptName {
+        width: 200px;
+    }
+    #resultDiv {
+        display: none;
+    }
+
+    tr:hover td {
+        background: none;
+    }
+
+    tr:hover {
+        background-color: #eee;
+    }
+
+    .option-td {
+        width: 120px;
+    }
+</style>
+
+{% end %}
+
+{% block body %}
+
+{% init error = "" %}
+{% init shell_list = [] %}
+{% set  index = 1 %}
+{% init op = "list" %}
+
+{% if error != "" and error != None %}
+<div class="col-md-12 error">{{error}}</div>
+{% end %}
+
+{% if op != "edit" %}
+    <div class="card">
+        <div class="card-title">
+            <span>脚本管理</span>
+            <div class="float-right">
+                <form action="/system/script/search" method="GET">
+                    <input type="button" value="添加" id="addBtn"/>
+                </form>
+            </div>
+        </div>
+    </div>
+{% end %}
+
+{% if op == "edit" %}
+    <div class="card">
+        <!-- <h3>{{name}}</h3> -->
+        {% set title = name %}
+        {% include "tools/base_title.html" %}
+        {# 编辑 #}
+        <form method="POST" action="/system/script_admin/save">
+            <div id="editorArea" class="col-md-12">
+                <input type="text" name="name" value="{{name}}" class="hide">
+                <textarea id="editor" class="col-md-12" name="content" rows=10>{{content}}</textarea>
+            </div>
+            <div class="col-md-12">
+                <input type="submit" id="save" class="btn" value="保存"/>
+                <input type="button" id="rename" class="btn renameScript" value="重命名"/>
+                <input type="button" scriptName="{{name}}" class="executeScript btn" value="执行"/>
+            </div>
+        </form>
+
+        <div id="resultDiv" class="col-md-12">
+            <div class="output-title">结果</div>
+            <pre id="result" class="output-body col-md-12">
+            </pre>
+        </div>
+    </div>
+
+    <script>
+        $(function () {
+            initCodeMirror("#editor", {
+                filename: $("input[name=name]").val()
+            })
+        });
+    </script>
+
+{% else %}
+    {% comment 列表 %}
+    <div class="card">
+        <table class="table col-md-12 top-offset-1">
+            {% for index, script in enumerate(shell_list) %}
+                <tr>
+                    <td class="index-td">{{index+1}}</td>
+                    <td>
+                        <a href="{{_server_home}}/system/script/edit?name={{script}}">{{script}}</a>
+                    </td>
+                    <td class="option-td">
+                        <input type="button" value="删除" class="deleteScript btn btn-danger" scriptName="{{script}}"/>
+                        <input type="button" value="执行" class="executeScript btn" scriptName="{{script}}"/> 
+                    </td>
+                </tr>
+            {% end %}
+        </table>
+    </div>
+{% end %}
+
+<script type="text/javascript">
+    $(".executeScript").on("click", function(event) {
+        var scriptName = $(event.target).attr("scriptName")
+        var content = $("[name=content]").val();
+        var path = getUrlParams().path;
+        // console.log(event);
+        // console.log($(event.target).attr("scriptName"))
+        $.post("/system/script_admin/execute?name=" + scriptName, 
+            {   
+                content: content, 
+                path: path
+            } ,
+            function (responseText) {
+                var data = responseText;
+                $("#resultDiv").show();
+                $("#result").show().text(data.data);
+            });
+    })
+
+    $(".deleteScript").on("click", function(event) {
+        var scriptName = $(event.target).attr("scriptName")
+        var check = confirm("确认删除 " + scriptName + " ?")
+        if (check) {        
+            $.post("/system/script_admin/delete?name=" + scriptName, function (data) {
+                location.reload();
+            });
+        }
+    });
+
+    $(".renameScript").click(function (event) {
+        var scriptName = $("input[name=name]").val();
+        var newName = prompt("重命名为", scriptName);
+        if (newName && newName != scriptName) {
+            $.post("/system/script/rename?oldname="+scriptName+"&newname="+newName, function (data) {
+                var code = data.code;
+                if (code != "success") {
+                    alert(data.message);
+                } else {
+                    window.location.href = "/system/script/edit?name=" + newName;
+                }
+            })
+        }
+    })
+
+    $("#addBtn").click(function () {
+        // var name = $("#scriptName").val();
+        var name = prompt("脚本名称");
+        if (name) {        
+            xnote.http.get("/system/script_admin?op=add&name=" + name, function () {
+                location.reload();
+            });
+        }
+    })
+</script>
+
+{% end %}
+
```

### Comparing `xnote-web-0.1.0/handlers/system/page/sqlite.html` & `xnote-web-0.1.1/handlers/system/page/sqlite.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/system_admin.html` & `xnote-web-0.1.1/handlers/system/page/system_admin.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/system_index.html` & `xnote-web-0.1.1/handlers/system/page/system_index.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/system_info.html` & `xnote-web-0.1.1/handlers/system/page/system_info.html`

 * *Files 16% similar despite different names*

```diff
@@ -33,15 +33,22 @@
             </div>
         </div>
     {% end %}
 
     <div class="settings-row btn-line-height">
         <div class="settings-key">重启应用</div>
         <div class="settings-value">
-            <button class="btn btn-default danger2 restart-btn">重启</button>
+            <button class="btn btn-default danger2" onclick="xnote.tmp.restart()">重启</button>
+        </div>
+    </div>
+
+    <div class="settings-row btn-line-height">
+        <div class="settings-key">升级系统</div>
+        <div class="settings-value">
+            <button class="btn btn-default danger2" onclick="xnote.tmp.upgrade()">升级</button>
         </div>
     </div>
 </div>
 
 <script type="text/javascript">
 $(function () {
     var checkInterval = 500;
@@ -64,16 +71,32 @@
         loadingIndex = layer.load(1);
         xnote.http.post("/system/reload?runtime_id={{runtime_id}}", function (resp) {
             console.log(resp);
             setTimeout(checkSystemStatus, checkInterval)
         })
     }
 
-    $(".restart-btn").click(function (e) {
+    xnote.tmp.restart = function () {
         xnote.confirm("确定重启吗?", function () {
             doRestart();
         })
-    })
+    };
+
+    xnote.tmp.doUpgrade = function() {
+        xnote.http.post("/system/pull_code", function (resp) {
+            if (resp.success) {
+                doRestart();
+            } else {
+                xnote.alert(resp.message);
+            }
+        })
+    }
+
+    xnote.tmp.upgrade = function() {
+        xnote.confirm("确定升级系统吗?", function () {
+            xnote.tmp.doUpgrade();
+        })
+    }
 })
 </script>
 
 {% end %}
```

### Comparing `xnote-web-0.1.0/handlers/system/page/system_info_text.html` & `xnote-web-0.1.1/handlers/system/page/system_info_text.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/system_sync.html` & `xnote-web-0.1.1/handlers/system/page/system_sync.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/template_cache.html` & `xnote-web-0.1.1/handlers/system/page/template_cache.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/page/thread_info.html` & `xnote-web-0.1.1/handlers/system/page/thread_info.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/script.py` & `xnote-web-0.1.1/handlers/system/script.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/stats.py` & `xnote-web-0.1.1/handlers/system/stats.py`

 * *Ordering differences only*

 * *Files 20% similar despite different names*

```diff
@@ -1,106 +1,106 @@
-# encoding=utf-8
-# Created by xupingmao on 2017/06/23
-# Last Modified on 2018/01/18
-import time
-import web
-import xauth
-import xtables
-import xutils
-import xconfig
-from xutils import dbutil
-
-dbutil.register_table("record", "系统日志表")
-_db = dbutil.get_table("record")
-
-def save_ip(real_ip):
-    if real_ip is not None:
-        # 处理X-Forwarded-For
-        real_ip = real_ip.split(",")[0]
-        # 跳过内网
-        # A类和C类
-        if real_ip.startswith("10.") or real_ip.startswith("192.168") or real_ip == "127.0.0.1":
-            return
-        db = xtables.get_record_table()
-        record = db.select_first(where=dict(type="ip", key=real_ip, cdate=xutils.format_date()))
-        if record is None:
-            db.insert(type="ip", key=real_ip, cdate=xutils.format_date(), 
-                ctime=xutils.format_datetime(), value="1")
-        else:
-            db.update(value=int(record.value)+1, where=dict(id=record.id))
-
-SCRIPT = """
-if (navigator.geolocation && window.xuser != "") {
-    navigator.geolocation.getCurrentPosition(function (pos) {
-        console.log(pos);
-        if (pos && pos.coords) {
-            // JSON.stringify 无效
-            var latitude = pos.coords.latitude;
-            var longitude = pos.coords.longitude;
-            var accuracy = pos.coords.accuracy;
-
-            var coords = {
-                latitude: latitude, 
-                longitude:longitude, 
-                accuracy: accuracy,
-                heading: pos.coords.heading,
-                speed: pos.coords.speed,
-                altitude: pos.coords.altitude,
-                altitudeAccuracy: pos.coords.altitudeAccuracy
-            };
-            $.post("/system/stats/location", {coords: JSON.stringify(coords)});
-        }
-    });
-}
-
-"""
-
-class handler:
-
-    def GET(self):
-        # X-Forwarded-For是RFC 7239（Forwarded HTTP Extension）定义的扩展首部，大部分代理支持
-        # 格式如下：
-        # X-Forwarded-For: client, proxy1, proxy2
-        # 而X-Real-IP目前不属于任何标准
-        # See https://imququ.com/post/x-forwarded-for-header-in-http.html
-        # save_ip(web.ctx.env.get("HTTP_X_FORWARDED_FOR"))
-        # save_ip(web.ctx.env.get("REMOTE_ADDR"))
-        
-        # web.header("Cache-Control", "max-age=600")
-        environ = web.ctx.environ
-        content = "/* empty */"
-
-        web.header("Content-Type", "application/javascript")
-        client_etag = environ.get('HTTP_IF_NONE_MATCH')
-
-        if client_etag == None or client_etag == "":
-            client_etag_val = 0
-        else:
-            client_etag_val = float(client_etag)
-
-        if time.time() - client_etag_val > 600:
-            # 采集数据时间区间
-            save_ip(web.ctx.env.get("HTTP_X_FORWARDED_FOR"))
-            save_ip(web.ctx.env.get("REMOTE_ADDR"))
-            if xconfig.WebConfig.record_location:
-                content = SCRIPT
-
-        if not xauth.is_admin():
-            content = "/* empty */"
-        web.header("Etag", time.time())
-        return content
-
-class LocationHandler:
-
-    def POST(self):
-        coords = xutils.get_argument("coords")
-        if coords != "null":
-            data = dict(type="location", key=xauth.get_current_name(), cdate=xutils.format_date(), 
-                ctime=xutils.format_datetime(), value=coords)
-            _db.insert(data)
-        return "{}"
-
-
-xurls = (
-    r"/system/stats", handler,
-    r"/system/stats/location", LocationHandler
+# encoding=utf-8
+# Created by xupingmao on 2017/06/23
+# Last Modified on 2018/01/18
+import time
+import web
+import xauth
+import xtables
+import xutils
+import xconfig
+from xutils import dbutil
+
+dbutil.register_table("record", "系统日志表")
+_db = dbutil.get_table("record")
+
+def save_ip(real_ip):
+    if real_ip is not None:
+        # 处理X-Forwarded-For
+        real_ip = real_ip.split(",")[0]
+        # 跳过内网
+        # A类和C类
+        if real_ip.startswith("10.") or real_ip.startswith("192.168") or real_ip == "127.0.0.1":
+            return
+        db = xtables.get_record_table()
+        record = db.select_first(where=dict(type="ip", key=real_ip, cdate=xutils.format_date()))
+        if record is None:
+            db.insert(type="ip", key=real_ip, cdate=xutils.format_date(), 
+                ctime=xutils.format_datetime(), value="1")
+        else:
+            db.update(value=int(record.value)+1, where=dict(id=record.id))
+
+SCRIPT = """
+if (navigator.geolocation && window.xuser != "") {
+    navigator.geolocation.getCurrentPosition(function (pos) {
+        console.log(pos);
+        if (pos && pos.coords) {
+            // JSON.stringify 无效
+            var latitude = pos.coords.latitude;
+            var longitude = pos.coords.longitude;
+            var accuracy = pos.coords.accuracy;
+
+            var coords = {
+                latitude: latitude, 
+                longitude:longitude, 
+                accuracy: accuracy,
+                heading: pos.coords.heading,
+                speed: pos.coords.speed,
+                altitude: pos.coords.altitude,
+                altitudeAccuracy: pos.coords.altitudeAccuracy
+            };
+            $.post("/system/stats/location", {coords: JSON.stringify(coords)});
+        }
+    });
+}
+
+"""
+
+class handler:
+
+    def GET(self):
+        # X-Forwarded-For是RFC 7239（Forwarded HTTP Extension）定义的扩展首部，大部分代理支持
+        # 格式如下：
+        # X-Forwarded-For: client, proxy1, proxy2
+        # 而X-Real-IP目前不属于任何标准
+        # See https://imququ.com/post/x-forwarded-for-header-in-http.html
+        # save_ip(web.ctx.env.get("HTTP_X_FORWARDED_FOR"))
+        # save_ip(web.ctx.env.get("REMOTE_ADDR"))
+        
+        # web.header("Cache-Control", "max-age=600")
+        environ = web.ctx.environ
+        content = "/* empty */"
+
+        web.header("Content-Type", "application/javascript")
+        client_etag = environ.get('HTTP_IF_NONE_MATCH')
+
+        if client_etag == None or client_etag == "":
+            client_etag_val = 0
+        else:
+            client_etag_val = float(client_etag)
+
+        if time.time() - client_etag_val > 600:
+            # 采集数据时间区间
+            save_ip(web.ctx.env.get("HTTP_X_FORWARDED_FOR"))
+            save_ip(web.ctx.env.get("REMOTE_ADDR"))
+            if xconfig.WebConfig.record_location:
+                content = SCRIPT
+
+        if not xauth.is_admin():
+            content = "/* empty */"
+        web.header("Etag", time.time())
+        return content
+
+class LocationHandler:
+
+    def POST(self):
+        coords = xutils.get_argument("coords")
+        if coords != "null":
+            data = dict(type="location", key=xauth.get_current_name(), cdate=xutils.format_date(), 
+                ctime=xutils.format_datetime(), value=coords)
+            _db.insert(data)
+        return "{}"
+
+
+xurls = (
+    r"/system/stats", handler,
+    r"/system/stats/location", LocationHandler
 )
```

### Comparing `xnote-web-0.1.0/handlers/system/system.py` & `xnote-web-0.1.1/handlers/system/system.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,264 +1,289 @@
-# -*- coding:utf-8 -*-
-# Created by xupingmao on 2016/10
-# @modified 2022/02/26 11:27:37
-"""System functions"""
-import os
-from xnote.core import xconfig
-from xnote.core import xtemplate
-import xutils
-from xnote.core import xauth
-from xnote.core import xmanager
-import web
-from xutils import Storage
-from xutils import webutil
-
-
-class AppLink:
-    def __init__(self):
-        self.name = ""
-        self.url = ""
-        self.user = ""
-        self.is_admin = False
-        self.is_user = False
-        self.is_guest = False
-        self.is_public = False
-        self.icon = None  # type: str|None
-        self.img_src = None
-
-    def build(self):
-        self.url = xconfig.WebConfig.server_home + self.url
-        if self.img_src != None:
-            self.img_src = xconfig.WebConfig.server_home + self.img_src
-
-
-def link(name, url, user="", icon="cube"):
-    result = AppLink()
-    result.name = name
-    result.url = url
-    result.user = user
-    result.icon = icon
-    result.build()
-    return result
-
-
-def admin_link(name, url, icon="cube"):
-    link = AppLink()
-    link.name = name
-    link.url = url
-    link.icon = icon
-    link.is_admin = True
-    link.user = "admin"
-    link.build()
-    return link
-
-
-def user_link(name, url, icon="cube", img_src=None):
-    link = AppLink()
-    link.name = name
-    link.url = url
-    link.icon = icon
-    link.img_src = img_src
-    link.is_user = True
-    link.build()
-    return link
-
-
-def guest_link(name, url, icon="cube"):
-    link = AppLink()
-    link.name = name
-    link.url = url
-    link.icon = icon
-    link.is_guest = True
-    link.build()
-    return link
-
-
-def public_link(name, url, icon="cube"):
-    link = AppLink()
-    link.name = name
-    link.url = url
-    link.icon = icon
-    link.is_public = True
-    link.build()
-    return link
-
-def about_link():
-    link = AppLink()
-    link.name = "关于"
-    link.url = xconfig.WebConfig.about_url
-    link.icon = "info-circle"
-    link.is_public = True
-    return link
-
-
-SYS_TOOLS = [
-    user_link("设置",   "/system/settings", "cog"),
-    guest_link("登录", "/login", "sign-in"),
-
-    admin_link("系统信息",   "/system/info", "info-circle"),
-    admin_link("文件",       "/fs_list", "file-text-o"),
-    admin_link("定时任务",   "/system/crontab", "clock-o"),
-    admin_link("任务实例", "/admin/jobs"),
-    admin_link("事件注册", "/system/event"),
-    admin_link("线程管理", "/system/thread_info"),
-    admin_link("Menu_User",   "/system/user/list", "users"),
-    admin_link("Menu_Log",    "/system/log"),
-    admin_link("Menu_Modules",  "/system/modules_info"),
-    admin_link("Shell",    "/tools/shell", "terminal"),
-    admin_link("集群管理", "/system/sync?p=home", "server"),
-    admin_link("开发者", "/system/develop"),
-
-    user_link("Menu_Plugin",   "/plugin_category_list?category=index&show_back=true", "cogs"),
-    # 关于链接，支持外链
-    about_link(),
-]
-
-NOTE_TOOLS = [
-    user_link("笔记本", "/note/group", "book"),
-    user_link("待办",  "/message?tag=task", "calendar-check-o"),
-    user_link("随手记",  "/message?tag=log", "pencil"),
-    user_link("标签列表", "/note/taglist", "tags"),
-
-    # 笔记
-    user_link("最近更新", "/note/recent?orderby=update", "edit"),
-    user_link("最近创建", "/note/recent?orderby=create", "plus"),
-    user_link("最近查看", "/note/recent?orderby=view", "eye"),
-    user_link("常用笔记", "/note/recent?orderby=myhot", "star-o"),
-    user_link("时光轴", "/note/timeline?type=all"),
-    user_link("词典", "/note/dict", img_src="/static/image/icon_dict.svg"),
-    user_link("搜索历史", "/search", "search"),
-    user_link("上传管理", "/fs_upload", "upload"),
-    user_link("数据统计", "/note/stat", "bar-chart"),
-    user_link("月度计划", "/plan/month", "calendar"),
-]
-
-DATA_TOOLS = [
-    admin_link("数据库", "/system/sqldb_admin?p=sqldb", "database"),
-    admin_link("缓存管理", "/system/cache", "database"),
-    # admin_link("消息队列", "/system/todo", "database"),
-]
-
-# 所有功能配置
-xconfig.MENU_LIST = [
-    Storage(name="Note", children=NOTE_TOOLS, need_login=True),
-    Storage(name="System", children=SYS_TOOLS, need_login=True),
-    Storage(name="数据管理", children=DATA_TOOLS, need_login=True),
-    # TODO 增加一栏自定义的插件
-]
-
-xconfig.NOTE_OPTIONS = [
-    link("New_Note", "/note/add"),
-    link("Recent Updated", "/note/recent_edit"),
-    link("Recent Created", "/note/recent_created"),
-    link("Recent View",  "/note/recent_viewed"),
-    link("Public",   "/note/public"),
-    link("Tag List", "/note/taglist"),
-]
-
-
-class IndexHandler:
-
-    def GET(self):
-        arg_show_back = xutils.get_argument_bool("show_back")
-        arg_show_menu = xutils.get_argument_bool("show_menu", default_value=True)
-        user_name = xauth.current_name()
-        menu_list = []
-
-        def filter_link_func(link):
-            if link.is_guest:
-                return user_name is None
-            if link.is_user:
-                return user_name != None
-            if link.user == "" or link.user == None:
-                return True
-            return link.user == user_name
-
-        for category in xconfig.MENU_LIST:
-            children = category.children
-            if len(children) == 0:
-                continue
-            children = list(filter(filter_link_func, children))
-            menu_list.append(Storage(name=category.name, children=children))
-
-        kw = Storage()
-        kw.Storage = Storage
-        kw.user = xauth.get_current_user()
-        kw.menu_list = menu_list
-        kw.html_title = "系统"
-        kw.show_back = arg_show_back
-        kw.show_menu = arg_show_menu
-
-        return xtemplate.render("system/page/system_index.html", **kw)
-
-
-class AdminHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        if webutil.is_desktop_client():
-            raise web.found("/system/info")
-        return xtemplate.render("system/page/system_admin.html")
-
-
-class ReloadHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        # autoreload will load new handlers
-        import web
-
-        runtime_id = xutils.get_argument_str("runtime_id")
-        if runtime_id == xconfig.RUNTIME_ID:
-            # autoreload.reload()
-            xmanager.restart()
-            raise web.seeother("/system/index")
-        else:
-            return dict(code="success", status="running")
-
-    def POST(self):
-        return self.GET()
-
-
-class UserCssHandler:
-
-    def GET(self):
-        web.header("Content-Type", "text/css")
-        environ = web.ctx.environ
-        path = os.path.join(xconfig.SCRIPTS_DIR, "user.css")
-        web.header("Cache-Control", "max-age=3600")
-
-        if not os.path.exists(path):
-            return b''
-
-        etag = '"%s"' % os.path.getmtime(path)
-        client_etag = environ.get('HTTP_IF_NONE_MATCH')
-        web.header("Etag", etag)
-        if etag == client_etag:
-            web.ctx.status = "304 Not Modified"
-            return b''  # 其实webpy已经通过yield空bytes来避免None
-        return xutils.readfile(path)
-        # return xconfig.get("USER_CSS", "")
-
-
-class UserJsHandler:
-
-    def GET(self):
-        web.header("Content-Type", "application/javascript")
-        web.header("Cache-Control", "max-age=3600")
-        path = os.path.join(xconfig.SCRIPTS_DIR, "user.js")
-        if not os.path.exists(path):
-            return ""
-        return xutils.readfile(path)
-
-
-xutils.register_func("url:/system/index", IndexHandler)
-
-xurls = (
-    r"/system/sys",   IndexHandler,
-    r"/system/index", IndexHandler,
-    r"/system/admin", AdminHandler,
-    r"/system/system", IndexHandler,
-    r"/system/reload", ReloadHandler,
-    r"/system/user\.css", UserCssHandler,
-    r"/system/user\.js", UserJsHandler,
-)
+# -*- coding:utf-8 -*-
+# Created by xupingmao on 2016/10
+# @modified 2022/02/26 11:27:37
+"""System functions"""
+import os
+from xnote.core import xconfig
+from xnote.core import xtemplate
+import xutils
+from xnote.core import xauth
+from xnote.core import xmanager
+import web
+from xutils import Storage
+from xutils import webutil
+import subprocess
+
+class AppLink:
+    def __init__(self):
+        self.name = ""
+        self.url = ""
+        self.user = ""
+        self.is_admin = False
+        self.is_user = False
+        self.is_guest = False
+        self.is_public = False
+        self.icon = None  # type: str|None
+        self.img_src = None
+
+    def build(self):
+        self.url = xconfig.WebConfig.server_home + self.url
+        if self.img_src != None:
+            self.img_src = xconfig.WebConfig.server_home + self.img_src
+
+
+def link(name, url, user="", icon="cube"):
+    result = AppLink()
+    result.name = name
+    result.url = url
+    result.user = user
+    result.icon = icon
+    result.build()
+    return result
+
+
+def admin_link(name, url, icon="cube"):
+    link = AppLink()
+    link.name = name
+    link.url = url
+    link.icon = icon
+    link.is_admin = True
+    link.user = "admin"
+    link.build()
+    return link
+
+
+def user_link(name, url, icon="cube", img_src=None):
+    link = AppLink()
+    link.name = name
+    link.url = url
+    link.icon = icon
+    link.img_src = img_src
+    link.is_user = True
+    link.build()
+    return link
+
+
+def guest_link(name, url, icon="cube"):
+    link = AppLink()
+    link.name = name
+    link.url = url
+    link.icon = icon
+    link.is_guest = True
+    link.build()
+    return link
+
+
+def public_link(name, url, icon="cube"):
+    link = AppLink()
+    link.name = name
+    link.url = url
+    link.icon = icon
+    link.is_public = True
+    link.build()
+    return link
+
+def about_link():
+    link = AppLink()
+    link.name = "关于"
+    link.url = xconfig.WebConfig.about_url
+    link.icon = "info-circle"
+    link.is_public = True
+    return link
+
+
+SYS_TOOLS = [
+    user_link("设置",   "/system/settings", "cog"),
+    guest_link("登录", "/login", "sign-in"),
+
+    admin_link("系统信息",   "/system/info", "info-circle"),
+    admin_link("文件",       "/fs_list", "file-text-o"),
+    admin_link("定时任务",   "/system/crontab", "clock-o"),
+    admin_link("任务实例", "/admin/jobs"),
+    admin_link("事件注册", "/system/event"),
+    admin_link("线程管理", "/system/thread_info"),
+    admin_link("Menu_User",   "/system/user/list", "users"),
+    admin_link("Menu_Log",    "/system/log"),
+    admin_link("Menu_Modules",  "/system/modules_info"),
+    admin_link("Shell",    "/tools/shell", "terminal"),
+    admin_link("集群管理", "/system/sync?p=home", "server"),
+    admin_link("开发者", "/system/develop"),
+
+    user_link("Menu_Plugin",   "/plugin_category_list?category=index&show_back=true", "cogs"),
+    # 关于链接，支持外链
+    about_link(),
+]
+
+NOTE_TOOLS = [
+    user_link("笔记本", "/note/group", "book"),
+    user_link("待办",  "/message?tag=task", "calendar-check-o"),
+    user_link("随手记",  "/message?tag=log", "pencil"),
+    user_link("标签列表", "/note/taglist", "tags"),
+
+    # 笔记
+    user_link("最近更新", "/note/recent?orderby=update", "edit"),
+    user_link("最近创建", "/note/recent?orderby=create", "plus"),
+    user_link("最近查看", "/note/recent?orderby=view", "eye"),
+    user_link("常用笔记", "/note/recent?orderby=myhot", "star-o"),
+    user_link("时光轴", "/note/timeline?type=all"),
+    user_link("词典", "/note/dict", img_src="/static/image/icon_dict.svg"),
+    user_link("搜索历史", "/search", "search"),
+    user_link("上传管理", "/fs_upload", "upload"),
+    user_link("数据统计", "/note/stat", "bar-chart"),
+    user_link("月度计划", "/plan/month", "calendar"),
+]
+
+DATA_TOOLS = [
+    admin_link("数据库", "/system/sqldb_admin?p=sqldb", "database"),
+    admin_link("缓存管理", "/system/cache", "database"),
+    # admin_link("消息队列", "/system/todo", "database"),
+]
+
+# 所有功能配置
+xconfig.MENU_LIST = [
+    Storage(name="Note", children=NOTE_TOOLS, need_login=True),
+    Storage(name="System", children=SYS_TOOLS, need_login=True),
+    Storage(name="数据管理", children=DATA_TOOLS, need_login=True),
+    # TODO 增加一栏自定义的插件
+]
+
+xconfig.NOTE_OPTIONS = [
+    link("New_Note", "/note/add"),
+    link("Recent Updated", "/note/recent_edit"),
+    link("Recent Created", "/note/recent_created"),
+    link("Recent View",  "/note/recent_viewed"),
+    link("Public",   "/note/public"),
+    link("Tag List", "/note/taglist"),
+]
+
+
+class IndexHandler:
+
+    def GET(self):
+        arg_show_back = xutils.get_argument_bool("show_back")
+        arg_show_menu = xutils.get_argument_bool("show_menu", default_value=True)
+        user_name = xauth.current_name()
+        menu_list = []
+
+        def filter_link_func(link):
+            if link.is_guest:
+                return user_name is None
+            if link.is_user:
+                return user_name != None
+            if link.user == "" or link.user == None:
+                return True
+            return link.user == user_name
+
+        for category in xconfig.MENU_LIST:
+            children = category.children
+            if len(children) == 0:
+                continue
+            children = list(filter(filter_link_func, children))
+            menu_list.append(Storage(name=category.name, children=children))
+
+        kw = Storage()
+        kw.Storage = Storage
+        kw.user = xauth.get_current_user()
+        kw.menu_list = menu_list
+        kw.html_title = "系统"
+        kw.show_back = arg_show_back
+        kw.show_menu = arg_show_menu
+
+        return xtemplate.render("system/page/system_index.html", **kw)
+
+
+class AdminHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        if webutil.is_desktop_client():
+            raise web.found("/system/info")
+        return xtemplate.render("system/page/system_admin.html")
+
+
+class ReloadHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        # autoreload will load new handlers
+        import web
+
+        runtime_id = xutils.get_argument_str("runtime_id")
+        if runtime_id == xconfig.RUNTIME_ID:
+            # autoreload.reload()
+            xmanager.restart()
+            raise web.seeother("/system/index")
+        else:
+            return dict(code="success", status="running")
+
+    def POST(self):
+        return self.GET()
+
+
+class PullCodeHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        check_git = os.system("git --version")
+        if check_git != 0:
+            return webutil.FailedResult(code="400", message="系统没有安装git,无法升级")
+        
+        process = subprocess.Popen("git pull", shell=True, 
+                                 stdout=subprocess.PIPE, 
+                                 stderr=subprocess.PIPE)
+        if process.returncode not in (0, None):
+            err_msg = f"returncode:({process.returncode})"
+            if process.stderr != None:
+                err_msg = process.stderr.read()
+            elif process.stdout != None:
+                err_msg = process.stdout.read()
+            return webutil.FailedResult(code="500", message=f"升级失败:{err_msg}")
+        
+        return webutil.SuccessResult()
+    
+    def POST(self):
+        return self.GET()
+
+class UserCssHandler:
+
+    def GET(self):
+        web.header("Content-Type", "text/css")
+        environ = web.ctx.environ
+        path = os.path.join(xconfig.SCRIPTS_DIR, "user.css")
+        web.header("Cache-Control", "max-age=3600")
+
+        if not os.path.exists(path):
+            return b''
+
+        etag = '"%s"' % os.path.getmtime(path)
+        client_etag = environ.get('HTTP_IF_NONE_MATCH')
+        web.header("Etag", etag)
+        if etag == client_etag:
+            web.ctx.status = "304 Not Modified"
+            return b''  # 其实webpy已经通过yield空bytes来避免None
+        return xutils.readfile(path)
+        # return xconfig.get("USER_CSS", "")
+
+
+class UserJsHandler:
+
+    def GET(self):
+        web.header("Content-Type", "application/javascript")
+        web.header("Cache-Control", "max-age=3600")
+        path = os.path.join(xconfig.SCRIPTS_DIR, "user.js")
+        if not os.path.exists(path):
+            return ""
+        return xutils.readfile(path)
+
+
+xutils.register_func("url:/system/index", IndexHandler)
+
+xurls = (
+    r"/system/sys",   IndexHandler,
+    r"/system/index", IndexHandler,
+    r"/system/admin", AdminHandler,
+    r"/system/system", IndexHandler,
+    r"/system/reload", ReloadHandler,
+    r"/system/pull_code", PullCodeHandler,
+    r"/system/user\.css", UserCssHandler,
+    r"/system/user\.js", UserJsHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/system/system_boot.py` & `xnote-web-0.1.1/handlers/system/system_boot.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/system_event.py` & `xnote-web-0.1.1/handlers/system/system_event.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/system_info.py` & `xnote-web-0.1.1/handlers/system/system_info.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/system_log.py` & `xnote-web-0.1.1/handlers/system/system_log.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,247 +1,247 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-04-06 12:04:41
-@LastEditors  : xupingmao
-@LastEditTime : 2024-02-12 22:10:17
-@FilePath     : /xnote/handlers/system/system_log.py
-@Description  : 描述
-"""
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2018/03/03 12:46:20
-# @modified 2022/04/20 22:50:10
-import os
-import time
-from collections import deque
-from xnote.core import xauth
-import xutils
-from xnote.core import xconfig
-from xnote.core import xmanager
-from xnote.core import xtables
-from xutils import logutil, dbutil, webutil, dateutil
-from xutils.imports import *
-from xnote.core.xtemplate import BasePlugin
-from xutils.functions import iter_exists
-
-uv_db = dbutil.get_table("uv")
-
-OPTION_HTML = '''
-<div class="row">
-    <script src="{{_server_home}}/_static/js/base/jq-ext.js"></script>
-    
-    {% include system/component/system_log_tab.html %}
-
-    <div class="card">
-        {% if log_type == "file" %}
-            <div class="x-tab-box btn-style dark row" data-tab-key="type" data-tab-default="tail">
-                <a class="x-tab" data-tab-value="tail">最新</a>
-                <a class="x-tab" data-tab-value="head">最早</a>
-                <a class="x-tab" data-tab-value="all">全部</a>
-            </div>
-
-            <div class="row">
-                <span>直接查看文件</span>
-                <a href="{{_server_home}}/code/edit?path={{info_log_path}}">INFO日志</a>
-                <span>|</span>
-                <a href="{{_server_home}}/code/edit?path={{warn_log_path}}">WARN日志</a>
-                <span>|</span>
-                <a href="{{_server_home}}/code/edit?path={{error_log_path}}">ERROR日志</a>
-                <span>|</span>
-                <a href="{{_server_home}}/code/edit?path={{trace_log_path}}">TRACE日志</a>
-            </div>
-        {% end %}
-
-        {% if log_type == "mem" %}
-            {% init log_name = "" %}
-            {% init log_not_found = False %}
-
-            <span>日志名称</span>
-            <select value="{{log_name}}" class="logger-name-select">
-                {% for logger in mem_loggers %}
-                    <option value="{{logger.name}}">{{logger.name}}</option>
-                {% end %}
-
-                {% if log_not_found and log_name != "" %}
-                    <option value="{{log_name}}">{{log_name}}</option>
-                {% end %}
-            </select>
-        {% end %}
-    </div>
-    <script>
-    $(function () {
-        $(".output-textarea").scrollBottom();
-        $(".logger-name-select").change(function (e) {
-            var oldHref = window.location.href;
-            var newHref = addUrlParam(oldHref, "log_name", $(e.target).val());
-            window.location.href = newHref;
-        });
-    })
-    </script>
-</div>
-'''
-
-ASIDE_HTML = """
-{% include system/component/admin_nav.html %}
-"""
-
-
-def readlines(fpath):
-    if not os.path.exists(fpath):
-        return []
-    with open(fpath, encoding="utf-8") as fp:
-        return fp.readlines()
-
-
-def get_log_path(date, level="INFO"):
-    month = "-".join(date.split("-")[:2])
-    dirname = os.path.join(xconfig.LOG_DIR, month)
-    fname = "xnote.%s.%s.log" % (date, level)
-    return os.path.join(dirname, fname)
-
-
-def read_tail_lines(fpath, lines):
-    if not os.path.exists(fpath):
-        return []
-
-    q = deque()
-
-    with open(fpath, encoding="utf-8") as fp:
-        while True:
-            line = fp.readline(1024)
-            if line is None or len(line) == 0:
-                break
-            q.append(line)
-            if len(q) > lines:
-                q.popleft()
-
-    return "".join(q)
-
-
-class LogHandler(BasePlugin):
-
-    title = 'xnote系统日志'
-    # description = "查看系统日志"
-    show_category = False
-    show_aside = True
-    category = 'system'
-    editable = False
-    rows = 0
-
-    def get_arg_date(self):
-        date = xutils.get_argument("date")
-
-        if not date:
-            date = time.strftime("%Y-%m-%d")
-
-        return date
-
-    def handle_mem_log(self):
-        log_name = xutils.get_argument("log_name", "")
-        loggers = logutil.MemLogger.list_loggers()
-        for logger in loggers:
-            if logger.name == log_name:
-                return logger.text()
-
-        if len(loggers) > 0 and log_name == "":
-            return loggers[0].text()
-
-        return "<empty>"
-
-    def handle_file_log(self):
-        type = xutils.get_argument("type", "tail")
-        date = self.get_arg_date()
-
-        fpath = get_log_path(date)
-
-        if type == "tail":
-            return read_tail_lines(fpath, 100)
-
-        if type == "head":
-            return ''.join(readlines(fpath)[:100])
-
-        return xutils.readfile(fpath, limit=1024 * 1024)
-
-    def handle(self, content):
-        user_name = xauth.current_name_str()
-        xmanager.add_visit_log(user_name, "/system/log")
-
-        log_type = xutils.get_argument("log_type", "file")
-        date = self.get_arg_date()
-
-        self.render_options(date)
-        
-        self.show_aside = True
-        self.write_aside(ASIDE_HTML)
-
-        if log_type == "mem":
-            return self.handle_mem_log()
-
-        if log_type == "file":
-            return self.handle_file_log()
-
-        return ""
-
-    def render_options(self, date):
-        log_type = xutils.get_argument("log_type", "file")
-        log_name = xutils.get_argument("log_name", "")
-        loggers = logutil.MemLogger.list_loggers()
-        log_not_found = not iter_exists(lambda x: x.name == log_name, loggers)
-
-        self.writehtml(OPTION_HTML,
-                       log_type=log_type,
-                       mem_loggers=loggers,
-                       info_log_path=get_log_path(date),
-                       log_name=log_name,
-                       log_not_found=log_not_found,
-                       warn_log_path=get_log_path(date, "WARN"),
-                       error_log_path=get_log_path(date, "ERROR"),
-                       trace_log_path=get_log_path(date, "TRACE"))
-
-
-class UvRecord(Storage):
-
-    def __init__(self) -> None:
-        self.id = 0
-        self.ip = ""
-        self.site = ""
-        self.date = ""
-        self.count = 0
-    
-class LogVisitHandler:
-
-    def do_get(self, site="", ip=""):
-        uv_db = xtables.get_table_by_name("site_visit_log")        
-        date = dateutil.format_date()
-        db_record = uv_db.select_first(where = dict(date = date, ip = ip, site = site))
-
-        if db_record == None:
-            record = UvRecord()
-            record.count += 1
-            record.date = date
-            record.site = site
-            record.ip = ip
-            record.pop("id")
-            uv_db.insert(**record)
-        else:
-            assert isinstance(db_record, dict)
-            record = UvRecord()
-            record.update(db_record)
-            record.count+=1
-            record.ip = ip
-            uv_db.update(where=dict(id=record.id), **record)
-        return "console.log('log visit success');"
-    
-    def GET(self):
-        site = xutils.get_argument_str("site", "xnote")
-        ip = webutil.get_real_ip()
-        if ip == None:
-            return
-        return self.do_get(site=site, ip=ip)
-
-
-xurls = (
-    r"/system/log", LogHandler,
-    r"/system/log/visit", LogVisitHandler,
-)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-04-06 12:04:41
+@LastEditors  : xupingmao
+@LastEditTime : 2024-02-12 22:10:17
+@FilePath     : /xnote/handlers/system/system_log.py
+@Description  : 描述
+"""
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2018/03/03 12:46:20
+# @modified 2022/04/20 22:50:10
+import os
+import time
+from collections import deque
+from xnote.core import xauth
+import xutils
+from xnote.core import xconfig
+from xnote.core import xmanager
+from xnote.core import xtables
+from xutils import logutil, dbutil, webutil, dateutil
+from xutils.imports import *
+from xnote.core.xtemplate import BasePlugin
+from xutils.functions import iter_exists
+
+uv_db = dbutil.get_table("uv")
+
+OPTION_HTML = '''
+<div class="row">
+    <script src="{{_server_home}}/_static/js/base/jq-ext.js"></script>
+    
+    {% include system/component/system_log_tab.html %}
+
+    <div class="card">
+        {% if log_type == "file" %}
+            <div class="x-tab-box btn-style dark row" data-tab-key="type" data-tab-default="tail">
+                <a class="x-tab" data-tab-value="tail">最新</a>
+                <a class="x-tab" data-tab-value="head">最早</a>
+                <a class="x-tab" data-tab-value="all">全部</a>
+            </div>
+
+            <div class="row">
+                <span>直接查看文件</span>
+                <a href="{{_server_home}}/code/edit?path={{info_log_path}}">INFO日志</a>
+                <span>|</span>
+                <a href="{{_server_home}}/code/edit?path={{warn_log_path}}">WARN日志</a>
+                <span>|</span>
+                <a href="{{_server_home}}/code/edit?path={{error_log_path}}">ERROR日志</a>
+                <span>|</span>
+                <a href="{{_server_home}}/code/edit?path={{trace_log_path}}">TRACE日志</a>
+            </div>
+        {% end %}
+
+        {% if log_type == "mem" %}
+            {% init log_name = "" %}
+            {% init log_not_found = False %}
+
+            <span>日志名称</span>
+            <select value="{{log_name}}" class="logger-name-select">
+                {% for logger in mem_loggers %}
+                    <option value="{{logger.name}}">{{logger.name}}</option>
+                {% end %}
+
+                {% if log_not_found and log_name != "" %}
+                    <option value="{{log_name}}">{{log_name}}</option>
+                {% end %}
+            </select>
+        {% end %}
+    </div>
+    <script>
+    $(function () {
+        $(".output-textarea").scrollBottom();
+        $(".logger-name-select").change(function (e) {
+            var oldHref = window.location.href;
+            var newHref = addUrlParam(oldHref, "log_name", $(e.target).val());
+            window.location.href = newHref;
+        });
+    })
+    </script>
+</div>
+'''
+
+ASIDE_HTML = """
+{% include system/component/admin_nav.html %}
+"""
+
+
+def readlines(fpath):
+    if not os.path.exists(fpath):
+        return []
+    with open(fpath, encoding="utf-8") as fp:
+        return fp.readlines()
+
+
+def get_log_path(date, level="INFO"):
+    month = "-".join(date.split("-")[:2])
+    dirname = os.path.join(xconfig.LOG_DIR, month)
+    fname = "xnote.%s.%s.log" % (date, level)
+    return os.path.join(dirname, fname)
+
+
+def read_tail_lines(fpath, lines):
+    if not os.path.exists(fpath):
+        return []
+
+    q = deque()
+
+    with open(fpath, encoding="utf-8") as fp:
+        while True:
+            line = fp.readline(1024)
+            if line is None or len(line) == 0:
+                break
+            q.append(line)
+            if len(q) > lines:
+                q.popleft()
+
+    return "".join(q)
+
+
+class LogHandler(BasePlugin):
+
+    title = 'xnote系统日志'
+    # description = "查看系统日志"
+    show_category = False
+    show_aside = True
+    category = 'system'
+    editable = False
+    rows = 0
+
+    def get_arg_date(self):
+        date = xutils.get_argument("date")
+
+        if not date:
+            date = time.strftime("%Y-%m-%d")
+
+        return date
+
+    def handle_mem_log(self):
+        log_name = xutils.get_argument("log_name", "")
+        loggers = logutil.MemLogger.list_loggers()
+        for logger in loggers:
+            if logger.name == log_name:
+                return logger.text()
+
+        if len(loggers) > 0 and log_name == "":
+            return loggers[0].text()
+
+        return "<empty>"
+
+    def handle_file_log(self):
+        type = xutils.get_argument("type", "tail")
+        date = self.get_arg_date()
+
+        fpath = get_log_path(date)
+
+        if type == "tail":
+            return read_tail_lines(fpath, 100)
+
+        if type == "head":
+            return ''.join(readlines(fpath)[:100])
+
+        return xutils.readfile(fpath, limit=1024 * 1024)
+
+    def handle(self, content):
+        user_name = xauth.current_name_str()
+        xmanager.add_visit_log(user_name, "/system/log")
+
+        log_type = xutils.get_argument("log_type", "file")
+        date = self.get_arg_date()
+
+        self.render_options(date)
+        
+        self.show_aside = True
+        self.write_aside(ASIDE_HTML)
+
+        if log_type == "mem":
+            return self.handle_mem_log()
+
+        if log_type == "file":
+            return self.handle_file_log()
+
+        return ""
+
+    def render_options(self, date):
+        log_type = xutils.get_argument("log_type", "file")
+        log_name = xutils.get_argument("log_name", "")
+        loggers = logutil.MemLogger.list_loggers()
+        log_not_found = not iter_exists(lambda x: x.name == log_name, loggers)
+
+        self.writehtml(OPTION_HTML,
+                       log_type=log_type,
+                       mem_loggers=loggers,
+                       info_log_path=get_log_path(date),
+                       log_name=log_name,
+                       log_not_found=log_not_found,
+                       warn_log_path=get_log_path(date, "WARN"),
+                       error_log_path=get_log_path(date, "ERROR"),
+                       trace_log_path=get_log_path(date, "TRACE"))
+
+
+class UvRecord(Storage):
+
+    def __init__(self) -> None:
+        self.id = 0
+        self.ip = ""
+        self.site = ""
+        self.date = ""
+        self.count = 0
+    
+class LogVisitHandler:
+
+    def do_get(self, site="", ip=""):
+        uv_db = xtables.get_table_by_name("site_visit_log")        
+        date = dateutil.format_date()
+        db_record = uv_db.select_first(where = dict(date = date, ip = ip, site = site))
+
+        if db_record == None:
+            record = UvRecord()
+            record.count += 1
+            record.date = date
+            record.site = site
+            record.ip = ip
+            record.pop("id")
+            uv_db.insert(**record)
+        else:
+            assert isinstance(db_record, dict)
+            record = UvRecord()
+            record.update(db_record)
+            record.count+=1
+            record.ip = ip
+            uv_db.update(where=dict(id=record.id), **record)
+        return "console.log('log visit success');"
+    
+    def GET(self):
+        site = xutils.get_argument_str("site", "xnote")
+        ip = webutil.get_real_ip()
+        if ip == None:
+            return
+        return self.do_get(site=site, ip=ip)
+
+
+xurls = (
+    r"/system/log", LogHandler,
+    r"/system/log/visit", LogVisitHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/system/system_module.py` & `xnote-web-0.1.1/handlers/system/system_module.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/models.py` & `xnote-web-0.1.1/handlers/system/system_sync/models.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/node_follower.py` & `xnote-web-0.1.1/handlers/system/system_sync/node_follower.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,603 +1,603 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-02-12 18:13:41
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-02 18:20:42
-@FilePath     : /xnote/handlers/system/system_sync/node_follower.py
-@Description  : 从节点管理
-"""
-
-import time
-import logging
-from xnote.core import xconfig, xtables
-
-from xutils import Storage
-from xutils import textutil, cacheutil
-from xutils import dbutil, six
-import xutils
-from xutils.db.binlog import BinLog, FileLog, BinLogOpType
-from .node_base import NodeManagerBase
-from .node_base import convert_follower_dict_to_list
-from .node_base import CONFIG
-from .system_sync_proxy import HttpClient, empty_http_client
-from .models import FileIndexInfo, LeaderStat
-from xutils.mem_util import log_mem_info_deco
-
-fs_sync_index_db = dbutil.get_hash_table("fs_sync_index")
-
-
-def filter_result(result, offset):
-    data = []
-    for item in result.data:
-        if item.get("_id", "") == offset:
-            logging.debug("跳过offset:%s", offset)
-            continue
-        data.append(item)
-
-    result.data = data
-    return result
-
-class Follower(NodeManagerBase):
-
-    # PING的时间间隔，单位是秒
-    # Leader侧的失效时间是1小时
-    PING_INTERVAL = 600
-
-    def __init__(self):
-        self.follower_list = []
-        self.leader_info = None
-        self.ping_error = None
-        self.ping_result = None
-        self.admin_token = None
-        self.last_ping_time = -1
-        self.fs_index_count = -1
-        # 同步完成的时间
-        self.fs_sync_done_time = -1
-        self._debug = False
-        self.http_client = self.get_client()
-        self.file_syncer = FileSyncer(self.http_client)
-        self.db_syncer = DBSyncer(file_syncer = self.file_syncer)
-
-    def create_http_client(self):
-        leader_host = self.get_leader_url()
-        leader_token = self.get_leader_token()
-        return HttpClient(leader_host, leader_token, self.admin_token)
-
-    def get_client(self):
-        return self.create_http_client()
-
-    def get_node_id(self):
-        return xconfig.get_global_config("system.node_id", "unknown_node_id")
-
-    def get_leader_node_id(self):
-        if self.leader_info != None:
-            return self.leader_info.get("node_id")
-        return "<unknown>"
-
-    def get_current_port(self):
-        return xconfig.get_global_config("system.port")
-    
-    def is_token_active(self):
-        now = time.time()
-        is_active = (now - self.last_ping_time) < self.PING_INTERVAL
-        return self.admin_token != None and is_active
-
-    def ping_leader(self, force=True):
-        if self.is_token_active() and not force:
-            return self.ping_result
-        
-        return self.do_ping_leader()
-
-    def do_ping_leader(self):
-        port = self.get_current_port()
-
-        fs_sync_offset = str(self.get_fs_sync_last_id())
-
-        leader_host = self.get_leader_url()
-        if leader_host != None:
-            client = self.get_client()
-            params = dict(port=port, fs_sync_offset=fs_sync_offset,
-                          node_id=self.get_node_id())
-            result_obj = client.get_stat(params)
-
-            self.update_ping_result(result_obj)
-            return result_obj
-
-        return None
-
-    def update_ping_result(self, result0):
-        if result0 is None:
-            logging.error("PING主节点:返回None")
-            return
-
-        result = LeaderStat(**result0)
-        if result.code != "success":
-            self.ping_error = result.message
-            logging.error("PING主节点失败:%s", self.ping_error)
-            return
-
-        logging.debug("PING主节点成功")
-
-        self.ping_error = None
-        self.ping_result = result
-        follower_dict = result.get("follower_dict", {})
-        self.follower_list = convert_follower_dict_to_list(follower_dict)
-        self.leader_info = result.get("leader")
-        self.last_ping_time = time.time()
-
-        if len(self.follower_list) > 0:
-            item = self.follower_list[0]
-            self.admin_token = item.admin_token
-            self.fs_index_count = item.fs_index_count
-            self.http_client.admin_token = self.admin_token
-
-    def get_follower_list(self):
-        return self.follower_list
-
-    @cacheutil.cache_deco("sync.leader_host")
-    def get_leader_url(self):
-        return CONFIG.get("leader.host")
-    
-    def get_leader_info(self):
-        if self.ping_result != None:
-            return self.ping_result.get("leader")
-        return None
-
-    def get_ping_error(self):
-        return self.ping_error
-
-    def need_sync(self):
-        if self.fs_sync_done_time < 0:
-            return True
-
-        last_sync = time.time() - self.fs_sync_done_time
-        return last_sync >= self.PING_INTERVAL
-
-    def get_fs_sync_last_id(self):
-        value = CONFIG.get("fs_sync_last_id")
-        try:
-            return int(value)
-        except:
-            return 0
-        
-    def sync_file_step(self):
-        client = self.get_client()
-        # 先重试失败的任务
-        client.retry_failed()
-    
-        last_id = self.get_fs_sync_last_id()
-        
-        logging.debug("fs_sync_last_id=%s", last_id)
-        result = client.list_files(last_id)
-        logging.debug("list files result=(%s), last_id=(%s)", result, last_id)
-
-        if result is None:
-            logging.error("返回结果为空")
-            return []
-
-        data = result.get("data", [])
-        assert isinstance(data, list)
-        
-        if len(data) == 0:
-            logging.debug("返回文件列表为空")
-            self.fs_sync_done_time = time.time()
-            return data
-        
-        for item in data:
-            item = FileIndexInfo(**item)
-            last_id = max(last_id, item.id)
-
-        # logging.debug("result:%s", result)
-        client.download_files(result)
-
-        # offset可能不变
-        logging.debug("result.sync_offset:%s", result.sync_offset)
-        logging.debug("last_id = %s", last_id)
-
-        CONFIG.put("fs_sync_last_id", last_id)
-        return data
-
-    def sync_files_from_leader(self):
-        result = self.ping_leader()
-        if result == None:
-            logging.error("ping_leader结果为空")
-            return
-
-        if not self.need_sync():
-            # logging.debug("没到SYNC时间")
-            return
-
-        has_next = True
-        loop_count = 0
-        while has_next and loop_count < 100:
-            result = self.sync_file_step()
-            has_next = len(result) > 0
-            loop_count += 1
-
-        return result
-
-    def get_sync_process(self):
-        if self.fs_index_count < 0:
-            return "-1"
-
-        count = self.count_sync_done()
-        if count == 0:
-            return "0%"
-        return "%.2f%%" % (count / self.fs_index_count * 100.0)
-
-    def sync_for_home_page(self):
-        return self.ping_leader() != None
-
-    def get_fs_index_count(self):
-        return self.fs_index_count
-
-    def count_sync_done(self):
-        return dbutil.count_table("fs_sync_index_copy")
-
-    def count_sync_failed(self):
-        return dbutil.count_table("fs_sync_index_failed")
-
-    def reset_sync(self):
-        CONFIG.put("fs_sync_offset", "")
-        CONFIG.put("db_sync_offset", "")
-        CONFIG.put("follower_db_sync_state", "full")
-        CONFIG.delete("follower_binlog_last_seq")
-        CONFIG.delete("follower_db_last_key")
-        self.fs_sync_done_time = -1
-
-        db = dbutil.get_hash_table("fs_sync_index_copy")
-        for key, value in db.iter(limit=-1):
-            db.delete(key)
-
-    def sync_db_from_leader(self):
-        leader_host = self.get_leader_url()
-        if leader_host == None:
-            logging.debug("leader_host为空")
-            raise Exception("leader_host为空")
-
-        ping_result = self.ping_leader()
-        if ping_result == None:
-            logging.debug("ping_leader结果为空")
-            raise Exception("ping_leader结果为空")
-
-        leader_token = self.get_leader_token()
-        if leader_token == "":
-            logging.debug("leader_token为空")
-            raise Exception("leader_token为空")
-        
-        self.db_syncer.sync_db(self.get_client())
-    
-    def is_at_full_sync(self):
-        return self.db_syncer.get_db_sync_state() == "full"
-
-
-class FileSyncer:
-    """文件同步器"""
-    def __init__(self, http_client = empty_http_client):
-        self.http_client = http_client
-
-    def handle_file_binlog(self, key, value):
-        if value == None:
-            logging.warning("value is None, key=%s", key)
-            return
-        self.sync_file(value)
-    
-    def sync_file(self, item):
-        new_item = FileIndexInfo(**item)
-        self.http_client.download_file(new_item)
-
-empty_file_syncer = FileSyncer()
-
-class DBSyncer:
-
-    MAX_LOOPS = 1000 # 最大循环次数
-    FULL_SYNC_MAX_LOOPS = 10000 # 全量同步最大循环次数
-
-    def __init__(self, *, debug = True, file_syncer = empty_file_syncer):
-        self._binlog = BinLog.get_instance()
-        self.debug = debug
-        self.file_syncer = file_syncer
-    
-    def get_table_by_key(self, key):
-        table_name = key.split(":")[0]
-        if dbutil.TableInfo.is_registered(table_name):
-            return dbutil.get_table(table_name)
-        return None
-    
-    def get_table_name_by_key(self, key):
-        return key.split(":")[0]
-    
-    def get_binlog_last_seq(self):
-        value = CONFIG.get("follower_binlog_last_seq", 0)
-        if isinstance(value, int):
-            return value
-        return 0
-
-    def put_binlog_last_seq(self, last_seq):
-        return CONFIG.put("follower_binlog_last_seq", last_seq)
-
-    def get_db_sync_state(self):
-        return CONFIG.get("follower_db_sync_state", "full")
-
-    def put_db_sync_state(self, state):
-        assert state in ("full", "binlog")
-        CONFIG.put("follower_db_sync_state", state)
-    
-    def get_db_last_key(self):
-        # type: () -> str
-        # 全量同步使用，按照key进行遍历
-        value = CONFIG.get("follower_db_last_key", "")
-        assert isinstance(value, six.string_types)
-        return value
-
-    def put_db_last_key(self, last_key):
-        CONFIG.put("follower_db_last_key", last_key)
-
-    def get_table_v2_or_None(self, table_name):
-        try:
-            return dbutil.get_table_v2(table_name)
-        except:
-            return None
-    
-    def put_and_log(self, key, value):
-        assert key != None
-        assert value != None
-        done = False
-        try:
-            table_name = self.get_table_name_by_key(key)
-            table_v2 = self.get_table_v2_or_None(table_name)
-            if table_v2 != None:
-                table_v2.put_by_key(key, value, fix_index=True)
-                return
-            
-            table_info = dbutil.get_table_info(table_name)
-            if table_info == None:
-                logging.warning("table not exists: %s", table_name)
-                return
-            
-            if table_info.type == "hash":
-                dbutil.put(key, value)
-                done = True
-            else:
-                table = dbutil.get_table(table_name)
-                table.update_by_key(key, value)
-                done = True
-        except:
-            xutils.print_exc()
-        
-        if not done:
-            # 失败才记录binlog
-            batch = dbutil.create_write_batch()
-            batch.put(key, value, check_table=False)
-            self._binlog.add_log("put", key, value, batch = batch)
-            batch.commit()
-    
-    def delete_and_log(self, key):
-        assert key != None
-        done = False
-        try:
-            table_name = self.get_table_name_by_key(key)
-            table_v2 = self.get_table_v2_or_None(table_name)
-            if table_v2 != None:
-                table_v2.delete_by_key(key)
-                return
-            
-            table = self.get_table_by_key(key)
-            if table != None:
-                table.delete_by_key(key)
-                done = True
-        except:
-            logging.error("key=%s", key)
-            xutils.print_exc()
-
-        if not done:
-            batch = dbutil.create_write_batch()
-            batch.delete(key)
-            self._binlog.add_log("delete", key, None, batch = batch)
-            batch.commit()
-    
-    @log_mem_info_deco("follower.sync_db")
-    def sync_db(self, proxy):
-        sync_state = self.get_db_sync_state()
-        if sync_state == "binlog":
-            # 增量同步
-            self.sync_by_binlog(proxy)
-        else:
-            # 全量同步
-            self.sync_db_full(proxy)
-
-    def sync_db_full(self, proxy):
-        steps = 0
-        while steps < self.FULL_SYNC_MAX_LOOPS:
-            last_key = self.get_db_last_key()
-            count = self.sync_db_full_step(proxy, last_key)
-            if count == 0:
-                break
-            steps+=1
-
-    def sync_db_full_step(self, proxy, last_key):
-        # type: (HttpClient, str) -> int
-        result = proxy.list_db(last_key)
-
-        if self.debug:
-            logging.debug("-------------\nresp:%s\n\n", result)
-
-        result_obj = textutil.parse_json(result)
-        assert isinstance(result_obj, dict)
-        count = self.sync_db_by_result(result_obj, last_key)
-        return count
-
-    @log_mem_info_deco("sync_by_binlog")
-    def sync_by_binlog(self, proxy): # type: (HttpClient) -> object
-        has_next = True
-        loops = 0
-        last_seq = ""
-
-        while has_next:
-            loops += 1
-            if loops > self.MAX_LOOPS:
-                logging.error("too deep loops, last_seq=%s", last_seq)
-                raise Exception("too deep loops")
-
-            last_seq = self.get_binlog_last_seq()
-            result_obj = proxy.list_binlog(last_seq)
-            
-            if self.debug:
-                logging.debug("list binlog result=%s" % result_obj)
-
-            code = result_obj.get("code")
-            data = result_obj.get("data")
-            # TODO 优化has_next判断
-            has_next = (data != None and len(data) > 1)
-            logging.info("code=%s, has_next=%s", code, has_next)
-
-            if code == "success":
-                self.sync_by_binlog_step(result_obj)
-            elif code == "sync_broken":
-                logging.error("同步binlog异常, 重新全量同步...")
-                self.put_binlog_last_seq(0)
-                self.put_db_sync_state("full")
-                self.put_db_last_key("")
-                self.sync_db_full(proxy)
-                return "sync_by_full"
-            else:
-                raise Exception("未知的code:%s" % code)
-        
-        return None
-
-    @log_mem_info_deco("sync_by_binlog_step")
-    def sync_by_binlog_step(self, result_obj):
-        last_seq = self.get_binlog_last_seq()
-        max_seq = last_seq
-        data_list = result_obj.get("data")
-        for data in data_list:
-            seq = data.get("seq")
-            assert isinstance(seq, int)
-
-            if seq == last_seq:
-                continue
-
-            optype = data.get("optype")
-            key = data.get("key")
-            value = data.get("value")
-
-            if optype in (BinLogOpType.put, BinLogOpType.delete):
-                self.handle_kv_binlog(data)
-            elif optype == "file_upload":
-                self.file_syncer.handle_file_binlog(key, value)
-            elif optype == "file_rename":
-                # TODO 重命名需要考虑删除原来的文件
-                self.file_syncer.handle_file_binlog(key, value)
-            elif optype == "file_delete":
-                # TODO 考虑移动到一个删除文件夹下面
-                logging.info("【不处理】删除文件操作: %s", data)
-            elif optype in (BinLogOpType.sql_upsert, BinLogOpType.sql_delete):
-                self.handle_sql_binlog(data)
-            else:
-                logging.error("未知的optype:%s", optype)
-
-            max_seq = max(max_seq, seq)
-        if max_seq != last_seq:
-            self.put_binlog_last_seq(max_seq)
-        else:
-            logging.info("db已经保持同步")
-    
-    def handle_kv_binlog(self, data):
-        key = data.get("key")
-        value = data.get("value")
-        assert key != None
-        if value == None:
-            self.delete_and_log(key)
-        else:
-            self.put_and_log(key, value)
-
-    def handle_sql_binlog(self, data):
-        optype = data.get("optype")
-        table_name = data.get("table_name")
-        value = data.get("value")
-        pk_value = data.get("key")
-
-        if table_name == None:
-            return
-        
-        if not xtables.is_table_exists(table_name):
-            logging.info("表不存在, table_name=%s", table_name)
-            return
-        
-        table = xtables.get_table_by_name(table_name)
-        pk_name = table.table_info.pk_name
-        where = {pk_name:pk_value}
-        if optype == BinLogOpType.sql_delete:
-            table.delete(where=where)
-
-        if optype == BinLogOpType.sql_upsert:
-            old = table.select_first(where=where)
-            value = table.filter_record(value)
-            # TODO 使用replace解决冲突的问题?
-            try:
-                if old == None:
-                    table.insert(**value)
-                else:
-                    table.update(where=where, **value)
-            except Exception as err:
-                xutils.print_exc()
-                print(f"error value={value}")
-                self.ignore_or_raise(err)
-                
-    def ignore_or_raise(self, err: Exception):
-        err_msg = str(err)
-        print(f"err_msg={err_msg}")
-        err_msg = err_msg.lower()
-        if err_msg.startswith("(1292, \"incorrect datetime value"):
-            # mysql: datetime异常,无法执行成功
-            return
-        if err_msg.startswith("(1062, \"duplicate entry"):
-            # mysql: 主键冲突
-            return
-        if err_msg.startswith("(1366, \"incorrect integer value:"):
-            # mysql: 类型错误
-            return
-        if err_msg.startswith("unique constraint failed:"):
-            # sqlite: 主键冲突
-            return
-        raise err
-
-    def sync_db_by_result(self, result_obj: dict, last_key):
-        # type: (dict, str) -> int
-        code = result_obj.get("code")
-        count = 0
-        assert code == "success"
-        data = result_obj.get("data")
-        assert data != None, "data不能为空"
-        if last_key == "":
-            # 这里需要保存一下位点，后面增量同步从这里开始
-            binlog_last_seq = data.get("binlog_last_seq")
-            assert isinstance(binlog_last_seq, int)
-            self.put_binlog_last_seq(binlog_last_seq)
-
-        rows = data.get("rows")
-        if not isinstance(rows, list):
-            logging.error("resp:%s", result_obj)
-            raise Exception("data.rows必须为list,当前类型(%s)" % type(rows))
-
-        new_last_key = last_key
-        for row in rows:
-            key = row.get("key")
-            value = row.get("value")
-            assert key != None
-            assert value != None
-            if key == last_key:
-                continue
-            
-            self.put_and_log(key, value)
-            new_last_key = key
-            count += 1
-
-        if count == 0:
-            self.put_db_sync_state("binlog")
-        else:
-            self.put_db_last_key(new_last_key)
-        
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-02-12 18:13:41
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-02 18:20:42
+@FilePath     : /xnote/handlers/system/system_sync/node_follower.py
+@Description  : 从节点管理
+"""
+
+import time
+import logging
+from xnote.core import xconfig, xtables
+
+from xutils import Storage
+from xutils import textutil, cacheutil
+from xutils import dbutil, six
+import xutils
+from xutils.db.binlog import BinLog, FileLog, BinLogOpType
+from .node_base import NodeManagerBase
+from .node_base import convert_follower_dict_to_list
+from .node_base import CONFIG
+from .system_sync_proxy import HttpClient, empty_http_client
+from .models import FileIndexInfo, LeaderStat
+from xutils.mem_util import log_mem_info_deco
+
+fs_sync_index_db = dbutil.get_hash_table("fs_sync_index")
+
+
+def filter_result(result, offset):
+    data = []
+    for item in result.data:
+        if item.get("_id", "") == offset:
+            logging.debug("跳过offset:%s", offset)
+            continue
+        data.append(item)
+
+    result.data = data
+    return result
+
+class Follower(NodeManagerBase):
+
+    # PING的时间间隔，单位是秒
+    # Leader侧的失效时间是1小时
+    PING_INTERVAL = 600
+
+    def __init__(self):
+        self.follower_list = []
+        self.leader_info = None
+        self.ping_error = None
+        self.ping_result = None
+        self.admin_token = None
+        self.last_ping_time = -1
+        self.fs_index_count = -1
+        # 同步完成的时间
+        self.fs_sync_done_time = -1
+        self._debug = False
+        self.http_client = self.get_client()
+        self.file_syncer = FileSyncer(self.http_client)
+        self.db_syncer = DBSyncer(file_syncer = self.file_syncer)
+
+    def create_http_client(self):
+        leader_host = self.get_leader_url()
+        leader_token = self.get_leader_token()
+        return HttpClient(leader_host, leader_token, self.admin_token)
+
+    def get_client(self):
+        return self.create_http_client()
+
+    def get_node_id(self):
+        return xconfig.get_global_config("system.node_id", "unknown_node_id")
+
+    def get_leader_node_id(self):
+        if self.leader_info != None:
+            return self.leader_info.get("node_id")
+        return "<unknown>"
+
+    def get_current_port(self):
+        return xconfig.get_global_config("system.port")
+    
+    def is_token_active(self):
+        now = time.time()
+        is_active = (now - self.last_ping_time) < self.PING_INTERVAL
+        return self.admin_token != None and is_active
+
+    def ping_leader(self, force=True):
+        if self.is_token_active() and not force:
+            return self.ping_result
+        
+        return self.do_ping_leader()
+
+    def do_ping_leader(self):
+        port = self.get_current_port()
+
+        fs_sync_offset = str(self.get_fs_sync_last_id())
+
+        leader_host = self.get_leader_url()
+        if leader_host != None:
+            client = self.get_client()
+            params = dict(port=port, fs_sync_offset=fs_sync_offset,
+                          node_id=self.get_node_id())
+            result_obj = client.get_stat(params)
+
+            self.update_ping_result(result_obj)
+            return result_obj
+
+        return None
+
+    def update_ping_result(self, result0):
+        if result0 is None:
+            logging.error("PING主节点:返回None")
+            return
+
+        result = LeaderStat(**result0)
+        if result.code != "success":
+            self.ping_error = result.message
+            logging.error("PING主节点失败:%s", self.ping_error)
+            return
+
+        logging.debug("PING主节点成功")
+
+        self.ping_error = None
+        self.ping_result = result
+        follower_dict = result.get("follower_dict", {})
+        self.follower_list = convert_follower_dict_to_list(follower_dict)
+        self.leader_info = result.get("leader")
+        self.last_ping_time = time.time()
+
+        if len(self.follower_list) > 0:
+            item = self.follower_list[0]
+            self.admin_token = item.admin_token
+            self.fs_index_count = item.fs_index_count
+            self.http_client.admin_token = self.admin_token
+
+    def get_follower_list(self):
+        return self.follower_list
+
+    @cacheutil.cache_deco("sync.leader_host")
+    def get_leader_url(self):
+        return CONFIG.get("leader.host")
+    
+    def get_leader_info(self):
+        if self.ping_result != None:
+            return self.ping_result.get("leader")
+        return None
+
+    def get_ping_error(self):
+        return self.ping_error
+
+    def need_sync(self):
+        if self.fs_sync_done_time < 0:
+            return True
+
+        last_sync = time.time() - self.fs_sync_done_time
+        return last_sync >= self.PING_INTERVAL
+
+    def get_fs_sync_last_id(self):
+        value = CONFIG.get("fs_sync_last_id")
+        try:
+            return int(value)
+        except:
+            return 0
+        
+    def sync_file_step(self):
+        client = self.get_client()
+        # 先重试失败的任务
+        client.retry_failed()
+    
+        last_id = self.get_fs_sync_last_id()
+        
+        logging.debug("fs_sync_last_id=%s", last_id)
+        result = client.list_files(last_id)
+        logging.debug("list files result=(%s), last_id=(%s)", result, last_id)
+
+        if result is None:
+            logging.error("返回结果为空")
+            return []
+
+        data = result.get("data", [])
+        assert isinstance(data, list)
+        
+        if len(data) == 0:
+            logging.debug("返回文件列表为空")
+            self.fs_sync_done_time = time.time()
+            return data
+        
+        for item in data:
+            item = FileIndexInfo(**item)
+            last_id = max(last_id, item.id)
+
+        # logging.debug("result:%s", result)
+        client.download_files(result)
+
+        # offset可能不变
+        logging.debug("result.sync_offset:%s", result.sync_offset)
+        logging.debug("last_id = %s", last_id)
+
+        CONFIG.put("fs_sync_last_id", last_id)
+        return data
+
+    def sync_files_from_leader(self):
+        result = self.ping_leader()
+        if result == None:
+            logging.error("ping_leader结果为空")
+            return
+
+        if not self.need_sync():
+            # logging.debug("没到SYNC时间")
+            return
+
+        has_next = True
+        loop_count = 0
+        while has_next and loop_count < 100:
+            result = self.sync_file_step()
+            has_next = len(result) > 0
+            loop_count += 1
+
+        return result
+
+    def get_sync_process(self):
+        if self.fs_index_count < 0:
+            return "-1"
+
+        count = self.count_sync_done()
+        if count == 0:
+            return "0%"
+        return "%.2f%%" % (count / self.fs_index_count * 100.0)
+
+    def sync_for_home_page(self):
+        return self.ping_leader() != None
+
+    def get_fs_index_count(self):
+        return self.fs_index_count
+
+    def count_sync_done(self):
+        return dbutil.count_table("fs_sync_index_copy")
+
+    def count_sync_failed(self):
+        return dbutil.count_table("fs_sync_index_failed")
+
+    def reset_sync(self):
+        CONFIG.put("fs_sync_offset", "")
+        CONFIG.put("db_sync_offset", "")
+        CONFIG.put("follower_db_sync_state", "full")
+        CONFIG.delete("follower_binlog_last_seq")
+        CONFIG.delete("follower_db_last_key")
+        self.fs_sync_done_time = -1
+
+        db = dbutil.get_hash_table("fs_sync_index_copy")
+        for key, value in db.iter(limit=-1):
+            db.delete(key)
+
+    def sync_db_from_leader(self):
+        leader_host = self.get_leader_url()
+        if leader_host == None:
+            logging.debug("leader_host为空")
+            raise Exception("leader_host为空")
+
+        ping_result = self.ping_leader()
+        if ping_result == None:
+            logging.debug("ping_leader结果为空")
+            raise Exception("ping_leader结果为空")
+
+        leader_token = self.get_leader_token()
+        if leader_token == "":
+            logging.debug("leader_token为空")
+            raise Exception("leader_token为空")
+        
+        self.db_syncer.sync_db(self.get_client())
+    
+    def is_at_full_sync(self):
+        return self.db_syncer.get_db_sync_state() == "full"
+
+
+class FileSyncer:
+    """文件同步器"""
+    def __init__(self, http_client = empty_http_client):
+        self.http_client = http_client
+
+    def handle_file_binlog(self, key, value):
+        if value == None:
+            logging.warning("value is None, key=%s", key)
+            return
+        self.sync_file(value)
+    
+    def sync_file(self, item):
+        new_item = FileIndexInfo(**item)
+        self.http_client.download_file(new_item)
+
+empty_file_syncer = FileSyncer()
+
+class DBSyncer:
+
+    MAX_LOOPS = 1000 # 最大循环次数
+    FULL_SYNC_MAX_LOOPS = 10000 # 全量同步最大循环次数
+
+    def __init__(self, *, debug = True, file_syncer = empty_file_syncer):
+        self._binlog = BinLog.get_instance()
+        self.debug = debug
+        self.file_syncer = file_syncer
+    
+    def get_table_by_key(self, key):
+        table_name = key.split(":")[0]
+        if dbutil.TableInfo.is_registered(table_name):
+            return dbutil.get_table(table_name)
+        return None
+    
+    def get_table_name_by_key(self, key):
+        return key.split(":")[0]
+    
+    def get_binlog_last_seq(self):
+        value = CONFIG.get("follower_binlog_last_seq", 0)
+        if isinstance(value, int):
+            return value
+        return 0
+
+    def put_binlog_last_seq(self, last_seq):
+        return CONFIG.put("follower_binlog_last_seq", last_seq)
+
+    def get_db_sync_state(self):
+        return CONFIG.get("follower_db_sync_state", "full")
+
+    def put_db_sync_state(self, state):
+        assert state in ("full", "binlog")
+        CONFIG.put("follower_db_sync_state", state)
+    
+    def get_db_last_key(self):
+        # type: () -> str
+        # 全量同步使用，按照key进行遍历
+        value = CONFIG.get("follower_db_last_key", "")
+        assert isinstance(value, six.string_types)
+        return value
+
+    def put_db_last_key(self, last_key):
+        CONFIG.put("follower_db_last_key", last_key)
+
+    def get_table_v2_or_None(self, table_name):
+        try:
+            return dbutil.get_table_v2(table_name)
+        except:
+            return None
+    
+    def put_and_log(self, key, value):
+        assert key != None
+        assert value != None
+        done = False
+        try:
+            table_name = self.get_table_name_by_key(key)
+            table_v2 = self.get_table_v2_or_None(table_name)
+            if table_v2 != None:
+                table_v2.put_by_key(key, value, fix_index=True)
+                return
+            
+            table_info = dbutil.get_table_info(table_name)
+            if table_info == None:
+                logging.warning("table not exists: %s", table_name)
+                return
+            
+            if table_info.type == "hash":
+                dbutil.put(key, value)
+                done = True
+            else:
+                table = dbutil.get_table(table_name)
+                table.update_by_key(key, value)
+                done = True
+        except:
+            xutils.print_exc()
+        
+        if not done:
+            # 失败才记录binlog
+            batch = dbutil.create_write_batch()
+            batch.put(key, value, check_table=False)
+            self._binlog.add_log("put", key, value, batch = batch)
+            batch.commit()
+    
+    def delete_and_log(self, key):
+        assert key != None
+        done = False
+        try:
+            table_name = self.get_table_name_by_key(key)
+            table_v2 = self.get_table_v2_or_None(table_name)
+            if table_v2 != None:
+                table_v2.delete_by_key(key)
+                return
+            
+            table = self.get_table_by_key(key)
+            if table != None:
+                table.delete_by_key(key)
+                done = True
+        except:
+            logging.error("key=%s", key)
+            xutils.print_exc()
+
+        if not done:
+            batch = dbutil.create_write_batch()
+            batch.delete(key)
+            self._binlog.add_log("delete", key, None, batch = batch)
+            batch.commit()
+    
+    @log_mem_info_deco("follower.sync_db")
+    def sync_db(self, proxy):
+        sync_state = self.get_db_sync_state()
+        if sync_state == "binlog":
+            # 增量同步
+            self.sync_by_binlog(proxy)
+        else:
+            # 全量同步
+            self.sync_db_full(proxy)
+
+    def sync_db_full(self, proxy):
+        steps = 0
+        while steps < self.FULL_SYNC_MAX_LOOPS:
+            last_key = self.get_db_last_key()
+            count = self.sync_db_full_step(proxy, last_key)
+            if count == 0:
+                break
+            steps+=1
+
+    def sync_db_full_step(self, proxy, last_key):
+        # type: (HttpClient, str) -> int
+        result = proxy.list_db(last_key)
+
+        if self.debug:
+            logging.debug("-------------\nresp:%s\n\n", result)
+
+        result_obj = textutil.parse_json(result)
+        assert isinstance(result_obj, dict)
+        count = self.sync_db_by_result(result_obj, last_key)
+        return count
+
+    @log_mem_info_deco("sync_by_binlog")
+    def sync_by_binlog(self, proxy): # type: (HttpClient) -> object
+        has_next = True
+        loops = 0
+        last_seq = ""
+
+        while has_next:
+            loops += 1
+            if loops > self.MAX_LOOPS:
+                logging.error("too deep loops, last_seq=%s", last_seq)
+                raise Exception("too deep loops")
+
+            last_seq = self.get_binlog_last_seq()
+            result_obj = proxy.list_binlog(last_seq)
+            
+            if self.debug:
+                logging.debug("list binlog result=%s" % result_obj)
+
+            code = result_obj.get("code")
+            data = result_obj.get("data")
+            # TODO 优化has_next判断
+            has_next = (data != None and len(data) > 1)
+            logging.info("code=%s, has_next=%s", code, has_next)
+
+            if code == "success":
+                self.sync_by_binlog_step(result_obj)
+            elif code == "sync_broken":
+                logging.error("同步binlog异常, 重新全量同步...")
+                self.put_binlog_last_seq(0)
+                self.put_db_sync_state("full")
+                self.put_db_last_key("")
+                self.sync_db_full(proxy)
+                return "sync_by_full"
+            else:
+                raise Exception("未知的code:%s" % code)
+        
+        return None
+
+    @log_mem_info_deco("sync_by_binlog_step")
+    def sync_by_binlog_step(self, result_obj):
+        last_seq = self.get_binlog_last_seq()
+        max_seq = last_seq
+        data_list = result_obj.get("data")
+        for data in data_list:
+            seq = data.get("seq")
+            assert isinstance(seq, int)
+
+            if seq == last_seq:
+                continue
+
+            optype = data.get("optype")
+            key = data.get("key")
+            value = data.get("value")
+
+            if optype in (BinLogOpType.put, BinLogOpType.delete):
+                self.handle_kv_binlog(data)
+            elif optype == "file_upload":
+                self.file_syncer.handle_file_binlog(key, value)
+            elif optype == "file_rename":
+                # TODO 重命名需要考虑删除原来的文件
+                self.file_syncer.handle_file_binlog(key, value)
+            elif optype == "file_delete":
+                # TODO 考虑移动到一个删除文件夹下面
+                logging.info("【不处理】删除文件操作: %s", data)
+            elif optype in (BinLogOpType.sql_upsert, BinLogOpType.sql_delete):
+                self.handle_sql_binlog(data)
+            else:
+                logging.error("未知的optype:%s", optype)
+
+            max_seq = max(max_seq, seq)
+        if max_seq != last_seq:
+            self.put_binlog_last_seq(max_seq)
+        else:
+            logging.info("db已经保持同步")
+    
+    def handle_kv_binlog(self, data):
+        key = data.get("key")
+        value = data.get("value")
+        assert key != None
+        if value == None:
+            self.delete_and_log(key)
+        else:
+            self.put_and_log(key, value)
+
+    def handle_sql_binlog(self, data):
+        optype = data.get("optype")
+        table_name = data.get("table_name")
+        value = data.get("value")
+        pk_value = data.get("key")
+
+        if table_name == None:
+            return
+        
+        if not xtables.is_table_exists(table_name):
+            logging.info("表不存在, table_name=%s", table_name)
+            return
+        
+        table = xtables.get_table_by_name(table_name)
+        pk_name = table.table_info.pk_name
+        where = {pk_name:pk_value}
+        if optype == BinLogOpType.sql_delete:
+            table.delete(where=where)
+
+        if optype == BinLogOpType.sql_upsert:
+            old = table.select_first(where=where)
+            value = table.filter_record(value)
+            # TODO 使用replace解决冲突的问题?
+            try:
+                if old == None:
+                    table.insert(**value)
+                else:
+                    table.update(where=where, **value)
+            except Exception as err:
+                xutils.print_exc()
+                print(f"error value={value}")
+                self.ignore_or_raise(err)
+                
+    def ignore_or_raise(self, err: Exception):
+        err_msg = str(err)
+        print(f"err_msg={err_msg}")
+        err_msg = err_msg.lower()
+        if err_msg.startswith("(1292, \"incorrect datetime value"):
+            # mysql: datetime异常,无法执行成功
+            return
+        if err_msg.startswith("(1062, \"duplicate entry"):
+            # mysql: 主键冲突
+            return
+        if err_msg.startswith("(1366, \"incorrect integer value:"):
+            # mysql: 类型错误
+            return
+        if err_msg.startswith("unique constraint failed:"):
+            # sqlite: 主键冲突
+            return
+        raise err
+
+    def sync_db_by_result(self, result_obj: dict, last_key):
+        # type: (dict, str) -> int
+        code = result_obj.get("code")
+        count = 0
+        assert code == "success"
+        data = result_obj.get("data")
+        assert data != None, "data不能为空"
+        if last_key == "":
+            # 这里需要保存一下位点，后面增量同步从这里开始
+            binlog_last_seq = data.get("binlog_last_seq")
+            assert isinstance(binlog_last_seq, int)
+            self.put_binlog_last_seq(binlog_last_seq)
+
+        rows = data.get("rows")
+        if not isinstance(rows, list):
+            logging.error("resp:%s", result_obj)
+            raise Exception("data.rows必须为list,当前类型(%s)" % type(rows))
+
+        new_last_key = last_key
+        for row in rows:
+            key = row.get("key")
+            value = row.get("value")
+            assert key != None
+            assert value != None
+            if key == last_key:
+                continue
+            
+            self.put_and_log(key, value)
+            new_last_key = key
+            count += 1
+
+        if count == 0:
+            self.put_db_sync_state("binlog")
+        else:
+            self.put_db_last_key(new_last_key)
+        
         return count
```

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/node_leader.py` & `xnote-web-0.1.1/handlers/system/system_sync/node_leader.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,280 +1,280 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-02-12 18:13:41
-@LastEditors  : xupingmao
-@LastEditTime : 2023-09-02 11:41:54
-@FilePath     : /xnote/handlers/system/system_sync/node_leader.py
-@Description  : 描述
-"""
-
-
-import threading
-import time
-import xutils
-import logging
-import os
-
-from xnote.core import xauth, xconfig, xtables
-
-from xutils import dateutil
-from xutils import textutil
-from xutils import Storage
-from xutils import webutil
-from xutils import dbutil
-from xutils import fsutil
-from xutils.db.binlog import BinLog, BinLogOpType
-
-from .node_base import NodeManagerBase, convert_follower_dict_to_list
-from .node_base import CONFIG
-from .node_base import get_system_port
-from .models import LeaderStat
-
-MAX_FOLLOWER_SIZE = 100
-EXPIRE_TIME = 60 * 60
-
-
-class FollwerInfo(Storage):
-
-    def init(self):
-        self.ping_time_ts = time.time()
-
-    def update_connect_info(self):
-        self.connected_time = dateutil.format_datetime()
-        self.connected_time_ts = time.time()
-
-    def is_expired(self):
-        gap = time.time() - self.ping_time_ts
-        return gap > EXPIRE_TIME
-
-    def update_ping_info(self):
-        self.ping_time = dateutil.format_datetime()
-        self.ping_time_ts = time.time()
-
-
-class Leader(NodeManagerBase):
-
-    _lock = threading.RLock()
-    FOLLOWER_DICT = dict()
-    binlog = BinLog.get_instance()
-    log_debug = False
-
-    def get_follower_info(self, client_id):
-        client_info = self.FOLLOWER_DICT.get(client_id)
-        if client_info == None:
-            client_info = FollwerInfo()
-            client_info.init()
-            client_info.client_id = client_id
-            client_info.update_connect_info()
-        return client_info
-
-    def check_follower_count(self, client_id):
-        if client_id not in self.FOLLOWER_DICT:
-            return len(self.FOLLOWER_DICT) <= MAX_FOLLOWER_SIZE
-        return True
-
-    def update_follower_info(self, client_info):
-        url = client_info.url
-        self.FOLLOWER_DICT[url] = client_info
-
-    def get_follower_list(self):
-        follower_dict = self.FOLLOWER_DICT
-        return convert_follower_dict_to_list(follower_dict)
-
-    def get_follower_dict(self):
-        return self.FOLLOWER_DICT
-
-    def get_leader_url(self):
-        return "http://127.0.0.1:%s" % get_system_port()
-
-    def get_leader_node_id(self):
-        return self.get_node_id()
-
-    def get_leader_token(self):
-        token = CONFIG.get("leader.token")
-        if token is None or token == "":
-            token = textutil.create_uuid()
-            CONFIG.put("leader.token", token)
-
-        return token
-
-    def get_node_id(self):
-        return xconfig.get("system.node_id")
-
-    def get_ip_whitelist(self):
-        return CONFIG.get("follower.whitelist", "")
-
-    def sync_for_home_page(self):
-        pass
-
-    def get_fs_index_count(self):
-        return xutils.call("system_sync.count_index")
-
-    def get_system_version(self):
-        return xconfig.SystemConfig.get_str("version")
-
-    def remove_expired_followers(self):
-        for key in self.FOLLOWER_DICT.copy():
-            info = self.FOLLOWER_DICT[key]
-            if info.is_expired():
-                del self.FOLLOWER_DICT[key]
-
-    def get_leader_info(self):
-        return dict(token=self.get_leader_token(),
-                    node_id=self.get_node_id(),
-                    fs_index_count=self.get_fs_index_count(),
-                    system_version=self.get_system_version(),
-                    binlog_last_seq=self.binlog.last_seq)
-
-    def get_stat(self, port):
-        admin_info = xauth.get_user_by_name("admin")
-        assert admin_info != None
-        admin_token = admin_info.token
-        fs_index_count = self.get_fs_index_count()
-
-        result = LeaderStat()
-        result.code = "success"
-        result.timestamp = int(time.time())
-        result.system_version = self.get_system_version()
-        result.admin_token = admin_token
-        result.fs_index_count = fs_index_count
-
-        node_id = xutils.get_argument_str("node_id")
-
-        client_ip = webutil.get_client_ip()
-        url = "{ip}:{port}#{node_id}".format(
-            ip=client_ip, port=port, node_id=node_id)
-
-        with self._lock:
-            if not self.check_follower_count(url):
-                result.code = "403"
-                result.message = "Too many connects"
-                return result
-
-            follower = self.get_follower_info(url)
-            follower.update_ping_info()
-            follower.fs_sync_offset = xutils.get_argument_str("fs_sync_offset")
-            follower.fs_index_count = fs_index_count
-            follower.admin_token = admin_token
-            follower.node_id = node_id
-            follower.url = url
-
-            self.update_follower_info(follower)
-            self.remove_expired_followers()
-
-        result.follower_dict = self.get_follower_dict()
-        result.leader = self.get_leader_info()
-
-        return result
-
-    def skip_db_sync(self, key):
-        # type: (str|int) -> bool
-        if isinstance(key, int):
-            return False
-        skipped_prefix_tuple = ("_binlog:", "_index$", "cluster_config:",
-                                "fs_index:", "fs_sync_index:", "fs_sync_index_copy:")
-        table_name = key.split(":", 1)[0]
-        if table_name.find("$")>=0:
-            return True
-        return key.startswith(skipped_prefix_tuple)
-
-    def list_binlog(self, last_seq=0, limit=20, include_req_seq=True):
-        """列出指定条件的binlog
-        include_req_seq: 是否包含请求的seq对应的binlog
-        """
-        sync_diff = self.binlog.last_seq - last_seq
-        binlog_size = self.binlog.count_size()
-        out_of_sync = sync_diff > self.binlog.count_size()
-        is_broken = False
-        broken_reason = ""
-
-        if last_seq <= 0:
-            broken_reason = "sync_broken: last_seq<=0"
-            is_broken = True
-        if last_seq > self.binlog.last_seq:
-            broken_reason = "sync_broken: last_seq=%s, binlog.last_seq=%s" % (last_seq, self.binlog.last_seq)
-            is_broken = True
-        if out_of_sync:
-            broken_reason = "sync_broken: sync_diff=%s, binlog_size=%s"% (sync_diff, binlog_size)
-            is_broken = True
-        
-        if is_broken:
-            return webutil.FailedResult(code="sync_broken", message="同步中断，请重新同步: %s" % broken_reason)
-
-        def map_func(key, value):
-            record_key = value.get("key")
-            if self.skip_db_sync(record_key):
-                return None
-            table_name, seq = key.split(":")
-            value["seq"] = self.binlog._unpack_id(seq)
-            return value
-
-        data_list = []
-        # 预读一位 用于获取下一个key
-        binlogs = self.binlog.list(last_seq, limit + 1, map_func=map_func)
-        if self.log_debug:
-            logging.debug("binlogs:%s", binlogs)
-
-        for log in binlogs:
-            assert isinstance(log, Storage)
-            if not include_req_seq and log.seq == last_seq:
-                continue
-            
-            log = self.process_log(log)
-            if log != None:
-                data_list.append(log)
-
-        return webutil.SuccessResult(data_list[:limit])
-    
-    def process_file_log(self, log):
-        value = log.value
-        fpath = value.get("fpath", "")
-        if os.path.isdir(fpath):
-            value["ftype"] = "dir"
-        else:
-            value["ftype"] = fsutil.get_file_ext(fpath)
-
-        return log
-    
-    def process_log(self, log):
-        # TODO 补充单元测试
-        optype = log.optype
-        if optype in (BinLogOpType.sql_upsert, BinLogOpType.sql_delete):
-            table_name = log.table_name
-            table_info = xtables.TableManager.get_table_info(table_name)
-            if table_info == None:
-                # 无效的binlog
-                return None
-            table = xtables.get_table_by_name(table_name)
-            pk_name = table_info.pk_name
-            pk_value = log.key
-            db_record = table.select_first(where={pk_name: pk_value})
-            log.value = db_record
-            if db_record == None:
-                log.optype = BinLogOpType.sql_delete
-        elif optype in (BinLogOpType.file_upload, BinLogOpType.file_rename, BinLogOpType.file_delete):
-            return self.process_file_log(log)
-        elif optype == BinLogOpType.put:
-            key = log.key
-            log.value = dbutil.get(key)
-            if log.value == None:
-                log.optype = "delete"
-        
-        return log
-
-    def list_db(self, last_key, limit=20):
-        def filter_func(key, value):
-            if self.skip_db_sync(key):
-                return False
-            return True
-
-        result = []
-        for key, value in dbutil.prefix_list("", key_from=last_key,
-                                             limit=limit,
-                                             include_key=True,
-                                             scan_db=True,
-                                             filter_func=filter_func):
-            record = dict(key=key, value=value)
-            result.append(record)
-        return dict(binlog_last_seq=self.binlog.last_seq, rows=result)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-02-12 18:13:41
+@LastEditors  : xupingmao
+@LastEditTime : 2023-09-02 11:41:54
+@FilePath     : /xnote/handlers/system/system_sync/node_leader.py
+@Description  : 描述
+"""
+
+
+import threading
+import time
+import xutils
+import logging
+import os
+
+from xnote.core import xauth, xconfig, xtables
+
+from xutils import dateutil
+from xutils import textutil
+from xutils import Storage
+from xutils import webutil
+from xutils import dbutil
+from xutils import fsutil
+from xutils.db.binlog import BinLog, BinLogOpType
+
+from .node_base import NodeManagerBase, convert_follower_dict_to_list
+from .node_base import CONFIG
+from .node_base import get_system_port
+from .models import LeaderStat
+
+MAX_FOLLOWER_SIZE = 100
+EXPIRE_TIME = 60 * 60
+
+
+class FollwerInfo(Storage):
+
+    def init(self):
+        self.ping_time_ts = time.time()
+
+    def update_connect_info(self):
+        self.connected_time = dateutil.format_datetime()
+        self.connected_time_ts = time.time()
+
+    def is_expired(self):
+        gap = time.time() - self.ping_time_ts
+        return gap > EXPIRE_TIME
+
+    def update_ping_info(self):
+        self.ping_time = dateutil.format_datetime()
+        self.ping_time_ts = time.time()
+
+
+class Leader(NodeManagerBase):
+
+    _lock = threading.RLock()
+    FOLLOWER_DICT = dict()
+    binlog = BinLog.get_instance()
+    log_debug = False
+
+    def get_follower_info(self, client_id):
+        client_info = self.FOLLOWER_DICT.get(client_id)
+        if client_info == None:
+            client_info = FollwerInfo()
+            client_info.init()
+            client_info.client_id = client_id
+            client_info.update_connect_info()
+        return client_info
+
+    def check_follower_count(self, client_id):
+        if client_id not in self.FOLLOWER_DICT:
+            return len(self.FOLLOWER_DICT) <= MAX_FOLLOWER_SIZE
+        return True
+
+    def update_follower_info(self, client_info):
+        url = client_info.url
+        self.FOLLOWER_DICT[url] = client_info
+
+    def get_follower_list(self):
+        follower_dict = self.FOLLOWER_DICT
+        return convert_follower_dict_to_list(follower_dict)
+
+    def get_follower_dict(self):
+        return self.FOLLOWER_DICT
+
+    def get_leader_url(self):
+        return "http://127.0.0.1:%s" % get_system_port()
+
+    def get_leader_node_id(self):
+        return self.get_node_id()
+
+    def get_leader_token(self):
+        token = CONFIG.get("leader.token")
+        if token is None or token == "":
+            token = textutil.create_uuid()
+            CONFIG.put("leader.token", token)
+
+        return token
+
+    def get_node_id(self):
+        return xconfig.get("system.node_id")
+
+    def get_ip_whitelist(self):
+        return CONFIG.get("follower.whitelist", "")
+
+    def sync_for_home_page(self):
+        pass
+
+    def get_fs_index_count(self):
+        return xutils.call("system_sync.count_index")
+
+    def get_system_version(self):
+        return xconfig.SystemConfig.get_str("version")
+
+    def remove_expired_followers(self):
+        for key in self.FOLLOWER_DICT.copy():
+            info = self.FOLLOWER_DICT[key]
+            if info.is_expired():
+                del self.FOLLOWER_DICT[key]
+
+    def get_leader_info(self):
+        return dict(token=self.get_leader_token(),
+                    node_id=self.get_node_id(),
+                    fs_index_count=self.get_fs_index_count(),
+                    system_version=self.get_system_version(),
+                    binlog_last_seq=self.binlog.last_seq)
+
+    def get_stat(self, port):
+        admin_info = xauth.get_user_by_name("admin")
+        assert admin_info != None
+        admin_token = admin_info.token
+        fs_index_count = self.get_fs_index_count()
+
+        result = LeaderStat()
+        result.code = "success"
+        result.timestamp = int(time.time())
+        result.system_version = self.get_system_version()
+        result.admin_token = admin_token
+        result.fs_index_count = fs_index_count
+
+        node_id = xutils.get_argument_str("node_id")
+
+        client_ip = webutil.get_client_ip()
+        url = "{ip}:{port}#{node_id}".format(
+            ip=client_ip, port=port, node_id=node_id)
+
+        with self._lock:
+            if not self.check_follower_count(url):
+                result.code = "403"
+                result.message = "Too many connects"
+                return result
+
+            follower = self.get_follower_info(url)
+            follower.update_ping_info()
+            follower.fs_sync_offset = xutils.get_argument_str("fs_sync_offset")
+            follower.fs_index_count = fs_index_count
+            follower.admin_token = admin_token
+            follower.node_id = node_id
+            follower.url = url
+
+            self.update_follower_info(follower)
+            self.remove_expired_followers()
+
+        result.follower_dict = self.get_follower_dict()
+        result.leader = self.get_leader_info()
+
+        return result
+
+    def skip_db_sync(self, key):
+        # type: (str|int) -> bool
+        if isinstance(key, int):
+            return False
+        skipped_prefix_tuple = ("_binlog:", "_index$", "cluster_config:",
+                                "fs_index:", "fs_sync_index:", "fs_sync_index_copy:")
+        table_name = key.split(":", 1)[0]
+        if table_name.find("$")>=0:
+            return True
+        return key.startswith(skipped_prefix_tuple)
+
+    def list_binlog(self, last_seq=0, limit=20, include_req_seq=True):
+        """列出指定条件的binlog
+        include_req_seq: 是否包含请求的seq对应的binlog
+        """
+        sync_diff = self.binlog.last_seq - last_seq
+        binlog_size = self.binlog.count_size()
+        out_of_sync = sync_diff > self.binlog.count_size()
+        is_broken = False
+        broken_reason = ""
+
+        if last_seq <= 0:
+            broken_reason = "sync_broken: last_seq<=0"
+            is_broken = True
+        if last_seq > self.binlog.last_seq:
+            broken_reason = "sync_broken: last_seq=%s, binlog.last_seq=%s" % (last_seq, self.binlog.last_seq)
+            is_broken = True
+        if out_of_sync:
+            broken_reason = "sync_broken: sync_diff=%s, binlog_size=%s"% (sync_diff, binlog_size)
+            is_broken = True
+        
+        if is_broken:
+            return webutil.FailedResult(code="sync_broken", message="同步中断，请重新同步: %s" % broken_reason)
+
+        def map_func(key, value):
+            record_key = value.get("key")
+            if self.skip_db_sync(record_key):
+                return None
+            table_name, seq = key.split(":")
+            value["seq"] = self.binlog._unpack_id(seq)
+            return value
+
+        data_list = []
+        # 预读一位 用于获取下一个key
+        binlogs = self.binlog.list(last_seq, limit + 1, map_func=map_func)
+        if self.log_debug:
+            logging.debug("binlogs:%s", binlogs)
+
+        for log in binlogs:
+            assert isinstance(log, Storage)
+            if not include_req_seq and log.seq == last_seq:
+                continue
+            
+            log = self.process_log(log)
+            if log != None:
+                data_list.append(log)
+
+        return webutil.SuccessResult(data_list[:limit])
+    
+    def process_file_log(self, log):
+        value = log.value
+        fpath = value.get("fpath", "")
+        if os.path.isdir(fpath):
+            value["ftype"] = "dir"
+        else:
+            value["ftype"] = fsutil.get_file_ext(fpath)
+
+        return log
+    
+    def process_log(self, log):
+        # TODO 补充单元测试
+        optype = log.optype
+        if optype in (BinLogOpType.sql_upsert, BinLogOpType.sql_delete):
+            table_name = log.table_name
+            table_info = xtables.TableManager.get_table_info(table_name)
+            if table_info == None:
+                # 无效的binlog
+                return None
+            table = xtables.get_table_by_name(table_name)
+            pk_name = table_info.pk_name
+            pk_value = log.key
+            db_record = table.select_first(where={pk_name: pk_value})
+            log.value = db_record
+            if db_record == None:
+                log.optype = BinLogOpType.sql_delete
+        elif optype in (BinLogOpType.file_upload, BinLogOpType.file_rename, BinLogOpType.file_delete):
+            return self.process_file_log(log)
+        elif optype == BinLogOpType.put:
+            key = log.key
+            log.value = dbutil.get(key)
+            if log.value == None:
+                log.optype = "delete"
+        
+        return log
+
+    def list_db(self, last_key, limit=20):
+        def filter_func(key, value):
+            if self.skip_db_sync(key):
+                return False
+            return True
+
+        result = []
+        for key, value in dbutil.prefix_list("", key_from=last_key,
+                                             limit=limit,
+                                             include_key=True,
+                                             scan_db=True,
+                                             filter_func=filter_func):
+            record = dict(key=key, value=value)
+            result.append(record)
+        return dict(binlog_last_seq=self.binlog.last_seq, rows=result)
```

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/system_sync_controller.py` & `xnote-web-0.1.1/handlers/system/system_sync/system_sync_controller.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,416 +1,416 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/11/07 12:38:32
-# @modified 2022/03/31 12:21:54
-# @filename system_sync_controller.py
-
-"""系统数据同步功能，目前提供主从同步的能力
-
-操作步骤：
-1、启动主节点服务，在主节点上添加IP白名单
-2、设置`node_role=follower`参数启动子节点服务
-3、配置子节点同步：
-    a. 从主节点同步设置页面拷贝`同步链接`
-    b. 把`同步链接`配置到子节点的同步设置页面上，点击同步按钮
-4、配置完成后，系统开始同步
-"""
-
-import time
-import threading
-import logging
-import xutils
-import web
-
-from xnote.core import xauth, xconfig, xtemplate, xmanager
-
-from xutils import webutil
-from xutils import Storage
-from xutils import dbutil
-from xutils import dateutil
-from xutils import textutil
-from xutils import netutil
-from xutils import cacheutil
-
-from .node_follower import Follower
-from .node_leader import Leader
-from . import system_sync_indexer
-
-dbutil.register_table("cluster_config", "集群配置")
-CONFIG = dbutil.get_hash_table("cluster_config")
-
-
-class SyncConfig:
-
-    @staticmethod
-    def need_sync_db():
-        return xconfig.WebConfig.sync_db_from_leader
-    
-    @staticmethod
-    def need_sync_files():
-        return xconfig.WebConfig.sync_files_from_leader
-    
-    @staticmethod
-    def set_need_sync_db(bool_value = False):
-        xconfig.WebConfig.sync_db_from_leader = bool_value
-    
-    @staticmethod
-    def set_need_sync_files(bool_value = False):
-        xconfig.WebConfig.sync_files_from_leader = bool_value
-
-def get_system_role():
-    return xconfig.get_global_config("system.node_role")
-
-
-def print_debug_info(*args):
-    new_args = [dateutil.format_time(), "[system_sync]"]
-    new_args += args
-    print(*new_args)
-
-
-def convert_dict_to_text(dict):
-    return textutil.tojson(dict, format=True)
-
-
-LEADER = Leader()
-FOLLOWER = Follower()
-
-
-def get_system_role_manager():
-    if get_system_role() == "leader":
-        return LEADER
-    else:
-        return FOLLOWER
-
-
-class ConfigHandler:
-
-    def execute(self):
-        key = xutils.get_argument("key")
-        value = xutils.get_argument("value")
-
-        if key == "leader.host":
-            return self.set_leader_host(value)
-
-        if key == "leader.token":
-            return self.set_leader_token(value)
-
-        if key == "reset_offset":
-            return self.reset_offset()
-
-        if key == "trigger_sync":
-            return self.trigger_sync()
-        
-        if key == "sync_status":
-            return self.set_sync_status(value)
-
-        return dict(code="success")
-
-    def reset_offset(self):
-        FOLLOWER.reset_sync()
-        return dict(code="success")
-
-    def trigger_sync(self):
-        FOLLOWER.ping_leader()
-        FOLLOWER.sync_files_from_leader()
-        return dict(code="success")
-
-    def set_leader_host(self, host):
-        assert xutils.is_str(host), "host is not str"
-
-        if not netutil.is_http_url(host):
-            return dict(code="400", message="无效的URL地址(%s)" % host)
-        CONFIG.put("leader.host", host)
-        cacheutil.delete("sync.leader_host")
-        return dict(code="success")
-
-    def set_leader_token(self, token):
-        CONFIG.put("leader.token", token)
-        cacheutil.delete("sync.leader_token")
-        return dict(code="success")
-    
-    def set_sync_status(self, value):
-        if value == None:
-            return dict(code="err", message="配置值为空")
-        bool_value = value.lower() == "true"
-        SyncConfig.set_need_sync_db(bool_value)
-        SyncConfig.set_need_sync_files(bool_value)
-        if bool_value:
-            message = "同步已开启"
-        else:
-            message = "同步已关闭"
-        return dict(code="success", message=message)
-
-
-def get_leader_url():
-    if get_system_role() == "leader":
-        return "127.0.0.1"
-
-    return CONFIG.get("leader.host")
-
-
-class SyncHandler:
-
-    def POST(self):
-        return self.GET()
-
-    def GET(self):
-        p = xutils.get_argument("p", "")
-        client_ip = webutil.get_client_ip()
-        system_role = get_system_role()
-
-        if p == "home" or p == "":
-            return self.get_home_page()
-
-        if p == "set_config":
-            return self.do_set_config()
-
-        if p == "ping":
-            return self.do_ping()
-
-        if p == "get_detail":
-            return self.get_detail()
-
-        if p == "build_index":
-            if not xconfig.get_global_config("system.build_fs_sync_index"):
-                return dict(code="403", message="文件同步索引未开启 [build_fs_sync_index]")
-
-            return self.do_build_index()
-
-        if p == "sync_files_from_leader":
-            xauth.check_login("admin")
-            return FOLLOWER.sync_files_from_leader()
-
-        if p == "sync_db":
-            xauth.check_login("admin")
-            FOLLOWER.sync_db_from_leader()
-            return webutil.SuccessResult()
-
-        return LeaderHandler().handle_leader_action()
-    
-    def get_leader_binlog_seq(self, role_manager):
-        leader_info = role_manager.get_leader_info()
-        if leader_info == None:
-            return -1
-        return leader_info.get("binlog_last_seq")
-
-    @xauth.login_required("admin")
-    def get_home_page(self):
-        kw = Storage()
-        role_manager = get_system_role_manager()
-
-        try:
-            role_manager.sync_for_home_page()
-        except:
-            xutils.print_exc()
-
-        kw.node_role = get_system_role()
-        kw.leader_host = CONFIG.get("leader.host", "未设置")
-        kw.leader_token = role_manager.get_leader_token()
-        kw.leader_url = role_manager.get_leader_url()
-        kw.leader_node_id = role_manager.get_leader_node_id()
-        kw.leader_binlog_seq = self.get_leader_binlog_seq(role_manager)
-
-        kw.follower_list = role_manager.get_follower_list()
-        kw.ping_error = role_manager.get_ping_error()
-        kw.fs_index_count = role_manager.get_fs_index_count()
-
-        kw.whitelist = LEADER.get_ip_whitelist()
-        kw.sync_process = FOLLOWER.get_sync_process()
-        kw.sync_failed_count = FOLLOWER.count_sync_failed()
-        kw.follower_binlog_seq = FOLLOWER.db_syncer.get_binlog_last_seq()
-        kw.follower_db_sync_state = FOLLOWER.db_syncer.get_db_sync_state()
-        kw.follower_db_last_key = FOLLOWER.db_syncer.get_db_last_key()
-        kw.sync_status = SyncConfig.need_sync_db()
-
-        return xtemplate.render("system/page/system_sync.html", **kw)
-
-    @xauth.login_required("admin")
-    def do_set_config(self):
-        handler = ConfigHandler()
-        return handler.execute()
-
-    @xauth.login_required("admin")
-    def get_detail(self):
-        type = xutils.get_argument("type")
-        key = xutils.get_argument("key")
-
-        if type == "follower":
-            role_manager = get_system_role_manager()
-            info = role_manager.get_follower_info_by_url(key)
-            return dict(code="success", data=info, text=convert_dict_to_text(info))
-
-        return dict(code="500", message="未知的类型")
-
-    def list_recent(self):
-        result = Storage()
-        result.code = "success"
-        # TODO 读取filelist
-        return result
-
-    @xauth.login_required("admin")
-    def do_build_index(self):
-        manager = system_sync_indexer.FileSyncIndexManager()
-        manager.build_full_index()
-        return dict(code="success")
-
-    def do_ping(self):
-        data = FOLLOWER.ping_leader(force=True)
-        return webutil.SuccessResult(data)
-
-
-class LeaderHandler(SyncHandler):
-    """作为主节点提供的能力"""
-
-    def GET(self):
-        return self.handle_leader_action()
-
-    def get_token(self):
-        """通过临时令牌换取访问token"""
-        pass
-
-    def refresh_token(self):
-        """刷新访问token"""
-        pass
-
-    def check_token(self):
-        token = xutils.get_argument("token", "")
-        leader_token = LEADER.get_leader_token()
-        if token != leader_token:
-            error = dict(code="403", message="无权访问,TOKEN校验不通过")
-            status = "401 Unauthorized"
-            headers = {"Content-Type": "application/json"}
-            raise web.HTTPError(status, headers, textutil.tojson(error))
-
-    def list_files(self):
-        """(主节点)读取文件列表"""
-        last_id = xutils.get_argument_int("last_id", 0)
-        result = Storage()
-        result.code = "success"
-        result.req_last_id = last_id
-
-        data = system_sync_indexer.list_files(last_id=last_id)
-        result.data = data
-        return result
-
-    def handle_leader_action(self):
-        """主节点的提供的功能"""
-        p = xutils.get_argument("p", "")
-        error = self.check_token()
-        if error != None:
-            return error
-
-        # 没有token不允许继续
-
-        if p == "get_token":
-            return self.get_token()
-
-        if p == "refresh_token":
-            return self.refresh_token()
-
-        if p == "get_stat":
-            port = xutils.get_argument("port", "")
-            return LEADER.get_stat(port)
-
-        if p == "list_files":
-            return self.list_files()
-
-        if p == "list_binlog":
-            binlog_last_seq = xutils.get_argument_int("last_seq")
-            limit = xutils.get_argument_int("limit", 20)
-            include_req_seq = xutils.get_argument_bool("include_req_seq", True)
-            return LEADER.list_binlog(binlog_last_seq, limit, include_req_seq=include_req_seq)
-
-        if p == "list_db":
-            last_key = xutils.get_argument("last_key", "")
-            limit = xutils.get_argument_int("limit", 20)
-            data = LEADER.list_db(last_key, limit)
-            return dict(code="success", data=data)
-
-        if p == "list_recent":
-            return self.list_recent()
-
-        return dict(code="error", message="未知的操作")
-
-
-class FollowerHandler(SyncHandler):
-
-    @xauth.login_required("admin")
-    def GET(self):
-        p = xutils.get_argument("p", "")
-        if p == "get_leader_stat":
-            return FOLLOWER.get_leader_info()
-        
-        return dict(code="400", message="unknown op")
-
-@xmanager.listen("sys.init")
-def init(ctx=None):
-    LEADER.get_leader_token()
-
-@xmanager.listen("sync.step")
-# @log_mem_info_deco("on_ping_leader")
-def on_ping_leader(ctx=None):
-    role = get_system_role()
-    if role == "leader":
-        return None
-    
-    # TODO 优化ping的时间
-
-    try:        
-        if FOLLOWER.is_token_active():
-            return
-            
-        return FOLLOWER.ping_leader()
-    except:
-        xutils.print_exc()
-        logging.error("ping_leader failed, wait 60 seconds...")
-        time.sleep(60)
-
-
-@xmanager.listen("sync.step")
-# @log_mem_info_deco("on_sync_files_from_leader")
-def on_sync_files_from_leader(ctx=None):
-    role = get_system_role()
-    if role == "leader":
-        return None
-    
-    if not SyncConfig.need_sync_files():
-        return None
-    
-    if FOLLOWER.is_at_full_sync():
-        # 优先等待db同步完
-        return None
-
-    try:
-        logging.debug("开始同步文件...")
-        logging.debug("-" * 50)
-        FOLLOWER.sync_files_from_leader()
-    except:
-        xutils.print_exc()
-        logging.error("sync_files_from_leader failed, wait 60 seconds...")
-        time.sleep(60)
-
-
-@xmanager.listen("sync.step")
-# @log_mem_info_deco("on_sync_db_from_leader")
-def on_sync_db_from_leader(ctx=None):
-    role = get_system_role()
-    if role == "leader":
-        return None
-    
-    if not SyncConfig.need_sync_db():
-        return None
-
-    try:
-        logging.debug("开始同步数据库")
-        logging.debug("-"*50)
-        FOLLOWER.sync_db_from_leader()
-    except:
-        xutils.print_exc()
-        logging.error("sync_db_from_leader failed, wait 60 seconds...")
-        time.sleep(60)
-
-xurls = (
-    r"/system/sync", SyncHandler,
-    r"/system/sync/leader", LeaderHandler,
-    r"/system/sync/follower", FollowerHandler,
-)
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/11/07 12:38:32
+# @modified 2022/03/31 12:21:54
+# @filename system_sync_controller.py
+
+"""系统数据同步功能，目前提供主从同步的能力
+
+操作步骤：
+1、启动主节点服务，在主节点上添加IP白名单
+2、设置`node_role=follower`参数启动子节点服务
+3、配置子节点同步：
+    a. 从主节点同步设置页面拷贝`同步链接`
+    b. 把`同步链接`配置到子节点的同步设置页面上，点击同步按钮
+4、配置完成后，系统开始同步
+"""
+
+import time
+import threading
+import logging
+import xutils
+import web
+
+from xnote.core import xauth, xconfig, xtemplate, xmanager
+
+from xutils import webutil
+from xutils import Storage
+from xutils import dbutil
+from xutils import dateutil
+from xutils import textutil
+from xutils import netutil
+from xutils import cacheutil
+
+from .node_follower import Follower
+from .node_leader import Leader
+from . import system_sync_indexer
+
+dbutil.register_table("cluster_config", "集群配置")
+CONFIG = dbutil.get_hash_table("cluster_config")
+
+
+class SyncConfig:
+
+    @staticmethod
+    def need_sync_db():
+        return xconfig.WebConfig.sync_db_from_leader
+    
+    @staticmethod
+    def need_sync_files():
+        return xconfig.WebConfig.sync_files_from_leader
+    
+    @staticmethod
+    def set_need_sync_db(bool_value = False):
+        xconfig.WebConfig.sync_db_from_leader = bool_value
+    
+    @staticmethod
+    def set_need_sync_files(bool_value = False):
+        xconfig.WebConfig.sync_files_from_leader = bool_value
+
+def get_system_role():
+    return xconfig.get_global_config("system.node_role")
+
+
+def print_debug_info(*args):
+    new_args = [dateutil.format_time(), "[system_sync]"]
+    new_args += args
+    print(*new_args)
+
+
+def convert_dict_to_text(dict):
+    return textutil.tojson(dict, format=True)
+
+
+LEADER = Leader()
+FOLLOWER = Follower()
+
+
+def get_system_role_manager():
+    if get_system_role() == "leader":
+        return LEADER
+    else:
+        return FOLLOWER
+
+
+class ConfigHandler:
+
+    def execute(self):
+        key = xutils.get_argument("key")
+        value = xutils.get_argument("value")
+
+        if key == "leader.host":
+            return self.set_leader_host(value)
+
+        if key == "leader.token":
+            return self.set_leader_token(value)
+
+        if key == "reset_offset":
+            return self.reset_offset()
+
+        if key == "trigger_sync":
+            return self.trigger_sync()
+        
+        if key == "sync_status":
+            return self.set_sync_status(value)
+
+        return dict(code="success")
+
+    def reset_offset(self):
+        FOLLOWER.reset_sync()
+        return dict(code="success")
+
+    def trigger_sync(self):
+        FOLLOWER.ping_leader()
+        FOLLOWER.sync_files_from_leader()
+        return dict(code="success")
+
+    def set_leader_host(self, host):
+        assert xutils.is_str(host), "host is not str"
+
+        if not netutil.is_http_url(host):
+            return dict(code="400", message="无效的URL地址(%s)" % host)
+        CONFIG.put("leader.host", host)
+        cacheutil.delete("sync.leader_host")
+        return dict(code="success")
+
+    def set_leader_token(self, token):
+        CONFIG.put("leader.token", token)
+        cacheutil.delete("sync.leader_token")
+        return dict(code="success")
+    
+    def set_sync_status(self, value):
+        if value == None:
+            return dict(code="err", message="配置值为空")
+        bool_value = value.lower() == "true"
+        SyncConfig.set_need_sync_db(bool_value)
+        SyncConfig.set_need_sync_files(bool_value)
+        if bool_value:
+            message = "同步已开启"
+        else:
+            message = "同步已关闭"
+        return dict(code="success", message=message)
+
+
+def get_leader_url():
+    if get_system_role() == "leader":
+        return "127.0.0.1"
+
+    return CONFIG.get("leader.host")
+
+
+class SyncHandler:
+
+    def POST(self):
+        return self.GET()
+
+    def GET(self):
+        p = xutils.get_argument("p", "")
+        client_ip = webutil.get_client_ip()
+        system_role = get_system_role()
+
+        if p == "home" or p == "":
+            return self.get_home_page()
+
+        if p == "set_config":
+            return self.do_set_config()
+
+        if p == "ping":
+            return self.do_ping()
+
+        if p == "get_detail":
+            return self.get_detail()
+
+        if p == "build_index":
+            if not xconfig.get_global_config("system.build_fs_sync_index"):
+                return dict(code="403", message="文件同步索引未开启 [build_fs_sync_index]")
+
+            return self.do_build_index()
+
+        if p == "sync_files_from_leader":
+            xauth.check_login("admin")
+            return FOLLOWER.sync_files_from_leader()
+
+        if p == "sync_db":
+            xauth.check_login("admin")
+            FOLLOWER.sync_db_from_leader()
+            return webutil.SuccessResult()
+
+        return LeaderHandler().handle_leader_action()
+    
+    def get_leader_binlog_seq(self, role_manager):
+        leader_info = role_manager.get_leader_info()
+        if leader_info == None:
+            return -1
+        return leader_info.get("binlog_last_seq")
+
+    @xauth.login_required("admin")
+    def get_home_page(self):
+        kw = Storage()
+        role_manager = get_system_role_manager()
+
+        try:
+            role_manager.sync_for_home_page()
+        except:
+            xutils.print_exc()
+
+        kw.node_role = get_system_role()
+        kw.leader_host = CONFIG.get("leader.host", "未设置")
+        kw.leader_token = role_manager.get_leader_token()
+        kw.leader_url = role_manager.get_leader_url()
+        kw.leader_node_id = role_manager.get_leader_node_id()
+        kw.leader_binlog_seq = self.get_leader_binlog_seq(role_manager)
+
+        kw.follower_list = role_manager.get_follower_list()
+        kw.ping_error = role_manager.get_ping_error()
+        kw.fs_index_count = role_manager.get_fs_index_count()
+
+        kw.whitelist = LEADER.get_ip_whitelist()
+        kw.sync_process = FOLLOWER.get_sync_process()
+        kw.sync_failed_count = FOLLOWER.count_sync_failed()
+        kw.follower_binlog_seq = FOLLOWER.db_syncer.get_binlog_last_seq()
+        kw.follower_db_sync_state = FOLLOWER.db_syncer.get_db_sync_state()
+        kw.follower_db_last_key = FOLLOWER.db_syncer.get_db_last_key()
+        kw.sync_status = SyncConfig.need_sync_db()
+
+        return xtemplate.render("system/page/system_sync.html", **kw)
+
+    @xauth.login_required("admin")
+    def do_set_config(self):
+        handler = ConfigHandler()
+        return handler.execute()
+
+    @xauth.login_required("admin")
+    def get_detail(self):
+        type = xutils.get_argument("type")
+        key = xutils.get_argument("key")
+
+        if type == "follower":
+            role_manager = get_system_role_manager()
+            info = role_manager.get_follower_info_by_url(key)
+            return dict(code="success", data=info, text=convert_dict_to_text(info))
+
+        return dict(code="500", message="未知的类型")
+
+    def list_recent(self):
+        result = Storage()
+        result.code = "success"
+        # TODO 读取filelist
+        return result
+
+    @xauth.login_required("admin")
+    def do_build_index(self):
+        manager = system_sync_indexer.FileSyncIndexManager()
+        manager.build_full_index()
+        return dict(code="success")
+
+    def do_ping(self):
+        data = FOLLOWER.ping_leader(force=True)
+        return webutil.SuccessResult(data)
+
+
+class LeaderHandler(SyncHandler):
+    """作为主节点提供的能力"""
+
+    def GET(self):
+        return self.handle_leader_action()
+
+    def get_token(self):
+        """通过临时令牌换取访问token"""
+        pass
+
+    def refresh_token(self):
+        """刷新访问token"""
+        pass
+
+    def check_token(self):
+        token = xutils.get_argument("token", "")
+        leader_token = LEADER.get_leader_token()
+        if token != leader_token:
+            error = dict(code="403", message="无权访问,TOKEN校验不通过")
+            status = "401 Unauthorized"
+            headers = {"Content-Type": "application/json"}
+            raise web.HTTPError(status, headers, textutil.tojson(error))
+
+    def list_files(self):
+        """(主节点)读取文件列表"""
+        last_id = xutils.get_argument_int("last_id", 0)
+        result = Storage()
+        result.code = "success"
+        result.req_last_id = last_id
+
+        data = system_sync_indexer.list_files(last_id=last_id)
+        result.data = data
+        return result
+
+    def handle_leader_action(self):
+        """主节点的提供的功能"""
+        p = xutils.get_argument("p", "")
+        error = self.check_token()
+        if error != None:
+            return error
+
+        # 没有token不允许继续
+
+        if p == "get_token":
+            return self.get_token()
+
+        if p == "refresh_token":
+            return self.refresh_token()
+
+        if p == "get_stat":
+            port = xutils.get_argument("port", "")
+            return LEADER.get_stat(port)
+
+        if p == "list_files":
+            return self.list_files()
+
+        if p == "list_binlog":
+            binlog_last_seq = xutils.get_argument_int("last_seq")
+            limit = xutils.get_argument_int("limit", 20)
+            include_req_seq = xutils.get_argument_bool("include_req_seq", True)
+            return LEADER.list_binlog(binlog_last_seq, limit, include_req_seq=include_req_seq)
+
+        if p == "list_db":
+            last_key = xutils.get_argument("last_key", "")
+            limit = xutils.get_argument_int("limit", 20)
+            data = LEADER.list_db(last_key, limit)
+            return dict(code="success", data=data)
+
+        if p == "list_recent":
+            return self.list_recent()
+
+        return dict(code="error", message="未知的操作")
+
+
+class FollowerHandler(SyncHandler):
+
+    @xauth.login_required("admin")
+    def GET(self):
+        p = xutils.get_argument("p", "")
+        if p == "get_leader_stat":
+            return FOLLOWER.get_leader_info()
+        
+        return dict(code="400", message="unknown op")
+
+@xmanager.listen("sys.init")
+def init(ctx=None):
+    LEADER.get_leader_token()
+
+@xmanager.listen("sync.step")
+# @log_mem_info_deco("on_ping_leader")
+def on_ping_leader(ctx=None):
+    role = get_system_role()
+    if role == "leader":
+        return None
+    
+    # TODO 优化ping的时间
+
+    try:        
+        if FOLLOWER.is_token_active():
+            return
+            
+        return FOLLOWER.ping_leader()
+    except:
+        xutils.print_exc()
+        logging.error("ping_leader failed, wait 60 seconds...")
+        time.sleep(60)
+
+
+@xmanager.listen("sync.step")
+# @log_mem_info_deco("on_sync_files_from_leader")
+def on_sync_files_from_leader(ctx=None):
+    role = get_system_role()
+    if role == "leader":
+        return None
+    
+    if not SyncConfig.need_sync_files():
+        return None
+    
+    if FOLLOWER.is_at_full_sync():
+        # 优先等待db同步完
+        return None
+
+    try:
+        logging.debug("开始同步文件...")
+        logging.debug("-" * 50)
+        FOLLOWER.sync_files_from_leader()
+    except:
+        xutils.print_exc()
+        logging.error("sync_files_from_leader failed, wait 60 seconds...")
+        time.sleep(60)
+
+
+@xmanager.listen("sync.step")
+# @log_mem_info_deco("on_sync_db_from_leader")
+def on_sync_db_from_leader(ctx=None):
+    role = get_system_role()
+    if role == "leader":
+        return None
+    
+    if not SyncConfig.need_sync_db():
+        return None
+
+    try:
+        logging.debug("开始同步数据库")
+        logging.debug("-"*50)
+        FOLLOWER.sync_db_from_leader()
+    except:
+        xutils.print_exc()
+        logging.error("sync_db_from_leader failed, wait 60 seconds...")
+        time.sleep(60)
+
+xurls = (
+    r"/system/sync", SyncHandler,
+    r"/system/sync/leader", LeaderHandler,
+    r"/system/sync/follower", FollowerHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/system_sync_indexer.py` & `xnote-web-0.1.1/handlers/system/system_sync/system_sync_indexer.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,225 +1,225 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/11/28 18:07:31
-# @modified 2022/03/18 22:13:48
-# @filename system_sync_indexer.py
-
-"""文件同步索引管理器"""
-
-import os
-import logging
-import time
-from collections import deque
-
-import xutils
-
-from xnote.core import xmanager, xconfig, xnote_event, xtables
-from xutils import Storage
-from xutils import dbutil
-from xutils import dateutil
-from xutils import fsutil
-from xutils import textutil
-from xutils.db.binlog import BinLogOpType, FileLog
-from handlers.fs.fs_helper import FileInfoDao
-
-_binlog = dbutil.BinLog.get_instance()
-
-# 临时文件
-TEMP_FNAME_SET = set([".DS_Store", ".thumbnail", ".git"])
-
-def get_system_role():
-    return xconfig.get_global_config("system.node_role")
-
-def print_debug_info(*args):
-    new_args = [dateutil.format_time(), "[fs_sync_index]"]
-    new_args += args
-    print(*new_args)
-
-def convert_time_to_str(mtime):
-    return "%020d" % (mtime * 1000)
-
-def is_temp_file(fname):
-    return fname in TEMP_FNAME_SET
-
-def build_index_by_fpath(fpath, user_id=0):
-    # TODO 如果 user_id=0 尝试根据路径推测用户
-    from handlers.fs.fs_helper import FileInfo, FileInfoDao
-    st = os.stat(fpath)
-    file_info = FileInfo()
-    file_info.fpath = fpath
-    file_info.user_id = user_id
-    file_info.fsize = fsutil.get_file_size_int(fpath)
-    file_info.mtime = xutils.format_datetime(st.st_mtime)
-    if os.path.isdir(fpath):
-        file_info.ftype = "dir"
-    else:
-        file_info.ftype = fsutil.get_file_ext(fpath)
-    FileInfoDao.upsert(file_info)
-    logging.debug("更新文件索引:%s", file_info)
-
-class FileSyncIndexManager:
-
-    # 文件队列
-    data = deque()
-    db = xtables.get_file_info_table()
-
-    def init_file_queue(self):
-        logging.debug("初始化文件队列")
-        self.data.append(xconfig.get_system_dir("files"))
-        self.data.append(xconfig.get_system_dir("storage"))
-        self.data.append(xconfig.get_system_dir("app"))
-        self.data.append(xconfig.get_system_dir("archive"))
-        self.data.append(xconfig.get_system_dir("scripts"))
-
-
-    def step(self):
-        if len(self.data) == 0:
-            self.init_file_queue()
-            return
-
-        fpath = self.data.popleft()
-        if not os.path.exists(fpath):
-            logging.error("文件不存在:%s", fpath)
-            return
-
-        if os.path.isfile(fpath):
-            build_index_by_fpath(fpath)
-
-        if os.path.isdir(fpath):
-            size = 0
-            for fname in os.listdir(fpath):
-                if is_temp_file(fname):
-                    continue
-                temp_path = os.path.join(fpath, fname)
-                self.data.append(temp_path)
-                size += 1
-
-            logging.debug("文件夹进队列 fpath:%s, size:%s", fpath, size)
-    
-
-    def build_full_index(self):
-        self.data.clear()
-        self.init_file_queue()
-        start_time = time.time()
-        while len(self.data) > 0:
-            self.step()
-        cost_time = time.time() - start_time
-        logging.info("构建索引耗时: %0.2fms", cost_time*1000)
-
-    def list_files(self, last_id = 0, offset = 0, limit = 20):
-        db = xtables.get_file_info_table()
-        result = db.select(where="id > $last_id", vars=dict(last_id=last_id), 
-                               offset=offset, limit=limit, order="id")
-        for item in result:
-            fpath = item.fpath
-            if os.path.isdir(fpath):
-                item.ftype = "dir"
-            item.webpath = fsutil.get_webpath(fpath)
-            item.fsize = fsutil.get_file_size_int(fpath)
-        return result
-
-    def count_index(self):
-        return self.db.count()
-
-class Refrence:
-
-    def __init__(self, value):
-        self.value = value
-
-class FileIndexCheckManager:
-    """索引检查器"""
-
-    last_check_time = -1
-    last_id = 0
-    db = xtables.get_table_by_name("file_info")
-
-    def check_index(self, value):
-        # type: (Storage) -> bool
-        fpath = value.fpath
-        index_id = int(value.id)
-
-        if fpath is None:
-            logging.debug("check_index:%s", "fpath为空")
-            FileInfoDao.delete_by_id(index_id)
-            return False
-        
-        if not os.path.exists(fpath):
-            logging.debug("check_index:%s", "文件不存在")
-            FileInfoDao.delete_by_id(index_id)
-            return False
-        
-        return True
-
-
-    def run_step(self):
-        where = "id > $id"
-        vars = dict(id = self.last_id)
-        file_info_list = self.db.select(where=where, vars=vars, order="id", offset=0, limit=20)
-        if len(file_info_list) == 0:
-            logging.debug("已完成一次全量检查")
-        
-        for file_info in file_info_list:
-            self.check_index(file_info)
-            self.last_id = max(self.last_id, file_info.id)
-
-        FileIndexCheckManager.last_check_time = time.time()
-
-
-@xmanager.listen(["fs.upload", "fs.update"])
-def on_fs_upload(ctx: xnote_event.FileUploadEvent):
-    logging.debug("检测到文件上传事件: %s", ctx)
-    filepath = ctx.fpath
-    if filepath == None:
-        return
-    user_id = ctx.user_id
-    build_index_by_fpath(filepath, user_id)
-
-    log_data = FileLog()
-    log_data.fpath = filepath
-    log_data.user_name = ctx.user_name
-    log_data.webpath = fsutil.get_webpath(filepath)
-    stat = os.stat(filepath)
-    log_data.mtime = stat.st_mtime
-    _binlog.add_log("file_upload", filepath, log_data, record_value=True)
-
-
-@xmanager.listen("fs.remove")
-def on_fs_remove(ctx: xnote_event.FileDeleteEvent):
-    logging.debug("检测到文件删除事件: %s", ctx)
-    from handlers.fs.fs_helper import FileInfoDao
-    FileInfoDao.delete_by_fpath(ctx.fpath)
-
-    log_data = FileLog()
-    log_data.fpath = ctx.fpath
-    log_data.user_name = ctx.user_name
-    log_data.webpath = fsutil.get_webpath(ctx.fpath)
-    _binlog.add_log(BinLogOpType.file_delete, ctx.fpath, log_data, record_value=True)
-
-
-@xmanager.listen("fs.rename")
-def on_fs_rename(ctx: xnote_event.FileRenameEvent):
-    logging.debug("检测到文件重命名事件: %s", ctx)
-    from handlers.fs.fs_helper import FileInfoDao
-
-    build_index_by_fpath(ctx.fpath, ctx.user_id)
-    FileInfoDao.delete_by_fpath(ctx.old_fpath)
-
-    log_data = FileLog()
-    log_data.fpath = ctx.fpath
-    log_data.user_name = ctx.user_name
-    log_data.webpath = fsutil.get_webpath(ctx.fpath)
-    log_data.old_webpath = fsutil.get_webpath(ctx.old_fpath)
-    _binlog.add_log(BinLogOpType.file_rename, ctx.fpath, log_data, record_value=True)
-
-
-def list_files(last_id = 0):
-    manager = FileSyncIndexManager()
-    return manager.list_files(last_id=last_id)
-
-def count_index():
-    manager = FileSyncIndexManager()
-    return manager.count_index()
-
-xutils.register_func("system_sync.list_files", list_files)
-xutils.register_func("system_sync.count_index", count_index)
-
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/11/28 18:07:31
+# @modified 2022/03/18 22:13:48
+# @filename system_sync_indexer.py
+
+"""文件同步索引管理器"""
+
+import os
+import logging
+import time
+from collections import deque
+
+import xutils
+
+from xnote.core import xmanager, xconfig, xnote_event, xtables
+from xutils import Storage
+from xutils import dbutil
+from xutils import dateutil
+from xutils import fsutil
+from xutils import textutil
+from xutils.db.binlog import BinLogOpType, FileLog
+from handlers.fs.fs_helper import FileInfoDao
+
+_binlog = dbutil.BinLog.get_instance()
+
+# 临时文件
+TEMP_FNAME_SET = set([".DS_Store", ".thumbnail", ".git"])
+
+def get_system_role():
+    return xconfig.get_global_config("system.node_role")
+
+def print_debug_info(*args):
+    new_args = [dateutil.format_time(), "[fs_sync_index]"]
+    new_args += args
+    print(*new_args)
+
+def convert_time_to_str(mtime):
+    return "%020d" % (mtime * 1000)
+
+def is_temp_file(fname):
+    return fname in TEMP_FNAME_SET
+
+def build_index_by_fpath(fpath, user_id=0):
+    # TODO 如果 user_id=0 尝试根据路径推测用户
+    from handlers.fs.fs_helper import FileInfo, FileInfoDao
+    st = os.stat(fpath)
+    file_info = FileInfo()
+    file_info.fpath = fpath
+    file_info.user_id = user_id
+    file_info.fsize = fsutil.get_file_size_int(fpath)
+    file_info.mtime = xutils.format_datetime(st.st_mtime)
+    if os.path.isdir(fpath):
+        file_info.ftype = "dir"
+    else:
+        file_info.ftype = fsutil.get_file_ext(fpath)
+    FileInfoDao.upsert(file_info)
+    logging.debug("更新文件索引:%s", file_info)
+
+class FileSyncIndexManager:
+
+    # 文件队列
+    data = deque()
+    db = xtables.get_file_info_table()
+
+    def init_file_queue(self):
+        logging.debug("初始化文件队列")
+        self.data.append(xconfig.get_system_dir("files"))
+        self.data.append(xconfig.get_system_dir("storage"))
+        self.data.append(xconfig.get_system_dir("app"))
+        self.data.append(xconfig.get_system_dir("archive"))
+        self.data.append(xconfig.get_system_dir("scripts"))
+
+
+    def step(self):
+        if len(self.data) == 0:
+            self.init_file_queue()
+            return
+
+        fpath = self.data.popleft()
+        if not os.path.exists(fpath):
+            logging.error("文件不存在:%s", fpath)
+            return
+
+        if os.path.isfile(fpath):
+            build_index_by_fpath(fpath)
+
+        if os.path.isdir(fpath):
+            size = 0
+            for fname in os.listdir(fpath):
+                if is_temp_file(fname):
+                    continue
+                temp_path = os.path.join(fpath, fname)
+                self.data.append(temp_path)
+                size += 1
+
+            logging.debug("文件夹进队列 fpath:%s, size:%s", fpath, size)
+    
+
+    def build_full_index(self):
+        self.data.clear()
+        self.init_file_queue()
+        start_time = time.time()
+        while len(self.data) > 0:
+            self.step()
+        cost_time = time.time() - start_time
+        logging.info("构建索引耗时: %0.2fms", cost_time*1000)
+
+    def list_files(self, last_id = 0, offset = 0, limit = 20):
+        db = xtables.get_file_info_table()
+        result = db.select(where="id > $last_id", vars=dict(last_id=last_id), 
+                               offset=offset, limit=limit, order="id")
+        for item in result:
+            fpath = item.fpath
+            if os.path.isdir(fpath):
+                item.ftype = "dir"
+            item.webpath = fsutil.get_webpath(fpath)
+            item.fsize = fsutil.get_file_size_int(fpath)
+        return result
+
+    def count_index(self):
+        return self.db.count()
+
+class Refrence:
+
+    def __init__(self, value):
+        self.value = value
+
+class FileIndexCheckManager:
+    """索引检查器"""
+
+    last_check_time = -1
+    last_id = 0
+    db = xtables.get_table_by_name("file_info")
+
+    def check_index(self, value):
+        # type: (Storage) -> bool
+        fpath = value.fpath
+        index_id = int(value.id)
+
+        if fpath is None:
+            logging.debug("check_index:%s", "fpath为空")
+            FileInfoDao.delete_by_id(index_id)
+            return False
+        
+        if not os.path.exists(fpath):
+            logging.debug("check_index:%s", "文件不存在")
+            FileInfoDao.delete_by_id(index_id)
+            return False
+        
+        return True
+
+
+    def run_step(self):
+        where = "id > $id"
+        vars = dict(id = self.last_id)
+        file_info_list = self.db.select(where=where, vars=vars, order="id", offset=0, limit=20)
+        if len(file_info_list) == 0:
+            logging.debug("已完成一次全量检查")
+        
+        for file_info in file_info_list:
+            self.check_index(file_info)
+            self.last_id = max(self.last_id, file_info.id)
+
+        FileIndexCheckManager.last_check_time = time.time()
+
+
+@xmanager.listen(["fs.upload", "fs.update"])
+def on_fs_upload(ctx: xnote_event.FileUploadEvent):
+    logging.debug("检测到文件上传事件: %s", ctx)
+    filepath = ctx.fpath
+    if filepath == None:
+        return
+    user_id = ctx.user_id
+    build_index_by_fpath(filepath, user_id)
+
+    log_data = FileLog()
+    log_data.fpath = filepath
+    log_data.user_name = ctx.user_name
+    log_data.webpath = fsutil.get_webpath(filepath)
+    stat = os.stat(filepath)
+    log_data.mtime = stat.st_mtime
+    _binlog.add_log("file_upload", filepath, log_data, record_value=True)
+
+
+@xmanager.listen("fs.remove")
+def on_fs_remove(ctx: xnote_event.FileDeleteEvent):
+    logging.debug("检测到文件删除事件: %s", ctx)
+    from handlers.fs.fs_helper import FileInfoDao
+    FileInfoDao.delete_by_fpath(ctx.fpath)
+
+    log_data = FileLog()
+    log_data.fpath = ctx.fpath
+    log_data.user_name = ctx.user_name
+    log_data.webpath = fsutil.get_webpath(ctx.fpath)
+    _binlog.add_log(BinLogOpType.file_delete, ctx.fpath, log_data, record_value=True)
+
+
+@xmanager.listen("fs.rename")
+def on_fs_rename(ctx: xnote_event.FileRenameEvent):
+    logging.debug("检测到文件重命名事件: %s", ctx)
+    from handlers.fs.fs_helper import FileInfoDao
+
+    build_index_by_fpath(ctx.fpath, ctx.user_id)
+    FileInfoDao.delete_by_fpath(ctx.old_fpath)
+
+    log_data = FileLog()
+    log_data.fpath = ctx.fpath
+    log_data.user_name = ctx.user_name
+    log_data.webpath = fsutil.get_webpath(ctx.fpath)
+    log_data.old_webpath = fsutil.get_webpath(ctx.old_fpath)
+    _binlog.add_log(BinLogOpType.file_rename, ctx.fpath, log_data, record_value=True)
+
+
+def list_files(last_id = 0):
+    manager = FileSyncIndexManager()
+    return manager.list_files(last_id=last_id)
+
+def count_index():
+    manager = FileSyncIndexManager()
+    return manager.count_index()
+
+xutils.register_func("system_sync.list_files", list_files)
+xutils.register_func("system_sync.count_index", count_index)
+
```

### Comparing `xnote-web-0.1.0/handlers/system/system_sync/system_sync_proxy.py` & `xnote-web-0.1.1/handlers/system/system_sync/system_sync_proxy.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,297 +1,297 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2021/11/29 22:48:26
-@LastEditors  : xupingmao
-@LastEditTime : 2023-11-18 15:19:04
-@FilePath     : /xnote/handlers/system/system_sync/system_sync_proxy.py
-@Description  : 网络代理
-"""
-
-import os
-import time
-import logging
-
-import xutils
-from xnote.core import xconfig
-
-from xutils import Storage
-from xutils import netutil
-from xutils import textutil
-from xutils import dateutil
-from xutils import fsutil
-from xutils import dbutil
-from xutils.six.moves.urllib.parse import quote
-from xutils.mem_util import log_mem_info_deco
-from .models import FileIndexInfo
-from .system_sync_indexer import build_index_by_fpath
-
-RETRY_INTERVAL = 60
-MAX_KEY_SIZE = 511
-
-dbutil.register_table("fs_sync_index_copy", "文件索引拷贝")
-dbutil.register_table("fs_sync_index_failed", "文件索引拷贝失败")
-
-def print_debug_info(*args):
-    new_args = [dateutil.format_time(), "[system_sync_http]"]
-    new_args += args
-    print(*new_args)
-
-class HttpClient:
-
-    def __init__(self, host, token, admin_token):
-        self.host = host
-        self.token = token
-        self.admin_token = admin_token
-        self.debug = True
-
-    def get_table(self):
-        return dbutil.get_hash_table("fs_sync_index_copy")
-
-    def get_failed_table(self):
-        return dbutil.get_table("fs_sync_index_failed")
-
-    def delete_retry_task(self, item):
-        db = self.get_failed_table()
-        result = db.list(filter_func = lambda k,x:x.webpath==item.webpath)
-        for result_item in result:
-            db.delete(result_item)
-    
-    def upsert_retry_task(self, item):
-        db = self.get_failed_table()
-        first = db.get_first(where = dict(webpath=item.webpath))
-        if first == None:
-            db.insert(item)
-        else:
-            db.update_by_key(first._key, item)
-
-    def check_failed(self):
-        if self.host is None:
-            logging.warning("host为空")
-            return True
-
-        return False
-
-    def get_stat(self, params):
-        self.check_disk_space()
-        if self.check_failed():
-            return
-
-        params["token"] = self.token
-
-        url = "{host}/system/sync/leader?p=get_stat".format(host = self.host)
-        result = netutil.http_get(url, params = params, skip_empty_value = True)
-        result_obj = textutil.parse_json(result, ignore_error = True)
-        return result_obj    
-
-    def list_files(self, last_id=0):
-        if self.check_failed():
-            return
-
-        last_id_str = str(last_id)
-        url = "{host}/system/sync/leader?p=list_files&token={token}&last_id={last_id}".format(
-            host = self.host, token = self.token, last_id = last_id_str)
-        
-        if self.debug:
-            logging.info("sync_from_leader: %s", url)
-
-        content = netutil.http_get(url)
-        result = textutil.parse_json(content, ignore_error = True)
-        
-        if result is None:
-            error = Storage()
-            error.url = url
-            error.content = content
-            print_debug_info("接口返回为空", error)
-            return
-
-        result = Storage(**result)
-        if result.code != "success":
-            print_debug_info("接口请求失败", result)
-
-        follower_dict = result.get("follower_dict", {})
-        for url in follower_dict:
-            info = follower_dict.get(url)
-            self.admin_token = info.get("admin_token")
-
-        return result
-
-    def is_same_file(self, dest_path, item: FileIndexInfo):
-        if not os.path.exists(dest_path):
-            return False
-
-        stat = os.stat(dest_path)
-        remote_mtime = item.mtime
-        local_mtime = xutils.format_datetime(stat.st_mtime)
-        is_same_file = (item.fsize == stat.st_size and remote_mtime == local_mtime)
-        logging.debug("远程文件: %s, 本地文件: %s, is_same_file: %s", (remote_mtime, item.fsize), 
-                      (local_mtime, stat.st_size), is_same_file)
-        return is_same_file
-
-    def check_disk_space(self):
-        data_dir = xconfig.get_system_dir("data")
-        free_space = fsutil.get_free_space(data_dir)
-        result = free_space >= 1024 ** 3 # 要大于1G
-
-        if not result:
-            logging.debug("磁盘容量不足, 当前容量:%s", fsutil.format_size(free_space))
-
-        return result
-    
-    def is_ignore_file(self, webpath):
-        skip_dir_list = ["/data/db", "/data/tmp", "/data/log", "/data/backup", "/data/cache", "/data/trash"]
-        for skip_dir in skip_dir_list:
-            if fsutil.is_parent_dir(skip_dir, webpath):
-                return True
-        return False
-    
-    def is_invalid_file(self, webpath=""):
-        if xutils.is_windows():
-            invalid_list = ":?"
-            for item in invalid_list:
-                if item in webpath:
-                    return True
-        return False
-    
-    def get_dest_path(self, webpath=""):
-        data_dir  = xconfig.FileConfig.data_dir
-        temp_path = fsutil.get_relative_path(webpath, "/data/")
-        path = os.path.join(data_dir, temp_path)
-        return os.path.abspath(path)
-
-    def download_file(self, item: FileIndexInfo):
-        if self.admin_token is None:
-            logging.warn("admin_token为空，跳过")
-            raise Exception("admin_token为空")
-
-        if not self.check_disk_space():
-            logging.error("磁盘容量不足，跳过")
-            raise Exception("磁盘容量不足")
-        
-        if item.ftype == "dir":
-            logging.info("跳过目录, dir=%s", item.fpath)
-            return
-        
-        # 数据库文件不能下载
-        if self.is_ignore_file(item.webpath):
-            logging.info("跳过系统/临时文件, fpath=%s", item.fpath)
-            return
-
-        fpath = item.fpath
-        webpath = item.webpath
-
-        if isinstance(item.mtime, float):
-            mtime = item.mtime
-        else:
-            try:
-                mtime = dateutil.parse_datetime(item.mtime)
-            except:
-                mtime = time.time()
-        
-        # 先保存失败记录，成功后再删除
-        self.upsert_retry_task(item)
-
-        table = self.get_table()
-        item.last_try_time = time.time()
-        
-        try:
-            # 文件名太长会导致保存失败
-            # 保存文件索引信息
-            table.put(webpath, item)
-        except:
-            item.err_msg = xutils.print_exc()
-            self.upsert_retry_task(item)
-
-        encoded_fpath = xutils.urlsafe_b64encode(fpath)
-        url = "{host}/fs_download".format(host = self.host)
-        params = dict(token = self.admin_token, fpath = encoded_fpath)
-        url = netutil._join_url_and_params(url, params)
-
-        dest_path = self.get_dest_path(webpath)
-        dirname   = os.path.dirname(dest_path)
-
-        if self.is_same_file(dest_path, item):
-            logging.debug("文件没有变化，跳过:%s", webpath)
-            self.delete_retry_task(item)
-            return
-
-        fsutil.makedirs(dirname)
-
-        logging.debug("原始文件:%s", url)
-        logging.debug("目标文件:%s", dest_path)
-
-        try:
-            netutil.http_download(url, dest_path)
-            os.utime(dest_path, times=(mtime, mtime))
-            self.delete_retry_task(item)
-            build_index_by_fpath(dest_path)
-        except:
-            item.err_msg = xutils.print_exc()
-            self.upsert_retry_task(item)
-            logging.error("下载文件失败:%s", dest_path)
-
-    def download_files(self, result):
-        for item in result.data:
-            self.download_file(FileIndexInfo(**item))
-
-    def retry_failed(self):
-        """TODO 这个应该是调度层的"""
-        for item_raw in self.get_failed_table().iter(limit = -1):
-            now = time.time()
-            item = FileIndexInfo(**item_raw)
-            if (now - item.last_try_time) < RETRY_INTERVAL:
-                continue
-
-            dest_path = self.get_dest_path(item.webpath) 
-            if xutils.is_windows() and len(dest_path) >= fsutil.WIN_MAXPATH:
-                logging.info("文件名过长, 取消重试, item=%s", item)
-                self.get_failed_table().delete(item_raw)
-                continue
-
-            if self.is_invalid_file(item.webpath):
-                logging.info("无效的文件名, item=%s", item)
-                self.get_failed_table().delete(item_raw)
-                continue
-
-            if self.is_ignore_file(item.webpath):
-                logging.info("忽略的文件, item=%s", item)
-                self.get_failed_table().delete(item_raw)
-                continue
-
-            logging.debug("正在重试:%s", item)
-            self.download_file(item)
-
-    @log_mem_info_deco("proxy.http_get")
-    def http_get(self, url, params=None):
-        return netutil.http_get(url, params=params)
-
-    @log_mem_info_deco("proxy.list_binlog")
-    def list_binlog(self, last_seq=0) -> dict:
-        assert isinstance(last_seq, int)
-        params = dict(last_seq=str(last_seq), include_req_seq="false")
-
-        leader_host = self.host
-        leader_token = self.token
-        url = "{host}/system/sync/leader?p=list_binlog&token={token}".format(
-            host=leader_host, token=leader_token)
-        
-        result = self.http_get(url, params=params)
-        try:
-            result_obj = textutil.parse_json(result)
-            assert isinstance(result_obj, dict)
-            return result_obj
-        except:
-            logging.error("解析json失败, result=%s", result)
-            raise Exception("解析JSON失败")
-    
-    def list_db(self, last_key):
-        # type: (str) -> str
-        leader_token = self.token
-        leader_host = self.host
-        params = dict(last_key=last_key, token=leader_token)
-        url = "{host}/system/sync/leader?p=list_db".format(host=leader_host)
-        return netutil.http_get(url, params=params)
-
-
-empty_http_client = HttpClient("", "", "")
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2021/11/29 22:48:26
+@LastEditors  : xupingmao
+@LastEditTime : 2023-11-18 15:19:04
+@FilePath     : /xnote/handlers/system/system_sync/system_sync_proxy.py
+@Description  : 网络代理
+"""
+
+import os
+import time
+import logging
+
+import xutils
+from xnote.core import xconfig
+
+from xutils import Storage
+from xutils import netutil
+from xutils import textutil
+from xutils import dateutil
+from xutils import fsutil
+from xutils import dbutil
+from xutils.six.moves.urllib.parse import quote
+from xutils.mem_util import log_mem_info_deco
+from .models import FileIndexInfo
+from .system_sync_indexer import build_index_by_fpath
+
+RETRY_INTERVAL = 60
+MAX_KEY_SIZE = 511
+
+dbutil.register_table("fs_sync_index_copy", "文件索引拷贝")
+dbutil.register_table("fs_sync_index_failed", "文件索引拷贝失败")
+
+def print_debug_info(*args):
+    new_args = [dateutil.format_time(), "[system_sync_http]"]
+    new_args += args
+    print(*new_args)
+
+class HttpClient:
+
+    def __init__(self, host, token, admin_token):
+        self.host = host
+        self.token = token
+        self.admin_token = admin_token
+        self.debug = True
+
+    def get_table(self):
+        return dbutil.get_hash_table("fs_sync_index_copy")
+
+    def get_failed_table(self):
+        return dbutil.get_table("fs_sync_index_failed")
+
+    def delete_retry_task(self, item):
+        db = self.get_failed_table()
+        result = db.list(filter_func = lambda k,x:x.webpath==item.webpath)
+        for result_item in result:
+            db.delete(result_item)
+    
+    def upsert_retry_task(self, item):
+        db = self.get_failed_table()
+        first = db.get_first(where = dict(webpath=item.webpath))
+        if first == None:
+            db.insert(item)
+        else:
+            db.update_by_key(first._key, item)
+
+    def check_failed(self):
+        if self.host is None:
+            logging.warning("host为空")
+            return True
+
+        return False
+
+    def get_stat(self, params):
+        self.check_disk_space()
+        if self.check_failed():
+            return
+
+        params["token"] = self.token
+
+        url = "{host}/system/sync/leader?p=get_stat".format(host = self.host)
+        result = netutil.http_get(url, params = params, skip_empty_value = True)
+        result_obj = textutil.parse_json(result, ignore_error = True)
+        return result_obj    
+
+    def list_files(self, last_id=0):
+        if self.check_failed():
+            return
+
+        last_id_str = str(last_id)
+        url = "{host}/system/sync/leader?p=list_files&token={token}&last_id={last_id}".format(
+            host = self.host, token = self.token, last_id = last_id_str)
+        
+        if self.debug:
+            logging.info("sync_from_leader: %s", url)
+
+        content = netutil.http_get(url)
+        result = textutil.parse_json(content, ignore_error = True)
+        
+        if result is None:
+            error = Storage()
+            error.url = url
+            error.content = content
+            print_debug_info("接口返回为空", error)
+            return
+
+        result = Storage(**result)
+        if result.code != "success":
+            print_debug_info("接口请求失败", result)
+
+        follower_dict = result.get("follower_dict", {})
+        for url in follower_dict:
+            info = follower_dict.get(url)
+            self.admin_token = info.get("admin_token")
+
+        return result
+
+    def is_same_file(self, dest_path, item: FileIndexInfo):
+        if not os.path.exists(dest_path):
+            return False
+
+        stat = os.stat(dest_path)
+        remote_mtime = item.mtime
+        local_mtime = xutils.format_datetime(stat.st_mtime)
+        is_same_file = (item.fsize == stat.st_size and remote_mtime == local_mtime)
+        logging.debug("远程文件: %s, 本地文件: %s, is_same_file: %s", (remote_mtime, item.fsize), 
+                      (local_mtime, stat.st_size), is_same_file)
+        return is_same_file
+
+    def check_disk_space(self):
+        data_dir = xconfig.get_system_dir("data")
+        free_space = fsutil.get_free_space(data_dir)
+        result = free_space >= 1024 ** 3 # 要大于1G
+
+        if not result:
+            logging.debug("磁盘容量不足, 当前容量:%s", fsutil.format_size(free_space))
+
+        return result
+    
+    def is_ignore_file(self, webpath):
+        skip_dir_list = ["/data/db", "/data/tmp", "/data/log", "/data/backup", "/data/cache", "/data/trash"]
+        for skip_dir in skip_dir_list:
+            if fsutil.is_parent_dir(skip_dir, webpath):
+                return True
+        return False
+    
+    def is_invalid_file(self, webpath=""):
+        if xutils.is_windows():
+            invalid_list = ":?"
+            for item in invalid_list:
+                if item in webpath:
+                    return True
+        return False
+    
+    def get_dest_path(self, webpath=""):
+        data_dir  = xconfig.FileConfig.data_dir
+        temp_path = fsutil.get_relative_path(webpath, "/data/")
+        path = os.path.join(data_dir, temp_path)
+        return os.path.abspath(path)
+
+    def download_file(self, item: FileIndexInfo):
+        if self.admin_token is None:
+            logging.warn("admin_token为空，跳过")
+            raise Exception("admin_token为空")
+
+        if not self.check_disk_space():
+            logging.error("磁盘容量不足，跳过")
+            raise Exception("磁盘容量不足")
+        
+        if item.ftype == "dir":
+            logging.info("跳过目录, dir=%s", item.fpath)
+            return
+        
+        # 数据库文件不能下载
+        if self.is_ignore_file(item.webpath):
+            logging.info("跳过系统/临时文件, fpath=%s", item.fpath)
+            return
+
+        fpath = item.fpath
+        webpath = item.webpath
+
+        if isinstance(item.mtime, float):
+            mtime = item.mtime
+        else:
+            try:
+                mtime = dateutil.parse_datetime(item.mtime)
+            except:
+                mtime = time.time()
+        
+        # 先保存失败记录，成功后再删除
+        self.upsert_retry_task(item)
+
+        table = self.get_table()
+        item.last_try_time = time.time()
+        
+        try:
+            # 文件名太长会导致保存失败
+            # 保存文件索引信息
+            table.put(webpath, item)
+        except:
+            item.err_msg = xutils.print_exc()
+            self.upsert_retry_task(item)
+
+        encoded_fpath = xutils.urlsafe_b64encode(fpath)
+        url = "{host}/fs_download".format(host = self.host)
+        params = dict(token = self.admin_token, fpath = encoded_fpath)
+        url = netutil._join_url_and_params(url, params)
+
+        dest_path = self.get_dest_path(webpath)
+        dirname   = os.path.dirname(dest_path)
+
+        if self.is_same_file(dest_path, item):
+            logging.debug("文件没有变化，跳过:%s", webpath)
+            self.delete_retry_task(item)
+            return
+
+        fsutil.makedirs(dirname)
+
+        logging.debug("原始文件:%s", url)
+        logging.debug("目标文件:%s", dest_path)
+
+        try:
+            netutil.http_download(url, dest_path)
+            os.utime(dest_path, times=(mtime, mtime))
+            self.delete_retry_task(item)
+            build_index_by_fpath(dest_path)
+        except:
+            item.err_msg = xutils.print_exc()
+            self.upsert_retry_task(item)
+            logging.error("下载文件失败:%s", dest_path)
+
+    def download_files(self, result):
+        for item in result.data:
+            self.download_file(FileIndexInfo(**item))
+
+    def retry_failed(self):
+        """TODO 这个应该是调度层的"""
+        for item_raw in self.get_failed_table().iter(limit = -1):
+            now = time.time()
+            item = FileIndexInfo(**item_raw)
+            if (now - item.last_try_time) < RETRY_INTERVAL:
+                continue
+
+            dest_path = self.get_dest_path(item.webpath) 
+            if xutils.is_windows() and len(dest_path) >= fsutil.WIN_MAXPATH:
+                logging.info("文件名过长, 取消重试, item=%s", item)
+                self.get_failed_table().delete(item_raw)
+                continue
+
+            if self.is_invalid_file(item.webpath):
+                logging.info("无效的文件名, item=%s", item)
+                self.get_failed_table().delete(item_raw)
+                continue
+
+            if self.is_ignore_file(item.webpath):
+                logging.info("忽略的文件, item=%s", item)
+                self.get_failed_table().delete(item_raw)
+                continue
+
+            logging.debug("正在重试:%s", item)
+            self.download_file(item)
+
+    @log_mem_info_deco("proxy.http_get")
+    def http_get(self, url, params=None):
+        return netutil.http_get(url, params=params)
+
+    @log_mem_info_deco("proxy.list_binlog")
+    def list_binlog(self, last_seq=0) -> dict:
+        assert isinstance(last_seq, int)
+        params = dict(last_seq=str(last_seq), include_req_seq="false")
+
+        leader_host = self.host
+        leader_token = self.token
+        url = "{host}/system/sync/leader?p=list_binlog&token={token}".format(
+            host=leader_host, token=leader_token)
+        
+        result = self.http_get(url, params=params)
+        try:
+            result_obj = textutil.parse_json(result)
+            assert isinstance(result_obj, dict)
+            return result_obj
+        except:
+            logging.error("解析json失败, result=%s", result)
+            raise Exception("解析JSON失败")
+    
+    def list_db(self, last_key):
+        # type: (str) -> str
+        leader_token = self.token
+        leader_host = self.host
+        params = dict(last_key=last_key, token=leader_token)
+        url = "{host}/system/sync/leader?p=list_db".format(host=leader_host)
+        return netutil.http_get(url, params=params)
+
+
+empty_http_client = HttpClient("", "", "")
```

### Comparing `xnote-web-0.1.0/handlers/system/template_cache.py` & `xnote-web-0.1.1/handlers/system/template_cache.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/system/thread_info.py` & `xnote-web-0.1.1/handlers/system/thread_info.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/component/example_nav.html` & `xnote-web-0.1.1/handlers/test/component/example_nav.html`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,30 +1,30 @@
-{# <!--
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-04-17 11:52:32
-@LastEditors  : xupingmao
-@LastEditTime : 2022-05-06 12:52:29
-@FilePath     : /xnote/handlers/test/component/example_nav.html
-@Description  : 描述
---> #}
-<div class="card">
-	<div class="card-title">
-		<span>组件示例</span>
-	</div>
-</div>
-
-<div class="card">
-	<div class="x-tab-box btn-style dark" 
-			data-tab-key="name" 
-			data-auto-href="true"
-			data-tab-default="index">
-		<span class="float-left btn-line-height">案例:&nbsp;</span>
-		<a class="x-tab" data-tab-value="btn">按钮示例</a>
-		<a class="x-tab" data-tab-value="tab">Tab示例</a>
-		<a class="x-tab" data-tab-value="tag">tag示例</a>
-		<a class="x-tab" data-tab-value="dialog">Dialog示例</a>
-	    <a class="x-tab" data-tab-value="dropdown">Dropdown示例</a>
-		<a class="x-tab" data-tab-value="table" href="/test/example/table">table示例</a>
-	   	<a class="x-tab" data-tab-value="hammer">Hammer示例</a>
-	</div>
-</div>
+{# <!--
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-04-17 11:52:32
+@LastEditors  : xupingmao
+@LastEditTime : 2022-05-06 12:52:29
+@FilePath     : /xnote/handlers/test/component/example_nav.html
+@Description  : 描述
+--> #}
+<div class="card">
+	<div class="card-title">
+		<span>组件示例</span>
+	</div>
+</div>
+
+<div class="card">
+	<div class="x-tab-box btn-style dark" 
+			data-tab-key="name" 
+			data-auto-href="true"
+			data-tab-default="index">
+		<span class="float-left btn-line-height">案例:&nbsp;</span>
+		<a class="x-tab" data-tab-value="btn">按钮示例</a>
+		<a class="x-tab" data-tab-value="tab">Tab示例</a>
+		<a class="x-tab" data-tab-value="tag">tag示例</a>
+		<a class="x-tab" data-tab-value="dialog">Dialog示例</a>
+	    <a class="x-tab" data-tab-value="dropdown">Dropdown示例</a>
+		<a class="x-tab" data-tab-value="table" href="/test/example/table">table示例</a>
+	   	<a class="x-tab" data-tab-value="hammer">Hammer示例</a>
+	</div>
+</div>
```

### Comparing `xnote-web-0.1.0/handlers/test/page/example_btn.html` & `xnote-web-0.1.1/handlers/test/page/example_btn.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/page/example_dialog.html` & `xnote-web-0.1.1/handlers/test/page/example_dialog.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/page/example_dropdown.html` & `xnote-web-0.1.1/handlers/test/page/example_dropdown.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/page/example_hammer.html` & `xnote-web-0.1.1/handlers/test/page/example_hammer.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/page/example_tab.html` & `xnote-web-0.1.1/handlers/test/page/example_tab.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/page/example_tag.html` & `xnote-web-0.1.1/handlers/test/page/example_tag.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/test/test_dbutil_handler.py` & `xnote-web-0.1.1/handlers/test/test_dbutil_handler.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/barcode.html` & `xnote-web-0.1.1/handlers/tools/barcode.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/base64.html` & `xnote-web-0.1.1/handlers/tools/base64.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/browser_info.html` & `xnote-web-0.1.1/handlers/tools/browser_info.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/camera.html` & `xnote-web-0.1.1/handlers/tools/camera.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/chat_demo.html` & `xnote-web-0.1.1/handlers/tools/chat_demo.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/code_template.html` & `xnote-web-0.1.1/handlers/tools/code_template.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/color.html` & `xnote-web-0.1.1/handlers/tools/color.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/datetime.html` & `xnote-web-0.1.1/handlers/tools/datetime.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/hex.html` & `xnote-web-0.1.1/handlers/tools/hex.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/img2gray.html` & `xnote-web-0.1.1/handlers/tools/img2gray.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/img_merge.html` & `xnote-web-0.1.1/handlers/tools/img_merge.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/img_split.html` & `xnote-web-0.1.1/handlers/tools/img_split.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/md5.html` & `xnote-web-0.1.1/handlers/tools/md5.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/multi_win.html` & `xnote-web-0.1.1/handlers/tools/multi_win.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/notebook.html` & `xnote-web-0.1.1/handlers/tools/notebook.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/port_scanner.py` & `xnote-web-0.1.1/handlers/tools/port_scanner.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/qrcode.html` & `xnote-web-0.1.1/handlers/tools/qrcode.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/random_string.html` & `xnote-web-0.1.1/handlers/tools/random_string.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/responsive.html` & `xnote-web-0.1.1/handlers/tools/responsive.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/runjs.html` & `xnote-web-0.1.1/handlers/tools/runjs.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/search_compare.html` & `xnote-web-0.1.1/handlers/tools/search_compare.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/sha1.html` & `xnote-web-0.1.1/handlers/tools/sha1.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/shell.html` & `xnote-web-0.1.1/handlers/tools/shell.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/speech_recognition.html` & `xnote-web-0.1.1/handlers/tools/speech_recognition.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/tcc.html` & `xnote-web-0.1.1/handlers/tools/tcc.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/terminal.html` & `xnote-web-0.1.1/handlers/tools/terminal.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/text_convert.html` & `xnote-web-0.1.1/handlers/tools/text_convert.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/text_diff.html` & `xnote-web-0.1.1/handlers/tools/text_diff.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/text_set.html` & `xnote-web-0.1.1/handlers/tools/text_set.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/tools.py` & `xnote-web-0.1.1/handlers/tools/tools.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/urlcoder.html` & `xnote-web-0.1.1/handlers/tools/urlcoder.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/vue_test.html` & `xnote-web-0.1.1/handlers/tools/vue_test.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/tools/webuploader.html` & `xnote-web-0.1.1/handlers/tools/webuploader.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/component/user_script.html` & `xnote-web-0.1.1/handlers/user/component/user_script.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/login.py` & `xnote-web-0.1.1/handlers/user/login.py`

 * *Ordering differences only*

 * *Files 22% similar despite different names*

```diff
@@ -1,160 +1,160 @@
-# encoding=utf-8
-# @modified 2022/04/06 12:39:18
-import web
-import xutils
-from xnote.core import xauth
-from xnote.core import xtemplate
-from xutils import cacheutil, dbutil
-from xutils import Storage
-from xutils import webutil
-import json
-
-from . import dao as user_dao
-
-RETRY_LIMIT = 3
-_login_failed_count = cacheutil.PrefixedCache("login_failed_count:")
-
-def get_real_ip():
-    return webutil.get_real_ip()
-
-
-def save_login_info(name, error=None):
-    if name != "":
-        real_ip = get_real_ip()
-        detail = "登录IP: %s" % real_ip
-        if error != None:
-            detail += ",登录失败:%s" % error
-        user_id = xauth.UserDao.get_id_by_name(name)
-        if user_id == 0:
-            user_id = -1
-            detail += f",login_name:{name}"
-        
-        log = user_dao.UserOpLog()
-        log.detail = detail
-        log.type = user_dao.UserOpTypeEnum.login.value
-        log.user_id = user_id
-        log.ip = real_ip
-        user_dao.UserOpLogDao.create_op_log(log)
-
-
-def save_login_error_count(name, count):
-    _login_failed_count.put(name, count, 60)
-
-
-class LoginHandler:
-
-    def POST(self):
-        name = xutils.get_argument_str("username", "")
-        pswd = xutils.get_argument_str("password", "")
-        error = self.do_login(name, pswd)
-        return xtemplate.render("user/page/login.html",
-                                show_aside=False,
-                                username=name,
-                                password=pswd,
-                                error=error)
-
-    def GET(self):
-        return xtemplate.render("user/page/login.html",
-                                show_aside=False,
-                                show_nav=False,
-                                username="",
-                                password="",
-                                error="")
-
-    def do_login(self, name, pswd):
-        target = xutils.get_argument_str("target")
-        return self.do_login_with_redirect(name,pswd,target)
-
-
-    def do_login_with_redirect(self,name, pswd, target=""):
-        error = self.do_login_with_error(name, pswd)
-        if error == "":
-            if target == "":
-                target = "/"
-            raise web.found(target)
-        return error
-
-    def do_login_with_error(self, name, pswd, count=0):
-        name = name.strip()
-        pswd = pswd.strip()
-        count = _login_failed_count.get(name, 0)
-        assert isinstance(count, int)
-        error = ""
-        if name == "":
-            error = "请输入登录名"
-        elif pswd == "":
-            error = "请输入密码"
-        elif count >= RETRY_LIMIT:
-            error = "重试次数过多"
-
-        if error != "":
-            return error
-
-        user = xauth.get_user_by_name(name)
-
-        if user == None:
-            error = "用户名或密码错误"
-            save_login_info(name, error)
-            save_login_error_count(name, count + 1)
-            return error
-        else:
-            if xauth.encode_password(pswd, user.salt) == user.password_md5:
-                save_login_info(name)
-
-                try:
-                    xauth.login_user_by_name(name, login_ip=get_real_ip())
-                    return "" # 登录成功
-                except Exception as e:
-                    xutils.print_exc()
-                    return str(e)
-            else:
-                error = "用户名或密码错误"
-                save_login_info(name, error)
-                save_login_error_count(name, count + 1)
-        return error
-
-
-
-class LoginAjaxHandler:
-    def POST(self):
-        request_data = str(web.data(),'UTF-8')
-        request_json = json.loads(request_data)
-        name = request_json["username"]
-        pswd = request_json["password"]
-
-        hander = LoginHandler()
-        error = hander.do_login_with_error(name,pswd)
-
-        response = {}
-        if ( error == ""):
-            response['success'] = True
-        else:
-            response['success']  = False
-            response['error']  = error
-        return json.dumps(response)
-
-class NewAccountLoginHandler:
-    def POST(self):
-        request_data = str(web.data(),'UTF-8')
-        print("enter login "+request_data)
-        request_json = json.loads(request_data)
-        name = request_json["username"]
-        pswd = request_json["password"]
-
-        hander = LoginHandler()
-        error = hander.do_login_with_error(name,pswd)
-
-        response = {}
-        response["type"] = "account"
-        if ( error == ""):
-            response['status'] = "ok"
-        else:
-            response['status']  = "error"
-            response['errorMsg']  = error
-        return json.dumps(response)
-
-xurls = (
-    r"/login", LoginHandler,
-    r"/login_ajax", LoginAjaxHandler,
-    r"/login/account_login", NewAccountLoginHandler
-)
+# encoding=utf-8
+# @modified 2022/04/06 12:39:18
+import web
+import xutils
+from xnote.core import xauth
+from xnote.core import xtemplate
+from xutils import cacheutil, dbutil
+from xutils import Storage
+from xutils import webutil
+import json
+
+from . import dao as user_dao
+
+RETRY_LIMIT = 3
+_login_failed_count = cacheutil.PrefixedCache("login_failed_count:")
+
+def get_real_ip():
+    return webutil.get_real_ip()
+
+
+def save_login_info(name, error=None):
+    if name != "":
+        real_ip = get_real_ip()
+        detail = "登录IP: %s" % real_ip
+        if error != None:
+            detail += ",登录失败:%s" % error
+        user_id = xauth.UserDao.get_id_by_name(name)
+        if user_id == 0:
+            user_id = -1
+            detail += f",login_name:{name}"
+        
+        log = user_dao.UserOpLog()
+        log.detail = detail
+        log.type = user_dao.UserOpTypeEnum.login.value
+        log.user_id = user_id
+        log.ip = real_ip
+        user_dao.UserOpLogDao.create_op_log(log)
+
+
+def save_login_error_count(name, count):
+    _login_failed_count.put(name, count, 60)
+
+
+class LoginHandler:
+
+    def POST(self):
+        name = xutils.get_argument_str("username", "")
+        pswd = xutils.get_argument_str("password", "")
+        error = self.do_login(name, pswd)
+        return xtemplate.render("user/page/login.html",
+                                show_aside=False,
+                                username=name,
+                                password=pswd,
+                                error=error)
+
+    def GET(self):
+        return xtemplate.render("user/page/login.html",
+                                show_aside=False,
+                                show_nav=False,
+                                username="",
+                                password="",
+                                error="")
+
+    def do_login(self, name, pswd):
+        target = xutils.get_argument_str("target")
+        return self.do_login_with_redirect(name,pswd,target)
+
+
+    def do_login_with_redirect(self,name, pswd, target=""):
+        error = self.do_login_with_error(name, pswd)
+        if error == "":
+            if target == "":
+                target = "/"
+            raise web.found(target)
+        return error
+
+    def do_login_with_error(self, name, pswd, count=0):
+        name = name.strip()
+        pswd = pswd.strip()
+        count = _login_failed_count.get(name, 0)
+        assert isinstance(count, int)
+        error = ""
+        if name == "":
+            error = "请输入登录名"
+        elif pswd == "":
+            error = "请输入密码"
+        elif count >= RETRY_LIMIT:
+            error = "重试次数过多"
+
+        if error != "":
+            return error
+
+        user = xauth.get_user_by_name(name)
+
+        if user == None:
+            error = "用户名或密码错误"
+            save_login_info(name, error)
+            save_login_error_count(name, count + 1)
+            return error
+        else:
+            if xauth.encode_password(pswd, user.salt) == user.password_md5:
+                save_login_info(name)
+
+                try:
+                    xauth.login_user_by_name(name, login_ip=get_real_ip())
+                    return "" # 登录成功
+                except Exception as e:
+                    xutils.print_exc()
+                    return str(e)
+            else:
+                error = "用户名或密码错误"
+                save_login_info(name, error)
+                save_login_error_count(name, count + 1)
+        return error
+
+
+
+class LoginAjaxHandler:
+    def POST(self):
+        request_data = str(web.data(),'UTF-8')
+        request_json = json.loads(request_data)
+        name = request_json["username"]
+        pswd = request_json["password"]
+
+        hander = LoginHandler()
+        error = hander.do_login_with_error(name,pswd)
+
+        response = {}
+        if ( error == ""):
+            response['success'] = True
+        else:
+            response['success']  = False
+            response['error']  = error
+        return json.dumps(response)
+
+class NewAccountLoginHandler:
+    def POST(self):
+        request_data = str(web.data(),'UTF-8')
+        print("enter login "+request_data)
+        request_json = json.loads(request_data)
+        name = request_json["username"]
+        pswd = request_json["password"]
+
+        hander = LoginHandler()
+        error = hander.do_login_with_error(name,pswd)
+
+        response = {}
+        response["type"] = "account"
+        if ( error == ""):
+            response['status'] = "ok"
+        else:
+            response['status']  = "error"
+            response['errorMsg']  = error
+        return json.dumps(response)
+
+xurls = (
+    r"/login", LoginHandler,
+    r"/login_ajax", LoginAjaxHandler,
+    r"/login/account_login", NewAccountLoginHandler
+)
```

### Comparing `xnote-web-0.1.0/handlers/user/page/change_password.html` & `xnote-web-0.1.1/handlers/user/page/change_password.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/login.html` & `xnote-web-0.1.1/handlers/user/page/login.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/user.html` & `xnote-web-0.1.1/handlers/user/page/user.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/user_list.html` & `xnote-web-0.1.1/handlers/user/page/user_list.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/user_manage.html` & `xnote-web-0.1.1/handlers/user/page/user_manage.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/user_op_log.html` & `xnote-web-0.1.1/handlers/user/page/user_op_log.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/page/userinfo.html` & `xnote-web-0.1.1/handlers/user/page/userinfo.html`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/handlers/user/user.py` & `xnote-web-0.1.1/handlers/user/user.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,206 +1,206 @@
-# encoding=utf-8
-# @modified 2022/04/04 14:01:57
-import web
-from xnote.core import xauth
-from xnote.core import xtemplate
-from xnote.core import xmanager
-import xutils
-import math
-from xutils import textutil
-from xutils import Storage
-from xutils import dbutil
-from xutils import webutil
-from . import dao
-
-OP_LOG_TABLE = xauth.UserOpLogDao
-
-
-def create_op_log(user_name, op_type, detail):
-    ip = webutil.get_real_ip()
-    log = dao.UserOpLog()
-    log.user_id = xauth.UserDao.get_id_by_name(user_name)
-    log.ip = ip
-    log.type = op_type
-    log.detail = detail
-    dao.UserOpLogDao.create_op_log(log)
-
-
-class ListHandler:
-    """用户管理"""
-
-    @xauth.login_required("admin")
-    def GET(self):
-        page = xutils.get_argument_int("page", 1)
-        page_size = xutils.get_argument_int("page_size", 10)
-        offset = (page-1) * page_size
-        assert offset >= 0
-
-        total = xauth.UserModel.count()
-
-        kw = Storage()
-        kw.user_info = None
-        kw.show_aside = False
-        kw.user_list = xauth.UserModel.list(offset = offset, limit = page_size)
-        kw.page = page
-        kw.page_size = page_size
-        kw.page_max = math.ceil(total/page_size)//1
-
-        return xtemplate.render("user/page/user_list.html", **kw)
-
-    @xauth.login_required("admin")
-    def POST(self):
-        name = xutils.get_argument("name")
-        password = xutils.get_argument("password")
-        error = xauth.create_user(name, password)
-        added = xauth.get_user(name)
-        # 先暴力解决
-        xmanager.reload()
-        raise web.seeother("/system/user?name=%s" % name)
-
-
-class UserHandler:
-
-    @xauth.login_required("admin")
-    def GET(self):
-        name = xutils.get_argument_str("name")
-        user_info = None
-        if name != "":
-            user_info = xauth.get_user(name)
-        
-        user_id = xauth.UserDao.get_id_by_name(name)
-        kw = Storage()
-        kw.name = name
-        kw.user_info = user_info
-        kw.log_list = OP_LOG_TABLE.list_by_user(user_id=user_id, limit=100)
-
-        return xtemplate.render("user/page/user_manage.html", **kw)
-
-    @xauth.login_required("admin")
-    def POST(self):
-        name = xutils.get_argument("name")
-        password = xutils.get_argument_str("password")
-        user_info = xauth.get_user(name)
-        if user_info is None:
-            raise Exception("用户不存在:%s" % name)
-
-        user_info.password = password
-        xauth.update_user(name, user_info)
-
-        raise web.seeother("/system/user?name=%s" % name)
-
-
-class AddHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        name = xutils.get_argument("name")
-        return xauth.create_user(name, textutil.random_string(6))
-
-
-class RemoveHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        user_id = xutils.get_argument_int("user_id")
-        xauth.UserModel.delete_by_id(user_id)
-        return dict(code="success")
-
-
-class UserInfoHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user = xauth.current_user()
-        return xtemplate.render("user/page/userinfo.html", user=user)
-
-class UserInfoAjaxHandler:
-    def getDesensitizedUserInfo(self):
-        user = xauth.current_user()
-        assert user != None
-        mobile = ''
-        if (user.mobile != None and user.mobile != ''):
-            mobile = user.mobile[:3] + '****' + user.mobile[7:]
-        return dict(name=user.name, phone=mobile)
-
-
-    @xauth.login_required()
-    def POST(self):
-       return self.getDesensitizedUserInfo()
-
-    @xauth.login_required()
-    def GET(self):
-        return self.getDesensitizedUserInfo()
-
-
-class SessionInfoAjaxHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name()
-        return xauth.list_user_session_detail(user_name)
-
-
-class ChangePasswordHandler:
-
-    def GET(self, error=""):
-        """获取页面, 修改密码后也需要跳转到这里，所以不能校验登录态"""
-        old_password = xutils.get_argument("old_password", "")
-        new_password = xutils.get_argument("new_password", "")
-        return xtemplate.render("user/page/change_password.html",
-                                old_password=old_password, new_password=new_password, error=error)
-
-    @xauth.login_required()
-    def POST(self):
-        user_name = xauth.current_name()
-        old_password = xutils.get_argument("old_password", "")
-        new_password = xutils.get_argument("new_password", "")
-        error = ""
-
-        if old_password == "":
-            return self.GET(error="旧的密码为空")
-        if new_password == "":
-            return self.GET(error="新的密码为空")
-
-        try:
-            xauth.check_old_password(user_name, old_password)
-            xauth.update_user(user_name, Storage(password=new_password))
-            create_op_log(user_name, "change_password", "修改密码")
-        except Exception as e:
-            return self.GET(error=str(e))
-
-        return self.GET(error=error)
-
-class ResetPasswordHandler:
-
-    @xauth.login_required("admin")
-    def POST(self):
-        user_name = xutils.get_argument_str("user_name")
-        new_password = xutils.random_number_str(8)
-        xauth.update_user(user_name, Storage(password=new_password))
-        create_op_log(user_name, dao.UserOpTypeEnum.reset_password.value, "重置密码")
-        return dict(code="success", data=new_password)
-
-class UserOpLogHandler:
-
-    @xauth.login_required()
-    def GET(self):
-        user_name = xauth.current_name_str()
-        user_id = xauth.UserDao.get_id_by_name(user_name)
-        log_list = OP_LOG_TABLE.list_by_user(user_id, limit=100)
-        return xtemplate.render("user/page/user_op_log.html", log_list=log_list)
-
-
-xurls = (
-    r"/user/add",  AddHandler,
-    r"/user/list",  ListHandler,
-    r"/user/info",   UserInfoHandler,
-    r"/user/info_ajax", UserInfoAjaxHandler,
-    r"/user/session", SessionInfoAjaxHandler,
-    r"/user/change_password", ChangePasswordHandler,
-    r"/user/op_log", UserOpLogHandler,
-
-    r"/system/user", UserHandler,
-    r"/system/user/list", ListHandler,
-    r"/system/user/remove", RemoveHandler,
-    r"/system/user/reset_password", ResetPasswordHandler,
-)
+# encoding=utf-8
+# @modified 2022/04/04 14:01:57
+import web
+from xnote.core import xauth
+from xnote.core import xtemplate
+from xnote.core import xmanager
+import xutils
+import math
+from xutils import textutil
+from xutils import Storage
+from xutils import dbutil
+from xutils import webutil
+from . import dao
+
+OP_LOG_TABLE = xauth.UserOpLogDao
+
+
+def create_op_log(user_name, op_type, detail):
+    ip = webutil.get_real_ip()
+    log = dao.UserOpLog()
+    log.user_id = xauth.UserDao.get_id_by_name(user_name)
+    log.ip = ip
+    log.type = op_type
+    log.detail = detail
+    dao.UserOpLogDao.create_op_log(log)
+
+
+class ListHandler:
+    """用户管理"""
+
+    @xauth.login_required("admin")
+    def GET(self):
+        page = xutils.get_argument_int("page", 1)
+        page_size = xutils.get_argument_int("page_size", 10)
+        offset = (page-1) * page_size
+        assert offset >= 0
+
+        total = xauth.UserModel.count()
+
+        kw = Storage()
+        kw.user_info = None
+        kw.show_aside = False
+        kw.user_list = xauth.UserModel.list(offset = offset, limit = page_size)
+        kw.page = page
+        kw.page_size = page_size
+        kw.page_max = math.ceil(total/page_size)//1
+
+        return xtemplate.render("user/page/user_list.html", **kw)
+
+    @xauth.login_required("admin")
+    def POST(self):
+        name = xutils.get_argument("name")
+        password = xutils.get_argument("password")
+        error = xauth.create_user(name, password)
+        added = xauth.get_user(name)
+        # 先暴力解决
+        xmanager.reload()
+        raise web.seeother("/system/user?name=%s" % name)
+
+
+class UserHandler:
+
+    @xauth.login_required("admin")
+    def GET(self):
+        name = xutils.get_argument_str("name")
+        user_info = None
+        if name != "":
+            user_info = xauth.get_user(name)
+        
+        user_id = xauth.UserDao.get_id_by_name(name)
+        kw = Storage()
+        kw.name = name
+        kw.user_info = user_info
+        kw.log_list = OP_LOG_TABLE.list_by_user(user_id=user_id, limit=100)
+
+        return xtemplate.render("user/page/user_manage.html", **kw)
+
+    @xauth.login_required("admin")
+    def POST(self):
+        name = xutils.get_argument("name")
+        password = xutils.get_argument_str("password")
+        user_info = xauth.get_user(name)
+        if user_info is None:
+            raise Exception("用户不存在:%s" % name)
+
+        user_info.password = password
+        xauth.update_user(name, user_info)
+
+        raise web.seeother("/system/user?name=%s" % name)
+
+
+class AddHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        name = xutils.get_argument("name")
+        return xauth.create_user(name, textutil.random_string(6))
+
+
+class RemoveHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        user_id = xutils.get_argument_int("user_id")
+        xauth.UserModel.delete_by_id(user_id)
+        return dict(code="success")
+
+
+class UserInfoHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user = xauth.current_user()
+        return xtemplate.render("user/page/userinfo.html", user=user)
+
+class UserInfoAjaxHandler:
+    def getDesensitizedUserInfo(self):
+        user = xauth.current_user()
+        assert user != None
+        mobile = ''
+        if (user.mobile != None and user.mobile != ''):
+            mobile = user.mobile[:3] + '****' + user.mobile[7:]
+        return dict(name=user.name, phone=mobile)
+
+
+    @xauth.login_required()
+    def POST(self):
+       return self.getDesensitizedUserInfo()
+
+    @xauth.login_required()
+    def GET(self):
+        return self.getDesensitizedUserInfo()
+
+
+class SessionInfoAjaxHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name()
+        return xauth.list_user_session_detail(user_name)
+
+
+class ChangePasswordHandler:
+
+    def GET(self, error=""):
+        """获取页面, 修改密码后也需要跳转到这里，所以不能校验登录态"""
+        old_password = xutils.get_argument("old_password", "")
+        new_password = xutils.get_argument("new_password", "")
+        return xtemplate.render("user/page/change_password.html",
+                                old_password=old_password, new_password=new_password, error=error)
+
+    @xauth.login_required()
+    def POST(self):
+        user_name = xauth.current_name()
+        old_password = xutils.get_argument("old_password", "")
+        new_password = xutils.get_argument("new_password", "")
+        error = ""
+
+        if old_password == "":
+            return self.GET(error="旧的密码为空")
+        if new_password == "":
+            return self.GET(error="新的密码为空")
+
+        try:
+            xauth.check_old_password(user_name, old_password)
+            xauth.update_user(user_name, Storage(password=new_password))
+            create_op_log(user_name, "change_password", "修改密码")
+        except Exception as e:
+            return self.GET(error=str(e))
+
+        return self.GET(error=error)
+
+class ResetPasswordHandler:
+
+    @xauth.login_required("admin")
+    def POST(self):
+        user_name = xutils.get_argument_str("user_name")
+        new_password = xutils.random_number_str(8)
+        xauth.update_user(user_name, Storage(password=new_password))
+        create_op_log(user_name, dao.UserOpTypeEnum.reset_password.value, "重置密码")
+        return dict(code="success", data=new_password)
+
+class UserOpLogHandler:
+
+    @xauth.login_required()
+    def GET(self):
+        user_name = xauth.current_name_str()
+        user_id = xauth.UserDao.get_id_by_name(user_name)
+        log_list = OP_LOG_TABLE.list_by_user(user_id, limit=100)
+        return xtemplate.render("user/page/user_op_log.html", log_list=log_list)
+
+
+xurls = (
+    r"/user/add",  AddHandler,
+    r"/user/list",  ListHandler,
+    r"/user/info",   UserInfoHandler,
+    r"/user/info_ajax", UserInfoAjaxHandler,
+    r"/user/session", SessionInfoAjaxHandler,
+    r"/user/change_password", ChangePasswordHandler,
+    r"/user/op_log", UserOpLogHandler,
+
+    r"/system/user", UserHandler,
+    r"/system/user/list", ListHandler,
+    r"/system/user/remove", RemoveHandler,
+    r"/system/user/reset_password", ResetPasswordHandler,
+)
```

### Comparing `xnote-web-0.1.0/handlers/webdav/webdav.py` & `xnote-web-0.1.1/handlers/webdav/webdav.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/html2text.py` & `xnote-web-0.1.1/lib/html2text.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/leveldb-x64.dll` & `xnote-web-0.1.1/lib/leveldb-x64.dll`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/leveldb.dll` & `xnote-web-0.1.1/lib/leveldb.dll`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/leveldbpy.py` & `xnote-web-0.1.1/lib/leveldbpy.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/smallseg.py` & `xnote-web-0.1.1/lib/smallseg.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/__init__.py` & `xnote-web-0.1.1/lib/web/__init__.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/application.py` & `xnote-web-0.1.1/lib/web/application.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/browser.py` & `xnote-web-0.1.1/lib/web/browser.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/contrib/template.py` & `xnote-web-0.1.1/lib/web/contrib/template.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/db.py` & `xnote-web-0.1.1/lib/web/db.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/debugerror.py` & `xnote-web-0.1.1/lib/web/debugerror.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/form.py` & `xnote-web-0.1.1/lib/web/form.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/http.py` & `xnote-web-0.1.1/lib/web/http.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/httpserver.py` & `xnote-web-0.1.1/lib/web/httpserver.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/net.py` & `xnote-web-0.1.1/lib/web/net.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/py3helpers.py` & `xnote-web-0.1.1/lib/web/py3helpers.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/session.py` & `xnote-web-0.1.1/lib/web/session.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/template.py` & `xnote-web-0.1.1/lib/web/template.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/test.py` & `xnote-web-0.1.1/lib/web/test.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/utils.py` & `xnote-web-0.1.1/lib/web/utils.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/webapi.py` & `xnote-web-0.1.1/lib/web/webapi.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/webopenid.py` & `xnote-web-0.1.1/lib/web/webopenid.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgi.py` & `xnote-web-0.1.1/lib/web/wsgi.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/LICENSE.txt` & `xnote-web-0.1.1/lib/web/wsgiserver/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/__init__.py` & `xnote-web-0.1.1/lib/web/wsgiserver/__init__.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/ssl_builtin.py` & `xnote-web-0.1.1/lib/web/wsgiserver/ssl_builtin.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/ssl_pyopenssl.py` & `xnote-web-0.1.1/lib/web/wsgiserver/ssl_pyopenssl.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/wsgiserver2.py` & `xnote-web-0.1.1/lib/web/wsgiserver/wsgiserver2.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/web/wsgiserver/wsgiserver3.py` & `xnote-web-0.1.1/lib/web/wsgiserver/wsgiserver3.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/lib/wget.py` & `xnote-web-0.1.1/lib/wget.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/setup.py` & `xnote-web-0.1.1/setup.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,32 +1,32 @@
-# encoding=utf-8
-
-import setuptools
-
-with open("README.md", "r", encoding="utf-8") as fp:
-    long_description = fp.read()
-
-
-data_ext_list =  ["*.txt", "*.json", "*.properties", "*.js", "*.html", "*.css"]
-
-setuptools.setup(
-    name = "xnote-web",
-    version = "0.1.0",
-    author = "mark",
-    author_email = "578749341@qq.com",
-    description = "xnote-web框架",
-    long_description = long_description,
-    long_description_content_type = "text/markdown",
-    # packages = ["config", "core", "docs", "handlers", "lib", "static", "tools", "xnote", "xutils"],
-    packages=setuptools.find_packages(),
-    include_package_data=True, # 包含资源文件
-    # package_dir={"": "."},
-    # package_data={
-    #     "": data_ext_list,
-    #     "handlers": data_ext_list,
-    # },
-    classifiers = [
-        "Programming Language :: Python :: 3",
-        "License :: OSI Approved :: MIT License",
-        "Operating System :: OS Independent",
-    ]
-)
+# encoding=utf-8
+
+import setuptools
+
+with open("README.md", "r", encoding="utf-8") as fp:
+    long_description = fp.read()
+
+
+data_ext_list =  ["*.txt", "*.json", "*.properties", "*.js", "*.html", "*.css"]
+
+setuptools.setup(
+    name = "xnote-web",
+    version = "0.1.1",
+    author = "mark",
+    author_email = "578749341@qq.com",
+    description = "xnote-web框架",
+    long_description = long_description,
+    long_description_content_type = "text/markdown",
+    # packages = ["config", "core", "docs", "handlers", "lib", "static", "tools", "xnote", "xutils"],
+    packages=setuptools.find_packages(),
+    include_package_data=True, # 包含资源文件
+    # package_dir={"": "."},
+    # package_data={
+    #     "": data_ext_list,
+    #     "handlers": data_ext_list,
+    # },
+    classifiers = [
+        "Programming Language :: Python :: 3",
+        "License :: OSI Approved :: MIT License",
+        "Operating System :: OS Independent",
+    ]
+)
```

### Comparing `xnote-web-0.1.0/static/audio/todo_done.mp3` & `xnote-web-0.1.1/static/audio/todo_done.mp3`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/app.build.css` & `xnote-web-0.1.1/static/css/app.build.css`

 * *Files 10% similar despite different names*

```diff
@@ -146,1121 +146,1121 @@
 table td {
     border-width: 1px;
     padding: 5px;
     border-style: solid;
     border-color: #ccc;
     background-color: #ffffff;
 }
-/**
- * 通用的CSS样式
- * @author xupingmao
- * @since 2017/12/16
- * @modified 2022/03/16 18:57:15
- * @filename common.css
- * 命名规范（主要参考bootstrap）: 包含两部分，
- * 1：简单的、望文生义的样式，比如颜色 red, blue等等
- * 2：复杂样式，命名规则为：模块名(可选)-功能外观-子功能外观(可选)-实现方式(可选)-特征或状态(可选)，示例如下：
- *   1. marked-code (marked模块的code组件)
- *   2. marked-img (marked模块的图片组件)
- *   3. list-link（外观是list，通过link实现的）
- *   4. list-item（外观是list，通过div实现的）
- *   5. btn-link   (外观是button，通过link实现的)
- *   6. btn-danger (外观是button，表示危险操作)
- *   7. btn-default (外观是button，默认样式)
- *   8. tab-link  （外观是tab，通过link实现)
- *   9. tab-link-activate (外观是tab，通过link实现，状态是激活)
- *   10. x-dialog-title-box-activate（x模块下的对话框标题，div实现，状态是激活）
- * 
- *  注意：后声明的样式匹配优先级更高
- */
-
-/** marked 样式 **/
-.marked-heading {
-    /* 避免顶部fixed菜单遮挡 */
-    width: 100%;
-    font-family: "Microsoft YaHei", "黑体";
-}
-
-h1.marked-heading {
-    font-size: 24px;
-}
-
-h2.marked-heading {
-    font-size: 20px;
-}
-
-h3.marked-heading {
-    font-size: 16px;
-}
-
-.marked-img {
-    text-align: center;
-}
-
-.marked-contents {
-    width: 100%;
-    border: 1px solid #ccc;
-    margin-bottom: 10px;
-}
-
-.marked-contents-title {
-    display: inline-block;
-    padding: 5px;
-}
-
-.marked-contents h1 {
-    text-align: center;
-    margin: 0px;
-    padding: 0px;
-    font-size: 20px;
-}
-
-.marked-code {
-    width: 100%;
-    background-color: #000;
-    color: #fff;
-    padding: 0.5rem;
-    border: 1px solid #ddd;
-    word-wrap: break-word;
-    white-space: pre-wrap;
-    margin: 0px;
-}
-
-.marked-codespan {
-    padding-left: 4px;
-    padding-right: 4px;
-    margin: 0;
-    /* background-color: rgba(27,31,35,.05); */
-    background-color: pink;
-    border-radius: 4px;
-    padding: 3px;
-    line-height: 23px;
-}
-
-.marked-strong {
-    color: red;
-}
-
-.marked-strong>a {
-    color: red;
-}
-
-/** 标题样式 **/
-.heading {
-    margin: 0px 0px 10px 0px;
-    padding: 5px;
-    display: block;
-    float: left;
-    width: 100%;
-    font-size: 16px;
-    background: #eee;
-    border-left: 5px solid #039BE5;
-}
-
-/** label **/
-.label {
-    display: inline-block;
-    width: 100px;
-}
-
-.btn-link, .button-link {
-    text-decoration: none;
-    cursor: pointer;
-}
-
-.btn-link:hover, .button-link:hover {
-    background: #ccc;
-}
-
-.link, .black-link, .link2 {
-    margin-right: 5px;
-    cursor: pointer;
-}
-
-.link {
-    /*color: #37a; */
-    color: #08c;
-}
-
-.black-link {
-    color: black;
-}
-
-.link2 {
-    color: black;
-}
-
-.link2:hover {
-    color: gray;
-}
-
-.path-link, .default-path-link {
-    line-height: 28px;
-    color: #000;
-}
-
-.path-link:hover, .default-path-link:hover {
-    color: #888;
-}
-
-.default-path-link {
-    color: #08c;
-}
-
-.danger-link {
-    color: red;
-}
-
-.selected-link {
-    /*border-bottom: 2px solid red;*/
-    color: red;
-}
-
-/* 高对比度link */
-.contract-link {
-    display: inline-block;
-    color: #08c;
-    line-height: 20px;
-    float: left;
-    margin: 3px;
-    padding: 3px;
-    text-decoration: none;
-}
-
-.contract-link:hover {
-    color: white;
-    background-color: #08c;
-    text-decoration: none;
-}
-
-/* 菜单的链接样式 */
-.nav-item>a, .menu-link {
-    color: white;
-    padding: 3px 5px;
-    text-decoration: none;
-    font-size: 16px;
-}
-
-.nav-item>a:hover, .menu-link:hover {
-    text-decoration: underline;
-}
-
-/** 表格 **/
-.no-border-table td {
-    border: none;
-}
-
-.table {
-    width: 100%;
-}
-
-.table th{
-    border-color: #ccc;
-    text-align: left;
-}
-
-.table td {
-    border-color: #ccc;
-    word-wrap: break-word;
-    word-break: break-all;
-}
-
-/* 
-这种方式走不通,需要声明hover-tr
-.table tr:hover td{
-    background-color: none;
-}
-
-.table tr:hover{
-    background-color: #eee;
-}
- */
-
-.row-no, .index-td {
-    width: 50px;
-}
-
-.hover-tr:hover td {
-    background: none;
-}
-
-.hover-tr:hover {
-    background-color: #eee;
-}
-
-.line-td {
-    border-top: none;
-    border-left: none;
-    border-right: none;
-}
-
-/** 列表样式 **/
-.list-item, .list-link {
-    width: 100%;
-    padding: 10px 5px;
-    margin-top: 0px;
-    margin-bottom: 0px;
-    float: left;
-    line-height: 25px;
-    border-bottom: 1px solid #eee;
-    cursor: pointer;
-}
-
-.list-item:last-of-type, .list-link:last-of-type {
-    border-bottom: none;
-}
-
-.list-item:hover, .list-link:hover {
-    background-color: #eee;
-}
-
-.list-link i, .list-item i {
-    color: black;
-}
-
-.list-item-badge {
-    color: #888;
-}
-
-/** 以下为具体场景下的样式 **/
-.menu-selected {
-    background: #0088cc;
-    color: #fff;
-}
-
-/** 侧边栏样式 **/
-.nav-sidebar > .active > a,
-.nav-sidebar > .active > a:hover,
-.nav-sidebar > .active > a:focus {
-  color: #fff;
-  background-color: #428bca;
-}
-
-.hide, .hidden {
-    display: none;
-}
-
-.hidden-file {
-    display: none;
-}
-
-.tool-div {
-    font-size: medium;
-}
-
-.tool-div a {
-    font-size: medium;
-    color: blue;
-}
-
-.tool-description {
-    font-size: small;
-    padding-top: 3px;
-}
-
-.xnote-menu {
-    padding-left:0;
-}
-
-li.menu-item {
-    float: left;
-    display: block;
-    padding-left: 10px;
-    padding-right: 10px;
-    padding-top: 5px;
-    padding-bottom: 5px;
-}
-
-li.menu-active {
-    padding-bottom: 3px;
-    border-style: solid;
-    border-color: #99cc33;
-    border-top: 0px;
-    border-left: 0px;
-    border-right: 0px;
-    border-bottom-width: 2px;
-}
-
-li.menu-item a {
-    text-decoration: none; 
-    color: #fff;
-}
-
-li.menu-item a:hover {
-    background-color: inherit;
-}
-
-li.menu-item:hover {
-    background-color: #777;
-}
-
-/** base START **/
-
-.header {
-  width: 100%;
-  background-color: #eee;
-  position: fixed;
-  left: 0px;
-  top: 0px;
-}
-
-
-.root {
-    /*    
-    padding-bottom: 10px;
-    width: 1000px;
-    height: 100%;
-    overflow: hidden;
-    margin-left: 0px;
-    margin: 0 auto;
-    */
-}
-
-.nav {
-    float: left;
-    width: 100%;
-    background-color: #515865;
-}
-
-.nav-container {
-    float: left;
-    width: 1000px;
-    padding-left: 10px;
-    padding-right: 10px;
-}
-
-.nav-left {
-    display: none;
-}
-
-.x-center {
-    /* 具体样式由 base_layout.html 脚本动态调整 */
-}
-
-.x-center.dev-info {
-    padding-left: 10px;
-    padding-right: 10px;
-}
-
-.x-left {
-    display: none;
-}
-
-.x-body {
-    float: left;
-    width: 100%;
-    margin: 0 auto;
-    margin-top: 10px;
-    min-height: 400px;
-    /*padding: 0px 10%;*/
-}
-
-.footer {
-    float: left;
-    color: #fff;
-    background-color: #515865;
-    width: 100%;
-    font-size: 14px;
-}
-
-.nav-top {
-  width: 100%;
-  float: left;
-  margin-top: 40px;
-}
-
-.nav-top * {
-  margin: 0px;
-  padding: 0px;
-  color: black;
-}
-
-.nav-top h1 {
-  font-family: "monospace Consolas";
-}
-
-.nav-top ul {
-  height: 30px;
-  width: 100%;
-  padding-left: 10px;
-}
-
-.nav-top li {
-  display: block;
-  float: left;
-  padding: 5px;
-}
-
-.nav-left-search {
-    float: left;
-    padding: 10px;
-    display: none;
-    padding-bottom: 0px;
-}
-
-.nav-search-input {
-    width: 100%;
-    height: 30px;
-    outline: none;
-    padding-left: 5px;
-    padding-right: 30px;
-    float: left;
-    display: block;
-    border: 1px solid #ccc;
-}
-
-.nav-search-btn {
-    float: left;
-    height: 30px;
-    width: 30px;
-    margin-left: -30px;
-    margin-top: 0px;
-    border-radius: 0px;
-}
-
-.nav-search {
-    width: 345px;
-    float: right;
-    padding: 10px 0px;
-}
-
-.navMenu-top { 
-  padding: 10px; 
-  color: #fff; 
-  border-bottom: 1px solid rgba(255,255,255,.1) 
-}
-
-.notice {
-    border: 1px solid #ccc;
-    background-color: #cef2e0;
-    margin-top: 3px;
-    margin-bottom: 3px;
-    padding-left: 3px;
-}
-
-.form-control {
-    width: 100%;
-}
-
-
-/** file-list样式 END **/
-
-.green-text {
-    color: green;
-}
-
-.green-bg {
-    color: #fff;
-    background-color: green;
-}
-
-.red-bg {
-    background-color: red;
-}
-
-.red-text {
-    color: #f00;
-}
-
-.blue-text {
-    color: #00f;
-}
-
-.center-text {
-    text-align: center;
-}
-
-.gray-text {
-    color: #888;
-}
-
-.error {
-    padding: 5px;
-    background-color: #f2dede;
-    margin: 0px;
-}
-
-.warn {
-    margin: 0px;
-    padding: 5px;
-    background-color: #ffc;
-}
-
-.info {
-    padding: 5px;
-    background-color: #C1FFC1;
-    margin: 0px;
-}
-
-.info.light {
-    background-color: #eee;
-}
-
-.success {
-    padding: 5px;
-    margin: 0px;
-    background-color: #cf9;
-}
-
-.x-dialog {
-    display: none;
-    position: fixed;
-    margin: 0 auto;
-    background-color: #fff;
-    z-index: 100;
-    overflow-y: hidden;
-}
-
-.x-dialog-title {
-    margin: 0 auto;
-    width: 100%;
-    background-color: #214FA3;
-    color: #fff;
-    padding: 5px;
-    cursor: move;
-    height: 36px;
-    line-height: 26px;
-}
-
-.x-dialog-body {
-    float: left;
-    width: 100%;
-    overflow-y: auto;
-}
-
-.x-dialog-background {
-    display: none;
-    position: fixed;
-    left: 0px;
-    top: 0px;
-    width: 100%;
-    height: 100%;
-    background-color: #000;
-    opacity: 0.5;
-}
-
-.background {
-    display: none;
-    position: fixed;
-    left: 0px;
-    top: 0px;
-    width: 100%;
-    height: 100%;
-    background-color: #000;
-    opacity: 0.5;
-}
-
-.x-dialog-ajax {
-    display: block;
-}
-
-.x-dialog-close {
-    background-color: red;
-    float: right;
-    border: none;
-    margin-top: 0px;
-    border: 1px solid transparent;
-}
-
-.x-dialog-close:hover {
-    border: 1px solid black;
-}
-
-.dialog-close-btn {
-    float: right;
-    padding-left: 5px;
-    padding-right: 5px;
-    color: #fff;
-    cursor: pointer;
-    line-height: 30px;
-}
-
-.dialog-close-btn:hover {
-    background-color: red;
-}
-
-.dialog-title-btn {
-    float: left;
-    padding-left: 5px;
-    padding-right: 5px;
-    color: #fff;
-    cursor: pointer;
-    line-height: 30px;
-}
-
-.dialog-title-btn:hover {
-    background-color: gray;
-}
-
-
-.dialog-title {
-    float: left;
-    width: 100%;
-    height: 30px;
-    background-color: #3c3333
-}
-
-.dialog-iframe {
-    float: left;
-    width: 100%;
-    height: 100%;
-    border: none
-}
-
-
-.no-border tr td {
-    border: none;
-}
-
-.input-group {
-    float:left;
-    width:300px;
-    padding-bottom:5px;
-    max-width: 700px;
-    line-height: 29px;
-}
-
-.input-group label {
-    width: 120px;
-    float: left;
-    padding-right: 10px;
-    line-height: 29px;
-    text-align: right;
-}
-
-.input-group input[type=text], .input-group input[type=password], .input-group select {
-    width: 160px;
-}
-
-.input-group button {
-    margin-top: 0px;
-}
-
-.input-group-row {
-    float: left;
-    width: 100%;
-    margin-top: 10px;
-}
-
-.input-group-row input, .input-group-row select {
-    width: 200px;
-}
-
-#searchBox {
-    margin-bottom: 5px;
-}
-
-.search-input {
-    float: left;
-    height:40px;
-    padding-left: 10px;
-    padding-right: 40px;
-    width: 100%;
-    max-width: 500px;
-    outline: none;
-    box-sizing: border-box;
-}
-
-.search-btn {
-    float: left;
-    right: 10px;
-    background: #355380; 
-    color: #fff; 
-    border: none;
-    border-radius:0px;
-    /*max-width:25%;*/
-    width: 40px;
-    height: 40px;
-    margin-left: -40px;
-}
-
-.item-option {
-    color: #aaa;
-    cursor: pointer;
-    font-size: 12px;
-}
-
-.item-option:hover {
-    color: #000;
-    background: none;
-    text-decoration: underline;
-}
-
-.fs-path {
-    float: left;
-    width: 100%;
-    padding: 5px;
-    box-sizing: border-box;
-    background-color: #eee;
-}
-
-.fs-file {
-    color: black;
-    cursor: pointer;
-}
-
-.fs-folder {
-    color: blue;
-}
-
-/** 知识库列表样式 **/
-#fileTable td {
-    border-top: none;
-    border-left: none;
-    border-right: none;
-}
-
-.group-link {
-    color: #08c;
-}
-
-.grid-title, .card-title {
-    width: 100%;
-    float: left;
-    border-left: 5px solid #039BE5;
-    margin-top: 0px;
-    margin-bottom: 5px;
-    font-family: arial,"Sim Sun";
-    font-size: 14px;
-    font-weight: normal;
-    overflow: initial;
-    padding-left: 5px;
-}
-
-.card-title-2 {
-    padding: 5px;
-    margin: 0px;
-    background-color: #eee;
-}
-
-.grid-row {
-    width: 100%;
-    float: left;
-}
-
-.grid-link {
-    display: block;
-    float: left;
-    width: 220px;
-    padding: 5px;
-    margin: 5px;
-    margin-top: 0px;
-    margin-bottom: 0px;
-    line-height: 25px;
-}
-
-.grid-link:hover {
-    background: #eee;
-}
-
-.grid-item {
-    width: 20%;
-    padding: 5px;
-    /*margin: 5px;*/
-    margin-top: 0px;
-    margin-bottom: 0px;
-    float: left;
-    line-height: 25px;
-}
-
-.group-div {
-    width: 220px;
-    padding: 5px;
-    margin: 5px;
-    margin-top: 0px;
-    margin-bottom: 0px;
-    /*border: 1px solid #ccc;*/
-    box-sizing: border-box;
-    float: left;
-    line-height: 25px;
-}
-
-.group-div:hover {
-    background-color: #eee;
-}
-
-.children-count {
-    float: right;
-}
-
-.note-link {
-    color: #08c;
-}
-
-.scroll-y {
-    overflow-y: auto;
-}
-
-.float-left {
-    float: left;
-}
-
-.float-right {
-    float: right;
-}
-
-.align-right {
-    text-align: right;
-}
-
-.align-center {
-    text-align: center;
-}
-
-.small-font {
-    font-size: small;
-}
-
-.code {
-    font-family: Consolas, monospace;
-}
-
-.nav-ul {
-    display: block;
-    float: left;
-    list-style: none;
-    padding-left: 0px;
-    margin: 0px;
-    line-height: 50px;
-}
-
-.nav-item {
-    padding-right: 5px;
-    display: block;
-    float: left;
-}
-
-.keyword {
-    color: blue;
-}
-
-.output-title {
-    width: 100%;
-    border: 1px solid #ccc;
-    padding-left: 5px;
-    margin-top: 5px;
-}
-
-.output-body {
-    border: 1px solid #ccc;
-    padding: 4px;
-    background-color: #eee;
-    box-sizing: border-box;
-    margin: 0px;
-    border-top: none;
-    font-family: consolas, monospace;
-}
-
-
-.bot-btn {
-    position: fixed;
-    bottom: 50px;
-    width: 50px;
-    height: 40px;
-    font-size: 14px;
-    background-color: #00c1de;
-    cursor: pointer;
-    border-radius: 5px;
-    color: #fff;
-    padding: 10px;
-    z-index: 100;
-    opacity: 0.8
-}
-
-.border {
-    border: solid 1px #ccc;
-}
-
-.main-content {
-    float: left;
-    width: 1000px;
-    min-height: 20px;
-    padding: 10px;
-    background-color: #fff;
-}
-
-.main-content-bg {
-    background-color: #fff;
-}
-
-.aside {
-    float: left;
-    width: 220px;
-    margin-left: -220px;
-    display: none;
-}
-
-.aside-item {
-    background-color: white;
-    border: 1px solid #ccc;
-    width: 100%;
-    float: left;
-    margin-bottom: 10px;
-}
-
-.aside-item li {
-    list-style: none;
-    line-height: 20px;
-}
-
-.aside-title {
-    border-bottom: 1px solid #ccc;
-    /*background-color: #efefef;*/
-    padding: 5px;
-}
-
-.aside-content {
-    margin: 5px;
-}
-
-.aside-content ul {
-    margin: 0px;
-    padding: 0px;
-}
-
-.aside-content li {
-    display: block;
-    width: 100%;
-}
-
-/** 颜色属性 **/
-.red {
-    color:red;
-}
-
-.black {
-    color: black;
-}
-
-.orange {
-    color: orange;
-}
-
-.green {
-    color: green;
-}
-
-.gray {
-    color: gray;
-}
-
-.small-device {
-    display: none;
-}
-
-.grid-card, .card, .box {
-    float: left;
-    width: 100%;
-    background-color: #fff;
-    margin-bottom: 10px;
-}
-
-.card.btn-line-height {
-    padding-left: 10px;
-}
-
-.transparent-card {
-    float: left;
-    width: 100%;
-    margin-bottom: 10px;
-}
-
-.x-photo {
-    cursor: pointer;
-}
-
-.no-outline {
-    outline: none;
-}
-
-/** 滚动条样式 **/
-.scrollbar::-webkit-scrollbar {
-    /*滚动条整体样式*/
-    width: 10px;
-    height: 10px;
-    background-color: #eee;
-}
-
-.scrollbar::-webkit-scrollbar-thumb {
-    /*滚动条里面小方块*/
-    background-color: #999;
-}
-
-
-.scrollbar::-webkit-scrollbar-track { 
-    /*滚动条里面轨道*/
-    /*border-radius: 10px; */
-    /*background: #eee; */
-} 
-
-.x-option-dialog div.layui-layer-content {
-    padding: 10px;
-}
-
-
-.light-bottom-border {
-    border-bottom: 1px solid #eee;
-}
-
-select.no-border {
-    border: none;
-}
-
-.split-title {
-    width: 100%;
-    float: left;
-    background-color: #eee;
-    padding: 5px;
-    margin-bottom: 5px;
-    font-weight: bold;
-    line-height: normal;
-}
-
-.search-out-box {
-    float: left;
-    width: 100%;
-    padding-bottom: 10px;
-}
-
-/* 高优先级样式 */
-.col-md-1{float:left;width:8.3%;}
-.col-md-2{float:left;width:16.7%;}
-.col-md-3{float:left;width:25%;}
-.col-md-4{float:left;width:33.3%;}
-.col-md-5{float:left;width:41.7%;}
-.col-md-6{float:left;width:50%;}
-.col-md-7{float:left;width:58.3%;}
-.col-md-8{float:left;width:66.7%;}
-.col-md-9{float:left;width:75%;}
-.col-md-10{float:left;width:83.3%;}
-.col-md-11{float:left;width:91.7%;}
-.col-md-12{float:left;width:100%;}
-.col-md-offset-12{margin-left:100%;}
-.col-md-offset-11{margin-left:91.66666666666666%;}
-.col-md-offset-10{margin-left:83.33333333333334%;}
-.col-md-offset-9{margin-left:75%;}
-.col-md-offset-8{margin-left:66.66666666666666%;}
-.col-md-offset-7{margin-left:58.333333333333336%;}
-.col-md-offset-6{margin-left:50%;}
-.col-md-offset-5{margin-left:41.66666666666667%;}
-.col-md-offset-4{margin-left:33.33333333333333%;}
-.col-md-offset-3{margin-left:25%;}
-.col-md-offset-2{margin-left:16.666666666666664%;}
-.col-md-offset-1{margin-left:8.333333333333332%;}
-.col-md-offset-0{margin-left:0;}
-.top-offset-1{margin-top:5px;}
-.top-offset-2{margin-top:10px;}
-.bottom-offset-1{margin-bottom:5px;}
-.row{float: left;width: 100%;overflow: auto;}
-.pad5 {padding: 5px;}
-.pad10 {padding: 10px;}
-.pad-left-5 {padding-left: 5px;}
-.pad-bottom-10 {padding-bottom: 10px}
-
-
+/**
+ * 通用的CSS样式
+ * @author xupingmao
+ * @since 2017/12/16
+ * @modified 2022/03/16 18:57:15
+ * @filename common.css
+ * 命名规范（主要参考bootstrap）: 包含两部分，
+ * 1：简单的、望文生义的样式，比如颜色 red, blue等等
+ * 2：复杂样式，命名规则为：模块名(可选)-功能外观-子功能外观(可选)-实现方式(可选)-特征或状态(可选)，示例如下：
+ *   1. marked-code (marked模块的code组件)
+ *   2. marked-img (marked模块的图片组件)
+ *   3. list-link（外观是list，通过link实现的）
+ *   4. list-item（外观是list，通过div实现的）
+ *   5. btn-link   (外观是button，通过link实现的)
+ *   6. btn-danger (外观是button，表示危险操作)
+ *   7. btn-default (外观是button，默认样式)
+ *   8. tab-link  （外观是tab，通过link实现)
+ *   9. tab-link-activate (外观是tab，通过link实现，状态是激活)
+ *   10. x-dialog-title-box-activate（x模块下的对话框标题，div实现，状态是激活）
+ * 
+ *  注意：后声明的样式匹配优先级更高
+ */
+
+/** marked 样式 **/
+.marked-heading {
+    /* 避免顶部fixed菜单遮挡 */
+    width: 100%;
+    font-family: "Microsoft YaHei", "黑体";
+}
+
+h1.marked-heading {
+    font-size: 24px;
+}
+
+h2.marked-heading {
+    font-size: 20px;
+}
+
+h3.marked-heading {
+    font-size: 16px;
+}
+
+.marked-img {
+    text-align: center;
+}
+
+.marked-contents {
+    width: 100%;
+    border: 1px solid #ccc;
+    margin-bottom: 10px;
+}
+
+.marked-contents-title {
+    display: inline-block;
+    padding: 5px;
+}
+
+.marked-contents h1 {
+    text-align: center;
+    margin: 0px;
+    padding: 0px;
+    font-size: 20px;
+}
+
+.marked-code {
+    width: 100%;
+    background-color: #000;
+    color: #fff;
+    padding: 0.5rem;
+    border: 1px solid #ddd;
+    word-wrap: break-word;
+    white-space: pre-wrap;
+    margin: 0px;
+}
+
+.marked-codespan {
+    padding-left: 4px;
+    padding-right: 4px;
+    margin: 0;
+    /* background-color: rgba(27,31,35,.05); */
+    background-color: pink;
+    border-radius: 4px;
+    padding: 3px;
+    line-height: 23px;
+}
+
+.marked-strong {
+    color: red;
+}
+
+.marked-strong>a {
+    color: red;
+}
+
+/** 标题样式 **/
+.heading {
+    margin: 0px 0px 10px 0px;
+    padding: 5px;
+    display: block;
+    float: left;
+    width: 100%;
+    font-size: 16px;
+    background: #eee;
+    border-left: 5px solid #039BE5;
+}
+
+/** label **/
+.label {
+    display: inline-block;
+    width: 100px;
+}
+
+.btn-link, .button-link {
+    text-decoration: none;
+    cursor: pointer;
+}
+
+.btn-link:hover, .button-link:hover {
+    background: #ccc;
+}
+
+.link, .black-link, .link2 {
+    margin-right: 5px;
+    cursor: pointer;
+}
+
+.link {
+    /*color: #37a; */
+    color: #08c;
+}
+
+.black-link {
+    color: black;
+}
+
+.link2 {
+    color: black;
+}
+
+.link2:hover {
+    color: gray;
+}
+
+.path-link, .default-path-link {
+    line-height: 28px;
+    color: #000;
+}
+
+.path-link:hover, .default-path-link:hover {
+    color: #888;
+}
+
+.default-path-link {
+    color: #08c;
+}
+
+.danger-link {
+    color: red;
+}
+
+.selected-link {
+    /*border-bottom: 2px solid red;*/
+    color: red;
+}
+
+/* 高对比度link */
+.contract-link {
+    display: inline-block;
+    color: #08c;
+    line-height: 20px;
+    float: left;
+    margin: 3px;
+    padding: 3px;
+    text-decoration: none;
+}
+
+.contract-link:hover {
+    color: white;
+    background-color: #08c;
+    text-decoration: none;
+}
+
+/* 菜单的链接样式 */
+.nav-item>a, .menu-link {
+    color: white;
+    padding: 3px 5px;
+    text-decoration: none;
+    font-size: 16px;
+}
+
+.nav-item>a:hover, .menu-link:hover {
+    text-decoration: underline;
+}
+
+/** 表格 **/
+.no-border-table td {
+    border: none;
+}
+
+.table {
+    width: 100%;
+}
+
+.table th{
+    border-color: #ccc;
+    text-align: left;
+}
+
+.table td {
+    border-color: #ccc;
+    word-wrap: break-word;
+    word-break: break-all;
+}
+
+/* 
+这种方式走不通,需要声明hover-tr
+.table tr:hover td{
+    background-color: none;
+}
+
+.table tr:hover{
+    background-color: #eee;
+}
+ */
+
+.row-no, .index-td {
+    width: 50px;
+}
+
+.hover-tr:hover td {
+    background: none;
+}
+
+.hover-tr:hover {
+    background-color: #eee;
+}
+
+.line-td {
+    border-top: none;
+    border-left: none;
+    border-right: none;
+}
+
+/** 列表样式 **/
+.list-item, .list-link {
+    width: 100%;
+    padding: 10px 5px;
+    margin-top: 0px;
+    margin-bottom: 0px;
+    float: left;
+    line-height: 25px;
+    border-bottom: 1px solid #eee;
+    cursor: pointer;
+}
+
+.list-item:last-of-type, .list-link:last-of-type {
+    border-bottom: none;
+}
+
+.list-item:hover, .list-link:hover {
+    background-color: #eee;
+}
+
+.list-link i, .list-item i {
+    color: black;
+}
+
+.list-item-badge {
+    color: #888;
+}
+
+/** 以下为具体场景下的样式 **/
+.menu-selected {
+    background: #0088cc;
+    color: #fff;
+}
+
+/** 侧边栏样式 **/
+.nav-sidebar > .active > a,
+.nav-sidebar > .active > a:hover,
+.nav-sidebar > .active > a:focus {
+  color: #fff;
+  background-color: #428bca;
+}
+
+.hide, .hidden {
+    display: none;
+}
+
+.hidden-file {
+    display: none;
+}
+
+.tool-div {
+    font-size: medium;
+}
+
+.tool-div a {
+    font-size: medium;
+    color: blue;
+}
+
+.tool-description {
+    font-size: small;
+    padding-top: 3px;
+}
+
+.xnote-menu {
+    padding-left:0;
+}
+
+li.menu-item {
+    float: left;
+    display: block;
+    padding-left: 10px;
+    padding-right: 10px;
+    padding-top: 5px;
+    padding-bottom: 5px;
+}
+
+li.menu-active {
+    padding-bottom: 3px;
+    border-style: solid;
+    border-color: #99cc33;
+    border-top: 0px;
+    border-left: 0px;
+    border-right: 0px;
+    border-bottom-width: 2px;
+}
+
+li.menu-item a {
+    text-decoration: none; 
+    color: #fff;
+}
+
+li.menu-item a:hover {
+    background-color: inherit;
+}
+
+li.menu-item:hover {
+    background-color: #777;
+}
+
+/** base START **/
+
+.header {
+  width: 100%;
+  background-color: #eee;
+  position: fixed;
+  left: 0px;
+  top: 0px;
+}
+
+
+.root {
+    /*    
+    padding-bottom: 10px;
+    width: 1000px;
+    height: 100%;
+    overflow: hidden;
+    margin-left: 0px;
+    margin: 0 auto;
+    */
+}
+
+.nav {
+    float: left;
+    width: 100%;
+    background-color: #515865;
+}
+
+.nav-container {
+    float: left;
+    width: 1000px;
+    padding-left: 10px;
+    padding-right: 10px;
+}
+
+.nav-left {
+    display: none;
+}
+
+.x-center {
+    /* 具体样式由 base_layout.html 脚本动态调整 */
+}
+
+.x-center.dev-info {
+    padding-left: 10px;
+    padding-right: 10px;
+}
+
+.x-left {
+    display: none;
+}
+
+.x-body {
+    float: left;
+    width: 100%;
+    margin: 0 auto;
+    margin-top: 10px;
+    min-height: 400px;
+    /*padding: 0px 10%;*/
+}
+
+.footer {
+    float: left;
+    color: #fff;
+    background-color: #515865;
+    width: 100%;
+    font-size: 14px;
+}
+
+.nav-top {
+  width: 100%;
+  float: left;
+  margin-top: 40px;
+}
+
+.nav-top * {
+  margin: 0px;
+  padding: 0px;
+  color: black;
+}
+
+.nav-top h1 {
+  font-family: "monospace Consolas";
+}
+
+.nav-top ul {
+  height: 30px;
+  width: 100%;
+  padding-left: 10px;
+}
+
+.nav-top li {
+  display: block;
+  float: left;
+  padding: 5px;
+}
+
+.nav-left-search {
+    float: left;
+    padding: 10px;
+    display: none;
+    padding-bottom: 0px;
+}
+
+.nav-search-input {
+    width: 100%;
+    height: 30px;
+    outline: none;
+    padding-left: 5px;
+    padding-right: 30px;
+    float: left;
+    display: block;
+    border: 1px solid #ccc;
+}
+
+.nav-search-btn {
+    float: left;
+    height: 30px;
+    width: 30px;
+    margin-left: -30px;
+    margin-top: 0px;
+    border-radius: 0px;
+}
+
+.nav-search {
+    width: 345px;
+    float: right;
+    padding: 10px 0px;
+}
+
+.navMenu-top { 
+  padding: 10px; 
+  color: #fff; 
+  border-bottom: 1px solid rgba(255,255,255,.1) 
+}
+
+.notice {
+    border: 1px solid #ccc;
+    background-color: #cef2e0;
+    margin-top: 3px;
+    margin-bottom: 3px;
+    padding-left: 3px;
+}
+
+.form-control {
+    width: 100%;
+}
+
+
+/** file-list样式 END **/
+
+.green-text {
+    color: green;
+}
+
+.green-bg {
+    color: #fff;
+    background-color: green;
+}
+
+.red-bg {
+    background-color: red;
+}
+
+.red-text {
+    color: #f00;
+}
+
+.blue-text {
+    color: #00f;
+}
+
+.center-text {
+    text-align: center;
+}
+
+.gray-text {
+    color: #888;
+}
+
+.error {
+    padding: 5px;
+    background-color: #f2dede;
+    margin: 0px;
+}
+
+.warn {
+    margin: 0px;
+    padding: 5px;
+    background-color: #ffc;
+}
+
+.info {
+    padding: 5px;
+    background-color: #C1FFC1;
+    margin: 0px;
+}
+
+.info.light {
+    background-color: #eee;
+}
+
+.success {
+    padding: 5px;
+    margin: 0px;
+    background-color: #cf9;
+}
+
+.x-dialog {
+    display: none;
+    position: fixed;
+    margin: 0 auto;
+    background-color: #fff;
+    z-index: 100;
+    overflow-y: hidden;
+}
+
+.x-dialog-title {
+    margin: 0 auto;
+    width: 100%;
+    background-color: #214FA3;
+    color: #fff;
+    padding: 5px;
+    cursor: move;
+    height: 36px;
+    line-height: 26px;
+}
+
+.x-dialog-body {
+    float: left;
+    width: 100%;
+    overflow-y: auto;
+}
+
+.x-dialog-background {
+    display: none;
+    position: fixed;
+    left: 0px;
+    top: 0px;
+    width: 100%;
+    height: 100%;
+    background-color: #000;
+    opacity: 0.5;
+}
+
+.background {
+    display: none;
+    position: fixed;
+    left: 0px;
+    top: 0px;
+    width: 100%;
+    height: 100%;
+    background-color: #000;
+    opacity: 0.5;
+}
+
+.x-dialog-ajax {
+    display: block;
+}
+
+.x-dialog-close {
+    background-color: red;
+    float: right;
+    border: none;
+    margin-top: 0px;
+    border: 1px solid transparent;
+}
+
+.x-dialog-close:hover {
+    border: 1px solid black;
+}
+
+.dialog-close-btn {
+    float: right;
+    padding-left: 5px;
+    padding-right: 5px;
+    color: #fff;
+    cursor: pointer;
+    line-height: 30px;
+}
+
+.dialog-close-btn:hover {
+    background-color: red;
+}
+
+.dialog-title-btn {
+    float: left;
+    padding-left: 5px;
+    padding-right: 5px;
+    color: #fff;
+    cursor: pointer;
+    line-height: 30px;
+}
+
+.dialog-title-btn:hover {
+    background-color: gray;
+}
+
+
+.dialog-title {
+    float: left;
+    width: 100%;
+    height: 30px;
+    background-color: #3c3333
+}
+
+.dialog-iframe {
+    float: left;
+    width: 100%;
+    height: 100%;
+    border: none
+}
+
+
+.no-border tr td {
+    border: none;
+}
+
+.input-group {
+    float:left;
+    width:300px;
+    padding-bottom:5px;
+    max-width: 700px;
+    line-height: 29px;
+}
+
+.input-group label {
+    width: 120px;
+    float: left;
+    padding-right: 10px;
+    line-height: 29px;
+    text-align: right;
+}
+
+.input-group input[type=text], .input-group input[type=password], .input-group select {
+    width: 160px;
+}
+
+.input-group button {
+    margin-top: 0px;
+}
+
+.input-group-row {
+    float: left;
+    width: 100%;
+    margin-top: 10px;
+}
+
+.input-group-row input, .input-group-row select {
+    width: 200px;
+}
+
+#searchBox {
+    margin-bottom: 5px;
+}
+
+.search-input {
+    float: left;
+    height:40px;
+    padding-left: 10px;
+    padding-right: 40px;
+    width: 100%;
+    max-width: 500px;
+    outline: none;
+    box-sizing: border-box;
+}
+
+.search-btn {
+    float: left;
+    right: 10px;
+    background: #355380; 
+    color: #fff; 
+    border: none;
+    border-radius:0px;
+    /*max-width:25%;*/
+    width: 40px;
+    height: 40px;
+    margin-left: -40px;
+}
+
+.item-option {
+    color: #aaa;
+    cursor: pointer;
+    font-size: 12px;
+}
+
+.item-option:hover {
+    color: #000;
+    background: none;
+    text-decoration: underline;
+}
+
+.fs-path {
+    float: left;
+    width: 100%;
+    padding: 5px;
+    box-sizing: border-box;
+    background-color: #eee;
+}
+
+.fs-file {
+    color: black;
+    cursor: pointer;
+}
+
+.fs-folder {
+    color: blue;
+}
+
+/** 知识库列表样式 **/
+#fileTable td {
+    border-top: none;
+    border-left: none;
+    border-right: none;
+}
+
+.group-link {
+    color: #08c;
+}
+
+.grid-title, .card-title {
+    width: 100%;
+    float: left;
+    border-left: 5px solid #039BE5;
+    margin-top: 0px;
+    margin-bottom: 5px;
+    font-family: arial,"Sim Sun";
+    font-size: 14px;
+    font-weight: normal;
+    overflow: initial;
+    padding-left: 5px;
+}
+
+.card-title-2 {
+    padding: 5px;
+    margin: 0px;
+    background-color: #eee;
+}
+
+.grid-row {
+    width: 100%;
+    float: left;
+}
+
+.grid-link {
+    display: block;
+    float: left;
+    width: 220px;
+    padding: 5px;
+    margin: 5px;
+    margin-top: 0px;
+    margin-bottom: 0px;
+    line-height: 25px;
+}
+
+.grid-link:hover {
+    background: #eee;
+}
+
+.grid-item {
+    width: 20%;
+    padding: 5px;
+    /*margin: 5px;*/
+    margin-top: 0px;
+    margin-bottom: 0px;
+    float: left;
+    line-height: 25px;
+}
+
+.group-div {
+    width: 220px;
+    padding: 5px;
+    margin: 5px;
+    margin-top: 0px;
+    margin-bottom: 0px;
+    /*border: 1px solid #ccc;*/
+    box-sizing: border-box;
+    float: left;
+    line-height: 25px;
+}
+
+.group-div:hover {
+    background-color: #eee;
+}
+
+.children-count {
+    float: right;
+}
+
+.note-link {
+    color: #08c;
+}
+
+.scroll-y {
+    overflow-y: auto;
+}
+
+.float-left {
+    float: left;
+}
+
+.float-right {
+    float: right;
+}
+
+.align-right {
+    text-align: right;
+}
+
+.align-center {
+    text-align: center;
+}
+
+.small-font {
+    font-size: small;
+}
+
+.code {
+    font-family: Consolas, monospace;
+}
+
+.nav-ul {
+    display: block;
+    float: left;
+    list-style: none;
+    padding-left: 0px;
+    margin: 0px;
+    line-height: 50px;
+}
+
+.nav-item {
+    padding-right: 5px;
+    display: block;
+    float: left;
+}
+
+.keyword {
+    color: blue;
+}
+
+.output-title {
+    width: 100%;
+    border: 1px solid #ccc;
+    padding-left: 5px;
+    margin-top: 5px;
+}
+
+.output-body {
+    border: 1px solid #ccc;
+    padding: 4px;
+    background-color: #eee;
+    box-sizing: border-box;
+    margin: 0px;
+    border-top: none;
+    font-family: consolas, monospace;
+}
+
+
+.bot-btn {
+    position: fixed;
+    bottom: 50px;
+    width: 50px;
+    height: 40px;
+    font-size: 14px;
+    background-color: #00c1de;
+    cursor: pointer;
+    border-radius: 5px;
+    color: #fff;
+    padding: 10px;
+    z-index: 100;
+    opacity: 0.8
+}
+
+.border {
+    border: solid 1px #ccc;
+}
+
+.main-content {
+    float: left;
+    width: 1000px;
+    min-height: 20px;
+    padding: 10px;
+    background-color: #fff;
+}
+
+.main-content-bg {
+    background-color: #fff;
+}
+
+.aside {
+    float: left;
+    width: 220px;
+    margin-left: -220px;
+    display: none;
+}
+
+.aside-item {
+    background-color: white;
+    border: 1px solid #ccc;
+    width: 100%;
+    float: left;
+    margin-bottom: 10px;
+}
+
+.aside-item li {
+    list-style: none;
+    line-height: 20px;
+}
+
+.aside-title {
+    border-bottom: 1px solid #ccc;
+    /*background-color: #efefef;*/
+    padding: 5px;
+}
+
+.aside-content {
+    margin: 5px;
+}
+
+.aside-content ul {
+    margin: 0px;
+    padding: 0px;
+}
+
+.aside-content li {
+    display: block;
+    width: 100%;
+}
+
+/** 颜色属性 **/
+.red {
+    color:red;
+}
+
+.black {
+    color: black;
+}
+
+.orange {
+    color: orange;
+}
+
+.green {
+    color: green;
+}
+
+.gray {
+    color: gray;
+}
+
+.small-device {
+    display: none;
+}
+
+.grid-card, .card, .box {
+    float: left;
+    width: 100%;
+    background-color: #fff;
+    margin-bottom: 10px;
+}
+
+.card.btn-line-height {
+    padding-left: 10px;
+}
+
+.transparent-card {
+    float: left;
+    width: 100%;
+    margin-bottom: 10px;
+}
+
+.x-photo {
+    cursor: pointer;
+}
+
+.no-outline {
+    outline: none;
+}
+
+/** 滚动条样式 **/
+.scrollbar::-webkit-scrollbar {
+    /*滚动条整体样式*/
+    width: 10px;
+    height: 10px;
+    background-color: #eee;
+}
+
+.scrollbar::-webkit-scrollbar-thumb {
+    /*滚动条里面小方块*/
+    background-color: #999;
+}
+
+
+.scrollbar::-webkit-scrollbar-track { 
+    /*滚动条里面轨道*/
+    /*border-radius: 10px; */
+    /*background: #eee; */
+} 
+
+.x-option-dialog div.layui-layer-content {
+    padding: 10px;
+}
+
+
+.light-bottom-border {
+    border-bottom: 1px solid #eee;
+}
+
+select.no-border {
+    border: none;
+}
+
+.split-title {
+    width: 100%;
+    float: left;
+    background-color: #eee;
+    padding: 5px;
+    margin-bottom: 5px;
+    font-weight: bold;
+    line-height: normal;
+}
+
+.search-out-box {
+    float: left;
+    width: 100%;
+    padding-bottom: 10px;
+}
+
+/* 高优先级样式 */
+.col-md-1{float:left;width:8.3%;}
+.col-md-2{float:left;width:16.7%;}
+.col-md-3{float:left;width:25%;}
+.col-md-4{float:left;width:33.3%;}
+.col-md-5{float:left;width:41.7%;}
+.col-md-6{float:left;width:50%;}
+.col-md-7{float:left;width:58.3%;}
+.col-md-8{float:left;width:66.7%;}
+.col-md-9{float:left;width:75%;}
+.col-md-10{float:left;width:83.3%;}
+.col-md-11{float:left;width:91.7%;}
+.col-md-12{float:left;width:100%;}
+.col-md-offset-12{margin-left:100%;}
+.col-md-offset-11{margin-left:91.66666666666666%;}
+.col-md-offset-10{margin-left:83.33333333333334%;}
+.col-md-offset-9{margin-left:75%;}
+.col-md-offset-8{margin-left:66.66666666666666%;}
+.col-md-offset-7{margin-left:58.333333333333336%;}
+.col-md-offset-6{margin-left:50%;}
+.col-md-offset-5{margin-left:41.66666666666667%;}
+.col-md-offset-4{margin-left:33.33333333333333%;}
+.col-md-offset-3{margin-left:25%;}
+.col-md-offset-2{margin-left:16.666666666666664%;}
+.col-md-offset-1{margin-left:8.333333333333332%;}
+.col-md-offset-0{margin-left:0;}
+.top-offset-1{margin-top:5px;}
+.top-offset-2{margin-top:10px;}
+.bottom-offset-1{margin-bottom:5px;}
+.row{float: left;width: 100%;overflow: auto;}
+.pad5 {padding: 5px;}
+.pad10 {padding: 10px;}
+.pad-left-5 {padding-left: 5px;}
+.pad-bottom-10 {padding-bottom: 10px}
+
+
 
 
 /** 移动端样式放在最后 **/
 @media screen and (max-width: 1000px) {
     /** mobile **/
 
     .root {
@@ -1669,185 +1669,185 @@
     }
 
     .desktop-only, .desktop-only-inline, .desktop-only-inline-block {
         display: none;
     }
 
 }
-/**
- * description here
- * @author xupingmao
- * @since 2021/07/25 12:04:40
- * @modified 2022/03/13 16:38:20
- * @filename common-button.css
- */
-
-
-.fixed-button-box {
-    position: fixed;
-    right: 20px;
-    bottom: 20%;
-}
-
-.fixed-bottom-box {
-    position: fixed;
-    width: 80%;
-    left: 10%;
-    bottom: 0px;
-}
-
-.fixed-button {
-    color: white;
-    display: block;
-    width: 100%;
-    text-align: center;
-    background-color: black;
-    margin-top: 20px;
-    padding: 5px;
-    border-radius: 5px;
-    opacity: 0.6;
-    box-shadow: 2px 2px 2px #888;
-}
-
-.fixed-button:hover {
-    opacity: 1.0;
-}
-
-.fixed-button-inner-box {
-    float: left;
-    width: 50%;
-    padding: 10px;
-}
-
-.fixed-button-2 {
-    color: white;
-    display: block;
-    width: 100%;
-    float: left;
-    text-align: center;
-    background-color: black;
-    padding: 5px;
-    border-radius: 5px;
-    opacity: 0.6;
-    box-shadow: 2px 2px 2px #888;
-}
-
-
-/** 按钮样式 **/
-
-/* 不能指定input[type=button]不然会覆盖其他class样式(选择器优先级过高) */
-.btn, [type=submit], [type=button], button, .inline-btn, .x-tab-btn {
-    display: inline-block;
-    -webkit-appearance: none; /* 消除IOS默认的按钮样式 */
-    background-color: #337ab7;
-    /*background-color: #067bef;*/
-    /*background-color: #06f;*/
-    border-color: #2e6da4;
-    border: 1px solid transparent;
-    color: #fff;
-    text-decoration: none;
-    margin-top: 5px;
-    padding: 3px 7px 3px;
-    font-size: 12px;
-    font-weight: bold;
-    line-height: 18px;
-    border-radius: 3px;
-    font-family: "Open Sans",Arial,Helvetica,sans-senif,"Microsoft Yahei",SimSun,"宋体";
-}
-
-.btn.large, [type=button].large, button.large {
-    padding-left: 20px;
-    padding-right: 20px;
-}
-
-.btn:hover, .inline-btn:hover, button:hover, [type=submit]:hover, [type=button]:hover {
-    color: #fff;
-    background-color: #286090;
-    border-color: #204d74;
-    cursor: pointer;
-    text-decoration: none;
-}
-
-.btn-default, .btn-cancel {
-    color: black;
-    background-color: #eee;
-    border: 1px solid #ccc;
-    border-radius: 3px;
-}
-
-.btn-default:hover, .btn-cancel:hover {
-    color: black;
-    background-color: #ccc;
-}
-
-.btn-danger {
-    background-color: #f00;
-    border-radius: 3px;
-}
-
-.btn-danger:hover {
-    background-color: #c00;
-}
-
-.btn-line-height {
-    line-height: 32px;
-}
-
-.inline-btn {
-    margin-top: 0px;
-    border-radius: 3px;
-}
-
-.prompt-btn:hover {
-    cursor: pointer;
-}
-
-.btn.danger {
-    color: red;
-    background-color: #eee;
-    border: 1px solid #ccc;
-    border-radius: 3px;
-}
-
-.btn.danger:hover {
-    background-color: #ccc;
-    border-color: #000;
-}
-
-.btn.danger2 {
-    color: red;
-}
-
-
-.toolbar.homepage {
-    position: fixed;
-    right: 10px;
-    bottom: 20%;
-}
-
-.toolbar.homepage>.action {
-    width: 50px;
-    background-color: white;
-    cursor: pointer;
-    padding: 10px;
-    opacity: 0.5;
-}
-
-.toolbar.homepage>.action:hover {
-    opacity: 1.0;
-}
-
-.btn.large {
-    width: 100px;
-    height: 30px;
-}
-
-.btn.huge {
-    width: 100%;
-    height: 30px;
+/**
+ * description here
+ * @author xupingmao
+ * @since 2021/07/25 12:04:40
+ * @modified 2022/03/13 16:38:20
+ * @filename common-button.css
+ */
+
+
+.fixed-button-box {
+    position: fixed;
+    right: 20px;
+    bottom: 20%;
+}
+
+.fixed-bottom-box {
+    position: fixed;
+    width: 80%;
+    left: 10%;
+    bottom: 0px;
+}
+
+.fixed-button {
+    color: white;
+    display: block;
+    width: 100%;
+    text-align: center;
+    background-color: black;
+    margin-top: 20px;
+    padding: 5px;
+    border-radius: 5px;
+    opacity: 0.6;
+    box-shadow: 2px 2px 2px #888;
+}
+
+.fixed-button:hover {
+    opacity: 1.0;
+}
+
+.fixed-button-inner-box {
+    float: left;
+    width: 50%;
+    padding: 10px;
+}
+
+.fixed-button-2 {
+    color: white;
+    display: block;
+    width: 100%;
+    float: left;
+    text-align: center;
+    background-color: black;
+    padding: 5px;
+    border-radius: 5px;
+    opacity: 0.6;
+    box-shadow: 2px 2px 2px #888;
+}
+
+
+/** 按钮样式 **/
+
+/* 不能指定input[type=button]不然会覆盖其他class样式(选择器优先级过高) */
+.btn, [type=submit], [type=button], button, .inline-btn, .x-tab-btn {
+    display: inline-block;
+    -webkit-appearance: none; /* 消除IOS默认的按钮样式 */
+    background-color: #337ab7;
+    /*background-color: #067bef;*/
+    /*background-color: #06f;*/
+    border-color: #2e6da4;
+    border: 1px solid transparent;
+    color: #fff;
+    text-decoration: none;
+    margin-top: 5px;
+    padding: 3px 7px 3px;
+    font-size: 12px;
+    font-weight: bold;
+    line-height: 18px;
+    border-radius: 3px;
+    font-family: "Open Sans",Arial,Helvetica,sans-senif,"Microsoft Yahei",SimSun,"宋体";
+}
+
+.btn.large, [type=button].large, button.large {
+    padding-left: 20px;
+    padding-right: 20px;
+}
+
+.btn:hover, .inline-btn:hover, button:hover, [type=submit]:hover, [type=button]:hover {
+    color: #fff;
+    background-color: #286090;
+    border-color: #204d74;
+    cursor: pointer;
+    text-decoration: none;
+}
+
+.btn-default, .btn-cancel {
+    color: black;
+    background-color: #eee;
+    border: 1px solid #ccc;
+    border-radius: 3px;
+}
+
+.btn-default:hover, .btn-cancel:hover {
+    color: black;
+    background-color: #ccc;
+}
+
+.btn-danger {
+    background-color: #f00;
+    border-radius: 3px;
+}
+
+.btn-danger:hover {
+    background-color: #c00;
+}
+
+.btn-line-height {
+    line-height: 32px;
+}
+
+.inline-btn {
+    margin-top: 0px;
+    border-radius: 3px;
+}
+
+.prompt-btn:hover {
+    cursor: pointer;
+}
+
+.btn.danger {
+    color: red;
+    background-color: #eee;
+    border: 1px solid #ccc;
+    border-radius: 3px;
+}
+
+.btn.danger:hover {
+    background-color: #ccc;
+    border-color: #000;
+}
+
+.btn.danger2 {
+    color: red;
+}
+
+
+.toolbar.homepage {
+    position: fixed;
+    right: 10px;
+    bottom: 20%;
+}
+
+.toolbar.homepage>.action {
+    width: 50px;
+    background-color: white;
+    cursor: pointer;
+    padding: 10px;
+    opacity: 0.5;
+}
+
+.toolbar.homepage>.action:hover {
+    opacity: 1.0;
+}
+
+.btn.large {
+    width: 100px;
+    height: 30px;
+}
+
+.btn.huge {
+    width: 100%;
+    height: 30px;
 }/**
  * markdown的样式扩展
  * @author xupingmao
  * @since 2021/08/01 14:25:17
  * @modified 2022/03/27 16:53:38
  * @filename common-markdown.css
  */
@@ -1879,30 +1879,50 @@
     padding: 2px;
     border-radius: 2px;
 }
 
 .xnote-todo.doing {
     color: black;
     background-color: #98FB98;
-}/**
- * description here
- * @author xupingmao
- * @since 2021/11/28 19:24:44
- * @modified 2021/11/28 19:28:07
- * @filename common-dialog.css
- */
-
-.dialog-textarea {
-    position: absolute;
-    width: 100%;
-    font-size: 14px;
-    top: 0px;
-    bottom: 0px;
-}
-/**
+}/**
+ * description here
+ * @author xupingmao
+ * @since 2021/11/28 19:24:44
+ * @modified 2021/11/28 19:28:07
+ * @filename common-dialog.css
+ */
+
+.dialog-textarea {
+    position: absolute;
+    left: 0px;
+    right: 0px;
+    font-size: 14px;
+    top: 0px;
+    bottom: 0px;
+}
+
+
+.dialog-body {
+    position: absolute;
+    padding: 10px;
+    top: 0px;
+    bottom: 50px;
+    overflow-y: auto;
+    right: 0px;
+    left: 0px;
+}
+
+.dialog-footer {
+    position: absolute;
+    bottom: 0px;
+    left: 0px;
+    right: 0px;
+    height: 50px;
+    padding: 10px;
+}/**
  * description here
  * @author mark
  * @since 2022/03/11 21:46:22
  * @modified 2022/03/16 18:10:23
  * @filename common-tab.css
  */
 
@@ -2233,141 +2253,141 @@
 /* 小屏幕设备 <768px */
 @media screen and (max-width: 768px) {
 
     .hidden-xs {
         display: none;
     }
 
-}/**
- * 应用相关的CSS样式
- * @author xupingmao
- * @since 2019/06/16
- * @modified 2019/12/15 18:26:57
-*/
-
-/* 上传文件样式 */
-.progress {
-    background-color: #f90;
-    color: #fff;
-    height: 20px;
-    display: none;
-    margin-left: 5px;
-    border-width: 3px;
-}
-.progress span {
-    display: block;
-    background-color: #f90;
-    color: #fff;
-    height: 100%;
-}
-
-.finished-tag {
-    color: #fff;
-    background-color: green;
-    border-width: 3px;
-    border-radius: 3px;
-    margin-left: 5px;
-}
-
-#dropArea {
-    float: left;
-    width: 100%;
-    height: 80px;
-    line-height: 80px;
-    border: 3px dashed silver;
-    text-align: center;
-    font-size: 36px;
-    color: #d3d3d3;
-    cursor: pointer;
-}
-
-.file-item {
-    float: left;
-    width: 100%;
-}
-
-.file-item-icon {
-    display: block;
-    float: left;
-    width: 100px;
-    height: 100px;
-    line-height: 100px;
-    text-align: center;
-}
-
-.file-item-info {
-    padding: 10px;
-    float: left;
-    width: calc(100% - 100px);
-}
-
-.menu-aside {
-    display: none;
-}
-
-.option-name {
-    width: 60%;
-}
-
-.option-td {
-    width: 20%;
-}
-
-#poweredBy {
-    position: absolute; 
-    bottom: 0px; 
-    left: 0px; 
-    right: 0px; 
-    padding: 15px; 
-    padding-left: 40px;
-    padding-right: 0px;
-    border-top: 1px solid #ccc;
-}
-
-#poweredBy,
-#poweredBy a {
-    color: white;
-}
-
-#poweredBy a {
-    text-decoration: underline;
-}
-
-.item-ext-info {
-    padding-top: 10px;
-}
-
-.note-group-select {
-    padding: 5px;
-}
-
-.suggest-link {
-    padding-right: 10px;
-}
-
-@media screen and (max-width: 800px) {
-    /** mobile **/
-    #dropArea {
-        font-size: 24px;
-    }
-
-    .recent-note-date {
-        font-size: 12px;
-    }
-
-    .x-left {
-        display: none;
-    }
-
-    .x-body {
-        position: static;
-        width: 100%;
-    }
-}
-
+}/**
+ * 应用相关的CSS样式
+ * @author xupingmao
+ * @since 2019/06/16
+ * @modified 2019/12/15 18:26:57
+*/
+
+/* 上传文件样式 */
+.progress {
+    background-color: #f90;
+    color: #fff;
+    height: 20px;
+    display: none;
+    margin-left: 5px;
+    border-width: 3px;
+}
+.progress span {
+    display: block;
+    background-color: #f90;
+    color: #fff;
+    height: 100%;
+}
+
+.finished-tag {
+    color: #fff;
+    background-color: green;
+    border-width: 3px;
+    border-radius: 3px;
+    margin-left: 5px;
+}
+
+#dropArea {
+    float: left;
+    width: 100%;
+    height: 80px;
+    line-height: 80px;
+    border: 3px dashed silver;
+    text-align: center;
+    font-size: 36px;
+    color: #d3d3d3;
+    cursor: pointer;
+}
+
+.file-item {
+    float: left;
+    width: 100%;
+}
+
+.file-item-icon {
+    display: block;
+    float: left;
+    width: 100px;
+    height: 100px;
+    line-height: 100px;
+    text-align: center;
+}
+
+.file-item-info {
+    padding: 10px;
+    float: left;
+    width: calc(100% - 100px);
+}
+
+.menu-aside {
+    display: none;
+}
+
+.option-name {
+    width: 60%;
+}
+
+.option-td {
+    width: 20%;
+}
+
+#poweredBy {
+    position: absolute; 
+    bottom: 0px; 
+    left: 0px; 
+    right: 0px; 
+    padding: 15px; 
+    padding-left: 40px;
+    padding-right: 0px;
+    border-top: 1px solid #ccc;
+}
+
+#poweredBy,
+#poweredBy a {
+    color: white;
+}
+
+#poweredBy a {
+    text-decoration: underline;
+}
+
+.item-ext-info {
+    padding-top: 10px;
+}
+
+.note-group-select {
+    padding: 5px;
+}
+
+.suggest-link {
+    padding-right: 10px;
+}
+
+@media screen and (max-width: 800px) {
+    /** mobile **/
+    #dropArea {
+        font-size: 24px;
+    }
+
+    .recent-note-date {
+        font-size: 12px;
+    }
+
+    .x-left {
+        display: none;
+    }
+
+    .x-body {
+        position: static;
+        width: 100%;
+    }
+}
+
 /**
  * 备忘消息的CSS样式
  * @author xupingmao
  * @since 2019/11/24
  * @modified 2022/04/16 10:35:15
 */
 
@@ -2656,372 +2676,372 @@
 
 
 /** 移动端样式放在最后 **/
 @media screen and (max-width: 360px) {
     /** mobile **/
 
 }
-/**
- * 笔记的CSS样式
- * @author xupingmao
- * @since 2019/11/24
- * @modified 2022/03/16 18:52:34
-*/
-
-
-/** note-list样式 **/
-.note-list>a:last-child>.book-item {
-    border-bottom: none;
-}
-
-.book-list>a:last-child>.book-item {
-    border-bottom: none;
-}
-
-.card>.book-item:last-child {
-    border-bottom: none;
-}
-
-.tool-div {
-    font-size: medium;
-}
-
-.tool-div a {
-    font-size: medium;
-    color: blue;
-}
-
-.tool-description {
-    font-size: small;
-    padding-top: 3px;
-}
-
-.note {
-    float: left;
-    border: solid 1px;
-    border-color: #ccc;
-    background-color: #fff;
-    margin-bottom: 10px;
-    width: 100%;
-}
-
-.note-body {
-    padding: 5px;
-    word-break: break-all;
-}
-
-.note-head {
-    font-size: 20px;
-}
-
-.note-head-info {
-    padding: 5px;
-    background-color: #eee;
-    color: #555;
-    margin: 0px;
-}
-
-.note-name {
-    /*font-size: 20px;*/
-    line-height: 25px;
-}
-
-.note-name a {
-    font-size: medium;
-    color: blue;
-}
-
-.note-title {
-    width: 100%;
-    float: left;
-}
-
-.note-info {
-    width: 100%;
-    float: left;
-}
-
-.note-info span {
-    display: inline-block;
-    padding-top: 2px;
-}
-
-.note-time {
-    font-size: 12px;
-    color: #aaa;
-}
-
-.note-content-short {
-    font-size: small;
-    word-break: break-all;
-}
-
-.note-last-modify-time,
-.note-last-visit-time {
-    padding-left: 2px;
-    padding-top: 2px;
-    font-size: small;
-    color: green;
-}
-
-.note-related {
-    font-size: 6px;
-    padding-left: 5px;
-    color: red;
-    display: none;
-}
-.note-visited-cnt {
-    float: right;
-    font-size: small;
-}
-
-
-/** 笔记样式 **/
-.note-head {
-    font-size: 20px;
-}
-
-.note-name a {
-    font-size: medium;
-    color: blue;
-}
-
-.note-content-short {
-    font-size: small;
-    word-break: break-all;
-}
-
-.note-detail-head {
-    float: left;
-    width: 100%;
-    padding: 5px;
-    padding-bottom: 5px;
-    border: 1px solid #ccc;
-}
-
-.note-detail-foot {
-    float: left;
-    width: 100%;
-    padding: 5px;
-    border: 1px solid #ccc;
-}
-
-.note-last-visit-time {
-    padding-left: 2px;
-    padding-top: 2px;
-    font-size: small;
-    color: green;
-}
-
-.note-related {
-    font-size: 6px;
-    padding-left: 5px;
-    color: red;
-    display: none;
-}
-.note-visited-cnt {
-    float: right;
-    font-size: small;
-}
-
-/** 评论 **/
-.comment-row {
-    width: 100%;
-    float: left;
-    padding: 5px;
-    border: 1px solid #ccc;
-    border-radius: 2px;
-    margin-top: 5px;
-    margin-bottom: 5px;
-}
-
-.comment-user {
-    float: left;
-    font-weight: bold;
-}
-
-.comment-foot {
-    float: left;
-    width: 100%;
-}
-
-.comment-foot>.comment-foot-link {
-    color: #08c;
-}
-
-.comment-time {
-    float: right;
-    font-size: 12px;
-    color: #555;
-}
-
-.comment-content {
-    float: left;
-    width: 100%;
-    padding: 10px;
-}
-
-.book-item {
-    width: 100%;
-    padding: 10px 5px;
-    margin-top: 0px;
-    margin-bottom: 0px;
-    float: left;
-    line-height: 25px;
-    border-bottom: 1px solid #eee;
-}
-
-.book-item:hover {
-    background-color: #efefef;
-}
-
-.book-size {
-    float: right;
-    color: black;
-}
-
-.book-size-span {
-    color: #888;
-}
-
-.nav-book-size-span {
-    color: #888;
-    float: right;
-}
-
-/** group select **/
-
-.group-select-search {
-    float: left;
-    width: 100%;
-    padding: 5px;
-}
-
-.group-select-header {
-    width: 100%;
-    padding: 5px;
-    margin: 0px;
-    background-color: #eee;
-    /*float: left;*/
-    /*display: block;*/
-}
-
-.group-select-size {
-    float: right;
-    color: #ccc;
-}
-
-.group-select-row {
-    padding-left: 20px;
-    margin: 14px 0px 14px 0px;
-    padding-top: 0px;
-    padding-right: 0px;
-    /*float: left;*/
-    /*width: 100%;*/
-}
-/** group select end **/
-
-.dict-list-value {
-    color: #000;
-}
-
-.share-dialog-row {
-    padding-left: 20px;
-}
-
-.note-path {
-    /*background-color: #eee;*/
-    float: left;
-    width: 100%;
-    padding: 5px;
-    border: 1px solid #ccc;
-}
-
-
-.note-timeline-body {
-    width: 100%;
-    float: left;
-    margin-top: 5px;
-}
-
-.comment-source-info {
-    float: left;
-    line-height: 20px;
-    padding: 5px;
-}
-
-.edit-comment-btn, .delete-comment-btn {
-    color: black;
-    background-color: #eee;
-    border: 1px solid #ccc;
-}
-
-.delete-comment-btn {
-    color: red;
-}
-
-/** markdown编辑的侧边菜单样式 **/
-.note-sidebar-contents {
-    float: left;
-    width: 100%;
-    height: 500px;
-    overflow-y: auto;
-}
-
-.note-sidebar-contents>a[data-current] {
-    color: red;
-    font-weight: bold;
-}
-
-.sidebar-contents {
-    max-height: 500px;
-    overflow-y: auto;
-}
-
-.sidebar-contents .list-item {
-    border-bottom: none;
-    padding-top: 5px;
-    padding-bottom: 5px;
-}
-
-.list-item.level-1 {
-    padding-left: 5px;
-}
-
-.list-item.level-2 {
-    padding-left: 25px;
-}
-
-.list-item.level-3 {
-    padding-left: 45px;
-}
-
-.list-item.level-4, .list-item.level-5, .list-item.level-6, .list-item.level-7 {
-    padding-left: 65px;
-}
-
-.sidebar-contents {
-    font-weight: normal;
-}
-
-.note-header-span {
-    line-height: 32px;
-}
-
-.things {
-    padding-left: 20px;
-}
-
-#loadMore {
-    text-align: center;
-    width: 100%;
-    float: left;
-    color: blue;
-}
-
+/**
+ * 笔记的CSS样式
+ * @author xupingmao
+ * @since 2019/11/24
+ * @modified 2022/03/16 18:52:34
+*/
+
+
+/** note-list样式 **/
+.note-list>a:last-child>.book-item {
+    border-bottom: none;
+}
+
+.book-list>a:last-child>.book-item {
+    border-bottom: none;
+}
+
+.card>.book-item:last-child {
+    border-bottom: none;
+}
+
+.tool-div {
+    font-size: medium;
+}
+
+.tool-div a {
+    font-size: medium;
+    color: blue;
+}
+
+.tool-description {
+    font-size: small;
+    padding-top: 3px;
+}
+
+.note {
+    float: left;
+    border: solid 1px;
+    border-color: #ccc;
+    background-color: #fff;
+    margin-bottom: 10px;
+    width: 100%;
+}
+
+.note-body {
+    padding: 5px;
+    word-break: break-all;
+}
+
+.note-head {
+    font-size: 20px;
+}
+
+.note-head-info {
+    padding: 5px;
+    background-color: #eee;
+    color: #555;
+    margin: 0px;
+}
+
+.note-name {
+    /*font-size: 20px;*/
+    line-height: 25px;
+}
+
+.note-name a {
+    font-size: medium;
+    color: blue;
+}
+
+.note-title {
+    width: 100%;
+    float: left;
+}
+
+.note-info {
+    width: 100%;
+    float: left;
+}
+
+.note-info span {
+    display: inline-block;
+    padding-top: 2px;
+}
+
+.note-time {
+    font-size: 12px;
+    color: #aaa;
+}
+
+.note-content-short {
+    font-size: small;
+    word-break: break-all;
+}
+
+.note-last-modify-time,
+.note-last-visit-time {
+    padding-left: 2px;
+    padding-top: 2px;
+    font-size: small;
+    color: green;
+}
+
+.note-related {
+    font-size: 6px;
+    padding-left: 5px;
+    color: red;
+    display: none;
+}
+.note-visited-cnt {
+    float: right;
+    font-size: small;
+}
+
+
+/** 笔记样式 **/
+.note-head {
+    font-size: 20px;
+}
+
+.note-name a {
+    font-size: medium;
+    color: blue;
+}
+
+.note-content-short {
+    font-size: small;
+    word-break: break-all;
+}
+
+.note-detail-head {
+    float: left;
+    width: 100%;
+    padding: 5px;
+    padding-bottom: 5px;
+    border: 1px solid #ccc;
+}
+
+.note-detail-foot {
+    float: left;
+    width: 100%;
+    padding: 5px;
+    border: 1px solid #ccc;
+}
+
+.note-last-visit-time {
+    padding-left: 2px;
+    padding-top: 2px;
+    font-size: small;
+    color: green;
+}
+
+.note-related {
+    font-size: 6px;
+    padding-left: 5px;
+    color: red;
+    display: none;
+}
+.note-visited-cnt {
+    float: right;
+    font-size: small;
+}
+
+/** 评论 **/
+.comment-row {
+    width: 100%;
+    float: left;
+    padding: 5px;
+    border: 1px solid #ccc;
+    border-radius: 2px;
+    margin-top: 5px;
+    margin-bottom: 5px;
+}
+
+.comment-user {
+    float: left;
+    font-weight: bold;
+}
+
+.comment-foot {
+    float: left;
+    width: 100%;
+}
+
+.comment-foot>.comment-foot-link {
+    color: #08c;
+}
+
+.comment-time {
+    float: right;
+    font-size: 12px;
+    color: #555;
+}
+
+.comment-content {
+    float: left;
+    width: 100%;
+    padding: 10px;
+}
+
+.book-item {
+    width: 100%;
+    padding: 10px 5px;
+    margin-top: 0px;
+    margin-bottom: 0px;
+    float: left;
+    line-height: 25px;
+    border-bottom: 1px solid #eee;
+}
+
+.book-item:hover {
+    background-color: #efefef;
+}
+
+.book-size {
+    float: right;
+    color: black;
+}
+
+.book-size-span {
+    color: #888;
+}
+
+.nav-book-size-span {
+    color: #888;
+    float: right;
+}
+
+/** group select **/
+
+.group-select-search {
+    float: left;
+    width: 100%;
+    padding: 5px;
+}
+
+.group-select-header {
+    width: 100%;
+    padding: 5px;
+    margin: 0px;
+    background-color: #eee;
+    /*float: left;*/
+    /*display: block;*/
+}
+
+.group-select-size {
+    float: right;
+    color: #ccc;
+}
+
+.group-select-row {
+    padding-left: 20px;
+    margin: 14px 0px 14px 0px;
+    padding-top: 0px;
+    padding-right: 0px;
+    /*float: left;*/
+    /*width: 100%;*/
+}
+/** group select end **/
+
+.dict-list-value {
+    color: #000;
+}
+
+.share-dialog-row {
+    padding-left: 20px;
+}
+
+.note-path {
+    /*background-color: #eee;*/
+    float: left;
+    width: 100%;
+    padding: 5px;
+    border: 1px solid #ccc;
+}
+
+
+.note-timeline-body {
+    width: 100%;
+    float: left;
+    margin-top: 5px;
+}
+
+.comment-source-info {
+    float: left;
+    line-height: 20px;
+    padding: 5px;
+}
+
+.edit-comment-btn, .delete-comment-btn {
+    color: black;
+    background-color: #eee;
+    border: 1px solid #ccc;
+}
+
+.delete-comment-btn {
+    color: red;
+}
+
+/** markdown编辑的侧边菜单样式 **/
+.note-sidebar-contents {
+    float: left;
+    width: 100%;
+    height: 500px;
+    overflow-y: auto;
+}
+
+.note-sidebar-contents>a[data-current] {
+    color: red;
+    font-weight: bold;
+}
+
+.sidebar-contents {
+    max-height: 500px;
+    overflow-y: auto;
+}
+
+.sidebar-contents .list-item {
+    border-bottom: none;
+    padding-top: 5px;
+    padding-bottom: 5px;
+}
+
+.list-item.level-1 {
+    padding-left: 5px;
+}
+
+.list-item.level-2 {
+    padding-left: 25px;
+}
+
+.list-item.level-3 {
+    padding-left: 45px;
+}
+
+.list-item.level-4, .list-item.level-5, .list-item.level-6, .list-item.level-7 {
+    padding-left: 65px;
+}
+
+.sidebar-contents {
+    font-weight: normal;
+}
+
+.note-header-span {
+    line-height: 32px;
+}
+
+.things {
+    padding-left: 20px;
+}
+
+#loadMore {
+    text-align: center;
+    width: 100%;
+    float: left;
+    color: blue;
+}
+
 /** markdown编辑的侧边菜单样式 END **//**
  * 插件的CSS样式
  * @author xupingmao
  * @since 2019/12/15
  * @modified 2021/08/03 23:47:06
 */
```

### Comparing `xnote-web-0.1.0/static/css/app.css` & `xnote-web-0.1.1/static/css/base/common-layout.css`

 * *Files 21% similar despite different names*

```diff
@@ -1,127 +1,98 @@
 /**
- * 应用相关的CSS样式
+ * 布局相关的样式
  * @author xupingmao
- * @since 2019/06/16
- * @modified 2019/12/15 18:26:57
-*/
-
-/* 上传文件样式 */
-.progress {
-    background-color: #f90;
-    color: #fff;
-    height: 20px;
-    display: none;
-    margin-left: 5px;
-    border-width: 3px;
-}
-.progress span {
-    display: block;
-    background-color: #f90;
-    color: #fff;
-    height: 100%;
-}
-
-.finished-tag {
-    color: #fff;
-    background-color: green;
-    border-width: 3px;
-    border-radius: 3px;
-    margin-left: 5px;
-}
+ * @since 2021/07/25 09:22:04
+ * @modified 2021/07/31 14:09:11
+ * @filename common-layout.css
+ */
 
-#dropArea {
-    float: left;
-    width: 100%;
-    height: 80px;
-    line-height: 80px;
-    border: 3px dashed silver;
-    text-align: center;
-    font-size: 36px;
-    color: #d3d3d3;
-    cursor: pointer;
-}
 
-.file-item {
+.content-left {
     float: left;
-    width: 100%;
+    width: 700px;
 }
 
-.file-item-icon {
-    display: block;
+.content-right {
+    padding-left: 10px;
     float: left;
-    width: 100px;
-    height: 100px;
-    line-height: 100px;
-    text-align: center;
+    width: 300px;
 }
 
-.file-item-info {
-    padding: 10px;
+.foot-placeholder {
     float: left;
-    width: calc(100% - 100px);
+    width: 100%;
+    height: 50px;
 }
 
-.menu-aside {
+.mobile-only {
     display: none;
 }
 
-.option-name {
-    width: 60%;
+.mobile-hidden {
+    display: block;
 }
 
-.option-td {
-    width: 20%;
+.desktop-only {
+    display: block;
 }
 
-#poweredBy {
-    position: absolute; 
-    bottom: 0px; 
-    left: 0px; 
-    right: 0px; 
-    padding: 15px; 
-    padding-left: 40px;
-    padding-right: 0px;
-    border-top: 1px solid #ccc;
+.desktop-only-inline {
+    display: inline;
 }
 
-#poweredBy,
-#poweredBy a {
-    color: white;
+.desktop-only-inline-block {
+    display: inline-block;
 }
 
-#poweredBy a {
-    text-decoration: underline;
+.nav-left {
+    display: block;
+    float: left;
+    top: 0px;
+    width: 180px;
+    height: 100%;
+    position: fixed;
+    padding-top: 50px;
+    padding-bottom: 50px;
+    background-color: #515865;
 }
 
-.item-ext-info {
-    padding-top: 10px;
+.nav-scroll {
+    height: 100%;
+    overflow-y: auto;
 }
 
-.note-group-select {
-    padding: 5px;
+.nav-left li {
+    display: block;
+    color: white;
 }
 
-.suggest-link {
-    padding-right: 10px;
+.nav-left li>a {
+    color: white;
+    line-height: 25px;
 }
 
+/** 移动端样式放在最后 **/
 @media screen and (max-width: 800px) {
     /** mobile **/
-    #dropArea {
-        font-size: 24px;
+    .content-left {
+        width: 100%;
     }
 
-    .recent-note-date {
-        font-size: 12px;
+    .content-right {
+        padding-left: 0px;
+        width: 100%;
+    }
+
+    .mobile-only {
+        display: block;
     }
 
-    .x-left {
+    .mobile-hidden {
         display: none;
     }
 
-    .x-body {
-        position: static;
-        width: 100%;
+    .desktop-only, .desktop-only-inline, .desktop-only-inline-block {
+        display: none;
     }
-}
 
+}
```

### Comparing `xnote-web-0.1.0/static/css/base/common-dropdown.css` & `xnote-web-0.1.1/static/css/base/common-dropdown.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-icon.css` & `xnote-web-0.1.1/static/css/base/common-icon.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-markdown.css` & `xnote-web-0.1.1/static/css/base/common-markdown.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-mobile.css` & `xnote-web-0.1.1/static/css/base/common-mobile.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-page.css` & `xnote-web-0.1.1/static/css/base/common-page.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-photo.css` & `xnote-web-0.1.1/static/css/base/common-photo.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-tab.css` & `xnote-web-0.1.1/static/css/base/common-tab.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/common-tag.css` & `xnote-web-0.1.1/static/css/base/common-tag.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/base/reset.css` & `xnote-web-0.1.1/static/css/base/reset.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/common-card.css` & `xnote-web-0.1.1/static/css/common-card.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/common-left.css` & `xnote-web-0.1.1/static/css/common-left.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/common-react.css` & `xnote-web-0.1.1/static/css/common-react.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/font-awesome.min.css` & `xnote-web-0.1.1/static/css/font-awesome.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/message.css` & `xnote-web-0.1.1/static/css/message.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/plugins.css` & `xnote-web-0.1.1/static/css/plugins.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/timeline.css` & `xnote-web-0.1.1/static/css/timeline.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/css/todo.css` & `xnote-web-0.1.1/static/css/todo.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/favicon.ico` & `xnote-web-0.1.1/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/favicon.png` & `xnote-web-0.1.1/static/favicon.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/fonts/fontawesome-webfont.woff` & `xnote-web-0.1.1/static/fonts/fontawesome-webfont.woff`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/fonts/fontawesome-webfont.woff2` & `xnote-web-0.1.1/static/fonts/fontawesome-webfont.woff2`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/checked.png` & `xnote-web-0.1.1/static/image/checked.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/file.png` & `xnote-web-0.1.1/static/image/file.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/file2.png` & `xnote-web-0.1.1/static/image/file2.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/folder3.png` & `xnote-web-0.1.1/static/image/folder3.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_application.svg` & `xnote-web-0.1.1/static/image/icon_application.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_dict.png` & `xnote-web-0.1.1/static/image/icon_dict.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_dict.svg` & `xnote-web-0.1.1/static/image/icon_dict.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_recent.png` & `xnote-web-0.1.1/static/image/icon_recent.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_recent.svg` & `xnote-web-0.1.1/static/image/icon_recent.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_right.png` & `xnote-web-0.1.1/static/image/icon_right.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_script.png` & `xnote-web-0.1.1/static/image/icon_script.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_script.svg` & `xnote-web-0.1.1/static/image/icon_script.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_search.png` & `xnote-web-0.1.1/static/image/icon_search.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_search.svg` & `xnote-web-0.1.1/static/image/icon_search.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_settings_applications.png` & `xnote-web-0.1.1/static/image/icon_settings_applications.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_settings_applications.svg` & `xnote-web-0.1.1/static/image/icon_settings_applications.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_shell.png` & `xnote-web-0.1.1/static/image/icon_shell.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_shell.svg` & `xnote-web-0.1.1/static/image/icon_shell.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icon_txt.png` & `xnote-web-0.1.1/static/image/icon_txt.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icons/icon_barcode.png` & `xnote-web-0.1.1/static/image/icons/icon_barcode.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icons/icon_game.png` & `xnote-web-0.1.1/static/image/icons/icon_game.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icons/icon_network.png` & `xnote-web-0.1.1/static/image/icons/icon_network.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/image/icons/icon_work.png` & `xnote-web-0.1.1/static/image/icons/icon_work.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/Lexer.js` & `xnote-web-0.1.1/static/js/Lexer.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/app.build.js` & `xnote-web-0.1.1/static/js/app.build.js`

 * *Files 24% similar despite different names*

#### js-beautify {}

```diff
@@ -600,37 +600,50 @@
     // resize事件回调
     xnote.events.resizeHooks = [];
 
     // 表格模块
     xnote.table = {};
     // 编辑器模块
     xnote.editor = {};
+    // 对话框模块
+    xnote.dialog = {};
+
     // 业务状态
     xnote.state = {};
+    // ID计数器
+    xnote.state.currentId = 0;
     // 系统状态
     xnote.state.system = {};
     // 按键弹起的时间
     xnote.state.system.keyupTime = new Date().getTime();
 
     // http相关操作
     xnote.http = {};
 
     // 功能模块
     xnote.note = {};
 
     // 字符串模块
     xnote.string = {};
+
+    // 临时的空间
+    xnote.tmp = {};
 }
 
 xnote.registerApiModule = function(name) {
     if (xnote.api[name] === undefined) {
         xnote.api[name] = {};
     }
 };
 
+xnote.createNewId = function() {
+    xnote.state.currentId++;
+    return xnote.state.currentId;
+}
+
 /**
  * 注册API
  * @param {string} apiName API名称
  * @param {function} fn 函数
  */
 xnote.registerApi = function(apiName, fn) {
     if (xnote.api[apiName] === undefined) {
@@ -2008,14 +2021,27 @@
  */
 
 
 if (window.xnote === undefined) {
     throw new Error("xnote is undefined!");
 }
 
+var xnoteDialogModule = {}
+xnote.dialog = xnoteDialogModule;
+
+xnoteDialogModule.idToIndexMap = {};
+xnoteDialogModule.layerIndexStack = [];
+
+xnoteDialogModule.handleOptions = function(options) {
+    if (options.dialogId === undefined) {
+        options.dialogId = this.createNewId();
+    }
+    return options;
+}
+
 xnote.getDialogArea = function() {
     if (isMobile()) {
         return ['100%', '100%'];
     } else {
         return ['600px', '80%'];
     }
 }
@@ -2041,15 +2067,15 @@
     } else {
         dialogId++;
     }
     xnote.state._dialogId = dialogId;
     return "_xnoteDialog" + dialogId;
 }
 
-xnote.showIframeDialog = function(title, url, buttons, functions) {
+xnoteDialogModule.showIframeDialog = function(title, url, buttons, functions) {
     var area = getDialogArea();
     return layer.open({
         type: 2,
         shadeClose: false,
         title: title,
         maxmin: true,
         area: area,
@@ -2057,61 +2083,65 @@
         scrollbar: false,
         btn: buttons,
         functions: functions
     });
 }
 
 // 关闭对话框的入口方法
-xnote.closeDialog = function(flag) {
+xnoteDialogModule.closeDialog = function(flag) {
     if (flag === "last") {
-        var lastId = xnote._dialogIdStack.pop();
+        var lastId = xnoteDialogModule.layerIndexStack.pop();
         layer.close(lastId);
     }
 
     if (typeof(flag) === 'number') {
         layer.close(flag);
         // TODO 移除_dialogIdStack中的元素
     }
 }
 
-xnote.openDialogEx = function(options) {
-    var dialogId = xnote.openDialogExInner(options);
-    xnote._dialogIdStack.push(dialogId);
-    return dialogId;
+// 打开对话框
+xnoteDialogModule.openDialogEx = function(options) {
+    var layerIndex = xnoteDialogModule.openDialogExInner(options);
+    xnoteDialogModule.layerIndexStack.push(layerIndex);
+    return layerIndex;
 }
 
 xnote.showDialogEx = function() {
-    return xnote.openDialogEx.apply(this, arguments);
+    return xnoteDialogModule.openDialogEx.apply(xnoteDialogModule, arguments);
 }
 
 /**
  * 创建对话框
  * @param {object} options 创建选项
  * @param {string} options.title 标题
  * @param {string} options.html HTML内容
  * @param {list[string]} options.buttons 按钮文案
  * @param {list[function]} options.functions 回调函数(第一个是成功的回调函数)
  * @param {boolean} options.closeForYes 成功后是否关闭对话框(默认关闭)
  * @returns index
  */
-xnote.openDialogExInner = function(options) {
+xnoteDialogModule.openDialogExInner = function(options) {
+    options = xnoteDialogModule.handleOptions(options);
+
     var area = options.area;
     var title = options.title;
     var html = options.html;
     var buttons = options.buttons;
     var functions = options.functions;
     var anim = options.anim;
     var closeBtn = options.closeBtn;
     var onOpenFn = options.onOpenFn;
     var shadeClose = xnote.getOrDefault(options.shadeClose, false);
     var closeForYes = xnote.getOrDefault(options.closeForYes, true);
     var template = options.template;
     var defaultValues = options.defaultValues; // 模板的默认值
     var yesFunction = function(index, layero, dialogInfo) {};
     var successFunction = function(layero, index, that /*原型链的this对象*/ ) {};
+    var dialogId = options.dialogId;
 
     // 详细文档 https://www.layui.com/doc/modules/layer.html
     // @param {int} anim 动画的参数
     // undefined: 默认动画
     // 0：平滑放大。默认
     // 1：从上掉落
     // 2：从最底部往上滑入
@@ -2120,16 +2150,14 @@
     // 5：渐显
     // 6：抖动出现
 
     if (template !== undefined && html !== undefined) {
         throw new Error("不能同时设置template和html选项");
     }
 
-    var dialogId = "";
-
     if (template !== undefined) {
         var templateBody = $(template).html();
         dialogId = xnote.getNewDialogId();
 
         var ele = $("<div>").attr("id", dialogId).html(templateBody);
         html = ele.prop("outerHTML");
 
@@ -2188,14 +2216,17 @@
             }
             return yesResult;
         }
     }
 
     var index = layer.open(params);
 
+    // id映射
+    xnoteDialogModule.idToIndexMap[dialogId] = index;
+
     // 打开对话框的回调
     if (onOpenFn) {
         onOpenFn(index);
     }
     return index
 }
 
@@ -2203,32 +2234,60 @@
  * 打开一个对话框
  * @param {string} title 标题
  * @param {string|DOM} html 文本或者Jquery-DOM对象 比如 $(".mybox")
  * @param {array} buttons 按钮列表
  * @param {array} functions 函数列表
  * @returns 弹层的索引
  */
-xnote.openDialog = function(title, html, buttons, functions) {
+xnoteDialogModule.openDialog = function(title, html, buttons, functions) {
     var options = {};
     options.title = title;
     options.html = html;
     options.buttons = buttons;
     options.functions = functions;
-    return xnote.showDialogEx(options);
+    return xnoteDialogModule.openDialogEx(options);
 }
 
-xnote.showDialog = function() {
-    return xnote.openDialog.apply(this, arguments);
+xnoteDialogModule.showDialog = function() {
+    return xnoteDialogModule.openDialog.apply(xnoteDialogModule, arguments);
 }
 
 // 打开文本对话框
-xnote.openTextDialog = function(title, text, buttons, functions, features) {
+xnoteDialogModule.openTextDialog = function(title, text, buttons, functions, features) {
     var req = {};
+    var dialogId = xnoteDialogModule.createNewId();
+
     req.title = title;
-    req.html = $("<textarea>").addClass("dialog-textarea").text(text).prop("outerHTML");
+    req.dialogId = dialogId;
+    /*
+    <div class="card dialog-body">
+        <textarea class="dialog-textarea"></textarea>
+    </div>
+
+    <div class="dialog-footer">
+        <div class="float-right">
+            <button class="large btn-default" data-dialog-id="{{!dialogId}}" onclick="xnote.dialog.closeByElement(this)">关闭</button>
+        </div>
+    </div>
+     */
+    var div = $("<div>");
+    var textarea = $("<textarea>").addClass("dialog-textarea").text(text);
+    var dialogBody = $("<div>").addClass("card dialog-body").append(textarea);
+    var btnBox = $("<div>").addClass("float-right");
+    var closeBtn = $("<button>").attr("data-dialog-id", dialogId).addClass("large btn-default").attr("onclick", "xnote.dialog.closeByElement(this)").text("关闭");
+    var dialogFooter = $("<div>").addClass("dialog-footer").append(btnBox.append(closeBtn));
+
+    if (buttons === undefined) {
+        div.append(dialogBody);
+        div.append(dialogFooter);
+    } else {
+        div.append(textarea);
+    }
+
+    req.html = div.html();
     req.buttons = buttons;
     req.functions = functions;
     if (features != undefined) {
         xnote._updateDialogFeatures(req, features);
     }
     return xnote.showDialogEx(req);
 }
@@ -2238,56 +2297,51 @@
         var item = features[i];
         if (item === "large") {
             options.area = "large";
         }
     }
 }
 
-// 别名
-xnote.showTextDialog = xnote.openTextDialog;
-
 /**
  * 打开ajax对话框
  * @param {object} options 打开选项
  */
-xnote.openAjaxDialogEx = function(options) {
+xnoteDialogModule.openAjaxDialogEx = function(options) {
     var respFilter = xnote.getOrDefault(options.respFilter, function(resp) {
         return resp;
     });
 
-    $.get(options.url, function(resp) {
+    xnote.http.get(options.url, function(resp) {
         options.html = respFilter(resp);
         xnote.showDialogEx(options);
         // 刷新各种组件的默认值
         xnote.refresh();
-    }).fail(function(error) {
-        xnote.alert("调用接口失败，请重试");
     });
 }
 
 /**
  * 打开ajax对话框
  * @param {string} title 对话框标题
  * @param {string} url 对话框URL
  * @param {list<string>} buttons 按钮名称
  * @param {list<function>} functions 按钮对应的函数
  */
-xnote.openAjaxDialog = function(title, url, buttons, functions) {
+xnoteDialogModule.openAjaxDialog = function(title, url, buttons, functions) {
     var options = {};
     options.title = title;
     options.buttons = buttons;
     options.functions = functions;
     options.url = url;
 
-    return xnote.openAjaxDialogEx(options);
+    return xnoteDialogModule.openAjaxDialogEx(options);
 }
 
 // 函数别名
-xnote.showAjaxDialog = function() {
-    return xnote.openAjaxDialog.apply(this, arguments);
+xnoteDialogModule.showAjaxDialog = function() {
+    return xnoteDialogModule.openAjaxDialog.apply(xnoteDialogModule, arguments);
 }
 
 // 询问函数，原生prompt的替代方案
 xnote.prompt = function(title, defaultValue, callback) {
     if (layer && layer.prompt) {
         // 使用layer弹层
         layer.prompt({
@@ -2401,15 +2455,15 @@
 
 // 兼容之前的方法
 window.showToast = window.xnote.toast;
 
 /**
  * 展示选项对话框
  */
-xnote.showOptionDialog = function(option) {
+xnoteDialogModule.showOptionDialog = function(option) {
     var content = option.html;
     if (option.title === undefined) {
         option.title = false;
     }
 
     var oldStyle = $("body").css("overflow");
     $("body").css("overflow", "hidden");
@@ -2557,14 +2611,47 @@
         $(".x-dialog-background").show();
         $(".x-dialog-remote").show();
         $("#" + id).show();
     }
 
     xnote.initDialog = initDialog;
 });
+
+// 通过html元素来关闭对话框
+xnoteDialogModule.closeByElement = function(target) {
+    var dialogId = $(target).attr("data-dialog-id");
+    var index = xnoteDialogModule.idToIndexMap[dialogId];
+    layer.close(index);
+}
+
+xnoteDialogModule.closeLast = function() {
+    xnoteDialogModule.closeDialog("last");
+}
+
+xnoteDialogModule.createNewId = function() {
+    return "dialog_" + xnote.createNewId();
+}
+
+// 别名
+xnote.openAjaxDialog = xnoteDialogModule.openAjaxDialog;
+xnote.openAjaxDialogEx = xnoteDialogModule.openAjaxDialogEx;
+xnote.showAjaxDialog = xnoteDialogModule.showAjaxDialog;
+
+xnote.showDialog = xnoteDialogModule.showDialog;
+xnote.showDialogEx = xnoteDialogModule.openDialogEx;
+xnote.openDialogEx = xnoteDialogModule.openDialogEx;
+xnote.openDialogExInner = xnoteDialogModule.openDialogExInner;
+xnote.openDialog = xnoteDialogModule.openDialog;
+xnote.closeDialog = xnoteDialogModule.closeDialog;
+
+xnote.showIframeDialog = xnoteDialogModule.showIframeDialog;
+
+xnote.showTextDialog = xnoteDialogModule.openTextDialog;
+xnote.openTextDialog = xnoteDialogModule.openTextDialog;
+xnote.showOptionDialog = xnoteDialogModule.showOptionDialog;
 /** x-tab.js
  * tab页功能，依赖jQuery
  * 有两个样式: tab-link 和 tab-btn
  */
 
 $(function(e) {
 
@@ -3716,15 +3803,14 @@
  */
 var FileView = {};
 var FileAPI = {};
 
 xnote.action.fs = FileView;
 xnote.api.fs = FileAPI;
 
-
 // 调用重命名的API
 FileAPI.rename = function(dirname, oldName, newName, callback) {
     if (newName != oldName && newName) {
         xnote.http.post("/fs_api/rename", {
                 dirname: dirname,
                 old_name: oldName,
                 new_name: newName
@@ -3774,23 +3860,68 @@
         FileAPI.rename(dirname, realname, newName, function(resp) {
             window.location.reload();
         });
     });
 };
 
 // 打开选项对话框
-FileView.openOptionDialog = function(target) {
-    console.log(window.event);
-    window.event.preventDefault();
-    window.event.stopPropagation();
+FileView.openOptionDialog = function(target, event) {
+    // console.log(event);
+    event.preventDefault();
+    event.stopPropagation();
     console.log(target);
     var filePath = $(target).attr("data-path");
     var fileName = $(target).attr("data-name");
     var fileRealName = $(target).attr("data-realname");
+    var dialogId = xnote.dialog.createNewId();
+
     var html = $("#fileItemOptionDialog").render({
         "filePath": filePath,
         "fileName": fileName,
-        "fileRealName": fileRealName
+        "fileRealName": fileRealName,
+        "dialogId": dialogId,
     });
 
-    xnote.openDialog("选项", html);
-};
+    var options = {};
+    options.title = "选项";
+    options.html = html;
+    options.dialogId = dialogId;
+
+    xnote.openDialogEx(options);
+};
+
+// 查看文件详情
+FileView.showDetail = function(target) {
+    var dataPath = $(target).attr("data-path");
+    var params = {
+        fpath: dataPath
+    };
+    xnote.http.get("/fs_api/detail", params, function(resp) {
+        var message = ""
+        if (resp.success) {
+            message = resp.data;
+        } else {
+            message = resp.message;
+        }
+        xnote.showTextDialog("文件详情", message);
+    })
+};
+
+// 移除收藏夹
+FileView.removeBookmark = function(event) {
+    event.preventDefault();
+    var path = $(event.target).attr("data-path")
+    var params = {
+        action: "remove",
+        path: path,
+    }
+
+    xnote.confirm("确定要取消收藏文件<code color=red>" + path + "</code>?", function() {
+        xnote.http.post("/fs_api/bookmark", params, function(resp) {
+            if (resp.code == "success") {
+                window.location.reload()
+            } else {
+                xnote.alert("取消收藏失败，请稍后重试!")
+            }
+        })
+    })
+}
```

### Comparing `xnote-web-0.1.0/static/js/app.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-init.js`

 * *Files 25% similar despite different names*

#### js-beautify {}

```diff
@@ -1,331 +1,330 @@
 /**
- * 通用的操作函数
+ * xnote全局初始化
+ * @author xupingmao
+ * @since 2022/01/09 16:17:02
+ * @modified 2022/04/09 18:15:07
+ * @filename x-init.js
  */
-$(function() {
 
-    window.moveTo = function(selfId, parentId) {
-        $.post("/note/move", {
-                id: selfId,
-                parent_id: parentId
-            },
-            function(resp) {
-                console.log(resp);
-                window.location.reload();
-            });
-    }
-
-    function showSideBar() {
-        $(".navMenubox").animate({
-            "margin-left": "0px"
-        });
-        $("#poweredBy").show();
-    }
-
-    function hideSideBar() {
-        $(".navMenubox").animate({
-            "margin-left": "-200px"
-        });
-        $("#poweredBy").hide();
-    }
-
-    function checkResize() {
-        if ($(".navMenubox").is(":animated")) {
-            return;
-        }
-        if (window.innerWidth < 600) {
-            // 移动端，兼容下不支持@media的浏览器 
-            hideSideBar();
-        } else {
-            showSideBar();
-        }
-    }
-
-    function toggleMenu() {
-        var marginLeft = $(".navMenubox").css("margin-left");
-        if (marginLeft == "0px") {
-            hideSideBar();
-        } else {
-            showSideBar();
-        }
+/** 初始化xnote全局对象 **/
+if (window.xnote === undefined) {
+    // 全局对象
+    var xnote = {};
+
+    // 设备信息
+    xnote.device = {
+        contentWidth: 0, // 内容的宽度，包括左侧主数据和侧边栏
+        contentLeftWidth: 0, // 左侧的宽度
+        isMobile: false, // 是否是移动端
+        isDesktop: true, // 默认是桌面端
+        leftNavWidth: 0, // 左侧导航宽度
+        end: 0
+    };
+
+    // 配置信息
+    xnote.config = {};
+    xnote.config.serverHome = "";
+
+    // 内部属性
+    xnote._dialogIdStack = [];
+
+    // 常量
+    xnote.MOBILE_MAX_WIDTH = 1000;
+    xnote.constants = {
+        MOBILE_MAX_WIDTH: 100
+    };
+
+    // 后端接口API模块
+    xnote.api = {};
+    // 操作动作接口
+    xnote.action = {};
+
+    // 事件相关接口
+    xnote.events = {};
+    // resize事件回调
+    xnote.events.resizeHooks = [];
+
+    // 表格模块
+    xnote.table = {};
+    // 编辑器模块
+    xnote.editor = {};
+    // 对话框模块
+    xnote.dialog = {};
+
+    // 业务状态
+    xnote.state = {};
+    // ID计数器
+    xnote.state.currentId = 0;
+    // 系统状态
+    xnote.state.system = {};
+    // 按键弹起的时间
+    xnote.state.system.keyupTime = new Date().getTime();
+
+    // http相关操作
+    xnote.http = {};
+
+    // 功能模块
+    xnote.note = {};
+
+    // 字符串模块
+    xnote.string = {};
+
+    // 临时的空间
+    xnote.tmp = {};
+}
+
+xnote.registerApiModule = function(name) {
+    if (xnote.api[name] === undefined) {
+        xnote.api[name] = {};
     }
+};
 
-    $(".toggleMenu").on("click", function() {
-        toggleMenu();
-    });
-});
+xnote.createNewId = function() {
+    xnote.state.currentId++;
+    return xnote.state.currentId;
+}
 
 /**
- * 处理悬浮控件
+ * 注册API
+ * @param {string} apiName API名称
+ * @param {function} fn 函数
  */
-$(function() {
-    var width = 960;
-    var maxWidth = $(window).width();
-    var maxHeight = $(window).height();
-    var leftPartWidth = 200;
-
-    var btnRight = (maxWidth - width) / 2 + 20;
-    if (btnRight < 0) {
-        btnRight = 20;
+xnote.registerApi = function(apiName, fn) {
+    if (xnote.api[apiName] === undefined) {
+        xnote.api[apiName] = fn;
+    } else {
+        var errMessage = "api is registered: " + apiName;
+        console.error(errMessage);
+        xnote.alert(errMessage);
     }
-    var botHeight = "100%";
-    var botWidth = maxWidth / 2;
+}
 
-    var bots = {};
+xnote.isEmpty = function(value) {
+    return value === undefined || value === null || value === "";
+};
 
-    function createIframe(src) {
-        return $("<iframe>")
-            .addClass("dialog-iframe")
-            .attr("src", src)
-            .attr("id", "botIframe");
-    }
+xnote.isNotEmpty = function(value) {
+    return !xnote.isEmpty(value);
+};
 
-    function createCloseBtn() {
-        return $("<span>").text("Close").addClass("dialog-close-btn");
+xnote.getOrDefault = function(value, defaultValue) {
+    if (value === undefined) {
+        return defaultValue;
     }
+    return value;
+};
 
-    function createTitle() {
-        var btn1 = $("<span>").text("Home").addClass("dialog-title-btn dialog-home-btn");
-        var btn2 = $("<span>").text("Tools").addClass("dialog-title-btn dialog-tools-btn");
-        var btn3 = $("<span>").text("Refresh").addClass("dialog-title-btn dialog-refresh-btn");
-
-        return $("<div>").addClass("dialog-title")
-            .append(createCloseBtn())
-            .append(btn1).append(btn2).append(btn3);
-    }
+xnote.execute = function(fn) {
+    fn();
+};
 
-    function getBottomBot() {
-        if (bots.bottom) {
-            return bots.bottom;
-        }
-        var bot = $("<div>").css({
-            "position": "fixed",
-            "width": "100%",
-            "height": "80%",
-            "background-color": "#fff",
-            "border": "1px solid #ccc",
-            "bottom": "0px",
-            "right": "0px",
-            "z-index": 50
-        }).append(createIframe("/"));
-        bot.hide();
-        bot.attr("id", "x-bot");
-        $(document.body).append(bot);
-        bots.bottom = bot;
-        return bot;
-    }
 
-    function getIframeDialog() {
-        if (bots.dialog) {
-            return bots.dialog;
+xnote.validate = {
+    "notUndefined": function(obj, errMsg) {
+        if (obj === undefined) {
+            xnote.alert(errMsg);
+            throw new Error(errMsg);
+        }
+    },
+    "isFunction": function(obj, errMsg) {
+        if (typeof obj !== 'function') {
+            xnote.alert(errMsg);
+            throw new Error(errMsg);
         }
-        var mainWidth = $(".root").width();
-        var bot = $("<div>").css({
-            "position": "fixed",
-            "width": mainWidth,
-            "height": "80%",
-            "background-color": "#fff",
-            "border": "1px solid #ccc",
-            "bottom": "0px",
-            "right": "0px",
-            "z-index": 50
-        }).append(createIframe("/"));
-        bot.hide();
-        $(document.body).append(bot);
-        bots.dialog = bot;
-        return bot;
     }
+};
 
-    function initEventHandlers() {
-        // close button event
-        console.log("init");
-        $("body").on("click", ".dialog-close-btn", function() {
-            getRightBot().fadeOut(200);
-        });
-        $("body").on("click", ".dialog-home-btn", function() {
-            $(".right-bot iframe").attr("src", "/");
-        });
-        $("body").on("click", ".dialog-tools-btn", function() {
-            $(".right-bot iframe").attr("src", "/fs_api/plugins");
-        });
-        $("body").on("click", ".dialog-refresh-btn", function() {
-            $(".right-bot iframe")[0].contentWindow.location.reload();
-        });
-        $("body").on("click", ".layer-btn", function(event) {
-            console.log("click");
-            var target = event.target;
-            var url = $(target).attr("data-url");
-            openDialog(url);
-        });
-        console.log("init done");
-    }
 
-    function getRightBot() {
-        if (bots.right) {
-            return bots.right;
-        }
-        var width = "50%";
-        if (maxWidth < 600) {
-            width = "100%";
-        }
-        var rightBot = $("<div>").css({
-                "position": "fixed",
-                "width": width,
-                "right": "0px",
-                "bottom": "0px",
-                "top": "0px",
-                "background-color": "#fff",
-                "border": "solid 1px #ccc",
-                "z-index": 50,
-            }).append(createTitle())
-            .append(createIframe("/system/index"))
-            .addClass("right-bot");
-        rightBot.hide();
-        $(document.body).append(rightBot);
-        bots.right = rightBot;
-        return rightBot;
-    }
 
-    function initSearchBoxWidth() {
-        if (window.SHOW_ASIDE == "False") {
-            $(".nav-left-search").css("width", "100%");
+// 调整表格宽度
+xnote.table.adjustWidth = function(selector) {
+    $(selector).each(function(element, index) {
+        var headings = $(this).find("th");
+        if (headings.length > 0) {
+            var width = 100 / headings.length;
+            headings.css("width", width + "%");
         }
-    }
-
-    function init() {
-        // var botBtn = $("<div>").text("工具").css("right", btnRight).addClass("bot-btn");
-        // $(document.body).append(botBtn);
-        $(".bot-btn").click(function() {
-            getRightBot().fadeToggle(200);
-        });
-        initSearchBoxWidth();
-        initEventHandlers();
-    }
-
-    function showIframeDialog(src) {
-        getRightBot().fadeIn(200);
-        $("#botIframe").attr("src", src);
-    }
+    });
+};
 
-    function hideIframeDialog() {
-        getRightBot().fadeOut(200);
+/**
+ * 追加CSS样式表
+ * @param {string} styleText 样式文本
+ */
+xnote.appendCSS = function(styleText) {
+    // 居中的样式
+    var style = document.createElement("style");
+    style.type = "text/css";
+
+    if (style.styleSheet) {
+        // 兼容IE
+        style.styleSheet.cssText = styleText;
+    } else {
+        style.innerHTML = styleText;
     }
 
-    window.openDialog = function(url) {
-        var width = $(".root").width() - 40;
-        var area;
+    document.head.appendChild(style);
+};
 
-        if (isMobile()) {
-            area = ['100%', '100%'];
-        } else {
-            area = [width + 'px', '80%'];
-        }
+xnote.http.defaultFailHandler = function(err) {
+    console.log(err);
+    xnote.toast("服务器繁忙, 请稍后重试~");
+};
 
-        layer.open({
-            type: 2,
-            shadeClose: true,
-            title: '子页面',
-            maxmin: true,
-            area: area,
-            content: url,
-            scrollbar: false
+// http-post请求
+xnote.http.post = function(url, data, callback, type) {
+    return $.post(xnote.config.serverHome + url, data, callback, type).fail(xnote.http.defaultFailHandler);
+}
+
+// http-get请求
+xnote.http.get = function(url, data, callback, type) {
+    return $.get(xnote.config.serverHome + url, data, callback, type).fail(xnote.http.defaultFailHandler);
+}
+
+xnote.isTyping = function() {
+    var now = new Date().getTime();
+    var typingGap = 200; // 200毫秒
+    return now - xnote.state.system.keyupTime < typingGap;
+}
+
+var XUI = function(window) {
+    // 处理select标签选中情况
+    function initSelect() {
+        $("select").each(function(index, ele) {
+            var self = $(ele);
+            var children = self.children();
+            // 使用$.val() 会取到第一个select标签值
+            var value = self.attr("value");
+            for (var i = 0; i < children.length; i++) {
+                var child = children[i];
+                if (value == child.value) {
+                    child.selected = "selected";
+                }
+            }
         });
     }
 
-    window.showIframeDialog = showIframeDialog;
-    window.hideIframeDialog = hideIframeDialog;
-
-    window.toggleMenu = function() {
-        $(".aside-background").toggle();
-        $(".aside").toggle(500);
-    }
-
-    /**
-     * 调整高度，通过
-     * @param {string} selector 选择器
-     * @param {number} bottom 距离窗口底部的距离
-     */
-    window.adjustHeight = function(selector, bottom, options) {
-        bottom = bottom || 0;
-        var height = getWindowHeight() - $(selector).offset().top - bottom;
-        $(selector).css("height", height).css("overflow", "auto");
-
-        if (options != undefined) {
-            if (options.overflow) {
-                $(selector).css("overflow", options.overflow);
+    function initCheckbox() {
+        $("input[type=checkbox]").each(function(index, ele) {
+            var self = $(ele);
+            var value = self.attr("default-value");
+            if (value == "on") {
+                self.attr("checked", "checked");
             }
-        }
-
-        return height;
-    }
-
-    /**
-     * 调整导航栏，如果在iframe中，则不显示菜单
-     */
-    window.adjustNav = function() {
-        if (self != top) {
-            $(".nav").hide();
-            $(".root").css("padding", "10px");
-        }
+        })
     }
 
-    window.adjustTable = function() {
-        $("table").each(function(index, element) {
-            var count = $(element).find("th").length;
-            if (count > 0) {
-                $(element).find("th").css("width", 100 / count + '%');
+    function initRadio() {
+        $("input[type=radio]").each(function(index, ele) {
+            var self = $(ele);
+            var value = self.attr("default-value");
+            if (value == self.val()) {
+                self.attr("checked", "checked");
             }
         });
     }
 
-    $(".aside-background").on('click', function() {
-        toggleMenu();
-    });
-
+    function initXRadio() {
+        $(".x-radio").each(function(index, element) {
+            var self = $(element);
+            var option = self.attr("data-option");
+            var value = self.attr("data-value");
+            if (value == option) {
+                self.addClass("selected-link");
+            }
+        });
+    };
 
-    if (window.PAGE_OPEN == "dialog") {
-        // 使用对话框浏览笔记
-        $(".dialog-link").click(function(e) {
-            e.preventDefault();
-            var url = $(this).attr("href");
-            var width = $(".root").width();
-            layer.open({
-                type: 2,
-                title: "查看",
-                shadeClose: true,
-                shade: 0.8,
-                area: [width + "px", "90%"],
-                scrollbar: false,
-                content: url
+    // 点击跳转链接的按钮
+    $(".link-btn").click(function() {
+        var link = $(this).attr("x-href");
+        if (!link) {
+            link = $(this).attr("href");
+        }
+        var confirmMessage = $(this).attr("confirm-message");
+        if (confirmMessage) {
+            xnote.confirm(confirmMessage, function(result) {
+                window.location.href = link;
             });
-        });
-    }
+        } else {
+            window.location.href = link;
+        }
+    });
 
-    function processInIframe() {
+    // 点击prompt按钮
+    // <input type="button" class="prompt-btn" action="/rename?name=" message="重命名为" value="重命名">
+    $(".prompt-btn").click(function() {
+        var action = $(this).attr("action");
+        var message = $(this).attr("message");
+        var defaultValue = $(this).attr("default-value");
+        var inputValue = prompt(message, defaultValue);
+        if (inputValue != "" && inputValue) {
+            var actionUrl = action + encodeURIComponent(inputValue);
+            $.get(actionUrl, function(resp) {
+                window.location.reload();
+            })
+        }
+    });
 
-    }
+    // 初始化表单控件的默认值
+    function initDefaultValue(event) {
+        initSelect();
+        initCheckbox();
+        initRadio();
+        initXRadio();
+        xnote.table.adjustWidth(".default-table");
+    };
+
+    window.xnote.assert = function(expression, message) {
+        if (!expression) {
+            xnote.alert(message);
+        }
+    };
+
+    // 刷新各种默认值
+    xnote.refresh = function() {
+        // 初始化
+        initDefaultValue();
+        // 注册事件
+        xnote.addEventListener("init-default-value", initDefaultValue);
+        xnote.addEventListener("xnote.reload", initDefaultValue);
+    };
 
-    if (self != top) {
-        processInIframe();
-    }
+    xnote.refresh();
+};
 
-    init();
+$(document).ready(function() {
+    XUI(window);
+    $("body").on("keyup", function(event) {
+        xnote.state.system.keyupTime = new Date().getTime();
+    });
 });
 
+/**
+ * 指定索引对文本进行替换
+ * @param {string} text 原始文本
+ * @param {string} target 被替换的文本
+ * @param {string} replacement 新的文本
+ * @param {int} index 索引位置
+ * @returns 
+ */
+xnote.string.replaceByIndex = function(text, target, replacement, index) {
+    var tokens = text.split(target);
+    var result = [];
+    for (var i = 0; i < tokens.length; i++) {
+        var token = tokens[i];
+        result.push(token);
 
-xnote.events.fireUploadEvent = function(event) {
-    xnote.fire("fs.upload", event);
-};
-
-xnote.events.onUploadEvent = function(listener) {
-    xnote.on("fs.upload", listener);
-};
-
+        if (i + 1 == tokens.length) {
+            continue;
+        }
 
-xnote.events.fireUploadPrepareEvent = function(event) {
-    console.log("fireUploadPrepareEvent", event);
-    xnote.fire("fs.upload.prepare", event);
-};
+        if (i == index) {
+            result.push(replacement);
+        } else {
+            result.push(target);
+        }
+    }
 
-xnote.events.onUploadPrepareEvent = function(listener) {
-    xnote.on("fs.upload.prepare", listener);
+    return result.join("");
 };
```

### Comparing `xnote-web-0.1.0/static/js/base/ajax.js` & `xnote-web-0.1.1/static/js/base/ajax.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/array.js` & `xnote-web-0.1.1/static/js/base/array.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/datetime.js` & `xnote-web-0.1.1/static/js/base/datetime.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/jq-ext.js` & `xnote-web-0.1.1/static/js/base/jq-ext.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/misc.js` & `xnote-web-0.1.1/static/js/base/misc.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/string.js` & `xnote-web-0.1.1/static/js/base/string.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/base/url.js` & `xnote-web-0.1.1/static/js/base/url.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/codemirror-addon/xnote-search.js` & `xnote-web-0.1.1/static/js/codemirror-addon/xnote-search.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/colors.js` & `xnote-web-0.1.1/static/js/colors.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/components/date-picker.js` & `xnote-web-0.1.1/static/js/components/date-picker.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/console.js` & `xnote-web-0.1.1/static/js/console.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/editor.js` & `xnote-web-0.1.1/static/lib/jquery-url-parser/purl.js`

 * *Files 19% similar despite different names*

#### js-beautify {}

```diff
@@ -1,365 +1,274 @@
-// @author xupingmao
-// @since 2018/02/13
-// @modified 2019/02/09 18:30:34
-
-
-// var codeMirror = CodeMirror.fromTextArea(editor, {
-//     lineNumbers: true,
-//     mode: { name: "text/x-markdown", fencedCodeBlocks: true },
-//     lineWrapping: true,
-//     fixedGutter: true,
-// });
-
-// fixedGutter
-// 设置gutter跟随编辑器内容水平滚动（false）还是固定在左侧（true或默认）
-
-// 编辑器组件
-var EditorView = {};
-
-/**
- * 初始化codeMirror编辑器
- * @param {string} selector 选择器
- * @param {object} options 可选项
+/*
+ * Purl (A JavaScript URL parser) v2.3.1
+ * Developed and maintanined by Mark Perkins, mark@allmarkedup.com
+ * Source repository: https://github.com/allmarkedup/jQuery-URL-Parser
+ * Licensed under an MIT-style license. See https://github.com/allmarkedup/jQuery-URL-Parser/blob/master/LICENSE for details.
  */
-function initCodeMirror(selector, options) {
-    var mode = "text/x-sh";
-    var name = options.filename || "";
-    var height = options.height || "450px";
-    var executable = false;
 
-    if (name.endsWith(".py")) {
-        mode = "text/x-python";
-        // executable = true;
-    }
-    if (name.endsWith(".js")) {
-        mode = "text/javascript";
-    }
-    if (name.endsWith(".c")) {
-        mode = "text/x-c";
-    }
-    if (name.endsWith(".java")) {
-        mode = "text/x-java";
-    }
-    if (name.endsWith(".md")) {
-        mode = "text/x-markdown";
-    }
-    if (name.endsWith(".sh") || name.endsWith(".command")) {
-        mode = "text/x-sh";
-    }
-    if (name.endsWith(".php")) {
-        mode = "text/x-php";
-    }
-    if (name.endsWith(".css")) {
-        mode = "text/css";
-    }
-
-    if (options.mode) {
-        mode = options.mode;
+;
+(function(factory) {
+    if (typeof define === 'function' && define.amd) {
+        define(factory);
+    } else {
+        window.purl = factory();
     }
+})(function() {
 
-    var keyMap = "default";
+    var tag2attr = {
+            a: 'href',
+            img: 'src',
+            form: 'action',
+            base: 'href',
+            script: 'src',
+            iframe: 'src',
+            link: 'href'
+        },
 
-    if (CodeMirror.keyMap.sublime) {
-        keyMap = "sublime";
-    }
+        key = ['source', 'protocol', 'authority', 'userInfo', 'user', 'password', 'host', 'port', 'relative', 'path', 'directory', 'file', 'query', 'fragment'], // keys available to query
 
-    // 补全配置, TODO补上hintWords
-    if (CodeMirror.hint) {
-        CodeMirror.defineOption("hintOptions", {
-            "hint": CodeMirror.hint.anyword
-        });
-    }
+        aliases = {
+            'anchor': 'fragment'
+        }, // aliases for backwards compatability
+
+        parser = {
+            strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/, //less intuitive, more accurate to the specs
+            loose: /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/ // more intuitive, fails on relative paths and deviates from specs
+        },
 
+        isint = /^[0-9]+$/;
 
-    var editor = CodeMirror.fromTextArea($(selector)[0], {
-        lineNumbers: true,
-        mode: mode,
-        indentUnit: 4,
-        lineWrapping: true,
-        keyMap: keyMap
-        // extraKeys is defined below.
-    });
-    editor.setSize("auto", height);
-    editor.on("update", function(codeMirror, changeObj) {
-        $(selector).val(codeMirror.doc.getValue());
-    });
-    // tab键处理
-    editor.setOption("extraKeys", {
-        Tab: function(cm) {
-            if (cm.somethingSelected()) {
-                cm.indentSelection('add');
+    function parseUri(url, strictMode) {
+        var str = decodeURI(url),
+            res = parser[strictMode || false ? 'strict' : 'loose'].exec(str),
+            uri = {
+                attr: {},
+                param: {},
+                seg: {}
+            },
+            i = 14;
+
+        while (i--) {
+            uri.attr[key[i]] = res[i] || '';
+        }
+
+        // build query and fragment parameters
+        uri.param['query'] = parseString(uri.attr['query']);
+        uri.param['fragment'] = parseString(uri.attr['fragment']);
+
+        // split path and fragement into segments
+        uri.seg['path'] = uri.attr.path.replace(/^\/+|\/+$/g, '').split('/');
+        uri.seg['fragment'] = uri.attr.fragment.replace(/^\/+|\/+$/g, '').split('/');
+
+        // compile a 'base' domain attribute
+        uri.attr['base'] = uri.attr.host ? (uri.attr.protocol ? uri.attr.protocol + '://' + uri.attr.host : uri.attr.host) + (uri.attr.port ? ':' + uri.attr.port : '') : '';
+
+        return uri;
+    }
+
+    function getAttrName(elm) {
+        var tn = elm.tagName;
+        if (typeof tn !== 'undefined') return tag2attr[tn.toLowerCase()];
+        return tn;
+    }
+
+    function promote(parent, key) {
+        if (parent[key].length === 0) return parent[key] = {};
+        var t = {};
+        for (var i in parent[key]) t[i] = parent[key][i];
+        parent[key] = t;
+        return t;
+    }
+
+    function parse(parts, parent, key, val) {
+        var part = parts.shift();
+        if (!part) {
+            if (isArray(parent[key])) {
+                parent[key].push(val);
+            } else if ('object' == typeof parent[key]) {
+                parent[key] = val;
+            } else if ('undefined' == typeof parent[key]) {
+                parent[key] = val;
             } else {
-                var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
-                cm.replaceSelection(spaces);
+                parent[key] = [parent[key], val];
             }
-        },
-        Ctrl: "autocomplete"
-    });
-
-    editor.on("keyup", function(cm, e) {
-        // console.log(e);
-        var keyCode = e.keyCode;
-
-        if ((keyCode >= 97 && keyCode <= 122) ||
-            (keyCode >= 65 && keyCode <= 90) ||
-            keyCode == 95 ||
-            keyCode == 36) {
-            // 字母及其他合法变量字符_$
-            if (editor.showHint) {
-                editor.showHint();
+        } else {
+            var obj = parent[key] = parent[key] || [];
+            if (']' == part) {
+                if (isArray(obj)) {
+                    if ('' !== val) obj.push(val);
+                } else if ('object' == typeof obj) {
+                    obj[keys(obj).length] = val;
+                } else {
+                    obj = parent[key] = [parent[key], val];
+                }
+            } else if (~part.indexOf(']')) {
+                part = part.substr(0, part.length - 1);
+                if (!isint.test(part) && isArray(obj)) obj = promote(parent, key);
+                parse(parts, obj, part, val);
+                // key
+            } else {
+                if (!isint.test(part) && isArray(obj)) obj = promote(parent, key);
+                parse(parts, obj, part, val);
             }
-            // 更新上次更新时间
-            xnote.editor.lastKeyUpTime = new Date().getTime();
-        }
-    });
-
-    if (mode == "text/x-python") {
-        $("#execute").show();
-        $("#execute").click(function(event) {
-            var content = editor.doc.getValue();
-            xnote.http.post("/system/command/python", {
-                    content: content
-                },
-                function(responseText) {
-                    var data = responseText;
-                    $("#resultDiv").show();
-                    $("#result").show().text(data.data);
-                });
-        })
-    }
-    return editor;
-}
-
-
-(function() {
-    var colSpacingWidth = 2; // 列间隔的宽度
-
-    // var paddingCache = '';
-    // for (var i = 0; i < 1000; i++) {
-    //     paddingCache += ' ';
-    // }
-
-    var _isMacOS = navigator.userAgent.indexOf("Mac OS") >= 0;
-
-    function isMacOS() {
-        return _isMacOS;
-    }
-    if (isMacOS()) {
-        console.log("Mac OS");
-    }
-
-    String.prototype.padLeft = function(size, value) {
-        var text = this;
-        while (getStringWidth(text) < size) {
-            text += value;
         }
-        return text;
     }
 
-    // 处理CJK的宽度, CJK认为是2个字符宽度
-    function getCharWidth(c) {
-        if (!c) {
-            return 0;
-        }
-        var code = c.charCodeAt(0);
-        if (code > 127) {
-            if (isMacOS()) {
-                // Mac是个奇葩, 3个汉字5个宽度
-                return 1.66;
+    function merge(parent, key, val) {
+        if (~key.indexOf(']')) {
+            var parts = key.split('[');
+            parse(parts, parent, 'base', val);
+        } else {
+            if (!isint.test(key) && isArray(parent.base)) {
+                var t = {};
+                for (var k in parent.base) t[k] = parent.base[k];
+                parent.base = t;
+            }
+            if (key !== '') {
+                set(parent.base, key, val);
             }
-            return 2;
         }
-        return 1;
+        return parent;
     }
 
-    // 判断是否是隔离行
-    function isSeperateLine(line) {
-        if (line.length == 0) {
-            return false;
-        }
-        for (var i = 0; i < line.length; i++) {
-            var char = line[i];
-            if (char != "-") {
-                return false;
+    function parseString(str) {
+        return reduce(String(str).split(/&|;/), function(ret, pair) {
+            try {
+                pair = decodeURIComponent(pair.replace(/\+/g, ' '));
+            } catch (e) {
+                // ignore
+            }
+            var eql = pair.indexOf('='),
+                brace = lastBraceInKey(pair),
+                key = pair.substr(0, brace || eql),
+                val = pair.substr(brace || eql, pair.length);
+
+            val = val.substr(val.indexOf('=') + 1, val.length);
+
+            if (key === '') {
+                key = pair;
+                val = '';
             }
-        }
-        return true;
-    }
 
-    function makeSeperateLine(length) {
-        return "-".repeat(length);
+            return merge(ret, key, val);
+        }, {
+            base: {}
+        }).base;
     }
 
-    function getStringWidth(str) {
-        if (!str) {
-            return 0;
-        }
-        var width = 0;
-        for (var i = 0; i < str.length; i++) {
-            width += getCharWidth(str[i]);
+    function set(obj, key, val) {
+        var v = obj[key];
+        if (typeof v === 'undefined') {
+            obj[key] = val;
+        } else if (isArray(v)) {
+            v.push(val);
+        } else {
+            obj[key] = [v, val];
         }
-        return Math.round(width);
     }
 
-    function getStringWidthIgnoreLine(text) {
-        if (isSeperateLine(text)) {
-            return 3;
-        } else {
-            return getStringWidth(text);
+    function lastBraceInKey(str) {
+        var len = str.length,
+            brace,
+            c;
+        for (var i = 0; i < len; ++i) {
+            c = str[i];
+            if (']' == c) brace = false;
+            if ('[' == c) brace = true;
+            if ('=' == c && !brace) return i;
         }
     }
 
-    function formatTable(text) {
-        // var text = "name|age|comment\n---|----|--\nCheck No|001|Nothing\nHello中文02|002|中文";
-        var lines = text.split('\n');
-        var table = [];
-        var colWidth = [];
-        var defaultWidth = 3;
-
-        // 计算每一个单元格的最大宽度
-        for (var i = 0; i < lines.length; i++) {
-            var line = lines[i];
-            var cols = line.split('|');
-            table[i] = cols;
-            if (cols.length > 1) {
-                // 命中了table的规则
-                for (var j = 0; j < cols.length; j++) {
-                    var cell = cols[j].trim();
-                    cols[j] = cell;
-                    var width = colWidth[j] || defaultWidth;
-                    var thisWidth = getStringWidthIgnoreLine(cell) + colSpacingWidth; // 增加2个宽度
-                    colWidth[j] = Math.max(thisWidth, width);
-                }
-            }
+    function reduce(obj, accumulator) {
+        var i = 0,
+            l = obj.length >> 0,
+            curr = arguments[2];
+        while (i < l) {
+            if (i in obj) curr = accumulator.call(undefined, curr, obj[i], i, obj);
+            ++i;
         }
-        console.log("colWidth:", colWidth);
+        return curr;
+    }
 
-        var newText = "";
-        var newLines = [];
+    function isArray(vArg) {
+        return Object.prototype.toString.call(vArg) === "[object Array]";
+    }
 
-        for (var i = 0; i < table.length; i++) {
-            var row = table[i];
-            if (row.length > 1) {
-                for (var j = 0; j < row.length; j++) {
-                    var cell = row[j].trim();
-                    if (isSeperateLine(cell)) {
-                        // 分割符号
-                        row[j] = makeSeperateLine(colWidth[j]);
-                    } else {
-                        row[j] = cell.padLeft(colWidth[j], ' ');
-                    }
-                }
-            }
-            newLines.push(row.join('|'));
+    function keys(obj) {
+        var key_array = [];
+        for (var prop in obj) {
+            if (obj.hasOwnProperty(prop)) key_array.push(prop);
         }
-        return newLines.join("\n");
+        return key_array;
     }
 
-    window.formatMarkdownTable = formatTable;
+    function purl(url, strictMode) {
+        if (arguments.length === 1 && url === true) {
+            strictMode = true;
+            url = undefined;
+        }
+        strictMode = strictMode || false;
+        url = url || window.location.toString();
 
-})();
+        return {
 
+            data: parseUri(url, strictMode),
 
-// markdown标题处理
-function MarkdownHeading() {
-    this.text = "";
-    this.headings = [];
-}
+            // get various attributes from the URI
+            attr: function(attr) {
+                attr = aliases[attr] || attr;
+                return typeof attr !== 'undefined' ? this.data.attr[attr] : this.data.attr;
+            },
 
-MarkdownHeading.prototype.getParentLevelText = function(info) {
-    if (info.parent === null) {
-        return "";
-    }
-    return info.parent.levelText;
-}
+            // return query string parameters
+            param: function(param) {
+                return typeof param !== 'undefined' ? this.data.param.query[param] : this.data.param.query;
+            },
 
-MarkdownHeading.prototype.getHeadingInfo = function(name, lineNo, prev) {
-    var start = 0;
-    var level = 0;
-    for (var i = 0; i < name.length; i++) {
-        if (name[i] === "#") {
-            level++;
-        }
-        if (name[i] === " " || name[i] === "#") {
-            start++;
-        } else {
-            break;
-        }
-    }
+            // return fragment parameters
+            fparam: function(param) {
+                return typeof param !== 'undefined' ? this.data.param.fragment[param] : this.data.param.fragment;
+            },
 
-    var levelText = "";
-    var lastIndex = 1;
-    var parent = null;
+            // return path segments
+            segment: function(seg) {
+                if (typeof seg === 'undefined') {
+                    return this.data.seg.path;
+                } else {
+                    seg = seg < 0 ? this.data.seg.path.length + seg : seg - 1; // negative segments count from the end
+                    return this.data.seg.path[seg];
+                }
+            },
 
-    if (prev === null) {
-        levelText = "1."
-    } else {
-        if (level > prev.level) {
-            levelText = prev.levelText + "1.";
-            lastIndex = 1;
-            parent = prev;
-        }
+            // return fragment segments
+            fsegment: function(seg) {
+                if (typeof seg === 'undefined') {
+                    return this.data.seg.fragment;
+                } else {
+                    seg = seg < 0 ? this.data.seg.fragment.length + seg : seg - 1; // negative segments count from the end
+                    return this.data.seg.fragment[seg];
+                }
+            }
 
-        if (level === prev.level) {
-            lastIndex = prev.lastIndex + 1;
-            levelText = this.getParentLevelText(prev) + lastIndex + ".";
-            parent = prev.parent;
-        }
+        };
 
-        if (level < prev.level) {
-            var brother = prev.parent;
-            if (brother !== null) {
-                lastIndex = brother.lastIndex + 1;
-                levelText = this.getParentLevelText(brother) + lastIndex + ".";
-                parent = brother.parent;
-            } else {
-                lastIndex = 1;
-                levelText = "1.";
-            }
-        }
     }
 
-    return {
-        name: name.substring(start),
-        lineNo: lineNo,
-        level: level,
-        levelText: levelText,
-        lastIndex: lastIndex,
-        parent: parent
-    }
-}
-
-MarkdownHeading.prototype.load = function(text) {
-    this.text = text;
-    this.headings = [];
-    var lines = text.split("\n");
-    var lineNo = 0;
-    var prev = null;
-    var isInCode = false;
-    var codeTag = "```";
-
-    for (var i = 0; i < lines.length; i++) {
-        lineNo++;
-        var line = lines[i];
-        if (isInCode) {
-            // 代码块内部，简单处理下
-            // FIXME 处理同一行有多个```的情况
-            if (line.indexOf(codeTag) >= 0) {
-                isInCode = false;
-            }
-        } else {
-            if (line[0] == "#") {
-                var info = this.getHeadingInfo(line, lineNo, prev);
-                this.headings.push(info);
-                prev = info;
-            }
-            if (line.indexOf(codeTag) >= 0) {
-                isInCode = true;
-            }
+    purl.jQuery = function($) {
+        if ($ != null) {
+            $.fn.url = function(strictMode) {
+                var url = '';
+                if (this.length) {
+                    url = $(this).attr(getAttrName(this[0])) || '';
+                }
+                return purl(url, strictMode);
+            };
+
+            $.url = purl;
         }
-    }
-}
+    };
+
+    purl.jQuery(window.jQuery);
+
+    return purl;
 
-MarkdownHeading.prototype.getHeadings = function() {
-    return this.headings
-}
+});
```

### Comparing `xnote-web-0.1.0/static/js/fs/fs.js` & `xnote-web-0.1.1/static/js/fs/fs.js`

 * *Files 27% similar despite different names*

#### js-beautify {}

```diff
@@ -1,83 +1,127 @@
-/**
- * 文件相关函数
- */
-var FileView = {};
-var FileAPI = {};
-
-xnote.action.fs = FileView;
-xnote.api.fs = FileAPI;
-
-
-// 调用重命名的API
-FileAPI.rename = function(dirname, oldName, newName, callback) {
-    if (newName != oldName && newName) {
-        xnote.http.post("/fs_api/rename", {
-                dirname: dirname,
-                old_name: oldName,
-                new_name: newName
-            },
-            function(resp) {
-                if (resp.code == "success") {
-                    callback(resp);
-                } else {
-                    xnote.alert("重命名失败:" + resp.message);
-                }
-            });
-    } else {
-        xnote.alert("请输入有效文件名");
-    }
-};
-
-
-// 删除文件
-FileView.delete = function(target) {
-    var path = $(target).attr("data-path");
-    var name = $(target).attr("data-name");
-
-    xnote.confirm("确定删除【" + name + "】?", function(value) {
-        xnote.http.post("/fs_api/remove", {
-            path: path
-        }, function(resp) {
-            if (resp.code == "success") {
-                window.location.reload();
-            } else {
-                xnote.alert("删除失败:" + resp.message);
-            }
-        });
-    });
-};
-
-// 重命名
-FileView.rename = function(target) {
-    var filePath = $(target).attr("data-path");
-    var oldName = $(target).attr("data-name");
-    var realname = $(target).attr("data-realname");
-    if (xnote.isEmpty(realname)) {
-        realname = oldName;
-    }
-
-    var dirname = $("#currentDir").val();
-    xnote.prompt("输入新的文件名", oldName, function(newName) {
-        FileAPI.rename(dirname, realname, newName, function(resp) {
-            window.location.reload();
-        });
-    });
-};
-
-// 打开选项对话框
-FileView.openOptionDialog = function(target) {
-    console.log(window.event);
-    window.event.preventDefault();
-    window.event.stopPropagation();
-    console.log(target);
-    var filePath = $(target).attr("data-path");
-    var fileName = $(target).attr("data-name");
-    var fileRealName = $(target).attr("data-realname");
-    var html = $("#fileItemOptionDialog").render({
-        "filePath": filePath,
-        "fileName": fileName,
-        "fileRealName": fileRealName
-    });
-
-    xnote.openDialog("选项", html);
-};
+/**
+ * 文件相关函数
+ */
+var FileView = {};
+var FileAPI = {};
+
+xnote.action.fs = FileView;
+xnote.api.fs = FileAPI;
+
+// 调用重命名的API
+FileAPI.rename = function(dirname, oldName, newName, callback) {
+    if (newName != oldName && newName) {
+        xnote.http.post("/fs_api/rename", {
+                dirname: dirname,
+                old_name: oldName,
+                new_name: newName
+            },
+            function(resp) {
+                if (resp.code == "success") {
+                    callback(resp);
+                } else {
+                    xnote.alert("重命名失败:" + resp.message);
+                }
+            });
+    } else {
+        xnote.alert("请输入有效文件名");
+    }
+};
+
+
+// 删除文件
+FileView.delete = function(target) {
+    var path = $(target).attr("data-path");
+    var name = $(target).attr("data-name");
+
+    xnote.confirm("确定删除【" + name + "】?", function(value) {
+        xnote.http.post("/fs_api/remove", {
+            path: path
+        }, function(resp) {
+            if (resp.code == "success") {
+                window.location.reload();
+            } else {
+                xnote.alert("删除失败:" + resp.message);
+            }
+        });
+    });
+};
+
+// 重命名
+FileView.rename = function(target) {
+    var filePath = $(target).attr("data-path");
+    var oldName = $(target).attr("data-name");
+    var realname = $(target).attr("data-realname");
+    if (xnote.isEmpty(realname)) {
+        realname = oldName;
+    }
+
+    var dirname = $("#currentDir").val();
+    xnote.prompt("输入新的文件名", oldName, function(newName) {
+        FileAPI.rename(dirname, realname, newName, function(resp) {
+            window.location.reload();
+        });
+    });
+};
+
+// 打开选项对话框
+FileView.openOptionDialog = function(target, event) {
+    // console.log(event);
+    event.preventDefault();
+    event.stopPropagation();
+    console.log(target);
+    var filePath = $(target).attr("data-path");
+    var fileName = $(target).attr("data-name");
+    var fileRealName = $(target).attr("data-realname");
+    var dialogId = xnote.dialog.createNewId();
+
+    var html = $("#fileItemOptionDialog").render({
+        "filePath": filePath,
+        "fileName": fileName,
+        "fileRealName": fileRealName,
+        "dialogId": dialogId,
+    });
+
+    var options = {};
+    options.title = "选项";
+    options.html = html;
+    options.dialogId = dialogId;
+
+    xnote.openDialogEx(options);
+};
+
+// 查看文件详情
+FileView.showDetail = function(target) {
+    var dataPath = $(target).attr("data-path");
+    var params = {
+        fpath: dataPath
+    };
+    xnote.http.get("/fs_api/detail", params, function(resp) {
+        var message = ""
+        if (resp.success) {
+            message = resp.data;
+        } else {
+            message = resp.message;
+        }
+        xnote.showTextDialog("文件详情", message);
+    })
+};
+
+// 移除收藏夹
+FileView.removeBookmark = function(event) {
+    event.preventDefault();
+    var path = $(event.target).attr("data-path")
+    var params = {
+        action: "remove",
+        path: path,
+    }
+
+    xnote.confirm("确定要取消收藏文件<code color=red>" + path + "</code>?", function() {
+        xnote.http.post("/fs_api/bookmark", params, function(resp) {
+            if (resp.code == "success") {
+                window.location.reload()
+            } else {
+                xnote.alert("取消收藏失败，请稍后重试!")
+            }
+        })
+    })
+}
```

### Comparing `xnote-web-0.1.0/static/js/marked-ext.js` & `xnote-web-0.1.1/static/js/marked-ext.js`

 * *Files 19% similar despite different names*

#### js-beautify {}

```diff
@@ -1,544 +1,544 @@
-/**
- * marked.js 插件扩展
- * 依赖: marked.js/jquery
- */
-(function(window) {
-
-    // 目录生成
-    function MarkedContents() {
-        this.id = 0;
-    }
-
-    function initExtOptions(options) {
-        if (options === undefined) {
-            options = {
-                text: "",
-                hideMenu: false,
-                checkboxIndexMap: {},
-                checkboxIndex: 0,
-                csvIndex: 0,
-                csvIndexMap: {},
-                csvEditFunc: "alert"
-            };
-        }
-        if (options.checkboxIndexMap === undefined) {
-            options.checkboxIndexMap = {};
-        }
-        if (options.checkboxIndex === undefined) {
-            options.checkboxIndex = 0;
-        }
-        if (options.csvIndex === undefined) {
-            options.csvIndex = 0;
-        }
-        if (options.csvIndexMap === undefined) {
-            options.csvIndexMap = {};
-        }
-        if (options.csvEditFunc === undefined) {
-            options.csvEditFunc = "alert";
-        }
-        return options;
-    }
-
-    MarkedContents.prototype.createNewId = function() {
-        this.id++;
-        return "heading-" + this.id;
-    }
-
-    MarkedContents.prototype.generateHtml = function(myRenderer) {
-        if (extOptions.hideMenu) {
-            return ""
-        }
-
-        console.log("contents.generateHtml start");
-
-        var menuText = "";
-        var menuList = [];
-        var minLevel = null;
-        var prevLevel = 1;
-
-        menuText += '<div class="marked-contents">';
-        menuText += '<span class="marked-contents-title">目录</span>';
-        menuText += "<ul>";
-
-        // 先把基础层级计算好
-        for (var i = 0; i < myRenderer.headings.length; i++) {
-            var heading = myRenderer.headings[i];
-            var text = heading.text;
-            var link = heading.link;
-            var level = heading.level;
-
-            if (minLevel === null) {
-                minLevel = level;
-            } else {
-                minLevel = Math.min(minLevel, level);
-            }
-
-            menuList.push([level, text, link]);
-        }
-
-        if (minLevel === null) {
-            minLevel = 1;
-        }
-
-        console.log("contents minLevel:", minLevel);
-
-        // 准备渲染目录
-        for (var i = 0; i < menuList.length; i++) {
-            var item = menuList[i];
-            var level = item[0];
-            var text = item[1];
-            var link = item[2];
-
-            // 调整层级
-            level = level - minLevel + 1;
-
-            if (level === prevLevel) {
-                menuText += buildMenuLink(text, link);
-            }
-
-            if (level > prevLevel) {
-                // 进入下一层
-                menuText += repeatElement("<ul>", level - prevLevel);
-                menuText += buildMenuLink(text, link);
-            }
-
-            if (level < prevLevel) {
-                // 退出下一层
-                menuText += repeatElement("</ul>", prevLevel - level);
-                menuText += buildMenuLink(text, link);
-            }
-
-            // 更新之前的层级
-            prevLevel = level;
-        }
-
-        menuText += repeatElement("</ul>", prevLevel);
-        menuText += "</ul>";
-        menuText += "</div>";
-
-        console.log("contents.generateHtml end");
-        return menuText;
-    }
-
-    // 全局变量
-    var globals = {
-        contents: new MarkedContents()
-    };
-
-    // marked 初始化操作
-    var myRenderer = new marked.Renderer();
-
-    myRenderer.headings = [];
-
-    marked.setOptions({
-        renderer: myRenderer,
-        highlight: highlight
-    });
-
-    marked.showMenu = true;
-    var oldParse = marked.parse;
-
-    // 扩展选项
-    var extOptions = initExtOptions();
-
-    // 进度的正则匹配
-    var regexPercent = /\d+(\.\d+)?\%/;
-
-    // 后面都是定义的函数和重写html生成
-    function escape(html, encode) {
-        return html
-            .replace(!encode ? /&(?!#?\w+;)/g : /&/g, '&amp;')
-            .replace(/</g, '&lt;')
-            .replace(/>/g, '&gt;')
-            .replace(/"/g, '&quot;')
-            .replace(/'/g, '&#39;');
-    }
-
-    function getCsvRowText(text) {
-        if (text === undefined) {
-            return "-";
-        }
-        return text;
-    }
-
-    function highlightCsv(code, lang) {
-        // 处理csv的展示
-        extOptions.csvIndex++;
-        var dupIndex = extOptions.csvIndexMap[code]
-        if (dupIndex === undefined) {
-            dupIndex = 0;
-        } else {
-            dupIndex++;
-        }
-        extOptions.csvIndexMap[code] = dupIndex;
-
-        var codeBlock = "```" + lang + "\n" + code + "\n```";
-
-        try {
-            // var csv = new CSV(code);
-            var rows = CSV.parse(code);
-            var table = $("<table>").attr("data-index", dupIndex).addClass("table");
-            var editAction = $("<a>").text("编辑表格");
-            editAction.attr("onclick", extOptions.csvEditFunc + "(this)");
-            editAction.attr("data-code", code).attr("data-index", dupIndex);
-            editAction.attr("data-lang", lang);
-
-            if (rows.length > 0) {
-                var headRow = rows[0];
-                var head = $("<tr>");
-                for (var j = 0; j < headRow.length; j++) {
-                    var th = $("<th>").text(getCsvRowText(headRow[j]));
-                    head.append(th);
-                }
-                table.append(head);
-
-                for (var i = 1; i < rows.length; i++) {
-                    var row = rows[i];
-                    var tr = $("<tr>");
-                    for (var j = 0; j < row.length; j++) {
-                        var td = $("<td>").text(getCsvRowText(row[j]));
-                        tr.append(td);
-                    }
-                    table.append(tr);
-                }
-            }
-            console.log(table);
-            window.csv_table = table;
-
-            if (extOptions.text.indexOf(codeBlock) >= 0) {
-                // 符合csv标准格式, 返回编辑按钮
-                return editAction.prop("outerHTML") + table.prop("outerHTML");
-            }
-
-            return table.prop("outerHTML");
-        } catch (e) {
-            console.log(e);
-            return escape(code);
-        }
-    }
-
-    function replaceKeyword(html, regexp, target) {
-        target = target || regexp;
-        return html.replace(new RegExp(regexp, 'g'), '<code class="keyword">' + target + "</code>");
-    }
-
-    function highlightKeywords(code, lang) {
-        // 这个需要依赖 hightlight
-        console.log("code language:", lang);
-        if (window.hljs == undefined) {
-            return code
-        }
-        if (lang == undefined) {
-            return hljs.highlightAuto(code).value;
-        }
-        try {
-            return hljs.highlight(code, {
-                language: lang
-            }).value;
-        } catch (e) {
-            return hljs.highlightAuto(code).value;
-        }
-    }
-
-    function highlight(code, lang) {
-        console.log(code, lang);
-        var langUpper;
-        if (lang) {
-            langUpper = lang.toUpperCase();
-        }
-        if (langUpper == "CSV") {
-            return highlightCsv(code, lang);
-        } else if (langUpper == "EXCEL") {
-            code = code.replace(/\t/g, ",");
-            // some \t may be replaced by four space
-            code = code.replace(/ {4}/g, ',');
-            console.log(code);
-            return highlightCsv(code, lang);
-        } else {
-            return highlightKeywords(code, langUpper);
-        }
-    }
-
-    // 处理待办的样式
-    function processCheckbox(text, clickable) {
-        var result = {};
-        var disabled = false;
-
-        if (clickable !== undefined) {
-            disabled = !clickable;
-        }
-
-        // 多选框选项索引
-        extOptions.checkboxIndex++;
-
-        var checkbox = $("<input>")
-            .attr("type", "checkbox")
-            .addClass("marked")
-            .attr("data-text", text);
-
-        if (disabled) {
-            checkbox.attr("disabled", true);
-        }
-
-        // 调试日志
-        console.info(extOptions.checkboxIndex, checkbox);
-        // 处理同名的待办索引
-        var index = extOptions.checkboxIndexMap[text]
-        if (index === undefined) {
-            index = 0;
-        } else {
-            index++;
-        }
-        extOptions.checkboxIndexMap[text] = index;
-        checkbox.attr("data-index", index); // 记录是第几个checkbox
-
-        if (/^\[\]/.test(text)) {
-            var content = text.substring(2);
-            var tail = "";
-            var parts = content.split("<ul>", 2); // content可能包含HTML
-            if (parts.length == 2) {
-                content = parts[0];
-                tail = "<ul>" + parts[1];
-            }
-
-            var element = $("<span>").html(content).addClass("xnote-todo");
-
-            if (regexPercent.test(content)) {
-                // 包含百分比的加上进行中的进度
-                element = element.addClass("doing");
-            }
-            result.checkbox = checkbox.prop("outerHTML");
-            result.text = element.prop("outerHTML") + tail;
-        } else if (/^\[ \]/.test(text)) {
-            result.checkbox = checkbox.prop("outerHTML");
-            result.text = text.substring(3);
-        } else if (/^\[[Xx]\]/.test(text)) {
-            checkbox.attr("checked", true);
-            console.info("set checked", checkbox);
-            result.checkbox = checkbox.prop("outerHTML");
-            result.text = '<span class="xnote-done">' + text.substring(3) + '</span>';
-        } else {
-            result.checkbox = '';
-            result.text = text;
-        }
-        return result;
-    }
-
-    myRenderer.listitem = function(text) {
-        var result = processCheckbox(text, true);
-        return '<li>' + result.checkbox + result.text + '</li>\n';
-    }
-
-    myRenderer.paragraph = function(text) {
-        var result = processCheckbox(text);
-        return '<p>' + result.checkbox + result.text + '</p>\n';
-    }
-
-    myRenderer.heading = function(text, level, raw) {
-        var id = globals.contents.createNewId();
-
-        this.headings.push({
-            text: raw,
-            link: id,
-            level: level
-        });
-        var checkboxResult = processCheckbox(text);
-
-        return '<h' +
-            level +
-            ' id="' +
-            this.options.headerPrefix +
-            id +
-            '" class="marked-heading"' +
-            ' "data-level"=' + level +
-            '>' +
-            checkboxResult.checkbox +
-            checkboxResult.text +
-            '</h' +
-            level +
-            '>\n';
-    }
-
-    /// 重写img, 不依赖JS版本
-    // myRenderer.image = function(href, title, text) {
-    //   var out = '<p class="marked-img"><a href="' + href + '"><img src="' + href + '" alt="' + text + '" style="max-width:100%;"';
-    //   if (title) {
-    //     out += ' title="' + title + '"';
-    //   }
-    //   out += this.options.xhtml ? '/>' : '>';
-    //   out += '</a></p>'
-    //   return out;
-    // };
-
-    // 重写img
-    myRenderer.image = function(href, title, text) {
-        var imgSrc = href;
-        // if (href && /^https?/.test(href)) {
-        //     imgSrc = "/fs_cache/image?url=" + encodeURIComponent(href);
-        // }
-        var out = '<p class="marked-img"><img class="x-photo" src="' + imgSrc + '" alt="' + text + '" style="max-width:100%;"';
-        if (title) {
-            out += ' title="' + title + '"';
-        }
-        out += this.options.xhtml ? '/>' : '>';
-        out += '</p>'
-        return out;
-    };
-
-    // 重写code
-    myRenderer.code = function(code, lang, escaped) {
-        if (this.options.highlight) {
-            var out = this.options.highlight(code, lang);
-            if (out != null && out !== code) {
-                escaped = true;
-                code = out;
-            }
-        }
-
-        // 没有定义语言
-        if (!lang) {
-            return '<pre class="marked-code"><code>' +
-                (escaped ? code : escape(code, true)) +
-                '\n</code></pre>';
-        }
-
-        // csv
-        if ("csv" == lang.toLowerCase()) {
-            return '<div>' + code + '</div>';
-        }
-
-        // 定义语言
-        return '<pre class="marked-code"><code class="' +
-            this.options.langPrefix +
-            escape(lang, true) +
-            '">' +
-            (escaped ? code : escape(code, true)) +
-            '\n</code></pre>\n';
-    };
-
-    // 单行的code
-    myRenderer.codespan = function(text) {
-        return '<code class="marked-codespan">' + text + '</code>';
-    }
-
-    // 重写strong
-    myRenderer.strong = function(text) {
-        return '<strong class="marked-strong"><a href="/s/' + text + '">' + text + '</a></strong>';
-    }
-
-    // 重写html标签
-    myRenderer.html = function(html) {
-        try {
-            var cap = marked.Lexer.rules.html.exec(html);
-            console.log(cap, html);
-            var htmlTag = cap[1].toLowerCase();
-            if (htmlTag == "script" || htmlTag == "pre") {
-                // 过滤脚本
-                return "";
-            }
-        } catch (e) {
-            console.error(e);
-        }
-        return html;
-    }
-
-    myRenderer.table = function(header, body) {
-        return '<table class="table marked-table">\n' +
-            '<thead>\n' +
-            header +
-            '</thead>\n' +
-            '<tbody>\n' +
-            body +
-            '</tbody>\n' +
-            '</table>\n';
-    };
-
-    myRenderer.link = function(href, title, text) {
-        if (this.options.sanitize) {
-            try {
-                var prot = decodeURIComponent(unescape(href))
-                    .replace(/[^\w:]/g, '')
-                    .toLowerCase();
-            } catch (e) {
-                return '';
-            }
-            if (prot.indexOf('javascript:') === 0 || prot.indexOf('vbscript:') === 0) {
-                return '';
-            }
-        }
-        var out = '<a target="_blank" href="' + href + '"';
-        // var out = '<a href="' + href + '" target="_blank" ';
-        if (title) {
-            out += ' title="' + title + '"';
-        }
-        out += '>' + text + '</a>';
-        return out;
-    };
-
-    function buildMenuLink(text, link) {
-        return '<li><a href="#link">text</a></li>'.replace(/mleft|link|text/g, function(match, index) {
-            // console.log(match, index);
-            if (match == "link") {
-                // 目录的链接
-                return link;
-            } else {
-                // 目录的文本
-                return text;
-            }
-        });
-    }
-
-    function repeatElement(element, times) {
-        var text = "";
-        for (var i = 0; i < times; i++) {
-            text += element;
-        }
-        return text;
-    }
-
-    function adjustTableWidth() {
-        xnote.table.adjustWidth(".marked-table");
-    }
-
-    // 重写parse方法
-    marked.parse = function(text) {
-        if (!marked.showMenu) {
-            return oldParse(text);
-        }
-
-        myRenderer.headings = [];
-        var outtext = oldParse(text);
-        if (myRenderer.headings.length == 0) {
-            return outtext;
-        }
-
-        // 处理目录
-        var menuHtml = globals.contents.generateHtml(myRenderer);
-
-        outtext = menuHtml + outtext;
-
-        $(".menu-aside").show();
-        $("#menuBox").html(menuHtml);
-        return outtext;
-    };
-
-    marked.parseAndRender = function(text, target, options) {
-        // 处理扩展选项
-        extOptions = initExtOptions(options);
-        extOptions.text = text;
-
-        var html = marked.parse(text);
-        $(target).html(html);
-        adjustTableWidth();
-
-        // 注册点击事件
-        $("input[type=checkbox].marked").click(function(e) {
-            var onCheckboxClicked = extOptions.onCheckboxClicked;
-            if (onCheckboxClicked) {
-                onCheckboxClicked(e);
-            }
-        });
-    };
-
-
+/**
+ * marked.js 插件扩展
+ * 依赖: marked.js/jquery
+ */
+(function(window) {
+
+    // 目录生成
+    function MarkedContents() {
+        this.id = 0;
+    }
+
+    function initExtOptions(options) {
+        if (options === undefined) {
+            options = {
+                text: "",
+                hideMenu: false,
+                checkboxIndexMap: {},
+                checkboxIndex: 0,
+                csvIndex: 0,
+                csvIndexMap: {},
+                csvEditFunc: "alert"
+            };
+        }
+        if (options.checkboxIndexMap === undefined) {
+            options.checkboxIndexMap = {};
+        }
+        if (options.checkboxIndex === undefined) {
+            options.checkboxIndex = 0;
+        }
+        if (options.csvIndex === undefined) {
+            options.csvIndex = 0;
+        }
+        if (options.csvIndexMap === undefined) {
+            options.csvIndexMap = {};
+        }
+        if (options.csvEditFunc === undefined) {
+            options.csvEditFunc = "alert";
+        }
+        return options;
+    }
+
+    MarkedContents.prototype.createNewId = function() {
+        this.id++;
+        return "heading-" + this.id;
+    }
+
+    MarkedContents.prototype.generateHtml = function(myRenderer) {
+        if (extOptions.hideMenu) {
+            return ""
+        }
+
+        console.log("contents.generateHtml start");
+
+        var menuText = "";
+        var menuList = [];
+        var minLevel = null;
+        var prevLevel = 1;
+
+        menuText += '<div class="marked-contents">';
+        menuText += '<span class="marked-contents-title">目录</span>';
+        menuText += "<ul>";
+
+        // 先把基础层级计算好
+        for (var i = 0; i < myRenderer.headings.length; i++) {
+            var heading = myRenderer.headings[i];
+            var text = heading.text;
+            var link = heading.link;
+            var level = heading.level;
+
+            if (minLevel === null) {
+                minLevel = level;
+            } else {
+                minLevel = Math.min(minLevel, level);
+            }
+
+            menuList.push([level, text, link]);
+        }
+
+        if (minLevel === null) {
+            minLevel = 1;
+        }
+
+        console.log("contents minLevel:", minLevel);
+
+        // 准备渲染目录
+        for (var i = 0; i < menuList.length; i++) {
+            var item = menuList[i];
+            var level = item[0];
+            var text = item[1];
+            var link = item[2];
+
+            // 调整层级
+            level = level - minLevel + 1;
+
+            if (level === prevLevel) {
+                menuText += buildMenuLink(text, link);
+            }
+
+            if (level > prevLevel) {
+                // 进入下一层
+                menuText += repeatElement("<ul>", level - prevLevel);
+                menuText += buildMenuLink(text, link);
+            }
+
+            if (level < prevLevel) {
+                // 退出下一层
+                menuText += repeatElement("</ul>", prevLevel - level);
+                menuText += buildMenuLink(text, link);
+            }
+
+            // 更新之前的层级
+            prevLevel = level;
+        }
+
+        menuText += repeatElement("</ul>", prevLevel);
+        menuText += "</ul>";
+        menuText += "</div>";
+
+        console.log("contents.generateHtml end");
+        return menuText;
+    }
+
+    // 全局变量
+    var globals = {
+        contents: new MarkedContents()
+    };
+
+    // marked 初始化操作
+    var myRenderer = new marked.Renderer();
+
+    myRenderer.headings = [];
+
+    marked.setOptions({
+        renderer: myRenderer,
+        highlight: highlight
+    });
+
+    marked.showMenu = true;
+    var oldParse = marked.parse;
+
+    // 扩展选项
+    var extOptions = initExtOptions();
+
+    // 进度的正则匹配
+    var regexPercent = /\d+(\.\d+)?\%/;
+
+    // 后面都是定义的函数和重写html生成
+    function escape(html, encode) {
+        return html
+            .replace(!encode ? /&(?!#?\w+;)/g : /&/g, '&amp;')
+            .replace(/</g, '&lt;')
+            .replace(/>/g, '&gt;')
+            .replace(/"/g, '&quot;')
+            .replace(/'/g, '&#39;');
+    }
+
+    function getCsvRowText(text) {
+        if (text === undefined) {
+            return "-";
+        }
+        return text;
+    }
+
+    function highlightCsv(code, lang) {
+        // 处理csv的展示
+        extOptions.csvIndex++;
+        var dupIndex = extOptions.csvIndexMap[code]
+        if (dupIndex === undefined) {
+            dupIndex = 0;
+        } else {
+            dupIndex++;
+        }
+        extOptions.csvIndexMap[code] = dupIndex;
+
+        var codeBlock = "```" + lang + "\n" + code + "\n```";
+
+        try {
+            // var csv = new CSV(code);
+            var rows = CSV.parse(code);
+            var table = $("<table>").attr("data-index", dupIndex).addClass("table");
+            var editAction = $("<a>").text("编辑表格");
+            editAction.attr("onclick", extOptions.csvEditFunc + "(this)");
+            editAction.attr("data-code", code).attr("data-index", dupIndex);
+            editAction.attr("data-lang", lang);
+
+            if (rows.length > 0) {
+                var headRow = rows[0];
+                var head = $("<tr>");
+                for (var j = 0; j < headRow.length; j++) {
+                    var th = $("<th>").text(getCsvRowText(headRow[j]));
+                    head.append(th);
+                }
+                table.append(head);
+
+                for (var i = 1; i < rows.length; i++) {
+                    var row = rows[i];
+                    var tr = $("<tr>");
+                    for (var j = 0; j < row.length; j++) {
+                        var td = $("<td>").text(getCsvRowText(row[j]));
+                        tr.append(td);
+                    }
+                    table.append(tr);
+                }
+            }
+            console.log(table);
+            window.csv_table = table;
+
+            if (extOptions.text.indexOf(codeBlock) >= 0) {
+                // 符合csv标准格式, 返回编辑按钮
+                return editAction.prop("outerHTML") + table.prop("outerHTML");
+            }
+
+            return table.prop("outerHTML");
+        } catch (e) {
+            console.log(e);
+            return escape(code);
+        }
+    }
+
+    function replaceKeyword(html, regexp, target) {
+        target = target || regexp;
+        return html.replace(new RegExp(regexp, 'g'), '<code class="keyword">' + target + "</code>");
+    }
+
+    function highlightKeywords(code, lang) {
+        // 这个需要依赖 hightlight
+        console.log("code language:", lang);
+        if (window.hljs == undefined) {
+            return code
+        }
+        if (lang == undefined) {
+            return hljs.highlightAuto(code).value;
+        }
+        try {
+            return hljs.highlight(code, {
+                language: lang
+            }).value;
+        } catch (e) {
+            return hljs.highlightAuto(code).value;
+        }
+    }
+
+    function highlight(code, lang) {
+        console.log(code, lang);
+        var langUpper;
+        if (lang) {
+            langUpper = lang.toUpperCase();
+        }
+        if (langUpper == "CSV") {
+            return highlightCsv(code, lang);
+        } else if (langUpper == "EXCEL") {
+            code = code.replace(/\t/g, ",");
+            // some \t may be replaced by four space
+            code = code.replace(/ {4}/g, ',');
+            console.log(code);
+            return highlightCsv(code, lang);
+        } else {
+            return highlightKeywords(code, langUpper);
+        }
+    }
+
+    // 处理待办的样式
+    function processCheckbox(text, clickable) {
+        var result = {};
+        var disabled = false;
+
+        if (clickable !== undefined) {
+            disabled = !clickable;
+        }
+
+        // 多选框选项索引
+        extOptions.checkboxIndex++;
+
+        var checkbox = $("<input>")
+            .attr("type", "checkbox")
+            .addClass("marked")
+            .attr("data-text", text);
+
+        if (disabled) {
+            checkbox.attr("disabled", true);
+        }
+
+        // 调试日志
+        console.info(extOptions.checkboxIndex, checkbox);
+        // 处理同名的待办索引
+        var index = extOptions.checkboxIndexMap[text]
+        if (index === undefined) {
+            index = 0;
+        } else {
+            index++;
+        }
+        extOptions.checkboxIndexMap[text] = index;
+        checkbox.attr("data-index", index); // 记录是第几个checkbox
+
+        if (/^\[\]/.test(text)) {
+            var content = text.substring(2);
+            var tail = "";
+            var parts = content.split("<ul>", 2); // content可能包含HTML
+            if (parts.length == 2) {
+                content = parts[0];
+                tail = "<ul>" + parts[1];
+            }
+
+            var element = $("<span>").html(content).addClass("xnote-todo");
+
+            if (regexPercent.test(content)) {
+                // 包含百分比的加上进行中的进度
+                element = element.addClass("doing");
+            }
+            result.checkbox = checkbox.prop("outerHTML");
+            result.text = element.prop("outerHTML") + tail;
+        } else if (/^\[ \]/.test(text)) {
+            result.checkbox = checkbox.prop("outerHTML");
+            result.text = text.substring(3);
+        } else if (/^\[[Xx]\]/.test(text)) {
+            checkbox.attr("checked", true);
+            console.info("set checked", checkbox);
+            result.checkbox = checkbox.prop("outerHTML");
+            result.text = '<span class="xnote-done">' + text.substring(3) + '</span>';
+        } else {
+            result.checkbox = '';
+            result.text = text;
+        }
+        return result;
+    }
+
+    myRenderer.listitem = function(text) {
+        var result = processCheckbox(text, true);
+        return '<li>' + result.checkbox + result.text + '</li>\n';
+    }
+
+    myRenderer.paragraph = function(text) {
+        var result = processCheckbox(text);
+        return '<p>' + result.checkbox + result.text + '</p>\n';
+    }
+
+    myRenderer.heading = function(text, level, raw) {
+        var id = globals.contents.createNewId();
+
+        this.headings.push({
+            text: raw,
+            link: id,
+            level: level
+        });
+        var checkboxResult = processCheckbox(text);
+
+        return '<h' +
+            level +
+            ' id="' +
+            this.options.headerPrefix +
+            id +
+            '" class="marked-heading"' +
+            ' "data-level"=' + level +
+            '>' +
+            checkboxResult.checkbox +
+            checkboxResult.text +
+            '</h' +
+            level +
+            '>\n';
+    }
+
+    /// 重写img, 不依赖JS版本
+    // myRenderer.image = function(href, title, text) {
+    //   var out = '<p class="marked-img"><a href="' + href + '"><img src="' + href + '" alt="' + text + '" style="max-width:100%;"';
+    //   if (title) {
+    //     out += ' title="' + title + '"';
+    //   }
+    //   out += this.options.xhtml ? '/>' : '>';
+    //   out += '</a></p>'
+    //   return out;
+    // };
+
+    // 重写img
+    myRenderer.image = function(href, title, text) {
+        var imgSrc = href;
+        // if (href && /^https?/.test(href)) {
+        //     imgSrc = "/fs_cache/image?url=" + encodeURIComponent(href);
+        // }
+        var out = '<p class="marked-img"><img class="x-photo" src="' + imgSrc + '" alt="' + text + '" style="max-width:100%;"';
+        if (title) {
+            out += ' title="' + title + '"';
+        }
+        out += this.options.xhtml ? '/>' : '>';
+        out += '</p>'
+        return out;
+    };
+
+    // 重写code
+    myRenderer.code = function(code, lang, escaped) {
+        if (this.options.highlight) {
+            var out = this.options.highlight(code, lang);
+            if (out != null && out !== code) {
+                escaped = true;
+                code = out;
+            }
+        }
+
+        // 没有定义语言
+        if (!lang) {
+            return '<pre class="marked-code"><code>' +
+                (escaped ? code : escape(code, true)) +
+                '\n</code></pre>';
+        }
+
+        // csv
+        if ("csv" == lang.toLowerCase()) {
+            return '<div>' + code + '</div>';
+        }
+
+        // 定义语言
+        return '<pre class="marked-code"><code class="' +
+            this.options.langPrefix +
+            escape(lang, true) +
+            '">' +
+            (escaped ? code : escape(code, true)) +
+            '\n</code></pre>\n';
+    };
+
+    // 单行的code
+    myRenderer.codespan = function(text) {
+        return '<code class="marked-codespan">' + text + '</code>';
+    }
+
+    // 重写strong
+    myRenderer.strong = function(text) {
+        return '<strong class="marked-strong"><a href="/s/' + text + '">' + text + '</a></strong>';
+    }
+
+    // 重写html标签
+    myRenderer.html = function(html) {
+        try {
+            var cap = marked.Lexer.rules.html.exec(html);
+            console.log(cap, html);
+            var htmlTag = cap[1].toLowerCase();
+            if (htmlTag == "script" || htmlTag == "pre") {
+                // 过滤脚本
+                return "";
+            }
+        } catch (e) {
+            console.error(e);
+        }
+        return html;
+    }
+
+    myRenderer.table = function(header, body) {
+        return '<table class="table marked-table">\n' +
+            '<thead>\n' +
+            header +
+            '</thead>\n' +
+            '<tbody>\n' +
+            body +
+            '</tbody>\n' +
+            '</table>\n';
+    };
+
+    myRenderer.link = function(href, title, text) {
+        if (this.options.sanitize) {
+            try {
+                var prot = decodeURIComponent(unescape(href))
+                    .replace(/[^\w:]/g, '')
+                    .toLowerCase();
+            } catch (e) {
+                return '';
+            }
+            if (prot.indexOf('javascript:') === 0 || prot.indexOf('vbscript:') === 0) {
+                return '';
+            }
+        }
+        var out = '<a target="_blank" href="' + href + '"';
+        // var out = '<a href="' + href + '" target="_blank" ';
+        if (title) {
+            out += ' title="' + title + '"';
+        }
+        out += '>' + text + '</a>';
+        return out;
+    };
+
+    function buildMenuLink(text, link) {
+        return '<li><a href="#link">text</a></li>'.replace(/mleft|link|text/g, function(match, index) {
+            // console.log(match, index);
+            if (match == "link") {
+                // 目录的链接
+                return link;
+            } else {
+                // 目录的文本
+                return text;
+            }
+        });
+    }
+
+    function repeatElement(element, times) {
+        var text = "";
+        for (var i = 0; i < times; i++) {
+            text += element;
+        }
+        return text;
+    }
+
+    function adjustTableWidth() {
+        xnote.table.adjustWidth(".marked-table");
+    }
+
+    // 重写parse方法
+    marked.parse = function(text) {
+        if (!marked.showMenu) {
+            return oldParse(text);
+        }
+
+        myRenderer.headings = [];
+        var outtext = oldParse(text);
+        if (myRenderer.headings.length == 0) {
+            return outtext;
+        }
+
+        // 处理目录
+        var menuHtml = globals.contents.generateHtml(myRenderer);
+
+        outtext = menuHtml + outtext;
+
+        $(".menu-aside").show();
+        $("#menuBox").html(menuHtml);
+        return outtext;
+    };
+
+    marked.parseAndRender = function(text, target, options) {
+        // 处理扩展选项
+        extOptions = initExtOptions(options);
+        extOptions.text = text;
+
+        var html = marked.parse(text);
+        $(target).html(html);
+        adjustTableWidth();
+
+        // 注册点击事件
+        $("input[type=checkbox].marked").click(function(e) {
+            var onCheckboxClicked = extOptions.onCheckboxClicked;
+            if (onCheckboxClicked) {
+                onCheckboxClicked(e);
+            }
+        });
+    };
+
+
 })(window);
```

### Comparing `xnote-web-0.1.0/static/js/note.js` & `xnote-web-0.1.1/static/js/note.js`

 * *Files 20% similar despite different names*

#### js-beautify {}

```diff
@@ -1,532 +1,532 @@
-/**
- * 更新笔记的类目
- * @deprecated 已废弃
- * @param {object} req 更新请求
- */
-xnote.updateNoteCategory = function(req) {
-    if (req === undefined) {
-        throw new Error("req is undefined");
-    }
-    if (req.noteId === undefined) {
-        throw new Error("req.noteId is undefined");
-    }
-    if (req.value === undefined) {
-        throw new Error("req.value is undefined");
-    }
-
-    var params = {
-        id: req.noteId,
-        key: "category",
-        value: req.value
-    };
-
-    xnote.http.post("/note/attribute/update", params, function(resp) {
-        console.log("update category", resp);
-        if (resp.code == "success") {
-            xnote.toast("更新类目成功");
-            if (req.doRefresh) {
-                window.location.reload();
-            }
-        } else {
-            xnote.alert(resp.message);
-        }
-    });
-};
-
-/**
- * 更新类目的名称
- * @param {object} req 请求对象
- */
-xnote.updateCategoryName = function(req) {
-    if (req === undefined) {
-        throw new Error("req is undefined");
-    }
-    if (req.oldName === undefined) {
-        throw new Error("req.oldName is undefined");
-    }
-    if (req.code === undefined) {
-        throw new Error("req.code is undefined");
-    }
-
-    xnote.prompt("重命名类目", req.oldName, function(newName) {
-        var params = {
-            code: req.code,
-            name: newName
-        };
-
-        xnote.http.post("/api/note/category/update", params, function(resp) {
-            if (resp.code == "success") {
-                window.location.reload();
-            } else {
-                xnote.alert(resp.message);
-            }
-        });
-    });
-};
-
-// 创建笔记接口
-xnote.api["note.create"] = function(req) {
-    xnote.validate.notUndefined(req.name, "req.name is undefined");
-    xnote.validate.notUndefined(req.parentId, "req.parentId is undefined");
-    xnote.validate.notUndefined(req.type, "req.type is undefined");
-    xnote.validate.isFunction(req.callback, "req.callback is not function");
-
-    var createOption = {};
-    createOption.name = req.name;
-    createOption.parent_id = req.parentId;
-    createOption.type = req.type;
-    createOption._format = "json";
-
-    var title = req.name;
-
-    xnote.http.post("/note/create", createOption, function(resp) {
-        if (resp.code == "success") {
-            req.callback(resp);
-        } else {
-            xnote.alert(title + "失败:" + resp.message);
-        }
-    });
-};
-
-// 复制笔记接口
-xnote.api["note.copy"] = function(req) {
-    xnote.validate.notUndefined(req.name, "req.name is undefined");
-    xnote.validate.notUndefined(req.originId, "req.originId is undefined");
-    var copyOption = {
-        name: req.name,
-        origin_id: req.originId
-    };
-    var title = req.name;
-
-    xnote.http.post("/note/copy", copyOption, function(resp) {
-        if (resp.code == "success") {
-            req.callback(resp);
-        } else {
-            xnote.alert(title + "失败:" + resp.message);
-        }
-    });
-};
-
-var noteAPI = {};
-xnote.api.note = noteAPI;
-
-
-// 绑定标签
-noteAPI.bindTag = function(cmd) {
-    var currentTags = cmd.currentTags;
-    var tagList = cmd.tagList;
-    var allTagList = cmd.allTagList; // 全部的标签
-    var targetId = cmd.targetId;
-
-    if (cmd.tagType != "group" && cmd.tagType != "note") {
-        throw new TypeError("无效的tagType");
-    }
-
-    // 渲染绑定标签的html
-    var html = $("#bindTagTemplate").render({
-        tagList: tagList,
-        allTagList: allTagList,
-        selectedNames: currentTags,
-        manageLink: cmd.manageLink,
-        globalTagList: [{
-            tag_name: "待办",
-            tag_code: "$todo$"
-        }],
-    });
-
-    console.log("bind-tag-dialog", html);
-
-    xnote.openDialog("添加标签", html, ["确定", "取消"], function() {
-        var selectedNames = [];
-        $(".tag.bind.active").each(function(idx, ele) {
-            var tagName = $(ele).attr("data-code");
-            selectedNames.push(tagName);
-        });
-
-        var bindParams = {
-            tag_type: cmd.tagType,
-            group_id: cmd.groupId,
-            note_id: cmd.noteId,
-            tag_names: JSON.stringify(selectedNames),
-        };
-
-        xnote.http.post("/note/tag/bind", bindParams, function(resp) {
-            if (resp.code != "success") {
-                xnote.alert(resp.message);
-            } else {
-                xnote.toast("添加标签成功");
-            }
-            location.reload();
-        });
-    });
-};
-
-
-var NoteView = {};
-xnote.action.note = NoteView;
-xnote.note = NoteView;
-
-NoteView.onTagClick = function(target) {
-    $(target).toggleClass("active");
-}
-
-// 编辑笔记的标签
-NoteView.editNoteTag = function(target) {
-    var parentId = $(target).attr("data-parent-id");
-    var noteId = $(target).attr("data-id");
-    var tagsJson = $(target).attr("data-tags");
-    var tagType = $(target).attr("data-tag-type");
-    if (xnote.isEmpty(tagType)) {
-        tagType = "note";
-    }
-
-    var listParams = {
-        tag_type: tagType,
-        group_id: parentId,
-        v: 2,
-    };
-
-    xnote.http.get("/note/tag/list", listParams, function(resp) {
-        var cmd = {
-            tagType: "note", // 绑定类型始终是note
-            currentTags: JSON.parse(tagsJson),
-            noteId: noteId,
-            manageLink: "/note/manage?parent_id=" + parentId,
-        };
-        // 推荐的标签
-        cmd.tagList = resp.data.suggest_list;
-        // 全部的标签
-        cmd.allTagList = resp.data.all_list;
-        // 调用绑定标签组件
-        noteAPI.bindTag(cmd);
-    })
-};
-
-NoteView.searchNote = function() {
-    var self = this;
-    var searchText = $("#note-search-text").val();
-    var api = "";
-    if (searchText == "") {
-        api = "/note/api/timeline?type=all&limit=100";
-    } else {
-        api = "/note/api/timeline?type=search&key=" + searchText;
-    }
-    xnote.http.get(api, function(resp) {
-        if (resp.code != "success") {
-            xnote.toast(resp.message);
-        } else {
-            var templateText = self.getSelectNoteItemListTemplate();
-            var html = template.render(templateText, {
-                itemList: resp.data
-            });
-            $(".note-search-dialog-body").html(html);
-        }
-    });
-};
-
-NoteView.getSelectNoteItemListTemplate = function() {
-    var text = "";
-    text += "{{if itemList.length == 0 }}";
-    text += "    <p class=\"align-center\">空空如也~</p>";
-    text += "{{/if}}";
-    text += "{{each itemList item}}";
-    text += "<h3 class=\"card-title-2\">{{item.title}}</h3>";
-    text += "    {{each item.children subItem }}";
-    text += "    <p class=\"card-row share-dialog-row\">";
-    text += "        <i class=\"fa {{subItem.icon}}\"></i>";
-    text += "        <a href=\"{{subItem.url}}\">{{subItem.name}}</a>";
-    text += "        <input type=\"checkbox\"";
-    text += "            class=\"select-note-checkbox float-right\" ";
-    text += "            data-id=\"{{subItem.id}}\">";
-    text += "    <p>";
-    text += "    {{/each}}";
-    text += "{{/each}}";
-    return text;
-}
-
-NoteView.getSelectNoteDialogTemplate = function() {
-    var text = "";
-    text += "<div class=\"card\">";
-    text += "<div class=\"row\">";
-    text += "    <input type=\"text\" class=\"nav-search-input\" id=\"note-search-text\" placeholder=\"搜索笔记\" ";
-    text += "        value=\"{{searchText}}\" onkeyup=\"xnote.action.note.searchNote(this);\">";
-    text += "    <button class=\"nav-search-btn btn-default\" onclick=\"xnote.action.note.searchNote(this)\">";
-    text += "        <i class=\"fa fa-search\"></i>";
-    text += "    </button>";
-    text += "</div>";
-    text += "<div class=\"row note-search-dialog-body\" style=\"padding-top: 10px;\">";
-    text += this.getSelectNoteItemListTemplate();
-    text += "</div>";
-    text += "</div>";
-    return text;
-};
-
-
-NoteView.renderNoteList = function(itemList) {
-    var templateText = this.getSelectNoteDialogTemplate();
-    var html = template.render(templateText, {
-        itemList: itemList
-    });
-    return html;
-};
-
-NoteView.openDialogToAddNote = function(event) {
-    var tagCode = $(event.target).attr("data-code");
-    xnote.http.get("/note/api/timeline?type=all&limit=100", function(resp) {
-        if (resp.code != "success") {
-            xnote.alert(resp.message);
-        } else {
-            var html = NoteView.renderNoteList(resp.data);
-            xnote.openDialog("选择笔记", html, ["确定", "取消"], function() {
-                NoteView.addNoteToTag(tagCode);
-            });
-        }
-    });
-};
-
-NoteView.addNoteToTag = function(tagCode) {
-    var selectedIds = [];
-    $(".select-note-checkbox:checked").each(function(idx, ele) {
-        var noteId = $(ele).attr("data-id");
-        selectedIds.push(noteId);
-    });
-    console.log(selectedIds);
-
-    var params = {
-        action: "add_note_to_tag",
-        tag_code: tagCode,
-        note_ids: selectedIds.join(",")
-    };
-    xnote.http.post("/note/tag/bind", params, function(resp) {
-        if (resp.code != "success") {
-            xnote.alert(resp.message);
-        } else {
-            xnote.toast("添加成功");
-            location.reload();
-        }
-    });
-};
-
-// 选择笔记本-平铺视图
-// 这个函数需要配合group_select_script.html使用
-NoteView.selectGroupFlat = function(req) {
-    var noteId = req.noteId;
-    var respData;
-
-    xnote.validate.isFunction(req.callback, "参数callback无效");
-
-    function bindEvent() {
-        $(".group-select-box").on("keyup", ".nav-search-input", function(event) {
-            /* Act on the event */
-            // console.log("event", event);
-            var searchKey = $(this).val().toLowerCase();
-
-            var newData = [];
-
-            for (var i = 0; i < respData.length; i++) {
-                var item = respData[i];
-                if (item.name.toLowerCase().indexOf(searchKey) >= 0) {
-                    newData.push(item);
-                }
-            }
-            renderData(newData);
-        });
-
-        $(".group-select-box").on("click", ".link", function(event) {
-            var dataId = $(event.target).attr("data-id");
-            req.callback(dataId);
-        });
-    }
-
-    function Section() {
-        this.children = [];
-        this.title = "title";
-    }
-
-    Section.prototype.add = function(item) {
-        this.children.push(item);
-    }
-
-    Section.prototype.isVisible = function() {
-        return this.children.length > 0;
-    }
-
-    // 渲染数据
-    function renderData(data) {
-        var first = new Section();
-        var second = new Section();
-        var last = new Section();
-        var firstGroup = new Section(); // 一级笔记本
-        for (var i = 0; i < data.length; i++) {
-            var item = data[i];
-            if (item.level >= 1) {
-                first.add(item);
-            } else if (item.level < 0) {
-                last.add(item);
-            } else if (item.parent_id == 0) {
-                firstGroup.add(item);
-            } else {
-                second.add(item);
-            }
-        }
-
-        first.title = "置顶";
-        firstGroup.title = "一级笔记本";
-        second.title = "其他笔记本";
-        last.title = "归档";
-
-        var groups = [first, firstGroup, second, last];
-        var hasNoMatch = (data.length === 0);
-
-        var html = $("#group_select_tpl").renderTemplate({
-            groups: groups,
-            noteId: noteId,
-            hasNoMatch: hasNoMatch
-        });
-        $(".group-select-data").html(html);
-    }
-
-    xnote.http.get("/note/api/group?list_type=all&orderby=name", function(resp) {
-        if (resp.code != "success") {
-            xnote.alert(resp.message);
-            return;
-        }
-
-        respData = resp.data;
-        xnote.showDialog("移动笔记", $(".group-select-box"));
-        // 绑定事件
-        bindEvent();
-        // 渲染数据
-        renderData(respData);
-    });
-};
-
-// 选择笔记本-树视图
-NoteView.selectGroupTree = function() {
-    // 树视图目前用的是html-ajax接口   
-}
-
-// 删除标签元信息
-NoteView.deleteTagMeta = function(tagMetaList) {
-    var html = $("#deleteTagTemplate").render({
-        tagList: tagMetaList,
-    });
-
-    xnote.openDialog("删除标签", html, ["确定删除", "取消"], function() {
-        var tagIds = [];
-        $(".tag.delete.active").each(function(idx, ele) {
-            var tagId = $(ele).attr("data-id");
-            tagIds.push(tagId);
-        });
-
-        var deleteParams = {
-            tag_type: "group",
-            tag_ids: JSON.stringify(tagIds),
-        };
-        xnote.http.post("/note/tag/delete", deleteParams, function(resp) {
-            if (resp.code != "success") {
-                xnote.alert(resp.message);
-            } else {
-                xnote.toast("删除成功,准备刷新...");
-                setTimeout(function() {
-                    window.location.reload()
-                }, 500);
-            }
-            refreshTagTop();
-        });
-    });
-};
-
-// 打开对话框移动笔记
-NoteView.openDialogToMove = function(note_id) {
-    var req = {};
-    req.callback = function(parentId) {
-        if (parentId === undefined || parentId == "") {
-            xnote.alert("parentId is undefined");
-            return;
-        }
-        xnote.http.post("/note/move", {
-            id: note_id,
-            parent_id: parentId
-        }, function(resp) {
-            console.log(resp);
-            window.location.reload();
-        });
-    };
-    this.selectGroupFlat(req);
-};
-
-// 打开对话框移动笔记
-NoteView.openDialogToMoveByElement = function(target) {
-    return this.openDialogToMove($(target).attr("data-id"));
-}
-
-
-// 点击标签操作
-NoteView.onTagClick = function(target) {
-    $(target).toggleClass("active");
-}
-
-// 打开对话框进行分享
-NoteView.openDialogToShare = function(target) {
-    var id = $(target).attr("data-id");
-    var type = $(target).attr("data-note-type");
-    var params = {
-        note_id: id
-    };
-    var ajax_dialog_url = "/note/ajax/share_group_dialog";
-    var ajax_dialog_title = "分享笔记本";
-
-    if (type != "group") {
-        ajax_dialog_url = "/note/ajax/share_note_dialog";
-        ajax_dialog_title = "分享笔记";
-    }
-
-    xnote.http.get(ajax_dialog_url, params, function(resp) {
-        xnote.showDialog(ajax_dialog_title, resp);
-    });
-}
-
-// 修改排序
-NoteView.changeOrderBy = function(target) {
-    var id = $(target).attr("data-id");
-    var orderby = $(target).val();
-
-    checkNotEmpty(id, "data-id为空");
-    checkNotEmpty(orderby, "data-orderby为空");
-
-    xnote.http.post("/note/orderby", {
-        id: id,
-        orderby: orderby
-    }, function(resp) {
-        var code = resp.code;
-        if (code != "success") {
-            xnote.alert(resp.message);
-        } else {
-            xnote.toast(resp.message);
-            window.location.reload();
-        }
-    })
-};
-
-// 修改笔记的等级（置顶之类的）
-NoteView.changeLevel = function(target) {
-    var id = $(target).attr("data-id");
-    var status = $(target).val();
-
-    checkNotEmpty(id, "data-id为空");
-    checkNotEmpty(status, "data-status为空");
-
-    xnote.http.post("/note/status", {
-        id: id,
-        status: status
-    }, function(resp) {
-        var code = resp.code;
-        if (code != "success") {
-            xnote.alert(resp.message);
-        } else {
-            xnote.toast(resp.message);
-            window.location.reload();
-        }
-    });
+/**
+ * 更新笔记的类目
+ * @deprecated 已废弃
+ * @param {object} req 更新请求
+ */
+xnote.updateNoteCategory = function(req) {
+    if (req === undefined) {
+        throw new Error("req is undefined");
+    }
+    if (req.noteId === undefined) {
+        throw new Error("req.noteId is undefined");
+    }
+    if (req.value === undefined) {
+        throw new Error("req.value is undefined");
+    }
+
+    var params = {
+        id: req.noteId,
+        key: "category",
+        value: req.value
+    };
+
+    xnote.http.post("/note/attribute/update", params, function(resp) {
+        console.log("update category", resp);
+        if (resp.code == "success") {
+            xnote.toast("更新类目成功");
+            if (req.doRefresh) {
+                window.location.reload();
+            }
+        } else {
+            xnote.alert(resp.message);
+        }
+    });
+};
+
+/**
+ * 更新类目的名称
+ * @param {object} req 请求对象
+ */
+xnote.updateCategoryName = function(req) {
+    if (req === undefined) {
+        throw new Error("req is undefined");
+    }
+    if (req.oldName === undefined) {
+        throw new Error("req.oldName is undefined");
+    }
+    if (req.code === undefined) {
+        throw new Error("req.code is undefined");
+    }
+
+    xnote.prompt("重命名类目", req.oldName, function(newName) {
+        var params = {
+            code: req.code,
+            name: newName
+        };
+
+        xnote.http.post("/api/note/category/update", params, function(resp) {
+            if (resp.code == "success") {
+                window.location.reload();
+            } else {
+                xnote.alert(resp.message);
+            }
+        });
+    });
+};
+
+// 创建笔记接口
+xnote.api["note.create"] = function(req) {
+    xnote.validate.notUndefined(req.name, "req.name is undefined");
+    xnote.validate.notUndefined(req.parentId, "req.parentId is undefined");
+    xnote.validate.notUndefined(req.type, "req.type is undefined");
+    xnote.validate.isFunction(req.callback, "req.callback is not function");
+
+    var createOption = {};
+    createOption.name = req.name;
+    createOption.parent_id = req.parentId;
+    createOption.type = req.type;
+    createOption._format = "json";
+
+    var title = req.name;
+
+    xnote.http.post("/note/create", createOption, function(resp) {
+        if (resp.code == "success") {
+            req.callback(resp);
+        } else {
+            xnote.alert(title + "失败:" + resp.message);
+        }
+    });
+};
+
+// 复制笔记接口
+xnote.api["note.copy"] = function(req) {
+    xnote.validate.notUndefined(req.name, "req.name is undefined");
+    xnote.validate.notUndefined(req.originId, "req.originId is undefined");
+    var copyOption = {
+        name: req.name,
+        origin_id: req.originId
+    };
+    var title = req.name;
+
+    xnote.http.post("/note/copy", copyOption, function(resp) {
+        if (resp.code == "success") {
+            req.callback(resp);
+        } else {
+            xnote.alert(title + "失败:" + resp.message);
+        }
+    });
+};
+
+var noteAPI = {};
+xnote.api.note = noteAPI;
+
+
+// 绑定标签
+noteAPI.bindTag = function(cmd) {
+    var currentTags = cmd.currentTags;
+    var tagList = cmd.tagList;
+    var allTagList = cmd.allTagList; // 全部的标签
+    var targetId = cmd.targetId;
+
+    if (cmd.tagType != "group" && cmd.tagType != "note") {
+        throw new TypeError("无效的tagType");
+    }
+
+    // 渲染绑定标签的html
+    var html = $("#bindTagTemplate").render({
+        tagList: tagList,
+        allTagList: allTagList,
+        selectedNames: currentTags,
+        manageLink: cmd.manageLink,
+        globalTagList: [{
+            tag_name: "待办",
+            tag_code: "$todo$"
+        }],
+    });
+
+    console.log("bind-tag-dialog", html);
+
+    xnote.openDialog("添加标签", html, ["确定", "取消"], function() {
+        var selectedNames = [];
+        $(".tag.bind.active").each(function(idx, ele) {
+            var tagName = $(ele).attr("data-code");
+            selectedNames.push(tagName);
+        });
+
+        var bindParams = {
+            tag_type: cmd.tagType,
+            group_id: cmd.groupId,
+            note_id: cmd.noteId,
+            tag_names: JSON.stringify(selectedNames),
+        };
+
+        xnote.http.post("/note/tag/bind", bindParams, function(resp) {
+            if (resp.code != "success") {
+                xnote.alert(resp.message);
+            } else {
+                xnote.toast("添加标签成功");
+            }
+            location.reload();
+        });
+    });
+};
+
+
+var NoteView = {};
+xnote.action.note = NoteView;
+xnote.note = NoteView;
+
+NoteView.onTagClick = function(target) {
+    $(target).toggleClass("active");
+}
+
+// 编辑笔记的标签
+NoteView.editNoteTag = function(target) {
+    var parentId = $(target).attr("data-parent-id");
+    var noteId = $(target).attr("data-id");
+    var tagsJson = $(target).attr("data-tags");
+    var tagType = $(target).attr("data-tag-type");
+    if (xnote.isEmpty(tagType)) {
+        tagType = "note";
+    }
+
+    var listParams = {
+        tag_type: tagType,
+        group_id: parentId,
+        v: 2,
+    };
+
+    xnote.http.get("/note/tag/list", listParams, function(resp) {
+        var cmd = {
+            tagType: "note", // 绑定类型始终是note
+            currentTags: JSON.parse(tagsJson),
+            noteId: noteId,
+            manageLink: "/note/manage?parent_id=" + parentId,
+        };
+        // 推荐的标签
+        cmd.tagList = resp.data.suggest_list;
+        // 全部的标签
+        cmd.allTagList = resp.data.all_list;
+        // 调用绑定标签组件
+        noteAPI.bindTag(cmd);
+    })
+};
+
+NoteView.searchNote = function() {
+    var self = this;
+    var searchText = $("#note-search-text").val();
+    var api = "";
+    if (searchText == "") {
+        api = "/note/api/timeline?type=all&limit=100";
+    } else {
+        api = "/note/api/timeline?type=search&key=" + searchText;
+    }
+    xnote.http.get(api, function(resp) {
+        if (resp.code != "success") {
+            xnote.toast(resp.message);
+        } else {
+            var templateText = self.getSelectNoteItemListTemplate();
+            var html = template.render(templateText, {
+                itemList: resp.data
+            });
+            $(".note-search-dialog-body").html(html);
+        }
+    });
+};
+
+NoteView.getSelectNoteItemListTemplate = function() {
+    var text = "";
+    text += "{{if itemList.length == 0 }}";
+    text += "    <p class=\"align-center\">空空如也~</p>";
+    text += "{{/if}}";
+    text += "{{each itemList item}}";
+    text += "<h3 class=\"card-title-2\">{{item.title}}</h3>";
+    text += "    {{each item.children subItem }}";
+    text += "    <p class=\"card-row share-dialog-row\">";
+    text += "        <i class=\"fa {{subItem.icon}}\"></i>";
+    text += "        <a href=\"{{subItem.url}}\">{{subItem.name}}</a>";
+    text += "        <input type=\"checkbox\"";
+    text += "            class=\"select-note-checkbox float-right\" ";
+    text += "            data-id=\"{{subItem.id}}\">";
+    text += "    <p>";
+    text += "    {{/each}}";
+    text += "{{/each}}";
+    return text;
+}
+
+NoteView.getSelectNoteDialogTemplate = function() {
+    var text = "";
+    text += "<div class=\"card\">";
+    text += "<div class=\"row\">";
+    text += "    <input type=\"text\" class=\"nav-search-input\" id=\"note-search-text\" placeholder=\"搜索笔记\" ";
+    text += "        value=\"{{searchText}}\" onkeyup=\"xnote.action.note.searchNote(this);\">";
+    text += "    <button class=\"nav-search-btn btn-default\" onclick=\"xnote.action.note.searchNote(this)\">";
+    text += "        <i class=\"fa fa-search\"></i>";
+    text += "    </button>";
+    text += "</div>";
+    text += "<div class=\"row note-search-dialog-body\" style=\"padding-top: 10px;\">";
+    text += this.getSelectNoteItemListTemplate();
+    text += "</div>";
+    text += "</div>";
+    return text;
+};
+
+
+NoteView.renderNoteList = function(itemList) {
+    var templateText = this.getSelectNoteDialogTemplate();
+    var html = template.render(templateText, {
+        itemList: itemList
+    });
+    return html;
+};
+
+NoteView.openDialogToAddNote = function(event) {
+    var tagCode = $(event.target).attr("data-code");
+    xnote.http.get("/note/api/timeline?type=all&limit=100", function(resp) {
+        if (resp.code != "success") {
+            xnote.alert(resp.message);
+        } else {
+            var html = NoteView.renderNoteList(resp.data);
+            xnote.openDialog("选择笔记", html, ["确定", "取消"], function() {
+                NoteView.addNoteToTag(tagCode);
+            });
+        }
+    });
+};
+
+NoteView.addNoteToTag = function(tagCode) {
+    var selectedIds = [];
+    $(".select-note-checkbox:checked").each(function(idx, ele) {
+        var noteId = $(ele).attr("data-id");
+        selectedIds.push(noteId);
+    });
+    console.log(selectedIds);
+
+    var params = {
+        action: "add_note_to_tag",
+        tag_code: tagCode,
+        note_ids: selectedIds.join(",")
+    };
+    xnote.http.post("/note/tag/bind", params, function(resp) {
+        if (resp.code != "success") {
+            xnote.alert(resp.message);
+        } else {
+            xnote.toast("添加成功");
+            location.reload();
+        }
+    });
+};
+
+// 选择笔记本-平铺视图
+// 这个函数需要配合group_select_script.html使用
+NoteView.selectGroupFlat = function(req) {
+    var noteId = req.noteId;
+    var respData;
+
+    xnote.validate.isFunction(req.callback, "参数callback无效");
+
+    function bindEvent() {
+        $(".group-select-box").on("keyup", ".nav-search-input", function(event) {
+            /* Act on the event */
+            // console.log("event", event);
+            var searchKey = $(this).val().toLowerCase();
+
+            var newData = [];
+
+            for (var i = 0; i < respData.length; i++) {
+                var item = respData[i];
+                if (item.name.toLowerCase().indexOf(searchKey) >= 0) {
+                    newData.push(item);
+                }
+            }
+            renderData(newData);
+        });
+
+        $(".group-select-box").on("click", ".link", function(event) {
+            var dataId = $(event.target).attr("data-id");
+            req.callback(dataId);
+        });
+    }
+
+    function Section() {
+        this.children = [];
+        this.title = "title";
+    }
+
+    Section.prototype.add = function(item) {
+        this.children.push(item);
+    }
+
+    Section.prototype.isVisible = function() {
+        return this.children.length > 0;
+    }
+
+    // 渲染数据
+    function renderData(data) {
+        var first = new Section();
+        var second = new Section();
+        var last = new Section();
+        var firstGroup = new Section(); // 一级笔记本
+        for (var i = 0; i < data.length; i++) {
+            var item = data[i];
+            if (item.level >= 1) {
+                first.add(item);
+            } else if (item.level < 0) {
+                last.add(item);
+            } else if (item.parent_id == 0) {
+                firstGroup.add(item);
+            } else {
+                second.add(item);
+            }
+        }
+
+        first.title = "置顶";
+        firstGroup.title = "一级笔记本";
+        second.title = "其他笔记本";
+        last.title = "归档";
+
+        var groups = [first, firstGroup, second, last];
+        var hasNoMatch = (data.length === 0);
+
+        var html = $("#group_select_tpl").renderTemplate({
+            groups: groups,
+            noteId: noteId,
+            hasNoMatch: hasNoMatch
+        });
+        $(".group-select-data").html(html);
+    }
+
+    xnote.http.get("/note/api/group?list_type=all&orderby=name", function(resp) {
+        if (resp.code != "success") {
+            xnote.alert(resp.message);
+            return;
+        }
+
+        respData = resp.data;
+        xnote.showDialog("移动笔记", $(".group-select-box"));
+        // 绑定事件
+        bindEvent();
+        // 渲染数据
+        renderData(respData);
+    });
+};
+
+// 选择笔记本-树视图
+NoteView.selectGroupTree = function() {
+    // 树视图目前用的是html-ajax接口   
+}
+
+// 删除标签元信息
+NoteView.deleteTagMeta = function(tagMetaList) {
+    var html = $("#deleteTagTemplate").render({
+        tagList: tagMetaList,
+    });
+
+    xnote.openDialog("删除标签", html, ["确定删除", "取消"], function() {
+        var tagIds = [];
+        $(".tag.delete.active").each(function(idx, ele) {
+            var tagId = $(ele).attr("data-id");
+            tagIds.push(tagId);
+        });
+
+        var deleteParams = {
+            tag_type: "group",
+            tag_ids: JSON.stringify(tagIds),
+        };
+        xnote.http.post("/note/tag/delete", deleteParams, function(resp) {
+            if (resp.code != "success") {
+                xnote.alert(resp.message);
+            } else {
+                xnote.toast("删除成功,准备刷新...");
+                setTimeout(function() {
+                    window.location.reload()
+                }, 500);
+            }
+            refreshTagTop();
+        });
+    });
+};
+
+// 打开对话框移动笔记
+NoteView.openDialogToMove = function(note_id) {
+    var req = {};
+    req.callback = function(parentId) {
+        if (parentId === undefined || parentId == "") {
+            xnote.alert("parentId is undefined");
+            return;
+        }
+        xnote.http.post("/note/move", {
+            id: note_id,
+            parent_id: parentId
+        }, function(resp) {
+            console.log(resp);
+            window.location.reload();
+        });
+    };
+    this.selectGroupFlat(req);
+};
+
+// 打开对话框移动笔记
+NoteView.openDialogToMoveByElement = function(target) {
+    return this.openDialogToMove($(target).attr("data-id"));
+}
+
+
+// 点击标签操作
+NoteView.onTagClick = function(target) {
+    $(target).toggleClass("active");
+}
+
+// 打开对话框进行分享
+NoteView.openDialogToShare = function(target) {
+    var id = $(target).attr("data-id");
+    var type = $(target).attr("data-note-type");
+    var params = {
+        note_id: id
+    };
+    var ajax_dialog_url = "/note/ajax/share_group_dialog";
+    var ajax_dialog_title = "分享笔记本";
+
+    if (type != "group") {
+        ajax_dialog_url = "/note/ajax/share_note_dialog";
+        ajax_dialog_title = "分享笔记";
+    }
+
+    xnote.http.get(ajax_dialog_url, params, function(resp) {
+        xnote.showDialog(ajax_dialog_title, resp);
+    });
+}
+
+// 修改排序
+NoteView.changeOrderBy = function(target) {
+    var id = $(target).attr("data-id");
+    var orderby = $(target).val();
+
+    checkNotEmpty(id, "data-id为空");
+    checkNotEmpty(orderby, "data-orderby为空");
+
+    xnote.http.post("/note/orderby", {
+        id: id,
+        orderby: orderby
+    }, function(resp) {
+        var code = resp.code;
+        if (code != "success") {
+            xnote.alert(resp.message);
+        } else {
+            xnote.toast(resp.message);
+            window.location.reload();
+        }
+    })
+};
+
+// 修改笔记的等级（置顶之类的）
+NoteView.changeLevel = function(target) {
+    var id = $(target).attr("data-id");
+    var status = $(target).val();
+
+    checkNotEmpty(id, "data-id为空");
+    checkNotEmpty(status, "data-status为空");
+
+    xnote.http.post("/note/status", {
+        id: id,
+        status: status
+    }, function(resp) {
+        var code = resp.code;
+        if (code != "success") {
+            xnote.alert(resp.message);
+        } else {
+            xnote.toast(resp.message);
+            window.location.reload();
+        }
+    });
 }
```

### Comparing `xnote-web-0.1.0/static/js/old/TagEditor.js` & `xnote-web-0.1.1/static/js/old/TagEditor.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/old/fileEditor.js` & `xnote-web-0.1.1/static/js/old/fileEditor.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/plan/plan.js` & `xnote-web-0.1.1/static/js/plan/plan.js`

 * *Files 27% similar despite different names*

#### js-beautify {}

```diff
@@ -1,88 +1,88 @@
-var PlanView = {};
-PlanView.state = {
-    month: "",
-    id: ""
-};
-xnote.action.plan = PlanView;
-
-PlanView.addNote = function(target) {
-    xnote.http.get("/note/api/timeline?type=all&limit=100", function(resp) {
-        if (resp.code != "success") {
-            xnote.alert(resp.message);
-        } else {
-            var html = PlanView.renderNoteList(resp.data);
-            var dialogEle = $("#select-note-dialog").html(html);
-            xnote.openDialog("选择笔记", dialogEle, ["加入计划", "取消"], function() {
-                PlanView.addSelectedToPlan();
-            });
-        }
-    });
-};
-
-
-PlanView.removeNote = function(target) {
-    window.event.preventDefault();
-    window.event.stopPropagation();
-
-    var noteId = $(target).attr("data-id");
-    var params = {
-        id: PlanView.state.id,
-        note_id: noteId
-    };
-
-    xnote.confirm("确认要移除吗?", function() {
-        xnote.http.post("/plan/month/remove", params, function(resp) {
-            if (resp.code == "success") {
-                xnote.toast("移除成功");
-                window.location.reload();
-            } else {
-                xnote.alert(resp.message);
-            }
-        });
-    });
-};
-
-
-PlanView.addSelectedToPlan = function() {
-    var selectedIds = [];
-    $(".select-note-checkbox:checked").each(function(idx, ele) {
-        var dataId = $(ele).attr("data-id");
-        selectedIds.push(dataId);
-    });
-    var params = {
-        id: PlanView.state.id,
-        note_ids: selectedIds.join(",")
-    }
-    xnote.http.post("/plan/month/add", params, function(resp) {
-        if (resp.code == "success") {
-            xnote.toast("加入成功");
-            window.location.reload();
-        } else {
-            xnote.alert(resp.message);
-        }
-    });
-};
-
-PlanView.renderNoteList = function(itemList) {
-    var html = $("#select_note_tpl").render({
-        itemList: itemList
-    });
-    $("#select-note-dialog-body").html(html);
-}
-
-PlanView.searchNote = function() {
-    var searchText = $("#plan-note-search-text").val();
-    var api = "";
-    if (searchText == "") {
-        api = "/note/api/timeline?type=all&limit=100";
-    } else {
-        api = "/note/api/timeline?type=search&key=" + searchText;
-    }
-    xnote.http.get(api, function(resp) {
-        if (resp.code != "success") {
-            xnote.toast(resp.message);
-        } else {
-            PlanView.renderNoteList(resp.data);
-        }
-    });
+var PlanView = {};
+PlanView.state = {
+    month: "",
+    id: ""
+};
+xnote.action.plan = PlanView;
+
+PlanView.addNote = function(target) {
+    xnote.http.get("/note/api/timeline?type=all&limit=100", function(resp) {
+        if (resp.code != "success") {
+            xnote.alert(resp.message);
+        } else {
+            var html = PlanView.renderNoteList(resp.data);
+            var dialogEle = $("#select-note-dialog").html(html);
+            xnote.openDialog("选择笔记", dialogEle, ["加入计划", "取消"], function() {
+                PlanView.addSelectedToPlan();
+            });
+        }
+    });
+};
+
+
+PlanView.removeNote = function(target) {
+    window.event.preventDefault();
+    window.event.stopPropagation();
+
+    var noteId = $(target).attr("data-id");
+    var params = {
+        id: PlanView.state.id,
+        note_id: noteId
+    };
+
+    xnote.confirm("确认要移除吗?", function() {
+        xnote.http.post("/plan/month/remove", params, function(resp) {
+            if (resp.code == "success") {
+                xnote.toast("移除成功");
+                window.location.reload();
+            } else {
+                xnote.alert(resp.message);
+            }
+        });
+    });
+};
+
+
+PlanView.addSelectedToPlan = function() {
+    var selectedIds = [];
+    $(".select-note-checkbox:checked").each(function(idx, ele) {
+        var dataId = $(ele).attr("data-id");
+        selectedIds.push(dataId);
+    });
+    var params = {
+        id: PlanView.state.id,
+        note_ids: selectedIds.join(",")
+    }
+    xnote.http.post("/plan/month/add", params, function(resp) {
+        if (resp.code == "success") {
+            xnote.toast("加入成功");
+            window.location.reload();
+        } else {
+            xnote.alert(resp.message);
+        }
+    });
+};
+
+PlanView.renderNoteList = function(itemList) {
+    var html = $("#select_note_tpl").render({
+        itemList: itemList
+    });
+    $("#select-note-dialog-body").html(html);
+}
+
+PlanView.searchNote = function() {
+    var searchText = $("#plan-note-search-text").val();
+    var api = "";
+    if (searchText == "") {
+        api = "/note/api/timeline?type=all&limit=100";
+    } else {
+        api = "/note/api/timeline?type=search&key=" + searchText;
+    }
+    xnote.http.get(api, function(resp) {
+        if (resp.code != "success") {
+            xnote.toast(resp.message);
+        } else {
+            PlanView.renderNoteList(resp.data);
+        }
+    });
 }
```

### Comparing `xnote-web-0.1.0/static/js/upload.js` & `xnote-web-0.1.1/static/js/upload.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/utils.build.js` & `xnote-web-0.1.1/static/js/utils.build.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/layer.photos.js` & `xnote-web-0.1.1/static/js/xnote-ui/layer.photos.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-audio.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-audio.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-device.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-device.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-dialog.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-dialog.js`

 * *Files 26% similar despite different names*

#### js-beautify {}

```diff
@@ -1,582 +1,656 @@
-/** 
- * 对话框实现
- * 参考 https://www.layui.com/doc/modules/layer.html
- * 
- * 对外接口:
- * 1. 展示对话框并且自适应设备
- *    xnote.showDialog(title, html, buttons = [], functions = [])
- *    xnote.openDialog(title, html, buttons = [], functions = [])
- *    xnote.showDialogEx(options)
- * 
- * 2. 展示iframe页面
- *    xnote.showIframeDialog(title, url)
- *    xnote.showAjaxDialog(title, url, buttons, functions)
- * 
- * 3. 展示选项的对话框
- *    // option参数的定义 {html, title = false}
- *    xnote.showOptionDialog(option)
- * 
- * 4. 系统自带的弹窗替换
- *    xnote.alert(message)
- *    xnote.confirm(message, callback)
- *    xnote.prompt(title, defaultValue, callback)
- *    // 打开文本编辑的对话框
- *    xnote.showTextDialog(title, text, buttons, functions)
- *    xnote.openTextDialog(title, text, buttons, functions)
- * 
- */
-
-
-if (window.xnote === undefined) {
-    throw new Error("xnote is undefined!");
-}
-
-xnote.getDialogArea = function() {
-    if (isMobile()) {
-        return ['100%', '100%'];
-    } else {
-        return ['600px', '80%'];
-    }
-}
-
-getDialogArea = xnote.getDialogArea;
-
-xnote.getDialogAreaLarge = function() {
-    if (xnote.isMobile()) {
-        return ['100%', '100%'];
-    } else {
-        return ['80%', '80%'];
-    }
-}
-
-xnote.getDialogAreaFullScreen = function() {
-    return ["100%", "100%"];
-}
-
-xnote.getNewDialogId = function() {
-    var dialogId = xnote.state._dialogId;
-    if (dialogId === undefined) {
-        dialogId = 1;
-    } else {
-        dialogId++;
-    }
-    xnote.state._dialogId = dialogId;
-    return "_xnoteDialog" + dialogId;
-}
-
-xnote.showIframeDialog = function(title, url, buttons, functions) {
-    var area = getDialogArea();
-    return layer.open({
-        type: 2,
-        shadeClose: false,
-        title: title,
-        maxmin: true,
-        area: area,
-        content: url,
-        scrollbar: false,
-        btn: buttons,
-        functions: functions
-    });
-}
-
-// 关闭对话框的入口方法
-xnote.closeDialog = function(flag) {
-    if (flag === "last") {
-        var lastId = xnote._dialogIdStack.pop();
-        layer.close(lastId);
-    }
-
-    if (typeof(flag) === 'number') {
-        layer.close(flag);
-        // TODO 移除_dialogIdStack中的元素
-    }
-}
-
-xnote.openDialogEx = function(options) {
-    var dialogId = xnote.openDialogExInner(options);
-    xnote._dialogIdStack.push(dialogId);
-    return dialogId;
-}
-
-xnote.showDialogEx = function() {
-    return xnote.openDialogEx.apply(this, arguments);
-}
-
-/**
- * 创建对话框
- * @param {object} options 创建选项
- * @param {string} options.title 标题
- * @param {string} options.html HTML内容
- * @param {list[string]} options.buttons 按钮文案
- * @param {list[function]} options.functions 回调函数(第一个是成功的回调函数)
- * @param {boolean} options.closeForYes 成功后是否关闭对话框(默认关闭)
- * @returns index
- */
-xnote.openDialogExInner = function(options) {
-    var area = options.area;
-    var title = options.title;
-    var html = options.html;
-    var buttons = options.buttons;
-    var functions = options.functions;
-    var anim = options.anim;
-    var closeBtn = options.closeBtn;
-    var onOpenFn = options.onOpenFn;
-    var shadeClose = xnote.getOrDefault(options.shadeClose, false);
-    var closeForYes = xnote.getOrDefault(options.closeForYes, true);
-    var template = options.template;
-    var defaultValues = options.defaultValues; // 模板的默认值
-    var yesFunction = function(index, layero, dialogInfo) {};
-    var successFunction = function(layero, index, that /*原型链的this对象*/ ) {};
-
-    // 详细文档 https://www.layui.com/doc/modules/layer.html
-    // @param {int} anim 动画的参数
-    // undefined: 默认动画
-    // 0：平滑放大。默认
-    // 1：从上掉落
-    // 2：从最底部往上滑入
-    // 3：从左滑入
-    // 4：从左翻滚
-    // 5：渐显
-    // 6：抖动出现
-
-    if (template !== undefined && html !== undefined) {
-        throw new Error("不能同时设置template和html选项");
-    }
-
-    var dialogId = "";
-
-    if (template !== undefined) {
-        var templateBody = $(template).html();
-        dialogId = xnote.getNewDialogId();
-
-        var ele = $("<div>").attr("id", dialogId).html(templateBody);
-        html = ele.prop("outerHTML");
-
-        if (defaultValues !== undefined) {
-            html = xnote.renderTemplate(html, defaultValues);
-        }
-    }
-
-    if (functions === undefined) {
-        functions = [];
-    }
-
-    if (!(functions instanceof Array)) {
-        functions = [functions];
-    }
-
-    if (functions.length > 0) {
-        yesFunction = functions[0];
-    }
-
-    if (area === undefined) {
-        area = xnote.getDialogArea();
-    }
-
-    if (area == "large") {
-        area = xnote.getDialogAreaLarge();
-    }
-
-    if (area == "fullscreen") {
-        area = xnote.getDialogAreaFullScreen();
-    }
-
-    var params = {
-        type: 1,
-        title: title,
-        shadeClose: shadeClose,
-        closeBtn: closeBtn,
-        area: area,
-        content: html,
-        anim: anim,
-        success: successFunction,
-        // scrollbar是弹层本身的滚动条，不是整个页面的
-        scrollbar: false
-    }
-
-    if (buttons !== undefined) {
-        params.btn = buttons
-        params.yes = function(index, layero) {
-            console.log(index, layero);
-            var dialogInfo = {
-                id: dialogId
-            };
-            var yesResult = yesFunction(index, layero, dialogInfo);
-            if (yesResult === undefined && closeForYes) {
-                layer.close(index);
-            }
-            return yesResult;
-        }
-    }
-
-    var index = layer.open(params);
-
-    // 打开对话框的回调
-    if (onOpenFn) {
-        onOpenFn(index);
-    }
-    return index
-}
-
-/**
- * 打开一个对话框
- * @param {string} title 标题
- * @param {string|DOM} html 文本或者Jquery-DOM对象 比如 $(".mybox")
- * @param {array} buttons 按钮列表
- * @param {array} functions 函数列表
- * @returns 弹层的索引
- */
-xnote.openDialog = function(title, html, buttons, functions) {
-    var options = {};
-    options.title = title;
-    options.html = html;
-    options.buttons = buttons;
-    options.functions = functions;
-    return xnote.showDialogEx(options);
-}
-
-xnote.showDialog = function() {
-    return xnote.openDialog.apply(this, arguments);
-}
-
-// 打开文本对话框
-xnote.openTextDialog = function(title, text, buttons, functions, features) {
-    var req = {};
-    req.title = title;
-    req.html = $("<textarea>").addClass("dialog-textarea").text(text).prop("outerHTML");
-    req.buttons = buttons;
-    req.functions = functions;
-    if (features != undefined) {
-        xnote._updateDialogFeatures(req, features);
-    }
-    return xnote.showDialogEx(req);
-}
-
-xnote._updateDialogFeatures = function(options, features) {
-    for (var i = 0; i < features.length; i++) {
-        var item = features[i];
-        if (item === "large") {
-            options.area = "large";
-        }
-    }
-}
-
-// 别名
-xnote.showTextDialog = xnote.openTextDialog;
-
-/**
- * 打开ajax对话框
- * @param {object} options 打开选项
- */
-xnote.openAjaxDialogEx = function(options) {
-    var respFilter = xnote.getOrDefault(options.respFilter, function(resp) {
-        return resp;
-    });
-
-    $.get(options.url, function(resp) {
-        options.html = respFilter(resp);
-        xnote.showDialogEx(options);
-        // 刷新各种组件的默认值
-        xnote.refresh();
-    }).fail(function(error) {
-        xnote.alert("调用接口失败，请重试");
-    });
-}
-
-/**
- * 打开ajax对话框
- * @param {string} title 对话框标题
- * @param {string} url 对话框URL
- * @param {list<string>} buttons 按钮名称
- * @param {list<function>} functions 按钮对应的函数
- */
-xnote.openAjaxDialog = function(title, url, buttons, functions) {
-    var options = {};
-    options.title = title;
-    options.buttons = buttons;
-    options.functions = functions;
-    options.url = url;
-
-    return xnote.openAjaxDialogEx(options);
-}
-
-// 函数别名
-xnote.showAjaxDialog = function() {
-    return xnote.openAjaxDialog.apply(this, arguments);
-}
-
-// 询问函数，原生prompt的替代方案
-xnote.prompt = function(title, defaultValue, callback) {
-    if (layer && layer.prompt) {
-        // 使用layer弹层
-        layer.prompt({
-                title: title,
-                value: defaultValue,
-                scrollbar: false,
-                area: ['400px', '300px']
-            },
-            function(value, index, element) {
-                callback(value);
-                layer.close(index);
-            })
-    } else {
-        // 使用系统默认的prompt
-        var result = prompt(title, defaultValue);
-        callback(result);
-    }
-};
-
-// 确认函数
-xnote.confirm = function(message, callback) {
-    if (layer && layer.confirm) {
-        layer.confirm(message,
-            function(index) {
-                callback(true);
-                layer.close(index);
-            });
-    } else {
-        var result = confirm(message);
-        callback(result);
-    }
-};
-
-// 警告函数
-xnote.alert = function(message) {
-    if (layer && layer.alert) {
-        layer.alert(message);
-    } else {
-        alert(message);
-    }
-};
-
-/**
- * 展示Toast信息
- * @param {string} message 展示信息
- * @param {number} time 显示时间
- * @param {function} callback 回调函数
- */
-xnote.toast = function(message, time, callback) {
-    if (layer && layer.msg) {
-        layer.msg(message, {
-            time: time
-        });
-    } else {
-        myToast(message, time);
-    }
-
-    if (callback) {
-        if (time === undefined) {
-            time = 1000;
-        }
-        setTimeout(callback, time);
-    }
-}
-
-var myToast = function(message, timeout) {
-    if (timeout == undefined) {
-        timeout = 1000;
-    }
-    var maxWidth = $(document.body).width();
-    var maxHeight = $(document.body).height()
-    var fontSize = 14;
-    var toast = $("<div>").css({
-        "margin": "0 auto",
-        "position": "fixed",
-        "left": 0,
-        "top": "24px",
-        "font-size": fontSize,
-        "padding": "14px 18px",
-        "border-radius": "4px",
-        "background": "#000",
-        "opacity": 0.7,
-        "color": "#fff",
-        "line-height": "22px",
-        "z-index": 1000
-    });
-    toast.text(message);
-
-    $(document.body).append(toast);
-
-    // 宽度
-    var width = toast.outerWidth();
-    var left = (maxWidth - width) / 2;
-    if (left < 0) {
-        left = 0;
-    }
-    toast.css("left", left);
-
-    // 高度
-    var height = toast.outerHeight();
-    var top = (maxHeight - height) / 2;
-    if (top < 0) {
-        top = 0;
-    }
-    toast.css("top", top);
-
-    setTimeout(function() {
-        toast.remove();
-    }, timeout);
-}
-
-// 兼容之前的方法
-window.showToast = window.xnote.toast;
-
-/**
- * 展示选项对话框
- */
-xnote.showOptionDialog = function(option) {
-    var content = option.html;
-    if (option.title === undefined) {
-        option.title = false;
-    }
-
-    var oldStyle = $("body").css("overflow");
-    $("body").css("overflow", "hidden");
-
-    function recoveryStyle() {
-        $("body").css("overflow", oldStyle);
-    }
-
-    var dialogIndex = layer.open({
-        title: option.title,
-        closeBtn: false,
-        shadeClose: true,
-        btn: [],
-        content: content,
-        skin: "x-option-dialog",
-        yes: function(index, layero) {
-            layer.close(index);
-            // 恢复样式
-            recoveryStyle();
-        },
-        cancel: function() {
-            layer.close(index);
-            // 恢复样式
-            recoveryStyle();
-        }
-    });
-
-    // 原组件点遮罩关闭没有回调事件，要重新一下
-    $('#layui-layer-shade' + dialogIndex).on('click', function() {
-        console.log("xnote.showOptionDialog: shadowClose event")
-        layer.close(dialogIndex);
-        recoveryStyle();
-    });
-};
-
-// 老版本的对话框，先保留在这里
-window.ContentDialog = {
-    open: function(title, content, size) {
-        var width = $(".root").width() - 40;
-        var area;
-
-        if (isMobile()) {
-            area = ['100%', '100%'];
-        } else {
-            if (size == "small") {
-                area = ['400px', '300px'];
-            } else {
-                area = [width + 'px', '80%'];
-            }
-        }
-
-        layer.open({
-            type: 1,
-            shadeClose: true,
-            title: title,
-            area: area,
-            content: content,
-            scrollbar: false
-        });
-    }
-}
-
-xnote.closeAllDialog = function() {
-    layer.closeAll();
-}
-
-
-// 自定义的dialog
-$(function() {
-
-    // 点击激活对话框的按钮
-    $("body").on("click", ".dialog-btn", function() {
-        var dialogUrl = $(this).attr("dialog-url");
-        var dialogId = $(this).attr("dialog-id");
-        var dailogTitle = $(this).attr("dialog-title");
-        var optionSelector = $(this).attr("dialog-option-selector");
-        if (dialogUrl) {
-            // 通过新的HTML页面获取dialog
-            $.get(dialogUrl, function(respHtml) {
-
-                // 展示对话框
-                xnote.showDialog(dailogTitle, respHtml);
-
-                // 重新绑定事件
-                xnote.fire("init-default-value");
-            })
-        } else if (optionSelector) {
-            var html = $(optionSelector).html();
-            var option = {};
-            option.html = html;
-            xnote.showOptionDialog(option);
-        } else {
-            xnote.alert("请定义[dialog-url]或者[dialog-option-selector]属性");
-        }
-    });
-
-
-    /**
-     * 初始化弹层
-     */
-    function initDialog() {
-        // 初始化样式
-        $(".x-dialog-close").css({
-            "background-color": "red",
-            "float": "right"
-        });
-
-        $(".x-dialog").each(function(index, ele) {
-            var self = $(ele);
-            var width = window.innerWidth;
-            if (width < 600) {
-                dialogWidth = width - 40;
-            } else {
-                dialogWidth = 600;
-            }
-            var top = Math.max((getWindowHeight() - self.height()) / 2, 0);
-            var left = (width - dialogWidth) / 2;
-            self.css({
-                "width": dialogWidth,
-                "left": left
-            }).css("top", top);
-        });
-
-        $("body").css("overflow", "hidden");
-    }
-
-    /** 隐藏弹层 **/
-    function onDialogHide() {
-        $(".x-dialog").hide();
-        $(".x-dialog-background").hide();
-        $(".x-dialog-remote").remove(); // 清空远程的dialog
-        $("body").css("overflow", "auto");
-    }
-
-    $(".x-dialog-background").click(function() {
-        onDialogHide();
-    });
-
-    $(".x-dialog-close, .x-dialog-cancel").click(function() {
-        onDialogHide();
-    });
-
-    function doModal(id) {
-        initDialog();
-        $(".x-dialog-background").show();
-        $(".x-dialog-remote").show();
-        $("#" + id).show();
-    }
-
-    xnote.initDialog = initDialog;
-});
+/** 
+ * 对话框实现
+ * 参考 https://www.layui.com/doc/modules/layer.html
+ * 
+ * 对外接口:
+ * 1. 展示对话框并且自适应设备
+ *    xnote.showDialog(title, html, buttons = [], functions = [])
+ *    xnote.openDialog(title, html, buttons = [], functions = [])
+ *    xnote.showDialogEx(options)
+ * 
+ * 2. 展示iframe页面
+ *    xnote.showIframeDialog(title, url)
+ *    xnote.showAjaxDialog(title, url, buttons, functions)
+ * 
+ * 3. 展示选项的对话框
+ *    // option参数的定义 {html, title = false}
+ *    xnote.showOptionDialog(option)
+ * 
+ * 4. 系统自带的弹窗替换
+ *    xnote.alert(message)
+ *    xnote.confirm(message, callback)
+ *    xnote.prompt(title, defaultValue, callback)
+ *    // 打开文本编辑的对话框
+ *    xnote.showTextDialog(title, text, buttons, functions)
+ *    xnote.openTextDialog(title, text, buttons, functions)
+ * 
+ */
+
+
+if (window.xnote === undefined) {
+    throw new Error("xnote is undefined!");
+}
+
+var xnoteDialogModule = {}
+xnote.dialog = xnoteDialogModule;
+
+xnoteDialogModule.idToIndexMap = {};
+xnoteDialogModule.layerIndexStack = [];
+
+xnoteDialogModule.handleOptions = function(options) {
+    if (options.dialogId === undefined) {
+        options.dialogId = this.createNewId();
+    }
+    return options;
+}
+
+xnote.getDialogArea = function() {
+    if (isMobile()) {
+        return ['100%', '100%'];
+    } else {
+        return ['600px', '80%'];
+    }
+}
+
+getDialogArea = xnote.getDialogArea;
+
+xnote.getDialogAreaLarge = function() {
+    if (xnote.isMobile()) {
+        return ['100%', '100%'];
+    } else {
+        return ['80%', '80%'];
+    }
+}
+
+xnote.getDialogAreaFullScreen = function() {
+    return ["100%", "100%"];
+}
+
+xnote.getNewDialogId = function() {
+    var dialogId = xnote.state._dialogId;
+    if (dialogId === undefined) {
+        dialogId = 1;
+    } else {
+        dialogId++;
+    }
+    xnote.state._dialogId = dialogId;
+    return "_xnoteDialog" + dialogId;
+}
+
+xnoteDialogModule.showIframeDialog = function(title, url, buttons, functions) {
+    var area = getDialogArea();
+    return layer.open({
+        type: 2,
+        shadeClose: false,
+        title: title,
+        maxmin: true,
+        area: area,
+        content: url,
+        scrollbar: false,
+        btn: buttons,
+        functions: functions
+    });
+}
+
+// 关闭对话框的入口方法
+xnoteDialogModule.closeDialog = function(flag) {
+    if (flag === "last") {
+        var lastId = xnoteDialogModule.layerIndexStack.pop();
+        layer.close(lastId);
+    }
+
+    if (typeof(flag) === 'number') {
+        layer.close(flag);
+        // TODO 移除_dialogIdStack中的元素
+    }
+}
+
+// 打开对话框
+xnoteDialogModule.openDialogEx = function(options) {
+    var layerIndex = xnoteDialogModule.openDialogExInner(options);
+    xnoteDialogModule.layerIndexStack.push(layerIndex);
+    return layerIndex;
+}
+
+xnote.showDialogEx = function() {
+    return xnoteDialogModule.openDialogEx.apply(xnoteDialogModule, arguments);
+}
+
+/**
+ * 创建对话框
+ * @param {object} options 创建选项
+ * @param {string} options.title 标题
+ * @param {string} options.html HTML内容
+ * @param {list[string]} options.buttons 按钮文案
+ * @param {list[function]} options.functions 回调函数(第一个是成功的回调函数)
+ * @param {boolean} options.closeForYes 成功后是否关闭对话框(默认关闭)
+ * @returns index
+ */
+xnoteDialogModule.openDialogExInner = function(options) {
+    options = xnoteDialogModule.handleOptions(options);
+
+    var area = options.area;
+    var title = options.title;
+    var html = options.html;
+    var buttons = options.buttons;
+    var functions = options.functions;
+    var anim = options.anim;
+    var closeBtn = options.closeBtn;
+    var onOpenFn = options.onOpenFn;
+    var shadeClose = xnote.getOrDefault(options.shadeClose, false);
+    var closeForYes = xnote.getOrDefault(options.closeForYes, true);
+    var template = options.template;
+    var defaultValues = options.defaultValues; // 模板的默认值
+    var yesFunction = function(index, layero, dialogInfo) {};
+    var successFunction = function(layero, index, that /*原型链的this对象*/ ) {};
+    var dialogId = options.dialogId;
+
+    // 详细文档 https://www.layui.com/doc/modules/layer.html
+    // @param {int} anim 动画的参数
+    // undefined: 默认动画
+    // 0：平滑放大。默认
+    // 1：从上掉落
+    // 2：从最底部往上滑入
+    // 3：从左滑入
+    // 4：从左翻滚
+    // 5：渐显
+    // 6：抖动出现
+
+    if (template !== undefined && html !== undefined) {
+        throw new Error("不能同时设置template和html选项");
+    }
+
+    if (template !== undefined) {
+        var templateBody = $(template).html();
+        dialogId = xnote.getNewDialogId();
+
+        var ele = $("<div>").attr("id", dialogId).html(templateBody);
+        html = ele.prop("outerHTML");
+
+        if (defaultValues !== undefined) {
+            html = xnote.renderTemplate(html, defaultValues);
+        }
+    }
+
+    if (functions === undefined) {
+        functions = [];
+    }
+
+    if (!(functions instanceof Array)) {
+        functions = [functions];
+    }
+
+    if (functions.length > 0) {
+        yesFunction = functions[0];
+    }
+
+    if (area === undefined) {
+        area = xnote.getDialogArea();
+    }
+
+    if (area == "large") {
+        area = xnote.getDialogAreaLarge();
+    }
+
+    if (area == "fullscreen") {
+        area = xnote.getDialogAreaFullScreen();
+    }
+
+    var params = {
+        type: 1,
+        title: title,
+        shadeClose: shadeClose,
+        closeBtn: closeBtn,
+        area: area,
+        content: html,
+        anim: anim,
+        success: successFunction,
+        // scrollbar是弹层本身的滚动条，不是整个页面的
+        scrollbar: false
+    }
+
+    if (buttons !== undefined) {
+        params.btn = buttons
+        params.yes = function(index, layero) {
+            console.log(index, layero);
+            var dialogInfo = {
+                id: dialogId
+            };
+            var yesResult = yesFunction(index, layero, dialogInfo);
+            if (yesResult === undefined && closeForYes) {
+                layer.close(index);
+            }
+            return yesResult;
+        }
+    }
+
+    var index = layer.open(params);
+
+    // id映射
+    xnoteDialogModule.idToIndexMap[dialogId] = index;
+
+    // 打开对话框的回调
+    if (onOpenFn) {
+        onOpenFn(index);
+    }
+    return index
+}
+
+/**
+ * 打开一个对话框
+ * @param {string} title 标题
+ * @param {string|DOM} html 文本或者Jquery-DOM对象 比如 $(".mybox")
+ * @param {array} buttons 按钮列表
+ * @param {array} functions 函数列表
+ * @returns 弹层的索引
+ */
+xnoteDialogModule.openDialog = function(title, html, buttons, functions) {
+    var options = {};
+    options.title = title;
+    options.html = html;
+    options.buttons = buttons;
+    options.functions = functions;
+    return xnoteDialogModule.openDialogEx(options);
+}
+
+xnoteDialogModule.showDialog = function() {
+    return xnoteDialogModule.openDialog.apply(xnoteDialogModule, arguments);
+}
+
+// 打开文本对话框
+xnoteDialogModule.openTextDialog = function(title, text, buttons, functions, features) {
+    var req = {};
+    var dialogId = xnoteDialogModule.createNewId();
+
+    req.title = title;
+    req.dialogId = dialogId;
+    /*
+    <div class="card dialog-body">
+        <textarea class="dialog-textarea"></textarea>
+    </div>
+
+    <div class="dialog-footer">
+        <div class="float-right">
+            <button class="large btn-default" data-dialog-id="{{!dialogId}}" onclick="xnote.dialog.closeByElement(this)">关闭</button>
+        </div>
+    </div>
+     */
+    var div = $("<div>");
+    var textarea = $("<textarea>").addClass("dialog-textarea").text(text);
+    var dialogBody = $("<div>").addClass("card dialog-body").append(textarea);
+    var btnBox = $("<div>").addClass("float-right");
+    var closeBtn = $("<button>").attr("data-dialog-id", dialogId).addClass("large btn-default").attr("onclick", "xnote.dialog.closeByElement(this)").text("关闭");
+    var dialogFooter = $("<div>").addClass("dialog-footer").append(btnBox.append(closeBtn));
+
+    if (buttons === undefined) {
+        div.append(dialogBody);
+        div.append(dialogFooter);
+    } else {
+        div.append(textarea);
+    }
+
+    req.html = div.html();
+    req.buttons = buttons;
+    req.functions = functions;
+    if (features != undefined) {
+        xnote._updateDialogFeatures(req, features);
+    }
+    return xnote.showDialogEx(req);
+}
+
+xnote._updateDialogFeatures = function(options, features) {
+    for (var i = 0; i < features.length; i++) {
+        var item = features[i];
+        if (item === "large") {
+            options.area = "large";
+        }
+    }
+}
+
+/**
+ * 打开ajax对话框
+ * @param {object} options 打开选项
+ */
+xnoteDialogModule.openAjaxDialogEx = function(options) {
+    var respFilter = xnote.getOrDefault(options.respFilter, function(resp) {
+        return resp;
+    });
+
+    xnote.http.get(options.url, function(resp) {
+        options.html = respFilter(resp);
+        xnote.showDialogEx(options);
+        // 刷新各种组件的默认值
+        xnote.refresh();
+    });
+}
+
+/**
+ * 打开ajax对话框
+ * @param {string} title 对话框标题
+ * @param {string} url 对话框URL
+ * @param {list<string>} buttons 按钮名称
+ * @param {list<function>} functions 按钮对应的函数
+ */
+xnoteDialogModule.openAjaxDialog = function(title, url, buttons, functions) {
+    var options = {};
+    options.title = title;
+    options.buttons = buttons;
+    options.functions = functions;
+    options.url = url;
+
+    return xnoteDialogModule.openAjaxDialogEx(options);
+}
+
+// 函数别名
+xnoteDialogModule.showAjaxDialog = function() {
+    return xnoteDialogModule.openAjaxDialog.apply(xnoteDialogModule, arguments);
+}
+
+// 询问函数，原生prompt的替代方案
+xnote.prompt = function(title, defaultValue, callback) {
+    if (layer && layer.prompt) {
+        // 使用layer弹层
+        layer.prompt({
+                title: title,
+                value: defaultValue,
+                scrollbar: false,
+                area: ['400px', '300px']
+            },
+            function(value, index, element) {
+                callback(value);
+                layer.close(index);
+            })
+    } else {
+        // 使用系统默认的prompt
+        var result = prompt(title, defaultValue);
+        callback(result);
+    }
+};
+
+// 确认函数
+xnote.confirm = function(message, callback) {
+    if (layer && layer.confirm) {
+        layer.confirm(message,
+            function(index) {
+                callback(true);
+                layer.close(index);
+            });
+    } else {
+        var result = confirm(message);
+        callback(result);
+    }
+};
+
+// 警告函数
+xnote.alert = function(message) {
+    if (layer && layer.alert) {
+        layer.alert(message);
+    } else {
+        alert(message);
+    }
+};
+
+/**
+ * 展示Toast信息
+ * @param {string} message 展示信息
+ * @param {number} time 显示时间
+ * @param {function} callback 回调函数
+ */
+xnote.toast = function(message, time, callback) {
+    if (layer && layer.msg) {
+        layer.msg(message, {
+            time: time
+        });
+    } else {
+        myToast(message, time);
+    }
+
+    if (callback) {
+        if (time === undefined) {
+            time = 1000;
+        }
+        setTimeout(callback, time);
+    }
+}
+
+var myToast = function(message, timeout) {
+    if (timeout == undefined) {
+        timeout = 1000;
+    }
+    var maxWidth = $(document.body).width();
+    var maxHeight = $(document.body).height()
+    var fontSize = 14;
+    var toast = $("<div>").css({
+        "margin": "0 auto",
+        "position": "fixed",
+        "left": 0,
+        "top": "24px",
+        "font-size": fontSize,
+        "padding": "14px 18px",
+        "border-radius": "4px",
+        "background": "#000",
+        "opacity": 0.7,
+        "color": "#fff",
+        "line-height": "22px",
+        "z-index": 1000
+    });
+    toast.text(message);
+
+    $(document.body).append(toast);
+
+    // 宽度
+    var width = toast.outerWidth();
+    var left = (maxWidth - width) / 2;
+    if (left < 0) {
+        left = 0;
+    }
+    toast.css("left", left);
+
+    // 高度
+    var height = toast.outerHeight();
+    var top = (maxHeight - height) / 2;
+    if (top < 0) {
+        top = 0;
+    }
+    toast.css("top", top);
+
+    setTimeout(function() {
+        toast.remove();
+    }, timeout);
+}
+
+// 兼容之前的方法
+window.showToast = window.xnote.toast;
+
+/**
+ * 展示选项对话框
+ */
+xnoteDialogModule.showOptionDialog = function(option) {
+    var content = option.html;
+    if (option.title === undefined) {
+        option.title = false;
+    }
+
+    var oldStyle = $("body").css("overflow");
+    $("body").css("overflow", "hidden");
+
+    function recoveryStyle() {
+        $("body").css("overflow", oldStyle);
+    }
+
+    var dialogIndex = layer.open({
+        title: option.title,
+        closeBtn: false,
+        shadeClose: true,
+        btn: [],
+        content: content,
+        skin: "x-option-dialog",
+        yes: function(index, layero) {
+            layer.close(index);
+            // 恢复样式
+            recoveryStyle();
+        },
+        cancel: function() {
+            layer.close(index);
+            // 恢复样式
+            recoveryStyle();
+        }
+    });
+
+    // 原组件点遮罩关闭没有回调事件，要重新一下
+    $('#layui-layer-shade' + dialogIndex).on('click', function() {
+        console.log("xnote.showOptionDialog: shadowClose event")
+        layer.close(dialogIndex);
+        recoveryStyle();
+    });
+};
+
+// 老版本的对话框，先保留在这里
+window.ContentDialog = {
+    open: function(title, content, size) {
+        var width = $(".root").width() - 40;
+        var area;
+
+        if (isMobile()) {
+            area = ['100%', '100%'];
+        } else {
+            if (size == "small") {
+                area = ['400px', '300px'];
+            } else {
+                area = [width + 'px', '80%'];
+            }
+        }
+
+        layer.open({
+            type: 1,
+            shadeClose: true,
+            title: title,
+            area: area,
+            content: content,
+            scrollbar: false
+        });
+    }
+}
+
+xnote.closeAllDialog = function() {
+    layer.closeAll();
+}
+
+
+// 自定义的dialog
+$(function() {
+
+    // 点击激活对话框的按钮
+    $("body").on("click", ".dialog-btn", function() {
+        var dialogUrl = $(this).attr("dialog-url");
+        var dialogId = $(this).attr("dialog-id");
+        var dailogTitle = $(this).attr("dialog-title");
+        var optionSelector = $(this).attr("dialog-option-selector");
+        if (dialogUrl) {
+            // 通过新的HTML页面获取dialog
+            $.get(dialogUrl, function(respHtml) {
+
+                // 展示对话框
+                xnote.showDialog(dailogTitle, respHtml);
+
+                // 重新绑定事件
+                xnote.fire("init-default-value");
+            })
+        } else if (optionSelector) {
+            var html = $(optionSelector).html();
+            var option = {};
+            option.html = html;
+            xnote.showOptionDialog(option);
+        } else {
+            xnote.alert("请定义[dialog-url]或者[dialog-option-selector]属性");
+        }
+    });
+
+
+    /**
+     * 初始化弹层
+     */
+    function initDialog() {
+        // 初始化样式
+        $(".x-dialog-close").css({
+            "background-color": "red",
+            "float": "right"
+        });
+
+        $(".x-dialog").each(function(index, ele) {
+            var self = $(ele);
+            var width = window.innerWidth;
+            if (width < 600) {
+                dialogWidth = width - 40;
+            } else {
+                dialogWidth = 600;
+            }
+            var top = Math.max((getWindowHeight() - self.height()) / 2, 0);
+            var left = (width - dialogWidth) / 2;
+            self.css({
+                "width": dialogWidth,
+                "left": left
+            }).css("top", top);
+        });
+
+        $("body").css("overflow", "hidden");
+    }
+
+    /** 隐藏弹层 **/
+    function onDialogHide() {
+        $(".x-dialog").hide();
+        $(".x-dialog-background").hide();
+        $(".x-dialog-remote").remove(); // 清空远程的dialog
+        $("body").css("overflow", "auto");
+    }
+
+    $(".x-dialog-background").click(function() {
+        onDialogHide();
+    });
+
+    $(".x-dialog-close, .x-dialog-cancel").click(function() {
+        onDialogHide();
+    });
+
+    function doModal(id) {
+        initDialog();
+        $(".x-dialog-background").show();
+        $(".x-dialog-remote").show();
+        $("#" + id).show();
+    }
+
+    xnote.initDialog = initDialog;
+});
+
+// 通过html元素来关闭对话框
+xnoteDialogModule.closeByElement = function(target) {
+    var dialogId = $(target).attr("data-dialog-id");
+    var index = xnoteDialogModule.idToIndexMap[dialogId];
+    layer.close(index);
+}
+
+xnoteDialogModule.closeLast = function() {
+    xnoteDialogModule.closeDialog("last");
+}
+
+xnoteDialogModule.createNewId = function() {
+    return "dialog_" + xnote.createNewId();
+}
+
+// 别名
+xnote.openAjaxDialog = xnoteDialogModule.openAjaxDialog;
+xnote.openAjaxDialogEx = xnoteDialogModule.openAjaxDialogEx;
+xnote.showAjaxDialog = xnoteDialogModule.showAjaxDialog;
+
+xnote.showDialog = xnoteDialogModule.showDialog;
+xnote.showDialogEx = xnoteDialogModule.openDialogEx;
+xnote.openDialogEx = xnoteDialogModule.openDialogEx;
+xnote.openDialogExInner = xnoteDialogModule.openDialogExInner;
+xnote.openDialog = xnoteDialogModule.openDialog;
+xnote.closeDialog = xnoteDialogModule.closeDialog;
+
+xnote.showIframeDialog = xnoteDialogModule.showIframeDialog;
+
+xnote.showTextDialog = xnoteDialogModule.openTextDialog;
+xnote.openTextDialog = xnoteDialogModule.openTextDialog;
+xnote.showOptionDialog = xnoteDialogModule.showOptionDialog;
```

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-dropdown.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-dropdown.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-event.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-event.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-init.js` & `xnote-web-0.1.1/handlers/note/component/script/note_option_script.html`

 * *Files 27% similar despite different names*

```diff
@@ -1,530 +1,452 @@
-00000000: 2f2a 2a0d 0a20 2a20 786e 6f74 65e5 85a8  /**.. * xnote...
-00000010: e5b1 80e5 889d e5a7 8be5 8c96 0d0a 202a  .............. *
-00000020: 2040 6175 7468 6f72 2078 7570 696e 676d   @author xupingm
-00000030: 616f 0d0a 202a 2040 7369 6e63 6520 3230  ao.. * @since 20
-00000040: 3232 2f30 312f 3039 2031 363a 3137 3a30  22/01/09 16:17:0
-00000050: 320d 0a20 2a20 406d 6f64 6966 6965 6420  2.. * @modified 
-00000060: 3230 3232 2f30 342f 3039 2031 383a 3135  2022/04/09 18:15
-00000070: 3a30 370d 0a20 2a20 4066 696c 656e 616d  :07.. * @filenam
-00000080: 6520 782d 696e 6974 2e6a 730d 0a20 2a2f  e x-init.js.. */
-00000090: 0d0a 0d0a 2f2a 2a20 e588 9de5 a78b e58c  ..../** ........
-000000a0: 9678 6e6f 7465 e585 a8e5 b180 e5af b9e8  .xnote..........
-000000b0: b1a1 202a 2a2f 0d0a 6966 2028 7769 6e64  .. **/..if (wind
-000000c0: 6f77 2e78 6e6f 7465 203d 3d3d 2075 6e64  ow.xnote === und
-000000d0: 6566 696e 6564 2920 7b0d 0a20 2020 202f  efined) {..    /
-000000e0: 2f20 e585 a8e5 b180 e5af b9e8 b1a1 0d0a  / ..............
-000000f0: 2020 2020 7661 7220 786e 6f74 6520 3d20      var xnote = 
-00000100: 7b7d 3b0d 0a0d 0a20 2020 202f 2f20 e8ae  {};....    // ..
-00000110: bee5 a487 e4bf a1e6 81af 0d0a 2020 2020  ............    
-00000120: 786e 6f74 652e 6465 7669 6365 203d 207b  xnote.device = {
-00000130: 0d0a 2020 2020 2020 2020 636f 6e74 656e  ..        conten
-00000140: 7457 6964 7468 3a20 302c 2020 2020 202f  tWidth: 0,     /
-00000150: 2f20 e586 85e5 aeb9 e79a 84e5 aebd e5ba  / ..............
-00000160: a6ef bc8c e58c 85e6 8bac e5b7 a6e4 bea7  ................
-00000170: e4b8 bbe6 95b0 e68d aee5 928c e4be a7e8  ................
-00000180: beb9 e6a0 8f0d 0a20 2020 2020 2020 2063  .......        c
-00000190: 6f6e 7465 6e74 4c65 6674 5769 6474 683a  ontentLeftWidth:
-000001a0: 2030 2c20 2f2f 20e5 b7a6 e4be a7e7 9a84   0, // .........
-000001b0: e5ae bde5 baa6 0d0a 2020 2020 2020 2020  ........        
-000001c0: 6973 4d6f 6269 6c65 3a20 6661 6c73 652c  isMobile: false,
-000001d0: 202f 2f20 e698 afe5 90a6 e698 afe7 a7bb   // ............
-000001e0: e58a a8e7 abaf 0d0a 2020 2020 2020 2020  ........        
-000001f0: 6973 4465 736b 746f 703a 2074 7275 652c  isDesktop: true,
-00000200: 202f 2f20 e9bb 98e8 aea4 e698 afe6 a18c   // ............
-00000210: e99d a2e7 abaf 0d0a 2020 2020 2020 2020  ........        
-00000220: 6c65 6674 4e61 7657 6964 7468 3a20 302c  leftNavWidth: 0,
-00000230: 202f 2f20 e5b7 a6e4 bea7 e5af bce8 88aa   // ............
-00000240: e5ae bde5 baa6 0d0a 2020 2020 2020 2020  ........        
-00000250: 656e 643a 2030 0d0a 2020 2020 7d3b 0d0a  end: 0..    };..
-00000260: 0d0a 2020 2020 2f2f 20e9 858d e7bd aee4  ..    // .......
-00000270: bfa1 e681 af0d 0a20 2020 2078 6e6f 7465  .......    xnote
-00000280: 2e63 6f6e 6669 6720 3d20 7b7d 3b0d 0a20  .config = {};.. 
-00000290: 2020 2078 6e6f 7465 2e63 6f6e 6669 672e     xnote.config.
-000002a0: 7365 7276 6572 486f 6d65 203d 2022 223b  serverHome = "";
-000002b0: 0d0a 2020 2020 0d0a 2020 2020 2f2f 20e5  ..    ..    // .
-000002c0: 8685 e983 a8e5 b19e e680 a70d 0a20 2020  .............   
-000002d0: 2078 6e6f 7465 2e5f 6469 616c 6f67 4964   xnote._dialogId
-000002e0: 5374 6163 6b20 3d20 5b5d 3b0d 0a0d 0a20  Stack = [];.... 
-000002f0: 2020 202f 2f20 e5b8 b8e9 878f 0d0a 2020     // ........  
-00000300: 2020 786e 6f74 652e 4d4f 4249 4c45 5f4d    xnote.MOBILE_M
-00000310: 4158 5f57 4944 5448 203d 2031 3030 303b  AX_WIDTH = 1000;
-00000320: 0d0a 2020 2020 786e 6f74 652e 636f 6e73  ..    xnote.cons
-00000330: 7461 6e74 7320 3d20 7b0d 0a20 2020 2020  tants = {..     
-00000340: 2020 204d 4f42 494c 455f 4d41 585f 5749     MOBILE_MAX_WI
-00000350: 4454 483a 2031 3030 0d0a 2020 2020 7d3b  DTH: 100..    };
-00000360: 0d0a 0d0a 2020 2020 2f2f 20e5 908e e7ab  ....    // .....
-00000370: afe6 8ea5 e58f a341 5049 e6a8 a1e5 9d97  .......API......
-00000380: 0d0a 2020 2020 786e 6f74 652e 6170 6920  ..    xnote.api 
-00000390: 3d20 7b7d 3b0d 0a20 2020 202f 2f20 e693  = {};..    // ..
-000003a0: 8de4 bd9c e58a a8e4 bd9c e68e a5e5 8fa3  ................
-000003b0: 0d0a 2020 2020 786e 6f74 652e 6163 7469  ..    xnote.acti
-000003c0: 6f6e 203d 207b 7d3b 0d0a 0d0a 2020 2020  on = {};....    
-000003d0: 2f2f 20e4 ba8b e4bb b6e7 9bb8 e585 b3e6  // .............
-000003e0: 8ea5 e58f a30d 0a20 2020 2078 6e6f 7465  .......    xnote
-000003f0: 2e65 7665 6e74 7320 3d20 7b7d 3b0d 0a20  .events = {};.. 
-00000400: 2020 202f 2f20 7265 7369 7a65 e4ba 8be4     // resize....
-00000410: bbb6 e59b 9ee8 b083 0d0a 2020 2020 786e  ..........    xn
-00000420: 6f74 652e 6576 656e 7473 2e72 6573 697a  ote.events.resiz
-00000430: 6548 6f6f 6b73 203d 205b 5d3b 0d0a 0d0a  eHooks = [];....
-00000440: 2020 2020 2f2f 20e8 a1a8 e6a0 bce6 a8a1      // .........
-00000450: e59d 970d 0a20 2020 2078 6e6f 7465 2e74  .....    xnote.t
-00000460: 6162 6c65 203d 207b 7d3b 0d0a 2020 2020  able = {};..    
-00000470: 2f2f 20e7 bc96 e8be 91e5 99a8 e6a8 a1e5  // .............
-00000480: 9d97 0d0a 2020 2020 786e 6f74 652e 6564  ....    xnote.ed
-00000490: 6974 6f72 203d 207b 7d3b 0d0a 2020 2020  itor = {};..    
-000004a0: 2f2f 20e4 b89a e58a a1e7 8ab6 e680 810d  // .............
-000004b0: 0a20 2020 2078 6e6f 7465 2e73 7461 7465  .    xnote.state
-000004c0: 203d 207b 7d3b 0d0a 2020 2020 2f2f 20e7   = {};..    // .
-000004d0: b3bb e7bb 9fe7 8ab6 e680 810d 0a20 2020  .............   
-000004e0: 2078 6e6f 7465 2e73 7461 7465 2e73 7973   xnote.state.sys
-000004f0: 7465 6d20 3d20 7b7d 3b0d 0a20 2020 202f  tem = {};..    /
-00000500: 2f20 e68c 89e9 94ae e5bc b9e8 b5b7 e79a  / ..............
-00000510: 84e6 97b6 e997 b40d 0a20 2020 2078 6e6f  .........    xno
-00000520: 7465 2e73 7461 7465 2e73 7973 7465 6d2e  te.state.system.
-00000530: 6b65 7975 7054 696d 6520 3d20 6e65 7720  keyupTime = new 
-00000540: 4461 7465 2829 2e67 6574 5469 6d65 2829  Date().getTime()
-00000550: 3b0d 0a0d 0a20 2020 202f 2f20 6874 7470  ;....    // http
-00000560: e79b b8e5 85b3 e693 8de4 bd9c 0d0a 2020  ..............  
-00000570: 2020 786e 6f74 652e 6874 7470 203d 207b    xnote.http = {
-00000580: 7d3b 0d0a 0d0a 2020 2020 2f2f 20e5 8a9f  };....    // ...
-00000590: e883 bde6 a8a1 e59d 970d 0a20 2020 2078  ...........    x
-000005a0: 6e6f 7465 2e6e 6f74 6520 3d20 7b7d 3b0d  note.note = {};.
-000005b0: 0a0d 0a20 2020 202f 2f20 e5ad 97e7 aca6  ...    // ......
-000005c0: e4b8 b2e6 a8a1 e59d 970d 0a20 2020 2078  ...........    x
-000005d0: 6e6f 7465 2e73 7472 696e 6720 3d20 7b7d  note.string = {}
-000005e0: 3b0d 0a7d 0d0a 0d0a 786e 6f74 652e 7265  ;..}....xnote.re
-000005f0: 6769 7374 6572 4170 694d 6f64 756c 6520  gisterApiModule 
-00000600: 3d20 6675 6e63 7469 6f6e 2028 6e61 6d65  = function (name
-00000610: 2920 7b0d 0a20 2020 2069 6620 2878 6e6f  ) {..    if (xno
-00000620: 7465 2e61 7069 5b6e 616d 655d 203d 3d3d  te.api[name] ===
-00000630: 2075 6e64 6566 696e 6564 2920 7b0d 0a20   undefined) {.. 
-00000640: 2020 2020 2020 2078 6e6f 7465 2e61 7069         xnote.api
-00000650: 5b6e 616d 655d 203d 207b 7d3b 0d0a 2020  [name] = {};..  
-00000660: 2020 7d0d 0a7d 3b0d 0a0d 0a2f 2a2a 0d0a    }..};..../**..
-00000670: 202a 20e6 b3a8 e586 8c41 5049 0d0a 202a   * ......API.. *
-00000680: 2040 7061 7261 6d20 7b73 7472 696e 677d   @param {string}
-00000690: 2061 7069 4e61 6d65 2041 5049 e590 8de7   apiName API....
-000006a0: a7b0 0d0a 202a 2040 7061 7261 6d20 7b66  .... * @param {f
-000006b0: 756e 6374 696f 6e7d 2066 6e20 e587 bde6  unction} fn ....
-000006c0: 95b0 0d0a 202a 2f0d 0a78 6e6f 7465 2e72  .... */..xnote.r
-000006d0: 6567 6973 7465 7241 7069 203d 2066 756e  egisterApi = fun
-000006e0: 6374 696f 6e20 2861 7069 4e61 6d65 2c20  ction (apiName, 
-000006f0: 666e 2920 7b0d 0a20 2020 2069 6620 2878  fn) {..    if (x
-00000700: 6e6f 7465 2e61 7069 5b61 7069 4e61 6d65  note.api[apiName
-00000710: 5d20 3d3d 3d20 756e 6465 6669 6e65 6429  ] === undefined)
-00000720: 207b 0d0a 2020 2020 2020 2020 786e 6f74   {..        xnot
-00000730: 652e 6170 695b 6170 694e 616d 655d 203d  e.api[apiName] =
-00000740: 2066 6e3b 0d0a 2020 2020 7d20 656c 7365   fn;..    } else
-00000750: 207b 0d0a 2020 2020 2020 2020 7661 7220   {..        var 
-00000760: 6572 724d 6573 7361 6765 203d 2022 6170  errMessage = "ap
-00000770: 6920 6973 2072 6567 6973 7465 7265 643a  i is registered:
-00000780: 2022 202b 2061 7069 4e61 6d65 3b0d 0a20   " + apiName;.. 
-00000790: 2020 2020 2020 2063 6f6e 736f 6c65 2e65         console.e
-000007a0: 7272 6f72 2865 7272 4d65 7373 6167 6529  rror(errMessage)
-000007b0: 3b0d 0a20 2020 2020 2020 2078 6e6f 7465  ;..        xnote
-000007c0: 2e61 6c65 7274 2865 7272 4d65 7373 6167  .alert(errMessag
-000007d0: 6529 3b0d 0a20 2020 207d 0d0a 7d0d 0a0d  e);..    }..}...
-000007e0: 0a78 6e6f 7465 2e69 7345 6d70 7479 203d  .xnote.isEmpty =
-000007f0: 2066 756e 6374 696f 6e20 2876 616c 7565   function (value
-00000800: 2920 7b0d 0a20 2020 2072 6574 7572 6e20  ) {..    return 
-00000810: 7661 6c75 6520 3d3d 3d20 756e 6465 6669  value === undefi
-00000820: 6e65 6420 7c7c 2076 616c 7565 203d 3d3d  ned || value ===
-00000830: 206e 756c 6c20 7c7c 2076 616c 7565 203d   null || value =
-00000840: 3d3d 2022 223b 0d0a 7d3b 0d0a 0d0a 786e  == "";..};....xn
-00000850: 6f74 652e 6973 4e6f 7445 6d70 7479 203d  ote.isNotEmpty =
-00000860: 2066 756e 6374 696f 6e20 2876 616c 7565   function (value
-00000870: 2920 7b0d 0a20 2020 2072 6574 7572 6e20  ) {..    return 
-00000880: 2178 6e6f 7465 2e69 7345 6d70 7479 2876  !xnote.isEmpty(v
-00000890: 616c 7565 293b 0d0a 7d3b 0d0a 0d0a 786e  alue);..};....xn
-000008a0: 6f74 652e 6765 744f 7244 6566 6175 6c74  ote.getOrDefault
-000008b0: 203d 2066 756e 6374 696f 6e20 2876 616c   = function (val
-000008c0: 7565 2c20 6465 6661 756c 7456 616c 7565  ue, defaultValue
-000008d0: 2920 7b0d 0a20 2020 2069 6620 2876 616c  ) {..    if (val
-000008e0: 7565 203d 3d3d 2075 6e64 6566 696e 6564  ue === undefined
-000008f0: 2920 7b0d 0a20 2020 2020 2020 2072 6574  ) {..        ret
-00000900: 7572 6e20 6465 6661 756c 7456 616c 7565  urn defaultValue
-00000910: 3b0d 0a20 2020 207d 0d0a 2020 2020 7265  ;..    }..    re
-00000920: 7475 726e 2076 616c 7565 3b0d 0a7d 3b0d  turn value;..};.
-00000930: 0a0d 0a78 6e6f 7465 2e65 7865 6375 7465  ...xnote.execute
-00000940: 203d 2066 756e 6374 696f 6e20 2866 6e29   = function (fn)
-00000950: 207b 0d0a 2020 2020 666e 2829 3b0d 0a7d   {..    fn();..}
-00000960: 3b0d 0a0d 0a0d 0a78 6e6f 7465 2e76 616c  ;......xnote.val
-00000970: 6964 6174 6520 3d20 7b0d 0a20 2020 2022  idate = {..    "
-00000980: 6e6f 7455 6e64 6566 696e 6564 223a 2066  notUndefined": f
-00000990: 756e 6374 696f 6e20 286f 626a 2c20 6572  unction (obj, er
-000009a0: 724d 7367 2920 7b0d 0a20 2020 2020 2020  rMsg) {..       
-000009b0: 2069 6620 286f 626a 203d 3d3d 2075 6e64   if (obj === und
-000009c0: 6566 696e 6564 2920 7b0d 0a20 2020 2020  efined) {..     
-000009d0: 2020 2020 2020 2078 6e6f 7465 2e61 6c65         xnote.ale
-000009e0: 7274 2865 7272 4d73 6729 3b0d 0a20 2020  rt(errMsg);..   
-000009f0: 2020 2020 2020 2020 2074 6872 6f77 206e           throw n
-00000a00: 6577 2045 7272 6f72 2865 7272 4d73 6729  ew Error(errMsg)
-00000a10: 3b0d 0a20 2020 2020 2020 207d 0d0a 2020  ;..        }..  
-00000a20: 2020 7d2c 0d0a 2020 2020 2269 7346 756e    },..    "isFun
-00000a30: 6374 696f 6e22 3a20 6675 6e63 7469 6f6e  ction": function
-00000a40: 2028 6f62 6a2c 2065 7272 4d73 6729 207b   (obj, errMsg) {
-00000a50: 0d0a 2020 2020 2020 2020 6966 2028 7479  ..        if (ty
-00000a60: 7065 6f66 206f 626a 2021 3d3d 2027 6675  peof obj !== 'fu
-00000a70: 6e63 7469 6f6e 2729 207b 0d0a 2020 2020  nction') {..    
-00000a80: 2020 2020 2020 2020 786e 6f74 652e 616c          xnote.al
-00000a90: 6572 7428 6572 724d 7367 293b 0d0a 2020  ert(errMsg);..  
-00000aa0: 2020 2020 2020 2020 2020 7468 726f 7720            throw 
-00000ab0: 6e65 7720 4572 726f 7228 6572 724d 7367  new Error(errMsg
-00000ac0: 293b 0d0a 2020 2020 2020 2020 7d0d 0a20  );..        }.. 
-00000ad0: 2020 207d 0d0a 7d3b 0d0a 0d0a 0d0a 0d0a     }..};........
-00000ae0: 2f2f 20e8 b083 e695 b4e8 a1a8 e6a0 bce5  // .............
-00000af0: aebd e5ba a60d 0a78 6e6f 7465 2e74 6162  .......xnote.tab
-00000b00: 6c65 2e61 646a 7573 7457 6964 7468 203d  le.adjustWidth =
-00000b10: 2066 756e 6374 696f 6e28 7365 6c65 6374   function(select
-00000b20: 6f72 2920 7b0d 0a20 2020 2024 2873 656c  or) {..    $(sel
-00000b30: 6563 746f 7229 2e65 6163 6828 6675 6e63  ector).each(func
-00000b40: 7469 6f6e 2028 656c 656d 656e 742c 2069  tion (element, i
-00000b50: 6e64 6578 2920 7b0d 0a20 2020 2020 2020  ndex) {..       
-00000b60: 2076 6172 2068 6561 6469 6e67 7320 3d20   var headings = 
-00000b70: 2428 7468 6973 292e 6669 6e64 2822 7468  $(this).find("th
-00000b80: 2229 3b0d 0a20 2020 2020 2020 2069 6620  ");..        if 
-00000b90: 2868 6561 6469 6e67 732e 6c65 6e67 7468  (headings.length
-00000ba0: 203e 2030 2920 7b0d 0a20 2020 2020 2020   > 0) {..       
-00000bb0: 2020 2020 2076 6172 2077 6964 7468 203d       var width =
-00000bc0: 2031 3030 202f 2068 6561 6469 6e67 732e   100 / headings.
-00000bd0: 6c65 6e67 7468 3b0d 0a20 2020 2020 2020  length;..       
-00000be0: 2020 2020 2068 6561 6469 6e67 732e 6373       headings.cs
-00000bf0: 7328 2277 6964 7468 222c 2077 6964 7468  s("width", width
-00000c00: 202b 2022 2522 293b 0d0a 2020 2020 2020   + "%");..      
-00000c10: 2020 7d0d 0a20 2020 207d 293b 0d0a 7d3b    }..    });..};
-00000c20: 0d0a 0d0a 2f2a 2a0d 0a20 2a20 e8bf bde5  ..../**.. * ....
-00000c30: 8aa0 4353 53e6 a0b7 e5bc 8fe8 a1a8 0d0a  ..CSS...........
-00000c40: 202a 2040 7061 7261 6d20 7b73 7472 696e   * @param {strin
-00000c50: 677d 2073 7479 6c65 5465 7874 20e6 a0b7  g} styleText ...
-00000c60: e5bc 8fe6 9687 e69c ac0d 0a20 2a2f 0d0a  ........... */..
-00000c70: 786e 6f74 652e 6170 7065 6e64 4353 5320  xnote.appendCSS 
-00000c80: 3d20 6675 6e63 7469 6f6e 2028 7374 796c  = function (styl
-00000c90: 6554 6578 7429 207b 0d0a 2020 2020 2f2f  eText) {..    //
-00000ca0: 20e5 b185 e4b8 ade7 9a84 e6a0 b7e5 bc8f   ...............
-00000cb0: 0d0a 2020 2020 7661 7220 7374 796c 6520  ..    var style 
-00000cc0: 3d20 646f 6375 6d65 6e74 2e63 7265 6174  = document.creat
-00000cd0: 6545 6c65 6d65 6e74 2822 7374 796c 6522  eElement("style"
-00000ce0: 293b 0d0a 2020 2020 7374 796c 652e 7479  );..    style.ty
-00000cf0: 7065 203d 2022 7465 7874 2f63 7373 223b  pe = "text/css";
-00000d00: 0d0a 0d0a 2020 2020 6966 2028 7374 796c  ....    if (styl
-00000d10: 652e 7374 796c 6553 6865 6574 2920 7b0d  e.styleSheet) {.
-00000d20: 0a20 2020 2020 202f 2f20 e585 bce5 aeb9  .      // ......
-00000d30: 4945 0d0a 2020 2020 2020 7374 796c 652e  IE..      style.
-00000d40: 7374 796c 6553 6865 6574 2e63 7373 5465  styleSheet.cssTe
-00000d50: 7874 203d 2073 7479 6c65 5465 7874 3b20  xt = styleText; 
-00000d60: 200d 0a20 2020 207d 2065 6c73 6520 7b20   ..    } else { 
-00000d70: 200d 0a20 2020 2020 2073 7479 6c65 2e69   ..      style.i
-00000d80: 6e6e 6572 4854 4d4c 203d 2073 7479 6c65  nnerHTML = style
-00000d90: 5465 7874 3b0d 0a20 2020 207d 200d 0a0d  Text;..    } ...
-00000da0: 0a20 2020 2064 6f63 756d 656e 742e 6865  .    document.he
-00000db0: 6164 2e61 7070 656e 6443 6869 6c64 2873  ad.appendChild(s
-00000dc0: 7479 6c65 293b 0d0a 7d3b 0d0a 0d0a 786e  tyle);..};....xn
-00000dd0: 6f74 652e 6874 7470 2e64 6566 6175 6c74  ote.http.default
-00000de0: 4661 696c 4861 6e64 6c65 7220 3d20 6675  FailHandler = fu
-00000df0: 6e63 7469 6f6e 2028 6572 7229 207b 0d0a  nction (err) {..
-00000e00: 2020 2020 636f 6e73 6f6c 652e 6c6f 6728      console.log(
-00000e10: 6572 7229 3b0d 0a20 2020 2078 6e6f 7465  err);..    xnote
-00000e20: 2e74 6f61 7374 2822 e69c 8de5 8aa1 e599  .toast("........
-00000e30: a8e7 b981 e5bf 992c 20e8 afb7 e7a8 8de5  ......., .......
-00000e40: 908e e987 8de8 af95 7e22 293b 0d0a 7d3b  ........~");..};
-00000e50: 0d0a 0d0a 2f2f 2068 7474 702d 706f 7374  ....// http-post
-00000e60: e8af b7e6 b182 0d0a 786e 6f74 652e 6874  ........xnote.ht
-00000e70: 7470 2e70 6f73 7420 3d20 6675 6e63 7469  tp.post = functi
-00000e80: 6f6e 2028 7572 6c2c 2064 6174 612c 2063  on (url, data, c
-00000e90: 616c 6c62 6163 6b2c 2074 7970 6529 207b  allback, type) {
-00000ea0: 0d0a 2020 2020 7265 7475 726e 2024 2e70  ..    return $.p
-00000eb0: 6f73 7428 786e 6f74 652e 636f 6e66 6967  ost(xnote.config
-00000ec0: 2e73 6572 7665 7248 6f6d 6520 2b20 7572  .serverHome + ur
-00000ed0: 6c2c 2064 6174 612c 2063 616c 6c62 6163  l, data, callbac
-00000ee0: 6b2c 2074 7970 6529 2e66 6169 6c28 786e  k, type).fail(xn
-00000ef0: 6f74 652e 6874 7470 2e64 6566 6175 6c74  ote.http.default
-00000f00: 4661 696c 4861 6e64 6c65 7229 3b0d 0a7d  FailHandler);..}
-00000f10: 0d0a 0d0a 2f2f 2068 7474 702d 6765 74e8  ....// http-get.
-00000f20: afb7 e6b1 820d 0a78 6e6f 7465 2e68 7474  .......xnote.htt
-00000f30: 702e 6765 7420 3d20 6675 6e63 7469 6f6e  p.get = function
-00000f40: 2028 7572 6c2c 2064 6174 612c 2063 616c   (url, data, cal
-00000f50: 6c62 6163 6b2c 2074 7970 6529 207b 0d0a  lback, type) {..
-00000f60: 2020 2020 7265 7475 726e 2024 2e67 6574      return $.get
-00000f70: 2878 6e6f 7465 2e63 6f6e 6669 672e 7365  (xnote.config.se
-00000f80: 7276 6572 486f 6d65 202b 2075 726c 2c20  rverHome + url, 
-00000f90: 6461 7461 2c20 6361 6c6c 6261 636b 2c20  data, callback, 
-00000fa0: 7479 7065 292e 6661 696c 2878 6e6f 7465  type).fail(xnote
-00000fb0: 2e68 7474 702e 6465 6661 756c 7446 6169  .http.defaultFai
-00000fc0: 6c48 616e 646c 6572 293b 0d0a 7d0d 0a0d  lHandler);..}...
-00000fd0: 0a78 6e6f 7465 2e69 7354 7970 696e 6720  .xnote.isTyping 
-00000fe0: 3d20 6675 6e63 7469 6f6e 2829 207b 0d0a  = function() {..
-00000ff0: 2020 2020 7661 7220 6e6f 7720 3d20 6e65      var now = ne
-00001000: 7720 4461 7465 2829 2e67 6574 5469 6d65  w Date().getTime
-00001010: 2829 3b0d 0a20 2020 2076 6172 2074 7970  ();..    var typ
-00001020: 696e 6747 6170 203d 2032 3030 3b20 2f2f  ingGap = 200; //
-00001030: 2032 3030 e6af abe7 a792 0d0a 2020 2020   200........    
-00001040: 7265 7475 726e 206e 6f77 202d 2078 6e6f  return now - xno
-00001050: 7465 2e73 7461 7465 2e73 7973 7465 6d2e  te.state.system.
-00001060: 6b65 7975 7054 696d 6520 3c20 7479 7069  keyupTime < typi
-00001070: 6e67 4761 703b 0d0a 7d0d 0a0d 0a76 6172  ngGap;..}....var
-00001080: 2058 5549 203d 2066 756e 6374 696f 6e28   XUI = function(
-00001090: 7769 6e64 6f77 2920 7b0d 0a20 2020 202f  window) {..    /
-000010a0: 2f20 e5a4 84e7 9086 7365 6c65 6374 e6a0  / ......select..
-000010b0: 87e7 adbe e980 89e4 b8ad e683 85e5 86b5  ................
-000010c0: 0d0a 2020 2020 6675 6e63 7469 6f6e 2069  ..    function i
-000010d0: 6e69 7453 656c 6563 7428 2920 7b0d 0a20  nitSelect() {.. 
-000010e0: 2020 2020 2020 2024 2822 7365 6c65 6374         $("select
-000010f0: 2229 2e65 6163 6828 6675 6e63 7469 6f6e  ").each(function
-00001100: 2869 6e64 6578 2c20 656c 6529 207b 0d0a  (index, ele) {..
-00001110: 2020 2020 2020 2020 2020 2020 7661 7220              var 
-00001120: 7365 6c66 203d 2024 2865 6c65 293b 0d0a  self = $(ele);..
-00001130: 2020 2020 2020 2020 2020 2020 7661 7220              var 
-00001140: 6368 696c 6472 656e 203d 2073 656c 662e  children = self.
-00001150: 6368 696c 6472 656e 2829 3b0d 0a20 2020  children();..   
-00001160: 2020 2020 2020 2020 202f 2f20 e4bd bfe7           // ....
-00001170: 94a8 242e 7661 6c28 2920 e4bc 9ae5 8f96  ..$.val() ......
-00001180: e588 b0e7 acac e4b8 80e4 b8aa 7365 6c65  ............sele
-00001190: 6374 e6a0 87e7 adbe e580 bc0d 0a20 2020  ct...........   
-000011a0: 2020 2020 2020 2020 2076 6172 2076 616c           var val
-000011b0: 7565 203d 2073 656c 662e 6174 7472 2822  ue = self.attr("
-000011c0: 7661 6c75 6522 293b 0d0a 2020 2020 2020  value");..      
-000011d0: 2020 2020 2020 666f 7220 2876 6172 2069        for (var i
-000011e0: 203d 2030 3b20 6920 3c20 6368 696c 6472   = 0; i < childr
-000011f0: 656e 2e6c 656e 6774 683b 2069 2b2b 2920  en.length; i++) 
-00001200: 7b0d 0a20 2020 2020 2020 2020 2020 2020  {..             
-00001210: 2020 2076 6172 2063 6869 6c64 203d 2063     var child = c
-00001220: 6869 6c64 7265 6e5b 695d 3b0d 0a20 2020  hildren[i];..   
-00001230: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00001240: 2876 616c 7565 203d 3d20 6368 696c 642e  (value == child.
-00001250: 7661 6c75 6529 207b 0d0a 2020 2020 2020  value) {..      
-00001260: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00001270: 696c 642e 7365 6c65 6374 6564 203d 2022  ild.selected = "
-00001280: 7365 6c65 6374 6564 223b 0d0a 2020 2020  selected";..    
-00001290: 2020 2020 2020 2020 2020 2020 7d0d 0a20              }.. 
-000012a0: 2020 2020 2020 2020 2020 207d 0d0a 2020             }..  
-000012b0: 2020 2020 2020 7d29 3b0d 0a20 2020 207d        });..    }
-000012c0: 0d0a 0d0a 2020 2020 6675 6e63 7469 6f6e  ....    function
-000012d0: 2069 6e69 7443 6865 636b 626f 7828 2920   initCheckbox() 
-000012e0: 7b0d 0a20 2020 2020 2020 2024 2822 696e  {..        $("in
-000012f0: 7075 745b 7479 7065 3d63 6865 636b 626f  put[type=checkbo
-00001300: 785d 2229 2e65 6163 6828 6675 6e63 7469  x]").each(functi
-00001310: 6f6e 2869 6e64 6578 2c20 656c 6529 207b  on(index, ele) {
-00001320: 0d0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-00001330: 7220 7365 6c66 203d 2024 2865 6c65 293b  r self = $(ele);
-00001340: 0d0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-00001350: 7220 7661 6c75 6520 3d20 7365 6c66 2e61  r value = self.a
-00001360: 7474 7228 2264 6566 6175 6c74 2d76 616c  ttr("default-val
-00001370: 7565 2229 3b0d 0a20 2020 2020 2020 2020  ue");..         
-00001380: 2020 2069 6620 2876 616c 7565 203d 3d20     if (value == 
-00001390: 226f 6e22 2920 7b0d 0a20 2020 2020 2020  "on") {..       
-000013a0: 2020 2020 2020 2020 2073 656c 662e 6174           self.at
-000013b0: 7472 2822 6368 6563 6b65 6422 2c20 2263  tr("checked", "c
-000013c0: 6865 636b 6564 2229 3b0d 0a20 2020 2020  hecked");..     
-000013d0: 2020 2020 2020 207d 0d0a 2020 2020 2020         }..      
-000013e0: 2020 7d29 0d0a 2020 2020 7d0d 0a0d 0a20    })..    }.... 
-000013f0: 2020 2066 756e 6374 696f 6e20 696e 6974     function init
-00001400: 5261 6469 6f28 2920 7b0d 0a20 2020 2020  Radio() {..     
-00001410: 2020 2024 2822 696e 7075 745b 7479 7065     $("input[type
-00001420: 3d72 6164 696f 5d22 292e 6561 6368 2866  =radio]").each(f
-00001430: 756e 6374 696f 6e28 696e 6465 782c 2065  unction(index, e
-00001440: 6c65 2920 7b0d 0a20 2020 2020 2020 2020  le) {..         
-00001450: 2020 2076 6172 2073 656c 6620 3d20 2428     var self = $(
-00001460: 656c 6529 3b0d 0a20 2020 2020 2020 2020  ele);..         
-00001470: 2020 2076 6172 2076 616c 7565 203d 2073     var value = s
-00001480: 656c 662e 6174 7472 2822 6465 6661 756c  elf.attr("defaul
-00001490: 742d 7661 6c75 6522 293b 0d0a 2020 2020  t-value");..    
-000014a0: 2020 2020 2020 2020 6966 2028 7661 6c75          if (valu
-000014b0: 6520 3d3d 2073 656c 662e 7661 6c28 2929  e == self.val())
-000014c0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-000014d0: 2020 2020 7365 6c66 2e61 7474 7228 2263      self.attr("c
-000014e0: 6865 636b 6564 222c 2022 6368 6563 6b65  hecked", "checke
-000014f0: 6422 293b 0d0a 2020 2020 2020 2020 2020  d");..          
-00001500: 2020 7d0d 0a20 2020 2020 2020 207d 293b    }..        });
-00001510: 0d0a 2020 2020 7d0d 0a0d 0a20 2020 2066  ..    }....    f
-00001520: 756e 6374 696f 6e20 696e 6974 5852 6164  unction initXRad
-00001530: 696f 2829 207b 0d0a 2020 2020 2020 2020  io() {..        
-00001540: 2428 222e 782d 7261 6469 6f22 292e 6561  $(".x-radio").ea
-00001550: 6368 2866 756e 6374 696f 6e28 696e 6465  ch(function(inde
-00001560: 782c 2065 6c65 6d65 6e74 2920 7b0d 0a20  x, element) {.. 
-00001570: 2020 2020 2020 2020 2020 2076 6172 2073             var s
-00001580: 656c 6620 3d20 2428 656c 656d 656e 7429  elf = $(element)
-00001590: 3b0d 0a20 2020 2020 2020 2020 2020 2076  ;..            v
-000015a0: 6172 206f 7074 696f 6e20 3d20 7365 6c66  ar option = self
-000015b0: 2e61 7474 7228 2264 6174 612d 6f70 7469  .attr("data-opti
-000015c0: 6f6e 2229 3b0d 0a20 2020 2020 2020 2020  on");..         
-000015d0: 2020 2076 6172 2076 616c 7565 203d 2073     var value = s
-000015e0: 656c 662e 6174 7472 2822 6461 7461 2d76  elf.attr("data-v
-000015f0: 616c 7565 2229 3b0d 0a20 2020 2020 2020  alue");..       
-00001600: 2020 2020 2069 6620 2876 616c 7565 203d       if (value =
-00001610: 3d20 6f70 7469 6f6e 2920 7b0d 0a20 2020  = option) {..   
-00001620: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00001630: 662e 6164 6443 6c61 7373 2822 7365 6c65  f.addClass("sele
-00001640: 6374 6564 2d6c 696e 6b22 293b 0d0a 2020  cted-link");..  
-00001650: 2020 2020 2020 2020 2020 7d0d 0a20 2020            }..   
-00001660: 2020 2020 207d 293b 0d0a 2020 2020 7d3b       });..    };
-00001670: 0d0a 0d0a 2020 2020 2f2f 20e7 82b9 e587  ....    // .....
-00001680: bbe8 b7b3 e8bd ace9 93be e68e a5e7 9a84  ................
-00001690: e68c 89e9 92ae 0d0a 2020 2020 2428 222e  ........    $(".
-000016a0: 6c69 6e6b 2d62 746e 2229 2e63 6c69 636b  link-btn").click
-000016b0: 2866 756e 6374 696f 6e28 2920 7b0d 0a20  (function() {.. 
-000016c0: 2020 2020 2020 2076 6172 206c 696e 6b20         var link 
-000016d0: 3d20 2428 7468 6973 292e 6174 7472 2822  = $(this).attr("
-000016e0: 782d 6872 6566 2229 3b0d 0a20 2020 2020  x-href");..     
-000016f0: 2020 2069 6620 2821 6c69 6e6b 2920 7b0d     if (!link) {.
-00001700: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00001710: 6b20 3d20 2428 7468 6973 292e 6174 7472  k = $(this).attr
-00001720: 2822 6872 6566 2229 3b0d 0a20 2020 2020  ("href");..     
-00001730: 2020 207d 0d0a 2020 2020 2020 2020 7661     }..        va
-00001740: 7220 636f 6e66 6972 6d4d 6573 7361 6765  r confirmMessage
-00001750: 203d 2024 2874 6869 7329 2e61 7474 7228   = $(this).attr(
-00001760: 2263 6f6e 6669 726d 2d6d 6573 7361 6765  "confirm-message
-00001770: 2229 3b0d 0a20 2020 2020 2020 2069 6620  ");..        if 
-00001780: 2863 6f6e 6669 726d 4d65 7373 6167 6529  (confirmMessage)
-00001790: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-000017a0: 786e 6f74 652e 636f 6e66 6972 6d28 636f  xnote.confirm(co
-000017b0: 6e66 6972 6d4d 6573 7361 6765 2c20 6675  nfirmMessage, fu
-000017c0: 6e63 7469 6f6e 2028 7265 7375 6c74 2920  nction (result) 
-000017d0: 7b0d 0a20 2020 2020 2020 2020 2020 2020  {..             
-000017e0: 2020 2077 696e 646f 772e 6c6f 6361 7469     window.locati
-000017f0: 6f6e 2e68 7265 6620 3d20 6c69 6e6b 3b0d  on.href = link;.
-00001800: 0a20 2020 2020 2020 2020 2020 207d 293b  .            });
-00001810: 0d0a 2020 2020 2020 2020 7d20 656c 7365  ..        } else
-00001820: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
-00001830: 7769 6e64 6f77 2e6c 6f63 6174 696f 6e2e  window.location.
-00001840: 6872 6566 203d 206c 696e 6b3b 0d0a 2020  href = link;..  
-00001850: 2020 2020 2020 7d0d 0a20 2020 207d 293b        }..    });
-00001860: 0d0a 0d0a 2020 2020 2f2f 20e7 82b9 e587  ....    // .....
-00001870: bb70 726f 6d70 74e6 8c89 e992 ae0d 0a20  .prompt........ 
-00001880: 2020 202f 2f20 3c69 6e70 7574 2074 7970     // <input typ
-00001890: 653d 2262 7574 746f 6e22 2063 6c61 7373  e="button" class
-000018a0: 3d22 7072 6f6d 7074 2d62 746e 2220 6163  ="prompt-btn" ac
-000018b0: 7469 6f6e 3d22 2f72 656e 616d 653f 6e61  tion="/rename?na
-000018c0: 6d65 3d22 206d 6573 7361 6765 3d22 e987  me=" message="..
-000018d0: 8de5 91bd e590 8de4 b8ba 2220 7661 6c75  .........." valu
-000018e0: 653d 22e9 878d e591 bde5 908d 223e 0d0a  e=".........">..
-000018f0: 2020 2020 2428 222e 7072 6f6d 7074 2d62      $(".prompt-b
-00001900: 746e 2229 2e63 6c69 636b 2866 756e 6374  tn").click(funct
-00001910: 696f 6e28 2920 7b0d 0a20 2020 2020 2020  ion() {..       
-00001920: 2076 6172 2061 6374 696f 6e20 3d20 2428   var action = $(
-00001930: 7468 6973 292e 6174 7472 2822 6163 7469  this).attr("acti
-00001940: 6f6e 2229 3b0d 0a20 2020 2020 2020 2076  on");..        v
-00001950: 6172 206d 6573 7361 6765 203d 2024 2874  ar message = $(t
-00001960: 6869 7329 2e61 7474 7228 226d 6573 7361  his).attr("messa
-00001970: 6765 2229 3b0d 0a20 2020 2020 2020 2076  ge");..        v
-00001980: 6172 2064 6566 6175 6c74 5661 6c75 6520  ar defaultValue 
-00001990: 3d20 2428 7468 6973 292e 6174 7472 2822  = $(this).attr("
-000019a0: 6465 6661 756c 742d 7661 6c75 6522 293b  default-value");
-000019b0: 0d0a 2020 2020 2020 2020 7661 7220 696e  ..        var in
-000019c0: 7075 7456 616c 7565 203d 2070 726f 6d70  putValue = promp
-000019d0: 7428 6d65 7373 6167 652c 2064 6566 6175  t(message, defau
-000019e0: 6c74 5661 6c75 6529 3b0d 0a20 2020 2020  ltValue);..     
-000019f0: 2020 2069 6620 2869 6e70 7574 5661 6c75     if (inputValu
-00001a00: 6520 213d 2022 2220 2626 2069 6e70 7574  e != "" && input
-00001a10: 5661 6c75 6529 207b 0d0a 2020 2020 2020  Value) {..      
-00001a20: 2020 2020 2020 7661 7220 6163 7469 6f6e        var action
-00001a30: 5572 6c20 3d20 6163 7469 6f6e 202b 2065  Url = action + e
-00001a40: 6e63 6f64 6555 5249 436f 6d70 6f6e 656e  ncodeURIComponen
-00001a50: 7428 696e 7075 7456 616c 7565 293b 0d0a  t(inputValue);..
-00001a60: 2020 2020 2020 2020 2020 2020 242e 6765              $.ge
-00001a70: 7428 6163 7469 6f6e 5572 6c2c 2066 756e  t(actionUrl, fun
-00001a80: 6374 696f 6e28 7265 7370 2920 7b0d 0a20  ction(resp) {.. 
-00001a90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00001aa0: 696e 646f 772e 6c6f 6361 7469 6f6e 2e72  indow.location.r
-00001ab0: 656c 6f61 6428 293b 0d0a 2020 2020 2020  eload();..      
-00001ac0: 2020 2020 2020 7d29 0d0a 2020 2020 2020        })..      
-00001ad0: 2020 7d0d 0a20 2020 207d 293b 0d0a 0d0a    }..    });....
-00001ae0: 2020 2020 2f2f 20e5 889d e5a7 8be5 8c96      // .........
-00001af0: e8a1 a8e5 8d95 e68e a7e4 bbb6 e79a 84e9  ................
-00001b00: bb98 e8ae a4e5 80bc 0d0a 2020 2020 6675  ..........    fu
-00001b10: 6e63 7469 6f6e 2069 6e69 7444 6566 6175  nction initDefau
-00001b20: 6c74 5661 6c75 6528 6576 656e 7429 207b  ltValue(event) {
-00001b30: 0d0a 2020 2020 2020 2020 696e 6974 5365  ..        initSe
-00001b40: 6c65 6374 2829 3b0d 0a20 2020 2020 2020  lect();..       
-00001b50: 2069 6e69 7443 6865 636b 626f 7828 293b   initCheckbox();
-00001b60: 0d0a 2020 2020 2020 2020 696e 6974 5261  ..        initRa
-00001b70: 6469 6f28 293b 0d0a 2020 2020 2020 2020  dio();..        
-00001b80: 696e 6974 5852 6164 696f 2829 3b0d 0a20  initXRadio();.. 
-00001b90: 2020 2020 2020 2078 6e6f 7465 2e74 6162         xnote.tab
-00001ba0: 6c65 2e61 646a 7573 7457 6964 7468 2822  le.adjustWidth("
-00001bb0: 2e64 6566 6175 6c74 2d74 6162 6c65 2229  .default-table")
-00001bc0: 3b0d 0a20 2020 207d 3b0d 0a0d 0a20 2020  ;..    };....   
-00001bd0: 2077 696e 646f 772e 786e 6f74 652e 6173   window.xnote.as
-00001be0: 7365 7274 203d 2066 756e 6374 696f 6e20  sert = function 
-00001bf0: 2865 7870 7265 7373 696f 6e2c 206d 6573  (expression, mes
-00001c00: 7361 6765 2920 7b0d 0a20 2020 2020 2020  sage) {..       
-00001c10: 2069 6620 2821 6578 7072 6573 7369 6f6e   if (!expression
-00001c20: 2920 7b0d 0a20 2020 2020 2020 2020 2020  ) {..           
-00001c30: 2078 6e6f 7465 2e61 6c65 7274 286d 6573   xnote.alert(mes
-00001c40: 7361 6765 293b 0d0a 2020 2020 2020 2020  sage);..        
-00001c50: 7d0d 0a20 2020 207d 3b0d 0a0d 0a20 2020  }..    };....   
-00001c60: 202f 2f20 e588 b7e6 96b0 e590 84e7 a78d   // ............
-00001c70: e9bb 98e8 aea4 e580 bc0d 0a20 2020 2078  ...........    x
-00001c80: 6e6f 7465 2e72 6566 7265 7368 203d 2066  note.refresh = f
-00001c90: 756e 6374 696f 6e20 2829 207b 0d0a 2020  unction () {..  
-00001ca0: 2020 2020 2020 2f2f 20e5 889d e5a7 8be5        // .......
-00001cb0: 8c96 0d0a 2020 2020 2020 2020 696e 6974  ....        init
-00001cc0: 4465 6661 756c 7456 616c 7565 2829 3b0d  DefaultValue();.
-00001cd0: 0a20 2020 2020 2020 202f 2f20 e6b3 a8e5  .        // ....
-00001ce0: 868c e4ba 8be4 bbb6 0d0a 2020 2020 2020  ..........      
-00001cf0: 2020 786e 6f74 652e 6164 6445 7665 6e74    xnote.addEvent
-00001d00: 4c69 7374 656e 6572 2822 696e 6974 2d64  Listener("init-d
-00001d10: 6566 6175 6c74 2d76 616c 7565 222c 2069  efault-value", i
-00001d20: 6e69 7444 6566 6175 6c74 5661 6c75 6529  nitDefaultValue)
-00001d30: 3b0d 0a20 2020 2020 2020 2078 6e6f 7465  ;..        xnote
-00001d40: 2e61 6464 4576 656e 744c 6973 7465 6e65  .addEventListene
-00001d50: 7228 2278 6e6f 7465 2e72 656c 6f61 6422  r("xnote.reload"
-00001d60: 2c20 696e 6974 4465 6661 756c 7456 616c  , initDefaultVal
-00001d70: 7565 293b 0d0a 2020 2020 7d3b 0d0a 0d0a  ue);..    };....
-00001d80: 2020 2020 786e 6f74 652e 7265 6672 6573      xnote.refres
-00001d90: 6828 293b 0d0a 7d3b 0d0a 0d0a 2428 646f  h();..};....$(do
-00001da0: 6375 6d65 6e74 292e 7265 6164 7928 6675  cument).ready(fu
-00001db0: 6e63 7469 6f6e 2829 207b 0d0a 2020 2020  nction() {..    
-00001dc0: 5855 4928 7769 6e64 6f77 293b 0d0a 2020  XUI(window);..  
-00001dd0: 2020 2428 2262 6f64 7922 292e 6f6e 2822    $("body").on("
-00001de0: 6b65 7975 7022 2c20 6675 6e63 7469 6f6e  keyup", function
-00001df0: 2028 6576 656e 7429 207b 0d0a 2020 2020   (event) {..    
-00001e00: 2020 2020 786e 6f74 652e 7374 6174 652e      xnote.state.
-00001e10: 7379 7374 656d 2e6b 6579 7570 5469 6d65  system.keyupTime
-00001e20: 203d 206e 6577 2044 6174 6528 292e 6765   = new Date().ge
-00001e30: 7454 696d 6528 293b 0d0a 2020 2020 7d29  tTime();..    })
-00001e40: 3b0d 0a7d 293b 0d0a 0d0a 2f2a 2a0d 0a20  ;..});..../**.. 
-00001e50: 2a20 e68c 87e5 ae9a e7b4 a2e5 bc95 e5af  * ..............
-00001e60: b9e6 9687 e69c ace8 bf9b e8a1 8ce6 9bbf  ................
-00001e70: e68d a20d 0a20 2a20 4070 6172 616d 207b  ..... * @param {
-00001e80: 7374 7269 6e67 7d20 7465 7874 20e5 8e9f  string} text ...
-00001e90: e5a7 8be6 9687 e69c ac0d 0a20 2a20 4070  ........... * @p
-00001ea0: 6172 616d 207b 7374 7269 6e67 7d20 7461  aram {string} ta
-00001eb0: 7267 6574 20e8 a2ab e69b bfe6 8da2 e79a  rget ...........
-00001ec0: 84e6 9687 e69c ac0d 0a20 2a20 4070 6172  ......... * @par
-00001ed0: 616d 207b 7374 7269 6e67 7d20 7265 706c  am {string} repl
-00001ee0: 6163 656d 656e 7420 e696 b0e7 9a84 e696  acement ........
-00001ef0: 87e6 9cac 0d0a 202a 2040 7061 7261 6d20  ...... * @param 
-00001f00: 7b69 6e74 7d20 696e 6465 7820 e7b4 a2e5  {int} index ....
-00001f10: bc95 e4bd 8de7 bdae 0d0a 202a 2040 7265  .......... * @re
-00001f20: 7475 726e 7320 0d0a 202a 2f0d 0a78 6e6f  turns .. */..xno
-00001f30: 7465 2e73 7472 696e 672e 7265 706c 6163  te.string.replac
-00001f40: 6542 7949 6e64 6578 203d 2066 756e 6374  eByIndex = funct
-00001f50: 696f 6e20 2874 6578 742c 2074 6172 6765  ion (text, targe
-00001f60: 742c 2072 6570 6c61 6365 6d65 6e74 2c20  t, replacement, 
-00001f70: 696e 6465 7829 207b 0d0a 2020 2020 7661  index) {..    va
-00001f80: 7220 746f 6b65 6e73 203d 2074 6578 742e  r tokens = text.
-00001f90: 7370 6c69 7428 7461 7267 6574 293b 0d0a  split(target);..
-00001fa0: 2020 2020 7661 7220 7265 7375 6c74 203d      var result =
-00001fb0: 205b 5d3b 0d0a 2020 2020 666f 7220 2876   [];..    for (v
-00001fc0: 6172 2069 203d 2030 3b20 6920 3c20 746f  ar i = 0; i < to
-00001fd0: 6b65 6e73 2e6c 656e 6774 683b 2069 2b2b  kens.length; i++
-00001fe0: 2920 7b0d 0a20 2020 2020 2020 2076 6172  ) {..        var
-00001ff0: 2074 6f6b 656e 203d 2074 6f6b 656e 735b   token = tokens[
-00002000: 695d 3b0d 0a20 2020 2020 2020 2072 6573  i];..        res
-00002010: 756c 742e 7075 7368 2874 6f6b 656e 293b  ult.push(token);
-00002020: 0d0a 0d0a 2020 2020 2020 2020 6966 2028  ....        if (
-00002030: 692b 3120 3d3d 2074 6f6b 656e 732e 6c65  i+1 == tokens.le
-00002040: 6e67 7468 2920 7b0d 0a20 2020 2020 2020  ngth) {..       
-00002050: 2020 2020 2063 6f6e 7469 6e75 653b 0d0a       continue;..
-00002060: 2020 2020 2020 2020 7d0d 0a0d 0a20 2020          }....   
-00002070: 2020 2020 2069 6620 2869 203d 3d20 696e       if (i == in
-00002080: 6465 7829 207b 0d0a 2020 2020 2020 2020  dex) {..        
-00002090: 2020 2020 7265 7375 6c74 2e70 7573 6828      result.push(
-000020a0: 7265 706c 6163 656d 656e 7429 3b0d 0a20  replacement);.. 
-000020b0: 2020 2020 2020 207d 2065 6c73 6520 7b0d         } else {.
-000020c0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000020d0: 756c 742e 7075 7368 2874 6172 6765 7429  ult.push(target)
-000020e0: 3b0d 0a20 2020 2020 2020 207d 0d0a 2020  ;..        }..  
-000020f0: 2020 7d0d 0a20 2020 200d 0a20 2020 2072    }..    ..    r
-00002100: 6574 7572 6e20 7265 7375 6c74 2e6a 6f69  eturn result.joi
-00002110: 6e28 2222 293b 0d0a 7d3b 0d0a 0d0a       n("");..};....
+00000000: 0a3c 6469 7620 636c 6173 733d 2273 6861  .<div class="sha
+00000010: 7265 2d74 706c 2068 6964 6522 3e0a 2020  re-tpl hide">.  
+00000020: 2020 3c70 3ee5 8886 e4ba abe9 93be e68e    <p>...........
+00000030: a53a 203c 7370 616e 2063 6c61 7373 3d22  .: <span class="
+00000040: 6e6f 7465 2d73 6861 7265 2d6c 696e 6b2d  note-share-link-
+00000050: 7465 7874 223e 3c2f 7370 616e 3e3c 2f70  text"></span></p
+00000060: 3e0a 2020 2020 3c64 6976 2063 6c61 7373  >.    <div class
+00000070: 3d22 726f 7722 3e0a 2020 2020 2020 2020  ="row">.        
+00000080: 3c62 7574 746f 6e20 636c 6173 733d 226e  <button class="n
+00000090: 6f74 652d 7368 6172 652d 6c69 6e6b 2d62  ote-share-link-b
+000000a0: 746e 2062 746e 2220 6461 7461 2d63 6c69  tn btn" data-cli
+000000b0: 7062 6f61 7264 2d74 6578 743d 2222 3ee5  pboard-text="">.
+000000c0: a48d e588 b63c 2f62 7574 746f 6e3e 0a20  .....</button>. 
+000000d0: 2020 203c 2f64 6976 3e0a 3c2f 6469 763e     </div>.</div>
+000000e0: 0a0a 7b25 2069 6e63 6c75 6465 206e 6f74  ..{% include not
+000000f0: 652f 636f 6d70 6f6e 656e 742f 7363 7269  e/component/scri
+00000100: 7074 2f67 726f 7570 5f73 656c 6563 745f  pt/group_select_
+00000110: 7363 7269 7074 2e68 746d 6c20 257d 0a7b  script.html %}.{
+00000120: 2520 696e 636c 7564 6520 6e6f 7465 2f63  % include note/c
+00000130: 6f6d 706f 6e65 6e74 2f73 6372 6970 742f  omponent/script/
+00000140: 6e6f 7465 5f63 6f70 795f 7363 7269 7074  note_copy_script
+00000150: 2e68 746d 6c20 257d 0a0a 0a3c 7363 7269  .html %}...<scri
+00000160: 7074 2074 7970 653d 2274 6578 742f 6a61  pt type="text/ja
+00000170: 7661 7363 7269 7074 223e 0a20 2020 202f  vascript">.    /
+00000180: 2f20 e7a7 bbe5 8aa8 e7ac 94e8 aeb0 e79a  / ..............
+00000190: 84e5 9b9e e8b0 83e5 87bd e695 b00a 2020  ..............  
+000001a0: 2020 7769 6e64 6f77 2e6d 6f76 654e 6f74    window.moveNot
+000001b0: 6543 616c 6c62 6163 6b20 3d20 6675 6e63  eCallback = func
+000001c0: 7469 6f6e 2028 7061 7265 6e74 4964 2920  tion (parentId) 
+000001d0: 7b0a 2020 2020 2020 2020 7661 7220 7365  {.        var se
+000001e0: 6c66 4964 203d 2022 7b7b 6669 6c65 2e69  lfId = "{{file.i
+000001f0: 647d 7d22 3b0a 2020 2020 2020 2020 242e  d}}";.        $.
+00000200: 706f 7374 2822 2f6e 6f74 652f 6d6f 7665  post("/note/move
+00000210: 222c 207b 6964 3a73 656c 6649 642c 2070  ", {id:selfId, p
+00000220: 6172 656e 745f 6964 3a20 7061 7265 6e74  arent_id: parent
+00000230: 4964 7d2c 2066 756e 6374 696f 6e20 2872  Id}, function (r
+00000240: 6573 7029 7b0a 2020 2020 2020 2020 2020  esp){.          
+00000250: 2020 2020 636f 6e73 6f6c 652e 6c6f 6728      console.log(
+00000260: 7265 7370 293b 0a20 2020 2020 2020 2020  resp);.         
+00000270: 2020 2020 2077 696e 646f 772e 6c6f 6361       window.loca
+00000280: 7469 6f6e 2e72 656c 6f61 6428 293b 0a20  tion.reload();. 
+00000290: 2020 2020 2020 207d 293b 0a20 2020 207d         });.    }
+000002a0: 0a0a 2020 2020 7769 6e64 6f77 2e76 6973  ..    window.vis
+000002b0: 6974 416e 6452 6566 7265 7368 203d 2066  itAndRefresh = f
+000002c0: 756e 6374 696f 6e20 2865 6c29 207b 0a20  unction (el) {. 
+000002d0: 2020 2020 2020 2076 6172 2075 726c 203d         var url =
+000002e0: 2024 2865 6c29 2e61 7474 7228 2264 6174   $(el).attr("dat
+000002f0: 612d 6872 6566 2229 3b0a 2020 2020 2020  a-href");.      
+00000300: 2020 242e 6765 7428 7572 6c2c 2066 756e    $.get(url, fun
+00000310: 6374 696f 6e20 2829 207b 0a20 2020 2020  ction () {.     
+00000320: 2020 2020 2020 2077 696e 646f 772e 6c6f         window.lo
+00000330: 6361 7469 6f6e 2e72 656c 6f61 6428 293b  cation.reload();
+00000340: 0a20 2020 2020 2020 207d 293b 0a20 2020  .        });.   
+00000350: 207d 0a0a 2020 2020 6675 6e63 7469 6f6e   }..    function
+00000360: 2072 656e 616d 654e 6f74 6528 6964 2c20   renameNote(id, 
+00000370: 6f6c 644e 616d 6529 207b 0a20 2020 2020  oldName) {.     
+00000380: 2020 2078 6e6f 7465 2e70 726f 6d70 7428     xnote.prompt(
+00000390: 22e6 96b0 e590 8de7 a7b0 222c 206f 6c64  ".........", old
+000003a0: 4e61 6d65 2c20 6675 6e63 7469 6f6e 2028  Name, function (
+000003b0: 6e65 774e 616d 6529 207b 0a20 2020 2020  newName) {.     
+000003c0: 2020 2020 2020 2063 6f6e 736f 6c65 2e6c         console.l
+000003d0: 6f67 286e 6577 4e61 6d65 293b 0a20 2020  og(newName);.   
+000003e0: 2020 2020 2020 2020 2069 6620 286e 6577           if (new
+000003f0: 4e61 6d65 2021 3d20 2222 2026 2620 6e65  Name != "" && ne
+00000400: 774e 616d 6520 213d 206e 756c 6c29 207b  wName != null) {
+00000410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000420: 2024 2e70 6f73 7428 222f 6e6f 7465 2f72   $.post("/note/r
+00000430: 656e 616d 6522 2c20 7b69 643a 6964 2c20  ename", {id:id, 
+00000440: 6e61 6d65 3a6e 6577 4e61 6d65 7d2c 2066  name:newName}, f
+00000450: 756e 6374 696f 6e20 2872 6573 7029 207b  unction (resp) {
+00000460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000470: 2020 2020 2076 6172 2063 6f64 6520 3d20       var code = 
+00000480: 7265 7370 2e63 6f64 653b 0a20 2020 2020  resp.code;.     
+00000490: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000004a0: 6620 2863 6f64 6520 213d 2022 7375 6363  f (code != "succ
+000004b0: 6573 7322 2920 7b0a 2020 2020 2020 2020  ess") {.        
+000004c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000004d0: 616c 6572 7428 7265 7370 2e6d 6573 7361  alert(resp.messa
+000004e0: 6765 293b 0a20 2020 2020 2020 2020 2020  ge);.           
+000004f0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+00000500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00000510: 2020 2020 2020 2020 2020 2f2f 2024 2822            // $("
+00000520: 2366 696c 652d 222b 6964 292e 7465 7874  #file-"+id).text
+00000530: 286e 6577 4e61 6d65 293b 0a20 2020 2020  (newName);.     
+00000540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000550: 2020 2077 696e 646f 772e 6c6f 6361 7469     window.locati
+00000560: 6f6e 2e72 656c 6f61 6428 293b 0a20 2020  on.reload();.   
+00000570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000580: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00000590: 2020 207d 290a 2020 2020 2020 2020 2020     }).          
+000005a0: 2020 7d0a 2020 2020 2020 2020 7d29 3b0a    }.        });.
+000005b0: 2020 2020 7d0a 0a20 2020 2066 756e 6374      }..    funct
+000005c0: 696f 6e20 7265 6e61 6d65 4e6f 7465 4279  ion renameNoteBy
+000005d0: 4174 7472 2874 6172 6765 7429 207b 0a20  Attr(target) {. 
+000005e0: 2020 2020 2020 2076 6172 2069 6420 3d20         var id = 
+000005f0: 2428 7461 7267 6574 292e 6174 7472 2822  $(target).attr("
+00000600: 6461 7461 2d69 6422 293b 0a20 2020 2020  data-id");.     
+00000610: 2020 2076 6172 206f 6c64 4e61 6d65 203d     var oldName =
+00000620: 2024 2874 6172 6765 7429 2e61 7474 7228   $(target).attr(
+00000630: 2264 6174 612d 6e61 6d65 2229 3b0a 2020  "data-name");.  
+00000640: 2020 2020 2020 6966 2028 6964 203d 3d20        if (id == 
+00000650: 756e 6465 6669 6e65 6420 7c7c 2069 6420  undefined || id 
+00000660: 3d3d 2022 2229 207b 0a20 2020 2020 2020  == "") {.       
+00000670: 2020 2020 2078 6e6f 7465 2e61 6c65 7274       xnote.alert
+00000680: 2822 6461 7461 2d69 64e4 b8ba e7a9 ba22  ("data-id......"
+00000690: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
+000006a0: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+000006b0: 0a0a 2020 2020 2020 2020 6966 2028 6f6c  ..        if (ol
+000006c0: 644e 616d 6520 3d3d 2075 6e64 6566 696e  dName == undefin
+000006d0: 6564 207c 7c20 6f6c 644e 616d 6520 3d3d  ed || oldName ==
+000006e0: 2022 2229 207b 0a20 2020 2020 2020 2020   "") {.         
+000006f0: 2020 2078 6e6f 7465 2e61 6c65 7274 2822     xnote.alert("
+00000700: 6461 7461 2d6e 616d 65e4 b8ba e7a9 ba22  data-name......"
+00000710: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
+00000720: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+00000730: 0a0a 2020 2020 2020 2020 7265 6e61 6d65  ..        rename
+00000740: 4e6f 7465 2869 642c 206f 6c64 4e61 6d65  Note(id, oldName
+00000750: 293b 0a20 2020 207d 0a0a 2020 2020 6675  );.    }..    fu
+00000760: 6e63 7469 6f6e 2063 6865 636b 4e6f 7445  nction checkNotE
+00000770: 6d70 7479 286f 626a 6563 742c 206d 6573  mpty(object, mes
+00000780: 7361 6765 2920 7b0a 2020 2020 2020 2020  sage) {.        
+00000790: 6966 2028 6f62 6a65 6374 203d 3d3d 2075  if (object === u
+000007a0: 6e64 6566 696e 6564 207c 7c20 6f62 6a65  ndefined || obje
+000007b0: 6374 203d 3d3d 206e 756c 6c20 7c7c 206f  ct === null || o
+000007c0: 626a 6563 7420 3d3d 3d20 2222 2920 7b0a  bject === "") {.
+000007d0: 2020 2020 2020 2020 2020 2020 786e 6f74              xnot
+000007e0: 652e 616c 6572 7428 6d65 7373 6167 6529  e.alert(message)
+000007f0: 3b0a 2020 2020 2020 2020 2020 2020 7468  ;.            th
+00000800: 726f 7720 6e65 7720 4572 726f 7228 6d65  row new Error(me
+00000810: 7373 6167 6529 3b0a 2020 2020 2020 2020  ssage);.        
+00000820: 7d0a 2020 2020 7d0a 0a20 2020 2066 756e  }.    }..    fun
+00000830: 6374 696f 6e20 6361 6c6c 5f78 6e6f 7465  ction call_xnote
+00000840: 5f61 7069 2861 7069 2c20 7061 7261 6d73  _api(api, params
+00000850: 2920 7b0a 2020 2020 2020 2020 242e 706f  ) {.        $.po
+00000860: 7374 2861 7069 2c20 7061 7261 6d73 2c20  st(api, params, 
+00000870: 6675 6e63 7469 6f6e 2028 7265 7370 2920  function (resp) 
+00000880: 7b0a 2020 2020 2020 2020 2020 2020 6966  {.            if
+00000890: 2028 7265 7370 2e63 6f64 6520 213d 2022   (resp.code != "
+000008a0: 7375 6363 6573 7322 2920 7b0a 2020 2020  success") {.    
+000008b0: 2020 2020 2020 2020 2020 2020 786e 6f74              xnot
+000008c0: 652e 616c 6572 7428 7265 7370 2e6d 6573  e.alert(resp.mes
+000008d0: 7361 6765 293b 0a20 2020 2020 2020 2020  sage);.         
+000008e0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+000008f0: 2020 2020 2020 2020 2020 2020 786e 6f74              xnot
+00000900: 652e 746f 6173 7428 7265 7370 2e6d 6573  e.toast(resp.mes
+00000910: 7361 6765 293b 0a20 2020 2020 2020 2020  sage);.         
+00000920: 2020 2020 2020 2077 696e 646f 772e 6c6f         window.lo
+00000930: 6361 7469 6f6e 2e72 656c 6f61 6428 293b  cation.reload();
+00000940: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00000950: 2020 2020 2020 207d 292e 6661 696c 2866         }).fail(f
+00000960: 756e 6374 696f 6e20 2865 7272 6f72 2920  unction (error) 
+00000970: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
+00000980: 6e73 6f6c 652e 6572 726f 7228 6572 726f  nsole.error(erro
+00000990: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+000009a0: 786e 6f74 652e 616c 6572 7428 22e6 8ea5  xnote.alert("...
+000009b0: e58f a3e8 b083 e794 a8e5 a4b1 e8b4 a53a  ...............:
+000009c0: 2220 2b20 6572 726f 722e 7374 6174 7573  " + error.status
+000009d0: 202b 2022 2c22 202b 2065 7272 6f72 2e73   + "," + error.s
+000009e0: 7461 7475 7354 6578 7429 3b0a 2020 2020  tatusText);.    
+000009f0: 2020 2020 7d29 0a20 2020 207d 0a0a 2020      }).    }..  
+00000a00: 2020 2428 6675 6e63 7469 6f6e 2028 2920    $(function () 
+00000a10: 7b0a 0a20 2020 2020 2020 2066 756e 6374  {..        funct
+00000a20: 696f 6e20 6f6e 4e6f 7465 5265 6e61 6d65  ion onNoteRename
+00000a30: 4576 656e 7428 6576 656e 7429 207b 0a20  Event(event) {. 
+00000a40: 2020 2020 2020 2020 2020 2063 6f6e 736f             conso
+00000a50: 6c65 2e6c 6f67 2822 7265 6e61 6d65 2229  le.log("rename")
+00000a60: 3b0a 2020 2020 2020 2020 2020 2020 7661  ;.            va
+00000a70: 7220 7461 7267 6574 203d 2065 7665 6e74  r target = event
+00000a80: 2e74 6172 6765 743b 0a20 2020 2020 2020  .target;.       
+00000a90: 2020 2020 2072 656e 616d 654e 6f74 6542       renameNoteB
+00000aa0: 7941 7474 7228 7461 7267 6574 293b 0a20  yAttr(target);. 
+00000ab0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00000ac0: 200a 2020 2020 2020 2020 2428 222e 7265   .        $(".re
+00000ad0: 6e61 6d65 2d62 746e 2229 2e63 6c69 636b  name-btn").click
+00000ae0: 2866 756e 6374 696f 6e28 6576 656e 7429  (function(event)
+00000af0: 207b 0a20 2020 2020 2020 2020 2020 206f   {.            o
+00000b00: 6e4e 6f74 6552 656e 616d 6545 7665 6e74  nNoteRenameEvent
+00000b10: 2865 7665 6e74 293b 0a20 2020 2020 2020  (event);.       
+00000b20: 207d 293b 0a0a 2020 2020 2020 2020 2428   });..        $(
+00000b30: 222e 6e6f 7465 2d72 656e 616d 652d 6274  ".note-rename-bt
+00000b40: 6e22 292e 636c 6963 6b28 6675 6e63 7469  n").click(functi
+00000b50: 6f6e 2865 7665 6e74 2920 7b0a 2020 2020  on(event) {.    
+00000b60: 2020 2020 2020 2020 6f6e 4e6f 7465 5265          onNoteRe
+00000b70: 6e61 6d65 4576 656e 7428 6576 656e 7429  nameEvent(event)
+00000b80: 3b0a 2020 2020 2020 2020 7d29 3b0a 0a20  ;.        });.. 
+00000b90: 2020 2020 2020 2024 2822 2e73 7461 7475         $(".statu
+00000ba0: 732d 6274 6e22 292e 6561 6368 2866 756e  s-btn").each(fun
+00000bb0: 6374 696f 6e20 2869 6e64 6578 2c20 656c  ction (index, el
+00000bc0: 656d 656e 7429 207b 0a20 2020 2020 2020  ement) {.       
+00000bd0: 2020 2020 2076 6172 2073 7461 7475 7320       var status 
+00000be0: 3d20 2428 656c 656d 656e 7429 2e61 7474  = $(element).att
+00000bf0: 7228 2264 6174 612d 7374 6174 7573 2229  r("data-status")
+00000c00: 3b0a 2020 2020 2020 2020 2020 2020 6966  ;.            if
+00000c10: 2028 7374 6174 7573 203d 3d20 227b 7b66   (status == "{{f
+00000c20: 696c 652e 7072 696f 7269 7479 7d7d 2229  ile.priority}}")
+00000c30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00000c40: 2020 2024 2865 6c65 6d65 6e74 292e 6164     $(element).ad
+00000c50: 6443 6c61 7373 2822 782d 7461 622d 6274  dClass("x-tab-bt
+00000c60: 6e2d 6163 7469 7665 2229 3b0a 2020 2020  n-active");.    
+00000c70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00000c80: 2020 7d29 3b0a 0a20 2020 2020 2020 2024    });..        $
+00000c90: 2822 2e73 7461 7475 732d 6274 6e22 292e  (".status-btn").
+00000ca0: 636c 6963 6b28 6675 6e63 7469 6f6e 2865  click(function(e
+00000cb0: 7665 6e74 2920 7b0a 2020 2020 2020 2020  vent) {.        
+00000cc0: 2020 2020 7661 7220 6964 203d 2024 2865      var id = $(e
+00000cd0: 7665 6e74 2e74 6172 6765 7429 2e61 7474  vent.target).att
+00000ce0: 7228 2264 6174 612d 6964 2229 3b0a 2020  r("data-id");.  
+00000cf0: 2020 2020 2020 2020 2020 7661 7220 7374            var st
+00000d00: 6174 7573 203d 2024 2865 7665 6e74 2e74  atus = $(event.t
+00000d10: 6172 6765 7429 2e61 7474 7228 2264 6174  arget).attr("dat
+00000d20: 612d 7374 6174 7573 2229 3b0a 0a20 2020  a-status");..   
+00000d30: 2020 2020 2020 2020 2063 6865 636b 4e6f           checkNo
+00000d40: 7445 6d70 7479 2869 642c 2022 6461 7461  tEmpty(id, "data
+00000d50: 2d69 64e4 b8ba e7a9 ba22 293b 0a20 2020  -id......");.   
+00000d60: 2020 2020 2020 2020 2063 6865 636b 4e6f           checkNo
+00000d70: 7445 6d70 7479 2873 7461 7475 732c 2022  tEmpty(status, "
+00000d80: 6461 7461 2d73 7461 7475 73e4 b8ba e7a9  data-status.....
+00000d90: ba22 293b 0a0a 2020 2020 2020 2020 2020  .");..          
+00000da0: 2020 786e 6f74 652e 6874 7470 2e70 6f73    xnote.http.pos
+00000db0: 7428 222f 6e6f 7465 2f73 7461 7475 7322  t("/note/status"
+00000dc0: 2c20 7b69 643a 2069 642c 2073 7461 7475  , {id: id, statu
+00000dd0: 733a 2073 7461 7475 737d 2c20 6675 6e63  s: status}, func
+00000de0: 7469 6f6e 2028 7265 7370 2920 7b0a 2020  tion (resp) {.  
+00000df0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00000e00: 7220 636f 6465 203d 2072 6573 702e 636f  r code = resp.co
+00000e10: 6465 3b0a 2020 2020 2020 2020 2020 2020  de;.            
+00000e20: 2020 2020 6966 2028 636f 6465 2021 3d20      if (code != 
+00000e30: 2273 7563 6365 7373 2229 207b 0a20 2020  "success") {.   
+00000e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000e50: 2078 6e6f 7465 2e61 6c65 7274 2872 6573   xnote.alert(res
+00000e60: 702e 6d65 7373 6167 6529 3b0a 2020 2020  p.message);.    
+00000e70: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00000e80: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+00000e90: 2020 2020 2020 2020 2078 6e6f 7465 2e74           xnote.t
+00000ea0: 6f61 7374 2872 6573 702e 6d65 7373 6167  oast(resp.messag
+00000eb0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00000ec0: 2020 2020 2020 2020 7769 6e64 6f77 2e6c          window.l
+00000ed0: 6f63 6174 696f 6e2e 7265 6c6f 6164 2829  ocation.reload()
+00000ee0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00000ef0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00000f00: 7d29 0a20 2020 2020 2020 207d 293b 0a0a  }).        });..
+00000f10: 2020 2020 2020 2020 2428 222e 6f72 6465          $(".orde
+00000f20: 7262 792d 6274 6e22 292e 6561 6368 2866  rby-btn").each(f
+00000f30: 756e 6374 696f 6e20 2869 6e64 6578 2c20  unction (index, 
+00000f40: 656c 656d 656e 7429 207b 0a20 2020 2020  element) {.     
+00000f50: 2020 2020 2020 2076 6172 206f 7264 6572         var order
+00000f60: 6279 203d 2024 2865 6c65 6d65 6e74 292e  by = $(element).
+00000f70: 6174 7472 2822 6461 7461 2d6f 7264 6572  attr("data-order
+00000f80: 6279 2229 3b0a 2020 2020 2020 2020 2020  by");.          
+00000f90: 2020 6966 2028 6f72 6465 7262 7920 3d3d    if (orderby ==
+00000fa0: 2022 7b7b 6669 6c65 2e6f 7264 6572 6279   "{{file.orderby
+00000fb0: 7d7d 2229 207b 0a20 2020 2020 2020 2020  }}") {.         
+00000fc0: 2020 2020 2020 2024 2865 6c65 6d65 6e74         $(element
+00000fd0: 292e 6164 6443 6c61 7373 2822 782d 7461  ).addClass("x-ta
+00000fe0: 622d 6274 6e2d 6163 7469 7665 2229 3b0a  b-btn-active");.
+00000ff0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00001000: 2020 2020 2020 7d29 3b0a 0a20 2020 2020        });..     
+00001010: 2020 2024 2822 2e6f 7264 6572 6279 2d62     $(".orderby-b
+00001020: 746e 2229 2e63 6c69 636b 2866 756e 6374  tn").click(funct
+00001030: 696f 6e20 2865 7665 6e74 2920 7b0a 2020  ion (event) {.  
+00001040: 2020 2020 2020 2020 2020 7661 7220 6964            var id
+00001050: 203d 2024 2865 7665 6e74 2e74 6172 6765   = $(event.targe
+00001060: 7429 2e61 7474 7228 2264 6174 612d 6964  t).attr("data-id
+00001070: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
+00001080: 7661 7220 6f72 6465 7262 7920 3d20 2428  var orderby = $(
+00001090: 6576 656e 742e 7461 7267 6574 292e 6174  event.target).at
+000010a0: 7472 2822 6461 7461 2d6f 7264 6572 6279  tr("data-orderby
+000010b0: 2229 3b0a 0a20 2020 2020 2020 2020 2020  ");..           
+000010c0: 2063 6865 636b 4e6f 7445 6d70 7479 2869   checkNotEmpty(i
+000010d0: 642c 2022 6461 7461 2d69 64e4 b8ba e7a9  d, "data-id.....
+000010e0: ba22 293b 0a20 2020 2020 2020 2020 2020  .");.           
+000010f0: 2063 6865 636b 4e6f 7445 6d70 7479 286f   checkNotEmpty(o
+00001100: 7264 6572 6279 2c20 2264 6174 612d 6f72  rderby, "data-or
+00001110: 6465 7262 79e4 b8ba e7a9 ba22 293b 0a0a  derby......");..
+00001120: 2020 2020 2020 2020 2020 2020 786e 6f74              xnot
+00001130: 652e 6874 7470 2e70 6f73 7428 222f 6e6f  e.http.post("/no
+00001140: 7465 2f6f 7264 6572 6279 222c 207b 6964  te/orderby", {id
+00001150: 3a20 6964 2c20 6f72 6465 7262 793a 206f  : id, orderby: o
+00001160: 7264 6572 6279 7d2c 2066 756e 6374 696f  rderby}, functio
+00001170: 6e20 2872 6573 7029 207b 0a20 2020 2020  n (resp) {.     
+00001180: 2020 2020 2020 2020 2020 2076 6172 2063             var c
+00001190: 6f64 6520 3d20 7265 7370 2e63 6f64 653b  ode = resp.code;
+000011a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000011b0: 2069 6620 2863 6f64 6520 213d 2022 7375   if (code != "su
+000011c0: 6363 6573 7322 2920 7b0a 2020 2020 2020  ccess") {.      
+000011d0: 2020 2020 2020 2020 2020 2020 2020 786e                xn
+000011e0: 6f74 652e 616c 6572 7428 7265 7370 2e6d  ote.alert(resp.m
+000011f0: 6573 7361 6765 293b 0a20 2020 2020 2020  essage);.       
+00001200: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+00001210: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00001220: 2020 2020 2020 786e 6f74 652e 746f 6173        xnote.toas
+00001230: 7428 7265 7370 2e6d 6573 7361 6765 293b  t(resp.message);
+00001240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001250: 2020 2020 2077 696e 646f 772e 6c6f 6361       window.loca
+00001260: 7469 6f6e 2e72 656c 6f61 6428 293b 0a20  tion.reload();. 
+00001270: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00001280: 0a20 2020 2020 2020 2020 2020 207d 290a  .            }).
+00001290: 2020 2020 2020 2020 7d29 3b0a 0a20 2020          });..   
+000012a0: 2020 2020 2066 756e 6374 696f 6e20 6e6f       function no
+000012b0: 7465 5f73 6861 7265 5f62 795f 6c69 6e6b  te_share_by_link
+000012c0: 2874 6172 6765 7429 207b 0a20 2020 2020  (target) {.     
+000012d0: 2020 2020 2020 202f 2a20 4163 7420 6f6e         /* Act on
+000012e0: 2074 6865 2065 7665 6e74 202a 2f0a 2020   the event */.  
+000012f0: 2020 2020 2020 2020 2020 242e 706f 7374            $.post
+00001300: 2822 2f6e 6f74 652f 6c69 6e6b 5f73 6861  ("/note/link_sha
+00001310: 7265 222c 207b 6964 3a20 227b 7b66 696c  re", {id: "{{fil
+00001320: 652e 6964 7d7d 227d 2c20 6675 6e63 7469  e.id}}"}, functi
+00001330: 6f6e 2028 7265 7370 2920 7b0a 2020 2020  on (resp) {.    
+00001340: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00001350: 7265 7370 2e63 6f64 6520 3d3d 2022 7375  resp.code == "su
+00001360: 6363 6573 7322 2920 7b0a 2020 2020 2020  ccess") {.      
+00001370: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00001380: 7220 6c69 6e6b 203d 2077 696e 646f 772e  r link = window.
+00001390: 6c6f 6361 7469 6f6e 2e70 726f 746f 636f  location.protoco
+000013a0: 6c20 2b20 222f 2f22 202b 2077 696e 646f  l + "//" + windo
+000013b0: 772e 6c6f 6361 7469 6f6e 2e68 6f73 7420  w.location.host 
+000013c0: 2b20 7265 7370 2e64 6174 613b 0a20 2020  + resp.data;.   
+000013d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013e0: 2024 2822 2e6e 6f74 652d 7368 6172 652d   $(".note-share-
+000013f0: 6c69 6e6b 2d74 6578 7422 292e 7465 7874  link-text").text
+00001400: 286c 696e 6b29 3b0a 2020 2020 2020 2020  (link);.        
+00001410: 2020 2020 2020 2020 2020 2020 2428 222e              $(".
+00001420: 6e6f 7465 2d73 6861 7265 2d6c 696e 6b2d  note-share-link-
+00001430: 6274 6e22 292e 6174 7472 2822 6461 7461  btn").attr("data
+00001440: 2d63 6c69 7062 6f61 7264 2d74 6578 7422  -clipboard-text"
+00001450: 2c20 6c69 6e6b 293b 0a0a 2020 2020 2020  , link);..      
+00001460: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00001470: 7220 6874 6d6c 203d 2024 2822 2e73 6861  r html = $(".sha
+00001480: 7265 2d74 706c 2229 2e68 746d 6c28 293b  re-tpl").html();
+00001490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000014a0: 2020 2020 206c 6179 6572 2e63 6f6e 6669       layer.confi
+000014b0: 726d 2868 746d 6c2c 207b 0a20 2020 2020  rm(html, {.     
+000014c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014d0: 2020 2062 746e 3a20 5b5d 202f 2fe6 8c89     btn: [] //...
+000014e0: e992 ae0a 2020 2020 2020 2020 2020 2020  ....            
+000014f0: 2020 2020 2020 2020 7d29 3b0a 2020 2020          });.    
+00001500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001510: 6e65 7720 436c 6970 626f 6172 644a 5328  new ClipboardJS(
+00001520: 272e 6e6f 7465 2d73 6861 7265 2d6c 696e  '.note-share-lin
+00001530: 6b2d 6274 6e27 2c20 7b0a 2020 2020 2020  k-btn', {.      
+00001540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001550: 2020 7465 7874 3a20 6675 6e63 7469 6f6e    text: function
+00001560: 2874 7269 6767 6572 2920 7b0a 2020 2020  (trigger) {.    
+00001570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001580: 2020 2020 2020 2020 786e 6f74 652e 746f          xnote.to
+00001590: 6173 7428 22e5 b7b2 e7bb 8fe5 a48d e588  ast("...........
+000015a0: b6e5 88b0 e7b2 98e8 b4b4 e69d bf22 293b  .............");
+000015b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000015c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000015d0: 7572 6e20 7472 6967 6765 722e 6765 7441  urn trigger.getA
+000015e0: 7474 7269 6275 7465 2827 6461 7461 2d63  ttribute('data-c
+000015f0: 6c69 7062 6f61 7264 2d74 6578 7427 293b  lipboard-text');
+00001600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001610: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00001620: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00001630: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00001640: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00001650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001660: 786e 6f74 652e 616c 6572 7428 22e5 8886  xnote.alert("...
+00001670: e4ba abe5 a4b1 e8b4 a521 2229 3b0a 2020  .........!");.  
+00001680: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00001690: 2020 2020 2020 2020 2020 2020 7d29 3b0a              });.
+000016a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000016b0: 2020 2077 696e 646f 772e 6e6f 7465 5f73     window.note_s
+000016c0: 6861 7265 5f62 795f 6c69 6e6b 203d 206e  hare_by_link = n
+000016d0: 6f74 655f 7368 6172 655f 6279 5f6c 696e  ote_share_by_lin
+000016e0: 6b3b 0a0a 2020 2020 2020 2020 2428 222e  k;..        $(".
+000016f0: 636f 7079 2d6c 696e 6b2d 6f70 7469 6f6e  copy-link-option
+00001700: 2229 2e63 6c69 636b 2866 756e 6374 696f  ").click(functio
+00001710: 6e28 6576 656e 7429 207b 0a20 2020 2020  n(event) {.     
+00001720: 2020 2020 2020 2024 2822 2e63 6f70 792d         $(".copy-
+00001730: 6c69 6e6b 2d6f 7074 696f 6e22 292e 6174  link-option").at
+00001740: 7472 2827 6461 7461 2d63 6c69 7062 6f61  tr('data-clipboa
+00001750: 7264 2d74 6578 7427 2c20 7769 6e64 6f77  rd-text', window
+00001760: 2e6c 6f63 6174 696f 6e2e 6872 6566 293b  .location.href);
+00001770: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00001780: 2043 6c69 7062 6f61 7264 4a53 2822 2e63   ClipboardJS(".c
+00001790: 6f70 792d 6c69 6e6b 2d6f 7074 696f 6e22  opy-link-option"
+000017a0: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
+000017b0: 2020 2020 7465 7874 3a20 6675 6e63 7469      text: functi
+000017c0: 6f6e 2028 7472 6967 6765 7229 207b 0a20  on (trigger) {. 
+000017d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000017e0: 2020 2078 6e6f 7465 2e74 6f61 7374 2822     xnote.toast("
+000017f0: e5b7 b2e7 bb8f e5a4 8de5 88b6 e588 b0e7  ................
+00001800: b298 e8b4 b4e6 9dbf 2229 3b0a 2020 2020  ........");.    
+00001810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001820: 7265 7475 726e 2074 7269 6767 6572 2e67  return trigger.g
+00001830: 6574 4174 7472 6962 7574 6528 2264 6174  etAttribute("dat
+00001840: 612d 636c 6970 626f 6172 642d 7465 7874  a-clipboard-text
+00001850: 2229 3b0a 2020 2020 2020 2020 2020 2020  ");.            
+00001860: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00001870: 2020 7d29 3b0a 2020 2020 2020 2020 7d29    });.        })
+00001880: 3b0a 0a20 2020 2020 2020 202f 2f20 e698  ;..        // ..
+00001890: bee7 a4ba e79b aee5 bd95 e5bc b9e7 aa97  ................
+000018a0: 0a20 2020 2020 2020 2024 2822 2e6e 6f74  .        $(".not
+000018b0: 652d 636f 6e74 656e 7473 2d62 746e 2229  e-contents-btn")
+000018c0: 2e63 6c69 636b 2866 756e 6374 696f 6e20  .click(function 
+000018d0: 2865 2920 7b0a 2020 2020 2020 2020 2020  (e) {.          
+000018e0: 2020 7661 7220 7061 7265 6e74 4964 203d    var parentId =
+000018f0: 2024 2865 2e74 6172 6765 7429 2e61 7474   $(e.target).att
+00001900: 7228 2264 6174 612d 7061 7265 6e74 2229  r("data-parent")
+00001910: 3b0a 2020 2020 2020 2020 2020 2020 786e  ;.            xn
+00001920: 6f74 652e 7368 6f77 416a 6178 4469 616c  ote.showAjaxDial
+00001930: 6f67 2822 e980 89e6 8ba9 e7ac 94e8 aeb0  og("............
+00001940: 222c 2022 2f6e 6f74 652f 2220 2b20 7061  ", "/note/" + pa
+00001950: 7265 6e74 4964 202b 2022 3f64 6961 6c6f  rentId + "?dialo
+00001960: 673d 7472 7565 2229 3b0a 2020 2020 2020  g=true");.      
+00001970: 2020 7d29 3b0a 0a20 2020 2020 2020 202f    });..        /
+00001980: 2f20 e7a7 bbe5 8aa8 e7ac 94e8 aeb0 0a20  / ............. 
+00001990: 2020 2020 2020 2024 2822 2e6d 6f76 652d         $(".move-
+000019a0: 6274 6e22 292e 636c 6963 6b28 6675 6e63  btn").click(func
+000019b0: 7469 6f6e 2028 6529 207b 0a20 2020 2020  tion (e) {.     
+000019c0: 2020 2020 2020 2076 6172 2072 6571 203d         var req =
+000019d0: 207b 7d3b 0a20 2020 2020 2020 2020 2020   {};.           
+000019e0: 2072 6571 2e63 616c 6c62 6163 6b20 3d20   req.callback = 
+000019f0: 6675 6e63 7469 6f6e 2028 7061 7265 6e74  function (parent
+00001a00: 4964 2920 7b0a 2020 2020 2020 2020 2020  Id) {.          
+00001a10: 2020 2020 2020 6966 2028 7061 7265 6e74        if (parent
+00001a20: 4964 203d 3d3d 2075 6e64 6566 696e 6564  Id === undefined
+00001a30: 207c 7c20 7061 7265 6e74 4964 203d 3d20   || parentId == 
+00001a40: 2222 2920 7b0a 2020 2020 2020 2020 2020  "") {.          
+00001a50: 2020 2020 2020 2020 2020 786e 6f74 652e            xnote.
+00001a60: 616c 6572 7428 2270 6172 656e 7449 6420  alert("parentId 
+00001a70: 6973 2075 6e64 6566 696e 6564 2229 3b0a  is undefined");.
+00001a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a90: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00001aa0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00001ab0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00001ac0: 7220 6e6f 7465 4964 203d 2022 7b7b 6669  r noteId = "{{fi
+00001ad0: 6c65 2e69 647d 7d22 3b0a 2020 2020 2020  le.id}}";.      
+00001ae0: 2020 2020 2020 2020 2020 786e 6f74 652e            xnote.
+00001af0: 6874 7470 2e70 6f73 7428 222f 6e6f 7465  http.post("/note
+00001b00: 2f6d 6f76 6522 2c20 7b20 6964 3a20 6e6f  /move", { id: no
+00001b10: 7465 4964 2c20 7061 7265 6e74 5f69 643a  teId, parent_id:
+00001b20: 2070 6172 656e 7449 6420 7d2c 2066 756e   parentId }, fun
+00001b30: 6374 696f 6e20 2872 6573 7029 207b 0a20  ction (resp) {. 
+00001b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b50: 2020 2063 6f6e 736f 6c65 2e6c 6f67 2872     console.log(r
+00001b60: 6573 7029 3b0a 2020 2020 2020 2020 2020  esp);.          
+00001b70: 2020 2020 2020 2020 2020 7769 6e64 6f77            window
+00001b80: 2e6c 6f63 6174 696f 6e2e 7265 6c6f 6164  .location.reload
+00001b90: 2829 3b0a 2020 2020 2020 2020 2020 2020  ();.            
+00001ba0: 2020 2020 7d29 3b0a 2020 2020 2020 2020      });.        
+00001bb0: 2020 2020 7d3b 0a20 2020 2020 2020 2020      };.         
+00001bc0: 2020 2078 6e6f 7465 2e6e 6f74 652e 7365     xnote.note.se
+00001bd0: 6c65 6374 4772 6f75 7046 6c61 7428 7265  lectGroupFlat(re
+00001be0: 7129 3b0a 2020 2020 2020 2020 7d29 3b0a  q);.        });.
+00001bf0: 2020 2020 7d29 0a3c 2f73 6372 6970 743e      }).</script>
+00001c00: 0a0a 7b25 2069 6e63 6c75 6465 206e 6f74  ..{% include not
+00001c10: 652f 636f 6d70 6f6e 656e 742f 7363 7269  e/component/scri
+00001c20: 7074 2f64 656c 6574 655f 7363 7269 7074  pt/delete_script
+00001c30: 2e68 746d 6c20 257d                      .html %}
```

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-layout.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-layout.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-photo.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-photo.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-tab.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-tab.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-template.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-template.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-upload.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-upload.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/js/xnote-ui/x-url.js` & `xnote-web-0.1.1/static/js/xnote-ui/x-url.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/JsBarcode/JsBarcode.all.min.js` & `xnote-web-0.1.1/static/lib/JsBarcode/JsBarcode.all.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/art-template/template-web-4.13.2.js` & `xnote-web-0.1.1/static/lib/art-template/template-web-4.13.2.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/base64.js/base64.js` & `xnote-web-0.1.1/static/lib/base64.js/base64.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/bootstrap/bootstrap-3.3.5.min.css` & `xnote-web-0.1.1/static/lib/bootstrap/bootstrap-3.3.5.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/clipboard/clipboard-2.0.4.min.js` & `xnote-web-0.1.1/static/lib/clipboard/clipboard-2.0.4.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/5.41.0/codemirror.min.css` & `xnote-web-0.1.1/static/lib/codemirror/5.41.0/codemirror.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/5.41.0/codemirror.min.js` & `xnote-web-0.1.1/static/lib/codemirror/5.41.0/codemirror.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/5.65.12/codemirror.css` & `xnote-web-0.1.1/static/lib/codemirror/5.65.12/codemirror.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/5.65.12/codemirror.js` & `xnote-web-0.1.1/static/lib/codemirror/5.65.12/codemirror.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/dialog/dialog.css` & `xnote-web-0.1.1/static/lib/codemirror/addon/dialog/dialog.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/dialog/dialog.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/dialog/dialog.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/anyword-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/anyword-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/css-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/css-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/html-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/html-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/javascript-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/javascript-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/show-hint.css` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/show-hint.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/show-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/show-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/sql-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/sql-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/hint/xml-hint.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/hint/xml-hint.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/search/jump-to-line.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/search/jump-to-line.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/search/search.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/search/search.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/addon/search/searchcursor.js` & `xnote-web-0.1.1/static/lib/codemirror/addon/search/searchcursor.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/codemirror.min.css` & `xnote-web-0.1.1/static/lib/codemirror/codemirror.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/codemirror.min.js` & `xnote-web-0.1.1/static/lib/codemirror/codemirror.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/keymap/sublime.js` & `xnote-web-0.1.1/static/lib/codemirror/keymap/sublime.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/clike/clike.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/clike/clike.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/css.min.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/css.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/javascript.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/javascript.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/markdown.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/markdown.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/php.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/php.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/properties.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/properties.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/python.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/python.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/shell.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/shell.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/mode/sql.min.js` & `xnote-web-0.1.1/static/lib/codemirror/mode/sql.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/theme/eclipse.css` & `xnote-web-0.1.1/static/lib/codemirror/theme/eclipse.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/theme/monokai.min.css` & `xnote-web-0.1.1/static/lib/codemirror/theme/monokai.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/codemirror/theme/xq-light.css` & `xnote-web-0.1.1/static/lib/codemirror/theme/xq-light.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/csv.js/csv.js` & `xnote-web-0.1.1/static/lib/csv.js/csv.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/d3/d3.js` & `xnote-web-0.1.1/static/lib/d3/d3.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/d3/d3.min.js` & `xnote-web-0.1.1/static/lib/d3/d3.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/exif-js/exif.js` & `xnote-web-0.1.1/static/lib/exif-js/exif.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/css/font-awesome.css` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/css/font-awesome.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/css/font-awesome.min.css` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/css/font-awesome.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/FontAwesome.otf` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/FontAwesome.otf`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.eot` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.eot`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.svg` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.ttf` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.ttf`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff2` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/fonts/fontawesome-webfont.woff2`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/animated.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/animated.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/bordered-pulled.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/bordered-pulled.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/font-awesome.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/font-awesome.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/icons.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/icons.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/mixins.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/mixins.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/path.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/path.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/rotated-flipped.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/rotated-flipped.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/less/variables.less` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/less/variables.less`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_animated.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_animated.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_bordered-pulled.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_bordered-pulled.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_icons.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_icons.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_mixins.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_mixins.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_path.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_path.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_rotated-flipped.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_rotated-flipped.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/font-awesome-4.7.0/scss/_variables.scss` & `xnote-web-0.1.1/static/lib/font-awesome-4.7.0/scss/_variables.scss`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/highlight.js/11.6.0/highlight.min.js` & `xnote-web-0.1.1/static/lib/highlight.js/11.6.0/highlight.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/highlight.js/11.6.0/styles/default.min.css` & `xnote-web-0.1.1/static/lib/highlight.js/11.6.0/styles/default.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css` & `xnote-web-0.1.1/static/lib/highlight.js/11.7.0/styles/a11y-dark.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jexcel.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jexcel.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jexcel.min.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jexcel.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.min.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jcalendar.min.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jcalendar.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.min.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jdropdown.min.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jdropdown.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.min.css` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jexcel/2.0.2/jquery.jexcel.min.js` & `xnote-web-0.1.1/static/lib/jexcel/2.0.2/jquery.jexcel.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery/jquery-1.12.4.min.js` & `xnote-web-0.1.1/static/lib/jquery/jquery-1.12.4.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery-url-parser/purl.min.js` & `xnote-web-0.1.1/static/lib/jquery-url-parser/purl.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery.qrcode/jquery.qrcode.min.js` & `xnote-web-0.1.1/static/lib/jquery.qrcode/jquery.qrcode.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery.terminal/dterm.js` & `xnote-web-0.1.1/static/lib/jquery.terminal/dterm.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.css` & `xnote-web-0.1.1/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.js` & `xnote-web-0.1.1/static/lib/jquery.terminal/jquery.terminal-1.3.1.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jsdiff/diff.js` & `xnote-web-0.1.1/static/lib/jsdiff/diff.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/README.md` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/README.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/WEBCOMPONENT.md` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/WEBCOMPONENT.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.css` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.js` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/deps/jsuites.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.css` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.js` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.theme.css` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/dist/jexcel.theme.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/de_DE.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/de_DE.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/en_GB.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/en_GB.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/fr_FR.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/fr_FR.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/it_IT.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/it_IT.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/pt_BR.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/pt_BR.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/lang/zh_CN.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/lang/zh_CN.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/package.json` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/package.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/jspreadsheet-ce-4.6.0/webcomponent-spreadsheet.md` & `xnote-web-0.1.1/static/lib/jspreadsheet-ce-4.6.0/webcomponent-spreadsheet.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/laydate.js` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/laydate.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.eot` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.eot`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.svg` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.svg`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.ttf` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.ttf`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/font/iconfont.woff` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/font/iconfont.woff`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layDate-v5.0.9/theme/default/laydate.css` & `xnote-web-0.1.1/static/lib/layDate-v5.0.9/theme/default/laydate.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/layer.full.js` & `xnote-web-0.1.1/static/lib/layer/layer.full.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/layer.js` & `xnote-web-0.1.1/static/lib/layer/layer.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/mobile/layer.js` & `xnote-web-0.1.1/static/lib/layer/mobile/layer.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/mobile/need/layer.css` & `xnote-web-0.1.1/static/lib/layer/mobile/need/layer.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/icon-ext.png` & `xnote-web-0.1.1/static/lib/layer/theme/default/icon-ext.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/icon.png` & `xnote-web-0.1.1/static/lib/layer/theme/default/icon.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/layer.css` & `xnote-web-0.1.1/static/lib/layer/theme/default/layer.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/loading-0.gif` & `xnote-web-0.1.1/static/lib/layer/theme/default/loading-0.gif`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/loading-1.gif` & `xnote-web-0.1.1/static/lib/layer/theme/default/loading-1.gif`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/layer/theme/default/loading-2.gif` & `xnote-web-0.1.1/static/lib/layer/theme/default/loading-2.gif`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/marked/marked.js` & `xnote-web-0.1.1/static/lib/marked/marked.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/md5.js` & `xnote-web-0.1.1/static/lib/md5.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/package-lock.json` & `xnote-web-0.1.1/static/lib/package-lock.json`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/quarkjs/quark.base-1.0.0.min.js` & `xnote-web-0.1.1/static/lib/quarkjs/quark.base-1.0.0.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/require-2.1.17.js` & `xnote-web-0.1.1/static/lib/require-2.1.17.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/requirejs/require-2.3.6.js` & `xnote-web-0.1.1/static/lib/requirejs/require-2.3.6.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/string-format/string-format.js` & `xnote-web-0.1.1/static/lib/string-format/string-format.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/string-format/string-format.min.js` & `xnote-web-0.1.1/static/lib/string-format/string-format.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/string.js/string-3.3.1.min.js` & `xnote-web-0.1.1/static/lib/string.js/string-3.3.1.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/string.js/string.js` & `xnote-web-0.1.1/static/lib/string.js/string.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/utf.js` & `xnote-web-0.1.1/static/lib/utf.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/vue/vue-2.2.6.min.js` & `xnote-web-0.1.1/static/lib/vue/vue-2.2.6.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/vue/vue-2.7.9.min.js` & `xnote-web-0.1.1/static/lib/vue/vue-2.7.9.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/wangEditor/wangEditor-3.1.1.min.js` & `xnote-web-0.1.1/static/lib/wangEditor/wangEditor-3.1.1.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/webuploader/README.md` & `xnote-web-0.1.1/static/lib/webuploader/README.md`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/webuploader/Uploader.swf` & `xnote-web-0.1.1/static/lib/webuploader/Uploader.swf`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/webuploader/webuploader.css` & `xnote-web-0.1.1/static/lib/webuploader/webuploader.css`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/lib/webuploader/webuploader.nolog.min.js` & `xnote-web-0.1.1/static/lib/webuploader/webuploader.nolog.min.js`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/xnote.pdn` & `xnote-web-0.1.1/static/xnote.pdn`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/static/xnote.png` & `xnote-web-0.1.1/static/xnote.png`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_admin.py` & `xnote-web-0.1.1/tests/test_admin.py`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,100 +1,100 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-10-14 09:30:29
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-31 14:37:13
-@FilePath     : /xnote/tests/test_admin.py
-@Description  : 描述
-"""
-
-from . import test_base
-from xnote.core import xconfig, xmanager, xauth
-import web.utils
-from xnote.service import JobService
-
-app = test_base.init()
-
-class TestMain(test_base.BaseTestCase):
-    """测试管理后台的功能"""
-    
-    def test_db_struct(self):
-        self.check_OK("/system/db/struct?table_name=user")
-        
-        
-    def assert_no_auth(self, response):
-        if response.status == "401 Unauthorized":
-            return
-        
-        if "/unauthorized" in response.headers['Location']:
-            return
-        raise Exception("发现权限拦截漏洞")
-
-    def test_admin_auth(self):
-        print("")
-        
-        skip_list = set([
-            "/system/settings",
-            "/system/stats",
-            "/system/stats/location",
-            "/system/index",
-            "/system/sys",
-            "/system/system",
-            r"/system/user\.css",
-            r"/system/user\.js",
-            "/system/log/visit",
-            "/system/todo",
-        ])
-
-        check_list = set([
-            "/plugins_upload",
-            "/plugins_new",
-            "/plugins_new/command",
-        ])
-
-        try:
-            # 登录普通用户
-            xauth.TestEnv.login_user("test")
-
-            mapping = xmanager.get_handler_manager().mapping
-            
-            for pattern, raw_handler in web.utils.group(mapping, 2):
-                if pattern in skip_list:
-                    continue
-                if pattern.startswith("/system/") or pattern in check_list or pattern.startswith("/admin/"):
-                    print(f"Check {pattern} ...")
-                    handler = raw_handler.handler_class
-                    check_pass = False
-                    if hasattr(handler, "GET"):
-                        response = self.request_app(pattern, method="GET")
-                        self.assert_no_auth(response)
-                        check_pass = True
-                    
-                    if hasattr(handler, "POST"):
-                        response = self.request_app(pattern, method="POST")
-                        self.assert_no_auth(response)
-                        check_pass = True
-                    assert check_pass
-        finally:
-            xauth.TestEnv.login_user("admin")
-        
-    def test_admin_functions(self):
-        self.check_OK("/admin/functions")
-
-    def test_admin_job(self):
-        self.check_OK("/admin/test_job")
-        self.check_OK("/admin/jobs")
-        
-        job_list, amount = JobService.list_job_page()
-        assert len(job_list) > 0
-        assert amount > 0
-        
-        job_id = job_list[0].id
-        
-        self.check_OK(f"/admin/jobs?action=view&job_id={job_id}")
-        self.check_OK(f"/admin/jobs?action=edit&job_id={job_id}")
-        self.check_OK(f"/admin/jobs?action=delete&job_id={job_id}")
-        
-    def test_example(self):
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-10-14 09:30:29
+@LastEditors  : xupingmao
+@LastEditTime : 2024-03-31 14:37:13
+@FilePath     : /xnote/tests/test_admin.py
+@Description  : 描述
+"""
+
+from . import test_base
+from xnote.core import xconfig, xmanager, xauth
+import web.utils
+from xnote.service import JobService
+
+app = test_base.init()
+
+class TestMain(test_base.BaseTestCase):
+    """测试管理后台的功能"""
+    
+    def test_db_struct(self):
+        self.check_OK("/system/db/struct?table_name=user")
+        
+        
+    def assert_no_auth(self, response):
+        if response.status == "401 Unauthorized":
+            return
+        
+        if "/unauthorized" in response.headers['Location']:
+            return
+        raise Exception("发现权限拦截漏洞")
+
+    def test_admin_auth(self):
+        print("")
+        
+        skip_list = set([
+            "/system/settings",
+            "/system/stats",
+            "/system/stats/location",
+            "/system/index",
+            "/system/sys",
+            "/system/system",
+            r"/system/user\.css",
+            r"/system/user\.js",
+            "/system/log/visit",
+            "/system/todo",
+        ])
+
+        check_list = set([
+            "/plugins_upload",
+            "/plugins_new",
+            "/plugins_new/command",
+        ])
+
+        try:
+            # 登录普通用户
+            xauth.TestEnv.login_user("test")
+
+            mapping = xmanager.get_handler_manager().mapping
+            
+            for pattern, raw_handler in web.utils.group(mapping, 2):
+                if pattern in skip_list:
+                    continue
+                if pattern.startswith("/system/") or pattern in check_list or pattern.startswith("/admin/"):
+                    print(f"Check {pattern} ...")
+                    handler = raw_handler.handler_class
+                    check_pass = False
+                    if hasattr(handler, "GET"):
+                        response = self.request_app(pattern, method="GET")
+                        self.assert_no_auth(response)
+                        check_pass = True
+                    
+                    if hasattr(handler, "POST"):
+                        response = self.request_app(pattern, method="POST")
+                        self.assert_no_auth(response)
+                        check_pass = True
+                    assert check_pass
+        finally:
+            xauth.TestEnv.login_user("admin")
+        
+    def test_admin_functions(self):
+        self.check_OK("/admin/functions")
+
+    def test_admin_job(self):
+        self.check_OK("/admin/test_job")
+        self.check_OK("/admin/jobs")
+        
+        job_list, amount = JobService.list_job_page()
+        assert len(job_list) > 0
+        assert amount > 0
+        
+        job_id = job_list[0].id
+        
+        self.check_OK(f"/admin/jobs?action=view&job_id={job_id}")
+        self.check_OK(f"/admin/jobs?action=edit&job_id={job_id}")
+        self.check_OK(f"/admin/jobs?action=delete&job_id={job_id}")
+        
+    def test_example(self):
         self.check_OK("/test/example/table")
```

### Comparing `xnote-web-0.1.0/tests/test_app.py` & `xnote-web-0.1.1/tests/test_app.py`

 * *Ordering differences only*

 * *Files 17% similar despite different names*

```diff
@@ -1,442 +1,442 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2017-05-23 00:30:19
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-20 16:42:38
-@FilePath     : /xnote/tests/test_app.py
-@Description  : 描述
-"""
-
-import os
-import xutils
-from xnote.core import xtemplate, xconfig, xtables, xauth, xmanager
-from xutils import logutil
-from . import test_base
-from .test_base import ResponseWrapper
-
-app = test_base.init()
-json_request = test_base.json_request
-request_html = test_base.request_html
-BaseTestCase = test_base.BaseTestCase
-
-SEARCH_DAO = xutils.DAO("search")
-
-
-def get_script_path(name):
-    return os.path.join(xconfig.SCRIPTS_DIR, name)
-
-
-class TextPage(xtemplate.BaseTextPlugin):
-
-    def get_input(self):
-        return ""
-
-    def get_format(self):
-        return ""
-
-    def handle(self, input):
-        return "test"
-
-
-class TestMain(BaseTestCase):
-
-    def test_xtables(self):
-        xtables.init_test_table()
-
-    def test_render_text(self):
-        value = xtemplate.render_text("Hello,{{name}}", name="World")
-        self.assertEqual(b"Hello,World", value)
-
-    def test_render(self):
-        value = app.request("/test").data
-        self.assertEqual(b"success", value)
-
-    def test_index(self):
-        self.check_OK("/")
-        self.check_OK("/index")
-
-    def test_home(self):
-        self.check_OK("/home")
-
-    def test_fs_func(self):
-        if not xutils.is_windows():
-            item0, item1 = xutils.splitpath("/fs/test/")
-            self.assertEqual("/fs/", item0.path)
-            self.assertEqual("/fs/test/", item1.path)
-
-        if xutils.is_windows():
-            item0, item1, item2 = xutils.splitpath("C:/data/name/")
-            self.assertEqual("C:/", item0.path)
-            self.assertEqual("C:/data/", item1.path)
-            self.assertEqual("C:/data/name/", item2.path)
-
-    def test_static_files(self):
-        self.check_200("/static/lib/jquery/jquery-1.12.4.min.js")
-        # 禁止直接访问目录
-        self.check_404("/static/")
-
-    def test_dict_json(self):
-        json_request("/note/dict?_format=json")
-
-    def test_dict(self):
-        self.check_200("/note/dict")
-
-    def test_dict_edit(self):
-        self.check_200("/dict/edit/test")
-
-    def test_fs(self):
-        self.check_200("/fs/~/")
-        self.check_200("/fs/~/?_format=json")
-        # self.check_200("/data/data.db")
-
-    def test_fs_partial_content(self):
-        fpath = os.path.join(xconfig.DATA_DIR, "test.txt")
-        xutils.writefile(fpath, "test")
-        response = app.request(
-            "/data/test.txt", headers=dict(RANGE="bytes=1-100"))
-        self.assertEqual("206 Partial Content", response.status)
-        self.assertEqual("bytes", response.headers["Accept-Ranges"])
-        self.assertEqual(True, "Content-Range" in response.headers)
-
-    def test_fs_find(self):
-        json_request("/fs_find", method="POST",
-                     data=dict(path="./data", find_key="java"))
-        self.check_OK("/fs_index")
-        self.check_OK("/fs_index", method="POST", action="reindex")
-
-    def test_fs_plugins(self):
-        self.check_OK("/fs_api/plugins?path=/")
-
-    def test_fs_sidebar(self):
-        self.check_OK("/fs_sidebar")
-
-    def test_fs_cut(self):
-        self.check_OK("/fs_api/cut?files=001.txt&files=002.txt")
-        self.check_OK("/fs_api/clear_clip")
-
-    def test_fs_shell(self):
-        self.check_OK("/fs/~/?mode=shell")
-
-    def test_fs_upload(self):
-        self.check_OK("/fs_upload")
-
-    def test_code_analyze(self):
-        # TODO 解决JSON的循环问题
-        self.check_200("/code/analyze?path=./handlers/&key=test")
-        self.check_200("/code/analyze?path=./handlers/&key=test&filename=test")
-
-    def test_code_lines(self):
-        self.check_OK("/code/lines?count=on&path=./handlers")
-
-    def test_system_tools(self):
-        self.check_200("/system/sys")
-        self.check_200("/system/user/list")
-        self.check_200("/system/crontab")
-        self.check_200("/system/stats")
-        self.check_200("/system/stats/location", method="POST")
-        self.check_200("/system/settings")
-        self.check_200("/system/network_profile?total_size=1024")
-        self.check_200("/system/log")
-        self.check_200("/system/clipboard-monitor")
-        # self.check_200("/system/pydoc")
-
-    def test_system_cache_page(self):
-        self.check_200("/system/cache")
-
-    def test_sys_info(self):
-        self.check_OK("/system/info")
-
-    def test_api(self):
-        self.check_200("/api/check_network")
-        self.check_200("/api/getip")
-        self.check_200("/api/ipv6")
-
-    def test_settings(self):
-        self.check_200("/system/settings")
-        self.check_200("/system/settings?category=admin")
-        self.check_200("/system/settings?category=search")
-
-    def skip_test_sys_storage(self):
-        data = json_request("/system/storage?key=unit-test&_format=json",
-                            method="POST", data=dict(key="unit-test", value="hello"))
-        value = data.get("config").get("value")
-        self.assertEqual("hello", value)
-
-        data = json_request("/system/storage?key=unit-test&_format=json")
-        value = data.get("config").get("value")
-        self.assertEqual("hello", value)
-
-    def test_sys_db_tools(self):
-        self.check_OK("/system/db_scan")
-        self.check_OK("/system/db_refresh")
-
-    def test_user(self):
-        self.check_OK("/system/user/list")
-        self.check_OK("/system/user?name=admin")
-    
-    def test_reset_password(self):
-        temp_user = xauth.create_quick_user()
-        assert temp_user != None
-        resp = json_request("/system/user/reset_password", method="POST", data=dict(user_name=temp_user.name))
-        assert isinstance(resp, dict)
-        assert resp["code"] == "success"
-        password = resp["data"]
-        user_info = xauth.find_by_name(temp_user.name)
-        assert user_info != None
-        assert user_info.password_md5 == xauth.encode_password(password=password, salt=user_info.salt)
-
-
-    def test_tools(self):
-        self.check_200("/tools/color")
-
-    def test_system_sqlite(self):
-        self.check_200("/system/sqlite")
-
-    def test_notfound(self):
-        self.check_404("/nosuchfile")
-
-    def test_exec_script(self):
-        name = "xnote-unit-test.py"
-        content = """print('hello')"""
-        test_path = os.path.join(xconfig.SCRIPTS_DIR, name)
-        xutils.savetofile(test_path, content)
-        result = xutils.exec_script(name)
-        self.assertEqual("hello\n", result)
-
-    def test_script_list(self):
-        self.check_200("/system/script_admin")
-
-    def test_script_add_remove(self):
-        json_request("/system/script/save", method="POST",
-                     data=dict(name="xnote-unit-test.py", content="print(123)"))
-        out = xutils.exec_script("xnote-unit-test.py", False, False)
-        json_request(
-            "/system/script/delete?name=xnote-unit-test.py", method="POST")
-
-    def test_script_rename(self):
-        path1 = get_script_path("unit-test-1.py")
-        path2 = get_script_path("unit-test-2.py")
-        xutils.remove(path1, hard=True)
-        xutils.remove(path2, hard=True)
-
-        ret = json_request(
-            "/system/script/rename?oldname=unit-test-1.py&newname=unit-test-2.py", method="POST")
-        self.assertEqual("fail", ret["code"])
-
-        xutils.touch(path1)
-        ret = json_request(
-            "/system/script/rename?oldname=unit-test-1.py&newname=unit-test-2.py", method="POST")
-        self.assertEqual("success", ret["code"])
-
-    def test_report_time(self):
-        self.check_200("/api/report_time")
-
-    def test_tts(self):
-        self.check_200("/api/tts?content=测试")
-
-    def test_alarm(self):
-        self.check_200("/api/alarm/test?repeat=1")
-
-    def test_search(self):
-        self.check_200("/search?key=测试")
-        self.check_200("/search/search?key=测试")
-        self.check_200("/search/history")
-
-    def test_search_in_cache(self):
-        xconfig.USE_CACHE_SEARCH = True
-        self.check_200("/search?key=测试")
-        self.check_200("/fs_find?find_key=xnote&path=" + xconfig.DATA_DIR)
-        xconfig.USE_CACHE_SEARCH = False
-
-    def test_search_message(self):
-        self.check_200("/message?key=test&category=message")
-
-        handler = SEARCH_DAO.get_search_handler("message")
-        self.assertEqual(u"搜索随手记", handler.placeholder)
-
-    def test_search_mute(self):
-        self.check_200(xutils.quote_unicode("/search?key=静音"))
-        self.assertTrue(xconfig.MUTE_END_TIME != None)
-
-    def test_search_translate(self):
-        self.check_200(xutils.quote_unicode("/search?key=翻译test"))
-
-    def test_http_headers(self):
-        data = app.request("/api/http_headers", headers=dict(X_TEST=True)).data
-        self.assertEqual(True, b"HTTP_X_TEST" in data)
-
-    def test_tagname(self):
-        self.check_OK("/note/tagname/test")
-
-    def test_taglist(self):
-        self.check_OK("/note/taglist")
-
-    def test_document(self):
-        self.check_200("/system/modules_info")
-        self.check_200("/system/document?name=os")
-        self.check_200("/system/document?name=xutils")
-
-    def test_view_source(self):
-        self.check_200("/code/view_source?path=./README.md")
-
-    def test_view_source_update(self):
-        json_request("/code/view_source/update", method="POST",
-                     data=dict(path="./test.md", content="hello"))
-        content = xutils.readfile("./test.md")
-        self.assertEqual("hello", content)
-        xutils.remove("./test.md", hard=True)
-
-    def test_markdown_preview(self):
-        self.check_200("/code/preview?path=./README.md")
-
-    def test_code_wiki(self):
-        self.check_200("/code/wiki/README.md")
-
-    def test_cron_list(self):
-        self.check_200("/system/crontab")
-
-    def test_BaseTextPlugin(self):
-        TextPage().render()
-
-    def test_plugin(self):
-        code = '''
-# @api-level 2.8
-# @title Unit-Test-Plugin
-# @category test
-class Main:
-    def render(self):
-        return "hello,world"
-        '''
-        fpath = os.path.join(xconfig.PLUGINS_DIR, "test.py")
-        xutils.savetofile(fpath, code)
-        html = request_html("/plugins/test.py")
-        self.assertEqual(b"hello,world", html)
-
-    def test_readbook(self):
-        self.check_200("/api/readbook")
-
-    def test_plugins_list(self):
-        self.check_200("/plugins_list")
-        self.check_200("/plugin_list")
-
-    def test_plugin_category_list(self):
-        self.check_200("/plugin_category_list")
-
-    def test_plugin_search(self):
-        self.check_200("/plugin_list?key=123")
-
-    def test_plugins_other(self):
-        self.check_OK("/plugins_list?category=other")
-
-    def test_plugins_new_plugin(self):
-        self.check_OK("/plugins_new?input=tpl-test")
-
-    def test_plugins_new_command(self):
-        self.check_OK("/plugins_new/command?input=cmd-test")
-
-    def test_diskclean(self):
-        self.check_OK("/cron/diskclean")
-
-    def test_backup(self):
-        self.check_OK("/system/backup")
-
-    def test_dbutil_test(self):
-        self.check_OK("/test/test_dbutil")
-        self.check_OK("/test/test_dbutil?p=clear")
-
-    def test_system_log(self):
-        logger = logutil.new_mem_logger("log_test")
-        logger.log("Hello,World")
-        self.check_OK("/system/log")
-        self.check_OK("/system/log?log_type=mem")
-
-    def test_login_success(self):
-        user_name = "test"
-        password = "123456"
-        xauth.update_user(user_name, dict(password=password))
-        params = dict(
-            username=user_name,
-            password=password
-        )
-
-        resp = self.request_app("/login", method="POST", data=params)
-
-        print("resp:", resp)
-
-        respWrapper = ResponseWrapper(resp)
-
-        self.assertEqual("302 Found", resp.status)
-        self.assertEqual("/", respWrapper.get_header("Location"))
-
-    def test_login_param_error(self):
-        params = dict(
-            username="test",
-            _format="json",
-        )
-
-        resp = json_request("/login", method="POST", data=params)
-
-        self.assertEqual("请输入密码", resp["error"])
-
-
-    def test_login_password_error(self):
-        password = xauth.get_user_by_name("test").password
-        params = dict(
-            username="test",
-            password=password+"_error",
-            _format="json",
-        )
-        resp = json_request("/login", method="POST", data=params)
-        print("test_login_password_error", resp)
-        self.assertEqual("用户名或密码错误", resp["error"])
-
-    def test_login_user_not_found(self):
-        params = dict(
-            username="test_user_not_found",
-            password="_error",
-            _format="json",
-        )
-        resp = json_request("/login", method="POST", data=params)
-        print("test_login_user_not_found", resp)
-        self.assertEqual("用户名或密码错误", resp["error"])
-
-    def test_add_visit_log(self):
-        xmanager.add_visit_log(None, "/index")
-
-
-    def test_system_log2(self):
-        from handlers.system.system_log import LogVisitHandler
-        handler = LogVisitHandler()
-        # insert
-        handler.do_get("test", "127.0.0.1")
-        # update
-        handler.do_get("test", "127.0.0.1")
-
-    def test_ext_handler(self):
-        dirname = os.path.dirname(__file__)
-        xconfig.FileConfig.ext_handlers_dir = os.path.join(dirname, "ext_handlers")
-        xtemplate.init()
-        text = xtemplate.render("$ext/test.html")
-        assert text.strip() == b"hello"
-
-
-    def test_plugin_handler(self):
-        dirname = os.path.dirname(__file__)
-        xconfig.FileConfig.plugins_dir = os.path.join(dirname, "plugins")
-        xtemplate.init()
-        text = xtemplate.render("$plugin/test_plugin.html")
-        assert text.strip() == b"plugin"
-
-    def test_plugin_upload(self):
-        user = xauth.get_user_by_name("admin")
-        assert user != None
-        content = """
-# @id test-upload-plugin
-# @title test-upload-plugin
-# @api-level 2.8
-        """
-        resp = json_request("/plugins_upload", data=dict(content=content, token=user.token), method="POST")
-        assert isinstance(resp, dict)
-        assert resp["success"] == True
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2017-05-23 00:30:19
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-20 16:42:38
+@FilePath     : /xnote/tests/test_app.py
+@Description  : 描述
+"""
+
+import os
+import xutils
+from xnote.core import xtemplate, xconfig, xtables, xauth, xmanager
+from xutils import logutil
+from . import test_base
+from .test_base import ResponseWrapper
+
+app = test_base.init()
+json_request = test_base.json_request
+request_html = test_base.request_html
+BaseTestCase = test_base.BaseTestCase
+
+SEARCH_DAO = xutils.DAO("search")
+
+
+def get_script_path(name):
+    return os.path.join(xconfig.SCRIPTS_DIR, name)
+
+
+class TextPage(xtemplate.BaseTextPlugin):
+
+    def get_input(self):
+        return ""
+
+    def get_format(self):
+        return ""
+
+    def handle(self, input):
+        return "test"
+
+
+class TestMain(BaseTestCase):
+
+    def test_xtables(self):
+        xtables.init_test_table()
+
+    def test_render_text(self):
+        value = xtemplate.render_text("Hello,{{name}}", name="World")
+        self.assertEqual(b"Hello,World", value)
+
+    def test_render(self):
+        value = app.request("/test").data
+        self.assertEqual(b"success", value)
+
+    def test_index(self):
+        self.check_OK("/")
+        self.check_OK("/index")
+
+    def test_home(self):
+        self.check_OK("/home")
+
+    def test_fs_func(self):
+        if not xutils.is_windows():
+            item0, item1 = xutils.splitpath("/fs/test/")
+            self.assertEqual("/fs/", item0.path)
+            self.assertEqual("/fs/test/", item1.path)
+
+        if xutils.is_windows():
+            item0, item1, item2 = xutils.splitpath("C:/data/name/")
+            self.assertEqual("C:/", item0.path)
+            self.assertEqual("C:/data/", item1.path)
+            self.assertEqual("C:/data/name/", item2.path)
+
+    def test_static_files(self):
+        self.check_200("/static/lib/jquery/jquery-1.12.4.min.js")
+        # 禁止直接访问目录
+        self.check_404("/static/")
+
+    def test_dict_json(self):
+        json_request("/note/dict?_format=json")
+
+    def test_dict(self):
+        self.check_200("/note/dict")
+
+    def test_dict_edit(self):
+        self.check_200("/dict/edit/test")
+
+    def test_fs(self):
+        self.check_200("/fs/~/")
+        self.check_200("/fs/~/?_format=json")
+        # self.check_200("/data/data.db")
+
+    def test_fs_partial_content(self):
+        fpath = os.path.join(xconfig.DATA_DIR, "test.txt")
+        xutils.writefile(fpath, "test")
+        response = app.request(
+            "/data/test.txt", headers=dict(RANGE="bytes=1-100"))
+        self.assertEqual("206 Partial Content", response.status)
+        self.assertEqual("bytes", response.headers["Accept-Ranges"])
+        self.assertEqual(True, "Content-Range" in response.headers)
+
+    def test_fs_find(self):
+        json_request("/fs_find", method="POST",
+                     data=dict(path="./data", find_key="java"))
+        self.check_OK("/fs_index")
+        self.check_OK("/fs_index", method="POST", action="reindex")
+
+    def test_fs_plugins(self):
+        self.check_OK("/fs_api/plugins?path=/")
+
+    def test_fs_sidebar(self):
+        self.check_OK("/fs_sidebar")
+
+    def test_fs_cut(self):
+        self.check_OK("/fs_api/cut?files=001.txt&files=002.txt")
+        self.check_OK("/fs_api/clear_clip")
+
+    def test_fs_shell(self):
+        self.check_OK("/fs/~/?mode=shell")
+
+    def test_fs_upload(self):
+        self.check_OK("/fs_upload")
+
+    def test_code_analyze(self):
+        # TODO 解决JSON的循环问题
+        self.check_200("/code/analyze?path=./handlers/&key=test")
+        self.check_200("/code/analyze?path=./handlers/&key=test&filename=test")
+
+    def test_code_lines(self):
+        self.check_OK("/code/lines?count=on&path=./handlers")
+
+    def test_system_tools(self):
+        self.check_200("/system/sys")
+        self.check_200("/system/user/list")
+        self.check_200("/system/crontab")
+        self.check_200("/system/stats")
+        self.check_200("/system/stats/location", method="POST")
+        self.check_200("/system/settings")
+        self.check_200("/system/network_profile?total_size=1024")
+        self.check_200("/system/log")
+        self.check_200("/system/clipboard-monitor")
+        # self.check_200("/system/pydoc")
+
+    def test_system_cache_page(self):
+        self.check_200("/system/cache")
+
+    def test_sys_info(self):
+        self.check_OK("/system/info")
+
+    def test_api(self):
+        self.check_200("/api/check_network")
+        self.check_200("/api/getip")
+        self.check_200("/api/ipv6")
+
+    def test_settings(self):
+        self.check_200("/system/settings")
+        self.check_200("/system/settings?category=admin")
+        self.check_200("/system/settings?category=search")
+
+    def skip_test_sys_storage(self):
+        data = json_request("/system/storage?key=unit-test&_format=json",
+                            method="POST", data=dict(key="unit-test", value="hello"))
+        value = data.get("config").get("value")
+        self.assertEqual("hello", value)
+
+        data = json_request("/system/storage?key=unit-test&_format=json")
+        value = data.get("config").get("value")
+        self.assertEqual("hello", value)
+
+    def test_sys_db_tools(self):
+        self.check_OK("/system/db_scan")
+        self.check_OK("/system/db_refresh")
+
+    def test_user(self):
+        self.check_OK("/system/user/list")
+        self.check_OK("/system/user?name=admin")
+    
+    def test_reset_password(self):
+        temp_user = xauth.create_quick_user()
+        assert temp_user != None
+        resp = json_request("/system/user/reset_password", method="POST", data=dict(user_name=temp_user.name))
+        assert isinstance(resp, dict)
+        assert resp["code"] == "success"
+        password = resp["data"]
+        user_info = xauth.find_by_name(temp_user.name)
+        assert user_info != None
+        assert user_info.password_md5 == xauth.encode_password(password=password, salt=user_info.salt)
+
+
+    def test_tools(self):
+        self.check_200("/tools/color")
+
+    def test_system_sqlite(self):
+        self.check_200("/system/sqlite")
+
+    def test_notfound(self):
+        self.check_404("/nosuchfile")
+
+    def test_exec_script(self):
+        name = "xnote-unit-test.py"
+        content = """print('hello')"""
+        test_path = os.path.join(xconfig.SCRIPTS_DIR, name)
+        xutils.savetofile(test_path, content)
+        result = xutils.exec_script(name)
+        self.assertEqual("hello\n", result)
+
+    def test_script_list(self):
+        self.check_200("/system/script_admin")
+
+    def test_script_add_remove(self):
+        json_request("/system/script/save", method="POST",
+                     data=dict(name="xnote-unit-test.py", content="print(123)"))
+        out = xutils.exec_script("xnote-unit-test.py", False, False)
+        json_request(
+            "/system/script/delete?name=xnote-unit-test.py", method="POST")
+
+    def test_script_rename(self):
+        path1 = get_script_path("unit-test-1.py")
+        path2 = get_script_path("unit-test-2.py")
+        xutils.remove(path1, hard=True)
+        xutils.remove(path2, hard=True)
+
+        ret = json_request(
+            "/system/script/rename?oldname=unit-test-1.py&newname=unit-test-2.py", method="POST")
+        self.assertEqual("fail", ret["code"])
+
+        xutils.touch(path1)
+        ret = json_request(
+            "/system/script/rename?oldname=unit-test-1.py&newname=unit-test-2.py", method="POST")
+        self.assertEqual("success", ret["code"])
+
+    def test_report_time(self):
+        self.check_200("/api/report_time")
+
+    def test_tts(self):
+        self.check_200("/api/tts?content=测试")
+
+    def test_alarm(self):
+        self.check_200("/api/alarm/test?repeat=1")
+
+    def test_search(self):
+        self.check_200("/search?key=测试")
+        self.check_200("/search/search?key=测试")
+        self.check_200("/search/history")
+
+    def test_search_in_cache(self):
+        xconfig.USE_CACHE_SEARCH = True
+        self.check_200("/search?key=测试")
+        self.check_200("/fs_find?find_key=xnote&path=" + xconfig.DATA_DIR)
+        xconfig.USE_CACHE_SEARCH = False
+
+    def test_search_message(self):
+        self.check_200("/message?key=test&category=message")
+
+        handler = SEARCH_DAO.get_search_handler("message")
+        self.assertEqual(u"搜索随手记", handler.placeholder)
+
+    def test_search_mute(self):
+        self.check_200(xutils.quote_unicode("/search?key=静音"))
+        self.assertTrue(xconfig.MUTE_END_TIME != None)
+
+    def test_search_translate(self):
+        self.check_200(xutils.quote_unicode("/search?key=翻译test"))
+
+    def test_http_headers(self):
+        data = app.request("/api/http_headers", headers=dict(X_TEST=True)).data
+        self.assertEqual(True, b"HTTP_X_TEST" in data)
+
+    def test_tagname(self):
+        self.check_OK("/note/tagname/test")
+
+    def test_taglist(self):
+        self.check_OK("/note/taglist")
+
+    def test_document(self):
+        self.check_200("/system/modules_info")
+        self.check_200("/system/document?name=os")
+        self.check_200("/system/document?name=xutils")
+
+    def test_view_source(self):
+        self.check_200("/code/view_source?path=./README.md")
+
+    def test_view_source_update(self):
+        json_request("/code/view_source/update", method="POST",
+                     data=dict(path="./test.md", content="hello"))
+        content = xutils.readfile("./test.md")
+        self.assertEqual("hello", content)
+        xutils.remove("./test.md", hard=True)
+
+    def test_markdown_preview(self):
+        self.check_200("/code/preview?path=./README.md")
+
+    def test_code_wiki(self):
+        self.check_200("/code/wiki/README.md")
+
+    def test_cron_list(self):
+        self.check_200("/system/crontab")
+
+    def test_BaseTextPlugin(self):
+        TextPage().render()
+
+    def test_plugin(self):
+        code = '''
+# @api-level 2.8
+# @title Unit-Test-Plugin
+# @category test
+class Main:
+    def render(self):
+        return "hello,world"
+        '''
+        fpath = os.path.join(xconfig.PLUGINS_DIR, "test.py")
+        xutils.savetofile(fpath, code)
+        html = request_html("/plugins/test.py")
+        self.assertEqual(b"hello,world", html)
+
+    def test_readbook(self):
+        self.check_200("/api/readbook")
+
+    def test_plugins_list(self):
+        self.check_200("/plugins_list")
+        self.check_200("/plugin_list")
+
+    def test_plugin_category_list(self):
+        self.check_200("/plugin_category_list")
+
+    def test_plugin_search(self):
+        self.check_200("/plugin_list?key=123")
+
+    def test_plugins_other(self):
+        self.check_OK("/plugins_list?category=other")
+
+    def test_plugins_new_plugin(self):
+        self.check_OK("/plugins_new?input=tpl-test")
+
+    def test_plugins_new_command(self):
+        self.check_OK("/plugins_new/command?input=cmd-test")
+
+    def test_diskclean(self):
+        self.check_OK("/cron/diskclean")
+
+    def test_backup(self):
+        self.check_OK("/system/backup")
+
+    def test_dbutil_test(self):
+        self.check_OK("/test/test_dbutil")
+        self.check_OK("/test/test_dbutil?p=clear")
+
+    def test_system_log(self):
+        logger = logutil.new_mem_logger("log_test")
+        logger.log("Hello,World")
+        self.check_OK("/system/log")
+        self.check_OK("/system/log?log_type=mem")
+
+    def test_login_success(self):
+        user_name = "test"
+        password = "123456"
+        xauth.update_user(user_name, dict(password=password))
+        params = dict(
+            username=user_name,
+            password=password
+        )
+
+        resp = self.request_app("/login", method="POST", data=params)
+
+        print("resp:", resp)
+
+        respWrapper = ResponseWrapper(resp)
+
+        self.assertEqual("302 Found", resp.status)
+        self.assertEqual("/", respWrapper.get_header("Location"))
+
+    def test_login_param_error(self):
+        params = dict(
+            username="test",
+            _format="json",
+        )
+
+        resp = json_request("/login", method="POST", data=params)
+
+        self.assertEqual("请输入密码", resp["error"])
+
+
+    def test_login_password_error(self):
+        password = xauth.get_user_by_name("test").password
+        params = dict(
+            username="test",
+            password=password+"_error",
+            _format="json",
+        )
+        resp = json_request("/login", method="POST", data=params)
+        print("test_login_password_error", resp)
+        self.assertEqual("用户名或密码错误", resp["error"])
+
+    def test_login_user_not_found(self):
+        params = dict(
+            username="test_user_not_found",
+            password="_error",
+            _format="json",
+        )
+        resp = json_request("/login", method="POST", data=params)
+        print("test_login_user_not_found", resp)
+        self.assertEqual("用户名或密码错误", resp["error"])
+
+    def test_add_visit_log(self):
+        xmanager.add_visit_log(None, "/index")
+
+
+    def test_system_log2(self):
+        from handlers.system.system_log import LogVisitHandler
+        handler = LogVisitHandler()
+        # insert
+        handler.do_get("test", "127.0.0.1")
+        # update
+        handler.do_get("test", "127.0.0.1")
+
+    def test_ext_handler(self):
+        dirname = os.path.dirname(__file__)
+        xconfig.FileConfig.ext_handlers_dir = os.path.join(dirname, "ext_handlers")
+        xtemplate.init()
+        text = xtemplate.render("$ext/test.html")
+        assert text.strip() == b"hello"
+
+
+    def test_plugin_handler(self):
+        dirname = os.path.dirname(__file__)
+        xconfig.FileConfig.plugins_dir = os.path.join(dirname, "plugins")
+        xtemplate.init()
+        text = xtemplate.render("$plugin/test_plugin.html")
+        assert text.strip() == b"plugin"
+
+    def test_plugin_upload(self):
+        user = xauth.get_user_by_name("admin")
+        assert user != None
+        content = """
+# @id test-upload-plugin
+# @title test-upload-plugin
+# @api-level 2.8
+        """
+        resp = json_request("/plugins_upload", data=dict(content=content, token=user.token), method="POST")
+        assert isinstance(resp, dict)
+        assert resp["success"] == True
```

### Comparing `xnote-web-0.1.0/tests/test_base.py` & `xnote-web-0.1.1/tests/test_base.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,222 +1,223 @@
-# encoding=utf-8
-from .a import *
-import os
-import time
-import unittest
-from xnote.core import xconfig
-import xutils
-from xnote.core import xtables
-from xnote.core import xmanager
-from xnote.core import xtemplate
-from xnote.core import xtables_kv
-import web
-import json
-from xnote.core import xauth
-from xutils import dbutil
-from xutils import cacheutil
-from xutils import six
-from xutils.db.driver_sqlite import SqliteKV
-
-config = xconfig
-date = time.strftime("%Y/%m")
-
-APP: web.application = None
-
-DEFAULT_HEADERS = dict()
-
-
-def init():
-    global APP
-    if APP is not None:
-        return APP
-    xconfig.init("./config/boot/boot.test.properties")
-    xconfig.IS_TEST = True
-    
-    xauth.TestEnv.login_admin()
-    
-    xconfig.port = "1234"
-    xconfig.DEV_MODE = True
-    var_env = dict()
-    xutils.remove_file("./testdata/data.db", hard=True)
-    xtables.init()
-
-    db_file = os.path.join(xconfig.DB_DIR, "sqlite", "test.db")
-    db_instance = SqliteKV(db_file)
-    dbutil.init(xconfig.DB_DIR, db_instance=db_instance, binlog_max_size=1000)
-    xtables_kv.init()
-
-    xutils.init(xconfig)
-    xauth.init()
-    cacheutil.init(xconfig.STORAGE_DIR)
-
-    APP = web.application(list(), var_env, autoreload=False)
-    last_mapping = (r"/tools/(.*)", "handlers.tools.tools.handler")
-    mgr = xmanager.init(APP, var_env, last_mapping=last_mapping)
-    mgr.reload()
-    # 加载template
-    xtemplate.reload()
-
-    xauth.create_user("test2", "123456")
-
-    # 发送启动消息
-    xmanager.fire("sys.reload")
-
-    return APP
-
-
-APP = init()
-
-
-def get_test_file_path(path):
-    return os.path.join("./testdata", path)
-
-
-def logout_test_user():
-    xauth.TestEnv.logout()
-
-
-def login_test_user(user_name="admin"):
-    xauth.TestEnv.login_user(user_name)
-
-
-def json_request(*args, **kw):
-    global APP
-    if "data" in kw:
-        # 对于POST请求设置无效
-        kw["data"]["_format"] = "json"
-    else:
-        kw["data"] = dict(_format="json")
-    kw["_format"] = "json"
-    kw["headers"] = DEFAULT_HEADERS
-
-    ret = APP.request(*args, **kw)
-    if ret.status == "303 See Other":
-        return
-    assert ret.status == "200 OK"
-    data = ret.data
-    if six.PY2:
-        return json.loads(data)
-    return json.loads(data.decode("utf-8"))
-
-def json_request_return_dict(*args, **kw):
-    """请求接口,返回json,实例如下
-    - json_request_return_dict("/api/test", method="POST", data=dict(name="test"))
-    - json_request_return_dict("/api/get_info?p1=1&p2=test")
-    """
-    ret = json_request(*args, **kw)
-    assert isinstance(ret, dict)
-    return ret
-
-def request_html(*args, **kw):
-    ret = APP.request(*args, **kw)
-    return ret.data
-
-
-def create_tmp_file(name):
-    path = os.path.join(xconfig.DATA_DIR, "files", "user",
-                        "upload", time.strftime("%Y/%m"), name)
-    xutils.touch(path)
-
-
-def remove_tmp_file(name):
-    path = os.path.join(xconfig.DATA_DIR, "files", "user",
-                        "upload", time.strftime("%Y/%m"), name)
-    if os.path.exists(path):
-        os.remove(path)
-
-
-class BaseTestCase(unittest.TestCase):
-
-    def request_app(self, *args, **kw):
-        return APP.request(*args, **kw)
-
-    def check_OK(self, *args, **kw):
-        response = APP.request(*args, **kw)
-        status = response.status
-        print("response.status:", status)
-        self.assertIn(status, ("200 OK", "303 See Other", "302 Found"))
-
-    def check_200(self, *args, **kw):
-        response = APP.request(*args, **kw)
-        self.assertEqual("200 OK", response.status)
-
-    def check_200_debug(self, *args, **kw):
-        response = APP.request(*args, **kw)
-        print(args, kw, response)
-        print(APP.mapping)
-        self.assertEqual("200 OK", response.status)
-
-    def check_303(self, *args, **kw):
-        response = APP.request(*args, **kw)
-        self.assertEqual("303 See Other", response.status)
-        
-    def check_404(self, url):
-        response = APP.request(url)
-        self.assertEqual("404 Not Found", response.status)
-
-    def check_status(self, status, *args, **kw):
-        response = APP.request(*args, **kw)
-        self.assertEqual(status, response.status)
-
-    def json_request(self, *args, **kw):
-        return json_request(*args, **kw)
-
-    def json_request_return_dict(self, *args, **kw):
-        return json_request_return_dict(*args, **kw)
-
-class BaseTestMain(unittest.TestCase):
-
-    def test_get_upload_file_path(self):
-        from handlers.fs.fs_upload import get_upload_file_path
-        remove_tmp_file("test.txt")
-        path, webpath = get_upload_file_path("user", "test.txt")
-        print()
-        print(path)
-        print(webpath)
-        self.assertEqual(os.path.abspath(config.DATA_PATH +
-                         "/files/user/upload/%s/test.txt" % date), path)
-        self.assertEqual("/data/files/user/upload/%s/test.txt" % date, webpath)
-
-    def test_get_upload_file_path_1(self):
-        from handlers.fs.fs_upload import get_upload_file_path
-        remove_tmp_file("test_1.txt")
-        create_tmp_file("test.txt")
-        path, webpath = get_upload_file_path("user", "test.txt")
-        print()
-        print(path)
-        print(webpath)
-        self.assertEqual(os.path.abspath(config.DATA_PATH +
-                         "/files/user/upload/%s/test_1.txt" % date), path)
-        self.assertEqual(
-            "/data/files/user/upload/%s/test_1.txt" % date, webpath)
-        remove_tmp_file("test.txt")
-
-    def test_get_upload_file_path_2(self):
-        from handlers.fs.fs_upload import get_upload_file_path
-        create_tmp_file("test.txt")
-        create_tmp_file("test_1.txt")
-        remove_tmp_file("test_2.txt")
-        path, webpath = get_upload_file_path("user", "test.txt")
-        print()
-        print(path)
-        print(webpath)
-        self.assertEqual(os.path.abspath(config.DATA_PATH +
-                         "/files/user/upload/%s/test_2.txt" % date), path)
-        self.assertEqual(
-            "/data/files/user/upload/%s/test_2.txt" % date, webpath)
-        remove_tmp_file("test.txt")
-        remove_tmp_file("test_1.txt")
-
-
-class ResponseWrapper:
-
-    def __init__(self, resp: web.Storage) -> None:
-        self.resp = resp
-
-    def get_header(self, header: str):
-        header = header.lower()
-        headers = self.resp.header_items
-        for key, value in headers:
-            if key.lower() == header:
-                return value
-        return None
+# encoding=utf-8
+from .a import *
+import typing
+import os
+import time
+import unittest
+from xnote.core import xconfig
+import xutils
+from xnote.core import xtables
+from xnote.core import xmanager
+from xnote.core import xtemplate
+from xnote.core import xtables_kv
+import web
+import json
+from xnote.core import xauth
+from xutils import dbutil
+from xutils import cacheutil
+from xutils import six
+from xutils.db.driver_sqlite import SqliteKV
+
+config = xconfig
+date = time.strftime("%Y/%m")
+
+APP: typing.Union[web.application,None] = None
+
+DEFAULT_HEADERS = dict()
+
+
+def init():
+    global APP
+    if APP is not None:
+        return APP
+    xconfig.init("./config/boot/boot.test.properties")
+    xconfig.IS_TEST = True
+    
+    xauth.TestEnv.login_admin()
+    
+    xconfig.port = "1234"
+    xconfig.DEV_MODE = True
+    var_env = dict()
+    xutils.remove_file("./testdata/data.db", hard=True)
+    xtables.init()
+
+    db_file = os.path.join(xconfig.DB_DIR, "sqlite", "test.db")
+    db_instance = SqliteKV(db_file)
+    dbutil.init(xconfig.DB_DIR, db_instance=db_instance, binlog_max_size=1000)
+    xtables_kv.init()
+
+    xutils.init(xconfig)
+    xauth.init()
+    cacheutil.init(xconfig.STORAGE_DIR)
+
+    APP = web.application(list(), var_env, autoreload=False)
+    last_mapping = (r"/tools/(.*)", "handlers.tools.tools.handler")
+    mgr = xmanager.init(APP, var_env, last_mapping=last_mapping)
+    mgr.reload()
+    # 加载template
+    xtemplate.reload()
+
+    xauth.create_user("test2", "123456")
+
+    # 发送启动消息
+    xmanager.fire("sys.reload")
+
+    return APP
+
+
+APP = init()
+
+
+def get_test_file_path(path):
+    return os.path.join("./testdata", path)
+
+
+def logout_test_user():
+    xauth.TestEnv.logout()
+
+
+def login_test_user(user_name="admin"):
+    xauth.TestEnv.login_user(user_name)
+
+
+def json_request(*args, **kw):
+    global APP
+    if "data" in kw:
+        # 对于POST请求设置无效
+        kw["data"]["_format"] = "json"
+    else:
+        kw["data"] = dict(_format="json")
+    kw["_format"] = "json"
+    kw["headers"] = DEFAULT_HEADERS
+
+    ret = APP.request(*args, **kw)
+    if ret.status == "303 See Other":
+        return
+    assert ret.status == "200 OK"
+    data = ret.data
+    if six.PY2:
+        return json.loads(data)
+    return json.loads(data.decode("utf-8"))
+
+def json_request_return_dict(*args, **kw):
+    """请求接口,返回json,实例如下
+    - json_request_return_dict("/api/test", method="POST", data=dict(name="test"))
+    - json_request_return_dict("/api/get_info?p1=1&p2=test")
+    """
+    ret = json_request(*args, **kw)
+    assert isinstance(ret, dict)
+    return ret
+
+def request_html(*args, **kw):
+    ret = APP.request(*args, **kw)
+    return ret.data
+
+
+def create_tmp_file(name):
+    path = os.path.join(xconfig.DATA_DIR, "files", "user",
+                        "upload", time.strftime("%Y/%m"), name)
+    xutils.touch(path)
+
+
+def remove_tmp_file(name):
+    path = os.path.join(xconfig.DATA_DIR, "files", "user",
+                        "upload", time.strftime("%Y/%m"), name)
+    if os.path.exists(path):
+        os.remove(path)
+
+
+class BaseTestCase(unittest.TestCase):
+
+    def request_app(self, *args, **kw):
+        return APP.request(*args, **kw)
+
+    def check_OK(self, *args, **kw):
+        response = APP.request(*args, **kw)
+        status = response.status
+        print("response.status:", status)
+        self.assertIn(status, ("200 OK", "303 See Other", "302 Found"))
+
+    def check_200(self, *args, **kw):
+        response = APP.request(*args, **kw)
+        self.assertEqual("200 OK", response.status)
+
+    def check_200_debug(self, *args, **kw):
+        response = APP.request(*args, **kw)
+        print(args, kw, response)
+        print(APP.mapping)
+        self.assertEqual("200 OK", response.status)
+
+    def check_303(self, *args, **kw):
+        response = APP.request(*args, **kw)
+        self.assertEqual("303 See Other", response.status)
+        
+    def check_404(self, url):
+        response = APP.request(url)
+        self.assertEqual("404 Not Found", response.status)
+
+    def check_status(self, status, *args, **kw):
+        response = APP.request(*args, **kw)
+        self.assertEqual(status, response.status)
+
+    def json_request(self, *args, **kw):
+        return json_request(*args, **kw)
+
+    def json_request_return_dict(self, *args, **kw):
+        return json_request_return_dict(*args, **kw)
+
+class BaseTestMain(unittest.TestCase):
+
+    def test_get_upload_file_path(self):
+        from handlers.fs.fs_upload import get_upload_file_path
+        remove_tmp_file("test.txt")
+        path, webpath = get_upload_file_path("user", "test.txt")
+        print()
+        print(path)
+        print(webpath)
+        self.assertEqual(os.path.abspath(config.DATA_PATH +
+                         "/files/user/upload/%s/test.txt" % date), path)
+        self.assertEqual("/data/files/user/upload/%s/test.txt" % date, webpath)
+
+    def test_get_upload_file_path_1(self):
+        from handlers.fs.fs_upload import get_upload_file_path
+        remove_tmp_file("test_1.txt")
+        create_tmp_file("test.txt")
+        path, webpath = get_upload_file_path("user", "test.txt")
+        print()
+        print(path)
+        print(webpath)
+        self.assertEqual(os.path.abspath(config.DATA_PATH +
+                         "/files/user/upload/%s/test_1.txt" % date), path)
+        self.assertEqual(
+            "/data/files/user/upload/%s/test_1.txt" % date, webpath)
+        remove_tmp_file("test.txt")
+
+    def test_get_upload_file_path_2(self):
+        from handlers.fs.fs_upload import get_upload_file_path
+        create_tmp_file("test.txt")
+        create_tmp_file("test_1.txt")
+        remove_tmp_file("test_2.txt")
+        path, webpath = get_upload_file_path("user", "test.txt")
+        print()
+        print(path)
+        print(webpath)
+        self.assertEqual(os.path.abspath(config.DATA_PATH +
+                         "/files/user/upload/%s/test_2.txt" % date), path)
+        self.assertEqual(
+            "/data/files/user/upload/%s/test_2.txt" % date, webpath)
+        remove_tmp_file("test.txt")
+        remove_tmp_file("test_1.txt")
+
+
+class ResponseWrapper:
+
+    def __init__(self, resp: web.Storage) -> None:
+        self.resp = resp
+
+    def get_header(self, header: str):
+        header = header.lower()
+        headers = self.resp.header_items
+        for key, value in headers:
+            if key.lower() == header:
+                return value
+        return None
```

### Comparing `xnote-web-0.1.0/tests/test_dict.py` & `xnote-web-0.1.1/tests/test_dict.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_exif.py` & `xnote-web-0.1.1/tests/test_exif.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_fs.py` & `xnote-web-0.1.1/tests/test_fs.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,90 +1,90 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2020/11/29 14:45:21
-# @modified 2022/06/03 14:33:36
-import xutils
-from .a import *
-import os
-from xnote.core import xconfig
-from xnote.core import xauth
-from .test_base import json_request, BaseTestCase
-from .test_base import init as init_app, get_test_file_path
-from handlers.fs.fs_index import build_fs_index
-
-init_app()
-
-
-class TestMain(BaseTestCase):
-
-    def test_fs_view_mode(self):
-        cwd = os.getcwd()
-
-        self.check_OK("/fs/~{cwd}".format(cwd=cwd))
-        self.check_OK("/fs/~{cwd}?mode=grid".format(cwd=cwd))
-
-    def test_fs_hex(self):
-        self.check_OK("/fs_hex")
-        self.check_OK("/fs_hex?path=./README.md")
-
-    def test_fs_tools(self):
-        self.check_OK("/fs_tools")
-        self.check_OK("/fs_bookmark")
-
-    def test_create_file(self):
-        path = xconfig.DATA_DIR
-        resp = json_request("/fs_api/add_file", method="POST",
-                            data=dict(path=path, filename="test_fs.txt"))
-        print(resp)
-        self.assertEqual("success", resp["code"])
-
-    def test_create_dir(self):
-        path = xconfig.DATA_DIR
-        resp = json_request("/fs_api/add_dir", method="POST",
-                            data=dict(path=path, filename="test_fs_dir"))
-        print(resp)
-        self.assertEqual("success", resp["code"])
-    
-    def test_code_preview(self):
-        self.check_OK("/code/preview?path=./README.md")
-
-    def test_build_fs_index(self):
-        size = build_fs_index(xconfig.DATA_DIR, sync=True)
-        self.assertTrue(size > 0)
-    
-    def test_fs_index_manage_page(self):
-        path = xutils.quote("./testdata")
-        self.check_OK("/fs_index?action=reindex&path={path}".format(path=path), method="POST")
-        self.check_OK("/fs_index?p=rebuild")
-        self.check_OK("/fs_index")
-
-    def test_config_fs_order(self):
-        resp = json_request("/fs_api/config", method = "POST", data = dict(action = "sort", order = "size"))
-        print(resp)
-        self.assertEqual("success", resp["code"])
-        
-        user_name = xauth.current_name()
-        self.assertEqual("size", xauth.get_user_config(user_name, "fs_order"))
-    
-    def test_fs_config_error(self):
-        resp = json_request("/fs_api/config", method = "POST", data = dict(action = "notfount", order = "size"))
-        print(resp)
-        self.assertEqual("error", resp["code"])
-    
-    def test_fs_sidebar(self):
-        path = os.getcwd()
-        txt_path = get_test_file_path("./fs_preview_test.txt")
-        with open(txt_path, "w+") as fp:
-            fp.write("test fs preview")
-
-        self.check_OK("/fs_sidebar?path={path}".format(path=path))
-        self.check_OK("/fs_preview?path={txt_path}".format(txt_path=txt_path))
-
-    def test_fs_find(self):
-        self.check_OK("/fs_find?key=test")
-    
-    def test_fs_find_in_cache(self):
-        xconfig.USE_CACHE_SEARCH = True
-        self.check_OK("/fs_find?key=test")
-
-    def test_fs_upload_search(self):
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2020/11/29 14:45:21
+# @modified 2022/06/03 14:33:36
+import xutils
+from .a import *
+import os
+from xnote.core import xconfig
+from xnote.core import xauth
+from .test_base import json_request, BaseTestCase
+from .test_base import init as init_app, get_test_file_path
+from handlers.fs.fs_index import build_fs_index
+
+init_app()
+
+
+class TestMain(BaseTestCase):
+
+    def test_fs_view_mode(self):
+        cwd = os.getcwd()
+
+        self.check_OK("/fs/~{cwd}".format(cwd=cwd))
+        self.check_OK("/fs/~{cwd}?mode=grid".format(cwd=cwd))
+
+    def test_fs_hex(self):
+        self.check_OK("/fs_hex")
+        self.check_OK("/fs_hex?path=./README.md")
+
+    def test_fs_tools(self):
+        self.check_OK("/fs_tools")
+        self.check_OK("/fs_bookmark")
+
+    def test_create_file(self):
+        path = xconfig.DATA_DIR
+        resp = json_request("/fs_api/add_file", method="POST",
+                            data=dict(path=path, filename="test_fs.txt"))
+        print(resp)
+        self.assertEqual("success", resp["code"])
+
+    def test_create_dir(self):
+        path = xconfig.DATA_DIR
+        resp = json_request("/fs_api/add_dir", method="POST",
+                            data=dict(path=path, filename="test_fs_dir"))
+        print(resp)
+        self.assertEqual("success", resp["code"])
+    
+    def test_code_preview(self):
+        self.check_OK("/code/preview?path=./README.md")
+
+    def test_build_fs_index(self):
+        size = build_fs_index(xconfig.DATA_DIR, sync=True)
+        self.assertTrue(size > 0)
+    
+    def test_fs_index_manage_page(self):
+        path = xutils.quote("./testdata")
+        self.check_OK("/fs_index?action=reindex&path={path}".format(path=path), method="POST")
+        self.check_OK("/fs_index?p=rebuild")
+        self.check_OK("/fs_index")
+
+    def test_config_fs_order(self):
+        resp = json_request("/fs_api/config", method = "POST", data = dict(action = "sort", order = "size"))
+        print(resp)
+        self.assertEqual("success", resp["code"])
+        
+        user_name = xauth.current_name()
+        self.assertEqual("size", xauth.get_user_config(user_name, "fs_order"))
+    
+    def test_fs_config_error(self):
+        resp = json_request("/fs_api/config", method = "POST", data = dict(action = "notfount", order = "size"))
+        print(resp)
+        self.assertEqual("error", resp["code"])
+    
+    def test_fs_sidebar(self):
+        path = os.getcwd()
+        txt_path = get_test_file_path("./fs_preview_test.txt")
+        with open(txt_path, "w+") as fp:
+            fp.write("test fs preview")
+
+        self.check_OK("/fs_sidebar?path={path}".format(path=path))
+        self.check_OK("/fs_preview?path={txt_path}".format(txt_path=txt_path))
+
+    def test_fs_find(self):
+        self.check_OK("/fs_find?key=test")
+    
+    def test_fs_find_in_cache(self):
+        xconfig.USE_CACHE_SEARCH = True
+        self.check_OK("/fs_find?key=test")
+
+    def test_fs_upload_search(self):
         self.check_OK("/fs_upload/search?key=" + xutils.quote("test"))
```

### Comparing `xnote-web-0.1.0/tests/test_message.py` & `xnote-web-0.1.1/tests/test_message.py`

 * *Ordering differences only*

 * *Files 26% similar despite different names*

```diff
@@ -1,306 +1,306 @@
-# encoding=utf-8
-# Created by xupingmao on 2017/05/23
-# @modified 2022/04/17 14:28:57
-
-from .a import *
-import os
-from xnote.core import xtemplate
-from xnote.core import xconfig
-from xnote.core import xauth
-
-from xutils import Storage
-from xutils import dbutil
-from xutils import dateutil, dbutil
-from xutils import logutil
-
-# cannot perform relative import
-try:
-    import test_base
-except ImportError:
-    from tests import test_base
-
-app = test_base.init()
-json_request = test_base.json_request
-json_request_return_dict = test_base.json_request_return_dict
-request_html = test_base.request_html
-BaseTestCase = test_base.BaseTestCase
-
-# 必须init之后再import
-
-import handlers.message.dao as msg_dao
-
-
-MSG_DB = dbutil.get_table("message")
-
-
-def get_script_path(name):
-    return os.path.join(xconfig.SCRIPTS_DIR, name)
-
-
-def del_msg_by_id(id):
-    json_request("/message/delete", method="POST", data=dict(id=id))
-
-
-def delete_all_messages():
-    for record in MSG_DB.iter(limit=-1):
-        MSG_DB.delete_by_key(record._key)
-
-
-class TextPage(xtemplate.BaseTextPlugin):
-
-    def get_input(self):
-        return ""
-
-    def get_format(self):
-        return ""
-
-    def handle(self, input):
-        return "test"
-
-
-class TestMain(BaseTestCase):
-
-    def test_message_create_and_update(self):
-        # Py2: webpy会自动把str对象转成unicode对象，data参数传unicode反而会有问题
-        from handlers.message.dao import MessageDao
-        response = json_request(
-            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test"))
-        self.assertEqual("success", response.get("code"))
-        data = response.get("data")
-        # Py2: 判断的时候必须使用unicode
-        self.assertEqual(u"Xnote-Unit-Test", data.get("content"))
-        json_request("/message/touch", method="POST",
-                     data=dict(id=data.get("id")))
-
-        msg_id = data.get("id")
-
-        update_result = json_request(
-            "/message/save", method="POST", data=dict(id=msg_id, content="New Content"))
-        self.assertEqual("success", update_result["code"])
-
-        data = MessageDao.get_by_id(msg_id)
-        assert data != None
-        assert data.tag == "log"
-        assert data.status == None
-
-        self.assertEqual("New Content", data.content)
-
-        json_request("/message/delete", method="POST",
-                     data=dict(id=data.id))
-
-    def test_message_list(self):
-        json_request("/message/list")
-        json_request("/message/list?status=created")
-        json_request("/message/list?status=suspended")
-        json_request("/message/list?tag=file")
-        json_request("/message/list?tag=link")
-        json_request("/message/list?tag=todo")
-        # search
-        json_request("/message/list?key=1")
-
-        self.check_OK("/message/list?format=html")
-
-    def test_message_finish(self):
-        response = json_request_return_dict(
-            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test", tag="task"))
-
-        self.assertEqual("success", response.get("code"))
-        data = response.get("data")
-        assert isinstance(data, dict)
-
-        msg_id = data['id']
-
-        json_request("/message/finish", method="POST", data=dict(id=msg_id))
-        done_result = json_request_return_dict("/message/list?tag=done")
-
-        self.assertEqual("success", done_result['code'])
-
-        done_list = done_result['data']
-        self.assertEqual(1, len(done_list))
-
-        for msg in done_list:
-            del_msg_by_id(msg['id'])
-
-    def count_message_key(self):
-        response = json_request("/message/list?tag=key")
-        assert isinstance(response, dict)
-        assert response.get("code") == "success"
-        return len(response.get("data"))
-
-    def test_message_key(self):
-        key_result = json_request("/message/list?tag=key")
-        assert isinstance(key_result, dict)
-
-        for item in key_result["data"]:
-            del_msg_by_id(item["id"])
-
-        assert self.count_message_key() == 0
-
-        response = json_request_return_dict(
-            "/message/save", method="POST", data=dict(content="#Xnote-Unit-Test#", tag="log"))
-
-        self.assertEqual("success", response.get("code"))
-        data = response.get("data")
-        msg_id = data['id']
-
-        assert self.count_message_key() == 1
-
-        del_msg_by_id(msg_id)
-
-    def test_message_stat(self):
-        result = json_request("/message/stat")
-        self.assertTrue(result.get("cron_count") != None)
-
-    def test_message_todo(self):
-        self.check_OK("/message/todo")
-        self.check_OK("/message/done")
-
-    def test_list_by_month(self):
-        self.check_OK("/message/date?date=2021-05")
-
-    def test_list_by_day(self):
-        # 创建一条记录
-        response = json_request("/message/save", method="POST",
-                                data=dict(content="Xnote-Unit-Test", tag="log"))
-
-        month = dateutil.format_date(fmt="%Y-%m")
-        date = dateutil.format_date()
-        self.check_OK("/message/list_by_day?date=" + month)
-        self.check_OK("/message?date=" + date)
-
-    def test_message_refresh(self):
-        self.check_OK("/message/refresh")
-
-    def test_message_task_tags(self):
-        # 创建一条记录
-        response = json_request("/message/save", method="POST",
-                                data=dict(content="#TEST# Xnote-Unit-Test", tag="task"))
-
-        self.check_OK("/message?tag=task_tags")
-
-    def test_message_task(self):
-        self.check_OK("/message?tag=task")
-        self.check_OK("/message?tag=task&action=create")
-        self.check_OK("/message?tag=task&filterKey=test")
-
-    def test_task_create_and_done(self):
-        # Py2: webpy会自动把str对象转成unicode对象，data参数传unicode反而会有问题
-        response = json_request_return_dict("/message/save", method="POST",
-                                            data=dict(content="Xnote-Unit-Test-Task", tag="task"))
-        self.assertEqual("success", response.get("code"))
-        data = response.get("data")
-        assert isinstance(data, dict)
-
-        # Py2: 判断的时候必须使用unicode
-        self.assertEqual(u"Xnote-Unit-Test-Task", data.get("content"))
-
-        task_id = data["id"]
-
-        update_result = json_request_return_dict("/message/finish", method="POST",
-                                                 data=dict(id=task_id))
-        self.assertEqual("success", update_result.get("code"))
-
-        self.check_OK("/message/detail?id=%s" % task_id)
-
-        logutil.wait_task_done()
-
-        # 重新把任务开启
-        open_result = json_request_return_dict("/message/tag", method="POST",
-                                               data=dict(id=task_id, tag="task"))
-        assert open_result["success"] == True
-
-        data = msg_dao.get_message_by_id(task_id)
-        assert data != None
-        assert data.tag == "task"
-
-    def test_message_dairy(self):
-        self.check_OK("/message/dairy")
-
-    def test_message_search(self):
-        delete_all_messages()
-
-        user_name = xauth.current_name_str()
-
-        create_data = dict(content="Xnote-Unit-Test")
-        response = json_request(
-            "/message/save", method="POST", data=create_data)
-
-        assert isinstance(response, dict)
-        resp_data = response.get("data")
-        assert isinstance(resp_data, dict)
-        new_msg_id = resp_data.get("id")
-        self.assertEqual("success", response.get("code"))
-
-        from handlers.message.message_search import on_search_message, SearchHandler
-        ctx = Storage(key="xnote", user_name=user_name, messages=[])
-        on_search_message(ctx)
-        # 两条记录（第一个是汇总，第二个是实际数据）
-        self.assertEqual(2, len(ctx.messages))
-        self.assertEqual("Xnote-Unit-Test", ctx.messages[1].html)
-
-        search_list, amount = SearchHandler().get_ajax_data(
-            user_name=user_name, key="xnote")
-        assert amount == 1
-        assert len(search_list) == 1
-        assert search_list[0].id == new_msg_id
-        assert search_list[0].sort_value != ""
-
-    def test_message_search_page(self):
-        self.check_OK("/message?tag=search&key=123")
-
-    def test_message_keyword_mark(self):
-        user_name = xauth.current_name_str()
-        from handlers.message.dao import MsgTagInfoDao
-        tags = MsgTagInfoDao.list(user=user_name, content="#test#")
-        for tag in tags:
-            print("删除tag:", tag)
-            MsgTagInfoDao.delete(tag)
-
-        response = json_request(
-            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test #test#"))
-
-        assert isinstance(response, dict)
-
-        self.assertEqual("success", response.get("code"))
-
-        result = json_request("/message/keyword", method="POST",
-                              data=dict(action="mark", keyword="#test#"))
-        assert isinstance(result, dict)
-
-        self.assertEqual("success", result["code"])
-
-        from handlers.message.message import get_or_create_keyword
-
-        user_name = xauth.current_name()
-        keyword = get_or_create_keyword(user_name, "#test#", "127.0.0.1")
-        print(keyword)
-
-        assert keyword != None
-        self.assertTrue(keyword.is_marked == True)
-
-        logutil.wait_task_done()
-
-    def test_message_keyword_delete(self):
-        from handlers.message.dao import MessageDO
-        user_name = xauth.current_name_str()
-        tagname = "#delete-test#"
-
-        tagInfo = msg_dao.MsgTagInfoDao.get_or_create(user_name, tagname)
-        keyword = msg_dao.get_by_content(user_name, "key", tagname)
-        assert keyword != None
-        assert keyword.content == tagname
-
-        resp = json_request_return_dict(
-            "/message/delete", method="POST", data=dict(id=tagInfo.id))
-        print("resp=", resp)
-
-        self.assertEqual("success", resp["code"])
-
-        keyword = msg_dao.get_by_content(user_name, "key", tagname)
-        print(keyword)
-        self.assertIsNone(keyword)
-
-        logutil.wait_task_done()
-
-    def test_message_calendar(self):
-        self.check_OK("/message/calendar")
+# encoding=utf-8
+# Created by xupingmao on 2017/05/23
+# @modified 2022/04/17 14:28:57
+
+from .a import *
+import os
+from xnote.core import xtemplate
+from xnote.core import xconfig
+from xnote.core import xauth
+
+from xutils import Storage
+from xutils import dbutil
+from xutils import dateutil, dbutil
+from xutils import logutil
+
+# cannot perform relative import
+try:
+    import test_base
+except ImportError:
+    from tests import test_base
+
+app = test_base.init()
+json_request = test_base.json_request
+json_request_return_dict = test_base.json_request_return_dict
+request_html = test_base.request_html
+BaseTestCase = test_base.BaseTestCase
+
+# 必须init之后再import
+
+import handlers.message.dao as msg_dao
+
+
+MSG_DB = dbutil.get_table("message")
+
+
+def get_script_path(name):
+    return os.path.join(xconfig.SCRIPTS_DIR, name)
+
+
+def del_msg_by_id(id):
+    json_request("/message/delete", method="POST", data=dict(id=id))
+
+
+def delete_all_messages():
+    for record in MSG_DB.iter(limit=-1):
+        MSG_DB.delete_by_key(record._key)
+
+
+class TextPage(xtemplate.BaseTextPlugin):
+
+    def get_input(self):
+        return ""
+
+    def get_format(self):
+        return ""
+
+    def handle(self, input):
+        return "test"
+
+
+class TestMain(BaseTestCase):
+
+    def test_message_create_and_update(self):
+        # Py2: webpy会自动把str对象转成unicode对象，data参数传unicode反而会有问题
+        from handlers.message.dao import MessageDao
+        response = json_request(
+            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test"))
+        self.assertEqual("success", response.get("code"))
+        data = response.get("data")
+        # Py2: 判断的时候必须使用unicode
+        self.assertEqual(u"Xnote-Unit-Test", data.get("content"))
+        json_request("/message/touch", method="POST",
+                     data=dict(id=data.get("id")))
+
+        msg_id = data.get("id")
+
+        update_result = json_request(
+            "/message/save", method="POST", data=dict(id=msg_id, content="New Content"))
+        self.assertEqual("success", update_result["code"])
+
+        data = MessageDao.get_by_id(msg_id)
+        assert data != None
+        assert data.tag == "log"
+        assert data.status == None
+
+        self.assertEqual("New Content", data.content)
+
+        json_request("/message/delete", method="POST",
+                     data=dict(id=data.id))
+
+    def test_message_list(self):
+        json_request("/message/list")
+        json_request("/message/list?status=created")
+        json_request("/message/list?status=suspended")
+        json_request("/message/list?tag=file")
+        json_request("/message/list?tag=link")
+        json_request("/message/list?tag=todo")
+        # search
+        json_request("/message/list?key=1")
+
+        self.check_OK("/message/list?format=html")
+
+    def test_message_finish(self):
+        response = json_request_return_dict(
+            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test", tag="task"))
+
+        self.assertEqual("success", response.get("code"))
+        data = response.get("data")
+        assert isinstance(data, dict)
+
+        msg_id = data['id']
+
+        json_request("/message/finish", method="POST", data=dict(id=msg_id))
+        done_result = json_request_return_dict("/message/list?tag=done")
+
+        self.assertEqual("success", done_result['code'])
+
+        done_list = done_result['data']
+        self.assertEqual(1, len(done_list))
+
+        for msg in done_list:
+            del_msg_by_id(msg['id'])
+
+    def count_message_key(self):
+        response = json_request("/message/list?tag=key")
+        assert isinstance(response, dict)
+        assert response.get("code") == "success"
+        return len(response.get("data"))
+
+    def test_message_key(self):
+        key_result = json_request("/message/list?tag=key")
+        assert isinstance(key_result, dict)
+
+        for item in key_result["data"]:
+            del_msg_by_id(item["id"])
+
+        assert self.count_message_key() == 0
+
+        response = json_request_return_dict(
+            "/message/save", method="POST", data=dict(content="#Xnote-Unit-Test#", tag="log"))
+
+        self.assertEqual("success", response.get("code"))
+        data = response.get("data")
+        msg_id = data['id']
+
+        assert self.count_message_key() == 1
+
+        del_msg_by_id(msg_id)
+
+    def test_message_stat(self):
+        result = json_request("/message/stat")
+        self.assertTrue(result.get("cron_count") != None)
+
+    def test_message_todo(self):
+        self.check_OK("/message/todo")
+        self.check_OK("/message/done")
+
+    def test_list_by_month(self):
+        self.check_OK("/message/date?date=2021-05")
+
+    def test_list_by_day(self):
+        # 创建一条记录
+        response = json_request("/message/save", method="POST",
+                                data=dict(content="Xnote-Unit-Test", tag="log"))
+
+        month = dateutil.format_date(fmt="%Y-%m")
+        date = dateutil.format_date()
+        self.check_OK("/message/list_by_day?date=" + month)
+        self.check_OK("/message?date=" + date)
+
+    def test_message_refresh(self):
+        self.check_OK("/message/refresh")
+
+    def test_message_task_tags(self):
+        # 创建一条记录
+        response = json_request("/message/save", method="POST",
+                                data=dict(content="#TEST# Xnote-Unit-Test", tag="task"))
+
+        self.check_OK("/message?tag=task_tags")
+
+    def test_message_task(self):
+        self.check_OK("/message?tag=task")
+        self.check_OK("/message?tag=task&action=create")
+        self.check_OK("/message?tag=task&filterKey=test")
+
+    def test_task_create_and_done(self):
+        # Py2: webpy会自动把str对象转成unicode对象，data参数传unicode反而会有问题
+        response = json_request_return_dict("/message/save", method="POST",
+                                            data=dict(content="Xnote-Unit-Test-Task", tag="task"))
+        self.assertEqual("success", response.get("code"))
+        data = response.get("data")
+        assert isinstance(data, dict)
+
+        # Py2: 判断的时候必须使用unicode
+        self.assertEqual(u"Xnote-Unit-Test-Task", data.get("content"))
+
+        task_id = data["id"]
+
+        update_result = json_request_return_dict("/message/finish", method="POST",
+                                                 data=dict(id=task_id))
+        self.assertEqual("success", update_result.get("code"))
+
+        self.check_OK("/message/detail?id=%s" % task_id)
+
+        logutil.wait_task_done()
+
+        # 重新把任务开启
+        open_result = json_request_return_dict("/message/tag", method="POST",
+                                               data=dict(id=task_id, tag="task"))
+        assert open_result["success"] == True
+
+        data = msg_dao.get_message_by_id(task_id)
+        assert data != None
+        assert data.tag == "task"
+
+    def test_message_dairy(self):
+        self.check_OK("/message/dairy")
+
+    def test_message_search(self):
+        delete_all_messages()
+
+        user_name = xauth.current_name_str()
+
+        create_data = dict(content="Xnote-Unit-Test")
+        response = json_request(
+            "/message/save", method="POST", data=create_data)
+
+        assert isinstance(response, dict)
+        resp_data = response.get("data")
+        assert isinstance(resp_data, dict)
+        new_msg_id = resp_data.get("id")
+        self.assertEqual("success", response.get("code"))
+
+        from handlers.message.message_search import on_search_message, SearchHandler
+        ctx = Storage(key="xnote", user_name=user_name, messages=[])
+        on_search_message(ctx)
+        # 两条记录（第一个是汇总，第二个是实际数据）
+        self.assertEqual(2, len(ctx.messages))
+        self.assertEqual("Xnote-Unit-Test", ctx.messages[1].html)
+
+        search_list, amount = SearchHandler().get_ajax_data(
+            user_name=user_name, key="xnote")
+        assert amount == 1
+        assert len(search_list) == 1
+        assert search_list[0].id == new_msg_id
+        assert search_list[0].sort_value != ""
+
+    def test_message_search_page(self):
+        self.check_OK("/message?tag=search&key=123")
+
+    def test_message_keyword_mark(self):
+        user_name = xauth.current_name_str()
+        from handlers.message.dao import MsgTagInfoDao
+        tags = MsgTagInfoDao.list(user=user_name, content="#test#")
+        for tag in tags:
+            print("删除tag:", tag)
+            MsgTagInfoDao.delete(tag)
+
+        response = json_request(
+            "/message/save", method="POST", data=dict(content="Xnote-Unit-Test #test#"))
+
+        assert isinstance(response, dict)
+
+        self.assertEqual("success", response.get("code"))
+
+        result = json_request("/message/keyword", method="POST",
+                              data=dict(action="mark", keyword="#test#"))
+        assert isinstance(result, dict)
+
+        self.assertEqual("success", result["code"])
+
+        from handlers.message.message import get_or_create_keyword
+
+        user_name = xauth.current_name()
+        keyword = get_or_create_keyword(user_name, "#test#", "127.0.0.1")
+        print(keyword)
+
+        assert keyword != None
+        self.assertTrue(keyword.is_marked == True)
+
+        logutil.wait_task_done()
+
+    def test_message_keyword_delete(self):
+        from handlers.message.dao import MessageDO
+        user_name = xauth.current_name_str()
+        tagname = "#delete-test#"
+
+        tagInfo = msg_dao.MsgTagInfoDao.get_or_create(user_name, tagname)
+        keyword = msg_dao.get_by_content(user_name, "key", tagname)
+        assert keyword != None
+        assert keyword.content == tagname
+
+        resp = json_request_return_dict(
+            "/message/delete", method="POST", data=dict(id=tagInfo.id))
+        print("resp=", resp)
+
+        self.assertEqual("success", resp["code"])
+
+        keyword = msg_dao.get_by_content(user_name, "key", tagname)
+        print(keyword)
+        self.assertIsNone(keyword)
+
+        logutil.wait_task_done()
+
+    def test_message_calendar(self):
+        self.check_OK("/message/calendar")
```

### Comparing `xnote-web-0.1.0/tests/test_search.py` & `xnote-web-0.1.1/tests/test_search.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_service.py` & `xnote-web-0.1.1/tests/test_service.py`

 * *Ordering differences only*

 * *Files 18% similar despite different names*

```diff
@@ -1,63 +1,63 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-04-04 00:01:38
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-04 01:07:22
-@FilePath     : /xnote/tests/test_service.py
-@Description  : 描述
-"""
-import time
-from . import test_base
-from xnote.core import xtables
-from xnote.service import DatabaseLockService
-
-app = test_base.init()
-
-class TestMain(test_base.BaseTestCase):
-    """测试管理后台的功能"""
-
-    db = xtables.get_table_by_name("t_lock")
-
-    def get_lock_record_by_key(self, lock_key=""):
-        return self.db.select_first(where=dict(lock_key=lock_key))    
-    
-    def test_lock_service_conflict(self):
-        lock_key = "test_conflict"
-
-        lock1 = DatabaseLockService.lock(lock_key)
-        assert self.get_lock_record_by_key(lock_key) != None
-
-        try:
-            lock2 = DatabaseLockService.lock(lock_key)
-            assert False
-        except:
-            assert True
-        
-        lock1.release()
-
-        assert self.get_lock_record_by_key(lock_key) == None
-    
-    def test_lock_and_free(self):
-        lock_key = "test_lock_and_free"
-        with DatabaseLockService.lock(lock_key):
-            assert self.get_lock_record_by_key(lock_key) != None
-            print("do some work")
-        
-        assert self.get_lock_record_by_key(lock_key) == None
-
-    def test_lock_timeout(self):
-        lock_key = "test_lock_timeout"
-        with DatabaseLockService.lock(lock_key, timeout_seconds=0.1):
-            assert self.get_lock_record_by_key(lock_key) != None
-            time.sleep(0.5)
-            t2 = DatabaseLockService.lock(lock_key)
-            assert t2.got_lock
-            current_lock = self.get_lock_record_by_key(lock_key)
-            assert current_lock != None
-            assert current_lock.lock_token == t2.lock_token
-        
-        current_lock = self.get_lock_record_by_key(lock_key)
-        assert current_lock != None
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-04-04 00:01:38
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-04 01:07:22
+@FilePath     : /xnote/tests/test_service.py
+@Description  : 描述
+"""
+import time
+from . import test_base
+from xnote.core import xtables
+from xnote.service import DatabaseLockService
+
+app = test_base.init()
+
+class TestMain(test_base.BaseTestCase):
+    """测试管理后台的功能"""
+
+    db = xtables.get_table_by_name("t_lock")
+
+    def get_lock_record_by_key(self, lock_key=""):
+        return self.db.select_first(where=dict(lock_key=lock_key))    
+    
+    def test_lock_service_conflict(self):
+        lock_key = "test_conflict"
+
+        lock1 = DatabaseLockService.lock(lock_key)
+        assert self.get_lock_record_by_key(lock_key) != None
+
+        try:
+            lock2 = DatabaseLockService.lock(lock_key)
+            assert False
+        except:
+            assert True
+        
+        lock1.release()
+
+        assert self.get_lock_record_by_key(lock_key) == None
+    
+    def test_lock_and_free(self):
+        lock_key = "test_lock_and_free"
+        with DatabaseLockService.lock(lock_key):
+            assert self.get_lock_record_by_key(lock_key) != None
+            print("do some work")
+        
+        assert self.get_lock_record_by_key(lock_key) == None
+
+    def test_lock_timeout(self):
+        lock_key = "test_lock_timeout"
+        with DatabaseLockService.lock(lock_key, timeout_seconds=0.1):
+            assert self.get_lock_record_by_key(lock_key) != None
+            time.sleep(0.5)
+            t2 = DatabaseLockService.lock(lock_key)
+            assert t2.got_lock
+            current_lock = self.get_lock_record_by_key(lock_key)
+            assert current_lock != None
+            assert current_lock.lock_token == t2.lock_token
+        
+        current_lock = self.get_lock_record_by_key(lock_key)
+        assert current_lock != None
+
```

### Comparing `xnote-web-0.1.0/tests/test_system_sync.py` & `xnote-web-0.1.1/tests/test_system_sync.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_user.py` & `xnote-web-0.1.1/tests/test_user.py`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,36 +1,36 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2020/01/25 12:48:47
-# @modified 2021/09/19 22:49:36
-
-import sys
-import time
-import unittest
-from xnote.core import xauth
-
-# cannot perform relative import
-try:
-    import test_base
-except ImportError:
-    from tests import test_base
-
-BaseTestCase = test_base.BaseTestCase
-
-app = test_base.init()
-
-class TestUser(BaseTestCase):
-
-    def test_login_page(self):
-        self.check_OK("/login")
-
-
-    def test_change_password(self):
-        self.check_OK("/user/change_password")
-
-    def test_user_oplog(self):
-        self.check_OK("/user/op_log")
-
-    def test_user_session(self):
-        self.check_OK("/user/session")
-
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2020/01/25 12:48:47
+# @modified 2021/09/19 22:49:36
+
+import sys
+import time
+import unittest
+from xnote.core import xauth
+
+# cannot perform relative import
+try:
+    import test_base
+except ImportError:
+    from tests import test_base
+
+BaseTestCase = test_base.BaseTestCase
+
+app = test_base.init()
+
+class TestUser(BaseTestCase):
+
+    def test_login_page(self):
+        self.check_OK("/login")
+
+
+    def test_change_password(self):
+        self.check_OK("/user/change_password")
+
+    def test_user_oplog(self):
+        self.check_OK("/user/op_log")
+
+    def test_user_session(self):
+        self.check_OK("/user/session")
+
```

### Comparing `xnote-web-0.1.0/tests/test_xauth.py` & `xnote-web-0.1.1/tests/test_xauth.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,175 +1,175 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2020/01/24 16:39:45
-# @modified 2022/04/04 14:11:51
-
-import sys
-import time
-import unittest
-from xnote.core import xauth
-from xnote.core import xnote_user_config
-from xutils import Storage
-from xutils import dateutil
-
-# cannot perform relative import
-try:
-    import test_base
-except ImportError:
-    from tests import test_base
-
-BaseTestCase = test_base.BaseTestCase
-
-app = test_base.init()
-
-class TestXauth(BaseTestCase):
-
-    def test_current_user(self):
-        self.assertEqual("admin", xauth.current_name())
-        
-    def test_check_invalid_names(self):
-        self.assertTrue(xauth.is_valid_username("t1234"))
-        self.assertFalse(xauth.is_valid_username("public"))
-
-    def test_create_and_delete_user(self):
-        old_count = xauth.count_user()
-
-        # 创建用户
-        result = xauth.create_user("u123456", "123456")
-        print(result)
-        
-        self.assertEqual(old_count+1, xauth.count_user())
-
-        # 删除用户
-        xauth.delete_user("u123456")
-
-        check = xauth.find_by_name("u123456")
-        self.assertEqual(None, check)
-
-    def test_count_user(self):
-        self.assertTrue(xauth.count_user() >= 1)
-
-    def test_login_logout(self):
-        self.check_OK("/")
-        # TODO 待修复
-        # AttributeError: 'ThreadedDict' object has no attribute 'homepath'
-        # xauth.login_user_by_name("test")
-        # xauth.logout_current_user()
-
-    def test_create_and_list_user_session(self):
-        # 先清理
-        for session_info in xauth.list_user_session_detail("admin"):
-            xauth.delete_user_session_by_id(session_info.sid)
-
-        # 创建并且查询
-        xauth.create_user_session("admin")
-        result = xauth.list_user_session_detail("admin")
-        self.assertEqual(1, len(result))
-
-    def test_update_user(self):
-        result = xauth.create_user("u123456", "123456")
-        print(result)
-
-        datetime = dateutil.format_time()
-        user_info = Storage(login_time = datetime)
-        xauth.update_user("u123456", user_info)
-
-        self.assertTrue(datetime, xauth.get_user_by_name("u123456").login_time)
-
-        xauth.delete_user("u123456")
-
-    def test_get_user_by_token(self):
-        user_name = "u123456"
-        result = xauth.create_user(user_name, "123456")
-        print(result)
-
-        datetime = dateutil.format_time()
-        token = "token123456"
-        user_info = Storage(login_time = datetime)
-        user_info.token = token
-
-        xauth.update_user("u123456", user_info)
-
-        found = xauth.UserModel.get_by_token(token)
-        self.assertEqual(user_name, found.name)
-
-        xauth.delete_user("u123456")
-
-    def test_user_config(self):
-        user_name = "u123456"
-        result = xauth.create_user(user_name, user_name)
-        print(result)
-
-        config = xauth.get_user_config_dict(user_name)
-        self.assertEqual("false", config.show_comment_edit)
-
-        xauth.update_user_config(user_name, "show_comment_edit", "true")
-
-        config = xauth.get_user_config_dict(user_name)
-        self.assertEqual("true", config.show_comment_edit)
-
-        xauth.delete_user(user_name)
-
-
-    def test_create_quick_user(self):
-        user_info = xauth.create_quick_user()
-        assert user_info != None
-        assert len(user_info.password_md5) > 0
-        xauth.delete_user(user_info.name)
-
-
-    def test_change_password(self):
-        user_name = "change_pass_test"
-        password = "123456"
-        xauth.delete_user(user_name)
-        resp = xauth.create_user(user_name, password)
-        assert resp.get("code") == "success"
-        xauth.check_old_password(user_name, password)
-        try:
-            xauth.check_old_password(user_name, password + "2")
-            self.fail("expect exception")
-        except:
-            pass
-
-    def test_login(self):
-        user_name = "test"
-        session_info = xauth.login_user_by_name(user_name, write_cookie=False)
-        assert xauth.has_login_by_sid(user_name, session_info.sid)
-
-    def test_user_config_2(self):
-        from xnote.core.xnote_user_config import UserConfigKey
-        user_name = xauth.current_name_str()
-        config_dict = xnote_user_config.get_config_dict(user_name)
-        
-        assert config_dict[UserConfigKey.THEME] == "default"
-        assert config_dict[UserConfigKey.HOME_PATH] == "/note/group"
-        assert config_dict[UserConfigKey.nav_style] == "left"
-
-        
-    def test_user_oplog_clean(self):
-        user_id = xauth.current_user_id()
-        
-        oplog = xauth.UserOpLog()
-        oplog.user_id = user_id
-        oplog.type = "test"
-        oplog.detail = "test clean"
-        
-        xauth.UserOpLogDao.max_log_size = 5
-        xauth.UserOpLogDao.log_buf_size = 1
-        
-        for i in range(10):
-            oplog.detail = "test clean %s" % i
-            xauth.UserOpLogDao.create_op_log(oplog)
-        
-        assert xauth.UserOpLogDao.count(user_id=user_id) == 5
-        
-        xauth.UserOpLogDao.log_buf_size = 2
-        xauth.UserOpLogDao.create_op_log(oplog)
-        assert xauth.UserOpLogDao.count(user_id=user_id) == 6
-        
-        last_log_detail = "test clean last"
-        oplog.detail = last_log_detail
-        xauth.UserOpLogDao.create_op_log(oplog)
-        assert xauth.UserOpLogDao.count(user_id=user_id) == 5
-        
-        logs = xauth.UserOpLogDao.list_by_user(user_id=user_id)
-        assert logs[0].detail == last_log_detail
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2020/01/24 16:39:45
+# @modified 2022/04/04 14:11:51
+
+import sys
+import time
+import unittest
+from xnote.core import xauth
+from xnote.core import xnote_user_config
+from xutils import Storage
+from xutils import dateutil
+
+# cannot perform relative import
+try:
+    import test_base
+except ImportError:
+    from tests import test_base
+
+BaseTestCase = test_base.BaseTestCase
+
+app = test_base.init()
+
+class TestXauth(BaseTestCase):
+
+    def test_current_user(self):
+        self.assertEqual("admin", xauth.current_name())
+        
+    def test_check_invalid_names(self):
+        self.assertTrue(xauth.is_valid_username("t1234"))
+        self.assertFalse(xauth.is_valid_username("public"))
+
+    def test_create_and_delete_user(self):
+        old_count = xauth.count_user()
+
+        # 创建用户
+        result = xauth.create_user("u123456", "123456")
+        print(result)
+        
+        self.assertEqual(old_count+1, xauth.count_user())
+
+        # 删除用户
+        xauth.delete_user("u123456")
+
+        check = xauth.find_by_name("u123456")
+        self.assertEqual(None, check)
+
+    def test_count_user(self):
+        self.assertTrue(xauth.count_user() >= 1)
+
+    def test_login_logout(self):
+        self.check_OK("/")
+        # TODO 待修复
+        # AttributeError: 'ThreadedDict' object has no attribute 'homepath'
+        # xauth.login_user_by_name("test")
+        # xauth.logout_current_user()
+
+    def test_create_and_list_user_session(self):
+        # 先清理
+        for session_info in xauth.list_user_session_detail("admin"):
+            xauth.delete_user_session_by_id(session_info.sid)
+
+        # 创建并且查询
+        xauth.create_user_session("admin")
+        result = xauth.list_user_session_detail("admin")
+        self.assertEqual(1, len(result))
+
+    def test_update_user(self):
+        result = xauth.create_user("u123456", "123456")
+        print(result)
+
+        datetime = dateutil.format_time()
+        user_info = Storage(login_time = datetime)
+        xauth.update_user("u123456", user_info)
+
+        self.assertTrue(datetime, xauth.get_user_by_name("u123456").login_time)
+
+        xauth.delete_user("u123456")
+
+    def test_get_user_by_token(self):
+        user_name = "u123456"
+        result = xauth.create_user(user_name, "123456")
+        print(result)
+
+        datetime = dateutil.format_time()
+        token = "token123456"
+        user_info = Storage(login_time = datetime)
+        user_info.token = token
+
+        xauth.update_user("u123456", user_info)
+
+        found = xauth.UserModel.get_by_token(token)
+        self.assertEqual(user_name, found.name)
+
+        xauth.delete_user("u123456")
+
+    def test_user_config(self):
+        user_name = "u123456"
+        result = xauth.create_user(user_name, user_name)
+        print(result)
+
+        config = xauth.get_user_config_dict(user_name)
+        self.assertEqual("false", config.show_comment_edit)
+
+        xauth.update_user_config(user_name, "show_comment_edit", "true")
+
+        config = xauth.get_user_config_dict(user_name)
+        self.assertEqual("true", config.show_comment_edit)
+
+        xauth.delete_user(user_name)
+
+
+    def test_create_quick_user(self):
+        user_info = xauth.create_quick_user()
+        assert user_info != None
+        assert len(user_info.password_md5) > 0
+        xauth.delete_user(user_info.name)
+
+
+    def test_change_password(self):
+        user_name = "change_pass_test"
+        password = "123456"
+        xauth.delete_user(user_name)
+        resp = xauth.create_user(user_name, password)
+        assert resp.get("code") == "success"
+        xauth.check_old_password(user_name, password)
+        try:
+            xauth.check_old_password(user_name, password + "2")
+            self.fail("expect exception")
+        except:
+            pass
+
+    def test_login(self):
+        user_name = "test"
+        session_info = xauth.login_user_by_name(user_name, write_cookie=False)
+        assert xauth.has_login_by_sid(user_name, session_info.sid)
+
+    def test_user_config_2(self):
+        from xnote.core.xnote_user_config import UserConfigKey
+        user_name = xauth.current_name_str()
+        config_dict = xnote_user_config.get_config_dict(user_name)
+        
+        assert config_dict[UserConfigKey.THEME] == "default"
+        assert config_dict[UserConfigKey.HOME_PATH] == "/note/group"
+        assert config_dict[UserConfigKey.nav_style] == "left"
+
+        
+    def test_user_oplog_clean(self):
+        user_id = xauth.current_user_id()
+        
+        oplog = xauth.UserOpLog()
+        oplog.user_id = user_id
+        oplog.type = "test"
+        oplog.detail = "test clean"
+        
+        xauth.UserOpLogDao.max_log_size = 5
+        xauth.UserOpLogDao.log_buf_size = 1
+        
+        for i in range(10):
+            oplog.detail = "test clean %s" % i
+            xauth.UserOpLogDao.create_op_log(oplog)
+        
+        assert xauth.UserOpLogDao.count(user_id=user_id) == 5
+        
+        xauth.UserOpLogDao.log_buf_size = 2
+        xauth.UserOpLogDao.create_op_log(oplog)
+        assert xauth.UserOpLogDao.count(user_id=user_id) == 6
+        
+        last_log_detail = "test clean last"
+        oplog.detail = last_log_detail
+        xauth.UserOpLogDao.create_op_log(oplog)
+        assert xauth.UserOpLogDao.count(user_id=user_id) == 5
+        
+        logs = xauth.UserOpLogDao.list_by_user(user_id=user_id)
+        assert logs[0].detail == last_log_detail
```

### Comparing `xnote-web-0.1.0/tests/test_xmanager.py` & `xnote-web-0.1.1/tests/test_xmanager.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_xutils_cache.py` & `xnote-web-0.1.1/tests/test_xutils_cache.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_xutils_db_hash_table.py` & `xnote-web-0.1.1/tests/test_xutils_db_hash_table.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/tests/test_xutils_db_table.py` & `xnote-web-0.1.1/tests/test_xutils_db_table.py`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,277 +1,277 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-08-14 17:17:50
-@LastEditors  : xupingmao
-@LastEditTime : 2023-11-05 22:27:59
-@FilePath     : /xnote/tests/test_xutils_db_table.py
-@Description  : table测试
-"""
-
-from .a import *
-from xutils import Storage
-from xutils import dbutil
-from xutils.db.encode import decode_id
-
-from . import test_base
-
-from xutils.dbutil import DBException
-
-app = test_base.init()
-json_request = test_base.json_request
-request_html = test_base.request_html
-BaseTestCase = test_base.BaseTestCase
-
-with xtables.create_default_table_manager("test_index", check_table_define=False) as manager:
-    manager.add_column("name", "varchar(50)", "")
-
-db = dbutil.register_table("test", "测试数据库")
-db.register_index("name")
-db.register_index("age")
-
-dbutil.register_table("test_user_db1", "测试数据库用户版v1")
-dbutil.register_table("test_user_db", "测试数据库用户版", user_attr="user")
-
-db = dbutil.register_table("test_v2_table", "测试V2表", index_db=xtables.get_table_by_name("test_index"))
-
-class RecordV2DO(Storage):
-
-    def __init__(self, **kw):
-        self.name = ""
-        self.age = 0
-        self.update(kw)
-
-class TestMain(BaseTestCase):
-
-    def test_table_with_user_in_class(self):
-        db1 = dbutil.get_table("test_user_db1", user_name="Ada")
-        db2 = dbutil.get_table("test_user_db1", user_name="Bob")
-
-        for item in db1.iter(limit=-1):
-            db1.delete(item)
-        for item in db2.iter(limit=-1):
-            db2.delete(item)
-
-        db1.insert(dict(user="Ada", prop="key1", prop_value="222"), id_type = "auto_increment")
-        db1.insert(dict(user="Ada", prop="key2", prop_value="333"), id_type = "auto_increment")
-
-        db2.insert(dict(user="Bob", prop="key3", prop_value="111"), id_type = "auto_increment")
-        db2.insert(dict(user="Bob", prop="key4", prop_value="111"), id_type = "auto_increment")
-
-        result1 = db1.list(limit=-1)
-
-        self.assertTrue(len(result1) > 0)
-
-        first = db1.get_first()
-        self.assertEqual("key1", first.prop)
-        self.assertEqual("test_user_db1:Ada:"+first._id, first._key)
-
-        last = db1.get_last()
-        self.assertEqual("key2", last.prop)
-
-        # 通过key进行更新和查询
-        first.job = "painter"
-        db1.update_by_key(first._key, first)
-        first = db1.get_by_key(first._key)
-        self.assertEqual("painter", first.job)
-
-        # 通过ID更新和查询
-        first.job = "teacher"
-        db1.update_by_id(first._id, first)
-        first = db1.get_by_id(first._id)
-        self.assertEqual("teacher", first.job)
-
-        # 查询
-        self.assertIsNone(db1.get_by_key(""))
-        self.assertIsNone(db1.get_by_key("test_user_db1:Ada:not_exists"))
-
-        # 删除
-        first = db1.get_first()
-        db1.delete_by_id(first._id)
-
-        self.assertIsNone(db1.get_by_id(first._id))
-        self.assertEqual(1, db1.count())
-    
-    def test_table_with_user_update_error(self):
-        db = dbutil.get_table("test_user_db")
-        obj = Storage(name = "Ada")
-        try:
-            db.update_by_id("2222", obj)
-            self.fail()
-        except DBException as e:
-            self.assertEqual("user属性未设置", e.message)
-
-    def test_table_with_user_in_param(self):
-        db = dbutil.get_table("test_user_db")
-        db.rebuild_index("v1")
-
-        for item in db.iter():
-            db.delete(item)
-
-        db.insert(dict(user="Ada", prop="key1", prop_value="222"))
-        db.insert(dict(user="Ada", prop="key2", prop_value="333"))
-        db.insert_by_user("Bob", dict(
-            user="Bob", prop="key3", prop_value="111"))
-        db.insert_by_user("Bob", dict(
-            user="Bob", prop="key4", prop_value="111"))
-
-        result1 = db.list(limit=-1, user_name="Ada")
-        result2 = db.list_by_func("Ada", limit=-1)
-
-        self.assertTrue(len(result1) > 0)
-        self.assertEqual(result1, result2)
-        self.assertEqual(2, len(result1))
-        self.assertEqual(2, len(db.list_by_user("Ada")))
-
-        first = db.get_first()
-        self.assertEqual("key1", first.prop)
-
-        last = db.get_last()
-        self.assertEqual("key4", last.prop)
-
-        # 通过key进行更新和查询
-        first.job = "painter"
-        db.update_by_key(first._key, first)
-        first = db.get_by_key(first._key)
-        self.assertEqual("painter", first.job)
-
-        # 通过ID更新和查询
-        first.job = "teacher"
-        db.update_by_id(first._id, first, user_name=first.user)
-        first = db.get_by_id(first._id, user_name=first.user)
-        self.assertEqual("teacher", first.job)
-
-    def test_insert(self):
-        obj = Storage(name = "Bob")
-        db = dbutil.get_table("test")
-        for item in db.list():
-            db.delete(item)
-        dbutil.db_delete("_max_id:test")
-        dbutil.db_delete("test:1")
-        new_id = dbutil.insert("test", obj)
-        new_id_int = decode_id(new_id)
-        self.assertEqual(1, new_id_int)
-
-        obj2 = Storage(name = "Carl")
-        new_id2 = dbutil.insert("test", obj2)
-        new_id2_int = decode_id(new_id2)
-        self.assertEqual(2, new_id2_int)
-
-    def test_where(self):
-        db = dbutil.get_table("test")
-        for item in db.iter(limit=-1):
-            db.delete(item)
-        
-        db.insert(dict(name = "name-1", age = 20))
-        db.insert(dict(name = "name-2", age = 21))
-
-        result = db.get_first(where = dict(name = "name-1"))
-        self.assertEqual(20, result.age)
-        self.assertEqual("name-1", result.name)
-
-        where = {
-            "name": {
-                "$prefix": "name"
-            }
-        }
-        result = db.list(where = where, limit = 20)
-        self.assertEqual(2, len(result))
-    
-    def test_where_count(self):
-        db = dbutil.get_table("test")
-        for item in db.iter(limit=-1):
-            db.delete(item)
-        
-        db.insert(dict(name = "name-1", age = 15))
-        db.insert(dict(name = "name-2", age = 15))
-
-        name_index_count = db.count_by_index("age", where = dict(name = "name-1", age = 15))
-        self.assertEqual(1, name_index_count)
-
-    def test_drop_table(self):
-        info = dbutil.register_table("drop_test", "删除测试")
-        db = dbutil.get_table(info.name)
-        db.insert(dict(name="test-1"))
-        db.insert(dict(name="test-2"))
-
-        info.delete_table()
-        test_base.json_request("/system/db/drop_table", method="POST", data=dict(table_name=info.name))
-        
-        self.assertEqual(0, dbutil.count_table(info.name))
-
-class TestMainV2(BaseTestCase):
-
-    def drop_table(self, table_name):
-        db = dbutil.get_table_v2(table_name)
-        for item in db.iter_by_index():
-            db.delete(item)
-        for item in db.iter_by_kv():
-            db.delete(item)
-    
-    def test_crud(self):
-        self.drop_table("test_v2_table")
-        db = dbutil.get_table_v2("test_v2_table")
-        record = RecordV2DO(name = "test", age=20)
-        new_id = db.insert(record)
-
-        record = db.get_by_id(new_id)
-        assert record != None
-        assert record.name == "test"
-        assert record.age == 20
-
-        record = db.select_first(where=dict(name="test"))
-        assert record != None
-        assert record.age == 20
-
-        record.name = "test-2"
-        db.update(record)
-
-        record = db.select_first(where=dict(name="test-2"))
-        assert record != None
-        assert record.age == 20
-        assert record.name == "test-2"
-
-        db.rebuild_index("v1")
-
-
-    def test_select(self):
-        db = dbutil.get_table_v2("test_v2_table")
-        self.drop_table("test_v2_table")
-
-        record = RecordV2DO(name = "test-1", age=20)
-        db.insert(record)
-        record = RecordV2DO(name = "test-2", age=20)
-        db.insert(record)
-        record = RecordV2DO(name = "name-3", age=30)
-        db.insert(record)
-
-        values = db.select(where="name LIKE $name", vars=dict(name="test-%"), limit=20)
-        assert len(values) == 2
-        assert isinstance(values, list)
-        first = values[0]
-        assert first.age == 20
-
-    def test_broken_kv(self):
-        db = dbutil.get_table_v2("test_v2_table")
-        self.drop_table("test_v2_table")
-
-        record = RecordV2DO(name = "test-1", age=20)
-        new_id = db.insert(record)
-
-        # 构建kv数据插入失败的场景
-        dbutil.delete(db.prefix + str(new_id))
-
-        values = db.select(where="name LIKE $name", vars=dict(name="test-%"), limit=20)
-        assert len(values) == 1
-        assert isinstance(values, list)
-        first = values[0]
-        assert first.name == "test-1"
-        assert not hasattr(first, "age") # 没有age属性
-
-        record_by_id = db.get_by_id(new_id)
-        assert record_by_id != None
-        assert record_by_id.name == "test-1"
-        assert not hasattr(record_by_id, "age") # 没有age属性
-
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-08-14 17:17:50
+@LastEditors  : xupingmao
+@LastEditTime : 2023-11-05 22:27:59
+@FilePath     : /xnote/tests/test_xutils_db_table.py
+@Description  : table测试
+"""
+
+from .a import *
+from xutils import Storage
+from xutils import dbutil
+from xutils.db.encode import decode_id
+
+from . import test_base
+
+from xutils.dbutil import DBException
+
+app = test_base.init()
+json_request = test_base.json_request
+request_html = test_base.request_html
+BaseTestCase = test_base.BaseTestCase
+
+with xtables.create_default_table_manager("test_index", check_table_define=False) as manager:
+    manager.add_column("name", "varchar(50)", "")
+
+db = dbutil.register_table("test", "测试数据库")
+db.register_index("name")
+db.register_index("age")
+
+dbutil.register_table("test_user_db1", "测试数据库用户版v1")
+dbutil.register_table("test_user_db", "测试数据库用户版", user_attr="user")
+
+db = dbutil.register_table("test_v2_table", "测试V2表", index_db=xtables.get_table_by_name("test_index"))
+
+class RecordV2DO(Storage):
+
+    def __init__(self, **kw):
+        self.name = ""
+        self.age = 0
+        self.update(kw)
+
+class TestMain(BaseTestCase):
+
+    def test_table_with_user_in_class(self):
+        db1 = dbutil.get_table("test_user_db1", user_name="Ada")
+        db2 = dbutil.get_table("test_user_db1", user_name="Bob")
+
+        for item in db1.iter(limit=-1):
+            db1.delete(item)
+        for item in db2.iter(limit=-1):
+            db2.delete(item)
+
+        db1.insert(dict(user="Ada", prop="key1", prop_value="222"), id_type = "auto_increment")
+        db1.insert(dict(user="Ada", prop="key2", prop_value="333"), id_type = "auto_increment")
+
+        db2.insert(dict(user="Bob", prop="key3", prop_value="111"), id_type = "auto_increment")
+        db2.insert(dict(user="Bob", prop="key4", prop_value="111"), id_type = "auto_increment")
+
+        result1 = db1.list(limit=-1)
+
+        self.assertTrue(len(result1) > 0)
+
+        first = db1.get_first()
+        self.assertEqual("key1", first.prop)
+        self.assertEqual("test_user_db1:Ada:"+first._id, first._key)
+
+        last = db1.get_last()
+        self.assertEqual("key2", last.prop)
+
+        # 通过key进行更新和查询
+        first.job = "painter"
+        db1.update_by_key(first._key, first)
+        first = db1.get_by_key(first._key)
+        self.assertEqual("painter", first.job)
+
+        # 通过ID更新和查询
+        first.job = "teacher"
+        db1.update_by_id(first._id, first)
+        first = db1.get_by_id(first._id)
+        self.assertEqual("teacher", first.job)
+
+        # 查询
+        self.assertIsNone(db1.get_by_key(""))
+        self.assertIsNone(db1.get_by_key("test_user_db1:Ada:not_exists"))
+
+        # 删除
+        first = db1.get_first()
+        db1.delete_by_id(first._id)
+
+        self.assertIsNone(db1.get_by_id(first._id))
+        self.assertEqual(1, db1.count())
+    
+    def test_table_with_user_update_error(self):
+        db = dbutil.get_table("test_user_db")
+        obj = Storage(name = "Ada")
+        try:
+            db.update_by_id("2222", obj)
+            self.fail()
+        except DBException as e:
+            self.assertEqual("user属性未设置", e.message)
+
+    def test_table_with_user_in_param(self):
+        db = dbutil.get_table("test_user_db")
+        db.rebuild_index("v1")
+
+        for item in db.iter():
+            db.delete(item)
+
+        db.insert(dict(user="Ada", prop="key1", prop_value="222"))
+        db.insert(dict(user="Ada", prop="key2", prop_value="333"))
+        db.insert_by_user("Bob", dict(
+            user="Bob", prop="key3", prop_value="111"))
+        db.insert_by_user("Bob", dict(
+            user="Bob", prop="key4", prop_value="111"))
+
+        result1 = db.list(limit=-1, user_name="Ada")
+        result2 = db.list_by_func("Ada", limit=-1)
+
+        self.assertTrue(len(result1) > 0)
+        self.assertEqual(result1, result2)
+        self.assertEqual(2, len(result1))
+        self.assertEqual(2, len(db.list_by_user("Ada")))
+
+        first = db.get_first()
+        self.assertEqual("key1", first.prop)
+
+        last = db.get_last()
+        self.assertEqual("key4", last.prop)
+
+        # 通过key进行更新和查询
+        first.job = "painter"
+        db.update_by_key(first._key, first)
+        first = db.get_by_key(first._key)
+        self.assertEqual("painter", first.job)
+
+        # 通过ID更新和查询
+        first.job = "teacher"
+        db.update_by_id(first._id, first, user_name=first.user)
+        first = db.get_by_id(first._id, user_name=first.user)
+        self.assertEqual("teacher", first.job)
+
+    def test_insert(self):
+        obj = Storage(name = "Bob")
+        db = dbutil.get_table("test")
+        for item in db.list():
+            db.delete(item)
+        dbutil.db_delete("_max_id:test")
+        dbutil.db_delete("test:1")
+        new_id = dbutil.insert("test", obj)
+        new_id_int = decode_id(new_id)
+        self.assertEqual(1, new_id_int)
+
+        obj2 = Storage(name = "Carl")
+        new_id2 = dbutil.insert("test", obj2)
+        new_id2_int = decode_id(new_id2)
+        self.assertEqual(2, new_id2_int)
+
+    def test_where(self):
+        db = dbutil.get_table("test")
+        for item in db.iter(limit=-1):
+            db.delete(item)
+        
+        db.insert(dict(name = "name-1", age = 20))
+        db.insert(dict(name = "name-2", age = 21))
+
+        result = db.get_first(where = dict(name = "name-1"))
+        self.assertEqual(20, result.age)
+        self.assertEqual("name-1", result.name)
+
+        where = {
+            "name": {
+                "$prefix": "name"
+            }
+        }
+        result = db.list(where = where, limit = 20)
+        self.assertEqual(2, len(result))
+    
+    def test_where_count(self):
+        db = dbutil.get_table("test")
+        for item in db.iter(limit=-1):
+            db.delete(item)
+        
+        db.insert(dict(name = "name-1", age = 15))
+        db.insert(dict(name = "name-2", age = 15))
+
+        name_index_count = db.count_by_index("age", where = dict(name = "name-1", age = 15))
+        self.assertEqual(1, name_index_count)
+
+    def test_drop_table(self):
+        info = dbutil.register_table("drop_test", "删除测试")
+        db = dbutil.get_table(info.name)
+        db.insert(dict(name="test-1"))
+        db.insert(dict(name="test-2"))
+
+        info.delete_table()
+        test_base.json_request("/system/db/drop_table", method="POST", data=dict(table_name=info.name))
+        
+        self.assertEqual(0, dbutil.count_table(info.name))
+
+class TestMainV2(BaseTestCase):
+
+    def drop_table(self, table_name):
+        db = dbutil.get_table_v2(table_name)
+        for item in db.iter_by_index():
+            db.delete(item)
+        for item in db.iter_by_kv():
+            db.delete(item)
+    
+    def test_crud(self):
+        self.drop_table("test_v2_table")
+        db = dbutil.get_table_v2("test_v2_table")
+        record = RecordV2DO(name = "test", age=20)
+        new_id = db.insert(record)
+
+        record = db.get_by_id(new_id)
+        assert record != None
+        assert record.name == "test"
+        assert record.age == 20
+
+        record = db.select_first(where=dict(name="test"))
+        assert record != None
+        assert record.age == 20
+
+        record.name = "test-2"
+        db.update(record)
+
+        record = db.select_first(where=dict(name="test-2"))
+        assert record != None
+        assert record.age == 20
+        assert record.name == "test-2"
+
+        db.rebuild_index("v1")
+
+
+    def test_select(self):
+        db = dbutil.get_table_v2("test_v2_table")
+        self.drop_table("test_v2_table")
+
+        record = RecordV2DO(name = "test-1", age=20)
+        db.insert(record)
+        record = RecordV2DO(name = "test-2", age=20)
+        db.insert(record)
+        record = RecordV2DO(name = "name-3", age=30)
+        db.insert(record)
+
+        values = db.select(where="name LIKE $name", vars=dict(name="test-%"), limit=20)
+        assert len(values) == 2
+        assert isinstance(values, list)
+        first = values[0]
+        assert first.age == 20
+
+    def test_broken_kv(self):
+        db = dbutil.get_table_v2("test_v2_table")
+        self.drop_table("test_v2_table")
+
+        record = RecordV2DO(name = "test-1", age=20)
+        new_id = db.insert(record)
+
+        # 构建kv数据插入失败的场景
+        dbutil.delete(db.prefix + str(new_id))
+
+        values = db.select(where="name LIKE $name", vars=dict(name="test-%"), limit=20)
+        assert len(values) == 1
+        assert isinstance(values, list)
+        first = values[0]
+        assert first.name == "test-1"
+        assert not hasattr(first, "age") # 没有age属性
+
+        record_by_id = db.get_by_id(new_id)
+        assert record_by_id != None
+        assert record_by_id.name == "test-1"
+        assert not hasattr(record_by_id, "age") # 没有age属性
+
+
```

### Comparing `xnote-web-0.1.0/xnote/core/__init__.py` & `xnote-web-0.1.1/xnote/core/__init__.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote/core/xauth.py` & `xnote-web-0.1.1/xnote/core/xauth.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,980 +1,980 @@
-# encoding=utf-8
-
-"""用户和权限控制,主要的方法包括
-- check_login(user_name=None)     检查用户是否登录,可以指定用户或者不指定用户
-- login_required(user_name=None)  检查登录态的注解
-- current_name()    获取当前登录的用户名，别名 get_current_name()
-- current_user()    获取当前登录的用户详情，别名 get_current_user()
-- current_role()    获取当前登录的用户角色，别名 get_current_role()
-- create_user       创建用户
-- update_user       更新用户
-- delete_user       删除用户
-"""
-
-import os
-import hashlib
-import copy
-import web
-import xutils
-import warnings
-import time
-import datetime
-from . import xtables, xconfig, xmanager
-import enum
-from xutils import textutil, dbutil, fsutil, dateutil
-from xutils import Storage
-from xutils import logutil
-from xutils import cacheutil
-from xutils import six
-from xutils.sqldb.utils import safe_str
-
-session_cache = cacheutil.PrefixedCache(prefix="session:")
-user_cache = cacheutil.PrefixedCache(prefix="user:")
-
-DEFAULT_CACHE_EXPIRE = 60 * 5
-
-# 用户配置
-# 通过init方法完成初始化
-BUILTIN_USER_DICT = None
-NAME_LENGTH_MIN = 4
-PASSWORD_LEN_MIN = 6
-INVALID_NAMES = None
-USER_CONFIG_PROP = {}  # type: dict
-SESSION_EXPIRE = 24 * 3600 * 7
-PRINT_DEBUG_LOG = False
-
-
-class TestEnv:
-    """用于测试的运行时环境"""
-    is_admin = False
-    has_login = False
-    login_user_name = "test"
-    
-    @classmethod
-    def login_admin(cls):
-        cls.is_admin = True
-        cls.has_login = True
-        cls.login_user_name = "admin"
-        
-    @classmethod
-    def login_user(cls, user_name=""):
-        cls.is_admin = (user_name == "admin")
-        cls.has_login = True
-        cls.login_user_name = user_name
-        
-    @classmethod
-    def logout(cls):
-        cls.has_login = False
-        cls.is_admin = False
-
-
-def get_user_db():
-    return xtables.get_user_table()
-
-
-def get_user_config_db(name):
-    assert name != None
-    assert name != ""
-    return dbutil.get_hash_table("user_config", user_name=name)
-
-
-class UserStatusEnum(enum.Enum):
-    normal = 0
-    deleted = -1
-
-class UserDO(xutils.Storage):
-
-    def __init__(self, **kw):
-        self.id = 0
-        self.name = ""
-        self.password = ""
-        self.password_md5 = ""
-        self.token = ""
-        self.ctime = ""
-        self.mtime = ""
-        self.login_time = ""
-        self.salt = ""
-        self.mobile = ""
-        self.status = 0
-        self.update(kw)
-
-    @classmethod
-    def from_dict(cls, dict_value):
-        if dict_value == None:
-            return None
-        assert isinstance(dict_value, dict)
-        result = UserDO()
-        result.update(dict_value)
-        result.build()
-        return result
-
-    def build(self):
-        # Fix md5
-        if self.password != "" and self.password_md5 == "":
-            self.password_md5 = encode_password(self.password, self.salt)
-
-
-class UserDao:
-    @classmethod
-    def get_by_name(cls, name=""):
-        # type: (str) -> UserDO | None
-        if name is None or name == "":
-            return None
-
-        user = user_cache.get(name)
-        if user == None:
-            user = cls.get_user_from_db(name)
-            user_cache.put(name, user, expire=DEFAULT_CACHE_EXPIRE)
-
-        return UserDO.from_dict(user)
-
-    @classmethod
-    def get_id_by_name(cls, name=""):
-        user_info = cls.get_by_name(name)
-        if user_info != None:
-            return user_info.id
-        return 0
-
-    @classmethod
-    def get_user_from_db(cls, name=""):
-        db = get_user_db()
-        user_dict = db.select_first(where=dict(name=name))
-        return UserDO.from_dict(user_dict)
-
-    @classmethod
-    def get_by_token(cls, token=""):
-        db = get_user_db()
-        user_dict = db.select_first(where=dict(token=token))
-        user_info = UserDO.from_dict(user_dict)
-        if user_info != None and user_info.status == UserStatusEnum.deleted.value:
-            return None
-        return user_info
-
-    @classmethod
-    def get_by_id(cls, user_id=0):
-        db = get_user_db()
-        user_dict = db.select_first(where=dict(id=user_id))
-        return UserDO.from_dict(user_dict)
-
-    @classmethod
-    def get_by_mobile(cls, mobile=""):
-        db = get_user_db()
-        user_dict = db.select_first(where=dict(mobile=mobile))
-        return UserDO.from_dict(user_dict)
-
-    @classmethod
-    def list(cls, offset=0, limit=20):
-        db = get_user_db()
-        return list(db.select(offset=offset, limit=limit))
-
-    @classmethod
-    def count(cls):
-        return get_user_db().count()
-
-    @classmethod
-    def create(cls, user, fire_event=True):
-        assert isinstance(user, UserDO)
-        name = user.name
-        assert isinstance(name, six.string_types)
-        assert name != ""
-
-        user.login_time = "1970-01-01 00:00:00"
-        user.pop("id")
-        db = get_user_db()
-        user_id = db.insert(**user)
-        #xutils.trace("UserAdd", name)
-        if fire_event:
-            event = Storage(user_name=name)
-            xmanager.fire("user.create", event)
-        return user_id
-
-    @classmethod
-    def update(cls, user_info):
-        assert isinstance(user_info, UserDO)
-        db = get_user_db()
-
-        if user_info.password != "":
-            user_info.password_md5 = encode_password(
-                user_info.password, user_info.salt)
-            user_info.password = ""
-
-        db.update(where=dict(id=user_info.id), **user_info)
-        user_cache.delete(user_info.name)
-        #有问题  临时加try-catch
-        try:
-            xutils.trace("UserUpdate", user_info)
-            # 刷新完成之后再发送消息
-            xmanager.fire("user.update", dict(user_name=user_info.name))
-        except:
-            pass
-
-
-    @classmethod
-    def delete(cls, user_info):
-        db = get_user_db()
-        db.update(where=dict(id=user_info.id), status=UserStatusEnum.deleted.value)
-
-    @classmethod
-    def delete_by_name(cls, name=""):
-        if name == "admin":
-            return
-        name = name.lower()
-        db = get_user_db()
-        db.delete(where=dict(name=name))
-        user_cache.delete(name)
-
-    @classmethod
-    def delete_by_id(cls, id=0):
-        get_user_db().update(where=dict(id=id), status=UserStatusEnum.deleted.value)
-
-    @classmethod
-    def batch_get_name_by_ids(cls, ids=[]):
-        if len(ids) == 0:
-            return {}
-        db = get_user_db()
-        result = db.select(what="id, name", where="id in $ids", vars=dict(ids=ids))
-        dict_result = {}
-        for item in result:
-            dict_result[item.id] = item.name
-        return dict_result
-
-class UserModel(UserDao):
-    pass
-
-
-class SessionInfo(Storage):
-
-    def __init__(self) -> None:
-        self.user_name = ""
-        self.user_id = 0
-        self.sid = ""
-        self.token = ""
-        self.expire_time = 0.0  # 时间
-        self.login_ip = ""
-        self.login_time = 0.0  # 时间
-        self.mobile = ""
-
-
-class SessionModel:
-
-    @classmethod
-    def init(cls):
-        cls.db = dbutil.get_table("session")
-
-    @classmethod
-    def get_by_sid(cls, sid=""):
-        if sid == None or sid == "":
-            return None
-        record = session_cache.get(sid)
-        if record == None:
-            record = cls.db.get_by_id(sid)
-            if record != None:
-                session_cache.put(sid, record, expire=DEFAULT_CACHE_EXPIRE)
-
-        if record == None or session_cache.is_empty(record):
-            return None
-
-        session_info = dict_to_session_info(record)
-        if session_info.user_name is None:
-            delete_user_session_by_id(sid)
-            return None
-
-        if time.time() > session_info.expire_time:
-            delete_user_session_by_id(sid)
-            return None
-
-        return session_info
-
-    @classmethod
-    def create(cls, session_info):
-        assert isinstance(session_info, SessionInfo)
-        new_id = cls.db.update_by_id(session_info.sid, session_info)
-        session_cache.delete(session_info.sid)
-        return new_id
-
-    @classmethod
-    def list_by_user_name(cls, user_name=""):
-        records = cls.db.list_by_index("user", index_value=user_name)
-        result = []
-        for item in records:
-            result.append(dict_to_session_info(item))
-        return result
-
-    @classmethod
-    def delete_by_sid(cls, sid=""):
-        cls.db.delete_by_id(sid)
-        session_cache.delete(sid)
-
-
-def dict_to_session_info(dict_value):
-    info = SessionInfo()
-    info.update(**dict_value)
-    return info
-
-
-def _is_debug_enabled():
-    return PRINT_DEBUG_LOG
-
-
-def log_debug(fmt, *args):
-    if PRINT_DEBUG_LOG:
-        print("[xauth]", fmt.format(*args))
-
-
-def is_valid_username(name):
-    """有效的用户名为字母+数字"""
-    if name in INVALID_NAMES:
-        return False
-    if len(name) < NAME_LENGTH_MIN:
-        return False
-
-    for c in name:
-        if c.isalnum() or c in "_-":
-            continue
-        return False
-    return True
-
-
-def validate_password_error(password):
-    if len(password) < PASSWORD_LEN_MIN:
-        return "密码不能少于6位"
-    return None
-
-
-def _create_temp_user(user_name):
-    user_info = UserModel.get_by_name(user_name)
-    if user_info == None:
-        create_user(user_name, "123456", fire_event=False,
-                    check_username=False)
-
-    upload_dirname = xconfig.get_upload_dir(user_name)
-    fsutil.makedirs(upload_dirname)
-
-
-def _get_users(force_reload=False):
-    """获取用户，内部接口"""
-    warnings.warn("_get_users(查询所有用户)已经过时，请停止使用", DeprecationWarning)
-    raise Exception("_get_users已经废弃")
-
-
-def _setcookie(key, value, expires=24*3600*30):
-    assert isinstance(key, str)
-    assert isinstance(value, str)
-    web.setcookie(key, value, expires)
-
-
-def get_users():
-    """获取所有用户，返回一个深度拷贝版本"""
-    warnings.warn("get_users已经过时，请停止使用", DeprecationWarning)
-    return copy.deepcopy(_get_users())
-
-
-def iter_user(limit=20):
-    db = get_user_db()
-    if limit < 0:
-        for batch in db.iter_batch():
-            for item in batch:
-                yield UserDO(**item)
-    else:
-        for user_info in db.select(limit=limit):
-            yield UserDO(**user_info)
-
-
-def count_user():
-    db = get_user_db()
-    return db.count()
-
-
-def refresh_users():
-    xutils.trace("ReLoadUsers", "reload users")
-
-
-def get_user(name):
-    warnings.warn("get_user已经过时，请使用 get_user_by_name", DeprecationWarning)
-    return find_by_name(name)
-
-
-def get_user_by_name(user_name):
-    return UserDao.get_by_name(user_name)
-
-
-def create_uuid():
-    import uuid
-    return uuid.uuid4().hex
-
-
-def is_session_expired(session_info):
-    return time.time() > session_info.expire_time
-
-
-def get_valid_session_by_id(sid):
-    return SessionModel.get_by_sid(sid)
-
-
-def list_user_session_detail(user_name):
-    return SessionModel.list_by_user_name(user_name)
-
-
-def create_user_session(user_name, expires=SESSION_EXPIRE, login_ip=""):
-    # type: (str, int, str) -> SessionInfo
-    user_detail = get_user_by_name(user_name)
-    if user_detail is None:
-        raise Exception("user not found: %s" % user_name)
-    return create_session_by_user(user_detail, expires, login_ip)
-
-
-def create_session_by_user(user_detail, expires=SESSION_EXPIRE, login_ip=""):
-    assert isinstance(user_detail, UserDO)
-    user_name = user_detail.name
-
-    session_id = create_uuid()
-    session_list = list_user_session_detail(user_name)
-    session_list.sort(key=lambda x: x.expire_time)
-
-    if len(session_list) > xconfig.WebConfig.auth_max_session_size:
-        # 踢出最早的登录
-        for old_session in session_list[0:2]:
-            delete_user_session_by_id(old_session.sid)
-
-    # 保存会话信息
-    session_info = SessionInfo()
-    session_info.user_name = user_name
-    session_info.user_id = user_detail.id
-    session_info.sid = session_id
-    session_info.token = user_detail.token
-    session_info.login_time = time.time()
-    session_info.login_ip = login_ip
-    session_info.expire_time = time.time() + expires
-    if user_detail.mobile != None and user_detail.mobile != "":
-        session_info.mobile = user_detail.mobile[0:3]+"********"
-    else :
-        session_info.mobile = ""
-
-    SessionModel.create(session_info)
-
-    return session_info
-
-
-def delete_user_session_by_id(sid):
-    # 登录的时候会自动清理无效的sid关系
-    SessionModel.delete_by_sid(sid)
-
-
-def find_by_name(name):
-    return UserModel.get_by_name(name)
-
-
-@cacheutil.cache_deco(prefix="user_config_dict", expire=600)
-def get_user_config_dict(name):
-    if name is None or name == "":
-        return Storage(**USER_CONFIG_PROP)
-
-    db = get_user_config_db(name)
-    config_dict = Storage(**USER_CONFIG_PROP)
-
-    db_records = db.dict(limit=-1)
-    if len(db_records) > 0:
-        config_dict.update(db_records)
-        return config_dict
-
-    return Storage(**USER_CONFIG_PROP)
-
-
-def get_user_config_valid_keys():
-    return USER_CONFIG_PROP.keys()
-
-
-def check_user_config_key(key):
-    if key not in USER_CONFIG_PROP:
-        raise Exception("invalid user config: %s" % key)
-
-
-def get_user_config(user_name, config_key):
-    default_value = USER_CONFIG_PROP.get(config_key)
-    config_dict = get_user_config_dict(user_name)
-    if config_dict is None:
-        return default_value
-    return config_dict.get(config_key, default_value)
-
-
-@logutil.log_deco("update_user_config", log_args=True)
-def update_user_config(user_name, key, value):
-    check_user_config_key(key)
-
-    db = get_user_config_db(user_name)
-    result = db.put(key, value)
-    cacheutil.delete(prefix="user_config_dict", args=(user_name,))
-    return result
-
-
-def update_user_config_dict(name, config_dict):
-    assert isinstance(config_dict, dict)
-    user = UserDao.get_by_name(name)
-    if user is None:
-        return
-
-    for key in config_dict:
-        check_user_config_key(key)
-
-    db = get_user_config_db(name)
-
-    for key in config_dict:
-        value = config_dict.get(key)
-        db.put(key, value)
-
-    cacheutil.delete(prefix="user_config_dict", args=(name, ))
-
-
-def get_user_from_token():
-    token = xutils.get_argument_str("token")
-    if token != None and token != "":
-        return UserModel.get_by_token(token)
-
-    sid = xutils.get_argument_str("__sid")
-    if sid != "":
-        return get_user_by_sid(sid)
-
-
-def get_user_password(name):
-    # TODO webdav需要用到密码
-    user = get_user_by_name(name)
-    if user != None:
-        return user.password
-    raise Exception("user not found")
-
-
-def get_user_password_md5(user_name, use_salt=True):
-    user = UserDao.get_by_name(user_name)
-    assert user != None
-    password = user.password
-    salt = user.salt
-
-    if use_salt:
-        return encode_password(password, salt)
-    else:
-        return encode_password(password, None)
-
-
-def get_session_id_from_cookie():
-    cookies = web.cookies()
-    return cookies.get("sid", "")
-
-
-def get_user_from_cookie():
-    sid = get_session_id_from_cookie()
-    return get_user_by_sid(sid)
-
-
-def get_user_by_sid(session_id=""):
-    if session_id == None or session_id == "":
-        return None
-    session_info = get_valid_session_by_id(session_id)
-
-    if session_info is None:
-        return None
-
-    log_debug("get_user_from_cookie: sid={}, session_info={}",
-              session_id, session_info)
-
-    return get_user_by_name(session_info.user_name)
-
-
-def get_current_user():
-    if TestEnv.has_login:
-        return get_user_by_name(TestEnv.login_user_name)
-
-    user = get_user_from_token()
-    if user != None:
-        return user
-
-    if not hasattr(web.ctx, "env"):
-        # 尚未完成初始化
-        return None
-
-    return get_user_from_cookie()
-
-
-def current_user():
-    return get_current_user()
-
-def current_user_id():
-    user = get_current_user()
-    if user != None:
-        return user.id
-    return 0
-
-def get_current_name():
-    # type: () -> str|None
-    """获取当前用户名"""
-    user = get_current_user()
-    if user is None:
-        return None
-    return user.get("name")
-
-
-def current_name():
-    return get_current_name()
-
-
-def current_name_str() -> str:
-    name = get_current_name()
-    if name == None:
-        name = "public"
-    assert isinstance(name, str)
-    return name
-
-
-def get_current_role():
-    """获取当前用户的角色"""
-    user = get_current_user()
-    if user is None:
-        return None
-    name = user.get("name")
-    if name == "admin":
-        return "admin"
-    else:
-        return "user"
-
-
-def current_role():
-    return get_current_role()
-
-
-def get_md5_hex(pswd):
-    pswd_md5 = hashlib.md5()
-    pswd_md5.update(pswd.encode("utf-8"))
-    return pswd_md5.hexdigest()
-
-
-def encode_password(password, salt):
-    # 加上日期防止cookie泄露意义不大
-    # 考虑使用session失效检测或者定时提醒更新密码
-    # password = password + xutils.format_date()
-    if password is None:
-        password = ""
-    pswd_md5 = hashlib.md5()
-    pswd_md5.update(password.encode("utf-8"))
-
-    if salt != None:
-        pswd_md5.update(salt.encode("utf-8"))
-    return pswd_md5.hexdigest()
-
-
-def write_cookie(user_name):
-    session_id = create_user_session(user_name).sid
-    _setcookie("sid", session_id, expires=24*3600*30)
-
-
-def get_user_cookie(name):
-    session_list = list_user_session_detail(name)
-
-    if len(session_list) == 0:
-        sid = create_user_session(name, login_ip="system").sid
-    else:
-        sid = session_list[0].sid
-
-    return "sid=%s" % sid
-
-
-def gen_new_token():
-    import uuid
-    return uuid.uuid4().hex
-
-
-def create_quick_user():
-    """创建快速用户，用于第三方授权登录"""
-    num_length = 5
-    for i in range(10):
-        name = "u" + xutils.random_number_str(num_length)
-        with dbutil.get_write_lock(name):
-            if UserDao.get_by_name(name) != None:
-                num_length += 1
-                continue
-            password = xutils.create_uuid()
-            new_user = UserDO()
-            new_user.name = name
-            new_user.password = password
-            new_user.ctime = xutils.format_time()
-            new_user.mtime = xutils.format_time()
-            new_user.token = gen_new_token()
-            new_user.salt = textutil.random_string(6)
-            user_id = UserDao.create(new_user)
-            return UserDao.get_by_id(user_id)
-    raise Exception("create user name conflict")
-
-
-def create_user(name, password, fire_event=True, check_username=True):
-    if name == "" or name == None:
-        return dict(code="PARAM_ERROR", message="name为空")
-    if password == "" or password == None:
-        return dict(code="PARAM_ERROR", message="password为空")
-    if check_username and not is_valid_username(name):
-        return dict(code="INVALID_NAME", message="非法的用户名")
-
-    name = name.lower()
-    found = find_by_name(name)
-    if found is not None:
-        return dict(code="fail", message="用户已存在")
-    else:
-        user = UserDO()
-        user.name = name
-        user.password = password
-        user.salt = textutil.random_string(6)
-        user.token = gen_new_token()
-        user.ctime = xutils.format_time()
-        user.mtime = xutils.format_time()
-        user.build()
-
-        UserModel.create(user, fire_event=fire_event)
-        return dict(code="success", message="create success")
-
-
-def _check_password(password):
-    error = validate_password_error(password)
-    if error != None:
-        raise Exception(error)
-
-
-def update_user(name, update_dict):
-    if name == "" or name == None:
-        return
-    name = name.lower()
-
-    user_info = find_by_name(name)
-    if user_info is None:
-        raise Exception("user not found")
-
-    password_new = update_dict.get("password")
-    md5_new = None
-    md5_old = user_info.password_md5
-    if password_new != None:
-        md5_new = encode_password(password_new, user_info.salt)
-
-    if md5_new != None and md5_new != md5_old:
-        # 修改密码
-        _check_password(password_new)
-        user_info.salt = textutil.random_string(6)
-        user_info.token = gen_new_token()
-
-    user_info.update(update_dict)
-    user_info.mtime = xutils.format_time()
-    UserDao.update(user_info)
-
-
-def delete_user(name):
-    return UserModel.delete_by_name(name)
-
-
-def has_login_by_cookie(name=None):
-    cookies = web.cookies()
-    session_id = cookies.get("sid")
-    return has_login_by_sid(name, session_id)
-
-def has_login_by_sid(name, session_id):
-    session_info = get_valid_session_by_id(session_id)
-
-    if session_info is None:
-        return False
-
-    name_in_cookie = session_info.user_name
-
-    log_debug("has_login_by_cookie: name={}, name_in_cookie={}",
-              name, name_in_cookie)
-
-    user = get_user_by_name(name_in_cookie)
-    if user is None:
-        return False
-    
-    if user.status == UserStatusEnum.deleted.value:
-        return False
-
-    if user.token != session_info.token:
-        return False
-
-    if name is None:
-        return True
-    else:
-        return name_in_cookie == name
-
-
-@logutil.timeit_deco(logargs=True, logret=True, switch_func=_is_debug_enabled)
-def has_login(name=None):
-    """验证是否登陆
-    如果``name``指定,则只能该用户名通过验证
-    """
-    if TestEnv.has_login:
-        if name == "admin":
-            return TestEnv.is_admin
-        return True
-
-    # 优先使用token
-    user = get_user_from_token()
-    if user != None:
-        if name is None:
-            return True
-        return user.get("name") == name
-
-    return has_login_by_cookie(name)
-
-
-@logutil.timeit_deco(logargs=True, logret=True, switch_func=_is_debug_enabled)
-def is_admin():
-    return TestEnv.is_admin or has_login("admin")
-
-
-def check_login(user_name=None):
-    if has_login(user_name):
-        return
-
-    if has_login():
-        xutils.log("unauthorized visit, user:%s, url:%s" %
-                   (user_name, web.ctx.path))
-        raise web.seeother("/unauthorized")
-
-    # 跳转到登陆URL
-    redirect_to_login()
-
-
-def redirect_to_login():
-    path = web.ctx.fullpath
-    raise web.seeother(xconfig.WebConfig.login_url + xutils.encode_uri_component(path))
-
-
-def login_required(user_name=None):
-    """管理员验证装饰器"""
-    def deco(func):
-        def handle(*args, **kw):
-            check_login(user_name)
-            ret = func(*args, **kw)
-            return ret
-        return handle
-    return deco
-
-
-def get_user_data_dir(user_name, mkdirs=False):
-    fpath = os.path.join(xconfig.DATA_DIR, "files", user_name)
-    if mkdirs:
-        fsutil.makedirs(fpath)
-    return fpath
-
-
-def login_user_by_name(user_name, login_ip="", write_cookie=True):
-    assert user_name != None
-    user_info = UserDao.get_by_name(user_name)
-    if user_info == None:
-        raise Exception("用户不存在")
-    
-    if user_info.status == UserStatusEnum.deleted.value:
-        raise Exception("用户已注销")
-
-    session_info = create_session_by_user(user_info, login_ip=login_ip)
-    session_id = session_info.sid
-    if write_cookie:
-        _setcookie("sid", session_id)
-
-    # 更新最近的登录时间
-    update_kw = dict(login_time=xutils.format_datetime())
-    if user_info.password_md5 == "":
-        update_kw["password"] = user_info.password
-
-    update_user(user_name, update_kw)
-    return session_info
-
-
-def logout_current_user():
-    sid = get_session_id_from_cookie()
-    delete_user_session_by_id(sid)
-
-
-def is_user_exist(user_name):
-    user = get_user_by_name(user_name)
-    return user != None
-
-
-def check_old_password(user_name, password):
-    user_info = get_user_by_name(user_name)
-    if user_info is None:
-        raise Exception("用户不存在")
-
-    if user_info.password_md5 != encode_password(password, user_info.salt):
-        raise Exception("旧的密码不匹配")
-
-class UserOpTypeEnum(enum.Enum):
-    # 登录
-    login = "login"
-    
-    # 修改密码
-    change_password = "change_password"
-
-    # 管理员重置密码
-    reset_password = "reset_password"
-
-class UserOpLog(Storage):
-
-    def __init__(self):
-        self.ctime = dateutil.format_datetime()
-        self.user_id = 0
-        self.type = ""
-        self.detail = ""
-        self.ip = ""
-
-class UserOpLogDao:
-
-    @classmethod
-    def init(cls):
-        cls.db = xtables.get_table_by_name("user_op_log")
-        cls.max_log_size = 500
-        cls.log_buf_size = 20
-
-    @classmethod
-    def create_op_log(cls, op_log):
-        assert isinstance(op_log, UserOpLog)
-        assert op_log.user_id != 0
-        assert op_log.ctime != ""
-        assert op_log.type != ""
-        assert op_log.detail != ""
-        assert cls.log_buf_size > 0
-        
-        op_log.ip = safe_str(op_log.ip)
-        
-        cls.db.insert(**op_log)
-        if cls.db.count(where=dict(user_id=op_log.user_id)) >= cls.max_log_size + cls.log_buf_size:
-            ids = []
-            for item in cls.db.select(where=dict(user_id=op_log.user_id), limit=cls.log_buf_size, order="ctime"):
-                ids.append(item.id)
-            if len(ids) > 0:
-                cls.db.delete(where="id in $ids", vars=dict(ids=ids))
-
-    @classmethod
-    def list_by_user(cls, user_id=0, offset=0, limit=20, reverse=True):
-        order = "ctime desc"
-        if not reverse:
-            order = "ctime"
-        return cls.db.select(where=dict(user_id=user_id), offset=offset, limit=limit, order=order)
-
-    @classmethod
-    def count(cls, user_id=0):
-        return cls.db.count(where=dict(user_id=user_id))
-    
-def init():
-    global USER_TABLE
-    global INVALID_NAMES
-    global USER_CONFIG_PROP
-
-    INVALID_NAMES = xconfig.load_invalid_names()
-    USER_CONFIG_PROP = xconfig.load_user_config_properties()
-
-    SessionModel.init()
-    UserOpLogDao.init()
-
-    _create_temp_user("admin")
-    _create_temp_user("test")
-
-    # 检查配置项的有效性
-    for key in USER_CONFIG_PROP:
-        if "." in key:
-            raise Exception("无效的用户配置项:(%s),不能包含(.),请使用(_)" % key)
-
-
-xutils.register_func("user.get_config_dict", get_user_config_dict, "xauth")
-xutils.register_func("user.get_config",      get_user_config,      "xauth")
+# encoding=utf-8
+
+"""用户和权限控制,主要的方法包括
+- check_login(user_name=None)     检查用户是否登录,可以指定用户或者不指定用户
+- login_required(user_name=None)  检查登录态的注解
+- current_name()    获取当前登录的用户名，别名 get_current_name()
+- current_user()    获取当前登录的用户详情，别名 get_current_user()
+- current_role()    获取当前登录的用户角色，别名 get_current_role()
+- create_user       创建用户
+- update_user       更新用户
+- delete_user       删除用户
+"""
+
+import os
+import hashlib
+import copy
+import web
+import xutils
+import warnings
+import time
+import datetime
+from . import xtables, xconfig, xmanager
+import enum
+from xutils import textutil, dbutil, fsutil, dateutil
+from xutils import Storage
+from xutils import logutil
+from xutils import cacheutil
+from xutils import six
+from xutils.sqldb.utils import safe_str
+
+session_cache = cacheutil.PrefixedCache(prefix="session:")
+user_cache = cacheutil.PrefixedCache(prefix="user:")
+
+DEFAULT_CACHE_EXPIRE = 60 * 5
+
+# 用户配置
+# 通过init方法完成初始化
+BUILTIN_USER_DICT = None
+NAME_LENGTH_MIN = 4
+PASSWORD_LEN_MIN = 6
+INVALID_NAMES = None
+USER_CONFIG_PROP = {}  # type: dict
+SESSION_EXPIRE = 24 * 3600 * 7
+PRINT_DEBUG_LOG = False
+
+
+class TestEnv:
+    """用于测试的运行时环境"""
+    is_admin = False
+    has_login = False
+    login_user_name = "test"
+    
+    @classmethod
+    def login_admin(cls):
+        cls.is_admin = True
+        cls.has_login = True
+        cls.login_user_name = "admin"
+        
+    @classmethod
+    def login_user(cls, user_name=""):
+        cls.is_admin = (user_name == "admin")
+        cls.has_login = True
+        cls.login_user_name = user_name
+        
+    @classmethod
+    def logout(cls):
+        cls.has_login = False
+        cls.is_admin = False
+
+
+def get_user_db():
+    return xtables.get_user_table()
+
+
+def get_user_config_db(name):
+    assert name != None
+    assert name != ""
+    return dbutil.get_hash_table("user_config", user_name=name)
+
+
+class UserStatusEnum(enum.Enum):
+    normal = 0
+    deleted = -1
+
+class UserDO(xutils.Storage):
+
+    def __init__(self, **kw):
+        self.id = 0
+        self.name = ""
+        self.password = ""
+        self.password_md5 = ""
+        self.token = ""
+        self.ctime = ""
+        self.mtime = ""
+        self.login_time = ""
+        self.salt = ""
+        self.mobile = ""
+        self.status = 0
+        self.update(kw)
+
+    @classmethod
+    def from_dict(cls, dict_value):
+        if dict_value == None:
+            return None
+        assert isinstance(dict_value, dict)
+        result = UserDO()
+        result.update(dict_value)
+        result.build()
+        return result
+
+    def build(self):
+        # Fix md5
+        if self.password != "" and self.password_md5 == "":
+            self.password_md5 = encode_password(self.password, self.salt)
+
+
+class UserDao:
+    @classmethod
+    def get_by_name(cls, name=""):
+        # type: (str) -> UserDO | None
+        if name is None or name == "":
+            return None
+
+        user = user_cache.get(name)
+        if user == None:
+            user = cls.get_user_from_db(name)
+            user_cache.put(name, user, expire=DEFAULT_CACHE_EXPIRE)
+
+        return UserDO.from_dict(user)
+
+    @classmethod
+    def get_id_by_name(cls, name=""):
+        user_info = cls.get_by_name(name)
+        if user_info != None:
+            return user_info.id
+        return 0
+
+    @classmethod
+    def get_user_from_db(cls, name=""):
+        db = get_user_db()
+        user_dict = db.select_first(where=dict(name=name))
+        return UserDO.from_dict(user_dict)
+
+    @classmethod
+    def get_by_token(cls, token=""):
+        db = get_user_db()
+        user_dict = db.select_first(where=dict(token=token))
+        user_info = UserDO.from_dict(user_dict)
+        if user_info != None and user_info.status == UserStatusEnum.deleted.value:
+            return None
+        return user_info
+
+    @classmethod
+    def get_by_id(cls, user_id=0):
+        db = get_user_db()
+        user_dict = db.select_first(where=dict(id=user_id))
+        return UserDO.from_dict(user_dict)
+
+    @classmethod
+    def get_by_mobile(cls, mobile=""):
+        db = get_user_db()
+        user_dict = db.select_first(where=dict(mobile=mobile))
+        return UserDO.from_dict(user_dict)
+
+    @classmethod
+    def list(cls, offset=0, limit=20):
+        db = get_user_db()
+        return list(db.select(offset=offset, limit=limit))
+
+    @classmethod
+    def count(cls):
+        return get_user_db().count()
+
+    @classmethod
+    def create(cls, user, fire_event=True):
+        assert isinstance(user, UserDO)
+        name = user.name
+        assert isinstance(name, six.string_types)
+        assert name != ""
+
+        user.login_time = "1970-01-01 00:00:00"
+        user.pop("id")
+        db = get_user_db()
+        user_id = db.insert(**user)
+        #xutils.trace("UserAdd", name)
+        if fire_event:
+            event = Storage(user_name=name)
+            xmanager.fire("user.create", event)
+        return user_id
+
+    @classmethod
+    def update(cls, user_info):
+        assert isinstance(user_info, UserDO)
+        db = get_user_db()
+
+        if user_info.password != "":
+            user_info.password_md5 = encode_password(
+                user_info.password, user_info.salt)
+            user_info.password = ""
+
+        db.update(where=dict(id=user_info.id), **user_info)
+        user_cache.delete(user_info.name)
+        #有问题  临时加try-catch
+        try:
+            xutils.trace("UserUpdate", user_info)
+            # 刷新完成之后再发送消息
+            xmanager.fire("user.update", dict(user_name=user_info.name))
+        except:
+            pass
+
+
+    @classmethod
+    def delete(cls, user_info):
+        db = get_user_db()
+        db.update(where=dict(id=user_info.id), status=UserStatusEnum.deleted.value)
+
+    @classmethod
+    def delete_by_name(cls, name=""):
+        if name == "admin":
+            return
+        name = name.lower()
+        db = get_user_db()
+        db.delete(where=dict(name=name))
+        user_cache.delete(name)
+
+    @classmethod
+    def delete_by_id(cls, id=0):
+        get_user_db().update(where=dict(id=id), status=UserStatusEnum.deleted.value)
+
+    @classmethod
+    def batch_get_name_by_ids(cls, ids=[]):
+        if len(ids) == 0:
+            return {}
+        db = get_user_db()
+        result = db.select(what="id, name", where="id in $ids", vars=dict(ids=ids))
+        dict_result = {}
+        for item in result:
+            dict_result[item.id] = item.name
+        return dict_result
+
+class UserModel(UserDao):
+    pass
+
+
+class SessionInfo(Storage):
+
+    def __init__(self) -> None:
+        self.user_name = ""
+        self.user_id = 0
+        self.sid = ""
+        self.token = ""
+        self.expire_time = 0.0  # 时间
+        self.login_ip = ""
+        self.login_time = 0.0  # 时间
+        self.mobile = ""
+
+
+class SessionModel:
+
+    @classmethod
+    def init(cls):
+        cls.db = dbutil.get_table("session")
+
+    @classmethod
+    def get_by_sid(cls, sid=""):
+        if sid == None or sid == "":
+            return None
+        record = session_cache.get(sid)
+        if record == None:
+            record = cls.db.get_by_id(sid)
+            if record != None:
+                session_cache.put(sid, record, expire=DEFAULT_CACHE_EXPIRE)
+
+        if record == None or session_cache.is_empty(record):
+            return None
+
+        session_info = dict_to_session_info(record)
+        if session_info.user_name is None:
+            delete_user_session_by_id(sid)
+            return None
+
+        if time.time() > session_info.expire_time:
+            delete_user_session_by_id(sid)
+            return None
+
+        return session_info
+
+    @classmethod
+    def create(cls, session_info):
+        assert isinstance(session_info, SessionInfo)
+        new_id = cls.db.update_by_id(session_info.sid, session_info)
+        session_cache.delete(session_info.sid)
+        return new_id
+
+    @classmethod
+    def list_by_user_name(cls, user_name=""):
+        records = cls.db.list_by_index("user", index_value=user_name)
+        result = []
+        for item in records:
+            result.append(dict_to_session_info(item))
+        return result
+
+    @classmethod
+    def delete_by_sid(cls, sid=""):
+        cls.db.delete_by_id(sid)
+        session_cache.delete(sid)
+
+
+def dict_to_session_info(dict_value):
+    info = SessionInfo()
+    info.update(**dict_value)
+    return info
+
+
+def _is_debug_enabled():
+    return PRINT_DEBUG_LOG
+
+
+def log_debug(fmt, *args):
+    if PRINT_DEBUG_LOG:
+        print("[xauth]", fmt.format(*args))
+
+
+def is_valid_username(name):
+    """有效的用户名为字母+数字"""
+    if name in INVALID_NAMES:
+        return False
+    if len(name) < NAME_LENGTH_MIN:
+        return False
+
+    for c in name:
+        if c.isalnum() or c in "_-":
+            continue
+        return False
+    return True
+
+
+def validate_password_error(password):
+    if len(password) < PASSWORD_LEN_MIN:
+        return "密码不能少于6位"
+    return None
+
+
+def _create_temp_user(user_name):
+    user_info = UserModel.get_by_name(user_name)
+    if user_info == None:
+        create_user(user_name, "123456", fire_event=False,
+                    check_username=False)
+
+    upload_dirname = xconfig.get_upload_dir(user_name)
+    fsutil.makedirs(upload_dirname)
+
+
+def _get_users(force_reload=False):
+    """获取用户，内部接口"""
+    warnings.warn("_get_users(查询所有用户)已经过时，请停止使用", DeprecationWarning)
+    raise Exception("_get_users已经废弃")
+
+
+def _setcookie(key, value, expires=24*3600*30):
+    assert isinstance(key, str)
+    assert isinstance(value, str)
+    web.setcookie(key, value, expires)
+
+
+def get_users():
+    """获取所有用户，返回一个深度拷贝版本"""
+    warnings.warn("get_users已经过时，请停止使用", DeprecationWarning)
+    return copy.deepcopy(_get_users())
+
+
+def iter_user(limit=20):
+    db = get_user_db()
+    if limit < 0:
+        for batch in db.iter_batch():
+            for item in batch:
+                yield UserDO(**item)
+    else:
+        for user_info in db.select(limit=limit):
+            yield UserDO(**user_info)
+
+
+def count_user():
+    db = get_user_db()
+    return db.count()
+
+
+def refresh_users():
+    xutils.trace("ReLoadUsers", "reload users")
+
+
+def get_user(name):
+    warnings.warn("get_user已经过时，请使用 get_user_by_name", DeprecationWarning)
+    return find_by_name(name)
+
+
+def get_user_by_name(user_name):
+    return UserDao.get_by_name(user_name)
+
+
+def create_uuid():
+    import uuid
+    return uuid.uuid4().hex
+
+
+def is_session_expired(session_info):
+    return time.time() > session_info.expire_time
+
+
+def get_valid_session_by_id(sid):
+    return SessionModel.get_by_sid(sid)
+
+
+def list_user_session_detail(user_name):
+    return SessionModel.list_by_user_name(user_name)
+
+
+def create_user_session(user_name, expires=SESSION_EXPIRE, login_ip=""):
+    # type: (str, int, str) -> SessionInfo
+    user_detail = get_user_by_name(user_name)
+    if user_detail is None:
+        raise Exception("user not found: %s" % user_name)
+    return create_session_by_user(user_detail, expires, login_ip)
+
+
+def create_session_by_user(user_detail, expires=SESSION_EXPIRE, login_ip=""):
+    assert isinstance(user_detail, UserDO)
+    user_name = user_detail.name
+
+    session_id = create_uuid()
+    session_list = list_user_session_detail(user_name)
+    session_list.sort(key=lambda x: x.expire_time)
+
+    if len(session_list) > xconfig.WebConfig.auth_max_session_size:
+        # 踢出最早的登录
+        for old_session in session_list[0:2]:
+            delete_user_session_by_id(old_session.sid)
+
+    # 保存会话信息
+    session_info = SessionInfo()
+    session_info.user_name = user_name
+    session_info.user_id = user_detail.id
+    session_info.sid = session_id
+    session_info.token = user_detail.token
+    session_info.login_time = time.time()
+    session_info.login_ip = login_ip
+    session_info.expire_time = time.time() + expires
+    if user_detail.mobile != None and user_detail.mobile != "":
+        session_info.mobile = user_detail.mobile[0:3]+"********"
+    else :
+        session_info.mobile = ""
+
+    SessionModel.create(session_info)
+
+    return session_info
+
+
+def delete_user_session_by_id(sid):
+    # 登录的时候会自动清理无效的sid关系
+    SessionModel.delete_by_sid(sid)
+
+
+def find_by_name(name):
+    return UserModel.get_by_name(name)
+
+
+@cacheutil.cache_deco(prefix="user_config_dict", expire=600)
+def get_user_config_dict(name):
+    if name is None or name == "":
+        return Storage(**USER_CONFIG_PROP)
+
+    db = get_user_config_db(name)
+    config_dict = Storage(**USER_CONFIG_PROP)
+
+    db_records = db.dict(limit=-1)
+    if len(db_records) > 0:
+        config_dict.update(db_records)
+        return config_dict
+
+    return Storage(**USER_CONFIG_PROP)
+
+
+def get_user_config_valid_keys():
+    return USER_CONFIG_PROP.keys()
+
+
+def check_user_config_key(key):
+    if key not in USER_CONFIG_PROP:
+        raise Exception("invalid user config: %s" % key)
+
+
+def get_user_config(user_name, config_key):
+    default_value = USER_CONFIG_PROP.get(config_key)
+    config_dict = get_user_config_dict(user_name)
+    if config_dict is None:
+        return default_value
+    return config_dict.get(config_key, default_value)
+
+
+@logutil.log_deco("update_user_config", log_args=True)
+def update_user_config(user_name, key, value):
+    check_user_config_key(key)
+
+    db = get_user_config_db(user_name)
+    result = db.put(key, value)
+    cacheutil.delete(prefix="user_config_dict", args=(user_name,))
+    return result
+
+
+def update_user_config_dict(name, config_dict):
+    assert isinstance(config_dict, dict)
+    user = UserDao.get_by_name(name)
+    if user is None:
+        return
+
+    for key in config_dict:
+        check_user_config_key(key)
+
+    db = get_user_config_db(name)
+
+    for key in config_dict:
+        value = config_dict.get(key)
+        db.put(key, value)
+
+    cacheutil.delete(prefix="user_config_dict", args=(name, ))
+
+
+def get_user_from_token():
+    token = xutils.get_argument_str("token")
+    if token != None and token != "":
+        return UserModel.get_by_token(token)
+
+    sid = xutils.get_argument_str("__sid")
+    if sid != "":
+        return get_user_by_sid(sid)
+
+
+def get_user_password(name):
+    # TODO webdav需要用到密码
+    user = get_user_by_name(name)
+    if user != None:
+        return user.password
+    raise Exception("user not found")
+
+
+def get_user_password_md5(user_name, use_salt=True):
+    user = UserDao.get_by_name(user_name)
+    assert user != None
+    password = user.password
+    salt = user.salt
+
+    if use_salt:
+        return encode_password(password, salt)
+    else:
+        return encode_password(password, None)
+
+
+def get_session_id_from_cookie():
+    cookies = web.cookies()
+    return cookies.get("sid", "")
+
+
+def get_user_from_cookie():
+    sid = get_session_id_from_cookie()
+    return get_user_by_sid(sid)
+
+
+def get_user_by_sid(session_id=""):
+    if session_id == None or session_id == "":
+        return None
+    session_info = get_valid_session_by_id(session_id)
+
+    if session_info is None:
+        return None
+
+    log_debug("get_user_from_cookie: sid={}, session_info={}",
+              session_id, session_info)
+
+    return get_user_by_name(session_info.user_name)
+
+
+def get_current_user():
+    if TestEnv.has_login:
+        return get_user_by_name(TestEnv.login_user_name)
+
+    user = get_user_from_token()
+    if user != None:
+        return user
+
+    if not hasattr(web.ctx, "env"):
+        # 尚未完成初始化
+        return None
+
+    return get_user_from_cookie()
+
+
+def current_user():
+    return get_current_user()
+
+def current_user_id():
+    user = get_current_user()
+    if user != None:
+        return user.id
+    return 0
+
+def get_current_name():
+    # type: () -> str|None
+    """获取当前用户名"""
+    user = get_current_user()
+    if user is None:
+        return None
+    return user.get("name")
+
+
+def current_name():
+    return get_current_name()
+
+
+def current_name_str() -> str:
+    name = get_current_name()
+    if name == None:
+        name = "public"
+    assert isinstance(name, str)
+    return name
+
+
+def get_current_role():
+    """获取当前用户的角色"""
+    user = get_current_user()
+    if user is None:
+        return None
+    name = user.get("name")
+    if name == "admin":
+        return "admin"
+    else:
+        return "user"
+
+
+def current_role():
+    return get_current_role()
+
+
+def get_md5_hex(pswd):
+    pswd_md5 = hashlib.md5()
+    pswd_md5.update(pswd.encode("utf-8"))
+    return pswd_md5.hexdigest()
+
+
+def encode_password(password, salt):
+    # 加上日期防止cookie泄露意义不大
+    # 考虑使用session失效检测或者定时提醒更新密码
+    # password = password + xutils.format_date()
+    if password is None:
+        password = ""
+    pswd_md5 = hashlib.md5()
+    pswd_md5.update(password.encode("utf-8"))
+
+    if salt != None:
+        pswd_md5.update(salt.encode("utf-8"))
+    return pswd_md5.hexdigest()
+
+
+def write_cookie(user_name):
+    session_id = create_user_session(user_name).sid
+    _setcookie("sid", session_id, expires=24*3600*30)
+
+
+def get_user_cookie(name):
+    session_list = list_user_session_detail(name)
+
+    if len(session_list) == 0:
+        sid = create_user_session(name, login_ip="system").sid
+    else:
+        sid = session_list[0].sid
+
+    return "sid=%s" % sid
+
+
+def gen_new_token():
+    import uuid
+    return uuid.uuid4().hex
+
+
+def create_quick_user():
+    """创建快速用户，用于第三方授权登录"""
+    num_length = 5
+    for i in range(10):
+        name = "u" + xutils.random_number_str(num_length)
+        with dbutil.get_write_lock(name):
+            if UserDao.get_by_name(name) != None:
+                num_length += 1
+                continue
+            password = xutils.create_uuid()
+            new_user = UserDO()
+            new_user.name = name
+            new_user.password = password
+            new_user.ctime = xutils.format_time()
+            new_user.mtime = xutils.format_time()
+            new_user.token = gen_new_token()
+            new_user.salt = textutil.random_string(6)
+            user_id = UserDao.create(new_user)
+            return UserDao.get_by_id(user_id)
+    raise Exception("create user name conflict")
+
+
+def create_user(name, password, fire_event=True, check_username=True):
+    if name == "" or name == None:
+        return dict(code="PARAM_ERROR", message="name为空")
+    if password == "" or password == None:
+        return dict(code="PARAM_ERROR", message="password为空")
+    if check_username and not is_valid_username(name):
+        return dict(code="INVALID_NAME", message="非法的用户名")
+
+    name = name.lower()
+    found = find_by_name(name)
+    if found is not None:
+        return dict(code="fail", message="用户已存在")
+    else:
+        user = UserDO()
+        user.name = name
+        user.password = password
+        user.salt = textutil.random_string(6)
+        user.token = gen_new_token()
+        user.ctime = xutils.format_time()
+        user.mtime = xutils.format_time()
+        user.build()
+
+        UserModel.create(user, fire_event=fire_event)
+        return dict(code="success", message="create success")
+
+
+def _check_password(password):
+    error = validate_password_error(password)
+    if error != None:
+        raise Exception(error)
+
+
+def update_user(name, update_dict):
+    if name == "" or name == None:
+        return
+    name = name.lower()
+
+    user_info = find_by_name(name)
+    if user_info is None:
+        raise Exception("user not found")
+
+    password_new = update_dict.get("password")
+    md5_new = None
+    md5_old = user_info.password_md5
+    if password_new != None:
+        md5_new = encode_password(password_new, user_info.salt)
+
+    if md5_new != None and md5_new != md5_old:
+        # 修改密码
+        _check_password(password_new)
+        user_info.salt = textutil.random_string(6)
+        user_info.token = gen_new_token()
+
+    user_info.update(update_dict)
+    user_info.mtime = xutils.format_time()
+    UserDao.update(user_info)
+
+
+def delete_user(name):
+    return UserModel.delete_by_name(name)
+
+
+def has_login_by_cookie(name=None):
+    cookies = web.cookies()
+    session_id = cookies.get("sid")
+    return has_login_by_sid(name, session_id)
+
+def has_login_by_sid(name, session_id):
+    session_info = get_valid_session_by_id(session_id)
+
+    if session_info is None:
+        return False
+
+    name_in_cookie = session_info.user_name
+
+    log_debug("has_login_by_cookie: name={}, name_in_cookie={}",
+              name, name_in_cookie)
+
+    user = get_user_by_name(name_in_cookie)
+    if user is None:
+        return False
+    
+    if user.status == UserStatusEnum.deleted.value:
+        return False
+
+    if user.token != session_info.token:
+        return False
+
+    if name is None:
+        return True
+    else:
+        return name_in_cookie == name
+
+
+@logutil.timeit_deco(logargs=True, logret=True, switch_func=_is_debug_enabled)
+def has_login(name=None):
+    """验证是否登陆
+    如果``name``指定,则只能该用户名通过验证
+    """
+    if TestEnv.has_login:
+        if name == "admin":
+            return TestEnv.is_admin
+        return True
+
+    # 优先使用token
+    user = get_user_from_token()
+    if user != None:
+        if name is None:
+            return True
+        return user.get("name") == name
+
+    return has_login_by_cookie(name)
+
+
+@logutil.timeit_deco(logargs=True, logret=True, switch_func=_is_debug_enabled)
+def is_admin():
+    return TestEnv.is_admin or has_login("admin")
+
+
+def check_login(user_name=None):
+    if has_login(user_name):
+        return
+
+    if has_login():
+        xutils.log("unauthorized visit, user:%s, url:%s" %
+                   (user_name, web.ctx.path))
+        raise web.seeother("/unauthorized")
+
+    # 跳转到登陆URL
+    redirect_to_login()
+
+
+def redirect_to_login():
+    path = web.ctx.fullpath
+    raise web.seeother(xconfig.WebConfig.login_url + xutils.encode_uri_component(path))
+
+
+def login_required(user_name=None):
+    """管理员验证装饰器"""
+    def deco(func):
+        def handle(*args, **kw):
+            check_login(user_name)
+            ret = func(*args, **kw)
+            return ret
+        return handle
+    return deco
+
+
+def get_user_data_dir(user_name, mkdirs=False):
+    fpath = os.path.join(xconfig.DATA_DIR, "files", user_name)
+    if mkdirs:
+        fsutil.makedirs(fpath)
+    return fpath
+
+
+def login_user_by_name(user_name, login_ip="", write_cookie=True):
+    assert user_name != None
+    user_info = UserDao.get_by_name(user_name)
+    if user_info == None:
+        raise Exception("用户不存在")
+    
+    if user_info.status == UserStatusEnum.deleted.value:
+        raise Exception("用户已注销")
+
+    session_info = create_session_by_user(user_info, login_ip=login_ip)
+    session_id = session_info.sid
+    if write_cookie:
+        _setcookie("sid", session_id)
+
+    # 更新最近的登录时间
+    update_kw = dict(login_time=xutils.format_datetime())
+    if user_info.password_md5 == "":
+        update_kw["password"] = user_info.password
+
+    update_user(user_name, update_kw)
+    return session_info
+
+
+def logout_current_user():
+    sid = get_session_id_from_cookie()
+    delete_user_session_by_id(sid)
+
+
+def is_user_exist(user_name):
+    user = get_user_by_name(user_name)
+    return user != None
+
+
+def check_old_password(user_name, password):
+    user_info = get_user_by_name(user_name)
+    if user_info is None:
+        raise Exception("用户不存在")
+
+    if user_info.password_md5 != encode_password(password, user_info.salt):
+        raise Exception("旧的密码不匹配")
+
+class UserOpTypeEnum(enum.Enum):
+    # 登录
+    login = "login"
+    
+    # 修改密码
+    change_password = "change_password"
+
+    # 管理员重置密码
+    reset_password = "reset_password"
+
+class UserOpLog(Storage):
+
+    def __init__(self):
+        self.ctime = dateutil.format_datetime()
+        self.user_id = 0
+        self.type = ""
+        self.detail = ""
+        self.ip = ""
+
+class UserOpLogDao:
+
+    @classmethod
+    def init(cls):
+        cls.db = xtables.get_table_by_name("user_op_log")
+        cls.max_log_size = 500
+        cls.log_buf_size = 20
+
+    @classmethod
+    def create_op_log(cls, op_log):
+        assert isinstance(op_log, UserOpLog)
+        assert op_log.user_id != 0
+        assert op_log.ctime != ""
+        assert op_log.type != ""
+        assert op_log.detail != ""
+        assert cls.log_buf_size > 0
+        
+        op_log.ip = safe_str(op_log.ip)
+        
+        cls.db.insert(**op_log)
+        if cls.db.count(where=dict(user_id=op_log.user_id)) >= cls.max_log_size + cls.log_buf_size:
+            ids = []
+            for item in cls.db.select(where=dict(user_id=op_log.user_id), limit=cls.log_buf_size, order="ctime"):
+                ids.append(item.id)
+            if len(ids) > 0:
+                cls.db.delete(where="id in $ids", vars=dict(ids=ids))
+
+    @classmethod
+    def list_by_user(cls, user_id=0, offset=0, limit=20, reverse=True):
+        order = "ctime desc"
+        if not reverse:
+            order = "ctime"
+        return cls.db.select(where=dict(user_id=user_id), offset=offset, limit=limit, order=order)
+
+    @classmethod
+    def count(cls, user_id=0):
+        return cls.db.count(where=dict(user_id=user_id))
+    
+def init():
+    global USER_TABLE
+    global INVALID_NAMES
+    global USER_CONFIG_PROP
+
+    INVALID_NAMES = xconfig.load_invalid_names()
+    USER_CONFIG_PROP = xconfig.load_user_config_properties()
+
+    SessionModel.init()
+    UserOpLogDao.init()
+
+    _create_temp_user("admin")
+    _create_temp_user("test")
+
+    # 检查配置项的有效性
+    for key in USER_CONFIG_PROP:
+        if "." in key:
+            raise Exception("无效的用户配置项:(%s),不能包含(.),请使用(_)" % key)
+
+
+xutils.register_func("user.get_config_dict", get_user_config_dict, "xauth")
+xutils.register_func("user.get_config",      get_user_config,      "xauth")
```

### Comparing `xnote-web-0.1.0/xnote/core/xconfig.py` & `xnote-web-0.1.1/xnote/core/xconfig.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,1027 +1,1029 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-10-27 21:17:40
-@LastEditors  : xupingmao
-@LastEditTime : 2024-05-02 22:05:57
-@FilePath     : /xnote/xnote/core/xconfig.py
-@Description  : 描述
-"""
-# encoding=utf-8
-# @author xupingmao
-# @modified 2022/03/19 18:10:06
-# @filename xconfig.py
-
-'''xnote系统配置
-
-TODO: 系统配置需要注册之后才能使用
-
-# 配置型函数
-- init(path = DATA_DIR)
-
-# 全局配置（系统配置）
-- get_global_config(key, default_value = None, type = None)
-- set_global_config(key, value)
-
-# 用户配置
-- get_user_config(user_name, key, default_value = None)
-- get_user_config_dict(user_name)
-
-# 文件配置约定
-- 目录 XXX_DIR
-- 文件 XXX_FILE
-
-# 别名配置
-- set_alias
-- get_alias
-
-# 菜单配置
-
-'''
-import os
-import time
-import json
-import xutils
-import logging
-from xutils import textutil
-from xutils import fsutil
-from xutils.base import Storage
-
-__version__ = "1.0"
-__author__ = "xupingmao (578749341@qq.com)"
-__copyright__ = "(C) 2016-2023 xupingmao. GNU GPL 3."
-__contributors__ = []
-
-def resolve_config_path(fpath):
-    xnote_core_dir = os.path.dirname(__file__)
-    xnote_dir = os.path.dirname(xnote_core_dir)
-    xnote_root = os.path.dirname(xnote_dir)
-    
-    # print("xnote_root", xnote_root)
-    result = os.path.join(xnote_root, fpath)
-    result = os.path.abspath(result)
-    # print("result", result)
-    return result
-
-# 系统错误信息
-errors = []
-
-##################################
-# 系统配置项（不建议添加属性，建议通过 set_global_config 设置）
-##################################
-
-# 开发者模式,会展示更多的选项和信息,会开启实验性功能
-DEV_MODE = False
-# 开启调试
-DEBUG = False
-# 调试盒子模型，针对某些不方便调试的浏览器
-DEBUG_HTML_BOX = False
-
-PORT = "1234"
-port = PORT
-
-# 线程数
-MIN_THREADS = 20
-# 打开浏览器
-OPEN_IN_BROWSER = False
-# 启用数据库的缓存搜索
-USE_CACHE_SEARCH = False
-# 文件系统使用urlencode方式,适用于只支持ASCII字符的系统
-USE_URLENCODE = True
-# 初始化脚本
-INIT_SCRIPT = "init.py"
-
-# *** 样式设置 ***
-# BASE_TEMPLATE = "common/theme/sidebar.html"
-BASE_TEMPLATE = "common/base.html"
-# 主题样式
-THEME = "standard"
-# 选项风格
-OPTION_STYLE = "aside"
-# 页面打开方式
-PAGE_OPEN = "self"
-# 页面宽度
-PAGE_WIDTH = "1150"
-USER_CSS = None
-USER_JS = None
-
-# 插件相关 具体的代码参考 handlers/plugins 目录
-LOAD_PLUGINS_ON_INIT = True
-PLUGINS_DICT = {}
-PLUGIN_TEMPLATE = ""
-
-# 菜单配置
-MENU_LIST = []
-# 导航配置
-NAV_LIST = []
-# 笔记的扩展配置
-NOTE_OPTIONS = []
-# 文件管理器的扩展配置
-FS_OPTIONS = []
-
-
-##################################
-# 存储目录配置项
-##################################
-# 请求处理器目录
-HANDLERS_DIR = resolve_config_path("handlers")
-# 工具目录
-TOOLS_DIR = resolve_config_path("handlers/tools")
-# 语言配置目录
-LANG_DIR = resolve_config_path("config/lang")
-DB_ENGINE = "leveldb"
-
-WORKING_DIR = os.path.dirname(__file__)
-WEBDIR = os.path.join(WORKING_DIR, "static")
-PLUGINS_DIR = os.path.join(WORKING_DIR, "plugins")
-LOG_DIR = os.path.join(WORKING_DIR, "log")
-# 日志失效时间
-LOG_EXPIRE = 24 * 3600 * 365
-# 用户数据的地址
-DATA_PATH = os.path.join(WORKING_DIR, "data")
-DATA_DIR = DATA_PATH
-SCRIPTS_DIR = os.path.join(DATA_DIR, "scripts")
-DB_DIR = os.path.join(DATA_DIR, "db")
-CONFIG_DIR = os.path.join(DATA_DIR, "config")
-BACKUP_DIR = os.path.join(DATA_DIR, "backup")
-BACKUP_DB_DIR = os.path.join(BACKUP_DIR, "db")
-CACHE_DIR = os.path.join(DATA_DIR, "cache")
-
-# 备份失效时间
-BACKUP_EXPIRE = 24 * 3600 * 365
-# 回收站清理时间
-TRASH_EXPIRE = 24 * 3600 * 90
-# 临时文件失效时间
-TMP_EXPIRE = 24 * 3600 * 90
-# 删除的笔记有效期
-NOTE_REMOVED_EXPIRE = 24 * 3600 * 90
-
-# 其他标记
-# 测试用的flag,开启会拥有admin权限
-IS_TEST = False
-# 开启性能分析
-OPEN_PROFILE = False
-PROFILE_PATH_SET = set(["/file/view"])
-# 静音停止时间
-MUTE_END_TIME = None
-# 资料相关
-# 分页数量
-PAGE_SIZE = 20
-# 搜索历史的最大记录数
-SEARCH_HISTORY_MAX_SIZE = 1000
-SEARCH_PAGE_SIZE = 20
-# 搜索摘要长度
-SEARCH_SUMMARY_LEN = 100
-RECENT_SEARCH_LIMIT = 10
-RECENT_SIZE = 6
-
-IP_BLACK_LIST = ["192.168.56.1"]  # this is vbox ip
-# max file size to sync or backup
-MAX_FILE_SIZE = 10 * 1024 ** 2
-# 文本编辑器的最大文件限制
-MAX_TEXT_SIZE = 100 * 1024
-# 文件系统列分隔符，文件名保留符号参考函数 xutils.get_safe_file_name(filename)
-FS_COL_SEP = "$"
-# 是否隐藏系统文件
-FS_HIDE_FILES = True
-# 文件管理扩展的选项,类型Storage
-FS_LINK = "/fs_list"
-# 文件浏览模式 list/grid/sidebar
-FS_VIEW_MODE = "list"
-# 文本文件后缀
-FS_TEXT_EXT_LIST = set()
-FS_IMG_EXT_LIST = set()
-FS_CODE_EXT_LIST = set()
-MIME_TYPES = dict()
-
-# 后面定义的set函数和系统函数冲突了，所以这里创建一个hashset的别名
-hashset = set
-# 剪切板
-FS_CLIP = []
-
-# 搜索历史
-search_history = None
-# 笔记访问历史
-note_history = None
-
-# 配置项
-_config = {}
-
-START_TIME = None
-
-# 是否隐藏词典的入口
-HIDE_DICT_ENTRY = True
-
-# 运行时ID
-RUNTIME_ID = None
-# 退出的编码
-EXIT_CODE = 0
-
-class FileReplacement:
-    "文件替换符"
-    data_dir = "$data"
-
-class FileConfig:
-
-    data_dir = ""
-    sqlite_dir = ""
-    backup_dir = ""
-    backup_db_dir = ""
-    db_dir = ""
-    files_dir = ""
-    tmp_dir = ""
-
-    boot_lock_file = "" # 启动的锁文件
-    record_db_name = "" # 默认的sqlite数据库名称
-    record_db_file = "" # 默认的sqlite数据库路径
-    kv_db_name = "kv_store"
-    kv_db_file = ""
-
-    source_root_dir = "" # 源码根目录
-    plugins_dir = "" # 插件目录
-    ext_handlers_dir = "./ext_handlers"
-
-    db_backup_expire_days = 5
-
-    template_base_nav_left = "" # 左侧菜单自定义模板
-    template_base_nav_top = ""
-
-    @classmethod
-    def init(cls, data_dir):
-        xnote_core_dir = os.path.dirname(__file__)
-        xnote_dir = os.path.dirname(xnote_core_dir)
-        cls.source_root_dir = os.path.dirname(xnote_dir)
-        
-        data_dir = os.path.abspath(data_dir)
-        cls.data_dir = os.path.abspath(data_dir)
-        makedirs(cls.data_dir)
-
-        cls.files_dir = os.path.join(data_dir, "files")
-        makedirs(cls.files_dir)
-
-        cls.db_dir = os.path.join(data_dir, "db")
-        
-        cls.sqlite_dir = os.path.join(data_dir, "db", "sqlite")
-        makedirs(cls.sqlite_dir)
-
-        cls.backup_dir = os.path.join(data_dir, "backup")
-        makedirs(cls.backup_dir)
-
-        cls.backup_db_dir = os.path.join(cls.backup_dir, "db")
-        makedirs(cls.backup_db_dir)
-
-        cls.tmp_dir = os.path.join(data_dir, "tmp")
-        makedirs(cls.tmp_dir)
-
-        cls.record_db_name = SystemConfig.get_str("record_db_name", "record")
-        cls.record_db_file = cls.get_db_path(cls.record_db_name)
-
-        cls.kv_db_name = SystemConfig.get_str("kv_db_name", "kv_store")
-        cls.kv_db_file = cls.get_db_path(cls.kv_db_name)
-
-        cls.db_backup_expire_days = SystemConfig.get_int("db_backup_expire_days", 5)
-        cls.plugins_dir = os.path.join(cls.data_dir, "scripts", "plugins")
-        cls.plugins_upload_dir = os.path.join(cls.plugins_dir, "upload")
-
-        cls.template_base_nav_left = SystemConfig.get_str("template_base_nav_left", "common/nav/base_nav_left.html")
-        cls.template_base_nav_top = SystemConfig.get_str("template_base_nav_top", "common/nav/base_nav_top.html")
-
-        cls.boot_lock_file = SystemConfig.get_str("boot_lock_file", "pid.lock")
-        cls.enable_boot_lock = SystemConfig.get_bool("enable_boot_lock", True)
-
-        global USE_URLENCODE
-        USE_URLENCODE = SystemConfig.get_bool("fs_encode_name", True)
-        fsutil.FileUtilConfig.encode_name = USE_URLENCODE
-
-    @classmethod
-    def get_db_path(cls, dbname=""):
-        """dbname: sqlite数据库的文件名称"""
-        if dbname in ("$temp", "$tmp"):
-            tmp_file_path = fsutil.get_tmp_path(ext=".db")
-            logging.info("tmp_file_path=%s", tmp_file_path)
-            return tmp_file_path
-        if not dbname.endswith(".db"):
-            dbname += ".db"
-        return os.path.join(cls.sqlite_dir, dbname)
-
-    @classmethod
-    def get_backup_db_path(cls, dbname=""):
-        if not dbname.endswith(".db"):
-            dbname += ".db"
-        return os.path.join(cls.backup_db_dir, dbname)
-
-    @classmethod
-    def get_gallery_dir_by_user(cls, user_name=""):
-        assert isinstance(user_name, str)
-        assert len(user_name) > 0
-        return os.path.join(cls.files_dir, user_name, "gallery")
-
-class WebConfig:
-
-    server_home = ""
-    port = "1234"
-
-    # 关于系统的链接
-    about_url = "" 
-    about_text = ""
-    login_url = ""
-
-    # 展示配置
-    # 是否展示footer
-    ui_show_footer = True
-    ui_title_prefix = "Xnote"
-    # 是否展示translate.js组件
-    ui_show_translate_js = False
-    
-    nav_list = []
-    # 自定义导航-开发中
-    custom_nav_list = []
-
-    auth_max_session_size = 20
-
-    fast_reload = False
-
-    sync_interval_seconds = 3
-    sync_db_from_leader = False
-    sync_files_from_leader = False
-
-    # 定时任务开关
-    cron_enabled = True
-
-    @classmethod
-    def init(cls):
-        cls.server_home = SystemConfig.get_str("server_home", "")
-        cls.port = SystemConfig.get_str("port", "1234")
-        cls.about_url = SystemConfig.get_str("about_url", "/code/wiki/README.md")
-        cls.login_url = SystemConfig.get_str("login_url", "/login?target=")
-        cls.about_text = SystemConfig.get_str("about_text", "关于Xnote")
-        cls.nav_list = cls.load_nav_list()
-        cls.auth_max_session_size = SystemConfig.get_int("auth_max_session_size")
-        cls.fast_reload = SystemConfig.get_bool("fast_reload", False)
-
-        cls.ui_show_footer = SystemConfig.get_bool("ui_show_footer")
-        cls.ui_title_prefix = SystemConfig.get_str("ui_title_prefix", "Xnote")
-        cls.ui_show_translate_js = SystemConfig.get_bool("ui_show_translate_js")
-
-        cls.sync_interval_seconds = SystemConfig.get_int("sync_interval_seconds", 3)
-        cls.sync_db_from_leader = SystemConfig.get_bool("sync_db_from_leader", False)
-        cls.sync_files_from_leader = SystemConfig.get_bool("sync_files_from_leader", False)
-        
-        cls.cron_enabled = SystemConfig.get_bool("cron_enabled", True)
-        cls.force_https = SystemConfig.get_bool("force_https", False)
-        cls.record_location = SystemConfig.get_bool("record_location", False)
-    
-    @classmethod
-    def load_nav_list(cls):
-        """加载导航列表"""
-        if len(cls.nav_list) > 0:
-            return cls.nav_list
-        nav_list = []
-        nav_list.append(NavItem(text="首页", need_logout=True,
-                                need_admin=False, url="/system/index"))
-        nav_list.append(NavItem(text="首页", need_login=True,
-                        need_admin=False, url="/note/index"))
-        nav_list.append(NavItem(text="动态", need_login=True,
-                        need_admin=False, url="/note/recent?orderby=update"))
-        nav_list.append(NavItem(text="分享", need_login=False,
-                        need_admin=False, url="/note/public"))
-        nav_list.append(NavItem(text="插件", need_login=True,
-                        need_admin=False, css_class="desktop-only", url="/plugin_list"))
-        nav_list.append(NavItem(text="文件", need_login=True,
-                        need_admin=True, css_class="desktop-only", url="/fs_bookmark"))
-        nav_list.append(NavItem(text="设置", need_login=True,
-                        need_admin=False, url="/system/settings"))
-        nav_list.append(NavItem(text="后台", need_login=True,
-                        need_admin=True, css_class="desktop-only", url="/system/admin"))
-        nav_list.append(NavItem(text="登录", need_logout=True,
-                        need_admin=False, url="/login"))
-        return nav_list
-
-
-class TemplateConfig:
-    """模板配置"""
-    nav_list = []
-    lang_dict = {}
-
-    @classmethod
-    def init(cls):
-        # 加载菜单
-        cls.nav_list = WebConfig.load_nav_list()
-        cls.load_languages()
-
-    @classmethod
-    def load_languages(cls):
-        """加载系统语言配置"""
-        lang_dict = cls.lang_dict
-
-        lang_dict.clear()
-        dirname = LANG_DIR
-        for fname in os.listdir(dirname):
-            name, ext = os.path.splitext(fname)
-            if ext != ".properties":
-                continue
-            fpath = os.path.join(dirname, fname)
-            content = xutils.readfile(fpath)
-            config = xutils.parse_config_text(content, ret_type='dict')
-            lang_dict[name] = config
-        cls.lang_dict = lang_dict
-
-    @classmethod
-    def get_lang_mapping(cls, lang):
-        if lang == None:
-            lang = "zh"
-        return cls.lang_dict.get(lang)
-
-class DatabaseConfig:
-
-    db_driver = "" # sqlite/mysql/leveldb/ssdb
-    db_driver_cache = "" # memory/redis
-    db_driver_sql = "" # sqlite/mysql
-    db_driver_kv = ""  # sqlite/mysql/leveldb/ssdb
-    kv_store = "kv_store" # SQL模拟KV的表名
-
-    user_max_log_size = 500 # 用户日志保留的最大条数
-    db_debug = False
-    db_log_debug = False
-    db_profile_table_proxy = False
-    db_auto_ddl = True # 自动执行DDL
-
-    binlog = False
-    binlog_max_size = 10000
-    # leveldb配置
-    block_cache_size = 16 * 1024**2
-    write_buffer_size = 4 * 1024**2
-    max_open_files = 1000
-
-    # mysql相关配置
-    mysql_cloud_type="" # mysql云服务类型
-    mysql_database = ""
-
-    # sqlite配置 { DELETE, TRUNCATE, PERSIST, WAL, MEMORY, OFF }
-    sqlite_journal_mode = "delete"
-    sqlite_page_size = 0
-    
-    # ssdb相关配置
-    ssdb_host = ""
-    ssdb_port = 8888
-
-    @classmethod
-    def init(cls):
-        cls.db_driver = SystemConfig.get_str("db_driver")
-        cls.db_driver_cache = SystemConfig.get_str("db_driver_cache", "")
-        cls.db_driver_kv = SystemConfig.get_str("db_driver_kv", "")
-        cls.db_driver_sql = SystemConfig.get_str("db_driver_sql", "")
-
-        cls.mysql_cloud_type = SystemConfig.get_str("mysql_cloud_type")
-        cls.mysql_database = SystemConfig.get_str("mysql_database")
-        cls.user_max_log_size = SystemConfig.get_int("user_max_log_size", 500)
-        cls.db_debug = SystemConfig.get_bool("db_debug")
-        cls.db_log_debug = SystemConfig.get_bool("db_log_debug")
-        cls.binlog = SystemConfig.get_bool("binlog")
-        cls.binlog_max_size = SystemConfig.get_int("binlog_max_size")
-        cls.block_cache_size = SystemConfig.get_int("block_cache_size")
-        cls.write_buffer_size = SystemConfig.get_int("write_buffer_size")
-        cls.max_open_files = SystemConfig.get_int("max_open_files")
-        cls.db_profile_table_proxy = SystemConfig.get_int("db_profile_table_proxy")
-        cls.db_sys_log_max_size = SystemConfig.get_int("db_sys_log_max_size", 100000)
-        cls.db_auto_ddl = SystemConfig.get_bool("db_auto_ddl", True)
-
-        cls.sqlite_journal_mode = SystemConfig.get_str("sqlite_journal_mode", "delete")
-        cls.sqlite_page_size = SystemConfig.get_int("sqlite_page_size", 0)
-
-        cls.ssdb_host = SystemConfig.get_str("ssdb_host", "127.0.0.1")
-        cls.ssdb_port = SystemConfig.get_int("ssdb_port", 8888)
-
-        if cls.db_driver_sql == "":
-            if cls.db_driver == "mysql":
-                cls.db_driver_sql = "mysql"
-            else:
-                cls.db_driver_sql = "sqlite"
-        
-        if cls.db_driver_kv == "":
-            cls.db_driver_kv = cls.db_driver
-
-def read_properties_file(fpath):
-    fpath = resolve_config_path(fpath)
-    return fsutil.readfile(fpath)
-
-
-def load_invalid_names():
-    fpath = resolve_config_path("./config/user/invalid_names.list")
-    return fsutil.load_list_config(fpath)
-
-def load_user_config_properties():
-    fpath = resolve_config_path("./config/user/user_config.default.properties")
-    return fsutil.load_prop_config(fpath)
-
-def load_cron_config():
-    fpath = resolve_config_path("./config/cron/cron.json")
-    text = fsutil.readfile(fpath)
-    return json.loads(text)
-
-def makedirs(dirname):
-    if not os.path.exists(dirname):
-        os.makedirs(dirname)
-
-def make_data_dir(dirname):
-    abspath = os.path.join(DATA_DIR, dirname)
-    makedirs(abspath)
-    return abspath
-
-def init(boot_config_file=None, boot_config_kw = None):
-    """初始化系统配置项,启动时必须调用"""
-    global DATA_PATH
-    global DATA_DIR
-    global DB_PATH
-    global DB_FILE
-    global DICT_FILE
-    global RECORD_FILE
-    global BACKUP_DIR
-    global BACKUP_DB_DIR
-    global UPLOAD_DIR
-    global APP_DIR
-    global TMP_DIR
-    global DB_DIR
-    global SCRIPTS_DIR
-    global COMMANDS_DIR
-    global PLUGINS_DIR
-    global CODE_ZIP
-    global DATA_ZIP
-    global TRASH_DIR
-    global LOG_PATH
-    global LOG_DIR
-    global LOG_FILE
-    global STORAGE_DIR
-    global ETC_DIR
-    global PLUGIN_TEMPLATE
-    global RUNTIME_ID
-    global FILE_EXT_PATH
-    global CACHE_DIR
-    global CONFIG_DIR
-
-    if boot_config_file != None:
-        # 初始化启动配置
-        init_boot_config(boot_config_file, boot_config_kw=boot_config_kw)
-
-    path = get_system_config("data")
-    assert isinstance(path, str)
-    DATA_PATH = os.path.abspath(path)
-    DATA_DIR = os.path.abspath(path)
-
-    # 初始HTTP端口号
-    init_http_port()
-
-    # 初始化文件配置
-    FileConfig.init(DATA_DIR)
-    # 初始化web配置
-    WebConfig.init()
-    # 初始化数据库配置
-    DatabaseConfig.init()
-    # 初始化模板配置
-    TemplateConfig.init()
-
-    # 数据库地址
-    init_db_config()
-
-    # 备份数据地址
-    BACKUP_DIR = make_data_dir("backup")
-    BACKUP_DB_DIR = make_data_dir("backup/db")
-
-    # APP地址
-    UPLOAD_DIR = make_data_dir("files")
-    APP_DIR = make_data_dir("app")
-    TMP_DIR = make_data_dir("tmp")
-    CACHE_DIR = make_data_dir("cache")
-
-    # 脚本的地址
-    SCRIPTS_DIR  = make_data_dir("scripts")
-    COMMANDS_DIR = make_data_dir("scripts/commands")
-    PLUGINS_DIR  = make_data_dir("scripts/plugins")
-
-
-    CODE_ZIP = os.path.join(DATA_DIR, "code.zip")
-    DATA_ZIP = os.path.join(DATA_DIR, "data.zip")
-    TRASH_DIR = os.path.join(DATA_DIR, "trash")
-    LOG_PATH = os.path.join(DATA_DIR, "xnote.log")
-    STORAGE_DIR = os.path.join(DATA_DIR, "storage")
-    ETC_DIR = os.path.join(DATA_DIR, "storage")
-    LOG_DIR = os.path.join(DATA_DIR, "log")
-    DB_FILE = DB_PATH
-    LOG_FILE = LOG_PATH
-    FILE_EXT_PATH = os.path.join(CONFIG_DIR, "file", "type.properties")
-
-    # 一级目录
-    makedirs(DATA_DIR)
-    makedirs(UPLOAD_DIR)
-    makedirs(TMP_DIR)
-    makedirs(SCRIPTS_DIR)
-    makedirs(TRASH_DIR)
-    makedirs(STORAGE_DIR)
-    makedirs(ETC_DIR)
-    makedirs(LOG_DIR)
-
-    # 二级目录
-    makedirs(COMMANDS_DIR)
-    makedirs(PLUGINS_DIR)
-
-    # 加载文件后缀配置
-    load_file_type_config()
-
-    # 初始化系统版本配置
-    init_system_version()
-
-    PLUGIN_TEMPLATE = read_properties_file("./config/plugin/plugin.tpl.py")
-
-    RUNTIME_ID = textutil.generate_uuid()
-
-
-def load_default_boot_config():
-    # type: () -> dict
-    text = read_properties_file("./config/boot/boot.default.properties")
-    return textutil.parse_config_text_to_dict(text)
-
-
-def _parse_int(value):
-    assert xutils.is_str(value)
-    if value == "":
-        return 0
-
-    value = value.lower()
-    if value[-2:] == "kb":
-        return int(value[:-2]) * 1024
-
-    if value[-2:] == "mb":
-        return int(value[:-2]) * 1024**2
-
-    if value[-2:] == "gb":
-        return int(value[:-2]) * 1024**3
-
-    if value[-2:] == "tb":
-        return int(value[:-2]) * 1024**4
-
-    if value[-2:] == "pb":
-        return int(value[:-2]) * 1024**5
-    
-    if value[-1] == "k":
-        return int(value[:-1]) * 1000
-    
-    if value[-1] == "m":
-        return int(value[:-1]) * 1000**2
-    
-    return int(value)
-
-
-def init_boot_config(fpath, boot_config_kw=None):
-
-    # 读取默认的配置
-    config_dict = load_default_boot_config()
-
-
-    # 加载用户配置覆盖
-    text = fsutil.readfile(fpath)
-    user_config = textutil.parse_config_text(text, 'dict')
-
-    config_dict.update(user_config)
-    if boot_config_kw != None:
-        config_dict.update(boot_config_kw)
-
-    for key in config_dict:
-        check_part = textutil.remove_tail(key, ".type")
-        if check_part.find(".") >= 0:
-            raise Exception("非法的配置项:(%s), 不能包含(.)" % key)
-
-        value = config_dict[key]
-        value_type = config_dict.get(key + ".type")
-
-        if value_type == "bool":
-            value = (value == "true" or value == "yes")
-        if value_type == "int":
-            value = _parse_int(value)
-
-        set_global_config("system.%s" % key, value)
-
-    global PORT
-    global DEBUG
-    global DEV_MODE
-
-    PORT = get_system_config("port")
-    DEBUG = get_system_config("debug")
-
-    if DEBUG:
-        DEV_MODE = True
-
-
-def init_http_port():
-    port = SystemConfig.get_str("port")
-
-    if port != None:
-        # 指定端口优先级最高
-        os.environ["PORT"] = port
-
-    if not os.environ.get("PORT"):
-        assert isinstance(port, str)
-        os.environ["PORT"] = port
-
-    # 兼容
-    set_global_config("port", port)
-
-
-def init_db_config():
-    global DB_DIR
-    global DB_PATH
-    global DICT_FILE
-    global RECORD_FILE
-
-    DB_DIR = os.path.join(DATA_DIR, "db")
-    DB_PATH = os.path.join(DATA_DIR, "data.db")
-    RECORD_FILE = FileConfig.record_db_file
-
-    makedirs(DB_DIR)
-
-    sqlite_dir = os.path.join(DB_DIR, "sqlite")
-    makedirs(sqlite_dir)
-    DICT_FILE = os.path.join(sqlite_dir, "dictionary.db")
-
-
-def init_system_version():
-    from xutils import fsutil
-    fpath = resolve_config_path("./config/version.txt")
-    system_version = fsutil.readfile(fpath, limit=1000)
-    if system_version != None:
-        system_version = system_version.strip()
-    set_global_config("system.version", system_version)
-
-
-def mark_started():
-    global START_TIME
-    START_TIME = time.time()
-
-
-def load_file_type_config0(fpath):
-    from xutils import fsutil, textutil
-    fpath = resolve_config_path(fpath)
-    text = fsutil.readfile(fpath)
-    ext_set = hashset()
-    ext_type_dict = textutil.parse_config_text_to_dict(text)
-    for ext in ext_type_dict:
-        ext_set.add(ext)
-    return ext_set
-
-
-def load_config_as_dict(fpath):
-    # type: (str) -> dict
-    from xutils import fsutil, textutil
-    fpath = resolve_config_path(fpath)
-    text = fsutil.readfile(fpath)
-    return textutil.parse_config_text_to_dict(text)
-
-def load_config_as_text(fpath):
-    fpath = resolve_config_path(fpath)
-    return fsutil.readfile(fpath)
-
-def load_file_type_config():
-    global FS_TEXT_EXT_LIST
-    global FS_IMG_EXT_LIST
-    global FS_CODE_EXT_LIST
-    global FS_ZIP_EXT_LIST
-    global FS_AUDIO_EXT_LIST
-    global FS_VIDEO_EXT_LIST
-    global MIME_TYPES
-
-    FS_TEXT_EXT_LIST = load_file_type_config0("./config/file/text.properties")
-    FS_IMG_EXT_LIST = load_file_type_config0("./config/file/image.properties")
-    FS_CODE_EXT_LIST = load_file_type_config0("./config/file/code.properties")
-    FS_ZIP_EXT_LIST = load_file_type_config0("./config/file/zip.properties")
-    FS_AUDIO_EXT_LIST = load_file_type_config0(
-        "./config/file/audio.properties")
-    FS_VIDEO_EXT_LIST = load_file_type_config0(
-        "./config/file/video.properties")
-    MIME_TYPES = load_config_as_dict("./config/file/mime-types.properties")
-    MIME_TYPES[""] = "application/octet-stream"
-
-
-def get_global_config(name, default_value=None, type=None):
-    """获取配置，如果不存在返回default值"""
-    value = _config.get(name)
-    if value is not None:
-        return value
-
-    value = globals().get(name)
-    if value is not None:
-        return value
-
-    if value is None:
-        return default_value
-    return value
-
-def get_system_config(name, default_value=None):
-    return get_global_config("system." + name, default_value)
-
-def get_system_config_int(name, default_value = 0):
-    value = get_system_config(name, default_value = default_value)
-    assert isinstance(value, int)
-    return value
-
-def get(key, default_value=None):
-    return get_global_config(key, default_value)
-
-def get_str(key, default_value=""):
-    value = get(key, default_value=default_value)
-    assert isinstance(value, str)
-    return value
-
-def set(name, value):
-    """和set函数冲突了，建议使用 set_global_config"""
-    return set_global_config(name, value)
-
-
-def put(name, value):
-    return set_global_config(name, value)
-
-
-def set_global_config(name, value):
-    _config[name] = value
-
-def set_system_config(name, value):
-    set_global_config("system." + name, value)
-
-def get_config():
-    raise Exception("deprecated: use xconfig.get_config_dict")
-
-def get_config_dict():
-    return _config
-
-
-def has_config(key, subkey=None):
-    return has_global_config(key, subkey)
-
-
-def has(key):
-    return has_global_config(key)
-
-
-def has_global_config(key, subkey=None):
-    group_value = get_global_config(key)
-    if group_value is None:
-        return False
-    if subkey is None:
-        return True
-    return subkey in group_value
-
-
-def is_mute():
-    """是否静音"""
-    return MUTE_END_TIME is not None and time.time() < MUTE_END_TIME
-
-
-# 设置别名
-_alias_dict = {}
-
-
-def set_alias(name, value):
-    """设置别名，用于扩展命令"""
-    _alias_dict[name] = value
-
-
-def get_alias(name, default_value):
-    """获取别名，用于扩展命令"""
-    return _alias_dict.get(name, default_value)
-
-
-def get_user_config(user_name, config_key, default_value=None):
-    """默认值参考DEFAULT_USER_CONFIG"""
-    # 未启动，直接返回默认值
-    if START_TIME is None:
-        return default_value
-
-    from . import xauth
-    return xauth.get_user_config(user_name, config_key)
-
-
-def update_user_config(user_name, key, value):
-    from . import xauth
-    return xauth.update_user_config(user_name, key, value)
-
-
-def get_user_config_dict(user_name):
-    from . import xauth
-    value = xauth.get_user_config_dict(user_name)
-    if value is None:
-        return Storage()
-    return value
-
-
-def get_current_user_config(key, default_value=None):
-    if START_TIME is None:
-        return default_value
-    
-    from . import xauth
-    """默认值参考DEFAULT_USER_CONFIG"""
-    return get_user_config(xauth.current_name(), key, default_value)
-
-
-def get_system_dir(name):
-    if name == "files":
-        return UPLOAD_DIR
-
-    if name == "data":
-        return DATA_DIR
-
-    if name == "tmp":
-        return TMP_DIR
-
-    if name == "storage":
-        return STORAGE_DIR
-
-    if name == "scripts":
-        return SCRIPTS_DIR
-
-    if name == "app":
-        return APP_DIR
-
-    if name == "archive":
-        return os.path.join(DATA_DIR, "archive")
-    
-    if name == "cache":
-        return os.path.join(DATA_DIR, "cache")
-
-    raise Exception("未知的系统目录:" + name)
-
-
-def get_upload_dir(username):
-    if username is None:
-        raise Exception("username is None")
-
-    upload_dir_root = get_system_dir("files")
-    return os.path.join(upload_dir_root, username, "upload")
-
-
-def get_backup_dir(name=None):
-    if name == None:
-        return BACKUP_DIR
-
-    assert isinstance(name, str)
-    return os.path.join(BACKUP_DIR, name)
-
-def get_system_files():
-    return hashset([
-        BACKUP_DB_DIR,
-    ])
-
-
-class SystemConfig:
-
-    @classmethod
-    def get_int(cls, name, default_value=0):
-        value = get_system_config(name, default_value)
-        if value == "":
-            return default_value
-        if isinstance(value, str):
-            value = value.replace("_", "") # 支持 100_000 这种格式
-        return int(value)
-    
-    @classmethod
-    def get_str(cls, name, default_value=""):
-        value = get_system_config(name, default_value)
-        return str(value)
-
-    @classmethod
-    def get_bool(cls, name, default_value=False):
-        value = get_system_config(name, default_value)
-        if isinstance(value, str):
-            return value.lower() == "true"
-        return bool(value)
-
-system_config = SystemConfig()
-
-
-
-
-class NavItem:
-
-    def __init__(self, text="", need_login=False, need_logout=False, need_admin=False, url="", css_class=""):
-        self.text = text
-        self.need_login = need_login
-        self.need_logout = need_logout
-        self.need_admin = need_admin
-        self.url = url
-        self.css_class = css_class
-
-    def check_platform(self):
-        return True
-
-    def is_visible(self):
-        from . import xauth
-        # 先判断高权限的
-        if self.need_admin:
-            return xauth.is_admin() and self.check_platform()
-
-        if self.need_login:
-            return xauth.has_login() and self.check_platform()
-
-        if self.need_logout:
-            return not xauth.has_login() and self.check_platform()
-
-        return self.check_platform()
-    
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-10-27 21:17:40
+@LastEditors  : xupingmao
+@LastEditTime : 2024-05-02 22:05:57
+@FilePath     : /xnote/xnote/core/xconfig.py
+@Description  : 描述
+"""
+# encoding=utf-8
+# @author xupingmao
+# @modified 2022/03/19 18:10:06
+# @filename xconfig.py
+
+'''xnote系统配置
+
+TODO: 系统配置需要注册之后才能使用
+
+# 配置型函数
+- init(path = DATA_DIR)
+
+# 全局配置（系统配置）
+- get_global_config(key, default_value = None, type = None)
+- set_global_config(key, value)
+
+# 用户配置
+- get_user_config(user_name, key, default_value = None)
+- get_user_config_dict(user_name)
+
+# 文件配置约定
+- 目录 XXX_DIR
+- 文件 XXX_FILE
+
+# 别名配置
+- set_alias
+- get_alias
+
+# 菜单配置
+
+'''
+import os
+import time
+import json
+import xutils
+import logging
+from xutils import textutil
+from xutils import fsutil
+from xutils.base import Storage
+
+__version__ = "1.0"
+__author__ = "xupingmao (578749341@qq.com)"
+__copyright__ = "(C) 2016-2023 xupingmao. GNU GPL 3."
+__contributors__ = []
+
+def resolve_config_path(fpath):
+    xnote_core_dir = os.path.dirname(__file__)
+    xnote_dir = os.path.dirname(xnote_core_dir)
+    xnote_root = os.path.dirname(xnote_dir)
+    
+    # print("xnote_root", xnote_root)
+    result = os.path.join(xnote_root, fpath)
+    result = os.path.abspath(result)
+    # print("result", result)
+    return result
+
+# 系统错误信息
+errors = []
+
+##################################
+# 系统配置项（不建议添加属性，建议通过 set_global_config 设置）
+##################################
+
+# 开发者模式,会展示更多的选项和信息,会开启实验性功能
+DEV_MODE = False
+# 开启调试
+DEBUG = False
+# 调试盒子模型，针对某些不方便调试的浏览器
+DEBUG_HTML_BOX = False
+
+PORT = "1234"
+port = PORT
+
+# 线程数
+MIN_THREADS = 20
+# 打开浏览器
+OPEN_IN_BROWSER = False
+# 启用数据库的缓存搜索
+USE_CACHE_SEARCH = False
+# 文件系统使用urlencode方式,适用于只支持ASCII字符的系统
+USE_URLENCODE = True
+# 初始化脚本
+INIT_SCRIPT = "init.py"
+
+# *** 样式设置 ***
+# BASE_TEMPLATE = "common/theme/sidebar.html"
+BASE_TEMPLATE = "common/base.html"
+# 主题样式
+THEME = "standard"
+# 选项风格
+OPTION_STYLE = "aside"
+# 页面打开方式
+PAGE_OPEN = "self"
+# 页面宽度
+PAGE_WIDTH = "1150"
+USER_CSS = None
+USER_JS = None
+
+# 插件相关 具体的代码参考 handlers/plugins 目录
+LOAD_PLUGINS_ON_INIT = True
+PLUGINS_DICT = {}
+PLUGIN_TEMPLATE = ""
+
+# 菜单配置
+MENU_LIST = []
+# 导航配置
+NAV_LIST = []
+# 笔记的扩展配置
+NOTE_OPTIONS = []
+# 文件管理器的扩展配置
+FS_OPTIONS = []
+
+
+##################################
+# 存储目录配置项
+##################################
+# 请求处理器目录
+HANDLERS_DIR = resolve_config_path("handlers")
+# 工具目录
+TOOLS_DIR = resolve_config_path("handlers/tools")
+# 语言配置目录
+LANG_DIR = resolve_config_path("config/lang")
+DB_ENGINE = "leveldb"
+
+WORKING_DIR = os.path.dirname(__file__)
+WEBDIR = os.path.join(WORKING_DIR, "static")
+PLUGINS_DIR = os.path.join(WORKING_DIR, "plugins")
+LOG_DIR = os.path.join(WORKING_DIR, "log")
+# 日志失效时间
+LOG_EXPIRE = 24 * 3600 * 365
+# 用户数据的地址
+DATA_PATH = os.path.join(WORKING_DIR, "data")
+DATA_DIR = DATA_PATH
+SCRIPTS_DIR = os.path.join(DATA_DIR, "scripts")
+DB_DIR = os.path.join(DATA_DIR, "db")
+CONFIG_DIR = os.path.join(DATA_DIR, "config")
+BACKUP_DIR = os.path.join(DATA_DIR, "backup")
+BACKUP_DB_DIR = os.path.join(BACKUP_DIR, "db")
+CACHE_DIR = os.path.join(DATA_DIR, "cache")
+
+# 备份失效时间
+BACKUP_EXPIRE = 24 * 3600 * 365
+# 回收站清理时间
+TRASH_EXPIRE = 24 * 3600 * 90
+# 临时文件失效时间
+TMP_EXPIRE = 24 * 3600 * 90
+# 删除的笔记有效期
+NOTE_REMOVED_EXPIRE = 24 * 3600 * 90
+
+# 其他标记
+# 测试用的flag,开启会拥有admin权限
+IS_TEST = False
+# 开启性能分析
+OPEN_PROFILE = False
+PROFILE_PATH_SET = set(["/file/view"])
+# 静音停止时间
+MUTE_END_TIME = None
+# 资料相关
+# 分页数量
+PAGE_SIZE = 20
+# 搜索历史的最大记录数
+SEARCH_HISTORY_MAX_SIZE = 1000
+SEARCH_PAGE_SIZE = 20
+# 搜索摘要长度
+SEARCH_SUMMARY_LEN = 100
+RECENT_SEARCH_LIMIT = 10
+RECENT_SIZE = 6
+
+IP_BLACK_LIST = ["192.168.56.1"]  # this is vbox ip
+# max file size to sync or backup
+MAX_FILE_SIZE = 10 * 1024 ** 2
+# 文本编辑器的最大文件限制
+MAX_TEXT_SIZE = 100 * 1024
+# 文件系统列分隔符，文件名保留符号参考函数 xutils.get_safe_file_name(filename)
+FS_COL_SEP = "$"
+# 是否隐藏系统文件
+FS_HIDE_FILES = True
+# 文件管理扩展的选项,类型Storage
+FS_LINK = "/fs_list"
+# 文件浏览模式 list/grid/sidebar
+FS_VIEW_MODE = "list"
+# 文本文件后缀
+FS_TEXT_EXT_LIST = set()
+FS_IMG_EXT_LIST = set([".jpg", ".png", ".gif"])
+FS_CODE_EXT_LIST = set()
+MIME_TYPES = dict()
+
+# 后面定义的set函数和系统函数冲突了，所以这里创建一个hashset的别名
+hashset = set
+# 剪切板
+FS_CLIP = []
+
+# 搜索历史
+search_history = None
+# 笔记访问历史
+note_history = None
+
+# 配置项
+_config = {}
+
+START_TIME = None
+
+# 是否隐藏词典的入口
+HIDE_DICT_ENTRY = True
+
+# 运行时ID
+RUNTIME_ID = None
+# 退出的编码
+EXIT_CODE = 0
+
+class FileReplacement:
+    "文件替换符"
+    data_dir = "$data"
+
+class FileConfig:
+
+    data_dir = ""
+    sqlite_dir = ""
+    backup_dir = ""
+    backup_db_dir = ""
+    db_dir = ""
+    files_dir = ""
+    tmp_dir = ""
+
+    boot_lock_file = "" # 启动的锁文件
+    record_db_name = "" # 默认的sqlite数据库名称
+    record_db_file = "" # 默认的sqlite数据库路径
+    kv_db_name = "kv_store"
+    kv_db_file = ""
+
+    source_root_dir = "" # 源码根目录
+    plugins_dir = "" # 插件目录
+    ext_handlers_dir = "./ext_handlers"
+
+    db_backup_expire_days = 5
+
+    template_base_nav_left = "" # 左侧菜单自定义模板
+    template_base_nav_top = ""
+
+    fs_max_name_length = 50
+
+    @classmethod
+    def init(cls, data_dir):
+        xnote_core_dir = os.path.dirname(__file__)
+        xnote_dir = os.path.dirname(xnote_core_dir)
+        cls.source_root_dir = os.path.dirname(xnote_dir)
+        
+        data_dir = os.path.abspath(data_dir)
+        cls.data_dir = os.path.abspath(data_dir)
+        makedirs(cls.data_dir)
+
+        cls.files_dir = os.path.join(data_dir, "files")
+        makedirs(cls.files_dir)
+
+        cls.db_dir = os.path.join(data_dir, "db")
+        
+        cls.sqlite_dir = os.path.join(data_dir, "db", "sqlite")
+        makedirs(cls.sqlite_dir)
+
+        cls.backup_dir = os.path.join(data_dir, "backup")
+        makedirs(cls.backup_dir)
+
+        cls.backup_db_dir = os.path.join(cls.backup_dir, "db")
+        makedirs(cls.backup_db_dir)
+
+        cls.tmp_dir = os.path.join(data_dir, "tmp")
+        makedirs(cls.tmp_dir)
+
+        cls.record_db_name = SystemConfig.get_str("record_db_name", "record")
+        cls.record_db_file = cls.get_db_path(cls.record_db_name)
+
+        cls.kv_db_name = SystemConfig.get_str("kv_db_name", "kv_store")
+        cls.kv_db_file = cls.get_db_path(cls.kv_db_name)
+
+        cls.db_backup_expire_days = SystemConfig.get_int("db_backup_expire_days", 5)
+        cls.plugins_dir = os.path.join(cls.data_dir, "scripts", "plugins")
+        cls.plugins_upload_dir = os.path.join(cls.plugins_dir, "upload")
+
+        cls.template_base_nav_left = SystemConfig.get_str("template_base_nav_left", "common/nav/base_nav_left.html")
+        cls.template_base_nav_top = SystemConfig.get_str("template_base_nav_top", "common/nav/base_nav_top.html")
+
+        cls.boot_lock_file = SystemConfig.get_str("boot_lock_file", "pid.lock")
+        cls.enable_boot_lock = SystemConfig.get_bool("enable_boot_lock", True)
+
+        global USE_URLENCODE
+        USE_URLENCODE = SystemConfig.get_bool("fs_encode_name", True)
+        fsutil.FileUtilConfig.encode_name = USE_URLENCODE
+
+    @classmethod
+    def get_db_path(cls, dbname=""):
+        """dbname: sqlite数据库的文件名称"""
+        if dbname in ("$temp", "$tmp"):
+            tmp_file_path = fsutil.get_tmp_path(ext=".db")
+            logging.info("tmp_file_path=%s", tmp_file_path)
+            return tmp_file_path
+        if not dbname.endswith(".db"):
+            dbname += ".db"
+        return os.path.join(cls.sqlite_dir, dbname)
+
+    @classmethod
+    def get_backup_db_path(cls, dbname=""):
+        if not dbname.endswith(".db"):
+            dbname += ".db"
+        return os.path.join(cls.backup_db_dir, dbname)
+
+    @classmethod
+    def get_gallery_dir_by_user(cls, user_name=""):
+        assert isinstance(user_name, str)
+        assert len(user_name) > 0
+        return os.path.join(cls.files_dir, user_name, "gallery")
+
+class WebConfig:
+
+    server_home = ""
+    port = "1234"
+
+    # 关于系统的链接
+    about_url = "" 
+    about_text = ""
+    login_url = ""
+
+    # 展示配置
+    # 是否展示footer
+    ui_show_footer = True
+    ui_title_prefix = "Xnote"
+    # 是否展示translate.js组件
+    ui_show_translate_js = False
+    
+    nav_list = []
+    # 自定义导航-开发中
+    custom_nav_list = []
+
+    auth_max_session_size = 20
+
+    fast_reload = False
+
+    sync_interval_seconds = 3
+    sync_db_from_leader = False
+    sync_files_from_leader = False
+
+    # 定时任务开关
+    cron_enabled = True
+
+    @classmethod
+    def init(cls):
+        cls.server_home = SystemConfig.get_str("server_home", "")
+        cls.port = SystemConfig.get_str("port", "1234")
+        cls.about_url = SystemConfig.get_str("about_url", "/code/wiki/README.md")
+        cls.login_url = SystemConfig.get_str("login_url", "/login?target=")
+        cls.about_text = SystemConfig.get_str("about_text", "关于Xnote")
+        cls.nav_list = cls.load_nav_list()
+        cls.auth_max_session_size = SystemConfig.get_int("auth_max_session_size")
+        cls.fast_reload = SystemConfig.get_bool("fast_reload", False)
+
+        cls.ui_show_footer = SystemConfig.get_bool("ui_show_footer")
+        cls.ui_title_prefix = SystemConfig.get_str("ui_title_prefix", "Xnote")
+        cls.ui_show_translate_js = SystemConfig.get_bool("ui_show_translate_js")
+
+        cls.sync_interval_seconds = SystemConfig.get_int("sync_interval_seconds", 3)
+        cls.sync_db_from_leader = SystemConfig.get_bool("sync_db_from_leader", False)
+        cls.sync_files_from_leader = SystemConfig.get_bool("sync_files_from_leader", False)
+        
+        cls.cron_enabled = SystemConfig.get_bool("cron_enabled", True)
+        cls.force_https = SystemConfig.get_bool("force_https", False)
+        cls.record_location = SystemConfig.get_bool("record_location", False)
+    
+    @classmethod
+    def load_nav_list(cls):
+        """加载导航列表"""
+        if len(cls.nav_list) > 0:
+            return cls.nav_list
+        nav_list = []
+        nav_list.append(NavItem(text="首页", need_logout=True,
+                                need_admin=False, url="/system/index"))
+        nav_list.append(NavItem(text="首页", need_login=True,
+                        need_admin=False, url="/note/index"))
+        nav_list.append(NavItem(text="动态", need_login=True,
+                        need_admin=False, url="/note/recent?orderby=update"))
+        nav_list.append(NavItem(text="分享", need_login=False,
+                        need_admin=False, url="/note/public"))
+        nav_list.append(NavItem(text="插件", need_login=True,
+                        need_admin=False, css_class="desktop-only", url="/plugin_list"))
+        nav_list.append(NavItem(text="文件", need_login=True,
+                        need_admin=True, css_class="desktop-only", url="/fs_bookmark"))
+        nav_list.append(NavItem(text="设置", need_login=True,
+                        need_admin=False, url="/system/settings"))
+        nav_list.append(NavItem(text="后台", need_login=True,
+                        need_admin=True, css_class="desktop-only", url="/system/admin"))
+        nav_list.append(NavItem(text="登录", need_logout=True,
+                        need_admin=False, url="/login"))
+        return nav_list
+
+
+class TemplateConfig:
+    """模板配置"""
+    nav_list = []
+    lang_dict = {}
+
+    @classmethod
+    def init(cls):
+        # 加载菜单
+        cls.nav_list = WebConfig.load_nav_list()
+        cls.load_languages()
+
+    @classmethod
+    def load_languages(cls):
+        """加载系统语言配置"""
+        lang_dict = cls.lang_dict
+
+        lang_dict.clear()
+        dirname = LANG_DIR
+        for fname in os.listdir(dirname):
+            name, ext = os.path.splitext(fname)
+            if ext != ".properties":
+                continue
+            fpath = os.path.join(dirname, fname)
+            content = xutils.readfile(fpath)
+            config = xutils.parse_config_text(content, ret_type='dict')
+            lang_dict[name] = config
+        cls.lang_dict = lang_dict
+
+    @classmethod
+    def get_lang_mapping(cls, lang):
+        if lang == None:
+            lang = "zh"
+        return cls.lang_dict.get(lang)
+
+class DatabaseConfig:
+
+    db_driver = "" # sqlite/mysql/leveldb/ssdb
+    db_driver_cache = "" # memory/redis
+    db_driver_sql = "" # sqlite/mysql
+    db_driver_kv = ""  # sqlite/mysql/leveldb/ssdb
+    kv_store = "kv_store" # SQL模拟KV的表名
+
+    user_max_log_size = 500 # 用户日志保留的最大条数
+    db_debug = False
+    db_log_debug = False
+    db_profile_table_proxy = False
+    db_auto_ddl = True # 自动执行DDL
+
+    binlog = False
+    binlog_max_size = 10000
+    # leveldb配置
+    block_cache_size = 16 * 1024**2
+    write_buffer_size = 4 * 1024**2
+    max_open_files = 1000
+
+    # mysql相关配置
+    mysql_cloud_type="" # mysql云服务类型
+    mysql_database = ""
+
+    # sqlite配置 { DELETE, TRUNCATE, PERSIST, WAL, MEMORY, OFF }
+    sqlite_journal_mode = "delete"
+    sqlite_page_size = 0
+    
+    # ssdb相关配置
+    ssdb_host = ""
+    ssdb_port = 8888
+
+    @classmethod
+    def init(cls):
+        cls.db_driver = SystemConfig.get_str("db_driver")
+        cls.db_driver_cache = SystemConfig.get_str("db_driver_cache", "")
+        cls.db_driver_kv = SystemConfig.get_str("db_driver_kv", "")
+        cls.db_driver_sql = SystemConfig.get_str("db_driver_sql", "")
+
+        cls.mysql_cloud_type = SystemConfig.get_str("mysql_cloud_type")
+        cls.mysql_database = SystemConfig.get_str("mysql_database")
+        cls.user_max_log_size = SystemConfig.get_int("user_max_log_size", 500)
+        cls.db_debug = SystemConfig.get_bool("db_debug")
+        cls.db_log_debug = SystemConfig.get_bool("db_log_debug")
+        cls.binlog = SystemConfig.get_bool("binlog")
+        cls.binlog_max_size = SystemConfig.get_int("binlog_max_size")
+        cls.block_cache_size = SystemConfig.get_int("block_cache_size")
+        cls.write_buffer_size = SystemConfig.get_int("write_buffer_size")
+        cls.max_open_files = SystemConfig.get_int("max_open_files")
+        cls.db_profile_table_proxy = SystemConfig.get_int("db_profile_table_proxy")
+        cls.db_sys_log_max_size = SystemConfig.get_int("db_sys_log_max_size", 100000)
+        cls.db_auto_ddl = SystemConfig.get_bool("db_auto_ddl", True)
+
+        cls.sqlite_journal_mode = SystemConfig.get_str("sqlite_journal_mode", "delete")
+        cls.sqlite_page_size = SystemConfig.get_int("sqlite_page_size", 0)
+
+        cls.ssdb_host = SystemConfig.get_str("ssdb_host", "127.0.0.1")
+        cls.ssdb_port = SystemConfig.get_int("ssdb_port", 8888)
+
+        if cls.db_driver_sql == "":
+            if cls.db_driver == "mysql":
+                cls.db_driver_sql = "mysql"
+            else:
+                cls.db_driver_sql = "sqlite"
+        
+        if cls.db_driver_kv == "":
+            cls.db_driver_kv = cls.db_driver
+
+def read_properties_file(fpath):
+    fpath = resolve_config_path(fpath)
+    return fsutil.readfile(fpath)
+
+
+def load_invalid_names():
+    fpath = resolve_config_path("./config/user/invalid_names.list")
+    return fsutil.load_list_config(fpath)
+
+def load_user_config_properties():
+    fpath = resolve_config_path("./config/user/user_config.default.properties")
+    return fsutil.load_prop_config(fpath)
+
+def load_cron_config():
+    fpath = resolve_config_path("./config/cron/cron.json")
+    text = fsutil.readfile(fpath)
+    return json.loads(text)
+
+def makedirs(dirname):
+    if not os.path.exists(dirname):
+        os.makedirs(dirname)
+
+def make_data_dir(dirname):
+    abspath = os.path.join(DATA_DIR, dirname)
+    makedirs(abspath)
+    return abspath
+
+def init(boot_config_file=None, boot_config_kw = None):
+    """初始化系统配置项,启动时必须调用"""
+    global DATA_PATH
+    global DATA_DIR
+    global DB_PATH
+    global DB_FILE
+    global DICT_FILE
+    global RECORD_FILE
+    global BACKUP_DIR
+    global BACKUP_DB_DIR
+    global UPLOAD_DIR
+    global APP_DIR
+    global TMP_DIR
+    global DB_DIR
+    global SCRIPTS_DIR
+    global COMMANDS_DIR
+    global PLUGINS_DIR
+    global CODE_ZIP
+    global DATA_ZIP
+    global TRASH_DIR
+    global LOG_PATH
+    global LOG_DIR
+    global LOG_FILE
+    global STORAGE_DIR
+    global ETC_DIR
+    global PLUGIN_TEMPLATE
+    global RUNTIME_ID
+    global FILE_EXT_PATH
+    global CACHE_DIR
+    global CONFIG_DIR
+
+    if boot_config_file != None:
+        # 初始化启动配置
+        init_boot_config(boot_config_file, boot_config_kw=boot_config_kw)
+
+    path = get_system_config("data")
+    assert isinstance(path, str)
+    DATA_PATH = os.path.abspath(path)
+    DATA_DIR = os.path.abspath(path)
+
+    # 初始HTTP端口号
+    init_http_port()
+
+    # 初始化文件配置
+    FileConfig.init(DATA_DIR)
+    # 初始化web配置
+    WebConfig.init()
+    # 初始化数据库配置
+    DatabaseConfig.init()
+    # 初始化模板配置
+    TemplateConfig.init()
+
+    # 数据库地址
+    init_db_config()
+
+    # 备份数据地址
+    BACKUP_DIR = make_data_dir("backup")
+    BACKUP_DB_DIR = make_data_dir("backup/db")
+
+    # APP地址
+    UPLOAD_DIR = make_data_dir("files")
+    APP_DIR = make_data_dir("app")
+    TMP_DIR = make_data_dir("tmp")
+    CACHE_DIR = make_data_dir("cache")
+
+    # 脚本的地址
+    SCRIPTS_DIR  = make_data_dir("scripts")
+    COMMANDS_DIR = make_data_dir("scripts/commands")
+    PLUGINS_DIR  = make_data_dir("scripts/plugins")
+
+
+    CODE_ZIP = os.path.join(DATA_DIR, "code.zip")
+    DATA_ZIP = os.path.join(DATA_DIR, "data.zip")
+    TRASH_DIR = os.path.join(DATA_DIR, "trash")
+    LOG_PATH = os.path.join(DATA_DIR, "xnote.log")
+    STORAGE_DIR = os.path.join(DATA_DIR, "storage")
+    ETC_DIR = os.path.join(DATA_DIR, "storage")
+    LOG_DIR = os.path.join(DATA_DIR, "log")
+    DB_FILE = DB_PATH
+    LOG_FILE = LOG_PATH
+    FILE_EXT_PATH = os.path.join(CONFIG_DIR, "file", "type.properties")
+
+    # 一级目录
+    makedirs(DATA_DIR)
+    makedirs(UPLOAD_DIR)
+    makedirs(TMP_DIR)
+    makedirs(SCRIPTS_DIR)
+    makedirs(TRASH_DIR)
+    makedirs(STORAGE_DIR)
+    makedirs(ETC_DIR)
+    makedirs(LOG_DIR)
+
+    # 二级目录
+    makedirs(COMMANDS_DIR)
+    makedirs(PLUGINS_DIR)
+
+    # 加载文件后缀配置
+    load_file_type_config()
+
+    # 初始化系统版本配置
+    init_system_version()
+
+    PLUGIN_TEMPLATE = read_properties_file("./config/plugin/plugin.tpl.py")
+
+    RUNTIME_ID = textutil.generate_uuid()
+
+
+def load_default_boot_config():
+    # type: () -> dict
+    text = read_properties_file("./config/boot/boot.default.properties")
+    return textutil.parse_config_text_to_dict(text)
+
+
+def _parse_int(value):
+    assert xutils.is_str(value)
+    if value == "":
+        return 0
+
+    value = value.lower()
+    if value[-2:] == "kb":
+        return int(value[:-2]) * 1024
+
+    if value[-2:] == "mb":
+        return int(value[:-2]) * 1024**2
+
+    if value[-2:] == "gb":
+        return int(value[:-2]) * 1024**3
+
+    if value[-2:] == "tb":
+        return int(value[:-2]) * 1024**4
+
+    if value[-2:] == "pb":
+        return int(value[:-2]) * 1024**5
+    
+    if value[-1] == "k":
+        return int(value[:-1]) * 1000
+    
+    if value[-1] == "m":
+        return int(value[:-1]) * 1000**2
+    
+    return int(value)
+
+
+def init_boot_config(fpath, boot_config_kw=None):
+
+    # 读取默认的配置
+    config_dict = load_default_boot_config()
+
+
+    # 加载用户配置覆盖
+    text = fsutil.readfile(fpath)
+    user_config = textutil.parse_config_text(text, 'dict')
+
+    config_dict.update(user_config)
+    if boot_config_kw != None:
+        config_dict.update(boot_config_kw)
+
+    for key in config_dict:
+        check_part = textutil.remove_tail(key, ".type")
+        if check_part.find(".") >= 0:
+            raise Exception("非法的配置项:(%s), 不能包含(.)" % key)
+
+        value = config_dict[key]
+        value_type = config_dict.get(key + ".type")
+
+        if value_type == "bool":
+            value = (value == "true" or value == "yes")
+        if value_type == "int":
+            value = _parse_int(value)
+
+        set_global_config("system.%s" % key, value)
+
+    global PORT
+    global DEBUG
+    global DEV_MODE
+
+    PORT = get_system_config("port")
+    DEBUG = get_system_config("debug")
+
+    if DEBUG:
+        DEV_MODE = True
+
+
+def init_http_port():
+    port = SystemConfig.get_str("port")
+
+    if port != None:
+        # 指定端口优先级最高
+        os.environ["PORT"] = port
+
+    if not os.environ.get("PORT"):
+        assert isinstance(port, str)
+        os.environ["PORT"] = port
+
+    # 兼容
+    set_global_config("port", port)
+
+
+def init_db_config():
+    global DB_DIR
+    global DB_PATH
+    global DICT_FILE
+    global RECORD_FILE
+
+    DB_DIR = os.path.join(DATA_DIR, "db")
+    DB_PATH = os.path.join(DATA_DIR, "data.db")
+    RECORD_FILE = FileConfig.record_db_file
+
+    makedirs(DB_DIR)
+
+    sqlite_dir = os.path.join(DB_DIR, "sqlite")
+    makedirs(sqlite_dir)
+    DICT_FILE = os.path.join(sqlite_dir, "dictionary.db")
+
+
+def init_system_version():
+    from xutils import fsutil
+    fpath = resolve_config_path("./config/version.txt")
+    system_version = fsutil.readfile(fpath, limit=1000)
+    if system_version != None:
+        system_version = system_version.strip()
+    set_global_config("system.version", system_version)
+
+
+def mark_started():
+    global START_TIME
+    START_TIME = time.time()
+
+
+def load_file_type_config0(fpath):
+    from xutils import fsutil, textutil
+    fpath = resolve_config_path(fpath)
+    text = fsutil.readfile(fpath)
+    ext_set = hashset()
+    ext_type_dict = textutil.parse_config_text_to_dict(text)
+    for ext in ext_type_dict:
+        ext_set.add(ext)
+    return ext_set
+
+
+def load_config_as_dict(fpath):
+    # type: (str) -> dict
+    from xutils import fsutil, textutil
+    fpath = resolve_config_path(fpath)
+    text = fsutil.readfile(fpath)
+    return textutil.parse_config_text_to_dict(text)
+
+def load_config_as_text(fpath):
+    fpath = resolve_config_path(fpath)
+    return fsutil.readfile(fpath)
+
+def load_file_type_config():
+    global FS_TEXT_EXT_LIST
+    global FS_IMG_EXT_LIST
+    global FS_CODE_EXT_LIST
+    global FS_ZIP_EXT_LIST
+    global FS_AUDIO_EXT_LIST
+    global FS_VIDEO_EXT_LIST
+    global MIME_TYPES
+
+    FS_TEXT_EXT_LIST = load_file_type_config0("./config/file/text.properties")
+    FS_IMG_EXT_LIST = load_file_type_config0("./config/file/image.properties")
+    FS_CODE_EXT_LIST = load_file_type_config0("./config/file/code.properties")
+    FS_ZIP_EXT_LIST = load_file_type_config0("./config/file/zip.properties")
+    FS_AUDIO_EXT_LIST = load_file_type_config0(
+        "./config/file/audio.properties")
+    FS_VIDEO_EXT_LIST = load_file_type_config0(
+        "./config/file/video.properties")
+    MIME_TYPES = load_config_as_dict("./config/file/mime-types.properties")
+    MIME_TYPES[""] = "application/octet-stream"
+
+
+def get_global_config(name, default_value=None, type=None):
+    """获取配置，如果不存在返回default值"""
+    value = _config.get(name)
+    if value is not None:
+        return value
+
+    value = globals().get(name)
+    if value is not None:
+        return value
+
+    if value is None:
+        return default_value
+    return value
+
+def get_system_config(name, default_value=None):
+    return get_global_config("system." + name, default_value)
+
+def get_system_config_int(name, default_value = 0):
+    value = get_system_config(name, default_value = default_value)
+    assert isinstance(value, int)
+    return value
+
+def get(key, default_value=None):
+    return get_global_config(key, default_value)
+
+def get_str(key, default_value=""):
+    value = get(key, default_value=default_value)
+    assert isinstance(value, str)
+    return value
+
+def set(name, value):
+    """和set函数冲突了，建议使用 set_global_config"""
+    return set_global_config(name, value)
+
+
+def put(name, value):
+    return set_global_config(name, value)
+
+
+def set_global_config(name, value):
+    _config[name] = value
+
+def set_system_config(name, value):
+    set_global_config("system." + name, value)
+
+def get_config():
+    raise Exception("deprecated: use xconfig.get_config_dict")
+
+def get_config_dict():
+    return _config
+
+
+def has_config(key, subkey=None):
+    return has_global_config(key, subkey)
+
+
+def has(key):
+    return has_global_config(key)
+
+
+def has_global_config(key, subkey=None):
+    group_value = get_global_config(key)
+    if group_value is None:
+        return False
+    if subkey is None:
+        return True
+    return subkey in group_value
+
+
+def is_mute():
+    """是否静音"""
+    return MUTE_END_TIME is not None and time.time() < MUTE_END_TIME
+
+
+# 设置别名
+_alias_dict = {}
+
+
+def set_alias(name, value):
+    """设置别名，用于扩展命令"""
+    _alias_dict[name] = value
+
+
+def get_alias(name, default_value):
+    """获取别名，用于扩展命令"""
+    return _alias_dict.get(name, default_value)
+
+
+def get_user_config(user_name, config_key, default_value=None):
+    """默认值参考DEFAULT_USER_CONFIG"""
+    # 未启动，直接返回默认值
+    if START_TIME is None:
+        return default_value
+
+    from . import xauth
+    return xauth.get_user_config(user_name, config_key)
+
+
+def update_user_config(user_name, key, value):
+    from . import xauth
+    return xauth.update_user_config(user_name, key, value)
+
+
+def get_user_config_dict(user_name):
+    from . import xauth
+    value = xauth.get_user_config_dict(user_name)
+    if value is None:
+        return Storage()
+    return value
+
+
+def get_current_user_config(key, default_value=None):
+    if START_TIME is None:
+        return default_value
+    
+    from . import xauth
+    """默认值参考DEFAULT_USER_CONFIG"""
+    return get_user_config(xauth.current_name(), key, default_value)
+
+
+def get_system_dir(name):
+    if name == "files":
+        return UPLOAD_DIR
+
+    if name == "data":
+        return DATA_DIR
+
+    if name == "tmp":
+        return TMP_DIR
+
+    if name == "storage":
+        return STORAGE_DIR
+
+    if name == "scripts":
+        return SCRIPTS_DIR
+
+    if name == "app":
+        return APP_DIR
+
+    if name == "archive":
+        return os.path.join(DATA_DIR, "archive")
+    
+    if name == "cache":
+        return os.path.join(DATA_DIR, "cache")
+
+    raise Exception("未知的系统目录:" + name)
+
+
+def get_upload_dir(username):
+    if username is None:
+        raise Exception("username is None")
+
+    upload_dir_root = get_system_dir("files")
+    return os.path.join(upload_dir_root, username, "upload")
+
+
+def get_backup_dir(name=None):
+    if name == None:
+        return BACKUP_DIR
+
+    assert isinstance(name, str)
+    return os.path.join(BACKUP_DIR, name)
+
+def get_system_files():
+    return hashset([
+        BACKUP_DB_DIR,
+    ])
+
+
+class SystemConfig:
+
+    @classmethod
+    def get_int(cls, name, default_value=0):
+        value = get_system_config(name, default_value)
+        if value == "":
+            return default_value
+        if isinstance(value, str):
+            value = value.replace("_", "") # 支持 100_000 这种格式
+        return int(value)
+    
+    @classmethod
+    def get_str(cls, name, default_value=""):
+        value = get_system_config(name, default_value)
+        return str(value)
+
+    @classmethod
+    def get_bool(cls, name, default_value=False):
+        value = get_system_config(name, default_value)
+        if isinstance(value, str):
+            return value.lower() == "true"
+        return bool(value)
+
+system_config = SystemConfig()
+
+
+
+
+class NavItem:
+
+    def __init__(self, text="", need_login=False, need_logout=False, need_admin=False, url="", css_class=""):
+        self.text = text
+        self.need_login = need_login
+        self.need_logout = need_logout
+        self.need_admin = need_admin
+        self.url = url
+        self.css_class = css_class
+
+    def check_platform(self):
+        return True
+
+    def is_visible(self):
+        from . import xauth
+        # 先判断高权限的
+        if self.need_admin:
+            return xauth.is_admin() and self.check_platform()
+
+        if self.need_login:
+            return xauth.has_login() and self.check_platform()
+
+        if self.need_logout:
+            return not xauth.has_login() and self.check_platform()
+
+        return self.check_platform()
+
```

### Comparing `xnote-web-0.1.0/xnote/core/xnote_app.py` & `xnote-web-0.1.1/xnote/core/xnote_app.py`

 * *Files 2% similar despite different names*

```diff
@@ -107,15 +107,14 @@
     time.sleep(delay)
 
     xconfig.MIN_THREADS = xconfig.get_system_config("min_threads")
     xconfig.INIT_SCRIPT = args.initScript
     web.config.minthreads = xconfig.MIN_THREADS
 
     xconfig.USE_CACHE_SEARCH = get_bool_by_sys_arg(args.useCacheSearch)
-    xconfig.USE_URLENCODE = get_bool_by_sys_arg(args.useUrlencode)
     xconfig.IS_TEST = get_bool_by_sys_arg(args.test)
 
     if xconfig.DEBUG:
         web.config.debug = xconfig.DEBUG
 
     start_time = xutils.format_datetime()
     xconfig.set_global_config("start_time", start_time)
@@ -285,15 +284,15 @@
     mem_util.ignore_log_mem_info_deco("sync_by_binlog_step")
 
 
 def init_xutils():
     xutils.init(xconfig)
     from xutils.fsutil import FileUtilConfig
     FileUtilConfig.data_dir = xconfig.FileConfig.data_dir
-    FileUtilConfig.use_urlencode = xconfig.USE_URLENCODE
+    FileUtilConfig.encode_name = xconfig.USE_URLENCODE
     FileUtilConfig.tmp_dir = xconfig.FileConfig.tmp_dir
 
 def init_app_internal(boot_config_kw=None):
     """初始化APP内部方法"""
     global app
     print_env_info()
```

### Comparing `xnote-web-0.1.0/xnote/core/xnote_code_builder.py` & `xnote-web-0.1.1/xnote/core/xnote_code_builder.py`

 * *Ordering differences only*

 * *Files 25% similar despite different names*

```diff
@@ -1,158 +1,158 @@
-# -*- coding:utf-8 -*-
-# @author mark
-# @since 2022/02/19 12:45:23
-# @modified 2022/04/09 18:43:28
-# @filename build.py
-
-import os
-import shutil
-import threading
-from . import xconfig
-
-try:
-    import termcolor
-except ImportError:
-    class termcolor:
-
-        @staticmethod
-        def colored(text, color):
-            return text
-
-BLOCKSIZE = 4 * 1024 # 4K
-_lock = threading.RLock()
-
-def green_text(text):
-    return termcolor.colored(text, "green")
-
-def red_text(text):
-    return termcolor.colored(text, "red")
-
-class FileBuilder:
-
-    def __init__(self, fpath):
-        self.target_path = xconfig.resolve_config_path(fpath)
-        self.source_path_list = []
-
-    def close(self):
-        pass
-
-    def append(self, fpath):
-        fpath = xconfig.resolve_config_path(fpath)
-        self.source_path_list.append(fpath)
-
-    def __enter__(self):
-        return self
-    
-    def append_file_to(self, fpath, target_fp):
-        with open(fpath, "rb") as read_fp:
-            shutil.copyfileobj(read_fp, target_fp, BLOCKSIZE)
-    
-    def do_build(self):
-        with open(self.target_path, "wb+") as fp:
-            for fpath in self.source_path_list:
-                self.append_file_to(fpath, fp)
-        
-        print("文件构建完成:%s" % self.target_path)
-
-    def __exit__(self, type, value, traceback):
-        if not os.path.exists(self.target_path):
-            self.do_build()
-            return
-        
-        target_mtime = os.stat(self.target_path).st_mtime
-        for fpath in self.source_path_list:
-            source_mtime = os.stat(fpath).st_mtime
-            if source_mtime > target_mtime:
-                print("文件发生了修改:%s" % fpath)
-                self.do_build()
-                return
-
-def build_app_css():
-    with FileBuilder("./static/css/app.build.css") as builder:
-        builder.append("./static/lib/font-awesome-4.7.0/css/font-awesome.min.css")
-
-        # 通用的css
-        builder.append("./static/css/base/reset.css")
-        builder.append("./static/css/base/common.css")
-        builder.append("./static/css/base/common-mobile.css")
-        builder.append("./static/css/base/common-icon.css")
-        builder.append("./static/css/base/common-tag.css")
-        builder.append("./static/css/base/common-layout.css")
-        builder.append("./static/css/base/common-button.css")
-        builder.append("./static/css/base/common-markdown.css")
-        builder.append("./static/css/base/common-dialog.css")
-        builder.append("./static/css/base/common-tab.css")
-        builder.append("./static/css/base/common-dropdown.css")
-        builder.append("./static/css/base/common-page.css")
-        builder.append("./static/css/base/common-photo.css")
-
-        # 场景化的css
-        builder.append("./static/css/common-react.css")
-        builder.append("./static/css/app.css")
-        builder.append("./static/css/message.css")
-        builder.append("./static/css/note.css")
-        builder.append("./static/css/plugins.css")
-        builder.append("./static/css/search.css")
-        builder.append("./static/css/todo.css")
-        # echo "打包app.build.css ... [OK]"
-
-        # 针对特殊设备的适配
-        builder.append("./static/css/base/reset-wide.css")
-
-def build_utils_js():
-    with FileBuilder("./static/js/utils.build.js") as builder:
-        # utils.js
-        builder.append("./static/js/base/array.js")
-        builder.append("./static/js/base/string.js")
-        builder.append("./static/js/base/datetime.js")
-        builder.append("./static/js/base/misc.js")
-        builder.append("./static/js/base/jq-ext.js")
-
-def build_app_js():
-    with FileBuilder("./static/js/app.build.js") as builder:
-        # utils.build.js 也都合并到 app.build.js 文件中
-        builder.append("./static/js/utils.build.js")
-
-        # xnote-ui
-        builder.append("./static/js/xnote-ui/x-init.js")
-        builder.append("./static/js/xnote-ui/x-event.js")
-        builder.append("./static/js/xnote-ui/x-ext.js")
-        builder.append("./static/js/xnote-ui/x-core.js")
-        builder.append("./static/js/xnote-ui/layer.photos.js")
-        builder.append("./static/js/xnote-ui/x-device.js")
-        builder.append("./static/js/xnote-ui/x-dropdown.js")
-        builder.append("./static/js/xnote-ui/x-photo.js")
-        builder.append("./static/js/xnote-ui/x-audio.js")
-        builder.append("./static/js/xnote-ui/x-upload.js")
-        builder.append("./static/js/xnote-ui/x-dialog.js")
-        builder.append("./static/js/xnote-ui/x-tab.js")
-        builder.append("./static/js/xnote-ui/x-layout.js")
-        builder.append("./static/js/xnote-ui/x-template.js")
-        builder.append("./static/js/xnote-ui/x-url.js")
-
-        # app.js
-        builder.append("./static/js/app.js")
-        builder.append("./static/js/note.js")
-        builder.append("./static/js/fs/fs.js")
-
-def build():
-    with _lock:
-        build_app_css()
-        build_utils_js()
-        build_app_js()
-
-def main():
-    with _lock:
-        build_app_css()
-        print("-"*50)
-
-        build_utils_js()
-        print("-"*50)
-
-        build_app_js()
-        print("-"*50)
-
-        print(green_text("全部打包完成!"))
-
-if __name__ == '__main__':
-    main()
+# -*- coding:utf-8 -*-
+# @author mark
+# @since 2022/02/19 12:45:23
+# @modified 2022/04/09 18:43:28
+# @filename build.py
+
+import os
+import shutil
+import threading
+from . import xconfig
+
+try:
+    import termcolor
+except ImportError:
+    class termcolor:
+
+        @staticmethod
+        def colored(text, color):
+            return text
+
+BLOCKSIZE = 4 * 1024 # 4K
+_lock = threading.RLock()
+
+def green_text(text):
+    return termcolor.colored(text, "green")
+
+def red_text(text):
+    return termcolor.colored(text, "red")
+
+class FileBuilder:
+
+    def __init__(self, fpath):
+        self.target_path = xconfig.resolve_config_path(fpath)
+        self.source_path_list = []
+
+    def close(self):
+        pass
+
+    def append(self, fpath):
+        fpath = xconfig.resolve_config_path(fpath)
+        self.source_path_list.append(fpath)
+
+    def __enter__(self):
+        return self
+    
+    def append_file_to(self, fpath, target_fp):
+        with open(fpath, "rb") as read_fp:
+            shutil.copyfileobj(read_fp, target_fp, BLOCKSIZE)
+    
+    def do_build(self):
+        with open(self.target_path, "wb+") as fp:
+            for fpath in self.source_path_list:
+                self.append_file_to(fpath, fp)
+        
+        print("文件构建完成:%s" % self.target_path)
+
+    def __exit__(self, type, value, traceback):
+        if not os.path.exists(self.target_path):
+            self.do_build()
+            return
+        
+        target_mtime = os.stat(self.target_path).st_mtime
+        for fpath in self.source_path_list:
+            source_mtime = os.stat(fpath).st_mtime
+            if source_mtime > target_mtime:
+                print("文件发生了修改:%s" % fpath)
+                self.do_build()
+                return
+
+def build_app_css():
+    with FileBuilder("./static/css/app.build.css") as builder:
+        builder.append("./static/lib/font-awesome-4.7.0/css/font-awesome.min.css")
+
+        # 通用的css
+        builder.append("./static/css/base/reset.css")
+        builder.append("./static/css/base/common.css")
+        builder.append("./static/css/base/common-mobile.css")
+        builder.append("./static/css/base/common-icon.css")
+        builder.append("./static/css/base/common-tag.css")
+        builder.append("./static/css/base/common-layout.css")
+        builder.append("./static/css/base/common-button.css")
+        builder.append("./static/css/base/common-markdown.css")
+        builder.append("./static/css/base/common-dialog.css")
+        builder.append("./static/css/base/common-tab.css")
+        builder.append("./static/css/base/common-dropdown.css")
+        builder.append("./static/css/base/common-page.css")
+        builder.append("./static/css/base/common-photo.css")
+
+        # 场景化的css
+        builder.append("./static/css/common-react.css")
+        builder.append("./static/css/app.css")
+        builder.append("./static/css/message.css")
+        builder.append("./static/css/note.css")
+        builder.append("./static/css/plugins.css")
+        builder.append("./static/css/search.css")
+        builder.append("./static/css/todo.css")
+        # echo "打包app.build.css ... [OK]"
+
+        # 针对特殊设备的适配
+        builder.append("./static/css/base/reset-wide.css")
+
+def build_utils_js():
+    with FileBuilder("./static/js/utils.build.js") as builder:
+        # utils.js
+        builder.append("./static/js/base/array.js")
+        builder.append("./static/js/base/string.js")
+        builder.append("./static/js/base/datetime.js")
+        builder.append("./static/js/base/misc.js")
+        builder.append("./static/js/base/jq-ext.js")
+
+def build_app_js():
+    with FileBuilder("./static/js/app.build.js") as builder:
+        # utils.build.js 也都合并到 app.build.js 文件中
+        builder.append("./static/js/utils.build.js")
+
+        # xnote-ui
+        builder.append("./static/js/xnote-ui/x-init.js")
+        builder.append("./static/js/xnote-ui/x-event.js")
+        builder.append("./static/js/xnote-ui/x-ext.js")
+        builder.append("./static/js/xnote-ui/x-core.js")
+        builder.append("./static/js/xnote-ui/layer.photos.js")
+        builder.append("./static/js/xnote-ui/x-device.js")
+        builder.append("./static/js/xnote-ui/x-dropdown.js")
+        builder.append("./static/js/xnote-ui/x-photo.js")
+        builder.append("./static/js/xnote-ui/x-audio.js")
+        builder.append("./static/js/xnote-ui/x-upload.js")
+        builder.append("./static/js/xnote-ui/x-dialog.js")
+        builder.append("./static/js/xnote-ui/x-tab.js")
+        builder.append("./static/js/xnote-ui/x-layout.js")
+        builder.append("./static/js/xnote-ui/x-template.js")
+        builder.append("./static/js/xnote-ui/x-url.js")
+
+        # app.js
+        builder.append("./static/js/app.js")
+        builder.append("./static/js/note.js")
+        builder.append("./static/js/fs/fs.js")
+
+def build():
+    with _lock:
+        build_app_css()
+        build_utils_js()
+        build_app_js()
+
+def main():
+    with _lock:
+        build_app_css()
+        print("-"*50)
+
+        build_utils_js()
+        print("-"*50)
+
+        build_app_js()
+        print("-"*50)
+
+        print(green_text("全部打包完成!"))
+
+if __name__ == '__main__':
+    main()
```

### Comparing `xnote-web-0.1.0/xnote/core/xnote_hooks.py` & `xnote-web-0.1.1/xnote/core/xnote_hooks.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote/core/xnote_trace.py` & `xnote-web-0.1.1/xnote/core/xnote_trace.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote/core/xnote_user_config.py` & `xnote-web-0.1.1/xnote/core/xnote_user_config.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote/core/xtables.py` & `xnote-web-0.1.1/xnote/core/xtables.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,690 +1,692 @@
-# -*- coding:utf-8 -*-
-# Created by xupingmao on 2017/03/15
-# @modified 2021/11/07 14:14:15
-"""Xnote的数据库配置(此模块已经废弃)
-    考虑到持续运行的维护，增加表结构需要非常慎重
-    考虑清楚你需要的是数据还是配置，如果是配置建议通过扩展脚本配置xconfig
-"""
-import os
-import threading
-import xutils
-from . import xconfig
-import web.db
-from xutils import dbutil
-from xutils.dbutil import interfaces
-from xutils.sqldb import TableManagerFacade as TableManager
-from xutils.sqldb import TableProxy, TableConfig
-from xutils import fsutil
-
-
-DEFAULT_DATETIME = "1970-01-01 00:00:00"
-DEFAULT_DATE = "1970-01-01"
-
-class MySqliteDB(web.db.SqliteDB):
-    _lock = threading.RLock()
-    _instances = set()
-    dbpath = ""
-
-    def __init__(self, **keywords):
-        super().__init__(**keywords)
-        with self._lock:
-            MySqliteDB._instances.add(self)
-
-    def __del__(self):
-        with self._lock:
-            MySqliteDB._instances.remove(self)
-
-    def __hash__(self):
-        return id(self)
-
-class DBPool:
-    # TODO 池化会导致资源无法释放
-
-    sqlite_pool = {} # type: dict[str, MySqliteDB]
-    mysql_instance = None # type: web.db.MySQLDB
-
-    @classmethod
-    def get_sqlite_db(cls, dbpath=""):
-        # type: (str) -> MySqliteDB
-        assert dbpath != ""
-        db = cls.sqlite_pool.get(dbpath)
-        if db == None:
-            db = MySqliteDB(db=dbpath)
-            db.query("pragma journal_mode = %s" % xconfig.DatabaseConfig.sqlite_journal_mode)
-            if xconfig.DatabaseConfig.sqlite_page_size != 0:
-                db.query("pragma page_size = %s" % xconfig.DatabaseConfig.sqlite_page_size)
-            cls.sqlite_pool[dbpath] = db
-        return db
-
-def create_table_manager_with_dbpath(table_name="", dbpath="", **kw):
-    assert table_name != ""
-    assert dbpath != ""
-    db = get_db_instance(dbpath)
-    kw["db_type"] = xconfig.DatabaseConfig.db_driver_sql
-    return TableManager(table_name, db=db, mysql_database=xconfig.DatabaseConfig.mysql_database, **kw)
-
-def create_table_manager_with_db(table_name="", db=None, **kw):
-    assert isinstance(db, web.db.DB)
-    kw["db_type"] = xconfig.DatabaseConfig.db_driver_sql
-    return TableManager(table_name, db=db, mysql_database=xconfig.DatabaseConfig.mysql_database, **kw)
-
-def create_record_table_manager(table_name=""):
-    """默认使用 record.db 文件"""
-    return create_table_manager_with_dbpath(table_name, xconfig.FileConfig.record_db_file)
-
-def create_default_table_manager(table_name="", **kw):
-    return create_table_manager_with_dbpath(table_name, xconfig.FileConfig.record_db_file, **kw)
-
-def get_default_db_instance():
-    return get_db_instance(xconfig.FileConfig.record_db_file)
-
-def get_db_instance(dbpath=""):
-    db_driver_sql = xconfig.DatabaseConfig.db_driver_sql
-    if db_driver_sql == "mysql":
-        if DBPool.mysql_instance == None:
-            db_host = xconfig.get_system_config("mysql_host")
-            db_name = xconfig.get_system_config("mysql_database")
-            db_user = xconfig.get_system_config("mysql_user")
-            db_pw = xconfig.get_system_config("mysql_password")
-            db_port = xconfig.get_system_config("mysql_port")
-
-            if xconfig.DatabaseConfig.mysql_cloud_type == "sae":
-                db_host = os.environ["MYSQL_HOST"]
-                db_user = os.environ["MYSQL_USER"]
-                db_pw = os.environ["MYSQL_PASS"]
-                db_name = os.environ["MYSQL_DB"]
-
-            db = web.db.MySQLDB(host=db_host, database=db_name,
-                                user=db_user, pw=db_pw, port=db_port)
-            db.dbname = "mysql"
-            DBPool.mysql_instance = db
-        return DBPool.mysql_instance
-    assert dbpath != ""
-    # db = MySqliteDB(db=dbpath)
-    db = DBPool.get_sqlite_db(dbpath=dbpath)
-    db.dbpath = dbpath
-    return db
-
-def is_table_exists(table_name=""):
-    """判断表是否存在"""
-    table_info = TableManager.get_table_info(table_name)
-    return table_info != None
-
-def get_table_by_name(table_name=""):
-    # type: (str) -> TableProxy
-    """通过表名获取操作代理"""
-    table_info = TableManager.get_table_info(table_name)
-    if table_info == None:
-        raise Exception("table not found: %s" % table_name)
-    db = get_db_instance(dbpath=table_info.dbpath)
-    return TableProxy(db, table_name)
-
-
-def get_all_tables(is_deleted=False):
-    # type: (bool) -> list[TableProxy]
-    """获取所有的sql-数据库代理实例"""
-    result = []
-    table_dict = TableManager.get_table_info_dict()
-    for table_name in table_dict:
-        table_info = table_dict[table_name]
-        if is_deleted != table_info.is_deleted:
-            continue
-        proxy = get_table_by_name(table_name)
-        result.append(proxy)
-    return result
-
-
-################################################
-#  表定义
-################################################
-
-def init_test_table():
-    """测试数据库"""
-    table_name = "test"
-    with create_record_table_manager(table_name) as manager:
-        manager.add_column("int_value", "int", default_value=0)
-        manager.add_column("float_value", "float", default_value=0.0)
-        manager.add_column("text_value", "text", default_value="")
-        manager.add_column("name", "text", default_value="test")
-        manager.add_column("uuid", "varchar(32)", default_value="")
-        manager.add_index("name")
-        manager.add_index("uuid", is_unique=True)
-
-
-def init_note_index_table():
-    comment = "笔记索引"
-    with create_default_table_manager("note_index", comment=comment) as manager:
-        manager.add_column("name", "varchar(255)", "")
-        # 文本内容长度
-        manager.add_column("size", "bigint", 0)
-        # 子节点数量
-        manager.add_column("children_count", "bigint", 0)
-        # 修改版本
-        manager.add_column("version", "int", 0)
-        # 类型, markdown, post, mailist, file
-        manager.add_column("type", "varchar(32)", "")
-        # 上级目录
-        manager.add_column("parent_id", "bigint", 0)
-        # 创建时间ctime
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        # 修改时间mtime
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        # 删除时间
-        manager.add_column("dtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("is_deleted", "tinyint", 0, comment="逻辑删除标记")
-        manager.add_column("is_public", "tinyint", 0, comment="是否是公开的笔记")
-        
-        # 创建者
-        manager.add_column("creator", "varchar(64)", "")
-        manager.add_column("creator_id", "bigint", 0)
-        manager.add_column("level", "tinyint", 0)
-        manager.add_column("tag_str", "varchar(255)", "")
-        manager.add_column("visit_cnt", "bigint", 0, comment="访问次数")
-
-        # 各种索引
-        manager.add_index("parent_id")
-        manager.add_index(["creator_id", "mtime"])
-        manager.add_index(["creator_id", "type"])
-
-def init_share_info_table():
-    comment = "分享记录"
-    table_name = "share_info"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME, comment="创建时间")
-        # 分享类型 {note_public, note_to_user, note_to_group}
-        manager.add_column("share_type", "varchar(16)", "", comment="分享类型")
-        manager.add_column("target_id", "bigint", 0, comment="被分享的对象ID")
-        manager.add_column("from_id", "bigint", 0, comment="分享人ID")
-        manager.add_column("to_id", "bigint", 0, comment="接收人ID")
-        manager.add_column("visit_cnt", "bigint", 0, comment="访问次数")
-
-        # 索引
-        manager.add_index(["share_type", "ctime"])
-        manager.add_index(["share_type", "visit_cnt"])
-        manager.add_index("target_id")
-        manager.add_index("from_id")
-        manager.add_index("to_id")
-
-def init_user_table():
-    # 2017/05/21
-    # 简单的用户表
-    comment = "用户信息"
-    with create_default_table_manager("user", comment=comment) as manager:
-        manager.add_column("name", "varchar(64)", "")
-        manager.add_column("password", "varchar(64)", "") # 始终为空
-        manager.add_column("password_md5", "varchar(64)", "")
-        manager.add_column("mobile", "varchar(32)", "")
-        manager.add_column("salt", "varchar(64)", "")
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("token", "varchar(32)", "")
-        manager.add_column("login_time", "datetime", DEFAULT_DATETIME)
-        manager.add_column("status", "tinyint", 0)
-        manager.add_index("name", is_unique=True)
-        manager.add_index("token")
-        # 删除的字段
-        manager.drop_column("privileges", "text", "")
-        manager.table_info.enable_binlog = True
-
-
-def init_user_op_log_table():
-    # 2023/07/15 用户操作日志，从kv迁移到sql
-    with create_default_table_manager("user_op_log") as manager:
-        manager.add_column("user_name", "varchar(64)", "")
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("ip", "varchar(32)", "")
-        manager.add_column("type", "varchar(32)", "")
-        manager.add_column("detail", "text", "")
-
-
-def init_message_table():
-    """
-    用来存储比较短的消息,消息和资料库的主要区别是消息存储较短的单一信息
-    - 消息支持状态
-    - 2017/05/29
-    """
-    table_name = "message"
-    with create_table_manager_with_dbpath(table_name) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user",  "varchar(64)", "")
-        # 用一个状态可以拍成一排
-        # 消息的状态 0关注 50挂起 100已完成
-        manager.add_column("status", "int", 0)
-        manager.add_column("content", "text", "")
-        # IP地址
-        manager.add_column("ip", "varchar(32)", "")
-        # 地址信息
-        manager.add_column("location", "varchar(255)", "")
-        # 索引
-        manager.add_index(["user", "ctime", "status"])
-        manager.add_index(["user", "status"])
-
-
-def init_record_table():
-    # 日志记录
-    dbpath = xconfig.FileConfig.record_db_file
-    comment = "通用日志记录"
-    with create_table_manager_with_dbpath("record", dbpath=dbpath, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        # 添加单独的日期，方便统计用，尽量减少SQL函数的使用
-        manager.add_column("cdate", "date", "1970-01-01")
-        manager.add_column("type",  "varchar(64)", "")
-        # 自己把所有条件都组装到key里
-        manager.add_column("key",  "varchar(100)", "")
-        manager.add_column("value", "text", "")
-        # 索引
-        manager.add_index(["type", "ctime"])
-
-
-def init_dict_table():
-    """词典，和主库隔离
-    @since 2018/01/14
-    """
-    comment = "词典"
-    with create_default_table_manager("dictionary", comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("key", "varchar(100)", "")
-        manager.add_column("value", "text", "")
-        manager.add_index("key")
-
-
-def init_note_tag_rel_table():
-    """笔记标签绑定关系
-    @since 2023/07/01
-    """
-    table_name = "note_tag_rel"
-    comment = "笔记标签绑定关系(废弃)"
-    with create_default_table_manager(table_name, is_deleted=True, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("note_id", "varchar(32)", "")
-        manager.add_column("tag_code", "varchar(32)", "")
-        manager.add_index(["user_id", "tag_code"])
-
-def init_tag_info_table():
-    """标签信息
-    @since 2023/09/09
-    """
-    table_name = "tag_info"
-    with create_default_table_manager(table_name) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("tag_type", "tinyint", 0)
-        manager.add_column("tag_code",  "varchar(32)", "")
-        manager.add_column("tag_size", "bigint", 0)
-        manager.add_index(["user_id", "tag_code"])
-
-
-def init_tag_bind_table():
-    """标签绑定关系
-    @since 2023/09/09
-    """
-    table_name = "tag_bind"
-    comment = "标签绑定关系"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("tag_type", "tinyint", 0)
-        manager.add_column("tag_code",  "varchar(32)", "")
-        manager.add_column("target_id", "bigint", 0)
-        manager.add_index(["user_id", "tag_code"])
-        manager.add_index(["user_id", "target_id"])
-
-def init_file_info():
-    """文件信息
-    @since 2023/05/26
-    """
-    table_name = "file_info"
-    comment = "文件索引信息"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("fpath", "text", "")
-        manager.add_column("ftype", "varchar(16)", "")
-        manager.add_column("fsize", "bigint", 0)
-        manager.add_column("user_id", "bigint", 0)
-
-        manager.add_index("user_id")
-        manager.add_index("fpath", key_len=100)
-        manager.add_index(["ftype", "fpath"], key_len_list=[0, 100])
-
-
-def init_site_visit_log():
-    """站点访问日志
-    @since 2023/05/28
-    """
-    table_name = "site_visit_log"
-    comment = "站点访问统计"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("date", "date", "1970-01-01")
-        manager.add_column("site", "varchar(64)", "")
-        manager.add_column("ip", "varchar(64)", "")
-        manager.add_column("count", "bigint", 0)
-        manager.add_index(["date", "ip"])
-    
-    # 日志数据, 关闭profile
-    TableConfig.disable_profile(table_name)
-    TableConfig.disable_binlog(table_name)
-
-def init_page_visit_log():
-    """页面访问日志
-    @since 2024/02/14
-    """
-    table_name = "page_visit_log"
-    comment = "页面访问统计"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("visit_time", "datetime", DEFAULT_DATETIME)
-        manager.add_column("visit_cnt", "bigint", 0)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("url", "varchar(256)", "")
-        manager.add_column("args", "text", "")
-        manager.add_index(["user_id", "url"])
-    
-    # 日志数据, 关闭profile
-    TableConfig.disable_profile(table_name)
-    TableConfig.disable_binlog(table_name)
-
-def init_job_table():
-    """系统任务
-    @since 2024/03/10
-    """
-    table_name = "t_job" # 避免关键字冲突
-    comment = "系统任务"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("job_type", "varchar(30)", "")
-        manager.add_column("job_status", "tinyint", 0, comment="日志状态,0-初始化,1-执行中,2-执行成功,3-执行失败")
-        manager.add_column("job_params", "text", "")
-        manager.add_column("job_result", "text", "")
-        manager.add_index(["job_type", "mtime"])
-
-def init_lock_table():
-    """分布式锁的表
-    @since 2024/04/03
-    """
-    table_name = "t_lock" # 避免和关键字冲突
-    comment = "系统任务"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("ctime", "datetime", default_value=DEFAULT_DATETIME)
-        manager.add_column("mtime", "datetime", default_value=DEFAULT_DATETIME)
-        manager.add_column("lock_key", "varchar(128)", default_value="")
-        manager.add_column("lock_token", "varchar(36)", default_value="", comment="锁的token")
-        manager.add_column("timeout_time", "bigint", default_value=0, comment="锁超时时间,毫秒时间戳")
-        manager.add_index("lock_key", is_unique=True)
-
-def init_msg_index_table():
-    """随手记索引"""
-    table_name = "msg_index"
-    comment = "随手记索引"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        # 展示创建时间
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        # 实际创建时间
-        manager.add_column("ctime_sys", "datetime", DEFAULT_DATETIME)
-        # 修改时间
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("user_name", "varchar(64)", "")
-        # 短信息的类型
-        manager.add_column("tag", "varchar(16)", "")
-        manager.add_column("date", "date", default_value=DEFAULT_DATE)
-        manager.add_column("sort_value", "varchar(64)", default_value="", comment="排序字段")
-        manager.add_index(["user_id", "ctime"])
-        manager.add_index(["user_id", "mtime"])
-        manager.add_index(["user_id", "sort_value"])
-
-def init_msg_history_index():
-    """随手记历史索引"""
-    table_name = "msg_history_index"
-    comment = "随手记历史索引"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        # 展示创建时间
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("msg_id", "bigint", 0)
-        manager.add_column("msg_version", "bigint", 0)
-        manager.add_index(["msg_id"])
-
-def init_kv_store_table():
-    kw = dict()
-    kw["pk_name"] = "key"
-    kw["pk_len"] = 100
-    kw["pk_type"] = "blob"
-    kw["debug"] = xconfig.DatabaseConfig.db_debug
-    kw["comment"] = "kv存储"
-    dbpath = xconfig.FileConfig.kv_db_file
-    with create_table_manager_with_dbpath("kv_store", dbpath=dbpath, **kw) as manager:
-        manager.add_column("value", "longblob", default_value="")
-        manager.add_column("version", "int", default_value=0)
-
-def init_kv_zset_table(db=None):
-    """使用关系型数据库模拟redis的zset结构"""
-    comment = "模拟redis的zset"
-    with create_table_manager_with_db("kv_zset", db=db, comment=comment) as manager:
-        manager.add_column("key", "varchar(512)", "")
-        manager.add_column("member", "varchar(512)", "")
-        manager.add_column("score", "bigint", default_value=0)
-        manager.add_column("version", "int", default_value=0)
-        manager.add_index(["key", "member"], is_unique=True, key_len_list=[32,100])
-        manager.add_index(["key", "score"], key_len_list=[32, 0])
-
-def init_comment_index_table():
-    """评论索引"""
-    table_name = "comment_index"
-    comment = "评论索引"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        # 展示创建时间
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        # 修改时间
-        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("type", "varchar(16)", 0)
-        manager.add_column("user_id", "bigint", 0, comment="用户ID")
-        manager.add_column("target_id", "bigint", 0, comment="关联的对象ID")
-        
-        manager.add_index(["user_id", "ctime"])
-        manager.add_index("target_id")
-        manager.table_info.enable_binlog = True
-
-
-def init_user_note_log():
-    """用户笔记日志, 从kv数据迁移过来
-    @since 2023/10/22
-    """
-    table_name = "user_note_log"
-    comment = "笔记用户日志"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("note_id", "bigint", 0)
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("atime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("visit_cnt", "bigint", 0)
-        manager.add_index(["user_id", "note_id"], is_unique=True)
-
-def init_user_op_log():
-    """用户操作日志, 从kv数据迁移过来
-    @since 2024/02/14
-    """
-    table_name = "user_op_log"
-    comment = "笔记操作日志"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("user_id", "bigint", 0)
-        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
-        manager.add_column("type", "varchar(64)", "")
-        manager.add_column("detail", "varchar(256)", "")
-        manager.add_column("ip", "varchar(64)", "")
-        manager.add_index(["user_id", "ctime"])
-
-def init_month_plan_index():
-    """月度计划索引
-    @since 2023/11/05
-    """
-    table_name = "month_plan_index"
-    comment = "月度计划索引"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("user_id", "bigint", default_value=0)
-        manager.add_column("month", "varchar(20)", default_value="")
-        manager.add_index("user_id")
-        manager.table_info.enable_binlog = False
-
-def init_txt_info_index():
-    """txt文件索引
-    @since 2023/11/18
-    """
-    table_name = "txt_info_index"
-    comment = "txt文件索引"
-    with create_default_table_manager(table_name, comment=comment) as manager:
-        manager.add_column("user_id", "bigint", default_value=0)
-        manager.add_column("path", "varchar(255)", default_value="")
-        manager.add_index("user_id")
-        manager.table_info.enable_binlog = False
-        
-def DBWrapper(dbpath, tablename):
-    db = MySqliteDB(db=dbpath)
-    return TableProxy(db, tablename)
-
-
-def get_file_table():
-    return get_table_by_name("file")
-
-
-def get_note_table():
-    return get_file_table()
-
-
-def get_note_history_table():
-    dbpath = xconfig.FileConfig.record_db_file
-    return DBWrapper(dbpath, "note_history")
-
-
-def get_note_content_table():
-    return DBWrapper(xconfig.DB_PATH, "note_content")
-
-
-def get_file_tag_table():
-    return DBWrapper(xconfig.DB_PATH, "file_tag")
-
-
-def get_schedule_table():
-    return DBWrapper(xconfig.DB_PATH, "schedule")
-
-
-def get_user_table():
-    return get_table_by_name("user")
-
-
-def get_message_table():
-    return get_table_by_name("message")
-
-
-def get_record_table():
-    return get_table_by_name("record")
-
-
-def get_dict_table():
-    return get_table_by_name("dictionary")
-
-
-get_dictionary_table = get_dict_table
-
-
-def get_file_info_table():
-    return get_table_by_name("file_info")
-
-
-def init_backup_table(tablename, db):
-    table_info = TableManager.get_table_info(tablename)
-    if table_info == None:
-        raise Exception("table not defined: %s" % tablename)
-
-    with TableManager(tablename, db=db, is_backup=True) as manager:
-        for args, kw in table_info.columns:
-            manager.add_column(*args, **kw)
-
-        for args, kw in table_info.indexes:
-            manager.add_index(*args, **kw)
-
-    proxy = TableProxy(db, tablename)
-    proxy.enable_binlog = False
-    return proxy
-
-
-def get_table(table_name, dbpath=None):
-    """获取数据库表，表的创建和访问不必在xtables中定义
-    @since 2019/04/11
-    """
-    return get_table_by_name(table_name)
-
-def move_sqlite_to_backup(db_name=""):
-    source_path = xconfig.FileConfig.get_db_path(db_name)
-    if not os.path.exists(source_path):
-        return
-    target_path = xconfig.FileConfig.get_backup_db_path(db_name)
-    fsutil.mvfile(source_path, target_path, rename_on_conflict=True)
-
-class DBProfileLogger(interfaces.ProfileLogger):
-
-    def __init__(self):
-        self.db = dbutil.get_table("sys_log")
-        self.db.binlog_enabled = False
-
-    def log(self, log):
-        self.db.insert(log, id_type="timeseq")
-
-
-@xutils.log_init_deco("xtables")
-def init():
-    TableManager.clear_table_dict()
-    web.db.config.debug_sql = xconfig.DatabaseConfig.db_debug
-
-    TableConfig.enable_binlog = xconfig.DatabaseConfig.binlog
-    TableConfig.enable_auto_ddl = xconfig.DatabaseConfig.db_auto_ddl
-
-    if xconfig.DatabaseConfig.db_profile_table_proxy:
-        dbutil.register_table("sys_log", "系统日志")
-        TableProxy.profile_logger = DBProfileLogger()
-        TableProxy.log_profile = True
-    
-    init_dict_table()
-    init_record_table()
-    init_user_table()
-    init_file_info()
-    
-    # 持久化任务表
-    init_job_table()
-    # 分布式锁表
-    init_lock_table()
-    
-    # 统计信息
-    init_site_visit_log()
-    init_page_visit_log()
-    
-    # 标签相关
-    init_note_tag_rel_table() # 已删除, 占位防止冲突
-    init_tag_bind_table()
-
-    # 评论相关
-    init_comment_index_table()
-
-    # 随手记
-    init_msg_index_table()
-    init_msg_history_index()
-    
-    # 笔记索引
-    init_note_index_table()
-    init_user_note_log()
-    init_user_op_log()
-    init_month_plan_index()
-    init_txt_info_index()
-
-    # 通用的分享记录
-    init_share_info_table()
-    
-    if xconfig.DatabaseConfig.db_driver_sql == "mysql":
-        init_kv_store_table()
-        init_kv_zset_table(get_db_instance())
-    
-    if xconfig.DatabaseConfig.db_driver_sql == "sqlite":
-        init_kv_store_table()
+# -*- coding:utf-8 -*-
+# Created by xupingmao on 2017/03/15
+# @modified 2021/11/07 14:14:15
+"""Xnote的数据库配置(此模块已经废弃)
+    考虑到持续运行的维护，增加表结构需要非常慎重
+    考虑清楚你需要的是数据还是配置，如果是配置建议通过扩展脚本配置xconfig
+"""
+import os
+import threading
+import xutils
+from . import xconfig
+import web.db
+from xutils import dbutil
+from xutils.dbutil import interfaces
+from xutils.sqldb import TableManagerFacade as TableManager
+from xutils.sqldb import TableProxy, TableConfig
+from xutils import fsutil
+
+
+DEFAULT_DATETIME = "1970-01-01 00:00:00"
+DEFAULT_DATE = "1970-01-01"
+
+class MySqliteDB(web.db.SqliteDB):
+    _lock = threading.RLock()
+    _instances = set()
+    dbpath = ""
+
+    def __init__(self, **keywords):
+        super().__init__(**keywords)
+        with self._lock:
+            MySqliteDB._instances.add(self)
+
+    def __del__(self):
+        with self._lock:
+            MySqliteDB._instances.remove(self)
+
+    def __hash__(self):
+        return id(self)
+
+class DBPool:
+    # TODO 池化会导致资源无法释放
+
+    sqlite_pool = {} # type: dict[str, MySqliteDB]
+    mysql_instance = None # type: web.db.MySQLDB
+
+    @classmethod
+    def get_sqlite_db(cls, dbpath=""):
+        # type: (str) -> MySqliteDB
+        assert dbpath != ""
+        db = cls.sqlite_pool.get(dbpath)
+        if db == None:
+            db = MySqliteDB(db=dbpath)
+            db.query("pragma journal_mode = %s" % xconfig.DatabaseConfig.sqlite_journal_mode)
+            if xconfig.DatabaseConfig.sqlite_page_size != 0:
+                db.query("pragma page_size = %s" % xconfig.DatabaseConfig.sqlite_page_size)
+            cls.sqlite_pool[dbpath] = db
+        return db
+
+def create_table_manager_with_dbpath(table_name="", dbpath="", **kw):
+    assert table_name != ""
+    assert dbpath != ""
+    db = get_db_instance(dbpath)
+    kw["db_type"] = xconfig.DatabaseConfig.db_driver_sql
+    return TableManager(table_name, db=db, mysql_database=xconfig.DatabaseConfig.mysql_database, **kw)
+
+def create_table_manager_with_db(table_name="", db=None, **kw):
+    assert isinstance(db, web.db.DB)
+    kw["db_type"] = xconfig.DatabaseConfig.db_driver_sql
+    return TableManager(table_name, db=db, mysql_database=xconfig.DatabaseConfig.mysql_database, **kw)
+
+def create_record_table_manager(table_name=""):
+    """默认使用 record.db 文件"""
+    return create_table_manager_with_dbpath(table_name, xconfig.FileConfig.record_db_file)
+
+def create_default_table_manager(table_name="", **kw):
+    return create_table_manager_with_dbpath(table_name, xconfig.FileConfig.record_db_file, **kw)
+
+def get_default_db_instance():
+    return get_db_instance(xconfig.FileConfig.record_db_file)
+
+def get_db_instance(dbpath=""):
+    db_driver_sql = xconfig.DatabaseConfig.db_driver_sql
+    if db_driver_sql == "mysql":
+        if DBPool.mysql_instance == None:
+            db_host = xconfig.get_system_config("mysql_host")
+            db_name = xconfig.get_system_config("mysql_database")
+            db_user = xconfig.get_system_config("mysql_user")
+            db_pw = xconfig.get_system_config("mysql_password")
+            db_port = xconfig.get_system_config("mysql_port")
+
+            if xconfig.DatabaseConfig.mysql_cloud_type == "sae":
+                db_host = os.environ["MYSQL_HOST"]
+                db_user = os.environ["MYSQL_USER"]
+                db_pw = os.environ["MYSQL_PASS"]
+                db_name = os.environ["MYSQL_DB"]
+
+            db = web.db.MySQLDB(host=db_host, database=db_name,
+                                user=db_user, pw=db_pw, port=db_port)
+            db.dbname = "mysql"
+            DBPool.mysql_instance = db
+        return DBPool.mysql_instance
+    assert dbpath != ""
+    # db = MySqliteDB(db=dbpath)
+    db = DBPool.get_sqlite_db(dbpath=dbpath)
+    db.dbpath = dbpath
+    return db
+
+def is_table_exists(table_name=""):
+    """判断表是否存在"""
+    table_info = TableManager.get_table_info(table_name)
+    return table_info != None
+
+def get_table_by_name(table_name=""):
+    # type: (str) -> TableProxy
+    """通过表名获取操作代理"""
+    table_info = TableManager.get_table_info(table_name)
+    if table_info == None:
+        raise Exception("table not found: %s" % table_name)
+    db = get_db_instance(dbpath=table_info.dbpath)
+    return TableProxy(db, table_name)
+
+
+def get_all_tables(is_deleted=False):
+    # type: (bool) -> list[TableProxy]
+    """获取所有的sql-数据库代理实例"""
+    result = []
+    table_dict = TableManager.get_table_info_dict()
+    for table_name in table_dict:
+        table_info = table_dict[table_name]
+        if is_deleted != table_info.is_deleted:
+            continue
+        proxy = get_table_by_name(table_name)
+        result.append(proxy)
+    return result
+
+
+################################################
+#  表定义
+################################################
+
+def init_test_table():
+    """测试数据库"""
+    table_name = "test"
+    with create_record_table_manager(table_name) as manager:
+        manager.add_column("int_value", "int", default_value=0)
+        manager.add_column("float_value", "float", default_value=0.0)
+        manager.add_column("text_value", "text", default_value="")
+        manager.add_column("name", "text", default_value="test")
+        manager.add_column("uuid", "varchar(32)", default_value="")
+        manager.add_index("name")
+        manager.add_index("uuid", is_unique=True)
+
+
+def init_note_index_table():
+    comment = "笔记索引"
+    with create_default_table_manager("note_index", comment=comment) as manager:
+        manager.add_column("name", "varchar(255)", "")
+        # 文本内容长度
+        manager.add_column("size", "bigint", 0)
+        # 子节点数量
+        manager.add_column("children_count", "bigint", 0)
+        # 修改版本
+        manager.add_column("version", "int", 0)
+        # 类型, markdown, post, mailist, file
+        manager.add_column("type", "varchar(32)", "")
+        # 上级目录
+        manager.add_column("parent_id", "bigint", 0)
+        # 创建时间ctime
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        # 修改时间mtime
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        # 删除时间
+        manager.add_column("dtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("is_deleted", "tinyint", 0, comment="逻辑删除标记")
+        manager.add_column("is_public", "tinyint", 0, comment="是否是公开的笔记")
+        
+        # 创建者
+        manager.add_column("creator", "varchar(64)", "")
+        manager.add_column("creator_id", "bigint", 0)
+        manager.add_column("level", "tinyint", 0)
+        manager.add_column("tag_str", "varchar(255)", "")
+        manager.add_column("visit_cnt", "bigint", 0, comment="访问次数")
+
+        # 各种索引
+        manager.add_index("parent_id")
+        manager.add_index(["creator_id", "mtime"])
+        manager.add_index(["creator_id", "type"])
+
+def init_share_info_table():
+    comment = "分享记录"
+    table_name = "share_info"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME, comment="创建时间")
+        # 分享类型 {note_public, note_to_user, note_to_group}
+        manager.add_column("share_type", "varchar(16)", "", comment="分享类型")
+        manager.add_column("target_id", "bigint", 0, comment="被分享的对象ID")
+        manager.add_column("from_id", "bigint", 0, comment="分享人ID")
+        manager.add_column("to_id", "bigint", 0, comment="接收人ID")
+        manager.add_column("visit_cnt", "bigint", 0, comment="访问次数")
+
+        # 索引
+        manager.add_index(["share_type", "ctime"])
+        manager.add_index(["share_type", "visit_cnt"])
+        manager.add_index("target_id")
+        manager.add_index("from_id")
+        manager.add_index("to_id")
+
+def init_user_table():
+    # 2017/05/21
+    # 简单的用户表
+    comment = "用户信息"
+    with create_default_table_manager("user", comment=comment) as manager:
+        manager.add_column("name", "varchar(64)", "")
+        manager.add_column("password", "varchar(64)", "") # 始终为空
+        manager.add_column("password_md5", "varchar(64)", "")
+        manager.add_column("mobile", "varchar(32)", "")
+        manager.add_column("salt", "varchar(64)", "")
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("token", "varchar(32)", "")
+        manager.add_column("login_time", "datetime", DEFAULT_DATETIME)
+        manager.add_column("status", "tinyint", 0)
+        manager.add_index("name", is_unique=True)
+        manager.add_index("token")
+        # 删除的字段
+        manager.drop_column("privileges", "text", "")
+        manager.table_info.enable_binlog = True
+
+
+def init_user_op_log_table():
+    # 2023/07/15 用户操作日志，从kv迁移到sql
+    with create_default_table_manager("user_op_log") as manager:
+        manager.add_column("user_name", "varchar(64)", "")
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("ip", "varchar(32)", "")
+        manager.add_column("type", "varchar(32)", "")
+        manager.add_column("detail", "text", "")
+
+
+def init_message_table():
+    """
+    用来存储比较短的消息,消息和资料库的主要区别是消息存储较短的单一信息
+    - 消息支持状态
+    - 2017/05/29
+    """
+    table_name = "message"
+    with create_table_manager_with_dbpath(table_name) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user",  "varchar(64)", "")
+        # 用一个状态可以拍成一排
+        # 消息的状态 0关注 50挂起 100已完成
+        manager.add_column("status", "int", 0)
+        manager.add_column("content", "text", "")
+        # IP地址
+        manager.add_column("ip", "varchar(32)", "")
+        # 地址信息
+        manager.add_column("location", "varchar(255)", "")
+        # 索引
+        manager.add_index(["user", "ctime", "status"])
+        manager.add_index(["user", "status"])
+
+
+def init_record_table():
+    # 日志记录
+    dbpath = xconfig.FileConfig.record_db_file
+    comment = "通用日志记录"
+    with create_table_manager_with_dbpath("record", dbpath=dbpath, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        # 添加单独的日期，方便统计用，尽量减少SQL函数的使用
+        manager.add_column("cdate", "date", "1970-01-01")
+        manager.add_column("type",  "varchar(64)", "")
+        # 自己把所有条件都组装到key里
+        manager.add_column("key",  "varchar(100)", "")
+        manager.add_column("value", "text", "")
+        # 索引
+        manager.add_index(["type", "ctime"])
+
+
+def init_dict_table():
+    """词典，和主库隔离
+    @since 2018/01/14
+    """
+    comment = "词典"
+    with create_default_table_manager("dictionary", comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("key", "varchar(100)", "")
+        manager.add_column("value", "text", "")
+        manager.add_index("key")
+
+
+def init_note_tag_rel_table():
+    """笔记标签绑定关系
+    @since 2023/07/01
+    """
+    table_name = "note_tag_rel"
+    comment = "笔记标签绑定关系(废弃)"
+    with create_default_table_manager(table_name, is_deleted=True, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("note_id", "varchar(32)", "")
+        manager.add_column("tag_code", "varchar(32)", "")
+        manager.add_index(["user_id", "tag_code"])
+
+def init_tag_info_table():
+    """标签信息
+    @since 2023/09/09
+    """
+    table_name = "tag_info"
+    with create_default_table_manager(table_name) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("tag_type", "tinyint", 0)
+        manager.add_column("tag_code",  "varchar(32)", "")
+        manager.add_column("tag_size", "bigint", 0)
+        manager.add_index(["user_id", "tag_code"])
+
+
+def init_tag_bind_table():
+    """标签绑定关系
+    @since 2023/09/09
+    """
+    table_name = "tag_bind"
+    comment = "标签绑定关系"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("tag_type", "tinyint", 0)
+        manager.add_column("tag_code",  "varchar(32)", "")
+        manager.add_column("target_id", "bigint", 0)
+        manager.add_index(["user_id", "tag_code"])
+        manager.add_index(["user_id", "target_id"])
+
+def init_file_info():
+    """文件信息
+    @since 2023/05/26
+    """
+    table_name = "file_info"
+    comment = "文件索引信息"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("fpath", "text", "")
+        manager.add_column("ftype", "varchar(16)", "")
+        manager.add_column("fsize", "bigint", 0)
+        manager.add_column("user_id", "bigint", 0)
+
+        manager.add_index("user_id")
+        manager.add_index("fpath", key_len=100)
+        manager.add_index(["ftype", "fpath"], key_len_list=[0, 100])
+
+
+def init_site_visit_log():
+    """站点访问日志
+    @since 2023/05/28
+    """
+    table_name = "site_visit_log"
+    comment = "站点访问统计"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("date", "date", "1970-01-01")
+        manager.add_column("site", "varchar(64)", "")
+        manager.add_column("ip", "varchar(64)", "")
+        manager.add_column("count", "bigint", 0)
+        manager.add_index(["date", "ip"])
+    
+    # 日志数据, 关闭profile
+    TableConfig.disable_profile(table_name)
+    TableConfig.disable_binlog(table_name)
+
+def init_page_visit_log():
+    """页面访问日志
+    @since 2024/02/14
+    """
+    table_name = "page_visit_log"
+    comment = "页面访问统计"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("visit_time", "datetime", DEFAULT_DATETIME)
+        manager.add_column("visit_cnt", "bigint", 0)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("url", "varchar(256)", "")
+        manager.add_column("args", "text", "")
+        manager.add_index(["user_id", "url"])
+    
+    # 日志数据, 关闭profile
+    TableConfig.disable_profile(table_name)
+    TableConfig.disable_binlog(table_name)
+
+def init_job_table():
+    """系统任务
+    @since 2024/03/10
+    """
+    table_name = "t_job" # 避免关键字冲突
+    comment = "系统任务"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("job_type", "varchar(30)", "")
+        manager.add_column("job_status", "tinyint", 0, comment="日志状态,0-初始化,1-执行中,2-执行成功,3-执行失败")
+        manager.add_column("job_params", "text", "")
+        manager.add_column("job_result", "text", "")
+        manager.add_index(["job_type", "mtime"])
+
+def init_lock_table():
+    """分布式锁的表
+    @since 2024/04/03
+    """
+    table_name = "t_lock" # 避免和关键字冲突
+    comment = "系统任务"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("ctime", "datetime", default_value=DEFAULT_DATETIME)
+        manager.add_column("mtime", "datetime", default_value=DEFAULT_DATETIME)
+        manager.add_column("lock_key", "varchar(128)", default_value="")
+        manager.add_column("lock_token", "varchar(36)", default_value="", comment="锁的token")
+        manager.add_column("timeout_time", "bigint", default_value=0, comment="锁超时时间,毫秒时间戳")
+        manager.add_index("lock_key", is_unique=True)
+
+def init_msg_index_table():
+    """随手记索引"""
+    table_name = "msg_index"
+    comment = "随手记索引"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        # 展示创建时间
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        # 实际创建时间
+        manager.add_column("ctime_sys", "datetime", DEFAULT_DATETIME)
+        # 修改时间
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("user_name", "varchar(64)", "")
+        # 短信息的类型
+        manager.add_column("tag", "varchar(16)", "")
+        manager.add_column("date", "date", default_value=DEFAULT_DATE)
+        manager.add_column("sort_value", "varchar(64)", default_value="", comment="排序字段")
+
+        manager.add_index(["user_id", "ctime"])
+        manager.add_index(["user_id", "mtime"])
+        manager.add_index(["user_id", "sort_value"])
+        manager.add_index(["user_id", "tag", "sort_value"])
+
+def init_msg_history_index():
+    """随手记历史索引"""
+    table_name = "msg_history_index"
+    comment = "随手记历史索引"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        # 展示创建时间
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("msg_id", "bigint", 0)
+        manager.add_column("msg_version", "bigint", 0)
+        manager.add_index(["msg_id"])
+
+def init_kv_store_table():
+    kw = dict()
+    kw["pk_name"] = "key"
+    kw["pk_len"] = 100
+    kw["pk_type"] = "blob"
+    kw["debug"] = xconfig.DatabaseConfig.db_debug
+    kw["comment"] = "kv存储"
+    dbpath = xconfig.FileConfig.kv_db_file
+    with create_table_manager_with_dbpath("kv_store", dbpath=dbpath, **kw) as manager:
+        manager.add_column("value", "longblob", default_value="")
+        manager.add_column("version", "int", default_value=0)
+
+def init_kv_zset_table(db=None):
+    """使用关系型数据库模拟redis的zset结构"""
+    comment = "模拟redis的zset"
+    with create_table_manager_with_db("kv_zset", db=db, comment=comment) as manager:
+        manager.add_column("key", "varchar(512)", "")
+        manager.add_column("member", "varchar(512)", "")
+        manager.add_column("score", "bigint", default_value=0)
+        manager.add_column("version", "int", default_value=0)
+        manager.add_index(["key", "member"], is_unique=True, key_len_list=[32,100])
+        manager.add_index(["key", "score"], key_len_list=[32, 0])
+
+def init_comment_index_table():
+    """评论索引"""
+    table_name = "comment_index"
+    comment = "评论索引"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        # 展示创建时间
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        # 修改时间
+        manager.add_column("mtime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("type", "varchar(16)", 0)
+        manager.add_column("user_id", "bigint", 0, comment="用户ID")
+        manager.add_column("target_id", "bigint", 0, comment="关联的对象ID")
+        
+        manager.add_index(["user_id", "ctime"])
+        manager.add_index("target_id")
+        manager.table_info.enable_binlog = True
+
+
+def init_user_note_log():
+    """用户笔记日志, 从kv数据迁移过来
+    @since 2023/10/22
+    """
+    table_name = "user_note_log"
+    comment = "笔记用户日志"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("note_id", "bigint", 0)
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("atime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("visit_cnt", "bigint", 0)
+        manager.add_index(["user_id", "note_id"], is_unique=True)
+
+def init_user_op_log():
+    """用户操作日志, 从kv数据迁移过来
+    @since 2024/02/14
+    """
+    table_name = "user_op_log"
+    comment = "笔记操作日志"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("user_id", "bigint", 0)
+        manager.add_column("ctime", "datetime", DEFAULT_DATETIME)
+        manager.add_column("type", "varchar(64)", "")
+        manager.add_column("detail", "varchar(256)", "")
+        manager.add_column("ip", "varchar(64)", "")
+        manager.add_index(["user_id", "ctime"])
+
+def init_month_plan_index():
+    """月度计划索引
+    @since 2023/11/05
+    """
+    table_name = "month_plan_index"
+    comment = "月度计划索引"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("user_id", "bigint", default_value=0)
+        manager.add_column("month", "varchar(20)", default_value="")
+        manager.add_index("user_id")
+        manager.table_info.enable_binlog = False
+
+def init_txt_info_index():
+    """txt文件索引
+    @since 2023/11/18
+    """
+    table_name = "txt_info_index"
+    comment = "txt文件索引"
+    with create_default_table_manager(table_name, comment=comment) as manager:
+        manager.add_column("user_id", "bigint", default_value=0)
+        manager.add_column("path", "varchar(255)", default_value="")
+        manager.add_index("user_id")
+        manager.table_info.enable_binlog = False
+        
+def DBWrapper(dbpath, tablename):
+    db = MySqliteDB(db=dbpath)
+    return TableProxy(db, tablename)
+
+
+def get_file_table():
+    return get_table_by_name("file")
+
+
+def get_note_table():
+    return get_file_table()
+
+
+def get_note_history_table():
+    dbpath = xconfig.FileConfig.record_db_file
+    return DBWrapper(dbpath, "note_history")
+
+
+def get_note_content_table():
+    return DBWrapper(xconfig.DB_PATH, "note_content")
+
+
+def get_file_tag_table():
+    return DBWrapper(xconfig.DB_PATH, "file_tag")
+
+
+def get_schedule_table():
+    return DBWrapper(xconfig.DB_PATH, "schedule")
+
+
+def get_user_table():
+    return get_table_by_name("user")
+
+
+def get_message_table():
+    return get_table_by_name("message")
+
+
+def get_record_table():
+    return get_table_by_name("record")
+
+
+def get_dict_table():
+    return get_table_by_name("dictionary")
+
+
+get_dictionary_table = get_dict_table
+
+
+def get_file_info_table():
+    return get_table_by_name("file_info")
+
+
+def init_backup_table(tablename, db):
+    table_info = TableManager.get_table_info(tablename)
+    if table_info == None:
+        raise Exception("table not defined: %s" % tablename)
+
+    with TableManager(tablename, db=db, is_backup=True) as manager:
+        for args, kw in table_info.columns:
+            manager.add_column(*args, **kw)
+
+        for args, kw in table_info.indexes:
+            manager.add_index(*args, **kw)
+
+    proxy = TableProxy(db, tablename)
+    proxy.enable_binlog = False
+    return proxy
+
+
+def get_table(table_name, dbpath=None):
+    """获取数据库表，表的创建和访问不必在xtables中定义
+    @since 2019/04/11
+    """
+    return get_table_by_name(table_name)
+
+def move_sqlite_to_backup(db_name=""):
+    source_path = xconfig.FileConfig.get_db_path(db_name)
+    if not os.path.exists(source_path):
+        return
+    target_path = xconfig.FileConfig.get_backup_db_path(db_name)
+    fsutil.mvfile(source_path, target_path, rename_on_conflict=True)
+
+class DBProfileLogger(interfaces.ProfileLogger):
+
+    def __init__(self):
+        self.db = dbutil.get_table("sys_log")
+        self.db.binlog_enabled = False
+
+    def log(self, log):
+        self.db.insert(log, id_type="timeseq")
+
+
+@xutils.log_init_deco("xtables")
+def init():
+    TableManager.clear_table_dict()
+    web.db.config.debug_sql = xconfig.DatabaseConfig.db_debug
+
+    TableConfig.enable_binlog = xconfig.DatabaseConfig.binlog
+    TableConfig.enable_auto_ddl = xconfig.DatabaseConfig.db_auto_ddl
+
+    if xconfig.DatabaseConfig.db_profile_table_proxy:
+        dbutil.register_table("sys_log", "系统日志")
+        TableProxy.profile_logger = DBProfileLogger()
+        TableProxy.log_profile = True
+    
+    init_dict_table()
+    init_record_table()
+    init_user_table()
+    init_file_info()
+    
+    # 持久化任务表
+    init_job_table()
+    # 分布式锁表
+    init_lock_table()
+    
+    # 统计信息
+    init_site_visit_log()
+    init_page_visit_log()
+    
+    # 标签相关
+    init_note_tag_rel_table() # 已删除, 占位防止冲突
+    init_tag_bind_table()
+
+    # 评论相关
+    init_comment_index_table()
+
+    # 随手记
+    init_msg_index_table()
+    init_msg_history_index()
+    
+    # 笔记索引
+    init_note_index_table()
+    init_user_note_log()
+    init_user_op_log()
+    init_month_plan_index()
+    init_txt_info_index()
+
+    # 通用的分享记录
+    init_share_info_table()
+    
+    if xconfig.DatabaseConfig.db_driver_sql == "mysql":
+        init_kv_store_table()
+        init_kv_zset_table(get_db_instance())
+    
+    if xconfig.DatabaseConfig.db_driver_sql == "sqlite":
+        init_kv_store_table()
```

### Comparing `xnote-web-0.1.0/xnote/core/xtables_kv.py` & `xnote-web-0.1.1/xnote/core/xtables_kv.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,179 +1,179 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2021/12/27 23:34:03
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-07 23:44:05
-@FilePath     : /xnote/xnote/core/xtables_kv.py
-@Description  : 数据库-KV表定义
-
-TODO 支持使用sql维护索引 index_type = sql
-"""
-
-import xutils
-from xutils import dbutil
-from . import xtables
-
-@xutils.log_init_deco("xtables_kv")
-def init():
-    # 使用NoSQL风格的数据库接口
-    # NoSQL适合的场景：大文档、配置、缓存、计数器、时序日志
-    # 尽量不要使用索引的功能，数据库索引保证最终一致，不保证强一致
-    # 变更索引后需要调用 rebuild_index 方法
-    init_system_table()
-    init_note_tables()
-    init_message_tables()
-    # 初始化一些废弃的表，防止覆盖老版本数据
-    init_deleted_table()
-    
-    # 网络文件映射到本地文件
-    dbutil.register_table("fs_map", "文件映射")
-    dbutil.register_table("fs_ctype", "缓存的Content-Type")
-    
-    txt_info_index = xtables.get_table_by_name("txt_info_index")
-    dbutil.register_table("txt_info", "txt文件信息", index_db=txt_info_index)
-    
-    dbutil.register_table("fs_sync_index", "文件同步索引信息")
-    
-    dbutil.register_table("user_config", "用户配置表")
-    db = dbutil.register_table("session", "用户会话信息")
-    db.register_index("user", columns=["user_name"])
-    dbutil.register_table("sys_config", "系统配置表")
-    
-    dbutil.register_table("user_stat", "用户数据统计")
-
-    # 月度计划
-    month_plan_index = xtables.get_table_by_name("month_plan_index")
-    db = dbutil.register_table("month_plan", "月度计划", index_db=month_plan_index)
-    dbutil.get_table_v2("month_plan").rebuild_index("v2", ignore_error=True)
-
-def init_system_table():
-    dbutil.register_table("sys_log", "系统日志")
-    dbutil.register_table("dict", "词典")
-    dbutil.register_table("migrate_failed", "迁移失败记录")
-    db = dbutil.register_table("z", "老版本的zset实现")
-    db.delete_table()
-
-def init_deleted_table():
-    # 统计数据
-    db = dbutil.register_table("plugin_visit_log", "插件访问日志", user_attr="user", check_user = True)
-    db.drop_index("url", comment = "页面URL")
-    db.rebuild_index("v2")
-    db.delete_table()
-
-    db = dbutil.register_table("user_session_rel", "用户会话关系")
-    db.delete_table()
-
-    db = dbutil.register_table("note_skey", "用户维度的skey索引 <note_skey:user:skey>")
-    db.delete_table()
-
-    db = dbutil.register_table("msg_task_idx", "待办索引")
-    db.delete_table()
-
-    # 用户信息，迁移到了sql-db
-    db = dbutil.register_table("user", "用户信息表")
-    db.delete_table()
-
-    # uv统计
-    db = dbutil.register_table("uv", "uv访问统计")
-    db.drop_index("date_ip", columns = ["date", "ip"])
-    db.rebuild_index("v1")
-    db.delete_table()
-
-    # 文件相关，废弃，新的使用sql-db
-    db = dbutil.register_table("fs_index", "文件索引")
-    db.drop_index("ftype", comment = "类型索引")
-    db.delete_table()
-    
-    # 插件访问日志,新的SQL表参考 page_visit_log
-    db = dbutil.register_table("plugin_visit", "插件访问日志")
-    db.drop_index("k_url", columns=["user", "url"])
-    db.rebuild_index("v2")
-    db.delete_table()
-    
-    # 操作日志
-    db = dbutil.register_table("user_op_log", "用户操作日志表", user_attr="user_name")
-    db.delete_table()
-    
-def init_note_tables():
-    # 笔记信息
-    dbutil.register_table("note_tags", "笔记标签绑定",
-                          category="note", user_attr="user")
-    dbutil.register_table("note_tag_meta", "笔记标签",
-                          category="note", user_attr="user")
-    dbutil.register_table("note_draft", "笔记草稿", category="note", type="hash")
-    dbutil.register_table("note_lock", "笔记编辑锁", category="note")
-    dbutil.register_table("note_full", "笔记的完整信息", category="note")
-
-    # ID维度笔记索引
-    db = dbutil.register_table(
-        "note_index", "笔记索引，不包含内容", category="note")
-    db.drop_index("parent_id", comment = "父级笔记ID")
-    db.drop_index("name", columns=["creator", "name"])
-    db.drop_index("ctime", columns=["creator", "ctime"])
-    db.drop_index("skey", columns=["creator", "skey"])
-    db.rebuild_index("v5")
-    db.delete_table()
-
-    # 用户维度笔记索引
-    db = dbutil.register_table("note_tiny", "用户维度的笔记索引",
-                               category="note", check_user=True, user_attr="creator")
-    db.drop_index("name")
-    db.drop_index("ctime")
-    db.drop_index("parent_id")
-    db.rebuild_index("v3")
-    db.delete_table()
-
-    # 笔记修改历史
-    dbutil.register_table("note_history_index", "笔记历史索引", category="note")
-    dbutil.register_table("note_history", "笔记的历史版本", category="note")
-    
-    db = dbutil.register_table("search_history", "搜索历史", user_attr="user", check_user=True)
-    db.drop_index("user", comment = "使用二级key的表,不需要user索引")
-
-    # 分享关系
-    db = dbutil.register_table("note_share", "笔记分享", category="note")
-    db.drop_index("note_id", comment = "笔记ID")
-    db.drop_index("to_user", comment = "分享的目标用户")
-    db.rebuild_index("v1")
-    db.delete_table()
-
-
-    db = dbutil.register_table("comment", "评论模型", category="note")
-    db.drop_index("user", comment = "用户索引")
-    db.drop_index("note_id", comment = "笔记ID索引")
-
-    # 公共笔记
-    db = dbutil.register_table("note_public", "公共笔记", category="note")
-    db.drop_index("hot_index")
-    db.drop_index("share_time")
-    db.rebuild_index("v1")
-    db.delete_table()
-
-    # 操作日志
-    db = dbutil.register_table("user_note_log", "用户笔记操作日志", check_user=True, user_attr="user")
-    db.drop_index("visit_cnt")
-    db.drop_index("atime")
-    db.drop_index("mtime")
-    db.drop_index("ctime")
-    db.rebuild_index("v1")
-    db.delete_table()
-
-    # 笔记类目（已删除）
-    db = dbutil.register_table("note_category", "笔记类目", category="note", 
-                               check_user=True, user_attr="user_name")
-    db.delete_table()
-
-def init_message_tables():
-    dbutil.register_table("message", "短文本", check_user=True, user_attr="user")
-    dbutil.register_table("msg_key", "备忘关键字/标签", check_user=True, user_attr="user")
-    
-    db = dbutil.register_table("msg_backup", "随手记备份", check_user=True, user_attr="user")
-    db.delete_table()
-
-    dbutil.register_table("msg_search_history", "备忘搜索历史", check_user=True, user_attr="user")
-    
-    msg_history_index = xtables.get_table_by_name("msg_history_index")
-    dbutil.register_table("msg_history", "备忘历史", index_db=msg_history_index)
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2021/12/27 23:34:03
+@LastEditors  : xupingmao
+@LastEditTime : 2024-03-07 23:44:05
+@FilePath     : /xnote/xnote/core/xtables_kv.py
+@Description  : 数据库-KV表定义
+
+TODO 支持使用sql维护索引 index_type = sql
+"""
+
+import xutils
+from xutils import dbutil
+from . import xtables
+
+@xutils.log_init_deco("xtables_kv")
+def init():
+    # 使用NoSQL风格的数据库接口
+    # NoSQL适合的场景：大文档、配置、缓存、计数器、时序日志
+    # 尽量不要使用索引的功能，数据库索引保证最终一致，不保证强一致
+    # 变更索引后需要调用 rebuild_index 方法
+    init_system_table()
+    init_note_tables()
+    init_message_tables()
+    # 初始化一些废弃的表，防止覆盖老版本数据
+    init_deleted_table()
+    
+    # 网络文件映射到本地文件
+    dbutil.register_table("fs_map", "文件映射")
+    dbutil.register_table("fs_ctype", "缓存的Content-Type")
+    
+    txt_info_index = xtables.get_table_by_name("txt_info_index")
+    dbutil.register_table("txt_info", "txt文件信息", index_db=txt_info_index)
+    
+    dbutil.register_table("fs_sync_index", "文件同步索引信息")
+    
+    dbutil.register_table("user_config", "用户配置表")
+    db = dbutil.register_table("session", "用户会话信息")
+    db.register_index("user", columns=["user_name"])
+    dbutil.register_table("sys_config", "系统配置表")
+    
+    dbutil.register_table("user_stat", "用户数据统计")
+
+    # 月度计划
+    month_plan_index = xtables.get_table_by_name("month_plan_index")
+    db = dbutil.register_table("month_plan", "月度计划", index_db=month_plan_index)
+    dbutil.get_table_v2("month_plan").rebuild_index("v2", ignore_error=True)
+
+def init_system_table():
+    dbutil.register_table("sys_log", "系统日志")
+    dbutil.register_table("dict", "词典")
+    dbutil.register_table("migrate_failed", "迁移失败记录")
+    db = dbutil.register_table("z", "老版本的zset实现")
+    db.delete_table()
+
+def init_deleted_table():
+    # 统计数据
+    db = dbutil.register_table("plugin_visit_log", "插件访问日志", user_attr="user", check_user = True)
+    db.drop_index("url", comment = "页面URL")
+    db.rebuild_index("v2")
+    db.delete_table()
+
+    db = dbutil.register_table("user_session_rel", "用户会话关系")
+    db.delete_table()
+
+    db = dbutil.register_table("note_skey", "用户维度的skey索引 <note_skey:user:skey>")
+    db.delete_table()
+
+    db = dbutil.register_table("msg_task_idx", "待办索引")
+    db.delete_table()
+
+    # 用户信息，迁移到了sql-db
+    db = dbutil.register_table("user", "用户信息表")
+    db.delete_table()
+
+    # uv统计
+    db = dbutil.register_table("uv", "uv访问统计")
+    db.drop_index("date_ip", columns = ["date", "ip"])
+    db.rebuild_index("v1")
+    db.delete_table()
+
+    # 文件相关，废弃，新的使用sql-db
+    db = dbutil.register_table("fs_index", "文件索引")
+    db.drop_index("ftype", comment = "类型索引")
+    db.delete_table()
+    
+    # 插件访问日志,新的SQL表参考 page_visit_log
+    db = dbutil.register_table("plugin_visit", "插件访问日志")
+    db.drop_index("k_url", columns=["user", "url"])
+    db.rebuild_index("v2")
+    db.delete_table()
+    
+    # 操作日志
+    db = dbutil.register_table("user_op_log", "用户操作日志表", user_attr="user_name")
+    db.delete_table()
+    
+def init_note_tables():
+    # 笔记信息
+    dbutil.register_table("note_tags", "笔记标签绑定",
+                          category="note", user_attr="user")
+    dbutil.register_table("note_tag_meta", "笔记标签",
+                          category="note", user_attr="user")
+    dbutil.register_table("note_draft", "笔记草稿", category="note", type="hash")
+    dbutil.register_table("note_lock", "笔记编辑锁", category="note")
+    dbutil.register_table("note_full", "笔记的完整信息", category="note")
+
+    # ID维度笔记索引
+    db = dbutil.register_table(
+        "note_index", "笔记索引，不包含内容", category="note")
+    db.drop_index("parent_id", comment = "父级笔记ID")
+    db.drop_index("name", columns=["creator", "name"])
+    db.drop_index("ctime", columns=["creator", "ctime"])
+    db.drop_index("skey", columns=["creator", "skey"])
+    db.rebuild_index("v5")
+    db.delete_table()
+
+    # 用户维度笔记索引
+    db = dbutil.register_table("note_tiny", "用户维度的笔记索引",
+                               category="note", check_user=True, user_attr="creator")
+    db.drop_index("name")
+    db.drop_index("ctime")
+    db.drop_index("parent_id")
+    db.rebuild_index("v3")
+    db.delete_table()
+
+    # 笔记修改历史
+    dbutil.register_table("note_history_index", "笔记历史索引", category="note")
+    dbutil.register_table("note_history", "笔记的历史版本", category="note")
+    
+    db = dbutil.register_table("search_history", "搜索历史", user_attr="user", check_user=True)
+    db.drop_index("user", comment = "使用二级key的表,不需要user索引")
+
+    # 分享关系
+    db = dbutil.register_table("note_share", "笔记分享", category="note")
+    db.drop_index("note_id", comment = "笔记ID")
+    db.drop_index("to_user", comment = "分享的目标用户")
+    db.rebuild_index("v1")
+    db.delete_table()
+
+
+    db = dbutil.register_table("comment", "评论模型", category="note")
+    db.drop_index("user", comment = "用户索引")
+    db.drop_index("note_id", comment = "笔记ID索引")
+
+    # 公共笔记
+    db = dbutil.register_table("note_public", "公共笔记", category="note")
+    db.drop_index("hot_index")
+    db.drop_index("share_time")
+    db.rebuild_index("v1")
+    db.delete_table()
+
+    # 操作日志
+    db = dbutil.register_table("user_note_log", "用户笔记操作日志", check_user=True, user_attr="user")
+    db.drop_index("visit_cnt")
+    db.drop_index("atime")
+    db.drop_index("mtime")
+    db.drop_index("ctime")
+    db.rebuild_index("v1")
+    db.delete_table()
+
+    # 笔记类目（已删除）
+    db = dbutil.register_table("note_category", "笔记类目", category="note", 
+                               check_user=True, user_attr="user_name")
+    db.delete_table()
+
+def init_message_tables():
+    dbutil.register_table("message", "短文本", check_user=True, user_attr="user")
+    dbutil.register_table("msg_key", "备忘关键字/标签", check_user=True, user_attr="user")
+    
+    db = dbutil.register_table("msg_backup", "随手记备份", check_user=True, user_attr="user")
+    db.delete_table()
+
+    dbutil.register_table("msg_search_history", "备忘搜索历史", check_user=True, user_attr="user")
+    
+    msg_history_index = xtables.get_table_by_name("msg_history_index")
+    dbutil.register_table("msg_history", "备忘历史", index_db=msg_history_index)
+
```

### Comparing `xnote-web-0.1.0/xnote/plugin/form.py` & `xnote-web-0.1.1/xnote/plugin/form.py`

 * *Ordering differences only*

 * *Files 19% similar despite different names*

```diff
@@ -1,92 +1,92 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-03-10 16:20:05
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-31 14:17:08
-@FilePath     : /xnote/xnote/plugin/form.py
-@Description  : 描述
-"""
-
-class FormRowType:
-    """表单行的类型"""
-    input = "input"
-    select = "select"
-    textarea = "textarea"
-    date = "date"
-
-class FormRowOption:
-    """表单行的选项"""
-    def __init__(self):
-        self.title = ""
-        self.value = ""
-
-class FormRowDateType:
-    """日期的类型"""
-    year = "year"
-    month = "month"
-    date = "date"
-    time = "time"
-    datetime = "datetime"
-    default = date
-
-class FormRow:
-    """数据行"""
-    def __init__(self):
-        self.id = ""
-        self.title = ""
-        self.field = ""
-        self.placeholder = ""
-        self.value = ""
-        self.type = FormRowType.input
-        self.css_class = ""
-        self.options = []
-        self.date_type = FormRowDateType.date # 用于日期组件
-        self.readonly = False
-    
-    def add_option(self, title="", value=""):
-        option = FormRowOption()
-        option.title = title
-        option.value = value
-        self.options.append(option)
-        return self
-
-    def get_readonly_attr(self):
-        if self.readonly:
-            return "readonly"
-        else:
-            return ""
-    
-class DataForm:
-    """数据表格"""
-    
-    def __init__(self):
-        self.id = "0"
-        self.row_id = 0
-        self.rows = []
-        self.save_action = "save"
-        self.model_name = "default"
-    
-    def add_row(self, title="", field="", placeholder="", value="", type="input", css_class="", readonly=False):
-        self.row_id += 1
-        row = FormRow()
-        row.id = f"row_{self.id}_{self.row_id}"
-        row.title = title
-        row.field = field
-        row.placeholder = placeholder
-        row.value = value
-        row.type = type
-        row.css_class = css_class
-        row.readonly = readonly
-        
-        self.rows.append(row)
-        return row
-
-    def count_type(self, type=""):
-        count = 0
-        for item in self.rows:
-            if item.type == type:
-                count+=1
-        return count
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-03-10 16:20:05
+@LastEditors  : xupingmao
+@LastEditTime : 2024-03-31 14:17:08
+@FilePath     : /xnote/xnote/plugin/form.py
+@Description  : 描述
+"""
+
+class FormRowType:
+    """表单行的类型"""
+    input = "input"
+    select = "select"
+    textarea = "textarea"
+    date = "date"
+
+class FormRowOption:
+    """表单行的选项"""
+    def __init__(self):
+        self.title = ""
+        self.value = ""
+
+class FormRowDateType:
+    """日期的类型"""
+    year = "year"
+    month = "month"
+    date = "date"
+    time = "time"
+    datetime = "datetime"
+    default = date
+
+class FormRow:
+    """数据行"""
+    def __init__(self):
+        self.id = ""
+        self.title = ""
+        self.field = ""
+        self.placeholder = ""
+        self.value = ""
+        self.type = FormRowType.input
+        self.css_class = ""
+        self.options = []
+        self.date_type = FormRowDateType.date # 用于日期组件
+        self.readonly = False
+    
+    def add_option(self, title="", value=""):
+        option = FormRowOption()
+        option.title = title
+        option.value = value
+        self.options.append(option)
+        return self
+
+    def get_readonly_attr(self):
+        if self.readonly:
+            return "readonly"
+        else:
+            return ""
+    
+class DataForm:
+    """数据表格"""
+    
+    def __init__(self):
+        self.id = "0"
+        self.row_id = 0
+        self.rows = []
+        self.save_action = "save"
+        self.model_name = "default"
+    
+    def add_row(self, title="", field="", placeholder="", value="", type="input", css_class="", readonly=False):
+        self.row_id += 1
+        row = FormRow()
+        row.id = f"row_{self.id}_{self.row_id}"
+        row.title = title
+        row.field = field
+        row.placeholder = placeholder
+        row.value = value
+        row.type = type
+        row.css_class = css_class
+        row.readonly = readonly
+        
+        self.rows.append(row)
+        return row
+
+    def count_type(self, type=""):
+        count = 0
+        for item in self.rows:
+            if item.type == type:
+                count+=1
+        return count
+
```

### Comparing `xnote-web-0.1.0/xnote/plugin/plugin.py` & `xnote-web-0.1.1/xnote/plugin/plugin.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,221 +1,221 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-10-29 15:43:50
-@LastEditors  : xupingmao
-@LastEditTime : 2023-10-29 16:32:24
-@FilePath     : /xnote/xnote/plugin/plugin.py
-@Description  : 插件管理
-"""
-
-import os
-import xutils
-import enum
-
-from xnote.core import xconfig
-from xutils import mem_util, fsutil, Storage, attrget, ScriptMeta
-
-DEFAULT_PLUGIN_ICON_CLASS = "fa fa-cube"
-
-
-class PluginMetaKey(enum.Enum):
-    api_level = "api-level"
-    category = "category"
-    id = "id"
-    author = "author"
-
-
-class PluginContext(Storage):
-    """插件上下文"""
-
-    def __init__(self):
-        self.meta = ScriptMeta()
-        self.title = "" # 展示的名称
-        self.description = ""
-        
-        self.name = "" # 文件名称
-        self.plugin_id = "" # 唯一识别符号
-        self.plugin_name = "" # 相对plugin目录的名称
-        self.fname = ""
-        self.fpath = ""
-        
-        self.url = ""  # 这个应该算是基础url，用于匹配访问日志
-        self.url_query = ""  # 查询参数部分
-        self.category = None
-        self.category_list = []
-        
-        self.require_admin = True
-        self.required_role = "" # type: None|str
-        self.permitted_role_list = []  # 允许访问的权限列表
-        self.atime = ""
-        self.editable = True
-        self.edit_link = ""
-        self.clazz = None
-        self.priority = 0
-        self.icon = DEFAULT_PLUGIN_ICON_CLASS
-        self.author = None
-        self.version = None
-        self.debug = False
-    
-    @property
-    def link(self):
-        return self.url
-    
-    @link.setter
-    def set_link(self, link=""):
-        self.url = link
-
-    # sort方法重写__lt__即可
-    def __lt__(self, other):
-        return self.title < other.title
-
-    # 兼容Python2
-    def __cmp__(self, other):
-        return cmp(self.title, other.title)
-
-    def load_category_info(self, meta_obj):
-        self.category = meta_obj.get_str_value("category")  # 这里取第一个分类
-        self.category_list = meta_obj.get_list_value("category")  # 获取分类列表
-        self.build_category()
-
-    def load_permission_info(self, meta_obj):
-        self.require_admin = meta_obj.get_bool_value(
-            "require-admin", True)  # 访问是否要求管理员权限
-        self.permitted_role_list = meta_obj.get_list_value(
-            "permitted-role")  # 允许访问的角色
-
-    def load_from_meta(self, meta_obj):
-        self.api_level = meta_obj.get_float_value("api-level", 0.0)
-
-        if self.api_level >= 2.8:
-            self.title = meta_obj.get_str_value("title")
-            self.description = meta_obj.get_str_value("description")
-            self.author = meta_obj.get_str_value("author")
-            self.version = meta_obj.get_str_value("version")
-            self.icon = meta_obj.get_str_value("icon-class")
-            self.since = meta_obj.get_str_value("since")
-            self.debug = meta_obj.get_bool_value("debug")
-
-            self.load_category_info(meta_obj)
-            self.load_permission_info(meta_obj)
-
-    def build_category(self):
-        if self.category is None and len(self.category_list) > 0:
-            self.category = self.category_list[0]
-
-        if self.category != None and self.category not in self.category_list:
-            self.category_list.append(self.category)
-
-        if self.category is None and len(self.category_list) == 0:
-            self.category = "other"
-            self.category_list.append(self.category)
-
-    def build_permission_info(self):
-        if self.clazz != None:
-            self.clazz.permitted_role_list = self.permitted_role_list
-
-    def build(self):
-        """构建完整的对象"""
-        self.build_category()
-        self.build_permission_info()
-
-        if self.icon is None:
-            self.icon = DEFAULT_PLUGIN_ICON_CLASS
-            self.icon_class = DEFAULT_PLUGIN_ICON_CLASS
-        if self.url == "":
-            self.url = f"/plugin/{self.plugin_name}"
-
-
-def is_plugin_file(fpath):
-    return os.path.isfile(fpath) and fpath.endswith(".py")
-
-
-@mem_util.log_mem_info_deco("load_plugin_file", log_args=True)
-def load_plugin_file(fpath, fname=None, raise_exception=False):
-    if not is_plugin_file(fpath):
-        return
-    if fname is None:
-        fname = os.path.basename(fpath)
-    dirname = os.path.dirname(fpath)
-
-    # 相对于插件目录的名称
-    plugin_name = fsutil.get_relative_path(fpath, xconfig.PLUGINS_DIR)
-
-    vars = dict()
-    vars["script_name"] = plugin_name
-    vars["fpath"] = fpath
-
-    try:
-        meta = xutils.load_script_meta(fpath)
-        context = PluginContext()
-        context.icon_class = DEFAULT_PLUGIN_ICON_CLASS
-        # 读取meta信息
-        context.load_from_meta(meta)
-        context.fpath = fpath
-        context.plugin_id = meta.get_str_value("plugin_id")
-        context.meta = meta
-        context.plugin_name = plugin_name
-        
-        if context.plugin_id == "":
-            # 兼容没有 plugin_id 的数据
-            context.plugin_id = fpath
-
-        if meta.has_tag("disabled"):
-            return
-
-        # 2.8版本之后从注解中获取插件信息
-        module = xutils.load_script(fname, vars, dirname=dirname)
-        main_class = vars.get("Main")
-        return load_plugin_by_context_and_class(context, main_class)
-    except Exception as e:
-        # TODO 增加异常日志
-        xutils.print_exc()
-        if raise_exception:
-            raise e
-
-def load_plugin_by_context(context: PluginContext):
-    assert isinstance(context, PluginContext)
-    assert context.plugin_name != ""
-    assert context.clazz != None
-    assert context.title != ""
-    
-    context.build()
-    plugin_name = context.plugin_name
-    xconfig.PLUGINS_DICT[plugin_name] = context
-
-def load_plugin_by_context_and_class(context: PluginContext, main_class=None):
-    if main_class != None:
-        fname = context.fname
-        fpath = context.fpath
-        plugin_name = context.plugin_name
-        
-        # 实例化插件
-        main_class.fname = fname
-        main_class.fpath = fpath
-        instance = main_class()
-        context.fname = fname
-        context.name = os.path.splitext(fname)[0]
-
-        if context.api_level < 2.8:
-            context.title = getattr(instance, "title", "")
-            context.category = attrget(instance, "category")
-            context.required_role = attrget(instance, "required_role")
-
-        if context.api_level >= 2.8:
-            main_class.title = context.title
-            main_class.category = context.category
-            main_class.required_role = context.required_role
-
-        context.url = "/plugin/%s" % plugin_name
-        context.clazz = main_class
-        context.edit_link = "code/edit?path=" + fpath
-
-        # 初始化插件
-        if hasattr(main_class, 'on_init'):
-            instance.on_init(context)
-
-        # 注册插件
-        xconfig.PLUGINS_DICT[plugin_name] = context
-        context.build()
-        return context
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-10-29 15:43:50
+@LastEditors  : xupingmao
+@LastEditTime : 2023-10-29 16:32:24
+@FilePath     : /xnote/xnote/plugin/plugin.py
+@Description  : 插件管理
+"""
+
+import os
+import xutils
+import enum
+
+from xnote.core import xconfig
+from xutils import mem_util, fsutil, Storage, attrget, ScriptMeta
+
+DEFAULT_PLUGIN_ICON_CLASS = "fa fa-cube"
+
+
+class PluginMetaKey(enum.Enum):
+    api_level = "api-level"
+    category = "category"
+    id = "id"
+    author = "author"
+
+
+class PluginContext(Storage):
+    """插件上下文"""
+
+    def __init__(self):
+        self.meta = ScriptMeta()
+        self.title = "" # 展示的名称
+        self.description = ""
+        
+        self.name = "" # 文件名称
+        self.plugin_id = "" # 唯一识别符号
+        self.plugin_name = "" # 相对plugin目录的名称
+        self.fname = ""
+        self.fpath = ""
+        
+        self.url = ""  # 这个应该算是基础url，用于匹配访问日志
+        self.url_query = ""  # 查询参数部分
+        self.category = None
+        self.category_list = []
+        
+        self.require_admin = True
+        self.required_role = "" # type: None|str
+        self.permitted_role_list = []  # 允许访问的权限列表
+        self.atime = ""
+        self.editable = True
+        self.edit_link = ""
+        self.clazz = None
+        self.priority = 0
+        self.icon = DEFAULT_PLUGIN_ICON_CLASS
+        self.author = None
+        self.version = None
+        self.debug = False
+    
+    @property
+    def link(self):
+        return self.url
+    
+    @link.setter
+    def set_link(self, link=""):
+        self.url = link
+
+    # sort方法重写__lt__即可
+    def __lt__(self, other):
+        return self.title < other.title
+
+    # 兼容Python2
+    def __cmp__(self, other):
+        return cmp(self.title, other.title)
+
+    def load_category_info(self, meta_obj):
+        self.category = meta_obj.get_str_value("category")  # 这里取第一个分类
+        self.category_list = meta_obj.get_list_value("category")  # 获取分类列表
+        self.build_category()
+
+    def load_permission_info(self, meta_obj):
+        self.require_admin = meta_obj.get_bool_value(
+            "require-admin", True)  # 访问是否要求管理员权限
+        self.permitted_role_list = meta_obj.get_list_value(
+            "permitted-role")  # 允许访问的角色
+
+    def load_from_meta(self, meta_obj):
+        self.api_level = meta_obj.get_float_value("api-level", 0.0)
+
+        if self.api_level >= 2.8:
+            self.title = meta_obj.get_str_value("title")
+            self.description = meta_obj.get_str_value("description")
+            self.author = meta_obj.get_str_value("author")
+            self.version = meta_obj.get_str_value("version")
+            self.icon = meta_obj.get_str_value("icon-class")
+            self.since = meta_obj.get_str_value("since")
+            self.debug = meta_obj.get_bool_value("debug")
+
+            self.load_category_info(meta_obj)
+            self.load_permission_info(meta_obj)
+
+    def build_category(self):
+        if self.category is None and len(self.category_list) > 0:
+            self.category = self.category_list[0]
+
+        if self.category != None and self.category not in self.category_list:
+            self.category_list.append(self.category)
+
+        if self.category is None and len(self.category_list) == 0:
+            self.category = "other"
+            self.category_list.append(self.category)
+
+    def build_permission_info(self):
+        if self.clazz != None:
+            self.clazz.permitted_role_list = self.permitted_role_list
+
+    def build(self):
+        """构建完整的对象"""
+        self.build_category()
+        self.build_permission_info()
+
+        if self.icon is None:
+            self.icon = DEFAULT_PLUGIN_ICON_CLASS
+            self.icon_class = DEFAULT_PLUGIN_ICON_CLASS
+        if self.url == "":
+            self.url = f"/plugin/{self.plugin_name}"
+
+
+def is_plugin_file(fpath):
+    return os.path.isfile(fpath) and fpath.endswith(".py")
+
+
+@mem_util.log_mem_info_deco("load_plugin_file", log_args=True)
+def load_plugin_file(fpath, fname=None, raise_exception=False):
+    if not is_plugin_file(fpath):
+        return
+    if fname is None:
+        fname = os.path.basename(fpath)
+    dirname = os.path.dirname(fpath)
+
+    # 相对于插件目录的名称
+    plugin_name = fsutil.get_relative_path(fpath, xconfig.PLUGINS_DIR)
+
+    vars = dict()
+    vars["script_name"] = plugin_name
+    vars["fpath"] = fpath
+
+    try:
+        meta = xutils.load_script_meta(fpath)
+        context = PluginContext()
+        context.icon_class = DEFAULT_PLUGIN_ICON_CLASS
+        # 读取meta信息
+        context.load_from_meta(meta)
+        context.fpath = fpath
+        context.plugin_id = meta.get_str_value("plugin_id")
+        context.meta = meta
+        context.plugin_name = plugin_name
+        
+        if context.plugin_id == "":
+            # 兼容没有 plugin_id 的数据
+            context.plugin_id = fpath
+
+        if meta.has_tag("disabled"):
+            return
+
+        # 2.8版本之后从注解中获取插件信息
+        module = xutils.load_script(fname, vars, dirname=dirname)
+        main_class = vars.get("Main")
+        return load_plugin_by_context_and_class(context, main_class)
+    except Exception as e:
+        # TODO 增加异常日志
+        xutils.print_exc()
+        if raise_exception:
+            raise e
+
+def load_plugin_by_context(context: PluginContext):
+    assert isinstance(context, PluginContext)
+    assert context.plugin_name != ""
+    assert context.clazz != None
+    assert context.title != ""
+    
+    context.build()
+    plugin_name = context.plugin_name
+    xconfig.PLUGINS_DICT[plugin_name] = context
+
+def load_plugin_by_context_and_class(context: PluginContext, main_class=None):
+    if main_class != None:
+        fname = context.fname
+        fpath = context.fpath
+        plugin_name = context.plugin_name
+        
+        # 实例化插件
+        main_class.fname = fname
+        main_class.fpath = fpath
+        instance = main_class()
+        context.fname = fname
+        context.name = os.path.splitext(fname)[0]
+
+        if context.api_level < 2.8:
+            context.title = getattr(instance, "title", "")
+            context.category = attrget(instance, "category")
+            context.required_role = attrget(instance, "required_role")
+
+        if context.api_level >= 2.8:
+            main_class.title = context.title
+            main_class.category = context.category
+            main_class.required_role = context.required_role
+
+        context.url = "/plugin/%s" % plugin_name
+        context.clazz = main_class
+        context.edit_link = "code/edit?path=" + fpath
+
+        # 初始化插件
+        if hasattr(main_class, 'on_init'):
+            instance.on_init(context)
+
+        # 注册插件
+        xconfig.PLUGINS_DICT[plugin_name] = context
+        context.build()
+        return context
```

### Comparing `xnote-web-0.1.0/xnote/service/comment_service.py` & `xnote-web-0.1.1/xnote/service/comment_service.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,61 +1,61 @@
-# encoding=utf-8
-
-
-import xutils
-from xnote.core import xtables
-from xutils import dateutil
-
-class CommentTypeEnum:
-    """枚举无法扩展,所以这里不用,从外部添加枚举值可以直接设置新的属性"""
-    empty = ""
-    note = "note"
-    list_item = "list_item"
-
-class Comment(xutils.Storage):
-    def __init__(self):
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.type = ""
-        self.user_id = 0
-        self.target_id = 0
-
-class CommentService:
-
-    db = xtables.get_table_by_name("comment_index")
-
-    def __init__(self):
-        pass
-    
-    def create(self, user_id=0, target_id=0, type=""):
-        now = dateutil.format_datetime()
-        return self.db.insert(ctime=now, mtime=now, type=type, user_id=user_id, target_id=target_id)
-    
-    def build_where(self, user_id=0, target_id=0, date=None, type=""):
-        date_like = date
-        where = "1=1"
-        if user_id != 0:
-            where += " AND user_id = $user_id"
-        if target_id != 0:
-            where += " AND target_id = $target_id"
-        if date != None and date != "":
-            where += " AND ctime LIKE $date_like"
-            date_like = date + "%"
-        if type != "":
-            where += " AND type=$type"
-        
-        vars = dict(type=type, user_id=user_id, target_id=target_id, date_like=date_like)
-        return where, vars
-    
-    def list(self, user_id=0, target_id=0, date=None, type="", offset=0,limit=20, order="ctime desc", what="*"):
-        if user_id ==0 and target_id == 0:
-            raise Exception("user_id,target_id不能同时为0")
-        
-        where, vars = self.build_where(user_id=user_id, target_id=target_id,date=date,type=type)
-        return self.db.select(where=where, vars=vars, offset=offset,limit=limit,order=order)
-
-    def count(self, user_id=0, target_id=0, date=None,type=""):
-        where, vars = self.build_where(user_id=user_id, target_id=target_id,date=date,type=type)
-        return self.db.count(where=where, vars=vars)
-    
-    def delete_by_id(self, id=0):
+# encoding=utf-8
+
+
+import xutils
+from xnote.core import xtables
+from xutils import dateutil
+
+class CommentTypeEnum:
+    """枚举无法扩展,所以这里不用,从外部添加枚举值可以直接设置新的属性"""
+    empty = ""
+    note = "note"
+    list_item = "list_item"
+
+class Comment(xutils.Storage):
+    def __init__(self):
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.type = ""
+        self.user_id = 0
+        self.target_id = 0
+
+class CommentService:
+
+    db = xtables.get_table_by_name("comment_index")
+
+    def __init__(self):
+        pass
+    
+    def create(self, user_id=0, target_id=0, type=""):
+        now = dateutil.format_datetime()
+        return self.db.insert(ctime=now, mtime=now, type=type, user_id=user_id, target_id=target_id)
+    
+    def build_where(self, user_id=0, target_id=0, date=None, type=""):
+        date_like = date
+        where = "1=1"
+        if user_id != 0:
+            where += " AND user_id = $user_id"
+        if target_id != 0:
+            where += " AND target_id = $target_id"
+        if date != None and date != "":
+            where += " AND ctime LIKE $date_like"
+            date_like = date + "%"
+        if type != "":
+            where += " AND type=$type"
+        
+        vars = dict(type=type, user_id=user_id, target_id=target_id, date_like=date_like)
+        return where, vars
+    
+    def list(self, user_id=0, target_id=0, date=None, type="", offset=0,limit=20, order="ctime desc", what="*"):
+        if user_id ==0 and target_id == 0:
+            raise Exception("user_id,target_id不能同时为0")
+        
+        where, vars = self.build_where(user_id=user_id, target_id=target_id,date=date,type=type)
+        return self.db.select(where=where, vars=vars, offset=offset,limit=limit,order=order)
+
+    def count(self, user_id=0, target_id=0, date=None,type=""):
+        where, vars = self.build_where(user_id=user_id, target_id=target_id,date=date,type=type)
+        return self.db.count(where=where, vars=vars)
+    
+    def delete_by_id(self, id=0):
         return self.db.delete(where=dict(id=id))
```

### Comparing `xnote-web-0.1.0/xnote/service/job_service.py` & `xnote-web-0.1.1/xnote/service/job_service.py`

 * *Ordering differences only*

 * *Files 23% similar despite different names*

```diff
@@ -1,122 +1,122 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-03-10 15:34:47
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-03 23:59:03
-@FilePath     : /xnote/xnote/service/job_service.py
-@Description  : 描述
-"""
-
-from xnote.core import xtables
-from xutils import dateutil
-
-class JobStatusEnum:
-    """枚举无法扩展,所以这里不用,从外部添加枚举值可以直接设置新的属性"""
-    init = 0 # 初始化
-    processing = 1 # 执行中
-    success = 2  # 执行成功
-    failed = 3 # 执行失败
-    
-    @classmethod
-    def get_title_by_status(cls, status=0):
-        if status == cls.init:
-            return "初始化"
-        if status == cls.processing:
-            return "执行中"
-        if status == cls.success:
-            return "执行成功"
-        if status == cls.failed:
-            return "执行失败"
-        return str(status)
-    
-class SysJob:
-    def __init__(self):
-        self.id = 0
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.job_status = JobStatusEnum.init
-        self.job_type = ""
-        self.job_params = ""
-        self.job_result = ""
-
-class JobManager:
-    """Database transaction."""
-
-    def __init__(self, job_info):
-        assert isinstance(job_info, SysJob)
-        self.job_info = job_info
-
-    def __enter__(self):
-        JobService.create_job(self.job_info)
-        return self
-
-    def __exit__(self, exctype, excvalue, traceback):
-        if exctype is not None:
-            self.job_info.job_status = JobStatusEnum.failed
-        else:
-            self.job_info.job_status = JobStatusEnum.success
-        
-        JobService.update_job(self.job_info)
-
-
-class JobService:
-    
-    db = xtables.get_table_by_name("t_job")
-    
-    @classmethod
-    def create_job(cls, job_info):
-        assert isinstance(job_info, SysJob)
-        assert job_info.id == 0
-        
-        record = job_info.__dict__
-        record.pop("id", None)
-        
-        db_id = cls.db.insert(record)
-        job_info.id = db_id
-        return db_id
-    
-    @classmethod
-    def get_job_by_id(cls, job_id=0):
-        record = cls.db.select_first(where=dict(id=job_id))
-        if record != None:
-            return cls.dict_to_obj(record)
-        return None
-    
-    @classmethod
-    def delete_by_id(cls, job_id=0):
-        return cls.db.delete(where=dict(id=job_id))
-    
-    @classmethod
-    def dict_to_obj(cls, record):
-        job_info = SysJob()
-        job_info.__dict__.update(record)
-        return job_info
-    
-    @classmethod
-    def list_job_page(cls, job_status_list=[], offset=0, limit=20, order="ctime desc"):
-        where_sql = "1=1"
-        if len(job_status_list) > 0:
-            where_sql += "AND job_status IN $job_status_list"
-        
-        vars = dict(job_status_list=job_status_list)
-        records = cls.db.select(where=where_sql, vars=vars, offset=offset, limit=limit, order=order)
-        result = []
-        for record in records:
-            result.append(cls.dict_to_obj(record))
-        amount = cls.db.count(where=where_sql, vars=vars)
-        return result, amount
-    
-    @classmethod
-    def update_job(cls, job_info):
-        assert isinstance(job_info, SysJob)
-        
-        updates = job_info.__dict__
-        return cls.db.update(where=dict(id=job_info.id), **updates)
-    
-    @classmethod
-    def run_with_job(cls, job_info):
-        assert isinstance(job_info, SysJob)
-        return JobManager(job_info=job_info)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-03-10 15:34:47
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-03 23:59:03
+@FilePath     : /xnote/xnote/service/job_service.py
+@Description  : 描述
+"""
+
+from xnote.core import xtables
+from xutils import dateutil
+
+class JobStatusEnum:
+    """枚举无法扩展,所以这里不用,从外部添加枚举值可以直接设置新的属性"""
+    init = 0 # 初始化
+    processing = 1 # 执行中
+    success = 2  # 执行成功
+    failed = 3 # 执行失败
+    
+    @classmethod
+    def get_title_by_status(cls, status=0):
+        if status == cls.init:
+            return "初始化"
+        if status == cls.processing:
+            return "执行中"
+        if status == cls.success:
+            return "执行成功"
+        if status == cls.failed:
+            return "执行失败"
+        return str(status)
+    
+class SysJob:
+    def __init__(self):
+        self.id = 0
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.job_status = JobStatusEnum.init
+        self.job_type = ""
+        self.job_params = ""
+        self.job_result = ""
+
+class JobManager:
+    """Database transaction."""
+
+    def __init__(self, job_info):
+        assert isinstance(job_info, SysJob)
+        self.job_info = job_info
+
+    def __enter__(self):
+        JobService.create_job(self.job_info)
+        return self
+
+    def __exit__(self, exctype, excvalue, traceback):
+        if exctype is not None:
+            self.job_info.job_status = JobStatusEnum.failed
+        else:
+            self.job_info.job_status = JobStatusEnum.success
+        
+        JobService.update_job(self.job_info)
+
+
+class JobService:
+    
+    db = xtables.get_table_by_name("t_job")
+    
+    @classmethod
+    def create_job(cls, job_info):
+        assert isinstance(job_info, SysJob)
+        assert job_info.id == 0
+        
+        record = job_info.__dict__
+        record.pop("id", None)
+        
+        db_id = cls.db.insert(record)
+        job_info.id = db_id
+        return db_id
+    
+    @classmethod
+    def get_job_by_id(cls, job_id=0):
+        record = cls.db.select_first(where=dict(id=job_id))
+        if record != None:
+            return cls.dict_to_obj(record)
+        return None
+    
+    @classmethod
+    def delete_by_id(cls, job_id=0):
+        return cls.db.delete(where=dict(id=job_id))
+    
+    @classmethod
+    def dict_to_obj(cls, record):
+        job_info = SysJob()
+        job_info.__dict__.update(record)
+        return job_info
+    
+    @classmethod
+    def list_job_page(cls, job_status_list=[], offset=0, limit=20, order="ctime desc"):
+        where_sql = "1=1"
+        if len(job_status_list) > 0:
+            where_sql += "AND job_status IN $job_status_list"
+        
+        vars = dict(job_status_list=job_status_list)
+        records = cls.db.select(where=where_sql, vars=vars, offset=offset, limit=limit, order=order)
+        result = []
+        for record in records:
+            result.append(cls.dict_to_obj(record))
+        amount = cls.db.count(where=where_sql, vars=vars)
+        return result, amount
+    
+    @classmethod
+    def update_job(cls, job_info):
+        assert isinstance(job_info, SysJob)
+        
+        updates = job_info.__dict__
+        return cls.db.update(where=dict(id=job_info.id), **updates)
+    
+    @classmethod
+    def run_with_job(cls, job_info):
+        assert isinstance(job_info, SysJob)
+        return JobManager(job_info=job_info)
```

### Comparing `xnote-web-0.1.0/xnote/service/lock_service.py` & `xnote-web-0.1.1/xnote/service/lock_service.py`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,100 +1,100 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-04-03 22:58:18
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-04 01:01:19
-@FilePath     : /xnote/xnote/service/lock_service.py
-@Description  : 分布式锁服务
-"""
-
-import xutils
-import time
-import datetime
-
-from xnote.core import xtables, xconfig
-
-DEFAULT_LOCK_TIMEOUT_SECONDS = 60.0
-
-def release_func(lock_key="", lock_token=""):
-    pass
-
-class LockObject:
-
-    def __init__(self):
-        self.lock_key = ""
-        self.timeout_time = 0
-        self.lock_token = ""
-        self.got_lock = False
-        self._release_func = release_func
-
-    def release(self):
-        if self.got_lock:
-            self._release_func(self.lock_key, self.lock_token)
-            self.got_lock = False
-
-    def __enter__(self):
-        if self.got_lock:
-            return self
-        raise Exception("acquire lock failed")
-
-    def __exit__(self, type, value, traceback):
-        self.release()
-
-    def __del__(self):
-        self.release()
-
-class DatabaseLockService:
-    """数据库锁服务"""
-
-    db = xtables.get_table_by_name("t_lock")
-
-    @classmethod
-    def to_datetime(cls, value):
-        if isinstance(value, str):
-            return datetime.datetime.fromisoformat(value)
-        if isinstance(value, datetime.datetime):
-            return value
-        raise Exception(f"unknown type {type(value)}")
-
-    @classmethod
-    def lock(cls, lock_key="", timeout_seconds=DEFAULT_LOCK_TIMEOUT_SECONDS):
-        now_time = xutils.format_datetime()
-        now_time_ms = time.time() * 1000
-        timeout_time = int(now_time_ms + timeout_seconds* 1000)
-        old_lock = cls.db.select_first(where=dict(lock_key=lock_key))
-        
-        if old_lock != None and old_lock.timeout_time < now_time_ms:
-            # lock is timeout
-            if xconfig.DatabaseConfig.db_driver_sql == "mysql":
-                cls.db.delete(where="lock_key=$lock_key AND timeout_time < current_timestamp()*1000", 
-                    vars=dict(lock_key=lock_key))
-            else:
-                cls.db.delete(where="lock_key=$lock_key AND timeout_time < $now_time_ms", 
-                    vars=dict(lock_key=lock_key, now_time_ms=now_time_ms))
-        
-        if old_lock != None and old_lock.timeout_time >= now_time_ms:
-            # lock is valid
-            raise Exception(f"acquire lock failed, lock_key={lock_key}")
-        
-        lock_token = xutils.create_uuid()
-        try:
-            cls.db.insert(ctime=now_time, mtime=now_time, lock_key=lock_key, lock_token=lock_token, 
-                          timeout_time=timeout_time)
-        except:
-            # create lock failed
-            raise Exception(f"acquire lock failed, lock_key={lock_key}")
-        
-        lock = LockObject()
-        lock.lock_key = lock_key
-        lock.timeout_time = timeout_time
-        lock.lock_token = lock_token
-        lock._release_func = cls.release
-        lock.got_lock = True
-        return lock
-    
-    @classmethod
-    def release(cls, lock_key="", lock_token=""):
-        cls.db.delete(where=dict(lock_key=lock_key, lock_token=lock_token))
-    
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-04-03 22:58:18
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-04 01:01:19
+@FilePath     : /xnote/xnote/service/lock_service.py
+@Description  : 分布式锁服务
+"""
+
+import xutils
+import time
+import datetime
+
+from xnote.core import xtables, xconfig
+
+DEFAULT_LOCK_TIMEOUT_SECONDS = 60.0
+
+def release_func(lock_key="", lock_token=""):
+    pass
+
+class LockObject:
+
+    def __init__(self):
+        self.lock_key = ""
+        self.timeout_time = 0
+        self.lock_token = ""
+        self.got_lock = False
+        self._release_func = release_func
+
+    def release(self):
+        if self.got_lock:
+            self._release_func(self.lock_key, self.lock_token)
+            self.got_lock = False
+
+    def __enter__(self):
+        if self.got_lock:
+            return self
+        raise Exception("acquire lock failed")
+
+    def __exit__(self, type, value, traceback):
+        self.release()
+
+    def __del__(self):
+        self.release()
+
+class DatabaseLockService:
+    """数据库锁服务"""
+
+    db = xtables.get_table_by_name("t_lock")
+
+    @classmethod
+    def to_datetime(cls, value):
+        if isinstance(value, str):
+            return datetime.datetime.fromisoformat(value)
+        if isinstance(value, datetime.datetime):
+            return value
+        raise Exception(f"unknown type {type(value)}")
+
+    @classmethod
+    def lock(cls, lock_key="", timeout_seconds=DEFAULT_LOCK_TIMEOUT_SECONDS):
+        now_time = xutils.format_datetime()
+        now_time_ms = time.time() * 1000
+        timeout_time = int(now_time_ms + timeout_seconds* 1000)
+        old_lock = cls.db.select_first(where=dict(lock_key=lock_key))
+        
+        if old_lock != None and old_lock.timeout_time < now_time_ms:
+            # lock is timeout
+            if xconfig.DatabaseConfig.db_driver_sql == "mysql":
+                cls.db.delete(where="lock_key=$lock_key AND timeout_time < current_timestamp()*1000", 
+                    vars=dict(lock_key=lock_key))
+            else:
+                cls.db.delete(where="lock_key=$lock_key AND timeout_time < $now_time_ms", 
+                    vars=dict(lock_key=lock_key, now_time_ms=now_time_ms))
+        
+        if old_lock != None and old_lock.timeout_time >= now_time_ms:
+            # lock is valid
+            raise Exception(f"acquire lock failed, lock_key={lock_key}")
+        
+        lock_token = xutils.create_uuid()
+        try:
+            cls.db.insert(ctime=now_time, mtime=now_time, lock_key=lock_key, lock_token=lock_token, 
+                          timeout_time=timeout_time)
+        except:
+            # create lock failed
+            raise Exception(f"acquire lock failed, lock_key={lock_key}")
+        
+        lock = LockObject()
+        lock.lock_key = lock_key
+        lock.timeout_time = timeout_time
+        lock.lock_token = lock_token
+        lock._release_func = cls.release
+        lock.got_lock = True
+        return lock
+    
+    @classmethod
+    def release(cls, lock_key="", lock_token=""):
+        cls.db.delete(where=dict(lock_key=lock_key, lock_token=lock_token))
+
```

### Comparing `xnote-web-0.1.0/xnote_migrate/__init__.py` & `xnote-web-0.1.1/xnote_migrate/__init__.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/base.py` & `xnote-web-0.1.1/xnote_migrate/base.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_001.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_001.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_002.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_002.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_003.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_003.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_004.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_004.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_005.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_005.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_007.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_007.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_009.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_009.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_010.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_010.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_011.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_011.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_012.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_012.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_013.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_013.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_014.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_014.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_015.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_015.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_016.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_016.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_017.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_017.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,312 +1,312 @@
-# encoding=utf-8
-import xutils
-from xnote.core import xtables, xauth, xconfig
-import logging
-import os
-import handlers.note.dao as note_dao
-
-from . import base
-from xutils import Storage
-from xutils import dbutil, dateutil
-from xutils.db.dbutil_helper import new_from_dict
-
-def do_upgrade():
-    # since v2.9.5
-    handler = MigrateHandler()
-    base.execute_upgrade("20230916_note_index", handler.migrate_note_index)
-    base.execute_upgrade("20230917_note_share", handler.migrate_note_share)
-    base.execute_upgrade("20230923_fix_creator_id", handler.fix_creator_id)
-    base.execute_upgrade("20230930_fix_gallery", handler.fix_gallery)
-    base.execute_upgrade("20231015_fix_note_history", handler.fix_note_history)
-    base.execute_upgrade("20231022_user_note_log", handler.migrate_user_note_log)
-
-
-class KvNoteIndexDO(Storage):
-    def __init__(self):
-        self.id = "" # id是str
-        self.name = ""
-        self.path = ""
-        self.creator = ""
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.atime = dateutil.format_datetime()
-        self.share_time = self.ctime
-        self.type = "md"
-        self.category = "" # 废弃
-        self.size = 0
-        self.children_count = 0
-        self.parent_id = "0" # 默认挂在根目录下
-        self.content = ""
-        self.data = ""
-        self.is_deleted = 0 # 0-正常， 1-删除
-        self.is_public = 0  # 0-不公开, 1-公开
-        self.token = ""
-        self.priority = 0 
-        self.visited_cnt = 0
-        self.orderby = ""
-        # 热门指数
-        self.hot_index = 0
-        # 版本
-        self.version = 0
-        self.tags = []
-
-    @staticmethod
-    def from_dict(dict_value):
-        return new_from_dict(KvNoteIndexDO, dict_value)
-
-class KvNoteShareDO(Storage):
-    def __init__(self, **kw):
-        self.from_user = kw.get("from_user", "")
-        self.to_user = kw.get("to_user", "")
-        self.note_id = kw.get("note_id", "")
-
-class NoteIndexDO(Storage):
-    def __init__(self):
-        self.id = 0
-        self.name = ""
-        self.creator = ""
-        self.creator_id = 0
-        self.type = ""
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.parent_id = 0
-        self.size = 0
-        self.version = 0
-        self.is_deleted = 0
-        self.is_public = 0
-        self.level = 0
-        self.children_count = 0
-        self.tag_str = ""
-        self.visit_cnt = 0
-
-    @staticmethod
-    def from_dict(dict_value):
-        return new_from_dict(NoteIndexDO, dict_value)
-
-
-class ShareInfoDO(Storage):
-    def __init__(self):
-        self.ctime = dateutil.format_datetime()
-        self.share_type = ""
-        self.target_id = 0
-        self.from_id = 0
-        self.to_id = 0
-        self.visit_cnt = 0
-
-class SimpleKvDO(xutils.Storage):
-    def __init__(self, **kw):
-        self._key = ""
-        self._id = ""
-        self.update(kw)
-
-class KvUserNoteLogDO(xutils.Storage):
-    def __init__(self, **kw):
-        self.note_id = 0
-        self.user = ""
-        self.visit_cnt = 0
-
-        self.ctime = xtables.DEFAULT_DATETIME
-        self.mtime = xtables.DEFAULT_DATETIME
-        self.atime = xtables.DEFAULT_DATETIME
-
-        self.update(kw)
-
-class NewUserNoteLogDO(Storage):
-    def __init__(self, **kw):
-        self.note_id = 0
-        self.user_id = 0
-        self.visit_cnt = 0
-        self.atime = xtables.DEFAULT_DATETIME
-        self.update(kw)
-
-class MigrateHandler:
-
-    share_db = xtables.get_table_by_name("share_info")
-    kv_note_share = dbutil.get_table("note_share")
-    user_dao = xauth.UserDao
-    note_full_db = dbutil.get_table("note_full")
-    note_index_db = xtables.get_table_by_name("note_index")
-    db_sep = ":"
-
-    def migrate_note_index(self):
-        """迁移笔记索引"""
-        old_db = dbutil.get_table("note_index")
-        new_db = self.note_index_db
-        note_full_db = self.note_full_db
-        
-
-        for item in old_db.iter(limit=-1):
-            old_index = KvNoteIndexDO.from_dict(item)
-            new_index = NoteIndexDO()
-
-            try:
-                note_id = int(old_index.id)
-            except:
-                base.add_failed_log("note_index", old_index, reason="note_id无法转换成数字")
-                continue
-
-            creator = old_index.creator
-            creator_id = xauth.UserDao.get_id_by_name(creator)
-
-            if old_index.tags == None:
-                old_index.tags = []
-
-            new_index.id = note_id
-            new_index.name = old_index.name
-            new_index.creator = old_index.creator
-            new_index.creator_id = creator_id
-            new_index.name = old_index.name
-            new_index.parent_id = int(old_index.parent_id)
-            new_index.ctime = old_index.ctime
-            new_index.mtime = old_index.mtime
-            new_index.type = old_index.type or "md"
-            new_index.size = old_index.size or 0
-            new_index.level = old_index.priority or 0
-            new_index.children_count = old_index.children_count or 0
-            new_index.is_deleted = old_index.is_deleted
-            new_index.is_public = old_index.is_public
-            new_index.tag_str = " ".join(old_index.tags)
-            new_index.visit_cnt = old_index.visited_cnt
-            if old_index.archived:
-                new_index.level = -1
-
-            if old_index.is_public:
-                self.upsert_public_note(new_index, old_index.share_time)
-
-            old_note_id = str(old_index.id)
-            if str(note_id) != old_note_id:
-                full_do = note_full_db.get_by_id(old_note_id)
-                if full_do != None:
-                    note_full_db.update_by_id(str(note_id), full_do)
-                    note_full_db.delete_by_id(old_note_id)
-
-            old = new_db.select_first(where=dict(id=note_id))
-            if old != None:
-                new_db.update(**new_index, where=dict(id=new_index.id))
-            else:
-                new_db.insert(**new_index)
-            
-            logging.info("迁移笔记索引: %s", new_index)
-
-    def upsert_public_note(self, index: NoteIndexDO, share_time:str):
-        note_id = index.id
-        share_info = self.share_db.select_first(where=dict(target_id=note_id))
-        if share_info == None:
-            new_share = ShareInfoDO()
-            new_share.ctime = share_time
-            new_share.share_type = "note_public"
-            new_share.target_id = index.id
-            new_share.from_id = index.creator_id
-            new_share.visit_cnt = index.visit_cnt
-            self.share_db.insert(**new_share)
-            logging.info("迁移笔记分享: %s", new_share)
-
-
-    def migrate_note_share(self):
-        for item in self.kv_note_share.iter(limit=-1):
-            kv_share = KvNoteShareDO(**item)
-            note_id = int(kv_share.note_id)
-            from_id = self.user_dao.get_id_by_name(kv_share.from_user)
-            to_id = self.user_dao.get_id_by_name(kv_share.to_user)
-            share_type = note_dao.ShareTypeEnum.note_to_user.value
-            where = dict(target_id=note_id, from_id=from_id, to_id=to_id, 
-                         share_type=share_type)
-            share_info = self.share_db.select_first(where=where)
-            if share_info == None:
-                new_share = ShareInfoDO()
-                new_share.ctime = dateutil.format_datetime()
-                new_share.share_type = share_type
-                new_share.target_id = note_id
-                new_share.from_id = from_id
-                new_share.to_id = to_id
-                self.share_db.insert(**new_share)
-    
-
-    def fix_creator_id(self):
-        """修复creator_id数据"""
-        for item in self.note_full_db.iter(limit=-1):
-            if item.creator_id in (0, None) and item.creator != "":
-                user_name = item.creator
-                user_id = xauth.UserDao.get_id_by_name(user_name)
-                item.creator_id = user_id
-                print(f"fix note_full, note_id={item.id}")
-                self.note_full_db.update(item)
-
-        for batch_result in self.note_index_db.iter_batch(where=" AND creator_id = 0"):
-            for item in batch_result:
-                creator = item.creator
-                user_id = xauth.UserDao.get_id_by_name(creator)
-                print(f"fix note_index, note_id={item.id}")
-                self.note_index_db.update(where=dict(id=item.id), creator_id=user_id)
-
-
-    def fix_gallery(self):
-        for user_info in xauth.iter_user(limit=-1):
-            gallery_dir = xconfig.FileConfig.get_gallery_dir_by_user(user_info.name)
-            if not os.path.exists(gallery_dir):
-                continue
-            for suffix_dir in os.listdir(gallery_dir):
-                dirname = os.path.join(gallery_dir, suffix_dir)
-                for note_id in os.listdir(dirname):
-                    if note_id[0] == "0":
-                        # 去掉0开始的文件夹
-                        new_note_id = note_id.lstrip("0")
-                        old_path = os.path.join(dirname, note_id)
-                        new_path = os.path.join(dirname, new_note_id)
-                        print(f"rename {old_path} -> {new_path}")
-                        os.rename(old_path, new_path)
-    
-    def build_new_id(self, parts=[]):
-        new_parts = []
-        for part in parts:
-            if part.startswith("0") and part != "0":
-                new_parts.append(part.lstrip("0"))
-            else:
-                new_parts.append(part)
-        return self.db_sep.join(new_parts)
-        
-    def fix_zero_pad(self, db:dbutil.LdbTable):
-        for item in db.iter(limit=-1):
-            index_do = SimpleKvDO(**item)
-            parts = index_do._key.split(self.db_sep)
-            old_id = self.db_sep.join(parts[1:])
-            new_id = self.build_new_id(parts[1:])
-            if old_id != new_id:
-                logging.info("修复0前缀, old_id=%s, new_id=%s", old_id, new_id)
-                db.put_by_id(new_id, index_do, encode_key=False)
-                db.delete_by_id(old_id)
-
-    def fix_note_history(self):
-        self.fix_zero_pad(dbutil.get_table("note_history_index"))
-        self.fix_zero_pad(dbutil.get_table("note_history"))
-
-
-    def migrate_user_note_log(self):
-        old_db = dbutil.get_table("user_note_log")
-        new_db = xtables.get_table_by_name("user_note_log")
-        for item_ in old_db.iter(limit=-1):
-            item = KvUserNoteLogDO(**item_)
-            user_id = xauth.UserDao.get_id_by_name(item.user)
-
-            try:
-                # 历史数据有非int类型的
-                note_id = int(item.note_id)
-            except:
-                print(f"invalid note_id: {item.note_id}")
-                continue
-
-            if user_id != 0:
-                record = new_db.select_first(where=dict(user_id=user_id, note_id=note_id))
-                if record != None:
-                    record.visit_cnt = item.visit_cnt
-                    record.atime = item.atime
-                else:
-                    new_record = NewUserNoteLogDO()
-                    new_record.user_id = user_id
-                    new_record.note_id = note_id
-                    new_record.atime = item.atime
-                    new_record.visit_cnt = item.visit_cnt
-                    new_db.insert(**new_record)
-                print(f"migrate log {item}")
-            else:
-                print(f"can not migrate log {item}")
+# encoding=utf-8
+import xutils
+from xnote.core import xtables, xauth, xconfig
+import logging
+import os
+import handlers.note.dao as note_dao
+
+from . import base
+from xutils import Storage
+from xutils import dbutil, dateutil
+from xutils.db.dbutil_helper import new_from_dict
+
+def do_upgrade():
+    # since v2.9.5
+    handler = MigrateHandler()
+    base.execute_upgrade("20230916_note_index", handler.migrate_note_index)
+    base.execute_upgrade("20230917_note_share", handler.migrate_note_share)
+    base.execute_upgrade("20230923_fix_creator_id", handler.fix_creator_id)
+    base.execute_upgrade("20230930_fix_gallery", handler.fix_gallery)
+    base.execute_upgrade("20231015_fix_note_history", handler.fix_note_history)
+    base.execute_upgrade("20231022_user_note_log", handler.migrate_user_note_log)
+
+
+class KvNoteIndexDO(Storage):
+    def __init__(self):
+        self.id = "" # id是str
+        self.name = ""
+        self.path = ""
+        self.creator = ""
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.atime = dateutil.format_datetime()
+        self.share_time = self.ctime
+        self.type = "md"
+        self.category = "" # 废弃
+        self.size = 0
+        self.children_count = 0
+        self.parent_id = "0" # 默认挂在根目录下
+        self.content = ""
+        self.data = ""
+        self.is_deleted = 0 # 0-正常， 1-删除
+        self.is_public = 0  # 0-不公开, 1-公开
+        self.token = ""
+        self.priority = 0 
+        self.visited_cnt = 0
+        self.orderby = ""
+        # 热门指数
+        self.hot_index = 0
+        # 版本
+        self.version = 0
+        self.tags = []
+
+    @staticmethod
+    def from_dict(dict_value):
+        return new_from_dict(KvNoteIndexDO, dict_value)
+
+class KvNoteShareDO(Storage):
+    def __init__(self, **kw):
+        self.from_user = kw.get("from_user", "")
+        self.to_user = kw.get("to_user", "")
+        self.note_id = kw.get("note_id", "")
+
+class NoteIndexDO(Storage):
+    def __init__(self):
+        self.id = 0
+        self.name = ""
+        self.creator = ""
+        self.creator_id = 0
+        self.type = ""
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.parent_id = 0
+        self.size = 0
+        self.version = 0
+        self.is_deleted = 0
+        self.is_public = 0
+        self.level = 0
+        self.children_count = 0
+        self.tag_str = ""
+        self.visit_cnt = 0
+
+    @staticmethod
+    def from_dict(dict_value):
+        return new_from_dict(NoteIndexDO, dict_value)
+
+
+class ShareInfoDO(Storage):
+    def __init__(self):
+        self.ctime = dateutil.format_datetime()
+        self.share_type = ""
+        self.target_id = 0
+        self.from_id = 0
+        self.to_id = 0
+        self.visit_cnt = 0
+
+class SimpleKvDO(xutils.Storage):
+    def __init__(self, **kw):
+        self._key = ""
+        self._id = ""
+        self.update(kw)
+
+class KvUserNoteLogDO(xutils.Storage):
+    def __init__(self, **kw):
+        self.note_id = 0
+        self.user = ""
+        self.visit_cnt = 0
+
+        self.ctime = xtables.DEFAULT_DATETIME
+        self.mtime = xtables.DEFAULT_DATETIME
+        self.atime = xtables.DEFAULT_DATETIME
+
+        self.update(kw)
+
+class NewUserNoteLogDO(Storage):
+    def __init__(self, **kw):
+        self.note_id = 0
+        self.user_id = 0
+        self.visit_cnt = 0
+        self.atime = xtables.DEFAULT_DATETIME
+        self.update(kw)
+
+class MigrateHandler:
+
+    share_db = xtables.get_table_by_name("share_info")
+    kv_note_share = dbutil.get_table("note_share")
+    user_dao = xauth.UserDao
+    note_full_db = dbutil.get_table("note_full")
+    note_index_db = xtables.get_table_by_name("note_index")
+    db_sep = ":"
+
+    def migrate_note_index(self):
+        """迁移笔记索引"""
+        old_db = dbutil.get_table("note_index")
+        new_db = self.note_index_db
+        note_full_db = self.note_full_db
+        
+
+        for item in old_db.iter(limit=-1):
+            old_index = KvNoteIndexDO.from_dict(item)
+            new_index = NoteIndexDO()
+
+            try:
+                note_id = int(old_index.id)
+            except:
+                base.add_failed_log("note_index", old_index, reason="note_id无法转换成数字")
+                continue
+
+            creator = old_index.creator
+            creator_id = xauth.UserDao.get_id_by_name(creator)
+
+            if old_index.tags == None:
+                old_index.tags = []
+
+            new_index.id = note_id
+            new_index.name = old_index.name
+            new_index.creator = old_index.creator
+            new_index.creator_id = creator_id
+            new_index.name = old_index.name
+            new_index.parent_id = int(old_index.parent_id)
+            new_index.ctime = old_index.ctime
+            new_index.mtime = old_index.mtime
+            new_index.type = old_index.type or "md"
+            new_index.size = old_index.size or 0
+            new_index.level = old_index.priority or 0
+            new_index.children_count = old_index.children_count or 0
+            new_index.is_deleted = old_index.is_deleted
+            new_index.is_public = old_index.is_public
+            new_index.tag_str = " ".join(old_index.tags)
+            new_index.visit_cnt = old_index.visited_cnt
+            if old_index.archived:
+                new_index.level = -1
+
+            if old_index.is_public:
+                self.upsert_public_note(new_index, old_index.share_time)
+
+            old_note_id = str(old_index.id)
+            if str(note_id) != old_note_id:
+                full_do = note_full_db.get_by_id(old_note_id)
+                if full_do != None:
+                    note_full_db.update_by_id(str(note_id), full_do)
+                    note_full_db.delete_by_id(old_note_id)
+
+            old = new_db.select_first(where=dict(id=note_id))
+            if old != None:
+                new_db.update(**new_index, where=dict(id=new_index.id))
+            else:
+                new_db.insert(**new_index)
+            
+            logging.info("迁移笔记索引: %s", new_index)
+
+    def upsert_public_note(self, index: NoteIndexDO, share_time:str):
+        note_id = index.id
+        share_info = self.share_db.select_first(where=dict(target_id=note_id))
+        if share_info == None:
+            new_share = ShareInfoDO()
+            new_share.ctime = share_time
+            new_share.share_type = "note_public"
+            new_share.target_id = index.id
+            new_share.from_id = index.creator_id
+            new_share.visit_cnt = index.visit_cnt
+            self.share_db.insert(**new_share)
+            logging.info("迁移笔记分享: %s", new_share)
+
+
+    def migrate_note_share(self):
+        for item in self.kv_note_share.iter(limit=-1):
+            kv_share = KvNoteShareDO(**item)
+            note_id = int(kv_share.note_id)
+            from_id = self.user_dao.get_id_by_name(kv_share.from_user)
+            to_id = self.user_dao.get_id_by_name(kv_share.to_user)
+            share_type = note_dao.ShareTypeEnum.note_to_user.value
+            where = dict(target_id=note_id, from_id=from_id, to_id=to_id, 
+                         share_type=share_type)
+            share_info = self.share_db.select_first(where=where)
+            if share_info == None:
+                new_share = ShareInfoDO()
+                new_share.ctime = dateutil.format_datetime()
+                new_share.share_type = share_type
+                new_share.target_id = note_id
+                new_share.from_id = from_id
+                new_share.to_id = to_id
+                self.share_db.insert(**new_share)
+    
+
+    def fix_creator_id(self):
+        """修复creator_id数据"""
+        for item in self.note_full_db.iter(limit=-1):
+            if item.creator_id in (0, None) and item.creator != "":
+                user_name = item.creator
+                user_id = xauth.UserDao.get_id_by_name(user_name)
+                item.creator_id = user_id
+                print(f"fix note_full, note_id={item.id}")
+                self.note_full_db.update(item)
+
+        for batch_result in self.note_index_db.iter_batch(where=" AND creator_id = 0"):
+            for item in batch_result:
+                creator = item.creator
+                user_id = xauth.UserDao.get_id_by_name(creator)
+                print(f"fix note_index, note_id={item.id}")
+                self.note_index_db.update(where=dict(id=item.id), creator_id=user_id)
+
+
+    def fix_gallery(self):
+        for user_info in xauth.iter_user(limit=-1):
+            gallery_dir = xconfig.FileConfig.get_gallery_dir_by_user(user_info.name)
+            if not os.path.exists(gallery_dir):
+                continue
+            for suffix_dir in os.listdir(gallery_dir):
+                dirname = os.path.join(gallery_dir, suffix_dir)
+                for note_id in os.listdir(dirname):
+                    if note_id[0] == "0":
+                        # 去掉0开始的文件夹
+                        new_note_id = note_id.lstrip("0")
+                        old_path = os.path.join(dirname, note_id)
+                        new_path = os.path.join(dirname, new_note_id)
+                        print(f"rename {old_path} -> {new_path}")
+                        os.rename(old_path, new_path)
+    
+    def build_new_id(self, parts=[]):
+        new_parts = []
+        for part in parts:
+            if part.startswith("0") and part != "0":
+                new_parts.append(part.lstrip("0"))
+            else:
+                new_parts.append(part)
+        return self.db_sep.join(new_parts)
+        
+    def fix_zero_pad(self, db:dbutil.LdbTable):
+        for item in db.iter(limit=-1):
+            index_do = SimpleKvDO(**item)
+            parts = index_do._key.split(self.db_sep)
+            old_id = self.db_sep.join(parts[1:])
+            new_id = self.build_new_id(parts[1:])
+            if old_id != new_id:
+                logging.info("修复0前缀, old_id=%s, new_id=%s", old_id, new_id)
+                db.put_by_id(new_id, index_do, encode_key=False)
+                db.delete_by_id(old_id)
+
+    def fix_note_history(self):
+        self.fix_zero_pad(dbutil.get_table("note_history_index"))
+        self.fix_zero_pad(dbutil.get_table("note_history"))
+
+
+    def migrate_user_note_log(self):
+        old_db = dbutil.get_table("user_note_log")
+        new_db = xtables.get_table_by_name("user_note_log")
+        for item_ in old_db.iter(limit=-1):
+            item = KvUserNoteLogDO(**item_)
+            user_id = xauth.UserDao.get_id_by_name(item.user)
+
+            try:
+                # 历史数据有非int类型的
+                note_id = int(item.note_id)
+            except:
+                print(f"invalid note_id: {item.note_id}")
+                continue
+
+            if user_id != 0:
+                record = new_db.select_first(where=dict(user_id=user_id, note_id=note_id))
+                if record != None:
+                    record.visit_cnt = item.visit_cnt
+                    record.atime = item.atime
+                else:
+                    new_record = NewUserNoteLogDO()
+                    new_record.user_id = user_id
+                    new_record.note_id = note_id
+                    new_record.atime = item.atime
+                    new_record.visit_cnt = item.visit_cnt
+                    new_db.insert(**new_record)
+                print(f"migrate log {item}")
+            else:
+                print(f"can not migrate log {item}")
```

### Comparing `xnote-web-0.1.0/xnote_migrate/upgrade_018.py` & `xnote-web-0.1.1/xnote_migrate/upgrade_018.py`

 * *Files 27% similar despite different names*

```diff
@@ -1,213 +1,224 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-11-05 19:11:13
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-10 15:21:20
-@FilePath     : /xnote/xnote_migrate/upgrade_018.py
-@Description  : 描述
-"""
-
-from xnote.core import xauth, xtables
-from xutils import dbutil, Storage
-from xutils.sqldb.utils import safe_str
-from . import base
-import logging
-from xutils import dateutil
-import xutils
-
-def do_upgrade():
-    # since v2.9.6
-    handler = MigrateHandler()
-    base.execute_upgrade("20231105_month_plan", handler.migrate_month_plan)
-    base.execute_upgrade("20231223_msg_index", handler.migrate_msg_index)
-    base.execute_upgrade("20240214_plugin_visit", handler.migrate_plugin_visit)
-    base.execute_upgrade("20240214_user_op_log", handler.migrate_user_op_log)
-    # base.execute_upgrade("20240308_msg_history", handler.migrate_msg_history)
-    xutils.register_func("upgrade.20240308_msg_history",handler.migrate_msg_history)
-    
-
-class MonthPlanRecord(Storage):
-    def __init__(self, **kw):
-        self._id = ""
-        self._key = ""
-        self.user = ""
-        self.user_id = 0
-        self.month = ""
-        self.notes = []
-        self.note_ids = []
-        self.create_notes = []
-        self.update_notes = []
-        self.update(kw)
-
-
-class MsgIndexDO(Storage):
-    def __init__(self, **kw):
-        self.id = 0
-        self.tag = ""
-        self.user_id = 0
-        self.user_name = ""
-        self.ctime_sys = dateutil.format_datetime() # 实际创建时间
-        self.ctime = dateutil.format_datetime() # 展示创建时间
-        self.mtime = dateutil.format_datetime() # 修改时间
-        self.date = "1970-01-01"
-        self.sort_value = "" # 排序字段, 对于log/task,存储创建时间,对于done,存储完成时间
-        self.update(kw)
-
-class PluginVisitDO(Storage):
-    
-    def __init__(self, **kw):
-        self.name = "test"
-        self.url = "/test"
-        self.args = "name=1&age=2"
-        self.user = ""
-        self.visit_cnt = 0
-        self.time = dateutil.format_datetime()
-        self.update(kw)
-    
-class PageVisitLogDO(Storage):
-    
-    def __init__(self, **kw):
-        self.user_id = 0
-        self.url = "/test"
-        self.args = "name=1&age=2"
-        self.visit_cnt = 0
-        self.visit_time = dateutil.format_datetime()
-        self.update(kw)
-        
-class UserOpLogV1(Storage):
-    def __init__(self, **kw):
-        self.ctime = dateutil.format_datetime()
-        self.user_name = ""
-        self.type = ""
-        self.detail = ""
-        self.ip = ""
-        self.update(kw)
-
-class UserOpLogV2(Storage):
-    def __init__(self, **kw):
-        self.ctime = dateutil.format_datetime()
-        self.user_id = 0
-        self.type = ""
-        self.detail = ""
-        self.ip = ""
-        self.update(kw)
-
-class MessageHistoryV1(Storage):
-    def __init__(self, **kw):
-        self.id = ""
-        self.version = 0
-        self.user_id = 0
-        self.user = ""
-        self.content = ""
-        self.ctime = dateutil.format_datetime()
-        self.mtime = dateutil.format_datetime()
-        self.update(kw)
-
-class MessageHistoryV2(Storage):
-    def __init__(self, **kw):
-        self.msg_id = 0
-        self.msg_version = 0
-        self.user_id = 0
-        self.content = ""
-        self.ctime = dateutil.format_datetime()
-        self.update(kw)
-
-class MigrateHandler:
-
-    @classmethod
-    def migrate_month_plan(cls):
-        db = dbutil.get_table_v2("month_plan")
-        for item in db.iter_by_kv():
-            record = MonthPlanRecord(**item)
-            if not record._id.isnumeric():
-                # 老版本的数据放弃修复，重新插入会导致id重复
-                logging.warning("ignore invalid key=%s", record._key)
-                continue
-            record.user_id = xauth.UserDao.get_id_by_name(record.user)
-            record.month = record.month.replace("/", "-")
-            db.update(record)
-
-    @classmethod
-    def migrate_msg_index(cls):
-        db = xtables.get_table_by_name("msg_index")
-        for item in db.iter():
-            msg_index = MsgIndexDO(**item)
-            if msg_index.sort_value in ("", xtables.DEFAULT_DATETIME):
-                if msg_index.tag == "done":
-                    msg_index.sort_value = msg_index.mtime
-                else:
-                    msg_index.sort_value = msg_index.ctime
-                db.update(where=dict(id=msg_index.id), _skip_binlog=True, _skip_profile=True, sort_value = msg_index.sort_value)
-    
-    
-    @classmethod
-    def migrate_plugin_visit(cls):
-        old_db = dbutil.get_table("plugin_visit")
-        new_db = xtables.get_table_by_name("page_visit_log")
-        for item0 in old_db.iter(limit=-1):
-            item = PluginVisitDO(**item0)
-            user_id = xauth.UserDao.get_id_by_name(item.user)
-            exist = new_db.select_first(where=dict(user_id=user_id, url=item.url))
-            if exist != None:
-                continue
-            else:
-                new_record = PageVisitLogDO()
-                new_record.user_id = user_id
-                new_record.visit_time = item.time
-                new_record.visit_cnt = item.visit_cnt
-                new_record.url = safe_str(item.url)
-                new_record.args = safe_str(item.args)
-                new_db.insert(**new_record)
-    
-    
-    @classmethod
-    def migrate_user_op_log(cls):
-        old_db = dbutil.get_table("user_op_log")
-        new_db = xtables.get_table_by_name("user_op_log")
-        for item0 in old_db.iter(limit=-1):
-            item = UserOpLogV1(**item0)
-            user_id = xauth.UserDao.get_id_by_name(item.user_name)
-            if user_id == 0:
-                logging.info("invalid user_op_log, %s", item0)
-                continue
-            exist = new_db.select_first(where=dict(user_id=user_id, ctime=item.ctime))
-            if exist == None:
-                new_record = UserOpLogV2()
-                new_record.user_id = user_id
-                new_record.ctime = item.ctime
-                new_record.type = item.type
-                new_record.detail = item.detail
-                new_record.ip = item.ip
-                new_db.insert(**new_record)
-    
-    
-    @classmethod
-    def migrate_msg_history(cls):
-        db = dbutil.get_table_v2("msg_history")
-        for item0 in db.iter_by_kv():
-            item = MessageHistoryV1(**item0)
-            if item.id == "":
-                continue
-            
-            msg_id = int(db._get_id_from_key(item.id))
-            version = item.get("version", 0)
-            user_id = item.get("user_id", 0)
-            
-            assert msg_id > 0
-            assert version >= 0
-            if user_id == 0:
-                user_id = xauth.UserDao.get_id_by_name(item.user)
-            
-            first = db.select_first(where=dict(msg_id=msg_id, msg_version=version))
-            
-            new_item = MessageHistoryV2()
-            new_item.msg_id = msg_id
-            new_item.msg_version = version
-            new_item.user_id = user_id
-            new_item.ctime = item.mtime
-            new_item.content = item.content
-            
-            if first is None:
-                db.insert(new_item)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-11-05 19:11:13
+@LastEditors  : xupingmao
+@LastEditTime : 2024-05-05 12:10:43
+@FilePath     : /xnote/xnote_migrate/upgrade_018.py
+@Description  : 描述
+"""
+
+from xnote.core import xauth, xtables
+from xutils import dbutil, Storage
+from xutils.sqldb.utils import safe_str
+from . import base
+import logging
+from xutils import dateutil
+import xutils
+
+def do_upgrade():
+    # since v2.9.6
+    handler = MigrateHandler()
+    base.execute_upgrade("20231105_month_plan", handler.migrate_month_plan)
+    base.execute_upgrade("20231223_msg_index", handler.migrate_msg_index)
+    base.execute_upgrade("20240214_plugin_visit", handler.migrate_plugin_visit)
+    base.execute_upgrade("20240214_user_op_log", handler.migrate_user_op_log)
+    base.execute_upgrade("20240308_msg_history", handler.migrate_msg_history)
+    
+
+class MonthPlanRecord(Storage):
+    def __init__(self, **kw):
+        self._id = ""
+        self._key = ""
+        self.user = ""
+        self.user_id = 0
+        self.month = ""
+        self.notes = []
+        self.note_ids = []
+        self.create_notes = []
+        self.update_notes = []
+        self.update(kw)
+
+
+class MsgIndexDO(Storage):
+    def __init__(self, **kw):
+        self.id = 0
+        self.tag = ""
+        self.user_id = 0
+        self.user_name = ""
+        self.ctime_sys = dateutil.format_datetime() # 实际创建时间
+        self.ctime = dateutil.format_datetime() # 展示创建时间
+        self.mtime = dateutil.format_datetime() # 修改时间
+        self.date = "1970-01-01"
+        self.sort_value = "" # 排序字段, 对于log/task,存储创建时间,对于done,存储完成时间
+        self.update(kw)
+
+class PluginVisitDO(Storage):
+    
+    def __init__(self, **kw):
+        self.name = "test"
+        self.url = "/test"
+        self.args = "name=1&age=2"
+        self.user = ""
+        self.visit_cnt = 0
+        self.time = dateutil.format_datetime()
+        self.update(kw)
+    
+class PageVisitLogDO(Storage):
+    
+    def __init__(self, **kw):
+        self.user_id = 0
+        self.url = "/test"
+        self.args = "name=1&age=2"
+        self.visit_cnt = 0
+        self.visit_time = dateutil.format_datetime()
+        self.update(kw)
+        
+class UserOpLogV1(Storage):
+    def __init__(self, **kw):
+        self.ctime = dateutil.format_datetime()
+        self.user_name = ""
+        self.type = ""
+        self.detail = ""
+        self.ip = ""
+        self.update(kw)
+
+class UserOpLogV2(Storage):
+    def __init__(self, **kw):
+        self.ctime = dateutil.format_datetime()
+        self.user_id = 0
+        self.type = ""
+        self.detail = ""
+        self.ip = ""
+        self.update(kw)
+
+class MessageHistoryV1(Storage):
+    def __init__(self, **kw):
+        self.id = ""
+        self.version = 0
+        self.user_id = 0
+        self.user = ""
+        self.content = ""
+        self.ctime = dateutil.format_datetime()
+        self.mtime = dateutil.format_datetime()
+        self.update(kw)
+
+class MessageHistoryV2(Storage):
+    def __init__(self, **kw):
+        self.msg_id = 0
+        self.msg_version = 0
+        self.user_id = 0
+        self.content = ""
+        self.ctime = dateutil.format_datetime()
+        self.update(kw)
+
+class MigrateHandler:
+
+    @classmethod
+    def migrate_month_plan(cls):
+        db = dbutil.get_table_v2("month_plan")
+        for item in db.iter_by_kv():
+            record = MonthPlanRecord(**item)
+            if not record._id.isnumeric():
+                # 老版本的数据放弃修复，重新插入会导致id重复
+                logging.warning("ignore invalid key=%s", record._key)
+                continue
+            record.user_id = xauth.UserDao.get_id_by_name(record.user)
+            record.month = record.month.replace("/", "-")
+            db.update(record)
+
+    @classmethod
+    def migrate_msg_index(cls):
+        db = xtables.get_table_by_name("msg_index")
+        for item in db.iter():
+            msg_index = MsgIndexDO(**item)
+            if msg_index.sort_value in ("", xtables.DEFAULT_DATETIME):
+                if msg_index.tag == "done":
+                    msg_index.sort_value = msg_index.mtime
+                else:
+                    msg_index.sort_value = msg_index.ctime
+                db.update(where=dict(id=msg_index.id), _skip_binlog=True, _skip_profile=True, sort_value = msg_index.sort_value)
+    
+    
+    @classmethod
+    def migrate_plugin_visit(cls):
+        old_db = dbutil.get_table("plugin_visit")
+        new_db = xtables.get_table_by_name("page_visit_log")
+        for item0 in old_db.iter(limit=-1):
+            item = PluginVisitDO(**item0)
+            user_id = xauth.UserDao.get_id_by_name(item.user)
+            exist = new_db.select_first(where=dict(user_id=user_id, url=item.url))
+            if exist != None:
+                continue
+            else:
+                new_record = PageVisitLogDO()
+                new_record.user_id = user_id
+                new_record.visit_time = item.time
+                new_record.visit_cnt = item.visit_cnt
+                new_record.url = safe_str(item.url)
+                new_record.args = safe_str(item.args)
+                new_db.insert(**new_record)
+    
+    
+    @classmethod
+    def migrate_user_op_log(cls):
+        old_db = dbutil.get_table("user_op_log")
+        new_db = xtables.get_table_by_name("user_op_log")
+        for item0 in old_db.iter(limit=-1):
+            item = UserOpLogV1(**item0)
+            user_id = xauth.UserDao.get_id_by_name(item.user_name)
+            if user_id == 0:
+                logging.info("invalid user_op_log, %s", item0)
+                continue
+            exist = new_db.select_first(where=dict(user_id=user_id, ctime=item.ctime))
+            if exist == None:
+                new_record = UserOpLogV2()
+                new_record.user_id = user_id
+                new_record.ctime = item.ctime
+                new_record.type = item.type
+                new_record.detail = item.detail
+                new_record.ip = item.ip
+                new_db.insert(**new_record)
+    
+    
+    @classmethod
+    def migrate_msg_history(cls):
+        db = dbutil.get_table_v2("msg_history")
+        for old_item in db.iter_by_kv():
+            item = MessageHistoryV1(**old_item)
+            if item.id == "":
+                continue
+            
+            try:
+                msg_id = int(db._get_id_from_key(item.id))
+            except:
+                logging.error("invalid msg_id: %s", item.id)
+                continue
+
+            version = item.get("version", 0)
+            user_id = item.get("user_id", 0)
+            
+            if msg_id <= 0 or version < 0:
+                logging.error("invalid msg: %s", old_item)
+                continue
+
+            if user_id == 0:
+                user_id = xauth.UserDao.get_id_by_name(item.user)
+            
+            first = db.select_first(where=dict(msg_id=msg_id, msg_version=version))
+            
+            new_item = MessageHistoryV2()
+            new_item.msg_id = msg_id
+            new_item.msg_version = version
+            new_item.user_id = user_id
+            new_item.ctime = item.mtime
+            new_item.content = item.content
+            
+            if first is None:
+                logging.info("insert %s", new_item)
+                db.insert(new_item)
+                db.delete(old_item)
+            else:
+                logging.info("delete %s", old_item)
+                db.delete(old_item)
```

### Comparing `xnote-web-0.1.0/xnote_web.egg-info/PKG-INFO` & `xnote-web-0.1.1/README.md`

 * *Files 15% similar despite different names*

```diff
@@ -1,148 +1,136 @@
-Metadata-Version: 2.1
-Name: xnote-web
-Version: 0.1.0
-Summary: xnote-web框架
-Author: mark
-Author-email: 578749341@qq.com
-Classifier: Programming Language :: Python :: 3
-Classifier: License :: OSI Approved :: MIT License
-Classifier: Operating System :: OS Independent
-Description-Content-Type: text/markdown
-License-File: COPYING
-
-# Xnote
-
-[![Coverage Status](https://coveralls.io/repos/github/xupingmao/xnote/badge.svg?branch=master)](https://coveralls.io/github/xupingmao/xnote?branch=master)
-![Docker Image](https://img.shields.io/docker/pulls/donjuanplatinum/xnote)
-
-xnote是一款面向个人的轻量级笔记系统，提供多种维度的数据管理功能，致力于把个人从信息过载中解放出来。它主要有如下特性
-
-- 拥有丰富的数据管理能力，支持多种笔记格式以及文件管理功能
-- 默认提供了一些常用的工具，同时提供扩展能力，用户可以编写各种插件满足自己的需求
-- 跨平台，支持Windows、Mac、Linux三大平台，可以在云服务上部署，也可以在本地运行
-- 100%自由的数据控制权，可以运行在多种数据库环境中
-- 支持小规模的多用户，面向多用户的商业场景使用请谨慎
-
-目前xnote定位是一个面向个人使用的小型笔记产品，不会重点投入以下方向
-- 大规模的多用户支持
-- 多用户协作功能
-
-如果你热爱技术爱折腾、需要多元的数据处理能力、希望完全掌控自己的文档数据，本产品将会是一个不错的尝试，欢迎试用反馈。
-
-- 体验demo网址 https://1k5u680558.goho.co/
-- 测试账号 user01/123456, user02/123456 友情提示：管理员会不定期清理数据，请勿存放重要数据
-
-以下是一些页面展示
-
-功能列表
-![功能列表](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_home.png)
-
-笔记本
-![笔记](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_books.png)
-
-markdown页面
-![markdown](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_markdown.png)
-
------
-## 项目地址
-
-- [github](https://github.com/xupingmao/xnote)
-- [gitee](https://gitee.com/xupingmao/xnote)
-
-如果使用过程中遇到问题，欢迎在项目主页提issue或者评论。
-
-## 安装&运行
-
-### Docker-compose
-1. 创建持久化数据目录 ```mkdir data```
-2. 创建配置文件 `mv ./config/boot/boot.default.properties ./boot.properties`
-3. 修改boot.properties
-4. ```docker-compose up -d```
-
-### 物理机安装
-
-#### 安装依赖环境
-
-- Python >= 3.6
-- 安装依赖的软件包
-    - 最小化安装(使用sqlite) `python3 -m pip install -r config/requirements.min.txt`
-    - Mac/Linux执行 ```python -m pip install -r config/requirements.txt```
-    - Windows执行 `python -m pip install -r config/requirements.win.txt`
-
-#### 配置和启动
-
-
-默认的配置文件位于`config/boot/boot.default.properties`，具体的功能参考配置的注释
-
-```sh
-# 切换到xnote目录
-> cd xnote
-# 复制配置并且进行自定义配置
-> cp config/boot/boot.min.properties boot.local.properties
-# 启动
-> python3 app.py --config boot.local.properties
-```
-
-如果不修改端口号，启动之后在浏览器打开 http://localhost:1234/ 就可以使用了，初始化的管理员账号是admin，默认密码是 123456
-
-### 在云服务平台部署
-
-- 新浪SAE TODO
-- [CentOS - 百度BAE](https://blog.csdn.net/u011320646/article/details/126334377) 
-
-## 主要功能
-
-### 笔记管理
-- 支持多种格式：markdown/表格/相册/列表
-- 组织功能：通过笔记本/标签/优先级来管理文档
-- 分享功能：在笔记的详情页面，点击【更多】下拉列表里面的分享，可以将文章分享给未登录用户查看
-- 优先级管理：置顶、归档功能
-- 备份功能：笔记的修改历史
-- 搜索功能：支持整个知识库搜索和项目内搜索
-- 评论功能：支持登录用户的评论
-- 访问统计：最近、常用的访问统计
-- 其他文档工具
-
-### 文件管理
-- 多种视图：列表、网格
-- 文件操作：文件上传、下载、新建、删除、重命名、移动等操作
-- 文件工具：代码编辑器、文本阅读器、二进制查看器、文件内容搜索等等
-- 大文件支持：文件下载支持断点续传，支持超大文件上传（测试过1G文件）
-- 扩展：支持开发插件扩展
-
-### 工具箱
-- Python文档(pydoc)
-- 文本处理(文本对比、代码生成、密码生成)
-- 编解码工具(base64、md5、进制转换、等等)
-- 条形码、二维码生成器
-- 图像处理（合并、拆分、灰度转换）
-- 提供扩展能力，开发者可以自己开发插件
-
-## 系统扩展
-
-### 插件机制
-
-由于每个人的需求不同，单一系统很难满足，开发者可以根据自己需要编写插件来扩展系统的功能。具体可以参考文档 [插件扩展](./docs/plugins.md)。
-
-具体特性如下
-
-- 插件中可以监听系统消息，包括笔记、提醒、文件、时间、系统五种类型的消息
-- 插件可以通过`category`属性设置分类，显示在笔记、文件、系统等功能的选项入口中
-- 可以通过模板创建插件
-
-### 二次开发
-
-- xnote现在已经打包上传到pypi[xnote-web](https://pypi.org/project/xnote-web/), 这样可以通过模块化的方式进行二次开发
-
-
-## 相关文档
-- [更新日志](./docs/changelog.md)
-- [系统架构](./docs/architecture.md)
-- [编码规范](./docs/code_style.md)
-- [插件扩展](./docs/plugins.md)
-- [搜索扩展](./docs/search_extension.md)
-- [数据库迁移](./docs/db_migrate.md)
-
-## 协议
-
-- GPL
+# Xnote
+
+[![Coverage Status](https://coveralls.io/repos/github/xupingmao/xnote/badge.svg?branch=master)](https://coveralls.io/github/xupingmao/xnote?branch=master)
+![Docker Image](https://img.shields.io/docker/pulls/donjuanplatinum/xnote)
+
+xnote是一款面向个人的轻量级笔记系统，提供多种维度的数据管理功能，致力于把个人从信息过载中解放出来。它主要有如下特性
+
+- 拥有丰富的数据管理能力，支持多种笔记格式以及文件管理功能
+- 默认提供了一些常用的工具，同时提供扩展能力，用户可以编写各种插件满足自己的需求
+- 跨平台，支持Windows、Mac、Linux三大平台，可以在云服务上部署，也可以在本地运行
+- 100%自由的数据控制权，可以运行在多种数据库环境中
+- 支持小规模的多用户，面向多用户的商业场景使用请谨慎
+
+目前xnote定位是一个面向个人使用的小型笔记产品，不会重点投入以下方向
+- 大规模的多用户支持
+- 多用户协作功能
+
+如果你热爱技术爱折腾、需要多元的数据处理能力、希望完全掌控自己的文档数据，本产品将会是一个不错的尝试，欢迎试用反馈。
+
+- 体验demo网址 https://1k5u680558.goho.co/
+- 测试账号 user01/123456, user02/123456 友情提示：管理员会不定期清理数据，请勿存放重要数据
+
+以下是一些页面展示
+
+功能列表
+![功能列表](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_home.png)
+
+笔记本
+![笔记](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_books.png)
+
+markdown页面
+![markdown](https://enjoy.applinzi.com/data/files/admin/upload/2024/02/xnote_v2.9.6_markdown.png)
+
+-----
+## 项目地址
+
+- [github](https://github.com/xupingmao/xnote)
+- [gitee](https://gitee.com/xupingmao/xnote)
+
+如果使用过程中遇到问题，欢迎在项目主页提issue或者评论。
+
+## 安装&运行
+
+### Docker-compose
+1. 创建持久化数据目录 ```mkdir data```
+2. 创建配置文件 `mv ./config/boot/boot.default.properties ./boot.properties`
+3. 修改boot.properties
+4. ```docker-compose up -d```
+
+### 物理机安装
+
+#### 安装依赖环境
+
+- Python >= 3.6
+- 安装依赖的软件包
+    - 最小化安装(使用sqlite) `python3 -m pip install -r config/requirements.min.txt`
+    - Mac/Linux执行 ```python -m pip install -r config/requirements.txt```
+    - Windows执行 `python -m pip install -r config/requirements.win.txt`
+
+#### 配置和启动
+
+
+默认的配置文件位于`config/boot/boot.default.properties`，具体的功能参考配置的注释
+
+```sh
+# 切换到xnote目录
+> cd xnote
+# 复制配置并且进行自定义配置
+> cp config/boot/boot.min.properties boot.local.properties
+# 启动
+> python3 app.py --config boot.local.properties
+```
+
+如果不修改端口号，启动之后在浏览器打开 http://localhost:1234/ 就可以使用了，初始化的管理员账号是admin，默认密码是 123456
+
+### 在云服务平台部署
+
+- 新浪SAE TODO
+- [CentOS - 百度BAE](https://blog.csdn.net/u011320646/article/details/126334377) 
+
+## 主要功能
+
+### 笔记管理
+- 支持多种格式：markdown/表格/相册/列表
+- 组织功能：通过笔记本/标签/优先级来管理文档
+- 分享功能：在笔记的详情页面，点击【更多】下拉列表里面的分享，可以将文章分享给未登录用户查看
+- 优先级管理：置顶、归档功能
+- 备份功能：笔记的修改历史
+- 搜索功能：支持整个知识库搜索和项目内搜索
+- 评论功能：支持登录用户的评论
+- 访问统计：最近、常用的访问统计
+- 其他文档工具
+
+### 文件管理
+- 多种视图：列表、网格
+- 文件操作：文件上传、下载、新建、删除、重命名、移动等操作
+- 文件工具：代码编辑器、文本阅读器、二进制查看器、文件内容搜索等等
+- 大文件支持：文件下载支持断点续传，支持超大文件上传（测试过1G文件）
+- 扩展：支持开发插件扩展
+
+### 工具箱
+- Python文档(pydoc)
+- 文本处理(文本对比、代码生成、密码生成)
+- 编解码工具(base64、md5、进制转换、等等)
+- 条形码、二维码生成器
+- 图像处理（合并、拆分、灰度转换）
+- 提供扩展能力，开发者可以自己开发插件
+
+## 系统扩展
+
+### 插件机制
+
+由于每个人的需求不同，单一系统很难满足，开发者可以根据自己需要编写插件来扩展系统的功能。具体可以参考文档 [插件扩展](./docs/plugins.md)。
+
+具体特性如下
+
+- 插件中可以监听系统消息，包括笔记、提醒、文件、时间、系统五种类型的消息
+- 插件可以通过`category`属性设置分类，显示在笔记、文件、系统等功能的选项入口中
+- 可以通过模板创建插件
+
+### 二次开发
+
+- xnote现在已经打包上传到pypi[xnote-web](https://pypi.org/project/xnote-web/), 这样可以通过模块化的方式进行二次开发
+
+
+## 相关文档
+- [更新日志](./docs/changelog.md)
+- [系统架构](./docs/architecture.md)
+- [编码规范](./docs/code_style.md)
+- [插件扩展](./docs/plugins.md)
+- [搜索扩展](./docs/search_extension.md)
+- [数据库迁移](./docs/db_migrate.md)
+
+## 协议
+
+- GPL
```

### Comparing `xnote-web-0.1.0/xnote_web.egg-info/SOURCES.txt` & `xnote-web-0.1.1/xnote_web.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -170,14 +170,15 @@
 handlers/dict/page/dict_update.html
 handlers/dict/page/relevant_list.html
 handlers/fs/__init__.py
 handlers/fs/fs.py
 handlers/fs/fs_add.py
 handlers/fs/fs_api.py
 handlers/fs/fs_cache.py
+handlers/fs/fs_checker.py
 handlers/fs/fs_find.py
 handlers/fs/fs_helper.py
 handlers/fs/fs_hex.py
 handlers/fs/fs_image.py
 handlers/fs/fs_index.py
 handlers/fs/fs_mode.py
 handlers/fs/fs_plugins.py
@@ -899,14 +900,15 @@
 tests/test_note.py
 tests/test_search.py
 tests/test_service.py
 tests/test_system_sync.py
 tests/test_user.py
 tests/test_xauth.py
 tests/test_xmanager.py
+tests/test_xtemplate.py
 tests/test_xutils.py
 tests/test_xutils_cache.py
 tests/test_xutils_db.py
 tests/test_xutils_db_hash_table.py
 tests/test_xutils_db_table.py
 tests/test_xutils_sqldb.py
 xnote/__init__.py
@@ -925,14 +927,15 @@
 xnote/core/xtables.py
 xnote/core/xtables_kv.py
 xnote/core/xtemplate.py
 xnote/plugin/__init__.py
 xnote/plugin/component.py
 xnote/plugin/form.py
 xnote/plugin/plugin.py
+xnote/plugin/tab.py
 xnote/plugin/table.py
 xnote/plugin/table_plugin.py
 xnote/service/__init__.py
 xnote/service/comment_service.py
 xnote/service/job_service.py
 xnote/service/lock_service.py
 xnote/service/tag_service.py
```

### Comparing `xnote-web-0.1.0/xutils/__init__.py` & `xnote-web-0.1.1/xutils/__init__.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,329 +1,297 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2016/12/09
-# @modified 2022/04/03 22:15:46
-
-"""xnote工具类总入口
-xutils是暴露出去的统一接口，类似于windows.h一样
-建议通过xutils暴露统一接口，其他的utils由xutils导入
-
-"""
-from __future__ import print_function
-from __future__ import absolute_import
-
-import shutil
-import subprocess
-import logging
-import logging.handlers
-from threading import current_thread
-
-from xutils.imports import *
-# xnote工具
-import xutils.textutil as textutil
-import xutils.ziputil as ziputil
-import xutils.fsutil as fsutil
-import xutils.logutil as logutil
-import xutils.dateutil as dateutil
-import xutils.htmlutil as htmlutil
-
-from xutils.ziputil import *
-from xutils.netutil import splithost, http_get, http_post
-from xutils.textutil import *
-from xutils.dateutil import *
-from xutils.netutil  import *
-from xutils.fsutil   import *
-from xutils.cacheutil import cache, cache_get, cache_put, cache_del
-from xutils.functions import History, MemTable, listremove
-
-# TODO xutils是最基础的库，后续会移除对xconfig的依赖，xutils会提供配置的函数出去在上层进行配置
-from xutils.base import Storage, print_exc, print_stacktrace
-from xutils.logutil import *
-from xutils.webutil import *
-from xutils.exeutil import *
-from xutils.func_util import *
-
-FS_IMG_EXT_LIST = []
-FS_TEXT_EXT_LIST = []
-FS_AUDIO_EXT_LIST = []
-FS_CODE_EXT_LIST = []
-IS_TEST = []
-
-#################################################################
-
-wday_map = {
-    "no-repeat": "一次性",
-    "*": "每天",
-    "1": "周一",
-    "2": "周二",
-    "3": "周三",
-    "4": "周四",
-    "5": "周五",
-    "6": "周六",
-    "7": "周日"
-}
-
-def print_table_row(row, max_length):
-    for item in row:
-        print(str(item)[:max_length].ljust(max_length), end='')
-    print('')
-
-def print_table(data, max_length=20, headings = None, ignore_attrs = None):
-    '''打印表格数据'''
-    if len(data) == 0:
-        return
-    if headings is None:
-        headings = list(data[0].keys())
-    if ignore_attrs:
-        for key in ignore_attrs:
-            if key in headings:
-                headings.remove(key)
-    print_table_row(headings, max_length)
-    for item in data:
-        row = map(lambda key:item.get(key), headings)
-        print_table_row(row, max_length)
-
-class SearchResult(dict):
-
-    def __init__(self, name=None, url='#', raw=None):
-        self.name = name
-        self.url = url
-        self.raw = raw
-
-    def __getattr__(self, key): 
-        try:
-            return self[key]
-        except KeyError as k:
-            return None
-    
-    def __setattr__(self, key, value): 
-        self[key] = value
-
-    def __delattr__(self, key):
-        try:
-            del self[key]
-        except KeyError as k:
-            raise AttributeError(k)
-
-#################################################################
-##   File System Utilities
-##   @see fsutil
-#################################################################
-
-def do_check_file_type(filename, target_set):
-    """根据文件后缀判断是否是图片"""
-    if filename.endswith(".x0"):
-        filename = fsutil.decode_name(filename)
-    name, ext = os.path.splitext(filename)
-    return ext.lower() in target_set
-
-def is_img_file(filename):
-    """根据文件后缀判断是否是图片"""
-    return do_check_file_type(filename, FS_IMG_EXT_LIST)
-
-def is_text_file(filename):
-    """根据文件后缀判断是否是文本文件"""
-    return do_check_file_type(filename, FS_TEXT_EXT_LIST)
-
-def is_audio_file(filename):
-    return do_check_file_type(filename, FS_AUDIO_EXT_LIST)
-
-def is_code_file(filename):
-    return do_check_file_type(filename, FS_CODE_EXT_LIST)
-
-def get_text_ext():
-    return FS_TEXT_EXT_LIST
-
-def is_editable(fpath):
-    return is_text_file(fpath) or is_code_file(fpath)
-
-def attrget(obj, attr, default_value = None):
-    if hasattr(obj, attr):
-        return getattr(obj, attr, default_value)
-    else:
-        return default_value
-
-### DB Utilities
-
-def db_execute(path, sql, args = None):
-    from xutils.base import Storage
-    db = sqlite3.connect(path)
-    cursorobj = db.cursor()
-    kv_result = []
-    try:
-        # print(sql)
-        if args is None:
-            cursorobj.execute(sql)
-        else:
-            cursorobj.execute(sql, args)
-        result = cursorobj.fetchall()
-        # result.rowcount
-        db.commit()
-        for single in result:
-            resultMap = Storage()
-            for i, desc in enumerate(cursorobj.description):
-                name = desc[0]
-                resultMap[name] = single[i]
-            kv_result.append(resultMap)
-
-    except Exception as e:
-        raise e
-    finally:
-        db.close()
-    return kv_result
-
-#################################################################
-##   Str Utilities
-#################################################################
-
-def json_str(**kw):
-    return json.dumps(kw)
-
-def decode_bytes(bytes):
-    for encoding in ["utf-8", "gbk", "mbcs", "latin_1"]:
-        try:
-            return bytes.decode(encoding)
-        except:
-            pass
-    return None
-
-
-def obj2dict(obj):
-    if obj == None:
-        return None
-    return dict(**obj.__dict__)
-
-#################################################################
-##   Platform/OS Utilities, Python 2 do not have this file
-#################################################################
-
-def system(cmd, cwd = None):
-    p = subprocess.Popen(cmd, cwd=cwd, 
-                                 shell=True, 
-                                 stdout=subprocess.PIPE, 
-                                 stderr=subprocess.PIPE)
-    # out = p.stdout.read()
-    # err = p.stderr.read()
-    # if PY2:
-    #     encoding = sys.getfilesystemencoding()
-    #     os.system(cmd.encode(encoding))
-    # else:
-    #     os.system(cmd)
-
-def is_windows():
-    return os.name == "nt"
-
-def is_mac():
-    return platform.system() == "Darwin"
-
-def is_linux():
-    return os.name == "linux"
-
-def mac_say(msg):
-    def escape(str):
-        new_str_list = ['"']
-        for c in str:
-            if c != '"':
-                new_str_list.append(c)
-            else:
-                new_str_list.append('\\"')
-        new_str_list.append('"')
-        return ''.join(new_str_list)
-
-    msglist = re.split(r"[,.;?!():，。？！；：\n\"'<>《》\[\]]", msg)
-    for m in msglist:
-        m = m.strip()
-        if m == "":
-            continue
-        cmd = u("say %s") % escape(m)
-        trace("MacSay", cmd)
-        os.system(cmd.encode("utf-8"))
-
-def windows_say(msg):
-    try:
-        import comtypes.client as cc
-        # dynamic=True不生成静态的Python代码
-        voice = cc.CreateObject("SAPI.SpVoice", dynamic=True)
-        voice.Speak(msg)
-    except ImportError:
-        logging.warning("没有安装comtypes")
-    except:
-        print_exc()
-
-def say(msg):
-    if IS_TEST:
-        return
-    if is_windows():
-        windows_say(msg)
-    elif is_mac():
-        mac_say(msg)
-    else:
-        # 防止调用语音API的程序没有正确处理循环
-        time.sleep(0.5)
-
-#################################################################
-##   规则引擎组件
-#################################################################
-
-class BaseRule:
-    """规则引擎基类"""
-
-    def __init__(self, pattern=None):
-        self.pattern = pattern
-
-    def match(self, ctx, input_str = None):
-        if input_str is not None:
-            return re.match(self.pattern, input_str)
-        return None
-
-    def match_execute(self, ctx, input_str = None):
-        try:
-            matched = self.match(ctx, input_str)
-            if matched:
-                self.execute(ctx, *matched.groups())
-        except Exception as e:
-            print_exc()
-
-    def execute(self, ctx, *argv):
-        raise NotImplementedError()
-
-class RecordInfo:
-
-    def __init__(self, name, url):
-        self.name = name
-        self.url  = url
-
-class RecordList:
-    """访问记录，可以统计最近访问的，最多访问的记录"""
-    def __init__(self, max_size = 1000):
-        self.max_size   = max_size
-        self.records    = []
-
-    def visit(self, name, url=None):
-        self.records.append(RecordInfo(name, url))
-        if len(self.records) > self.max_size:
-            del self.records[0]
-
-    def recent(self, count=5):
-        records = self.records[-count:]
-        records.reverse()
-        return records
-
-    def most(self, count):
-        return []
-
-
-def init(config, pool_size = 2000, thread_size = 5):
-    global FS_IMG_EXT_LIST
-    global FS_TEXT_EXT_LIST
-    global FS_AUDIO_EXT_LIST
-    global FS_CODE_EXT_LIST
-    global IS_TEST
-
-    FS_TEXT_EXT_LIST  = config.FS_TEXT_EXT_LIST
-    FS_IMG_EXT_LIST   = config.FS_IMG_EXT_LIST
-    FS_AUDIO_EXT_LIST = config.FS_AUDIO_EXT_LIST
-    FS_CODE_EXT_LIST  = config.FS_CODE_EXT_LIST
-    IS_TEST           = config.IS_TEST
-    
-    xutils.webutil.init_webutil_env(is_test = IS_TEST)
-    logutil.init_async_pool(pool_size=pool_size, thread_size=thread_size)
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2016/12/09
+# @modified 2022/04/03 22:15:46
+
+"""xnote工具类总入口
+xutils是暴露出去的统一接口，类似于windows.h一样
+建议通过xutils暴露统一接口，其他的utils由xutils导入
+
+"""
+from __future__ import print_function
+from __future__ import absolute_import
+
+import shutil
+import subprocess
+import logging
+import logging.handlers
+from threading import current_thread
+
+from xutils.imports import *
+# xnote工具
+import xutils.textutil as textutil
+import xutils.ziputil as ziputil
+import xutils.fsutil as fsutil
+import xutils.logutil as logutil
+import xutils.dateutil as dateutil
+import xutils.htmlutil as htmlutil
+
+from xutils.ziputil import *
+from xutils.netutil import splithost, http_get, http_post
+from xutils.textutil import *
+from xutils.dateutil import *
+from xutils.netutil  import *
+from xutils.fsutil   import *
+from xutils.cacheutil import cache, cache_get, cache_put, cache_del
+from xutils.functions import History, MemTable, listremove
+
+# TODO xutils是最基础的库，后续会移除对xconfig的依赖，xutils会提供配置的函数出去在上层进行配置
+from xutils.base import Storage, print_exc, print_stacktrace, XnoteException
+from xutils.logutil import *
+from xutils.webutil import *
+from xutils.exeutil import *
+from xutils.func_util import *
+
+FS_IMG_EXT_LIST = []
+FS_TEXT_EXT_LIST = []
+FS_AUDIO_EXT_LIST = []
+FS_CODE_EXT_LIST = []
+IS_TEST = []
+
+#################################################################
+
+wday_map = {
+    "no-repeat": "一次性",
+    "*": "每天",
+    "1": "周一",
+    "2": "周二",
+    "3": "周三",
+    "4": "周四",
+    "5": "周五",
+    "6": "周六",
+    "7": "周日"
+}
+
+def print_table_row(row, max_length):
+    for item in row:
+        print(str(item)[:max_length].ljust(max_length), end='')
+    print('')
+
+def print_table(data, max_length=20, headings = None, ignore_attrs = None):
+    '''打印表格数据'''
+    if len(data) == 0:
+        return
+    if headings is None:
+        headings = list(data[0].keys())
+    if ignore_attrs:
+        for key in ignore_attrs:
+            if key in headings:
+                headings.remove(key)
+    print_table_row(headings, max_length)
+    for item in data:
+        row = map(lambda key:item.get(key), headings)
+        print_table_row(row, max_length)
+
+class SearchResult(dict):
+
+    def __init__(self, name=None, url='#', raw=None):
+        self.name = name
+        self.url = url
+        self.raw = raw
+
+    def __getattr__(self, key): 
+        try:
+            return self[key]
+        except KeyError as k:
+            return None
+    
+    def __setattr__(self, key, value): 
+        self[key] = value
+
+    def __delattr__(self, key):
+        try:
+            del self[key]
+        except KeyError as k:
+            raise AttributeError(k)
+
+def attrget(obj, attr, default_value = None):
+    if hasattr(obj, attr):
+        return getattr(obj, attr, default_value)
+    else:
+        return default_value
+
+### DB Utilities
+
+def db_execute(path, sql, args = None):
+    from xutils.base import Storage
+    db = sqlite3.connect(path)
+    cursorobj = db.cursor()
+    kv_result = []
+    try:
+        # print(sql)
+        if args is None:
+            cursorobj.execute(sql)
+        else:
+            cursorobj.execute(sql, args)
+        result = cursorobj.fetchall()
+        # result.rowcount
+        db.commit()
+        for single in result:
+            resultMap = Storage()
+            for i, desc in enumerate(cursorobj.description):
+                name = desc[0]
+                resultMap[name] = single[i]
+            kv_result.append(resultMap)
+
+    except Exception as e:
+        raise e
+    finally:
+        db.close()
+    return kv_result
+
+#################################################################
+##   Str Utilities
+#################################################################
+
+def json_str(**kw):
+    return json.dumps(kw)
+
+def decode_bytes(bytes):
+    for encoding in ["utf-8", "gbk", "mbcs", "latin_1"]:
+        try:
+            return bytes.decode(encoding)
+        except:
+            pass
+    return None
+
+
+def obj2dict(obj):
+    if obj == None:
+        return None
+    return dict(**obj.__dict__)
+
+#################################################################
+##   Platform/OS Utilities, Python 2 do not have this file
+#################################################################
+
+def system(cmd, cwd = None):
+    p = subprocess.Popen(cmd, cwd=cwd, 
+                                 shell=True, 
+                                 stdout=subprocess.PIPE, 
+                                 stderr=subprocess.PIPE)
+    # out = p.stdout.read()
+    # err = p.stderr.read()
+    # if PY2:
+    #     encoding = sys.getfilesystemencoding()
+    #     os.system(cmd.encode(encoding))
+    # else:
+    #     os.system(cmd)
+
+def is_windows():
+    return os.name == "nt"
+
+def is_mac():
+    return platform.system() == "Darwin"
+
+def is_linux():
+    return os.name == "linux"
+
+def mac_say(msg):
+    def escape(str):
+        new_str_list = ['"']
+        for c in str:
+            if c != '"':
+                new_str_list.append(c)
+            else:
+                new_str_list.append('\\"')
+        new_str_list.append('"')
+        return ''.join(new_str_list)
+
+    msglist = re.split(r"[,.;?!():，。？！；：\n\"'<>《》\[\]]", msg)
+    for m in msglist:
+        m = m.strip()
+        if m == "":
+            continue
+        cmd = u("say %s") % escape(m)
+        trace("MacSay", cmd)
+        os.system(cmd.encode("utf-8"))
+
+def windows_say(msg):
+    try:
+        import comtypes.client as cc
+        # dynamic=True不生成静态的Python代码
+        voice = cc.CreateObject("SAPI.SpVoice", dynamic=True)
+        voice.Speak(msg)
+    except ImportError:
+        logging.warning("没有安装comtypes")
+    except:
+        print_exc()
+
+def say(msg):
+    if IS_TEST:
+        return
+    if is_windows():
+        windows_say(msg)
+    elif is_mac():
+        mac_say(msg)
+    else:
+        # 防止调用语音API的程序没有正确处理循环
+        time.sleep(0.5)
+
+#################################################################
+##   规则引擎组件
+#################################################################
+
+class BaseRule:
+    """规则引擎基类"""
+
+    def __init__(self, pattern=None):
+        self.pattern = pattern
+
+    def match(self, ctx, input_str = None):
+        if input_str is not None:
+            return re.match(self.pattern, input_str)
+        return None
+
+    def match_execute(self, ctx, input_str = None):
+        try:
+            matched = self.match(ctx, input_str)
+            if matched:
+                self.execute(ctx, *matched.groups())
+        except Exception as e:
+            print_exc()
+
+    def execute(self, ctx, *argv):
+        raise NotImplementedError()
+
+class RecordInfo:
+
+    def __init__(self, name, url):
+        self.name = name
+        self.url  = url
+
+class RecordList:
+    """访问记录，可以统计最近访问的，最多访问的记录"""
+    def __init__(self, max_size = 1000):
+        self.max_size   = max_size
+        self.records    = []
+
+    def visit(self, name, url=None):
+        self.records.append(RecordInfo(name, url))
+        if len(self.records) > self.max_size:
+            del self.records[0]
+
+    def recent(self, count=5):
+        records = self.records[-count:]
+        records.reverse()
+        return records
+
+    def most(self, count):
+        return []
+
+
+def init(config, pool_size = 2000, thread_size = 5):
+    global FS_IMG_EXT_LIST
+    global FS_TEXT_EXT_LIST
+    global FS_AUDIO_EXT_LIST
+    global FS_CODE_EXT_LIST
+    global IS_TEST
+
+    FS_TEXT_EXT_LIST  = config.FS_TEXT_EXT_LIST
+    FS_IMG_EXT_LIST   = config.FS_IMG_EXT_LIST
+    FS_AUDIO_EXT_LIST = config.FS_AUDIO_EXT_LIST
+    FS_CODE_EXT_LIST  = config.FS_CODE_EXT_LIST
+    IS_TEST           = config.IS_TEST
+    
+    xutils.webutil.init_webutil_env(is_test = IS_TEST)
+    logutil.init_async_pool(pool_size=pool_size, thread_size=thread_size)
```

### Comparing `xnote-web-0.1.0/xutils/base.py` & `xnote-web-0.1.1/xutils/base.py`

 * *Files 18% similar despite different names*

```diff
@@ -63,14 +63,20 @@
             result[key] = copy.deepcopy(value)
         return result
     
     def __repr__(self):     
         return '<MyStorage ' + dict.__repr__(self) + '>'
 
 
+class XnoteException(Exception):
+    def __init__(self, code="500", message=""):
+        super(XnoteException, self).__init__(message)
+        self.code = code
+        self.message = message
+
 
 def print_exc():
     """打印系统异常堆栈"""
     exc_info = traceback.format_exc()
     print(exc_info)
     return exc_info
```

### Comparing `xnote-web-0.1.0/xutils/cacheutil.py` & `xnote-web-0.1.1/xutils/cacheutil.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,785 +1,785 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2018/06/07 22:10:11
-# @modified 2022/04/04 13:42:52
-"""持久化操作已经禁用，请使用dbutil
-PS: 标准库 functools提供了缓存的方法， 参考 https://docs.python.org/zh-cn/3/library/functools.html
-
-
-缓存的实现，API列表如下
-
-* cache(key = None, prefix = None, expire = 600) 缓存装饰器，用于加速函数调用
-* cache_put(key, value, expire = -1) 写入缓存
-* cache_get(key, default_value = None) 读取缓存
-* cache_del(key)  删除缓存
-
-失效的检查策略
-1. 读取时检查失效
-2. 生成新的缓存时从队列中取出多个缓存进行检查
-
-~~持久化策略~~
-1. 初始化的时候从文件中读取，运行过程中直接从内存读取
-2. 创建或者更新的时候持久化到文件
-3. TODO 考虑持久化时的并发控制
-
-
-淘汰置换规则（仅用于会失效的缓存）
-1. FIFO, First In First Out
-2. LRU, Least Recently Used
-3. LFU, Least Frequently Used
-
-* 参考redis的API
-* TODO: 可以使用 BitCask 存储模型实现
-"""
-import threading
-import random
-import datetime
-import time
-import re
-import os
-import json
-import inspect
-import sys
-import traceback
-import base64
-
-from xutils import dateutil
-from collections import OrderedDict, deque
-from xutils import interfaces, Storage
-from xutils.db.dbutil_cache import DatabaseCache
-from xutils.base import is_str
-
-_cache_dict = dict()
-_cache_queue = deque()
-
-class CacheConfig:
-    """缓存配置"""
-    storage_dir = ""
-
-def encode_key(text):
-    """编码key为文件名"""
-    return text + ".json"
-    # return base64.urlsafe_b64encode(text.encode("utf-8")).decode("utf-8") + ".pk"
-
-
-def decode_key(text):
-    """解码文件名称为key值，暂时没有使用"""
-    return base64.urlsafe_b64decode(text[:-3].encode("utf-8")).decode("utf-8")
-
-
-def format_key(key):
-    """格式化key，先简单实现一版"""
-    result = []
-    for c in key:
-        if c == "/":
-            result.append("%47")
-        elif c == "%":
-            result.append("%25")
-        elif c == ":":
-            result.append("%58")
-        else:
-            result.append(c)
-    return "".join(result)
-
-
-def log_debug(msg):
-    # print(msg)
-    pass
-
-
-def log_error(msg):
-    print(msg)
-
-class JsonSerializer:
-    """缓存编码器"""
-
-    def format_value(self, value):
-        if isinstance(value, dict):
-            result = dict()
-            for key in value:
-                item_value = value.get(key)
-                if isinstance(item_value, datetime.datetime):
-                    result[key] = dateutil.format_datetime(item_value)
-                else:
-                    result[key] = item_value
-            return result
-        return value
-    
-    def _fix_storage(self, obj):
-        if isinstance(obj, dict):
-            return Storage(**obj)
-        if isinstance(obj, list):
-            for index, item in enumerate(obj):
-                if isinstance(item, dict):
-                    obj[index] = Storage(**item)
-            return obj
-        return obj
-
-    def encode(self, value):
-        if isinstance(value, bytes):
-            return value
-        else:
-            formatted_value = self.format_value(value)
-            return json.dumps(formatted_value) # 转成json，要保证能够序列化
-
-    def decode(self, value):
-        if isinstance(value, bytes):
-            obj = value
-        else:
-            obj = json.loads(value)
-        return self._fix_storage(obj)
-
-class MemoryCache(interfaces.CacheInterface):
-    """缓存实现,一般情况下不要直接用它,优先使用 PrefixedCache, 这样便于迁移到Redis之类的分布式缓存"""
-
-    def __init__(self, max_size = -1, serializer=JsonSerializer()):
-        self.dict = OrderedDict()
-        self.expire_dict = dict()
-        self.max_size = max_size
-        self.lock = threading.RLock()
-        self.serializer = serializer
-
-    def get(self, key, default_value=None):
-        assert isinstance(key, str), key
-        value = self.dict.get(key)
-        if value != None:
-            if self.is_alive(key):
-                self.dict[key] = value # 移到最后面
-                return self.serializer.decode(value)
-            else:
-                self.delete(key)
-        return default_value
-    
-    def get_raw(self, key):
-        return self.dict.get(key)
-
-    def put(self, key, value, expire=60*5, random_range=60*5):
-        assert expire > 0
-        with self.lock:
-            self.dict[key] = self.serializer.encode(value)
-            self.expire_dict[key] = time.time() + expire + random.randint(0, random_range)
-            
-            if self.max_size > 0:
-                self.check_size_and_clear()
-
-    def is_alive(self, key):
-        value = self.expire_dict.get(key, 60*5)
-        return value > time.time()
-    
-    def delete(self, key):
-        has_delete = False
-        with self.lock:
-            if key in self.dict:
-                del self.dict[key]
-                has_delete = True
-            if key in self.expire_dict:
-                del self.expire_dict[key]
-                has_delete = True
-        return has_delete
-
-    def check_size_and_clear(self):
-        if self.max_size <= 0:
-            return
-
-        while len(self.dict) > self.max_size:
-            key, value = self.dict.popitem(last=False) # 弹出第一个
-            self.delete(key)
-    
-    def get_expire(self, key):
-        return self.expire_dict.get(key)
-
-    def keys(self):
-        return list(self.dict.keys())
-    
-    def clear_expired(self):
-        """清理失效的缓存"""
-        for key in self.keys():
-            if not self.is_alive(key):
-                self.delete(key)
-
-class DummyCache:
-    """用于禁用缓存, 兼容缓存的API"""
-
-    def __init__(self, max_size=-1):
-        pass
-
-    def get(self, key):
-        return None
-    
-    def put(self, key, value, expire=-1):
-        pass
-
-    def delete(self, key):
-        pass
-
-class Cache(MemoryCache):
-    pass
-
-_global_cache = MemoryCache(max_size=1000)
-
-class PrefixedCache:
-
-    def __init__(self, prefix="", cache_engine=interfaces.empty_cache):
-        self.prefix = prefix
-        if cache_engine == interfaces.empty_cache:
-            self.cache = _global_cache
-        else:
-            self.cache = cache_engine
-    
-    def get(self, key, default_value=None):
-        return self.cache.get(self.prefix + key, default_value=default_value)
-    
-    def get_dict(self, key, default_value=None):
-        value = self.cache.get(self.prefix + key, default_value=default_value)
-        if value == None:
-            return None
-        assert isinstance(value, dict)
-        return value
-    
-    def put(self, key, value, expire=60*5):
-        return self.cache.put(self.prefix+key, value, expire)
-    
-    def put_empty(self, key, expire=5):
-        """针对空值的特殊处理"""
-        return self.cache.put(self.prefix+key, "$empty", expire)
-    
-    def is_empty(self, value):
-        return value == "$empty"
-    
-    def delete(self, key):
-        return self.cache.delete(self.prefix + key)
-
-def get_global_cache():
-    return _global_cache
-
-
-class MultiLevelCache(interfaces.CacheInterface):
-    """基于内存+数据库的多级缓存"""
-
-    def __init__(self):
-        self.database_cache = DatabaseCache()
-        self.mem_cache = _global_cache
-        self.mem_cache_expire = 60
-
-    def get(self, key, default_value=None):
-        # 先查内存缓存
-        value = self.mem_cache.get(key)
-        if value == None:
-            # 如果查不到，查数据库缓存
-            value = self.database_cache.get(key)
-            if value != None:
-                self.mem_cache.put(key, value)
-        if value == None:
-            return default_value
-        return value
-    
-    def put(self, key, value, expire = -1, expire_random = 600):
-        self.database_cache.put(key, value, expire=expire, expire_random=expire_random)
-        self.mem_cache.put(key, value, expire=self.mem_cache_expire)
-    
-    def delete(self, key):
-        self.database_cache.delete(key)
-        self.mem_cache.delete(key)
-
-class CacheObj:
-    """缓存对象，包含缓存的key和value，有一个公共的缓存队列
-    每次生成一个会从缓存队列中取出一个检查是否失效，同时把自己放入队列
-    TODO 提供按照大小过滤的规则
-    """
-    # 缓存的最大容量，用于集合类型
-    max_size = -1
-    valid_key_pattern = re.compile(r"^[0-9a-zA-Z\[\]_\-\.\(\)\@\#,'\"\$ ]+$")
-
-    def __init__(self, key, value, expire=-1, type="object", need_save=True):
-        global _cache_dict
-        global _cache_queue
-
-        self.check_key_value(key, value)
-
-        self.key = key
-        self.value = value
-        self.expire = expire
-        self.expire_time = time.time() + expire
-        self.type = type
-        self.is_force_expired = False
-
-        if type == "zset" and not isinstance(value, OrderedDict):
-            value = OrderedDict(**value)
-            self.value = value
-
-        if expire < 0:
-            self.expire_time = -1
-
-        obj = _cache_dict.get(key, None)
-        if obj is not None:
-            obj.is_force_expired = True
-
-        if need_save:
-            self.save()
-
-        _cache_queue.append(self)
-
-        # find and clear expired cache objects
-        try:
-            for i in range(3):
-                if len(_cache_queue) == 0:
-                    break
-                one = _cache_queue.popleft()
-                if one is not None:
-                    if one.is_force_expired == True:
-                        continue
-                    if one.is_alive():
-                        _cache_queue.append(one)
-                    else:
-                        one.clear()
-        except:
-            # queue.Empty异常
-            print_exc()
-
-    def check_key_value(self, key, value):
-        if key is None:
-            raise ValueError("key cannot be None")
-        if value is None:
-            raise ValueError("invalid key: value is None")
-        if len(key) > 200:
-            raise ValueError("invalid key: len(key)>200")
-
-    def is_valid_key(self, key):
-        return self.valid_key_pattern.match(key) != None
-
-    def _get_path(self, key):
-        assert CacheConfig.storage_dir != ""
-        return os.path.join(CacheConfig.storage_dir, key + ".json")
-
-    def get_dump_value(self):
-        if self.type == "zset":
-            return dict(**self.value)
-        else:
-            return self.value
-
-    def save(self, method_name="save"):
-        _cache_dict[self.key] = self
-        if self.is_temp():
-            return
-
-        # save to disk
-        raise Exception(
-            "cacheutil.%s to disk is no longer supprted, please use dbutil" % method_name)
-
-
-    def is_alive(self):
-        if self.is_force_expired:
-            return False
-        if self.expire_time < 0:
-            return True
-        return time.time() < self.expire_time
-
-    def is_temp(self):
-        return self.expire_time > 0
-
-    def get_value(self):
-        if self.is_alive():
-            return self.value
-        self.clear()
-        return None
-
-    def clear(self):
-        log_debug("clear cache %s" % self.key)
-        # 标记为删除，用于清除queue中的引用
-        self.is_force_expired = True
-        _cache_dict.pop(self.key, None)
-        if self.is_temp():
-            return
-        # remove from disk
-        path = self._get_path(self.key)
-        if os.path.exists(path):
-            os.remove(path)
-
-
-def cache_deco(key=None, prefix=None, expire=600, expire_random=600):
-    """缓存的装饰器，会自动清理失效的缓存
-    注意：不考虑持久化，如果有持久化需要使用db实现
-    @param {str} key    指定缓存的key，也就是使用固定的key
-    @param {str} prefix 指定缓存的前缀，使用前缀+函数参数的方式，也就是动态的key
-    如果 key 和prefix 都不指定，使用函数签名+函数参数的方式，生成动态的key
-    """
-    if key != None and prefix != None:
-        raise Exception("不能同时设置key和prefix参数")
-
-    def deco(func):
-        # 先不支持keywords参数
-        def handle(*args):
-            if key is not None:
-                cache_key = key
-            elif prefix is None:
-                mod = inspect.getmodule(func)
-                funcname = func.__name__
-                cache_key = "%s.%s%s" % (mod.__name__, funcname, args)
-            else:
-                cache_key = "%s%s" % (prefix, args)
-
-            cache_value = _global_cache.get(key=cache_key)
-            if cache_value is not None:
-                return cache_value
-            value = func(*args)
-            if value is None:
-                _global_cache.delete(key=cache_key)
-                return None
-
-            _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
-            return value
-        return handle
-    return deco
-
-
-def cache_call(cache_key, func, expire=600, expire_random=600):
-    """带缓存的函数调用,这种方式可以生成可读性更高的cache_key"""
-    assert isinstance(cache_key, str)
-    cache_value = _global_cache.get(key=cache_key)
-    if cache_value is not None:
-        return cache_value
-    value = func()
-    if value is None:
-        _global_cache.delete(key=cache_key)
-        return None
-
-    _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
-    return value
-
-def kw_cache_deco(prefix="", expire=600, expire_random=600):
-    """缓存的装饰器，会自动清理失效的缓存
-    注意：不考虑持久化，如果有持久化需要使用db实现
-    @param {str} key    指定缓存的key，也就是使用固定的key
-    @param {str} prefix 指定缓存的前缀，使用前缀+函数参数的方式，也就是动态的key
-    如果 key 和prefix 都不指定，使用函数签名+函数参数的方式，生成动态的key
-    """
-    assert prefix != ""
-
-    def deco(func):
-        # 先不支持keywords参数
-        def handle(*args, **kw):
-            cache_key = "%s(%s_%s)" % (prefix, args, kw)
-            cache_value = _global_cache.get(key=cache_key)
-            if cache_value is not None:
-                return cache_value
-            value = func(*args, **kw)
-            if value is None:
-                _global_cache.delete(key=cache_key)
-                return None
-
-            _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
-            return value
-        return handle
-    return deco
-
-
-def cache(*args, **kw):
-    return cache_deco(*args, **kw)
-
-
-def put(key, value=None, expire=-1):
-    """设置缓存的值
-    @param {object} value value对象必须可以json序列化，如果value为None，会删除key对应的对象
-    @param {integer} expire 失效时间，单位秒，如果小于等于0认为不失效，会持久化到文件
-    """
-    return _global_cache.put(key, value=value, expire=expire)
-
-
-def get(key, default_value=None):
-    """读取缓存对象
-    @param {object} default_value 如果缓存对象不存在，返回default_value
-    """
-    return _global_cache.get(key=key, default_value=default_value)
-
-
-def delete(key=None, prefix=None, args=None):
-    """使key对应的缓存失效，成功返回True
-    del与python关键字冲突
-    @param {string} key 缓存的key
-    """
-    if key == None:
-        key = "%s%s" % (prefix, args)
-    return _global_cache.delete(key=key)
-
-
-def prefix_del(prefix):
-    """使用前缀删除"""
-    for key in _global_cache.dict:
-        if key.startswith(prefix):
-            _global_cache.delete(key)
-
-
-# 方法别名
-cache_get = get
-cache_put = put
-cache_del = delete
-set = put
-
-
-def get_cache_obj(key, default_value=None, type=None):
-    if not is_str(key):
-        raise TypeError("cache key must be string")
-    obj = _cache_dict.get(key)
-    if obj is None:
-        return default_value
-    if obj.is_alive():
-        if type != None and type != obj.type:
-            raise TypeError("expect %s but found %s" % (type, obj.type))
-        return obj
-    obj.clear()
-    return None
-
-
-def update_cache_by_key(key):
-    """直接通过key来更新缓存，前提是缓存已经存在"""
-    obj = _cache_dict.get(key)
-    if obj != None:
-        func = obj.func
-        args = obj.args
-        obj.value = func(*args)
-
-
-def lpush(key, value):
-    obj = get_cache_obj(key, type="list")
-    if obj != None and obj.value != None:
-        obj.value.insert(0, value)
-        obj.save()
-    else:
-        obj = CacheObj(key, [value], type="list")
-        obj.save()
-
-
-def rpush(key, value):
-    obj = get_cache_obj(key, type="list")
-    if obj != None and obj.value != None:
-        obj.value.append(value)
-        obj.save()
-    else:
-        obj = CacheObj(key, [value], type="list")
-        obj.save()
-
-
-def lrange(key, start=0, stop=-1):
-    obj = get_cache_obj(key, type="list")
-    if obj != None and obj.value != None:
-        length = len(obj.value)
-        if start < 0:
-            start += length
-        if stop < 0:
-            stop += length
-        return obj.value[start: stop+1]
-    else:
-        return []
-
-
-def ltrim(key, start=0, stop=-1):
-    obj = get_cache_obj(key, type="list")
-    if obj != None and obj.value != None:
-        length = len(obj.value)
-        if start < 0:
-            start += length
-        if stop < 0:
-            stop += length
-        obj.value = obj.value[start: stop+1]
-        obj.save()
-    else:
-        pass
-
-
-def lindex(key, index):
-    obj = get_cache_obj(key, type="list")
-    if obj != None and obj.value != None:
-        length = len(obj.value)
-        if index < 0:
-            index += length
-        if index >= length or index < 0:
-            return None
-        return obj.value[index]
-    else:
-        return None
-
-
-class SortedObject:
-
-    def __init__(self, key, value):
-        self.key = key
-        self.value = value
-
-    def __lt__(self, obj):
-        return self.value < obj.value
-
-    def __cmp__(self, obj):
-        return cmp(self.value, obj.value)
-
-
-def zadd(key, score, member):
-    # TODO 双写两个列表
-    obj = get_cache_obj(key, type="zset")
-    if obj != None and obj.value != None:
-        obj.value.pop(member, None)
-        obj.value[member] = score
-        obj.type = "zset"
-        obj.save()
-    else:
-        obj = CacheObj(key, OrderedDict(), type="zset")
-        obj.value[member] = score
-        obj.save()
-
-
-def zrange(key, start, stop):
-    """zset分片，不同于Python，这里是左右包含，包含start，包含stop
-    :arg int start: 从0开始，负数表示倒数
-    :arg int stop: 从0开始，负数表示倒数
-    TODO 优化排序算法，使用有序列表+哈希表
-    """
-    obj = get_cache_obj(key)
-    if obj != None:
-        items = obj.value.items()
-        if stop == -1:
-            stop = len(items)
-        else:
-            stop += 1
-        sorted_items = sorted(items, key=lambda x: x[1])
-        sorted_keys = [k[0] for k in sorted_items]
-        return sorted_keys[start: stop]
-    return []
-
-
-def zcount(key):
-    obj = get_cache_obj(key)
-    if obj != None:
-        return len(obj.value)
-    return 0
-
-
-def zscore(key, member):
-    obj = get_cache_obj(key)
-    if obj != None:
-        return obj.value.get(member, None)
-    return None
-
-
-def zincrby(key, increment, member):
-    """通过setdefault处理并发问题"""
-    obj = get_cache_obj(key)
-    if obj != None:
-        obj.value.setdefault(member, 0)
-        obj.value[member] += increment
-        # obj.value.move_to_end(member, last=True)
-        obj.value[member] = obj.value.pop(member)
-        if obj.max_size > 0:
-            # LRU置换
-            while len(obj.value) > obj.max_size:
-                obj.value.popitem(last=False)
-        obj.save()
-    else:
-        zadd(key, increment, member)
-
-
-def zrem(key, member):
-    obj = get_cache_obj(key)
-    if obj != None:
-        value = obj.value.pop(member)
-        if value != None:
-            obj.save()
-            return 1
-        return 0
-    else:
-        return 0
-
-
-def zremrangebyrank(key, start, stop):
-    '''删除zset区间'''
-    obj = get_cache_obj(key)
-    if obj is None:
-        return 0
-    members = zrange(key, start, stop)
-    if len(members) == 0:
-        return 0
-    for member in members:
-        log_debug("del %s" % member)
-        obj.value.pop(member)
-    obj.save()
-    return len(members)
-
-
-def zmaxsize(key, max_size):
-    obj = get_cache_obj(key)
-    if obj is None:
-        return
-    obj.max_size = max_size
-
-
-def hset(key, field, value, expire=-1):
-    try:
-        obj = get_cache_obj(key, type="hash")
-        if obj != None and obj.value != None:
-            obj.value[field] = value
-            obj.type = "hash"
-            obj.save("hset")
-        else:
-            obj = CacheObj(key, dict(), type="hash", expire=expire)
-            obj.value[field] = value
-            obj.save("hset")
-    except:
-        print_exc()
-        return None
-
-
-def hget(key, field):
-    try:
-        obj = get_cache_obj(key, type="hash")
-        if obj != None and obj.value != None:
-            return obj.value.get(field)
-        else:
-            return None
-    except:
-        print_exc()
-        return None
-
-
-def hdel(key, field):
-    obj = get_cache_obj(key, type="hash")
-    if obj != None and obj.value != None:
-        if field in obj.value:
-            del obj.value[field]
-            return 1
-        return 0
-    else:
-        return 0
-
-
-def hkeys(key, field):
-    obj = get_cache_obj(key, type="hash")
-    if obj != None and obj.value != None:
-        return list(obj.value.keys())
-    else:
-        return list()
-
-
-def keys(pattern=None):
-    """返回所有缓存的key列表"""
-    return list(_cache_dict.keys())
-
-
-def print_exc():
-    """打印系统异常堆栈"""
-    ex_type, ex, tb = sys.exc_info()
-    exc_info = traceback.format_exc()
-    log_error(exc_info)
-
-
-def json_object_hook(dict_obj):
-    return Storage(**dict_obj)
-
-
-def clear_temp():
-    for key in _cache_dict.copy():
-        value = _cache_dict.get(key)
-        if value != None and value.is_temp():
-            value.clear()
-
-
-def init(storage_dir=""):
-    CacheConfig.storage_dir = storage_dir
-
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2018/06/07 22:10:11
+# @modified 2022/04/04 13:42:52
+"""持久化操作已经禁用，请使用dbutil
+PS: 标准库 functools提供了缓存的方法， 参考 https://docs.python.org/zh-cn/3/library/functools.html
+
+
+缓存的实现，API列表如下
+
+* cache(key = None, prefix = None, expire = 600) 缓存装饰器，用于加速函数调用
+* cache_put(key, value, expire = -1) 写入缓存
+* cache_get(key, default_value = None) 读取缓存
+* cache_del(key)  删除缓存
+
+失效的检查策略
+1. 读取时检查失效
+2. 生成新的缓存时从队列中取出多个缓存进行检查
+
+~~持久化策略~~
+1. 初始化的时候从文件中读取，运行过程中直接从内存读取
+2. 创建或者更新的时候持久化到文件
+3. TODO 考虑持久化时的并发控制
+
+
+淘汰置换规则（仅用于会失效的缓存）
+1. FIFO, First In First Out
+2. LRU, Least Recently Used
+3. LFU, Least Frequently Used
+
+* 参考redis的API
+* TODO: 可以使用 BitCask 存储模型实现
+"""
+import threading
+import random
+import datetime
+import time
+import re
+import os
+import json
+import inspect
+import sys
+import traceback
+import base64
+
+from xutils import dateutil
+from collections import OrderedDict, deque
+from xutils import interfaces, Storage
+from xutils.db.dbutil_cache import DatabaseCache
+from xutils.base import is_str
+
+_cache_dict = dict()
+_cache_queue = deque()
+
+class CacheConfig:
+    """缓存配置"""
+    storage_dir = ""
+
+def encode_key(text):
+    """编码key为文件名"""
+    return text + ".json"
+    # return base64.urlsafe_b64encode(text.encode("utf-8")).decode("utf-8") + ".pk"
+
+
+def decode_key(text):
+    """解码文件名称为key值，暂时没有使用"""
+    return base64.urlsafe_b64decode(text[:-3].encode("utf-8")).decode("utf-8")
+
+
+def format_key(key):
+    """格式化key，先简单实现一版"""
+    result = []
+    for c in key:
+        if c == "/":
+            result.append("%47")
+        elif c == "%":
+            result.append("%25")
+        elif c == ":":
+            result.append("%58")
+        else:
+            result.append(c)
+    return "".join(result)
+
+
+def log_debug(msg):
+    # print(msg)
+    pass
+
+
+def log_error(msg):
+    print(msg)
+
+class JsonSerializer:
+    """缓存编码器"""
+
+    def format_value(self, value):
+        if isinstance(value, dict):
+            result = dict()
+            for key in value:
+                item_value = value.get(key)
+                if isinstance(item_value, datetime.datetime):
+                    result[key] = dateutil.format_datetime(item_value)
+                else:
+                    result[key] = item_value
+            return result
+        return value
+    
+    def _fix_storage(self, obj):
+        if isinstance(obj, dict):
+            return Storage(**obj)
+        if isinstance(obj, list):
+            for index, item in enumerate(obj):
+                if isinstance(item, dict):
+                    obj[index] = Storage(**item)
+            return obj
+        return obj
+
+    def encode(self, value):
+        if isinstance(value, bytes):
+            return value
+        else:
+            formatted_value = self.format_value(value)
+            return json.dumps(formatted_value) # 转成json，要保证能够序列化
+
+    def decode(self, value):
+        if isinstance(value, bytes):
+            obj = value
+        else:
+            obj = json.loads(value)
+        return self._fix_storage(obj)
+
+class MemoryCache(interfaces.CacheInterface):
+    """缓存实现,一般情况下不要直接用它,优先使用 PrefixedCache, 这样便于迁移到Redis之类的分布式缓存"""
+
+    def __init__(self, max_size = -1, serializer=JsonSerializer()):
+        self.dict = OrderedDict()
+        self.expire_dict = dict()
+        self.max_size = max_size
+        self.lock = threading.RLock()
+        self.serializer = serializer
+
+    def get(self, key, default_value=None):
+        assert isinstance(key, str), key
+        value = self.dict.get(key)
+        if value != None:
+            if self.is_alive(key):
+                self.dict[key] = value # 移到最后面
+                return self.serializer.decode(value)
+            else:
+                self.delete(key)
+        return default_value
+    
+    def get_raw(self, key):
+        return self.dict.get(key)
+
+    def put(self, key, value, expire=60*5, random_range=60*5):
+        assert expire > 0
+        with self.lock:
+            self.dict[key] = self.serializer.encode(value)
+            self.expire_dict[key] = time.time() + expire + random.randint(0, random_range)
+            
+            if self.max_size > 0:
+                self.check_size_and_clear()
+
+    def is_alive(self, key):
+        value = self.expire_dict.get(key, 60*5)
+        return value > time.time()
+    
+    def delete(self, key):
+        has_delete = False
+        with self.lock:
+            if key in self.dict:
+                del self.dict[key]
+                has_delete = True
+            if key in self.expire_dict:
+                del self.expire_dict[key]
+                has_delete = True
+        return has_delete
+
+    def check_size_and_clear(self):
+        if self.max_size <= 0:
+            return
+
+        while len(self.dict) > self.max_size:
+            key, value = self.dict.popitem(last=False) # 弹出第一个
+            self.delete(key)
+    
+    def get_expire(self, key):
+        return self.expire_dict.get(key)
+
+    def keys(self):
+        return list(self.dict.keys())
+    
+    def clear_expired(self):
+        """清理失效的缓存"""
+        for key in self.keys():
+            if not self.is_alive(key):
+                self.delete(key)
+
+class DummyCache:
+    """用于禁用缓存, 兼容缓存的API"""
+
+    def __init__(self, max_size=-1):
+        pass
+
+    def get(self, key):
+        return None
+    
+    def put(self, key, value, expire=-1):
+        pass
+
+    def delete(self, key):
+        pass
+
+class Cache(MemoryCache):
+    pass
+
+_global_cache = MemoryCache(max_size=1000)
+
+class PrefixedCache:
+
+    def __init__(self, prefix="", cache_engine=interfaces.empty_cache):
+        self.prefix = prefix
+        if cache_engine == interfaces.empty_cache:
+            self.cache = _global_cache
+        else:
+            self.cache = cache_engine
+    
+    def get(self, key, default_value=None):
+        return self.cache.get(self.prefix + key, default_value=default_value)
+    
+    def get_dict(self, key, default_value=None):
+        value = self.cache.get(self.prefix + key, default_value=default_value)
+        if value == None:
+            return None
+        assert isinstance(value, dict)
+        return value
+    
+    def put(self, key, value, expire=60*5):
+        return self.cache.put(self.prefix+key, value, expire)
+    
+    def put_empty(self, key, expire=5):
+        """针对空值的特殊处理"""
+        return self.cache.put(self.prefix+key, "$empty", expire)
+    
+    def is_empty(self, value):
+        return value == "$empty"
+    
+    def delete(self, key):
+        return self.cache.delete(self.prefix + key)
+
+def get_global_cache():
+    return _global_cache
+
+
+class MultiLevelCache(interfaces.CacheInterface):
+    """基于内存+数据库的多级缓存"""
+
+    def __init__(self):
+        self.database_cache = DatabaseCache()
+        self.mem_cache = _global_cache
+        self.mem_cache_expire = 60
+
+    def get(self, key, default_value=None):
+        # 先查内存缓存
+        value = self.mem_cache.get(key)
+        if value == None:
+            # 如果查不到，查数据库缓存
+            value = self.database_cache.get(key)
+            if value != None:
+                self.mem_cache.put(key, value)
+        if value == None:
+            return default_value
+        return value
+    
+    def put(self, key, value, expire = -1, expire_random = 600):
+        self.database_cache.put(key, value, expire=expire, expire_random=expire_random)
+        self.mem_cache.put(key, value, expire=self.mem_cache_expire)
+    
+    def delete(self, key):
+        self.database_cache.delete(key)
+        self.mem_cache.delete(key)
+
+class CacheObj:
+    """缓存对象，包含缓存的key和value，有一个公共的缓存队列
+    每次生成一个会从缓存队列中取出一个检查是否失效，同时把自己放入队列
+    TODO 提供按照大小过滤的规则
+    """
+    # 缓存的最大容量，用于集合类型
+    max_size = -1
+    valid_key_pattern = re.compile(r"^[0-9a-zA-Z\[\]_\-\.\(\)\@\#,'\"\$ ]+$")
+
+    def __init__(self, key, value, expire=-1, type="object", need_save=True):
+        global _cache_dict
+        global _cache_queue
+
+        self.check_key_value(key, value)
+
+        self.key = key
+        self.value = value
+        self.expire = expire
+        self.expire_time = time.time() + expire
+        self.type = type
+        self.is_force_expired = False
+
+        if type == "zset" and not isinstance(value, OrderedDict):
+            value = OrderedDict(**value)
+            self.value = value
+
+        if expire < 0:
+            self.expire_time = -1
+
+        obj = _cache_dict.get(key, None)
+        if obj is not None:
+            obj.is_force_expired = True
+
+        if need_save:
+            self.save()
+
+        _cache_queue.append(self)
+
+        # find and clear expired cache objects
+        try:
+            for i in range(3):
+                if len(_cache_queue) == 0:
+                    break
+                one = _cache_queue.popleft()
+                if one is not None:
+                    if one.is_force_expired == True:
+                        continue
+                    if one.is_alive():
+                        _cache_queue.append(one)
+                    else:
+                        one.clear()
+        except:
+            # queue.Empty异常
+            print_exc()
+
+    def check_key_value(self, key, value):
+        if key is None:
+            raise ValueError("key cannot be None")
+        if value is None:
+            raise ValueError("invalid key: value is None")
+        if len(key) > 200:
+            raise ValueError("invalid key: len(key)>200")
+
+    def is_valid_key(self, key):
+        return self.valid_key_pattern.match(key) != None
+
+    def _get_path(self, key):
+        assert CacheConfig.storage_dir != ""
+        return os.path.join(CacheConfig.storage_dir, key + ".json")
+
+    def get_dump_value(self):
+        if self.type == "zset":
+            return dict(**self.value)
+        else:
+            return self.value
+
+    def save(self, method_name="save"):
+        _cache_dict[self.key] = self
+        if self.is_temp():
+            return
+
+        # save to disk
+        raise Exception(
+            "cacheutil.%s to disk is no longer supprted, please use dbutil" % method_name)
+
+
+    def is_alive(self):
+        if self.is_force_expired:
+            return False
+        if self.expire_time < 0:
+            return True
+        return time.time() < self.expire_time
+
+    def is_temp(self):
+        return self.expire_time > 0
+
+    def get_value(self):
+        if self.is_alive():
+            return self.value
+        self.clear()
+        return None
+
+    def clear(self):
+        log_debug("clear cache %s" % self.key)
+        # 标记为删除，用于清除queue中的引用
+        self.is_force_expired = True
+        _cache_dict.pop(self.key, None)
+        if self.is_temp():
+            return
+        # remove from disk
+        path = self._get_path(self.key)
+        if os.path.exists(path):
+            os.remove(path)
+
+
+def cache_deco(key=None, prefix=None, expire=600, expire_random=600):
+    """缓存的装饰器，会自动清理失效的缓存
+    注意：不考虑持久化，如果有持久化需要使用db实现
+    @param {str} key    指定缓存的key，也就是使用固定的key
+    @param {str} prefix 指定缓存的前缀，使用前缀+函数参数的方式，也就是动态的key
+    如果 key 和prefix 都不指定，使用函数签名+函数参数的方式，生成动态的key
+    """
+    if key != None and prefix != None:
+        raise Exception("不能同时设置key和prefix参数")
+
+    def deco(func):
+        # 先不支持keywords参数
+        def handle(*args):
+            if key is not None:
+                cache_key = key
+            elif prefix is None:
+                mod = inspect.getmodule(func)
+                funcname = func.__name__
+                cache_key = "%s.%s%s" % (mod.__name__, funcname, args)
+            else:
+                cache_key = "%s%s" % (prefix, args)
+
+            cache_value = _global_cache.get(key=cache_key)
+            if cache_value is not None:
+                return cache_value
+            value = func(*args)
+            if value is None:
+                _global_cache.delete(key=cache_key)
+                return None
+
+            _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
+            return value
+        return handle
+    return deco
+
+
+def cache_call(cache_key, func, expire=600, expire_random=600):
+    """带缓存的函数调用,这种方式可以生成可读性更高的cache_key"""
+    assert isinstance(cache_key, str)
+    cache_value = _global_cache.get(key=cache_key)
+    if cache_value is not None:
+        return cache_value
+    value = func()
+    if value is None:
+        _global_cache.delete(key=cache_key)
+        return None
+
+    _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
+    return value
+
+def kw_cache_deco(prefix="", expire=600, expire_random=600):
+    """缓存的装饰器，会自动清理失效的缓存
+    注意：不考虑持久化，如果有持久化需要使用db实现
+    @param {str} key    指定缓存的key，也就是使用固定的key
+    @param {str} prefix 指定缓存的前缀，使用前缀+函数参数的方式，也就是动态的key
+    如果 key 和prefix 都不指定，使用函数签名+函数参数的方式，生成动态的key
+    """
+    assert prefix != ""
+
+    def deco(func):
+        # 先不支持keywords参数
+        def handle(*args, **kw):
+            cache_key = "%s(%s_%s)" % (prefix, args, kw)
+            cache_value = _global_cache.get(key=cache_key)
+            if cache_value is not None:
+                return cache_value
+            value = func(*args, **kw)
+            if value is None:
+                _global_cache.delete(key=cache_key)
+                return None
+
+            _global_cache.put(key=cache_key, value=value, expire=expire, random_range=expire_random)
+            return value
+        return handle
+    return deco
+
+
+def cache(*args, **kw):
+    return cache_deco(*args, **kw)
+
+
+def put(key, value=None, expire=-1):
+    """设置缓存的值
+    @param {object} value value对象必须可以json序列化，如果value为None，会删除key对应的对象
+    @param {integer} expire 失效时间，单位秒，如果小于等于0认为不失效，会持久化到文件
+    """
+    return _global_cache.put(key, value=value, expire=expire)
+
+
+def get(key, default_value=None):
+    """读取缓存对象
+    @param {object} default_value 如果缓存对象不存在，返回default_value
+    """
+    return _global_cache.get(key=key, default_value=default_value)
+
+
+def delete(key=None, prefix=None, args=None):
+    """使key对应的缓存失效，成功返回True
+    del与python关键字冲突
+    @param {string} key 缓存的key
+    """
+    if key == None:
+        key = "%s%s" % (prefix, args)
+    return _global_cache.delete(key=key)
+
+
+def prefix_del(prefix):
+    """使用前缀删除"""
+    for key in _global_cache.dict:
+        if key.startswith(prefix):
+            _global_cache.delete(key)
+
+
+# 方法别名
+cache_get = get
+cache_put = put
+cache_del = delete
+set = put
+
+
+def get_cache_obj(key, default_value=None, type=None):
+    if not is_str(key):
+        raise TypeError("cache key must be string")
+    obj = _cache_dict.get(key)
+    if obj is None:
+        return default_value
+    if obj.is_alive():
+        if type != None and type != obj.type:
+            raise TypeError("expect %s but found %s" % (type, obj.type))
+        return obj
+    obj.clear()
+    return None
+
+
+def update_cache_by_key(key):
+    """直接通过key来更新缓存，前提是缓存已经存在"""
+    obj = _cache_dict.get(key)
+    if obj != None:
+        func = obj.func
+        args = obj.args
+        obj.value = func(*args)
+
+
+def lpush(key, value):
+    obj = get_cache_obj(key, type="list")
+    if obj != None and obj.value != None:
+        obj.value.insert(0, value)
+        obj.save()
+    else:
+        obj = CacheObj(key, [value], type="list")
+        obj.save()
+
+
+def rpush(key, value):
+    obj = get_cache_obj(key, type="list")
+    if obj != None and obj.value != None:
+        obj.value.append(value)
+        obj.save()
+    else:
+        obj = CacheObj(key, [value], type="list")
+        obj.save()
+
+
+def lrange(key, start=0, stop=-1):
+    obj = get_cache_obj(key, type="list")
+    if obj != None and obj.value != None:
+        length = len(obj.value)
+        if start < 0:
+            start += length
+        if stop < 0:
+            stop += length
+        return obj.value[start: stop+1]
+    else:
+        return []
+
+
+def ltrim(key, start=0, stop=-1):
+    obj = get_cache_obj(key, type="list")
+    if obj != None and obj.value != None:
+        length = len(obj.value)
+        if start < 0:
+            start += length
+        if stop < 0:
+            stop += length
+        obj.value = obj.value[start: stop+1]
+        obj.save()
+    else:
+        pass
+
+
+def lindex(key, index):
+    obj = get_cache_obj(key, type="list")
+    if obj != None and obj.value != None:
+        length = len(obj.value)
+        if index < 0:
+            index += length
+        if index >= length or index < 0:
+            return None
+        return obj.value[index]
+    else:
+        return None
+
+
+class SortedObject:
+
+    def __init__(self, key, value):
+        self.key = key
+        self.value = value
+
+    def __lt__(self, obj):
+        return self.value < obj.value
+
+    def __cmp__(self, obj):
+        return cmp(self.value, obj.value)
+
+
+def zadd(key, score, member):
+    # TODO 双写两个列表
+    obj = get_cache_obj(key, type="zset")
+    if obj != None and obj.value != None:
+        obj.value.pop(member, None)
+        obj.value[member] = score
+        obj.type = "zset"
+        obj.save()
+    else:
+        obj = CacheObj(key, OrderedDict(), type="zset")
+        obj.value[member] = score
+        obj.save()
+
+
+def zrange(key, start, stop):
+    """zset分片，不同于Python，这里是左右包含，包含start，包含stop
+    :arg int start: 从0开始，负数表示倒数
+    :arg int stop: 从0开始，负数表示倒数
+    TODO 优化排序算法，使用有序列表+哈希表
+    """
+    obj = get_cache_obj(key)
+    if obj != None:
+        items = obj.value.items()
+        if stop == -1:
+            stop = len(items)
+        else:
+            stop += 1
+        sorted_items = sorted(items, key=lambda x: x[1])
+        sorted_keys = [k[0] for k in sorted_items]
+        return sorted_keys[start: stop]
+    return []
+
+
+def zcount(key):
+    obj = get_cache_obj(key)
+    if obj != None:
+        return len(obj.value)
+    return 0
+
+
+def zscore(key, member):
+    obj = get_cache_obj(key)
+    if obj != None:
+        return obj.value.get(member, None)
+    return None
+
+
+def zincrby(key, increment, member):
+    """通过setdefault处理并发问题"""
+    obj = get_cache_obj(key)
+    if obj != None:
+        obj.value.setdefault(member, 0)
+        obj.value[member] += increment
+        # obj.value.move_to_end(member, last=True)
+        obj.value[member] = obj.value.pop(member)
+        if obj.max_size > 0:
+            # LRU置换
+            while len(obj.value) > obj.max_size:
+                obj.value.popitem(last=False)
+        obj.save()
+    else:
+        zadd(key, increment, member)
+
+
+def zrem(key, member):
+    obj = get_cache_obj(key)
+    if obj != None:
+        value = obj.value.pop(member)
+        if value != None:
+            obj.save()
+            return 1
+        return 0
+    else:
+        return 0
+
+
+def zremrangebyrank(key, start, stop):
+    '''删除zset区间'''
+    obj = get_cache_obj(key)
+    if obj is None:
+        return 0
+    members = zrange(key, start, stop)
+    if len(members) == 0:
+        return 0
+    for member in members:
+        log_debug("del %s" % member)
+        obj.value.pop(member)
+    obj.save()
+    return len(members)
+
+
+def zmaxsize(key, max_size):
+    obj = get_cache_obj(key)
+    if obj is None:
+        return
+    obj.max_size = max_size
+
+
+def hset(key, field, value, expire=-1):
+    try:
+        obj = get_cache_obj(key, type="hash")
+        if obj != None and obj.value != None:
+            obj.value[field] = value
+            obj.type = "hash"
+            obj.save("hset")
+        else:
+            obj = CacheObj(key, dict(), type="hash", expire=expire)
+            obj.value[field] = value
+            obj.save("hset")
+    except:
+        print_exc()
+        return None
+
+
+def hget(key, field):
+    try:
+        obj = get_cache_obj(key, type="hash")
+        if obj != None and obj.value != None:
+            return obj.value.get(field)
+        else:
+            return None
+    except:
+        print_exc()
+        return None
+
+
+def hdel(key, field):
+    obj = get_cache_obj(key, type="hash")
+    if obj != None and obj.value != None:
+        if field in obj.value:
+            del obj.value[field]
+            return 1
+        return 0
+    else:
+        return 0
+
+
+def hkeys(key, field):
+    obj = get_cache_obj(key, type="hash")
+    if obj != None and obj.value != None:
+        return list(obj.value.keys())
+    else:
+        return list()
+
+
+def keys(pattern=None):
+    """返回所有缓存的key列表"""
+    return list(_cache_dict.keys())
+
+
+def print_exc():
+    """打印系统异常堆栈"""
+    ex_type, ex, tb = sys.exc_info()
+    exc_info = traceback.format_exc()
+    log_error(exc_info)
+
+
+def json_object_hook(dict_obj):
+    return Storage(**dict_obj)
+
+
+def clear_temp():
+    for key in _cache_dict.copy():
+        value = _cache_dict.get(key)
+        if value != None and value.is_temp():
+            value.clear()
+
+
+def init(storage_dir=""):
+    CacheConfig.storage_dir = storage_dir
+
```

### Comparing `xnote-web-0.1.0/xutils/db/binlog.py` & `xnote-web-0.1.1/xutils/db/binlog.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_cache.py` & `xnote-web-0.1.1/xutils/db/dbutil_cache.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_deque.py` & `xnote-web-0.1.1/xutils/db/dbutil_deque.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_hash.py` & `xnote-web-0.1.1/xutils/db/dbutil_hash.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_helper.py` & `xnote-web-0.1.1/xutils/db/dbutil_helper.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_id_gen.py` & `xnote-web-0.1.1/xutils/db/dbutil_id_gen.py`

 * *Ordering differences only*

 * *Files 12% similar despite different names*

```diff
@@ -1,115 +1,115 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-10-03 22:51:40
-@LastEditors  : xupingmao
-@LastEditTime : 2023-09-23 11:59:05
-@FilePath     : /xnote/xutils/db/dbutil_id_gen.py
-@Description  : id生成
-"""
-import time
-import struct
-import xutils
-from xutils.db import dbutil_base as base
-from xutils.db.encode import encode_id
-
-class IdGenerator:
-
-    def __init__(self, table_name) -> None:
-        self.table_name = table_name
-
-    def create_increment_id(self, start_id=1):
-        new_id = self.create_increment_id_int(start_id=start_id)
-        return encode_id(new_id)
-    
-    def create_increment_id_int(self, start_id=1, increment=1):
-        assert start_id > 0
-        max_id_key = "_max_id:" + self.table_name
-        key_bytes = max_id_key.encode("utf-8")
-        return base.get_db_instance().Increase(key_bytes, start_id=start_id, increment=increment)
-    
-    def current_id_int(self):
-        max_id_key = "_max_id:" + self.table_name
-        key_bytes = max_id_key.encode("utf-8")
-        value = base.get_db_instance().Get(key_bytes)
-        if value == None:
-            return 0
-        return int(value)
-
-    def create_new_id(self, id_type="uuid", id_value=None):
-        if id_type == "uuid":
-            base.validate_none(id_value, "invalid id_value")
-            return xutils.create_uuid()
-
-        if id_type == "timeseq":
-            base.validate_none(id_value, "invalid id_value")
-            return TimeSeqId.create(id_value)
-
-        if id_type == "auto_increment":
-            base.validate_none(id_value, "invalid id_value")
-            return self.create_increment_id()
-
-        if id_type == "value":
-            assert id_value != None
-            return id_value
-
-        raise Exception("unknown id_type:%s" % id_type)
-
-
-
-class TimeSeqId:
-
-    """时间序列ID生成器,第1位数字用于标识ID版本,不保证定长"""
-
-    last_time_seq = (time.time() * 1000)
-    max_retry = 100
-
-    @classmethod
-    def create(cls, value):
-        """生成一个时间序列, python目前支持的最大时间是 9999 年
-        @param {float|None} value 时间序列，单位是秒，可选
-        @return {string}    16位字符串
-        """
-        return cls.create_v1(value)
-
-    @classmethod
-    def get_valid_ms(cls, value):
-        if value != None:
-            error_msg = "expect <class 'float'> but see %r" % type(value)
-            assert isinstance(value, float), error_msg
-
-            return int(value * 1000)
-        else:
-            t = int(time.time() * 1000)
-            # 加锁防止并发生成一样的值
-            # 注意这里的锁是单个进程级别的,后续可以考虑分布式锁,在时间戳后面增加机器的编号用于防止重复
-            with base.get_write_lock("time_seq"):
-                for retry in range(cls.max_retry):
-                    if t <= cls.last_time_seq:
-                        # 等于上次生成的值，说明太快了，sleep一下进行控速
-                        # print("too fast, sleep 0.001")
-                        # 如果不sleep，下次还可能会重复
-                        time.sleep(0.001)
-                        t = int(time.time() * 1000)
-                    else:
-                        cls.last_time_seq = t
-                        return t
-                raise Exception("too many retry")
-
-    @classmethod
-    def create_v1(cls, value):
-        """v1版本是使用16进制编码的16位字符"""
-        ms = cls.get_valid_ms(value)
-        return struct.pack(">Q", ms).hex()
-
-
-    @classmethod
-    def create_v0(cls, value):
-        """v0版本是一个20位固定长度的数字(19位用于毫秒时间序列)的ID"""
-        t = cls.get_valid_ms(value)
-        ts = "%020d" % t
-
-        assert len(ts) == 20
-        assert ts[0] == "0" # 其他数字用于扩展操作
-        return ts
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-10-03 22:51:40
+@LastEditors  : xupingmao
+@LastEditTime : 2023-09-23 11:59:05
+@FilePath     : /xnote/xutils/db/dbutil_id_gen.py
+@Description  : id生成
+"""
+import time
+import struct
+import xutils
+from xutils.db import dbutil_base as base
+from xutils.db.encode import encode_id
+
+class IdGenerator:
+
+    def __init__(self, table_name) -> None:
+        self.table_name = table_name
+
+    def create_increment_id(self, start_id=1):
+        new_id = self.create_increment_id_int(start_id=start_id)
+        return encode_id(new_id)
+    
+    def create_increment_id_int(self, start_id=1, increment=1):
+        assert start_id > 0
+        max_id_key = "_max_id:" + self.table_name
+        key_bytes = max_id_key.encode("utf-8")
+        return base.get_db_instance().Increase(key_bytes, start_id=start_id, increment=increment)
+    
+    def current_id_int(self):
+        max_id_key = "_max_id:" + self.table_name
+        key_bytes = max_id_key.encode("utf-8")
+        value = base.get_db_instance().Get(key_bytes)
+        if value == None:
+            return 0
+        return int(value)
+
+    def create_new_id(self, id_type="uuid", id_value=None):
+        if id_type == "uuid":
+            base.validate_none(id_value, "invalid id_value")
+            return xutils.create_uuid()
+
+        if id_type == "timeseq":
+            base.validate_none(id_value, "invalid id_value")
+            return TimeSeqId.create(id_value)
+
+        if id_type == "auto_increment":
+            base.validate_none(id_value, "invalid id_value")
+            return self.create_increment_id()
+
+        if id_type == "value":
+            assert id_value != None
+            return id_value
+
+        raise Exception("unknown id_type:%s" % id_type)
+
+
+
+class TimeSeqId:
+
+    """时间序列ID生成器,第1位数字用于标识ID版本,不保证定长"""
+
+    last_time_seq = (time.time() * 1000)
+    max_retry = 100
+
+    @classmethod
+    def create(cls, value):
+        """生成一个时间序列, python目前支持的最大时间是 9999 年
+        @param {float|None} value 时间序列，单位是秒，可选
+        @return {string}    16位字符串
+        """
+        return cls.create_v1(value)
+
+    @classmethod
+    def get_valid_ms(cls, value):
+        if value != None:
+            error_msg = "expect <class 'float'> but see %r" % type(value)
+            assert isinstance(value, float), error_msg
+
+            return int(value * 1000)
+        else:
+            t = int(time.time() * 1000)
+            # 加锁防止并发生成一样的值
+            # 注意这里的锁是单个进程级别的,后续可以考虑分布式锁,在时间戳后面增加机器的编号用于防止重复
+            with base.get_write_lock("time_seq"):
+                for retry in range(cls.max_retry):
+                    if t <= cls.last_time_seq:
+                        # 等于上次生成的值，说明太快了，sleep一下进行控速
+                        # print("too fast, sleep 0.001")
+                        # 如果不sleep，下次还可能会重复
+                        time.sleep(0.001)
+                        t = int(time.time() * 1000)
+                    else:
+                        cls.last_time_seq = t
+                        return t
+                raise Exception("too many retry")
+
+    @classmethod
+    def create_v1(cls, value):
+        """v1版本是使用16进制编码的16位字符"""
+        ms = cls.get_valid_ms(value)
+        return struct.pack(">Q", ms).hex()
+
+
+    @classmethod
+    def create_v0(cls, value):
+        """v0版本是一个20位固定长度的数字(19位用于毫秒时间序列)的ID"""
+        t = cls.get_valid_ms(value)
+        ts = "%020d" % t
+
+        assert len(ts) == 20
+        assert ts[0] == "0" # 其他数字用于扩展操作
+        return ts
```

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_set.py` & `xnote-web-0.1.1/xutils/db/dbutil_set.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_sortedset.py` & `xnote-web-0.1.1/xutils/db/dbutil_sortedset.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_table.py` & `xnote-web-0.1.1/xutils/db/dbutil_table.py`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,803 +1,803 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2021-12-04 21:22:40
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-24 15:53:03
-@FilePath     : /xnote/xutils/db/dbutil_table.py
-@Description  : 数据库表-API, 不建议使用, 建议使用 dbutil_table_v2
-"""
-
-from urllib.parse import quote
-from xutils import Storage
-from xutils.db.dbutil_base import *
-from xutils.db.dbutil_table_index import TableIndex, TableIndexRepair
-from xutils.db.encode import (
-    decode_str,
-    encode_index_value,
-    encode_str,
-    clean_value_before_update
-)
-from xutils.db.dbutil_id_gen import IdGenerator
-from xutils.db.binlog import BinLog
-from xutils.db import filters
-
-db = register_table("_id", "系统ID表")
-db.delete_table()
-
-register_table("_max_id", "最大ID")
-register_table("_index", "通用索引")
-register_table("_meta", "表元信息")
-register_table("_idx_version", "索引版本")
-
-db = register_table("_repair_error", "修复错误记录")
-db.register_index("ctime")
-
-class LdbTable:
-    """Deprecated: 建议使用 dbutil_table_v2
-    基于leveldb的表, 比较常见的是以下2种
-    * key = prefix:record_id           全局数据库
-    * key = prefix:user_name:record_id 用户(或者其他分片)维度数据
-
-    字段说明: 
-    * prefix    代表的是功能类型，比如猫和狗是两种不同的动物，锤子和手机是两种
-                不同的工具
-    * user_name 代表用户名，比如张三和李四，也可以是其他类型的对象ID，比如笔记ID
-    * record_id 代表一条记录的ID，从属于user_name
-
-    注: record_id建议使用全局ID，尽量避免多级主键，如果使用多级主键，移动记录会
-        比较麻烦，要重新构建主键
-    """
-
-    def __init__(self, table_name, user_name=None):
-        # 参数检查
-        check_table_name(table_name)
-        table_info = get_table_info(table_name)
-        assert table_info != None
-
-        self.table_name = table_name
-        self.key_name = "_key"
-        self.id_name = "_id"
-        self.prefix = table_name
-        self.user_name = user_name
-        self.table_info = table_info
-        self.index_names = table_info.get_index_names()
-        self._need_check_user = table_info.check_user
-        self.user_attr = None
-        self.id_gen = IdGenerator(self.table_name)
-        self.fix_user_attr = True
-        # 自定义索引构建器
-        self.build_index_func = None
-
-        if table_info.check_user:
-            if table_info.user_attr == None:
-                raise Exception("table({table_name}).user_attr can not be None".format(
-                    table_name=table_name))
-            self.user_attr = table_info.user_attr
-
-        self.binlog = BinLog.get_instance()
-        self.binlog_enabled = True
-        # TODO 索引用一个单例管理起来
-        self.indexes = self._build_indexes() # type: list[TableIndex]
-
-        if user_name != None:
-            assert user_name != ""
-            self.prefix += ":" + user_name
-
-        if self.prefix[-1] != ":":
-            self.prefix += ":"
-
-    def _build_indexes(self):
-        indexes = []
-        index_dict = IndexInfo.get_table_index_dict(self.table_name)
-        if index_dict != None:
-            for index_name in index_dict:
-                index_info = index_dict[index_name]
-                indexes.append(TableIndex(index_info))
-        return indexes
-
-    def set_binlog_enabled(self, enabled=True):
-        self.binlog_enabled = enabled
-
-    def _build_key(self, *argv):
-        return self.prefix + self._build_key_no_prefix(*argv)
-
-    def _build_key_with_user(self, id, user_name):
-        return self._build_key_no_prefix(self.table_name, user_name or self.user_name, id)
-
-    def _build_key_no_prefix(self, *argv):
-        return ":".join(filter(None, argv))
-
-    def _get_key_from_obj(self, obj):
-        validate_dict(obj, "obj is not dict")
-        return obj.get(self.key_name)
-
-    def _get_id_from_obj(self, obj):
-        key = self._get_key_from_obj(obj)
-        return key.rsplit(":", 1)[-1]
-
-    def _get_id_from_key(self, key):
-        return decode_str(key.rsplit(":", 1)[-1])
-
-    def _get_user_from_key(self, key):
-        parts = key.split(":")
-        assert len(parts) == 3, parts
-        return parts[1]
-
-    def _format_value(self, key, value):
-        if not isinstance(value, dict):
-            value = Storage(_raw=value)
-
-        value[self.key_name] = key
-        value[self.id_name] = self._get_id_from_key(key)
-        if self.user_attr != None and self.fix_user_attr:
-            user = value.get(self.user_attr)
-            parts = key.split(":")
-            if user == None and len(parts) == 3:
-                value[self.user_attr] = parts[1]
-        return value
-
-    def _convert_to_db_row(self, obj):
-        obj_copy = dict(**obj)
-        clean_value_before_update(obj_copy)
-        return obj_copy
-
-    def _create_new_id(self, id_type="uuid", id_value=None):
-        return self.id_gen.create_new_id(id_type, id_value)
-
-    def _check_before_delete(self, key):
-        if not key.startswith(self.prefix):
-            raise Exception("invalid key:%s" % key)
-
-    def _check_value(self, obj, key=""):
-        if not isinstance(obj, dict):
-            raise Exception("key:%r, invalid obj:%r, expected dict" % (key, obj))
-
-    def _check_key(self, key):
-        if not key.startswith(self.prefix):
-            raise Exception("invalid key:(%s), prefix:(%s)" %
-                            (key, self.prefix))
-
-    def _check_index_name(self, index_name):
-        validate_str(index_name, "invalid index_name:%r" % index_name)
-        if index_name not in self.index_names:
-            raise Exception("invalid index_name:%r" % index_name)
-
-    def _check_user_name(self, user_name):
-        user_name = self.user_name or user_name
-        if self._need_check_user:
-            validate_str(user_name, "invalid user_name:{!r}", user_name)
-
-    def _get_prefix(self, user_name=None):
-        user_name = self.user_name or user_name
-        if user_name is None:
-            return self.table_name + ":"
-        else:
-            return self.table_name + ":" + encode_str(user_name) + ":"
-
-    def _update_index(self, old_obj, new_obj, batch, force_update=False):
-        if self.build_index_func != None:
-            self.build_index_func(new_obj=new_obj, old_obj=old_obj, force_update=force_update)
-            return
-        
-        for index in self.indexes:
-            index.update_index(old_obj, new_obj, batch, force_update)
-
-    def _delete_index(self, old_obj, batch):
-        for index in self.indexes:
-            index.delete_index(old_obj, batch)
-
-    def _put_obj(self, key, obj, sync=False):
-        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
-        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
-        # 使用leveldb的批量操作可以确保不会读到未提交的数据
-        batch = create_write_batch()
-        with get_write_lock(key):
-            old_obj = db_get(key)
-            self._format_value(key, old_obj)
-            batch.put(key, self._convert_to_db_row(obj))
-            self._update_index(old_obj, obj, batch)
-            if self.binlog_enabled:
-                self.binlog.add_log(
-                    "put", key, obj, batch=batch, old_value=old_obj)
-            # 更新批量操作
-            batch.commit(sync)
-
-    def _insert_obj(self, key, obj, sync=False):
-        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
-        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
-        # 使用leveldb的批量操作可以确保不会读到未提交的数据
-        batch = create_write_batch()
-        with get_write_lock(key):
-            old_obj = db_get(key)
-            self._format_value(key, old_obj)
-            batch.insert(key, self._convert_to_db_row(obj))
-            self._update_index(old_obj, obj, batch)
-            if self.binlog_enabled:
-                self.binlog.add_log(
-                    "put", key, obj, batch=batch, old_value=old_obj)
-            # 更新批量操作
-            batch.commit(sync)
-
-    def is_valid_key(self, key=None, user_name=None):
-        assert isinstance(key, str)
-        if user_name is None:
-            return key.startswith(self.prefix)
-        else:
-            return key.startswith(self.prefix + user_name)
-
-    def get_by_id(self, row_id, default_value=None, user_name=None):
-        """通过ID查询记录
-        :param row_id: 记录ID
-        :param default_value: 默认值
-        :param user_name: 用户标识
-        """
-        row_id = str(row_id)
-        
-        if self._need_check_user:
-            validate_str(user_name, "invalid user_name:{!r}", user_name)
-
-        row_id = encode_str(row_id)
-        key = self._build_key_with_user(row_id, user_name=user_name)
-        return self.get_by_key(key, default_value)
-
-    def batch_get_by_id(self, row_id_list, default_value=None, user_name=None):
-        for row_id in row_id_list:
-            validate_str(row_id, "invalid row_id:{!r}", row_id)
-            if self._need_check_user:
-                validate_str(user_name, "invalid user_name:{!r}", user_name)
-
-        key_list = []
-        key_id_dict = {}
-        for row_id in row_id_list:
-            q_row_id = encode_str(row_id)
-            key = self._build_key_with_user(q_row_id, user_name=user_name)
-            key_list.append(key)
-            key_id_dict[key] = row_id
-
-        result = dict()
-        key_result = self.batch_get_by_key(
-            key_list, default_value=default_value)
-        for key in key_result:
-            object = key_result.get(key)
-            id = key_id_dict.get(key)
-            result[id] = object
-        return result
-
-    def get_by_key(self, key, default_value=None):
-        """通过key查询记录
-        :param key: kv数据库的key
-        :param default_value: 默认值
-        """
-        if key == "":
-            return None
-        self._check_key(key)
-        value = db_get(key, default_value)
-        if value is None:
-            return None
-
-        return self._format_value(key, value)
-
-    def batch_get_by_key(self, key_list, default_value=None):
-        for key in key_list:
-            self._check_key(key)
-
-        batch_result = db_batch_get(key_list, default_value)
-        for key in batch_result:
-            value = batch_result.get(key)
-            if value is None:
-                batch_result[key] = None
-                continue
-            batch_result[key] = self._format_value(key, value)
-
-        return batch_result
-
-    def insert(self, obj, id_type="auto_increment", id_value=None, max_retry=10):
-        """插入新数据
-        @param {object} obj 插入的对象
-        @param {string} id_type id类型
-        """
-        self._check_value(obj)
-
-        if id_value != None:
-            max_retry = 1
-
-        user_name = None
-        if self._need_check_user:
-            user_name = obj.get(self.user_attr)
-
-        new_id = "1"
-        with get_write_lock(self.table_name):
-            # TODO 优化加锁逻辑
-            for i in range(max_retry):
-                new_id = self.id_gen.create_new_id(id_type, id_value)
-                key = self._build_key_with_user(new_id, user_name=user_name)
-                conflict = self.get_by_key(key)
-                if conflict != None:
-                    continue
-
-                obj[self.key_name] = key
-                obj[self.id_name] = new_id
-
-                self._put_obj(key, obj)
-                return new_id
-        raise Exception("insert conflict, id=%s" % new_id)
-
-    def insert_by_user(self, user_name, obj, id_type="auto_increment"):
-        """@deprecated 定义user_attr之后使用insert即可满足
-        指定用户名插入数据
-        """
-        if self.user_name != None:
-            raise Exception("table实例已经设置了user_name, 不能使用该方法")
-
-        validate_str(user_name, "invalid user_name")
-        self._check_value(obj)
-            
-        with get_write_lock(self.table_name):
-            for i in range(10):
-                new_id = self._create_new_id(id_type)
-                key = self._build_key_with_user(new_id, user_name)
-                conflict = self.get_by_key(key)
-                if conflict != None:
-                    continue
-                self._put_obj(key, obj)
-                return key
-        raise Exception("insert conflict")
-
-    def update(self, obj):
-        """从`obj`中获取主键`key`进行更新"""
-        self._check_value(obj)
-
-        obj_key = self._get_key_from_obj(obj)
-        assert isinstance(obj_key, str), "obj_key must be str"
-        
-        self._check_key(obj_key)
-
-        self._put_obj(obj_key, obj)
-
-    def put_by_id(self, id, obj, user_name=None, encode_key=True):
-        """通过ID进行更新，如果key包含用户，必须有user_name(初始化定义或者传入参数)
-        :param {str} id: 指定ID
-        :param {dict} obj: 写入的对象
-        :param {str|None} user_name: 用户分片
-        :param encode_key=True: 是否对key进行编码,用于处理特殊字符
-        """
-        id = str(id)
-        if self.user_name != None and user_name != None:
-            raise DBException("table实例已经设置了user_name，不能再通过参数设置")
-
-        if encode_key:
-            id = encode_str(id)
-
-        if self.user_attr != None:
-            user_name = obj.get(self.user_attr)
-            if user_name == None:
-                raise DBException("%s属性未设置" % self.user_attr)
-
-        self._check_user_name(user_name)
-        key = self._build_key_with_user(id, user_name)
-        self.update_by_key(key, obj)
-
-    update_by_id = put_by_id
-
-    def update_by_key(self, key, obj):
-        """直接通过`key`进行更新"""
-        self._check_key(key)
-        self._check_value(obj, key=key)
-
-        obj[self.key_name] = key
-        obj[self.id_name] = self._get_id_from_key(key)
-        
-        update_obj = obj
-        self._put_obj(key, update_obj)
-
-    def rebuild_single_index(self, obj, user_name=None):
-        self._check_value(obj)
-        self._check_user_name(user_name)
-
-        key = self._get_key_from_obj(obj)
-        batch = create_write_batch()
-        with get_write_lock(key):
-            old_obj = get(key)
-            self._format_value(key, obj)
-            self._update_index(old_obj, obj, batch,
-                               force_update=True)
-            # 更新批量操作
-            batch.commit()
-
-    def repair_index(self):
-        repair = TableIndexRepair(self, LdbTable("_repair_error"))
-        repair.table_name = self.table_name
-        repair.repair_index()
-
-    def rebuild_index(self, version="v1"):
-        """重建索引, 可以通过设置新的version值重新建立索引"""
-        idx_version_key = "_idx_version:%s" % self.table_name
-        current_version = db_get(idx_version_key)
-        if current_version == version:
-            logging.info("当前索引已经是最新版本, table=%s, version=%s" %
-                            (self.table_name, version))
-            return
-        self.repair_index()
-        db_put(idx_version_key, version)
-
-    def delete(self, obj):
-        obj_key = self._get_key_from_obj(obj)
-        self.delete_by_key(obj_key)
-
-    def batch_delete(self, obj_list=[]):
-        if len(obj_list) == 0:
-            return
-        keys = []
-        for obj in obj_list:
-            key = self._get_key_from_obj(obj)
-            keys.append(key)
-        db_batch_delete(keys)
-
-    def delete_by_id(self, id, user_name=None):
-        id = str(id)
-        key = self._build_key_with_user(id, user_name)
-        self.delete_by_key(key)
-
-    def delete_by_key(self, key, user_name=None):
-        validate_str(key, "delete_by_key: invalid key")
-        self._check_before_delete(key)
-        assert self.is_valid_key(key, user_name), "key校验失败"
-
-        old_obj = get(key)
-        if old_obj is None:
-            return
-
-        self._format_value(key, old_obj)
-        with get_write_lock(key):
-            batch = create_write_batch()
-            self._delete_index(old_obj, batch)
-            # 更新批量操作
-            batch.delete(key)
-            if self.binlog_enabled:
-                self.binlog.add_log("delete", key, old_obj,
-                                    batch=batch, old_value=old_obj)
-            batch.commit()
-
-    def iter(self, offset=0, limit=20, reverse=False, key_from=None,
-             filter_func=None, where = None, fill_cache=False, user_name=None):
-        """返回一个遍历的迭代器
-        :param {int} offset: 返回结果下标开始
-        :param {int} limit:  返回结果最大数量
-        :param {bool} reverse: 返回结果是否逆序
-        :param {dict} where: where查询条件
-        :param {str} key_from: 开始的key，这里是相对的key，也就是不包含table_name
-        :param {func} filter_func: 过滤函数
-        :param {str} user_name: 用户标识
-        """
-        if key_from == "":
-            key_from = None
-
-        if key_from != None:
-            key_from = self._build_key(key_from)
-        
-        if user_name == None and where != None and self.user_attr != None:
-            user_name = where.get(self.user_attr)
-
-        if user_name != None:
-            prefix = self.table_name + ":" + user_name
-        else:
-            prefix = self.prefix
-
-        if where != None:
-            filter_func = filters.create_func_by_where(where, filter_func)
-
-        for key, value in prefix_iter(prefix, filter_func, offset, limit,
-                                      reverse=reverse, include_key=True, key_from=key_from,
-                                      fill_cache=fill_cache):
-            yield self._format_value(key, value)
-
-    def list(self, *args, **kw):
-        """查询记录列表,参数和`iter`保持一致"""
-        result = []
-        for value in self.iter(*args, **kw):
-            result.append(value)
-        return result
-
-    def get_first(self, filter_func=None, *, where = None, user_name=None):
-        """读取第一个满足条件的数据"""
-        result = self.list(limit=1, filter_func=filter_func, where = where,
-                           user_name=user_name)
-        if len(result) > 0:
-            return result[0]
-        else:
-            return None
-    
-    def get_last(self, filter_func=None, *, user_name=None):
-        """读取最后一个满足条件的数据"""
-        result = self.list(limit=1, reverse=True,
-                           filter_func=filter_func, user_name=user_name)
-        if len(result) > 0:
-            return result[0]
-        else:
-            return None
-
-    def list_by_user(self, user_name, offset=0, limit=20, reverse=False):
-        if self.user_name != None:
-            raise Exception("table实例的user_name已经设置，不能使用该方法")
-
-        return self.list(offset=offset, limit=limit, reverse=reverse, user_name=user_name)
-
-    def list_by_func(self, user_name, filter_func=None,
-                     offset=0, limit=20, reverse=False):
-        return self.list(offset=offset, limit=limit, reverse=reverse,
-                         filter_func=filter_func, user_name=user_name)
-
-    def create_index_map_func(self, filter_func, where = None, index_type="ref"):
-        if where != None:
-            filter_func = filters.create_func_by_where(where, filter_func)
-
-        def map_func_for_copy(batch_list):
-            result = []
-            for key, value in batch_list:
-                obj_key = value.get("key")
-                obj_value = value.get("value")
-                self._format_value(obj_key, obj_value)
-                if isinstance(obj_value, dict):
-                    obj_value = Storage(**obj_value)
-
-                # 这里应该是使用obj参数来过滤
-                if filter_func == None:
-                    is_match = True
-                else:
-                    is_match = filter_func(obj_key, obj_value)
-                
-                if is_match:
-                    result.append((key, obj_value))
-
-            return result
-
-        def map_func_for_ref(batch_list):
-            # 先判断实例是否存在
-            # 普通的引用索引
-            result = []
-            key_list = []
-            obj_dict = {}
-            for key, ref_key in batch_list:
-                key_list.append(ref_key)
-
-            obj_dict = self.batch_get_by_key(key_list)
-
-            for key, ref_key in batch_list:
-                obj = obj_dict.get(ref_key)
-
-                if obj is None:
-                    # 异步 delete(key)
-                    logging.warning("invalid key:(%s)", key)
-                    continue
-
-                # 检查key是否匹配
-                obj_id = key.rsplit(":", 1)[-1]
-                key_obj_id_temp = self._get_id_from_obj(obj)
-                key_obj_id = quote(key_obj_id_temp)
-                if obj_id != key_obj_id:
-                    logging.warning(
-                        "invalid obj_id:(%s), obj_id:(%s)", obj_id, key_obj_id)
-                    continue
-                
-                self._format_value(ref_key, obj)
-
-                # 用于调试
-                # setattr(obj, "_idx_key", key)
-                # 这里应该是使用obj参数来过滤
-                if filter_func == None:
-                    is_match = True
-                else:
-                    is_match = filter_func(key, obj)
-                
-                if is_match:
-                    result.append((key, obj))
-            return result
-
-        if index_type == "copy":
-            return map_func_for_copy
-
-        return map_func_for_ref
-    
-    
-    def _get_index_prefix(self, index_name, user_name=None):
-        self._check_index_name(index_name)
-        self._check_user_name(user_name)
-
-        index_prefix = IndexInfo.build_prefix(self.table_name, index_name)
-        return self._build_key_no_prefix(index_prefix, self.user_name or user_name)
-
-    def _get_index_prefix_by_value(self, index_name, index_value, where = None, user_name=None):
-        index_info = IndexInfo.get_table_index_info(self.table_name, index_name)
-        assert index_info != None
-
-        if self.user_attr != None and user_name == None and where != None:
-            user_name = where.get(self.user_attr)
-
-        if isinstance(index_value, dict):
-            assert len(index_value) == 1, "只能设置1个属性"
-            if index_value.get("$prefix") != None:
-                prefix_value = index_value.get("$prefix")
-                prefix_value_encoded = encode_index_value(prefix_value)
-                return self._get_index_prefix(index_name, user_name=user_name) + ":" + prefix_value_encoded
-            # TODO: 参考 mongodb 的 {$gt: 20} 这种格式的
-            raise NotImplementedError("暂未实现")
-        elif index_value != None:
-            index_value = encode_index_value(index_value)
-            return self._get_index_prefix(
-                index_name, user_name=user_name) + ":" + index_value + ":"
-        elif where != None:
-            cols = []
-            is_prefix_match = False
-            for col in index_info.columns:
-                col_value = where.get(col)
-                if col_value == None:
-                    break
-                if isinstance(col_value, dict):
-                    prefix = col_value.get("$prefix")
-                    if prefix != None:
-                        cols.append(prefix)
-                        is_prefix_match = True
-                        break
-                cols.append(where.get(col))
-
-            prefix_value_encoded = encode_index_value(cols)
-            if is_prefix_match == False and len(cols) > 0 and len(cols) < len(index_info.columns):
-                prefix_value_encoded += ","
-            return self._get_index_prefix(index_name, user_name=user_name) + ":" + prefix_value_encoded
-        else:
-            return self._get_index_prefix(index_name, user_name=user_name) + ":"
-
-
-    def count_by_index(self, index_name, filter_func=None, index_value=None, user_name=None, where = None):
-        validate_str(index_name, "index_name can not be empty")
-        index_info = IndexInfo.get_table_index_info(
-            self.table_name, index_name)
-        if index_info == None:
-            raise Exception("index not found: %s" % index_name)
-
-        prefix = self._get_index_prefix_by_value(index_name, index_value, where = where, user_name=user_name)
-        map_func = self.create_index_map_func(
-            filter_func, index_type=index_info.index_type, where = where)
-        return prefix_count_batch(prefix, map_func=map_func)
-    
-    def list_by_index(self, index_name, filter_func=None,
-                      offset=0, limit=20, *, reverse=False,
-                      index_value=None, user_name=None, where = None):
-        """通过索引查询结果列表
-        @param {str}  index_name 索引名称
-        @param {func} filter_func 过滤函数
-        @param {int}  offset 开始索引
-        @param {int}  limit  返回记录限制
-        @param {bool} reverse 是否逆向查询
-        """
-        validate_str(index_name, "index_name can not be empty")
-        index_info = IndexInfo.get_table_index_info(
-            self.table_name, index_name)
-        if index_info == None:
-            raise Exception("index not found: %s" % index_name)
-
-        prefix = self._get_index_prefix_by_value(index_name, index_value, where = where, user_name=user_name)
-        map_func = self.create_index_map_func(
-            filter_func, index_type=index_info.index_type, where = where)
-        return list(prefix_iter_batch(prefix, offset=offset, limit=limit,
-                                      map_func=map_func,
-                                      reverse=reverse, include_key=False))
-
-    def first_by_index(self, *args, **kw):
-        kw["limit"] = 1
-        result = self.list_by_index(*args, **kw)
-        if len(result) > 0:
-            return result[0]
-        return None
-
-    def count(self, filter_func=None, user_name=None, id_prefix=None, where = None):
-        if user_name == None and where != None and self.user_attr != None:
-            user_name = where.get(self.user_attr)
-
-        prefix = self._get_prefix(user_name=user_name)
-        if id_prefix != None:
-            prefix += encode_str(id_prefix)
-            
-        if filter_func == None:
-            return prefix_count_fast(prefix)
-
-        return prefix_count(prefix, filter_func)
-
-    def count_by_user(self, user_name):
-        return self.count(user_name=user_name)
-
-    def count_by_func(self, user_name, filter_func):
-        assert filter_func != None, "[count_by_func.assert] filter_func != None"
-        return self.count(user_name=user_name, filter_func=filter_func)
-
-    def drop_index(self, index_name):
-        for index in self.indexes:
-            if index.index_name == index_name:
-                index.drop()
-
-
-class PrefixedDb(LdbTable):
-    """plyvel中叫做prefixed_db"""
-    pass
-
-
-def insert(table_name, obj_value, sync=False):
-    """往指定表里面插入一条新记录"""
-    db = LdbTable(table_name)
-    return db.insert(obj_value)
-
-
-def prefix_iter_batch(prefix,  # type: str
-                      offset=0,  # type: int
-                      limit=-1,  # type: int
-                      reverse=False,
-                      include_key=False,
-                      map_func=None,
-                      fill_cache=False,
-                      batch_size=100):
-    """通过前缀迭代查询
-    @param {string} prefix 遍历前缀
-    @param {function} filter_func(str,object) 过滤函数
-    @param {function} map_func(str,object)    映射函数，如果返回不为空则认为匹配
-    @param {int} offset 选择的开始下标，包含
-    @param {int} limit  选择的数据行数
-    @param {boolean} reverse 是否反向遍历
-    @param {boolean} include_key 返回的数据是否包含key，默认只有value
-    """
-    db = check_get_leveldb()
-    prefix_str = prefix
-    prefix_bytes = prefix.encode("utf-8")
-
-    key_from = prefix_bytes
-    key_to = prefix_bytes + b'\xff'
-
-    iterator = db.RangeIter(key_from,
-                            key_to,
-                            include_value=True,
-                            reverse=reverse,
-                            fill_cache=fill_cache)
-
-    matched_offset = 0
-    result_size = 0
-
-    def do_iter():
-        batch_list = []
-        for key, value in iterator:
-            if not key.startswith(prefix_bytes):
-                break
-            key = key.decode("utf-8")
-            obj = convert_bytes_to_object(value)
-            if map_func == None:
-                yield key, obj
-            else:
-                batch_list.append((key, obj))
-                if len(batch_list) >= batch_size:
-                    for key, value in map_func(batch_list):
-                        yield key, value
-                    batch_list = []
-
-        if len(batch_list) > 0:
-            assert map_func != None
-            for key, obj in map_func(batch_list):
-                yield key, obj
-
-    for key, obj in do_iter():
-        if matched_offset >= offset:
-            result_size += 1
-            if include_key:
-                yield key, obj
-            else:
-                yield obj
-        matched_offset += 1
-
-        if limit > 0 and result_size >= limit:
-            break
-
-def prefix_count_batch(*args, **kw):
-    count = 0
-    kw["include_key"] = False
-    for obj in prefix_iter_batch(*args, **kw):
-        count+=1
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2021-12-04 21:22:40
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-24 15:53:03
+@FilePath     : /xnote/xutils/db/dbutil_table.py
+@Description  : 数据库表-API, 不建议使用, 建议使用 dbutil_table_v2
+"""
+
+from urllib.parse import quote
+from xutils import Storage
+from xutils.db.dbutil_base import *
+from xutils.db.dbutil_table_index import TableIndex, TableIndexRepair
+from xutils.db.encode import (
+    decode_str,
+    encode_index_value,
+    encode_str,
+    clean_value_before_update
+)
+from xutils.db.dbutil_id_gen import IdGenerator
+from xutils.db.binlog import BinLog
+from xutils.db import filters
+
+db = register_table("_id", "系统ID表")
+db.delete_table()
+
+register_table("_max_id", "最大ID")
+register_table("_index", "通用索引")
+register_table("_meta", "表元信息")
+register_table("_idx_version", "索引版本")
+
+db = register_table("_repair_error", "修复错误记录")
+db.register_index("ctime")
+
+class LdbTable:
+    """Deprecated: 建议使用 dbutil_table_v2
+    基于leveldb的表, 比较常见的是以下2种
+    * key = prefix:record_id           全局数据库
+    * key = prefix:user_name:record_id 用户(或者其他分片)维度数据
+
+    字段说明: 
+    * prefix    代表的是功能类型，比如猫和狗是两种不同的动物，锤子和手机是两种
+                不同的工具
+    * user_name 代表用户名，比如张三和李四，也可以是其他类型的对象ID，比如笔记ID
+    * record_id 代表一条记录的ID，从属于user_name
+
+    注: record_id建议使用全局ID，尽量避免多级主键，如果使用多级主键，移动记录会
+        比较麻烦，要重新构建主键
+    """
+
+    def __init__(self, table_name, user_name=None):
+        # 参数检查
+        check_table_name(table_name)
+        table_info = get_table_info(table_name)
+        assert table_info != None
+
+        self.table_name = table_name
+        self.key_name = "_key"
+        self.id_name = "_id"
+        self.prefix = table_name
+        self.user_name = user_name
+        self.table_info = table_info
+        self.index_names = table_info.get_index_names()
+        self._need_check_user = table_info.check_user
+        self.user_attr = None
+        self.id_gen = IdGenerator(self.table_name)
+        self.fix_user_attr = True
+        # 自定义索引构建器
+        self.build_index_func = None
+
+        if table_info.check_user:
+            if table_info.user_attr == None:
+                raise Exception("table({table_name}).user_attr can not be None".format(
+                    table_name=table_name))
+            self.user_attr = table_info.user_attr
+
+        self.binlog = BinLog.get_instance()
+        self.binlog_enabled = True
+        # TODO 索引用一个单例管理起来
+        self.indexes = self._build_indexes() # type: list[TableIndex]
+
+        if user_name != None:
+            assert user_name != ""
+            self.prefix += ":" + user_name
+
+        if self.prefix[-1] != ":":
+            self.prefix += ":"
+
+    def _build_indexes(self):
+        indexes = []
+        index_dict = IndexInfo.get_table_index_dict(self.table_name)
+        if index_dict != None:
+            for index_name in index_dict:
+                index_info = index_dict[index_name]
+                indexes.append(TableIndex(index_info))
+        return indexes
+
+    def set_binlog_enabled(self, enabled=True):
+        self.binlog_enabled = enabled
+
+    def _build_key(self, *argv):
+        return self.prefix + self._build_key_no_prefix(*argv)
+
+    def _build_key_with_user(self, id, user_name):
+        return self._build_key_no_prefix(self.table_name, user_name or self.user_name, id)
+
+    def _build_key_no_prefix(self, *argv):
+        return ":".join(filter(None, argv))
+
+    def _get_key_from_obj(self, obj):
+        validate_dict(obj, "obj is not dict")
+        return obj.get(self.key_name)
+
+    def _get_id_from_obj(self, obj):
+        key = self._get_key_from_obj(obj)
+        return key.rsplit(":", 1)[-1]
+
+    def _get_id_from_key(self, key):
+        return decode_str(key.rsplit(":", 1)[-1])
+
+    def _get_user_from_key(self, key):
+        parts = key.split(":")
+        assert len(parts) == 3, parts
+        return parts[1]
+
+    def _format_value(self, key, value):
+        if not isinstance(value, dict):
+            value = Storage(_raw=value)
+
+        value[self.key_name] = key
+        value[self.id_name] = self._get_id_from_key(key)
+        if self.user_attr != None and self.fix_user_attr:
+            user = value.get(self.user_attr)
+            parts = key.split(":")
+            if user == None and len(parts) == 3:
+                value[self.user_attr] = parts[1]
+        return value
+
+    def _convert_to_db_row(self, obj):
+        obj_copy = dict(**obj)
+        clean_value_before_update(obj_copy)
+        return obj_copy
+
+    def _create_new_id(self, id_type="uuid", id_value=None):
+        return self.id_gen.create_new_id(id_type, id_value)
+
+    def _check_before_delete(self, key):
+        if not key.startswith(self.prefix):
+            raise Exception("invalid key:%s" % key)
+
+    def _check_value(self, obj, key=""):
+        if not isinstance(obj, dict):
+            raise Exception("key:%r, invalid obj:%r, expected dict" % (key, obj))
+
+    def _check_key(self, key):
+        if not key.startswith(self.prefix):
+            raise Exception("invalid key:(%s), prefix:(%s)" %
+                            (key, self.prefix))
+
+    def _check_index_name(self, index_name):
+        validate_str(index_name, "invalid index_name:%r" % index_name)
+        if index_name not in self.index_names:
+            raise Exception("invalid index_name:%r" % index_name)
+
+    def _check_user_name(self, user_name):
+        user_name = self.user_name or user_name
+        if self._need_check_user:
+            validate_str(user_name, "invalid user_name:{!r}", user_name)
+
+    def _get_prefix(self, user_name=None):
+        user_name = self.user_name or user_name
+        if user_name is None:
+            return self.table_name + ":"
+        else:
+            return self.table_name + ":" + encode_str(user_name) + ":"
+
+    def _update_index(self, old_obj, new_obj, batch, force_update=False):
+        if self.build_index_func != None:
+            self.build_index_func(new_obj=new_obj, old_obj=old_obj, force_update=force_update)
+            return
+        
+        for index in self.indexes:
+            index.update_index(old_obj, new_obj, batch, force_update)
+
+    def _delete_index(self, old_obj, batch):
+        for index in self.indexes:
+            index.delete_index(old_obj, batch)
+
+    def _put_obj(self, key, obj, sync=False):
+        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
+        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
+        # 使用leveldb的批量操作可以确保不会读到未提交的数据
+        batch = create_write_batch()
+        with get_write_lock(key):
+            old_obj = db_get(key)
+            self._format_value(key, old_obj)
+            batch.put(key, self._convert_to_db_row(obj))
+            self._update_index(old_obj, obj, batch)
+            if self.binlog_enabled:
+                self.binlog.add_log(
+                    "put", key, obj, batch=batch, old_value=old_obj)
+            # 更新批量操作
+            batch.commit(sync)
+
+    def _insert_obj(self, key, obj, sync=False):
+        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
+        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
+        # 使用leveldb的批量操作可以确保不会读到未提交的数据
+        batch = create_write_batch()
+        with get_write_lock(key):
+            old_obj = db_get(key)
+            self._format_value(key, old_obj)
+            batch.insert(key, self._convert_to_db_row(obj))
+            self._update_index(old_obj, obj, batch)
+            if self.binlog_enabled:
+                self.binlog.add_log(
+                    "put", key, obj, batch=batch, old_value=old_obj)
+            # 更新批量操作
+            batch.commit(sync)
+
+    def is_valid_key(self, key=None, user_name=None):
+        assert isinstance(key, str)
+        if user_name is None:
+            return key.startswith(self.prefix)
+        else:
+            return key.startswith(self.prefix + user_name)
+
+    def get_by_id(self, row_id, default_value=None, user_name=None):
+        """通过ID查询记录
+        :param row_id: 记录ID
+        :param default_value: 默认值
+        :param user_name: 用户标识
+        """
+        row_id = str(row_id)
+        
+        if self._need_check_user:
+            validate_str(user_name, "invalid user_name:{!r}", user_name)
+
+        row_id = encode_str(row_id)
+        key = self._build_key_with_user(row_id, user_name=user_name)
+        return self.get_by_key(key, default_value)
+
+    def batch_get_by_id(self, row_id_list, default_value=None, user_name=None):
+        for row_id in row_id_list:
+            validate_str(row_id, "invalid row_id:{!r}", row_id)
+            if self._need_check_user:
+                validate_str(user_name, "invalid user_name:{!r}", user_name)
+
+        key_list = []
+        key_id_dict = {}
+        for row_id in row_id_list:
+            q_row_id = encode_str(row_id)
+            key = self._build_key_with_user(q_row_id, user_name=user_name)
+            key_list.append(key)
+            key_id_dict[key] = row_id
+
+        result = dict()
+        key_result = self.batch_get_by_key(
+            key_list, default_value=default_value)
+        for key in key_result:
+            object = key_result.get(key)
+            id = key_id_dict.get(key)
+            result[id] = object
+        return result
+
+    def get_by_key(self, key, default_value=None):
+        """通过key查询记录
+        :param key: kv数据库的key
+        :param default_value: 默认值
+        """
+        if key == "":
+            return None
+        self._check_key(key)
+        value = db_get(key, default_value)
+        if value is None:
+            return None
+
+        return self._format_value(key, value)
+
+    def batch_get_by_key(self, key_list, default_value=None):
+        for key in key_list:
+            self._check_key(key)
+
+        batch_result = db_batch_get(key_list, default_value)
+        for key in batch_result:
+            value = batch_result.get(key)
+            if value is None:
+                batch_result[key] = None
+                continue
+            batch_result[key] = self._format_value(key, value)
+
+        return batch_result
+
+    def insert(self, obj, id_type="auto_increment", id_value=None, max_retry=10):
+        """插入新数据
+        @param {object} obj 插入的对象
+        @param {string} id_type id类型
+        """
+        self._check_value(obj)
+
+        if id_value != None:
+            max_retry = 1
+
+        user_name = None
+        if self._need_check_user:
+            user_name = obj.get(self.user_attr)
+
+        new_id = "1"
+        with get_write_lock(self.table_name):
+            # TODO 优化加锁逻辑
+            for i in range(max_retry):
+                new_id = self.id_gen.create_new_id(id_type, id_value)
+                key = self._build_key_with_user(new_id, user_name=user_name)
+                conflict = self.get_by_key(key)
+                if conflict != None:
+                    continue
+
+                obj[self.key_name] = key
+                obj[self.id_name] = new_id
+
+                self._put_obj(key, obj)
+                return new_id
+        raise Exception("insert conflict, id=%s" % new_id)
+
+    def insert_by_user(self, user_name, obj, id_type="auto_increment"):
+        """@deprecated 定义user_attr之后使用insert即可满足
+        指定用户名插入数据
+        """
+        if self.user_name != None:
+            raise Exception("table实例已经设置了user_name, 不能使用该方法")
+
+        validate_str(user_name, "invalid user_name")
+        self._check_value(obj)
+            
+        with get_write_lock(self.table_name):
+            for i in range(10):
+                new_id = self._create_new_id(id_type)
+                key = self._build_key_with_user(new_id, user_name)
+                conflict = self.get_by_key(key)
+                if conflict != None:
+                    continue
+                self._put_obj(key, obj)
+                return key
+        raise Exception("insert conflict")
+
+    def update(self, obj):
+        """从`obj`中获取主键`key`进行更新"""
+        self._check_value(obj)
+
+        obj_key = self._get_key_from_obj(obj)
+        assert isinstance(obj_key, str), "obj_key must be str"
+        
+        self._check_key(obj_key)
+
+        self._put_obj(obj_key, obj)
+
+    def put_by_id(self, id, obj, user_name=None, encode_key=True):
+        """通过ID进行更新，如果key包含用户，必须有user_name(初始化定义或者传入参数)
+        :param {str} id: 指定ID
+        :param {dict} obj: 写入的对象
+        :param {str|None} user_name: 用户分片
+        :param encode_key=True: 是否对key进行编码,用于处理特殊字符
+        """
+        id = str(id)
+        if self.user_name != None and user_name != None:
+            raise DBException("table实例已经设置了user_name，不能再通过参数设置")
+
+        if encode_key:
+            id = encode_str(id)
+
+        if self.user_attr != None:
+            user_name = obj.get(self.user_attr)
+            if user_name == None:
+                raise DBException("%s属性未设置" % self.user_attr)
+
+        self._check_user_name(user_name)
+        key = self._build_key_with_user(id, user_name)
+        self.update_by_key(key, obj)
+
+    update_by_id = put_by_id
+
+    def update_by_key(self, key, obj):
+        """直接通过`key`进行更新"""
+        self._check_key(key)
+        self._check_value(obj, key=key)
+
+        obj[self.key_name] = key
+        obj[self.id_name] = self._get_id_from_key(key)
+        
+        update_obj = obj
+        self._put_obj(key, update_obj)
+
+    def rebuild_single_index(self, obj, user_name=None):
+        self._check_value(obj)
+        self._check_user_name(user_name)
+
+        key = self._get_key_from_obj(obj)
+        batch = create_write_batch()
+        with get_write_lock(key):
+            old_obj = get(key)
+            self._format_value(key, obj)
+            self._update_index(old_obj, obj, batch,
+                               force_update=True)
+            # 更新批量操作
+            batch.commit()
+
+    def repair_index(self):
+        repair = TableIndexRepair(self, LdbTable("_repair_error"))
+        repair.table_name = self.table_name
+        repair.repair_index()
+
+    def rebuild_index(self, version="v1"):
+        """重建索引, 可以通过设置新的version值重新建立索引"""
+        idx_version_key = "_idx_version:%s" % self.table_name
+        current_version = db_get(idx_version_key)
+        if current_version == version:
+            logging.info("当前索引已经是最新版本, table=%s, version=%s" %
+                            (self.table_name, version))
+            return
+        self.repair_index()
+        db_put(idx_version_key, version)
+
+    def delete(self, obj):
+        obj_key = self._get_key_from_obj(obj)
+        self.delete_by_key(obj_key)
+
+    def batch_delete(self, obj_list=[]):
+        if len(obj_list) == 0:
+            return
+        keys = []
+        for obj in obj_list:
+            key = self._get_key_from_obj(obj)
+            keys.append(key)
+        db_batch_delete(keys)
+
+    def delete_by_id(self, id, user_name=None):
+        id = str(id)
+        key = self._build_key_with_user(id, user_name)
+        self.delete_by_key(key)
+
+    def delete_by_key(self, key, user_name=None):
+        validate_str(key, "delete_by_key: invalid key")
+        self._check_before_delete(key)
+        assert self.is_valid_key(key, user_name), "key校验失败"
+
+        old_obj = get(key)
+        if old_obj is None:
+            return
+
+        self._format_value(key, old_obj)
+        with get_write_lock(key):
+            batch = create_write_batch()
+            self._delete_index(old_obj, batch)
+            # 更新批量操作
+            batch.delete(key)
+            if self.binlog_enabled:
+                self.binlog.add_log("delete", key, old_obj,
+                                    batch=batch, old_value=old_obj)
+            batch.commit()
+
+    def iter(self, offset=0, limit=20, reverse=False, key_from=None,
+             filter_func=None, where = None, fill_cache=False, user_name=None):
+        """返回一个遍历的迭代器
+        :param {int} offset: 返回结果下标开始
+        :param {int} limit:  返回结果最大数量
+        :param {bool} reverse: 返回结果是否逆序
+        :param {dict} where: where查询条件
+        :param {str} key_from: 开始的key，这里是相对的key，也就是不包含table_name
+        :param {func} filter_func: 过滤函数
+        :param {str} user_name: 用户标识
+        """
+        if key_from == "":
+            key_from = None
+
+        if key_from != None:
+            key_from = self._build_key(key_from)
+        
+        if user_name == None and where != None and self.user_attr != None:
+            user_name = where.get(self.user_attr)
+
+        if user_name != None:
+            prefix = self.table_name + ":" + user_name
+        else:
+            prefix = self.prefix
+
+        if where != None:
+            filter_func = filters.create_func_by_where(where, filter_func)
+
+        for key, value in prefix_iter(prefix, filter_func, offset, limit,
+                                      reverse=reverse, include_key=True, key_from=key_from,
+                                      fill_cache=fill_cache):
+            yield self._format_value(key, value)
+
+    def list(self, *args, **kw):
+        """查询记录列表,参数和`iter`保持一致"""
+        result = []
+        for value in self.iter(*args, **kw):
+            result.append(value)
+        return result
+
+    def get_first(self, filter_func=None, *, where = None, user_name=None):
+        """读取第一个满足条件的数据"""
+        result = self.list(limit=1, filter_func=filter_func, where = where,
+                           user_name=user_name)
+        if len(result) > 0:
+            return result[0]
+        else:
+            return None
+    
+    def get_last(self, filter_func=None, *, user_name=None):
+        """读取最后一个满足条件的数据"""
+        result = self.list(limit=1, reverse=True,
+                           filter_func=filter_func, user_name=user_name)
+        if len(result) > 0:
+            return result[0]
+        else:
+            return None
+
+    def list_by_user(self, user_name, offset=0, limit=20, reverse=False):
+        if self.user_name != None:
+            raise Exception("table实例的user_name已经设置，不能使用该方法")
+
+        return self.list(offset=offset, limit=limit, reverse=reverse, user_name=user_name)
+
+    def list_by_func(self, user_name, filter_func=None,
+                     offset=0, limit=20, reverse=False):
+        return self.list(offset=offset, limit=limit, reverse=reverse,
+                         filter_func=filter_func, user_name=user_name)
+
+    def create_index_map_func(self, filter_func, where = None, index_type="ref"):
+        if where != None:
+            filter_func = filters.create_func_by_where(where, filter_func)
+
+        def map_func_for_copy(batch_list):
+            result = []
+            for key, value in batch_list:
+                obj_key = value.get("key")
+                obj_value = value.get("value")
+                self._format_value(obj_key, obj_value)
+                if isinstance(obj_value, dict):
+                    obj_value = Storage(**obj_value)
+
+                # 这里应该是使用obj参数来过滤
+                if filter_func == None:
+                    is_match = True
+                else:
+                    is_match = filter_func(obj_key, obj_value)
+                
+                if is_match:
+                    result.append((key, obj_value))
+
+            return result
+
+        def map_func_for_ref(batch_list):
+            # 先判断实例是否存在
+            # 普通的引用索引
+            result = []
+            key_list = []
+            obj_dict = {}
+            for key, ref_key in batch_list:
+                key_list.append(ref_key)
+
+            obj_dict = self.batch_get_by_key(key_list)
+
+            for key, ref_key in batch_list:
+                obj = obj_dict.get(ref_key)
+
+                if obj is None:
+                    # 异步 delete(key)
+                    logging.warning("invalid key:(%s)", key)
+                    continue
+
+                # 检查key是否匹配
+                obj_id = key.rsplit(":", 1)[-1]
+                key_obj_id_temp = self._get_id_from_obj(obj)
+                key_obj_id = quote(key_obj_id_temp)
+                if obj_id != key_obj_id:
+                    logging.warning(
+                        "invalid obj_id:(%s), obj_id:(%s)", obj_id, key_obj_id)
+                    continue
+                
+                self._format_value(ref_key, obj)
+
+                # 用于调试
+                # setattr(obj, "_idx_key", key)
+                # 这里应该是使用obj参数来过滤
+                if filter_func == None:
+                    is_match = True
+                else:
+                    is_match = filter_func(key, obj)
+                
+                if is_match:
+                    result.append((key, obj))
+            return result
+
+        if index_type == "copy":
+            return map_func_for_copy
+
+        return map_func_for_ref
+    
+    
+    def _get_index_prefix(self, index_name, user_name=None):
+        self._check_index_name(index_name)
+        self._check_user_name(user_name)
+
+        index_prefix = IndexInfo.build_prefix(self.table_name, index_name)
+        return self._build_key_no_prefix(index_prefix, self.user_name or user_name)
+
+    def _get_index_prefix_by_value(self, index_name, index_value, where = None, user_name=None):
+        index_info = IndexInfo.get_table_index_info(self.table_name, index_name)
+        assert index_info != None
+
+        if self.user_attr != None and user_name == None and where != None:
+            user_name = where.get(self.user_attr)
+
+        if isinstance(index_value, dict):
+            assert len(index_value) == 1, "只能设置1个属性"
+            if index_value.get("$prefix") != None:
+                prefix_value = index_value.get("$prefix")
+                prefix_value_encoded = encode_index_value(prefix_value)
+                return self._get_index_prefix(index_name, user_name=user_name) + ":" + prefix_value_encoded
+            # TODO: 参考 mongodb 的 {$gt: 20} 这种格式的
+            raise NotImplementedError("暂未实现")
+        elif index_value != None:
+            index_value = encode_index_value(index_value)
+            return self._get_index_prefix(
+                index_name, user_name=user_name) + ":" + index_value + ":"
+        elif where != None:
+            cols = []
+            is_prefix_match = False
+            for col in index_info.columns:
+                col_value = where.get(col)
+                if col_value == None:
+                    break
+                if isinstance(col_value, dict):
+                    prefix = col_value.get("$prefix")
+                    if prefix != None:
+                        cols.append(prefix)
+                        is_prefix_match = True
+                        break
+                cols.append(where.get(col))
+
+            prefix_value_encoded = encode_index_value(cols)
+            if is_prefix_match == False and len(cols) > 0 and len(cols) < len(index_info.columns):
+                prefix_value_encoded += ","
+            return self._get_index_prefix(index_name, user_name=user_name) + ":" + prefix_value_encoded
+        else:
+            return self._get_index_prefix(index_name, user_name=user_name) + ":"
+
+
+    def count_by_index(self, index_name, filter_func=None, index_value=None, user_name=None, where = None):
+        validate_str(index_name, "index_name can not be empty")
+        index_info = IndexInfo.get_table_index_info(
+            self.table_name, index_name)
+        if index_info == None:
+            raise Exception("index not found: %s" % index_name)
+
+        prefix = self._get_index_prefix_by_value(index_name, index_value, where = where, user_name=user_name)
+        map_func = self.create_index_map_func(
+            filter_func, index_type=index_info.index_type, where = where)
+        return prefix_count_batch(prefix, map_func=map_func)
+    
+    def list_by_index(self, index_name, filter_func=None,
+                      offset=0, limit=20, *, reverse=False,
+                      index_value=None, user_name=None, where = None):
+        """通过索引查询结果列表
+        @param {str}  index_name 索引名称
+        @param {func} filter_func 过滤函数
+        @param {int}  offset 开始索引
+        @param {int}  limit  返回记录限制
+        @param {bool} reverse 是否逆向查询
+        """
+        validate_str(index_name, "index_name can not be empty")
+        index_info = IndexInfo.get_table_index_info(
+            self.table_name, index_name)
+        if index_info == None:
+            raise Exception("index not found: %s" % index_name)
+
+        prefix = self._get_index_prefix_by_value(index_name, index_value, where = where, user_name=user_name)
+        map_func = self.create_index_map_func(
+            filter_func, index_type=index_info.index_type, where = where)
+        return list(prefix_iter_batch(prefix, offset=offset, limit=limit,
+                                      map_func=map_func,
+                                      reverse=reverse, include_key=False))
+
+    def first_by_index(self, *args, **kw):
+        kw["limit"] = 1
+        result = self.list_by_index(*args, **kw)
+        if len(result) > 0:
+            return result[0]
+        return None
+
+    def count(self, filter_func=None, user_name=None, id_prefix=None, where = None):
+        if user_name == None and where != None and self.user_attr != None:
+            user_name = where.get(self.user_attr)
+
+        prefix = self._get_prefix(user_name=user_name)
+        if id_prefix != None:
+            prefix += encode_str(id_prefix)
+            
+        if filter_func == None:
+            return prefix_count_fast(prefix)
+
+        return prefix_count(prefix, filter_func)
+
+    def count_by_user(self, user_name):
+        return self.count(user_name=user_name)
+
+    def count_by_func(self, user_name, filter_func):
+        assert filter_func != None, "[count_by_func.assert] filter_func != None"
+        return self.count(user_name=user_name, filter_func=filter_func)
+
+    def drop_index(self, index_name):
+        for index in self.indexes:
+            if index.index_name == index_name:
+                index.drop()
+
+
+class PrefixedDb(LdbTable):
+    """plyvel中叫做prefixed_db"""
+    pass
+
+
+def insert(table_name, obj_value, sync=False):
+    """往指定表里面插入一条新记录"""
+    db = LdbTable(table_name)
+    return db.insert(obj_value)
+
+
+def prefix_iter_batch(prefix,  # type: str
+                      offset=0,  # type: int
+                      limit=-1,  # type: int
+                      reverse=False,
+                      include_key=False,
+                      map_func=None,
+                      fill_cache=False,
+                      batch_size=100):
+    """通过前缀迭代查询
+    @param {string} prefix 遍历前缀
+    @param {function} filter_func(str,object) 过滤函数
+    @param {function} map_func(str,object)    映射函数，如果返回不为空则认为匹配
+    @param {int} offset 选择的开始下标，包含
+    @param {int} limit  选择的数据行数
+    @param {boolean} reverse 是否反向遍历
+    @param {boolean} include_key 返回的数据是否包含key，默认只有value
+    """
+    db = check_get_leveldb()
+    prefix_str = prefix
+    prefix_bytes = prefix.encode("utf-8")
+
+    key_from = prefix_bytes
+    key_to = prefix_bytes + b'\xff'
+
+    iterator = db.RangeIter(key_from,
+                            key_to,
+                            include_value=True,
+                            reverse=reverse,
+                            fill_cache=fill_cache)
+
+    matched_offset = 0
+    result_size = 0
+
+    def do_iter():
+        batch_list = []
+        for key, value in iterator:
+            if not key.startswith(prefix_bytes):
+                break
+            key = key.decode("utf-8")
+            obj = convert_bytes_to_object(value)
+            if map_func == None:
+                yield key, obj
+            else:
+                batch_list.append((key, obj))
+                if len(batch_list) >= batch_size:
+                    for key, value in map_func(batch_list):
+                        yield key, value
+                    batch_list = []
+
+        if len(batch_list) > 0:
+            assert map_func != None
+            for key, obj in map_func(batch_list):
+                yield key, obj
+
+    for key, obj in do_iter():
+        if matched_offset >= offset:
+            result_size += 1
+            if include_key:
+                yield key, obj
+            else:
+                yield obj
+        matched_offset += 1
+
+        if limit > 0 and result_size >= limit:
+            break
+
+def prefix_count_batch(*args, **kw):
+    count = 0
+    kw["include_key"] = False
+    for obj in prefix_iter_batch(*args, **kw):
+        count+=1
     return count
```

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_table_index.py` & `xnote-web-0.1.1/xutils/db/dbutil_table_index.py`

 * *Ordering differences only*

 * *Files 16% similar despite different names*

```diff
@@ -1,329 +1,329 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-05-22 22:04:41
-@LastEditors  : xupingmao
-@LastEditTime : 2023-07-23 11:53:51
-@FilePath     : /xnote/xutils/db/dbutil_table_index.py
-@Description  : 表索引管理,不建议继续使用,推荐使用关系型数据库或者搜索引擎构建索引
-                - [x] 引用索引
-                - [x] 聚集索引支持
-                - [x] 联合索引支持
-"""
-
-import logging
-import xutils
-import time
-from xutils import Storage
-from xutils.db.encode import encode_index_value, clean_value_before_update, decode_str, KeyParser
-from xutils.db.dbutil_base import (
-    db_delete, 
-    db_get, 
-    validate_obj, 
-    validate_str, 
-    validate_dict, 
-    prefix_iter, 
-    delete_index_count_cache,
-    IndexInfo,
-)
-from xutils.db import dbutil_base
-from xutils.interfaces import BatchInterface
-
-class TableIndex:
-
-    def __init__(self, index_info: IndexInfo):
-        table_name = index_info.table_name
-        index_name = index_info.index_name
-
-        table_info = dbutil_base.TableInfo.get_by_name(table_name)
-        assert table_info != None
-
-        self.index_info = index_info
-        self.user_attr = table_info.user_attr
-        self.index_name = index_name
-        self.table_name = table_name
-        self.key_name = "_key"
-        self.check_user = table_info.check_user
-        self.prefix = IndexInfo.build_prefix(self.table_name, index_name)
-        self.index_type = index_info.index_type
-        self.index_info = index_info
-        self.debug = False
-
-        if self.check_user and self.user_attr == None:
-            raise Exception("user_attr没有注册, table_name:%s" % table_name)
-
-    def _get_prefix(self, user_name=None):
-        prefix = self.prefix
-
-        if user_name != None:
-            prefix += ":" + encode_index_value(user_name)
-
-        return prefix
-    
-    def get_prefix_by_obj(self, obj):
-        prefix = self.prefix
-        user_name = self._get_user_name(obj)
-        if user_name != None:
-            prefix += ":" + encode_index_value(user_name)
-
-        return prefix
-    
-
-    def _get_key_from_obj(self, obj):
-        validate_dict(obj, "obj is not dict")
-        return obj.get(self.key_name)
-
-    def _get_id_from_obj(self, obj):
-        key = self._get_key_from_obj(obj)
-        if key == None:
-            return None
-        return key.rsplit(":", 1)[-1]
-
-    def _get_user_name(self, obj):
-        if self.user_attr != None:
-            user_name = obj.get(self.user_attr)
-            if user_name == None:
-                raise Exception("({table_name}).{user_attr} is required, obj:{obj}".format(
-                    table_name=self.table_name, user_attr=self.user_attr, obj=obj))
-            return user_name
-        else:
-            return None
-    
-    def get_index_key(self, obj: dict):
-        assert obj != None
-        assert isinstance(obj, dict)
-
-        encoded_value = self.get_index_value(obj)
-        obj_id = self._get_id_from_obj(obj)
-        encoded_id = encode_index_value(obj_id)
-        index_prefix = self.get_prefix_by_obj(obj)
-        index_key = index_prefix + ":" + encoded_value + ":" + encoded_id
-        return index_key, encoded_value
-    
-    def get_index_value(self, obj) -> str:
-        if len(self.index_info.columns) > 1:
-            result = []
-            for colname in self.index_info.columns:
-                value = obj.get(colname)
-                result.append(encode_index_value(value))
-            return ",".join(result)
-        else:
-            index_attr = self.index_info.columns[0]
-            value = obj.get(index_attr)
-            return encode_index_value(value)
-
-    def update_index(self, old_obj, new_obj: dict, batch: BatchInterface, force_update=False):
-        index_name = self.index_name
-        assert isinstance(new_obj, dict), "new_obj must be dict"
-
-        # 插入的时候old_obj为空
-        obj_id = self._get_id_from_obj(new_obj)
-        obj_key = self._get_key_from_obj(new_obj)
-        validate_str(obj_id, "invalid obj_id")
-
-        old_index_key = ""
-        new_index_key, new_index_value = self.get_index_key(new_obj)
-
-        if old_obj != None and isinstance(old_obj, dict):
-            # 旧的数据必须为dict类型
-            old_index_key, _ = self.get_index_key(old_obj)
-
-        # 索引值是否变化
-        index_changed = (new_index_key != old_index_key)
-        need_update = self.index_type == "copy" or index_changed
-
-        if not need_update:
-            if self.debug:
-                logging.debug("index value unchanged, index_name:(%s), value:(%s)",
-                            index_name, old_index_key)
-            if not force_update:
-                return
-
-        assert isinstance(new_index_key, str)
-
-        # 只要有旧的记录，就要清空旧索引值
-        if old_index_key != "" and index_changed:
-            batch.check_and_delete(old_index_key)
-
-        if self.index_info.ignore_none_value and new_index_value == chr(0):
-            # None值不处理
-            return
-
-        # 新的索引值始终更新
-        if self.index_type == "copy":
-            clean_obj = dict(**new_obj)
-            clean_value_before_update(clean_obj)
-            index_value = dict(key = obj_key, value = clean_obj)
-            batch.check_and_put(new_index_key, index_value)
-        else:
-            # ref
-            batch.check_and_put(new_index_key, obj_key)
-
-    def delete_index(self, old_obj, batch):
-        assert old_obj != None
-        assert batch != None, "batch can not be None"
-        if isinstance(old_obj, dict):
-            index_key, _ = self.get_index_key(old_obj)
-            batch.delete(index_key)
-    
-    def drop(self):
-        for key, value in prefix_iter(self.prefix, limit=-1, include_key=True):
-            db_delete(key)
-
-
-class ErrorLog(Storage):
-
-    def __init__(self, **kw):
-        super().__init__(**kw)
-        self.key = ""
-        self.value = ""
-        self.ctime = "1970-01-01 00:00:00"
-        self.type = "exception"
-        self.err_msg = "error"
-
-class TableIndexRepair:
-    """表索引修复工具，不是标准功能，所以抽象到一个新的类里面"""
-
-    def __init__(self, db, error_db):
-        self.db = db
-        self.repair_error_db = error_db
-        self.table_name = ""
-        self.debug = False
-    
-    def current_time(self):
-        return time.strftime('%Y-%m-%d %H:%M:%S')
-
-    def repair_index(self):
-        try:
-            self.do_repair_index()
-        except:
-            err_msg = xutils.print_exc()
-            error_log = ErrorLog()
-            error_log.ctime = self.current_time()
-            error_log.err_msg = err_msg
-            self.repair_error_db.insert(error_log)
-
-    def do_repair_index(self):
-        db = self.db
-
-        if len(db.index_names) == 0:
-            return
-
-        # 先删除无效的索引，这样速度更快
-        for name in db.index_names:
-            prefix1 = "_index$%s$%s" % (db.table_name, name)      # v1版本的索引前缀
-            prefix2 = IndexInfo.build_prefix(db.table_name, name) # v2版本的索引前缀
-            self.delete_invalid_index(name, prefix1)
-            self.delete_invalid_index(name, prefix2)
-
-        for value in db.iter(limit=-1):
-            if db._need_check_user:
-                key = value._key
-                assert xutils.is_str(key)
-                try:
-                    parts = key.split(":")
-                    if len(parts) != 3:
-                        logging.error("invalid key: %s", key)
-                        error_log = ErrorLog()
-                        error_log.key = key
-                        error_log.value = value
-                        error_log.type = "record"
-                        error_log.ctime = self.current_time()
-                        self.repair_error_db.insert(error_log)
-                        db_delete(key)
-                        continue
-                    table_name, user_name, id = key.split(":")
-                    user_name = decode_str(user_name)
-                except ValueError:
-                    xutils.print_exc()
-                    logging.error("invalid record key: %s", key)
-                    continue
-                db.rebuild_single_index(value, user_name=user_name)
-            else:
-                db.rebuild_single_index(value)
-        
-        # 清理count缓存
-        for name in db.index_names:
-            delete_index_count_cache(db.table_name, name)
-
-    def do_delete(self, key):
-        if self.debug:
-            logging.info("Delete {%s}", key)
-
-        if not self.is_index_key(key):
-            logging.warning("Invalid index key:(%s)", key)
-            return
-        db_delete(key)
-    
-    def is_index_key(self, key):
-        return key.startswith("_index$") or key.startswith(self.table_name + "$")
-
-    def get_record_attr(self, record, key):
-        # TODO 要改成按照 columns 去组装索引的值
-        if isinstance(record, dict):
-            return record.get(key)
-        if hasattr(record, key):
-            return getattr(record, key)
-        return None
-
-    def delete_invalid_index(self, index_name, index_prefix):
-        db = self.db
-        index_info = dbutil_base.IndexInfo.get_table_index_info(self.table_name, index_name)
-        assert isinstance(index_info, IndexInfo)
-        index = TableIndex(index_info)
-
-        for old_key, index_object in prefix_iter(index_prefix, include_key=True):
-            if isinstance(index_object, dict):
-                # copy
-                record = index_object.get("value")
-                record_key = index_object.get("key")
-            else:
-                # ref
-                record_key = index_object
-                record = db_get(record_key)
-            
-            # record_key是主数据的key
-                
-            if record is None:
-                logging.debug("empty record, key:(%s), record_id:(%s)",
-                              old_key, record_key)
-                self.do_delete(old_key)
-                continue
-
-            if not isinstance(record_key, str):
-                logging.debug("invalid record key, key:(%s), record_id:(%s)",
-                              old_key, record_key)
-                self.do_delete(old_key)
-                continue
-
-            user_name = None
-            encoded_index_value = index.get_index_value(record)
-            record_id = db._get_id_from_key(record_key)
-
-            if db._need_check_user:
-                try:
-                    parser = KeyParser(record_key)
-                    table_name = parser.pop_left()
-                    user_name = parser.pop_left()
-                    user_name = decode_str(user_name)
-                except:
-                    logging.error("invalid key: (%s)", record_key)
-                    error_log = ErrorLog()
-                    error_log.key = old_key
-                    error_log.value = str(record_key)
-                    error_log.type = "index"
-                    error_log.ctime = self.current_time()
-                    self.repair_error_db.insert(error_log)
-                    self.do_delete(old_key)
-                    continue
-
-            prefix = db._get_index_prefix(index_name, user_name)
-            new_key = db._build_key_no_prefix(
-                prefix, encoded_index_value, record_id)
-
-            if new_key != old_key:
-                logging.debug("index dismatch, key:(%s), record_id:(%s), correct_key:(%s)",
-                              old_key, record_key, new_key)
-                self.do_delete(old_key)
-
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-05-22 22:04:41
+@LastEditors  : xupingmao
+@LastEditTime : 2023-07-23 11:53:51
+@FilePath     : /xnote/xutils/db/dbutil_table_index.py
+@Description  : 表索引管理,不建议继续使用,推荐使用关系型数据库或者搜索引擎构建索引
+                - [x] 引用索引
+                - [x] 聚集索引支持
+                - [x] 联合索引支持
+"""
+
+import logging
+import xutils
+import time
+from xutils import Storage
+from xutils.db.encode import encode_index_value, clean_value_before_update, decode_str, KeyParser
+from xutils.db.dbutil_base import (
+    db_delete, 
+    db_get, 
+    validate_obj, 
+    validate_str, 
+    validate_dict, 
+    prefix_iter, 
+    delete_index_count_cache,
+    IndexInfo,
+)
+from xutils.db import dbutil_base
+from xutils.interfaces import BatchInterface
+
+class TableIndex:
+
+    def __init__(self, index_info: IndexInfo):
+        table_name = index_info.table_name
+        index_name = index_info.index_name
+
+        table_info = dbutil_base.TableInfo.get_by_name(table_name)
+        assert table_info != None
+
+        self.index_info = index_info
+        self.user_attr = table_info.user_attr
+        self.index_name = index_name
+        self.table_name = table_name
+        self.key_name = "_key"
+        self.check_user = table_info.check_user
+        self.prefix = IndexInfo.build_prefix(self.table_name, index_name)
+        self.index_type = index_info.index_type
+        self.index_info = index_info
+        self.debug = False
+
+        if self.check_user and self.user_attr == None:
+            raise Exception("user_attr没有注册, table_name:%s" % table_name)
+
+    def _get_prefix(self, user_name=None):
+        prefix = self.prefix
+
+        if user_name != None:
+            prefix += ":" + encode_index_value(user_name)
+
+        return prefix
+    
+    def get_prefix_by_obj(self, obj):
+        prefix = self.prefix
+        user_name = self._get_user_name(obj)
+        if user_name != None:
+            prefix += ":" + encode_index_value(user_name)
+
+        return prefix
+    
+
+    def _get_key_from_obj(self, obj):
+        validate_dict(obj, "obj is not dict")
+        return obj.get(self.key_name)
+
+    def _get_id_from_obj(self, obj):
+        key = self._get_key_from_obj(obj)
+        if key == None:
+            return None
+        return key.rsplit(":", 1)[-1]
+
+    def _get_user_name(self, obj):
+        if self.user_attr != None:
+            user_name = obj.get(self.user_attr)
+            if user_name == None:
+                raise Exception("({table_name}).{user_attr} is required, obj:{obj}".format(
+                    table_name=self.table_name, user_attr=self.user_attr, obj=obj))
+            return user_name
+        else:
+            return None
+    
+    def get_index_key(self, obj: dict):
+        assert obj != None
+        assert isinstance(obj, dict)
+
+        encoded_value = self.get_index_value(obj)
+        obj_id = self._get_id_from_obj(obj)
+        encoded_id = encode_index_value(obj_id)
+        index_prefix = self.get_prefix_by_obj(obj)
+        index_key = index_prefix + ":" + encoded_value + ":" + encoded_id
+        return index_key, encoded_value
+    
+    def get_index_value(self, obj) -> str:
+        if len(self.index_info.columns) > 1:
+            result = []
+            for colname in self.index_info.columns:
+                value = obj.get(colname)
+                result.append(encode_index_value(value))
+            return ",".join(result)
+        else:
+            index_attr = self.index_info.columns[0]
+            value = obj.get(index_attr)
+            return encode_index_value(value)
+
+    def update_index(self, old_obj, new_obj: dict, batch: BatchInterface, force_update=False):
+        index_name = self.index_name
+        assert isinstance(new_obj, dict), "new_obj must be dict"
+
+        # 插入的时候old_obj为空
+        obj_id = self._get_id_from_obj(new_obj)
+        obj_key = self._get_key_from_obj(new_obj)
+        validate_str(obj_id, "invalid obj_id")
+
+        old_index_key = ""
+        new_index_key, new_index_value = self.get_index_key(new_obj)
+
+        if old_obj != None and isinstance(old_obj, dict):
+            # 旧的数据必须为dict类型
+            old_index_key, _ = self.get_index_key(old_obj)
+
+        # 索引值是否变化
+        index_changed = (new_index_key != old_index_key)
+        need_update = self.index_type == "copy" or index_changed
+
+        if not need_update:
+            if self.debug:
+                logging.debug("index value unchanged, index_name:(%s), value:(%s)",
+                            index_name, old_index_key)
+            if not force_update:
+                return
+
+        assert isinstance(new_index_key, str)
+
+        # 只要有旧的记录，就要清空旧索引值
+        if old_index_key != "" and index_changed:
+            batch.check_and_delete(old_index_key)
+
+        if self.index_info.ignore_none_value and new_index_value == chr(0):
+            # None值不处理
+            return
+
+        # 新的索引值始终更新
+        if self.index_type == "copy":
+            clean_obj = dict(**new_obj)
+            clean_value_before_update(clean_obj)
+            index_value = dict(key = obj_key, value = clean_obj)
+            batch.check_and_put(new_index_key, index_value)
+        else:
+            # ref
+            batch.check_and_put(new_index_key, obj_key)
+
+    def delete_index(self, old_obj, batch):
+        assert old_obj != None
+        assert batch != None, "batch can not be None"
+        if isinstance(old_obj, dict):
+            index_key, _ = self.get_index_key(old_obj)
+            batch.delete(index_key)
+    
+    def drop(self):
+        for key, value in prefix_iter(self.prefix, limit=-1, include_key=True):
+            db_delete(key)
+
+
+class ErrorLog(Storage):
+
+    def __init__(self, **kw):
+        super().__init__(**kw)
+        self.key = ""
+        self.value = ""
+        self.ctime = "1970-01-01 00:00:00"
+        self.type = "exception"
+        self.err_msg = "error"
+
+class TableIndexRepair:
+    """表索引修复工具，不是标准功能，所以抽象到一个新的类里面"""
+
+    def __init__(self, db, error_db):
+        self.db = db
+        self.repair_error_db = error_db
+        self.table_name = ""
+        self.debug = False
+    
+    def current_time(self):
+        return time.strftime('%Y-%m-%d %H:%M:%S')
+
+    def repair_index(self):
+        try:
+            self.do_repair_index()
+        except:
+            err_msg = xutils.print_exc()
+            error_log = ErrorLog()
+            error_log.ctime = self.current_time()
+            error_log.err_msg = err_msg
+            self.repair_error_db.insert(error_log)
+
+    def do_repair_index(self):
+        db = self.db
+
+        if len(db.index_names) == 0:
+            return
+
+        # 先删除无效的索引，这样速度更快
+        for name in db.index_names:
+            prefix1 = "_index$%s$%s" % (db.table_name, name)      # v1版本的索引前缀
+            prefix2 = IndexInfo.build_prefix(db.table_name, name) # v2版本的索引前缀
+            self.delete_invalid_index(name, prefix1)
+            self.delete_invalid_index(name, prefix2)
+
+        for value in db.iter(limit=-1):
+            if db._need_check_user:
+                key = value._key
+                assert xutils.is_str(key)
+                try:
+                    parts = key.split(":")
+                    if len(parts) != 3:
+                        logging.error("invalid key: %s", key)
+                        error_log = ErrorLog()
+                        error_log.key = key
+                        error_log.value = value
+                        error_log.type = "record"
+                        error_log.ctime = self.current_time()
+                        self.repair_error_db.insert(error_log)
+                        db_delete(key)
+                        continue
+                    table_name, user_name, id = key.split(":")
+                    user_name = decode_str(user_name)
+                except ValueError:
+                    xutils.print_exc()
+                    logging.error("invalid record key: %s", key)
+                    continue
+                db.rebuild_single_index(value, user_name=user_name)
+            else:
+                db.rebuild_single_index(value)
+        
+        # 清理count缓存
+        for name in db.index_names:
+            delete_index_count_cache(db.table_name, name)
+
+    def do_delete(self, key):
+        if self.debug:
+            logging.info("Delete {%s}", key)
+
+        if not self.is_index_key(key):
+            logging.warning("Invalid index key:(%s)", key)
+            return
+        db_delete(key)
+    
+    def is_index_key(self, key):
+        return key.startswith("_index$") or key.startswith(self.table_name + "$")
+
+    def get_record_attr(self, record, key):
+        # TODO 要改成按照 columns 去组装索引的值
+        if isinstance(record, dict):
+            return record.get(key)
+        if hasattr(record, key):
+            return getattr(record, key)
+        return None
+
+    def delete_invalid_index(self, index_name, index_prefix):
+        db = self.db
+        index_info = dbutil_base.IndexInfo.get_table_index_info(self.table_name, index_name)
+        assert isinstance(index_info, IndexInfo)
+        index = TableIndex(index_info)
+
+        for old_key, index_object in prefix_iter(index_prefix, include_key=True):
+            if isinstance(index_object, dict):
+                # copy
+                record = index_object.get("value")
+                record_key = index_object.get("key")
+            else:
+                # ref
+                record_key = index_object
+                record = db_get(record_key)
+            
+            # record_key是主数据的key
+                
+            if record is None:
+                logging.debug("empty record, key:(%s), record_id:(%s)",
+                              old_key, record_key)
+                self.do_delete(old_key)
+                continue
+
+            if not isinstance(record_key, str):
+                logging.debug("invalid record key, key:(%s), record_id:(%s)",
+                              old_key, record_key)
+                self.do_delete(old_key)
+                continue
+
+            user_name = None
+            encoded_index_value = index.get_index_value(record)
+            record_id = db._get_id_from_key(record_key)
+
+            if db._need_check_user:
+                try:
+                    parser = KeyParser(record_key)
+                    table_name = parser.pop_left()
+                    user_name = parser.pop_left()
+                    user_name = decode_str(user_name)
+                except:
+                    logging.error("invalid key: (%s)", record_key)
+                    error_log = ErrorLog()
+                    error_log.key = old_key
+                    error_log.value = str(record_key)
+                    error_log.type = "index"
+                    error_log.ctime = self.current_time()
+                    self.repair_error_db.insert(error_log)
+                    self.do_delete(old_key)
+                    continue
+
+            prefix = db._get_index_prefix(index_name, user_name)
+            new_key = db._build_key_no_prefix(
+                prefix, encoded_index_value, record_id)
+
+            if new_key != old_key:
+                logging.debug("index dismatch, key:(%s), record_id:(%s), correct_key:(%s)",
+                              old_key, record_key, new_key)
+                self.do_delete(old_key)
+
```

### Comparing `xnote-web-0.1.0/xutils/db/dbutil_table_v2.py` & `xnote-web-0.1.1/xutils/db/dbutil_table_v2.py`

 * *Ordering differences only*

 * *Files 27% similar despite different names*

```diff
@@ -1,393 +1,393 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-10-28 09:54:54
-@LastEditors  : xupingmao
-@LastEditTime : 2024-03-10 00:42:58
-@FilePath     : /xnote/xutils/db/dbutil_table_v2.py
-@Description  : 数据库表-API
-"""
-
-from xutils import Storage
-from xutils.db.dbutil_base import *
-from xutils.db.encode import (
-    decode_str,
-    encode_str,
-    clean_value_before_update
-)
-from xutils.db.binlog import BinLog
-
-class KvTableV2:
-    """基于SQL+KV的表
-    - 索引使用SQL维护
-    - 数据使用KV维护
-    """
-
-    def __init__(self, table_name):
-        # 参数检查
-        table_info = get_table_info(table_name)
-        assert table_info != None
-        assert table_info.index_db != None
-
-        self.table_name = table_name
-        self.key_name = "_key"
-        self.id_name = "_id"
-        self.prefix = table_name + ":"
-        self.table_info = table_info
-        self.binlog = BinLog.get_instance()
-        self.binlog_enabled = True
-        self.index_column_names = table_info.index_db.get_column_names()
-        self.index_db = table_info.index_db
-
-    def set_binlog_enabled(self, enabled=True):
-        self.binlog_enabled = enabled
-
-    def _build_key(self, id):
-        return self.prefix + str(id)
-
-    def _get_key_from_obj(self, obj):
-        validate_dict(obj, "obj is not dict")
-        return obj.get(self.key_name)
-
-    def _get_id_from_obj(self, obj):
-        key = self._get_key_from_obj(obj)
-        return key.rsplit(":", 1)[-1]
-    
-    def _get_int_id_from_obj(self, obj):
-        id = self._get_id_from_obj(obj)
-        return int(id)
-
-    def _get_id_from_key(self, key):
-        return decode_str(key.rsplit(":", 1)[-1])
-
-    def _get_int_id_from_key(self, key):
-        id_str = self._get_id_from_key(key)
-        return int(id_str)
-
-    def _format_value(self, key, value):
-        if not isinstance(value, dict):
-            value = Storage(_raw=value)
-
-        value[self.key_name] = key
-        value[self.id_name] = self._get_id_from_key(key)
-        return value
-
-    def _convert_to_db_row(self, obj):
-        obj_copy = dict(**obj)
-        clean_value_before_update(obj_copy)
-        return obj_copy
-
-    def _check_before_delete(self, key):
-        if not key.startswith(self.prefix):
-            raise Exception("invalid key:%s" % key)
-
-    def _check_value(self, obj, key=""):
-        if not isinstance(obj, dict):
-            raise Exception("key:%r, invalid obj:%r, expected dict" % (key, obj))
-
-    def _check_key(self, key):
-        if not key.startswith(self.prefix):
-            raise Exception("invalid key:(%s), prefix:(%s)" %
-                            (key, self.prefix))
-
-    def _put_obj(self, key, obj, sync=False, fix_index=False):
-        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
-        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
-        # 使用leveldb的批量操作可以确保不会读到未提交的数据
-        batch = create_write_batch()
-        old_obj = db_get(key)
-        self._format_value(key, old_obj)
-        batch.put(key, self._convert_to_db_row(obj))
-        if self.binlog_enabled:
-            self.binlog.add_log(
-                "put", key, obj, batch=batch, old_value=old_obj)
-        # 更新批量操作
-        batch.commit(sync)
-        
-        if fix_index:
-            self.rebuild_record_index(key, obj)
-        else:
-            self.update_index(obj)
-
-    def is_valid_key(self, key=None):
-        assert isinstance(key, str)
-        return key.startswith(self.prefix)
-
-    def get_by_id(self, row_id, default_value=None):
-        """通过ID查询记录
-        :param row_id: 记录ID
-        :param default_value: 默认值
-        """
-        row_id = str(row_id)
-        key = self._build_key(row_id)
-        result = self.get_by_key(key, default_value)
-        if result == None:
-            index_result = self.index_db.select_first(where=dict(id=row_id))
-            if index_result != None:
-                return self._format_value(key, index_result)
-        return result
-
-    def batch_get_by_id(self, row_id_list, default_value=None):
-        key_list = []
-        key_id_dict = {}
-        for row_id in row_id_list:
-            q_row_id = str(row_id)
-            key = self._build_key(q_row_id)
-            key_list.append(key)
-            key_id_dict[key] = row_id
-
-        result = dict()
-        key_result = self.batch_get_by_key(
-            key_list, default_value=default_value)
-        for key in key_result:
-            object = key_result.get(key)
-            id = key_id_dict.get(key)
-            result[id] = object
-        return result
-    
-    def batch_get_by_index_list(self, row_list, default_value=None):
-        key_list = []
-        dict_result = {}
-
-        for row in row_list:
-            q_row_id = str(row.id)
-            key = self._build_key(q_row_id)
-            key_list.append(key)
-            dict_result[key] = self._format_value(key, row)
-
-        kv_dict_result = self.batch_get_by_key(
-            key_list, default_value=default_value)
-        dict_result.update(kv_dict_result)
-        
-        result = []
-        for key in key_list:
-            object = dict_result.get(key)
-            if object != None:
-                result.append(object)
-        return result
-
-    def get_by_key(self, key, default_value=None):
-        """通过key查询记录
-        :param key: kv数据库的key
-        :param default_value: 默认值
-        """
-        if key == "":
-            return None
-        self._check_key(key)
-        value = db_get(key, default_value)
-        if value is None:
-            return None
-
-        return self._format_value(key, value)
-
-    def batch_get_by_key(self, key_list, default_value=None):
-        for key in key_list:
-            self._check_key(key)
-
-        batch_result = db_batch_get(key_list, default_value)
-        for key in batch_result:
-            value = batch_result.get(key)
-            if value is None:
-                batch_result[key] = None
-                continue
-            batch_result[key] = self._format_value(key, value)
-
-        return batch_result
-    
-    def build_sql_record(self, obj):
-        result = {}
-        for attr in self.index_column_names:
-            result[attr] = obj.get(attr) # None值也需要写入
-        return result
-
-    def insert(self, obj):
-        """插入新数据
-        @param {object} obj 插入的对象
-        @param {string} id_type id类型
-        """
-        self._check_value(obj)
-        sql_record = self.build_sql_record(obj)
-        # 必须先插入索引，有两个目的:
-        # 1. 获取主键ID
-        # 2. 如果插入索引成功，插入主数据失败，可以在列表上做删除操作
-        new_id = self.index_db.insert(**sql_record)
-        new_id_str = str(new_id)
-        key = self._build_key(new_id_str)
-        obj[self.key_name] = key
-        obj[self.id_name] = new_id_str
-
-        self._put_obj(key, obj)
-        return new_id
-
-    def put(self, obj, fix_index=False):
-        """从`obj`中获取主键`key`进行更新"""
-        self._check_value(obj)
-
-        obj_key = self._get_key_from_obj(obj)
-        assert isinstance(obj_key, str), "obj_key must be str"
-        
-        self._check_key(obj_key)
-        self._put_obj(obj_key, obj, fix_index=fix_index)
-
-    update = put
-
-    def put_by_id(self, id, obj, encode_key=True):
-        """通过ID进行更新，如果key包含用户，必须有user_name(初始化定义或者传入参数)
-        :param {str} id: 指定ID
-        :param {dict} obj: 写入的对象
-        :param encode_key=True: 是否对key进行编码,用于处理特殊字符
-        """
-        id = str(id)
-        if encode_key:
-            id = encode_str(id)
-
-        key = self._build_key(id)
-        self.put_by_key(key, obj)
-
-    def put_by_key(self, key, obj, fix_index=False):
-        """直接通过`key`进行更新"""
-        self._check_key(key)
-        self._check_value(obj, key=key)
-
-        obj[self.key_name] = key
-        obj[self.id_name] = self._get_id_from_key(key)
-        
-        update_obj = obj
-        self._put_obj(key, update_obj, fix_index=fix_index)
-
-    def delete(self, obj):
-        obj_key = self._get_key_from_obj(obj)
-        self.delete_by_key(obj_key)
-
-    def batch_delete(self, obj_list=[]):
-        if len(obj_list) == 0:
-            return
-        keys = []
-        ids = []
-        for obj in obj_list:
-            key = self._get_key_from_obj(obj)
-            id = self._get_int_id_from_obj(obj)
-            keys.append(key)
-            ids.append(id)
-        db_batch_delete(keys)
-        self.index_db.delete(where="id in $ids", vars=dict(ids=ids))
-
-    def delete_by_id(self, id):
-        id = str(id)
-        key = self._build_key(id)
-        self.delete_by_key(key)
-
-    def delete_by_key(self, key):
-        """通过key删除记录: 这里先删除记录，然后删除索引，如果删除记录成功，删除索引失败，还可以在列表发起重试"""
-        validate_str(key, "delete_by_key: invalid key")
-        self._check_before_delete(key)
-
-        old_obj = self.get_by_key(key)
-        if old_obj is None:
-            self.delete_index_by_key(key)
-            return
-
-        id = self._get_int_id_from_obj(old_obj)
-        self._format_value(key, old_obj)
-        batch = create_write_batch()
-        # 更新批量操作
-        batch.delete(key)
-        if self.binlog_enabled:
-            self.binlog.add_log("delete", key, old_obj,
-                                batch=batch, old_value=old_obj)
-        batch.commit()
-        self.index_db.delete(where=dict(id=id))
-
-    def delete_index_by_key(self, key):
-        id = self._get_int_id_from_key(key)
-        self.index_db.delete(where=dict(id=id))
-
-    def update_index(self, record):
-        sql_record = self.build_sql_record(record)
-        id = self._get_int_id_from_obj(record)
-        self.index_db.update(where=dict(id=id), **sql_record)
-
-    def select(self, where=None, vars=None, offset=0, limit=10, order=None):
-        rows = self.index_db.select(where=where, vars=vars, order=order, offset=offset, limit=limit)
-        return self.batch_get_by_index_list(rows)
-
-    def select_first(self, where=None, vars=None, order="id"):
-        index_record = self.index_db.select_first(where=where, vars=vars, order=order, offset=0, limit=1)
-        if index_record == None:
-            return None
-        kv_record = self.get_by_id(index_record.id)
-        if kv_record == None:
-            key = self._build_key(index_record.id)
-            return self._format_value(key, index_record)
-        return kv_record
-
-    def iter_by_index(self, where="", vars=None, batch_size=20):
-        """内部接口"""
-        assert isinstance(where, str)
-        last_id = 0
-        while True:
-            this_vars = dict(last_id = last_id)
-            if vars != None:
-                this_vars.update(vars)
-            index_records = self.index_db.select(where = "id > $last_id " + where, vars = this_vars, limit = batch_size, order="id")
-            if len(index_records) == 0:
-                break
-            result_list = self.batch_get_by_index_list(index_records)
-            for item in result_list:
-                yield item
-            last_id = result_list[-1].id
-    
-    def iter_by_kv(self, limit=-1):
-        """内部接口"""
-        for key, item in prefix_iter(self.prefix, include_key=True, limit=limit):
-            yield self._format_value(key, item)
-
-    def rebuild_index(self, version="v1", **kw):
-        """重建索引
-        :param version="v1": 版本
-        :param ignore_error=False: 忽略错误
-        :param ignore_invalid_id=False: 忽略无效的ID
-        """
-        idx_version_key = "_idx_version:%s" % self.table_name
-        current_version = db_get(idx_version_key)
-        if current_version == version:
-            logging.info("当前索引已经是最新版本, table=%s, version=%s" %
-                            (self.table_name, version))
-            return
-        self.rebuild_index_no_check(**kw)
-        db_put(idx_version_key, version)
-        logging.info("索引重建完成, table=%s", self.table_name)
-
-    def rebuild_index_no_check(self, **kw):
-        # TODO 可以通过复制表的方式重建索引,减少数据库的锁时间
-        for key, item in prefix_iter(self.prefix, include_key=True):
-            self.rebuild_record_index(key, item, **kw)
-
-    def rebuild_record_index(self, key, item, **kw):
-        ignore_invalid_id = kw.get("ignore_invalid_id", False)
-        ignore_error = kw.get("ignore_error", False)
-        
-        """重建单条记录的索引"""
-        sql_record = self.build_sql_record(item)
-        try:
-            id = self._get_int_id_from_key(key)
-        except ValueError as e:
-            if ignore_invalid_id or ignore_error:
-                logging.warning("invalid key=%s", key)
-                return
-            else:
-                raise e
-        old_index = self.index_db.select_first(where=dict(id=id))
-        try:
-            if old_index == None:
-                sql_record["id"] = id
-                self.index_db.insert(**sql_record)
-            else:
-                self.index_db.update(where=dict(id=id), **sql_record)
-        except Exception as e:
-            if ignore_error:
-                logging.warning("err=%s",e)
-                return
-            else:
-                raise e
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-10-28 09:54:54
+@LastEditors  : xupingmao
+@LastEditTime : 2024-03-10 00:42:58
+@FilePath     : /xnote/xutils/db/dbutil_table_v2.py
+@Description  : 数据库表-API
+"""
+
+from xutils import Storage
+from xutils.db.dbutil_base import *
+from xutils.db.encode import (
+    decode_str,
+    encode_str,
+    clean_value_before_update
+)
+from xutils.db.binlog import BinLog
+
+class KvTableV2:
+    """基于SQL+KV的表
+    - 索引使用SQL维护
+    - 数据使用KV维护
+    """
+
+    def __init__(self, table_name):
+        # 参数检查
+        table_info = get_table_info(table_name)
+        assert table_info != None
+        assert table_info.index_db != None
+
+        self.table_name = table_name
+        self.key_name = "_key"
+        self.id_name = "_id"
+        self.prefix = table_name + ":"
+        self.table_info = table_info
+        self.binlog = BinLog.get_instance()
+        self.binlog_enabled = True
+        self.index_column_names = table_info.index_db.get_column_names()
+        self.index_db = table_info.index_db
+
+    def set_binlog_enabled(self, enabled=True):
+        self.binlog_enabled = enabled
+
+    def _build_key(self, id):
+        return self.prefix + str(id)
+
+    def _get_key_from_obj(self, obj):
+        validate_dict(obj, "obj is not dict")
+        return obj.get(self.key_name)
+
+    def _get_id_from_obj(self, obj):
+        key = self._get_key_from_obj(obj)
+        return key.rsplit(":", 1)[-1]
+    
+    def _get_int_id_from_obj(self, obj):
+        id = self._get_id_from_obj(obj)
+        return int(id)
+
+    def _get_id_from_key(self, key):
+        return decode_str(key.rsplit(":", 1)[-1])
+
+    def _get_int_id_from_key(self, key):
+        id_str = self._get_id_from_key(key)
+        return int(id_str)
+
+    def _format_value(self, key, value):
+        if not isinstance(value, dict):
+            value = Storage(_raw=value)
+
+        value[self.key_name] = key
+        value[self.id_name] = self._get_id_from_key(key)
+        return value
+
+    def _convert_to_db_row(self, obj):
+        obj_copy = dict(**obj)
+        clean_value_before_update(obj_copy)
+        return obj_copy
+
+    def _check_before_delete(self, key):
+        if not key.startswith(self.prefix):
+            raise Exception("invalid key:%s" % key)
+
+    def _check_value(self, obj, key=""):
+        if not isinstance(obj, dict):
+            raise Exception("key:%r, invalid obj:%r, expected dict" % (key, obj))
+
+    def _check_key(self, key):
+        if not key.startswith(self.prefix):
+            raise Exception("invalid key:(%s), prefix:(%s)" %
+                            (key, self.prefix))
+
+    def _put_obj(self, key, obj, sync=False, fix_index=False):
+        # ~~写redo-log，启动的时候要先锁定检查redo-log，恢复异常关闭的数据~~
+        # 不需要重新实现redo-log，直接用leveldb的批量处理功能即可
+        # 使用leveldb的批量操作可以确保不会读到未提交的数据
+        batch = create_write_batch()
+        old_obj = db_get(key)
+        self._format_value(key, old_obj)
+        batch.put(key, self._convert_to_db_row(obj))
+        if self.binlog_enabled:
+            self.binlog.add_log(
+                "put", key, obj, batch=batch, old_value=old_obj)
+        # 更新批量操作
+        batch.commit(sync)
+        
+        if fix_index:
+            self.rebuild_record_index(key, obj)
+        else:
+            self.update_index(obj)
+
+    def is_valid_key(self, key=None):
+        assert isinstance(key, str)
+        return key.startswith(self.prefix)
+
+    def get_by_id(self, row_id, default_value=None):
+        """通过ID查询记录
+        :param row_id: 记录ID
+        :param default_value: 默认值
+        """
+        row_id = str(row_id)
+        key = self._build_key(row_id)
+        result = self.get_by_key(key, default_value)
+        if result == None:
+            index_result = self.index_db.select_first(where=dict(id=row_id))
+            if index_result != None:
+                return self._format_value(key, index_result)
+        return result
+
+    def batch_get_by_id(self, row_id_list, default_value=None):
+        key_list = []
+        key_id_dict = {}
+        for row_id in row_id_list:
+            q_row_id = str(row_id)
+            key = self._build_key(q_row_id)
+            key_list.append(key)
+            key_id_dict[key] = row_id
+
+        result = dict()
+        key_result = self.batch_get_by_key(
+            key_list, default_value=default_value)
+        for key in key_result:
+            object = key_result.get(key)
+            id = key_id_dict.get(key)
+            result[id] = object
+        return result
+    
+    def batch_get_by_index_list(self, row_list, default_value=None):
+        key_list = []
+        dict_result = {}
+
+        for row in row_list:
+            q_row_id = str(row.id)
+            key = self._build_key(q_row_id)
+            key_list.append(key)
+            dict_result[key] = self._format_value(key, row)
+
+        kv_dict_result = self.batch_get_by_key(
+            key_list, default_value=default_value)
+        dict_result.update(kv_dict_result)
+        
+        result = []
+        for key in key_list:
+            object = dict_result.get(key)
+            if object != None:
+                result.append(object)
+        return result
+
+    def get_by_key(self, key, default_value=None):
+        """通过key查询记录
+        :param key: kv数据库的key
+        :param default_value: 默认值
+        """
+        if key == "":
+            return None
+        self._check_key(key)
+        value = db_get(key, default_value)
+        if value is None:
+            return None
+
+        return self._format_value(key, value)
+
+    def batch_get_by_key(self, key_list, default_value=None):
+        for key in key_list:
+            self._check_key(key)
+
+        batch_result = db_batch_get(key_list, default_value)
+        for key in batch_result:
+            value = batch_result.get(key)
+            if value is None:
+                batch_result[key] = None
+                continue
+            batch_result[key] = self._format_value(key, value)
+
+        return batch_result
+    
+    def build_sql_record(self, obj):
+        result = {}
+        for attr in self.index_column_names:
+            result[attr] = obj.get(attr) # None值也需要写入
+        return result
+
+    def insert(self, obj):
+        """插入新数据
+        @param {object} obj 插入的对象
+        @param {string} id_type id类型
+        """
+        self._check_value(obj)
+        sql_record = self.build_sql_record(obj)
+        # 必须先插入索引，有两个目的:
+        # 1. 获取主键ID
+        # 2. 如果插入索引成功，插入主数据失败，可以在列表上做删除操作
+        new_id = self.index_db.insert(**sql_record)
+        new_id_str = str(new_id)
+        key = self._build_key(new_id_str)
+        obj[self.key_name] = key
+        obj[self.id_name] = new_id_str
+
+        self._put_obj(key, obj)
+        return new_id
+
+    def put(self, obj, fix_index=False):
+        """从`obj`中获取主键`key`进行更新"""
+        self._check_value(obj)
+
+        obj_key = self._get_key_from_obj(obj)
+        assert isinstance(obj_key, str), "obj_key must be str"
+        
+        self._check_key(obj_key)
+        self._put_obj(obj_key, obj, fix_index=fix_index)
+
+    update = put
+
+    def put_by_id(self, id, obj, encode_key=True):
+        """通过ID进行更新，如果key包含用户，必须有user_name(初始化定义或者传入参数)
+        :param {str} id: 指定ID
+        :param {dict} obj: 写入的对象
+        :param encode_key=True: 是否对key进行编码,用于处理特殊字符
+        """
+        id = str(id)
+        if encode_key:
+            id = encode_str(id)
+
+        key = self._build_key(id)
+        self.put_by_key(key, obj)
+
+    def put_by_key(self, key, obj, fix_index=False):
+        """直接通过`key`进行更新"""
+        self._check_key(key)
+        self._check_value(obj, key=key)
+
+        obj[self.key_name] = key
+        obj[self.id_name] = self._get_id_from_key(key)
+        
+        update_obj = obj
+        self._put_obj(key, update_obj, fix_index=fix_index)
+
+    def delete(self, obj):
+        obj_key = self._get_key_from_obj(obj)
+        self.delete_by_key(obj_key)
+
+    def batch_delete(self, obj_list=[]):
+        if len(obj_list) == 0:
+            return
+        keys = []
+        ids = []
+        for obj in obj_list:
+            key = self._get_key_from_obj(obj)
+            id = self._get_int_id_from_obj(obj)
+            keys.append(key)
+            ids.append(id)
+        db_batch_delete(keys)
+        self.index_db.delete(where="id in $ids", vars=dict(ids=ids))
+
+    def delete_by_id(self, id):
+        id = str(id)
+        key = self._build_key(id)
+        self.delete_by_key(key)
+
+    def delete_by_key(self, key):
+        """通过key删除记录: 这里先删除记录，然后删除索引，如果删除记录成功，删除索引失败，还可以在列表发起重试"""
+        validate_str(key, "delete_by_key: invalid key")
+        self._check_before_delete(key)
+
+        old_obj = self.get_by_key(key)
+        if old_obj is None:
+            self.delete_index_by_key(key)
+            return
+
+        id = self._get_int_id_from_obj(old_obj)
+        self._format_value(key, old_obj)
+        batch = create_write_batch()
+        # 更新批量操作
+        batch.delete(key)
+        if self.binlog_enabled:
+            self.binlog.add_log("delete", key, old_obj,
+                                batch=batch, old_value=old_obj)
+        batch.commit()
+        self.index_db.delete(where=dict(id=id))
+
+    def delete_index_by_key(self, key):
+        id = self._get_int_id_from_key(key)
+        self.index_db.delete(where=dict(id=id))
+
+    def update_index(self, record):
+        sql_record = self.build_sql_record(record)
+        id = self._get_int_id_from_obj(record)
+        self.index_db.update(where=dict(id=id), **sql_record)
+
+    def select(self, where=None, vars=None, offset=0, limit=10, order=None):
+        rows = self.index_db.select(where=where, vars=vars, order=order, offset=offset, limit=limit)
+        return self.batch_get_by_index_list(rows)
+
+    def select_first(self, where=None, vars=None, order="id"):
+        index_record = self.index_db.select_first(where=where, vars=vars, order=order, offset=0, limit=1)
+        if index_record == None:
+            return None
+        kv_record = self.get_by_id(index_record.id)
+        if kv_record == None:
+            key = self._build_key(index_record.id)
+            return self._format_value(key, index_record)
+        return kv_record
+
+    def iter_by_index(self, where="", vars=None, batch_size=20):
+        """内部接口"""
+        assert isinstance(where, str)
+        last_id = 0
+        while True:
+            this_vars = dict(last_id = last_id)
+            if vars != None:
+                this_vars.update(vars)
+            index_records = self.index_db.select(where = "id > $last_id " + where, vars = this_vars, limit = batch_size, order="id")
+            if len(index_records) == 0:
+                break
+            result_list = self.batch_get_by_index_list(index_records)
+            for item in result_list:
+                yield item
+            last_id = result_list[-1].id
+    
+    def iter_by_kv(self, limit=-1):
+        """内部接口"""
+        for key, item in prefix_iter(self.prefix, include_key=True, limit=limit):
+            yield self._format_value(key, item)
+
+    def rebuild_index(self, version="v1", **kw):
+        """重建索引
+        :param version="v1": 版本
+        :param ignore_error=False: 忽略错误
+        :param ignore_invalid_id=False: 忽略无效的ID
+        """
+        idx_version_key = "_idx_version:%s" % self.table_name
+        current_version = db_get(idx_version_key)
+        if current_version == version:
+            logging.info("当前索引已经是最新版本, table=%s, version=%s" %
+                            (self.table_name, version))
+            return
+        self.rebuild_index_no_check(**kw)
+        db_put(idx_version_key, version)
+        logging.info("索引重建完成, table=%s", self.table_name)
+
+    def rebuild_index_no_check(self, **kw):
+        # TODO 可以通过复制表的方式重建索引,减少数据库的锁时间
+        for key, item in prefix_iter(self.prefix, include_key=True):
+            self.rebuild_record_index(key, item, **kw)
+
+    def rebuild_record_index(self, key, item, **kw):
+        ignore_invalid_id = kw.get("ignore_invalid_id", False)
+        ignore_error = kw.get("ignore_error", False)
+        
+        """重建单条记录的索引"""
+        sql_record = self.build_sql_record(item)
+        try:
+            id = self._get_int_id_from_key(key)
+        except ValueError as e:
+            if ignore_invalid_id or ignore_error:
+                logging.warning("invalid key=%s", key)
+                return
+            else:
+                raise e
+        old_index = self.index_db.select_first(where=dict(id=id))
+        try:
+            if old_index == None:
+                sql_record["id"] = id
+                self.index_db.insert(**sql_record)
+            else:
+                self.index_db.update(where=dict(id=id), **sql_record)
+        except Exception as e:
+            if ignore_error:
+                logging.warning("err=%s",e)
+                return
+            else:
+                raise e
```

### Comparing `xnote-web-0.1.0/xutils/db/driver_leveldb.py` & `xnote-web-0.1.1/xutils/db/driver_leveldb.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/driver_leveldbpy.py` & `xnote-web-0.1.1/xutils/db/driver_leveldbpy.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/driver_lmdb.py` & `xnote-web-0.1.1/xutils/db/driver_lmdb.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/driver_mysql.py` & `xnote-web-0.1.1/xutils/db/driver_mysql.py`

 * *Ordering differences only*

 * *Files 24% similar despite different names*

```diff
@@ -1,450 +1,450 @@
-# -*- coding:utf-8 -*-
-"""
-MySQL驱动
-
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-05-28 12:29:19
-@LastEditors  : xupingmao
-@LastEditTime : 2023-12-24 21:51:21
-@FilePath     : /xnote/xutils/db/driver_mysql.py
-@Description  : mysql驱动
-"""
-
-import logging
-import threading
-import time
-from collections import deque
-from xutils import interfaces
-from xutils.interfaces import SqlLoggerInterface
-import web.db
-
-class Holder(threading.local):
-    db = None
-
-    def __del__(self):
-        if self.db != None:
-            self.db.close()
-
-class MySQLKV(interfaces.DBInterface):
-
-    holder = Holder()
-    lock = threading.RLock()
-    max_value_length = 1024 * 1024 * 5 # 5MB
-    long_value_length = 1024 * 10 # 10K
-
-    def __init__(self, *, host=None, port=3306, user=None,
-                 password=None, database=None, pool_size=5, 
-                 db_instance=None, sql_logger=SqlLoggerInterface()):
-        assert isinstance(db_instance, web.db.MySQLDB)
-        self.db = db_instance
-        
-        self.debug = True
-        self.log_get_profile = True
-        self.log_put_profile = True
-        self.sql_logger = sql_logger  # type: SqlLoggerInterface
-        self.scan_limit = 200  # 扫描的分页大小
-        self.pool = deque()
-        self.pool_size = 0
-        self.debug_pool = False
-        self.driver = ""
-        self.driver_type = "mysql"
-
-        try:
-            self.init()
-        except Exception as e:
-            logging.error("mysql driver init failed, host=%s, port=%s, database=%s", host, port, database)
-            raise e
-
-    def close_cursor(self, cursor):
-        cursor.close()
-
-    def mysql_to_py(self, obj):
-        if isinstance(obj, bytearray):
-            return bytes(obj)
-        return obj
-
-    def init(self):
-        # tinyblob 最大长度 255
-        # KEY索引长度并不对key的长度做限制，只是索引最多使用200字节
-        # 但是如果索引前缀是相同的，会报主键冲突的错误
-        # 比如索引长度为5, 存在12345A，插入12345B会报错，插入12346A可以成功
-        # 一个CHAR占用3个字节，索引最多用1000个字节
-        
-        self.db.query("""CREATE TABLE IF NOT EXISTS `kv_store` (
-            `key` blob not null comment '键值对key', 
-            value longblob comment '键值对value',
-            version int not null default 0 comment '版本',
-            PRIMARY KEY (`key`(200))
-        ) COMMENT '键值对存储';
-        """)
-
-    def get_with_version(self, key):
-        # type: (bytes) -> tuple[bytes|None, int]
-        """通过key读取Value
-        @param {bytes} key
-        @return {bytes|None} value
-        """
-
-        assert isinstance(key, bytes)
-        
-        start_time = time.time()
-        sql = "SELECT value, version FROM kv_store WHERE `key`=$key"
-        vars = dict(key=key)
-        
-        try:
-            result_iter = self.db.query(sql, vars=vars)
-            for item in result_iter:
-                return self.mysql_to_py(item.value), item.version
-            return None, 0
-        except Exception as e:
-            del self.db.ctx.db # 尝试重新连接
-            real_sql = self.db.query(sql, vars=vars, _test=True)
-            logging.error("SQL:%s", real_sql)
-            raise e
-        finally:
-            cost_time = time.time() - start_time
-            
-            if self.log_get_profile:
-                logging.debug("GET (%s) cost %.2fms", key, cost_time*1000)
-
-            if self.sql_logger != None:
-                sql_query = self.db.query(sql, vars=vars, _test=True)
-                sql_info = str(sql_query)
-                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-                self.sql_logger.append(log_info)
-
-    def doGet(self, key, cursor=None):
-        value, version = self.get_with_version(key)
-        return value
-    
-    def Get(self, key=b''):
-        value, version = self.get_with_version(key)
-        return value
-
-    def BatchGet(self, key_list):
-        # type: (list[bytes]) -> dict[bytes, bytes]
-        if len(key_list) == 0:
-            return {}
-
-        start_time = time.time()
-
-        sql = ""
-        vars = dict(key_list=key_list)
-        try:
-            result = dict()
-            sql = "SELECT `key`, value FROM kv_store WHERE `key` IN $key_list"
-            # mysql.connector不支持传入列表,需要自己处理下
-            # sql_args = ["%s" for i in key_list]
-            # sql = sql % ",".join(sql_args)
-            result_iter = self.db.query(sql, vars=vars)
-            for item in result_iter:
-                key = self.mysql_to_py(item.key)
-                value = self.mysql_to_py(item.value)
-                result[key] = value
-            return result
-        finally:
-            cost_time = time.time() - start_time
-            if self.log_get_profile:
-                logging.debug("BatchGet (%s) cost %.2fms",
-                                key_list, cost_time*1000)
-
-            if self.sql_logger != None:
-                sql_query = self.db.query(sql, vars=vars, _test=True)
-                sql_info = str(sql_query)
-                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-                self.sql_logger.append(log_info)
-    
-    def log_sql(self, sql, vars, start_time=0.0, key=None):
-        if self.debug:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            logging.debug("SQL:%s", sql_query)
-
-        if self.sql_logger:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            cost_time = time.time() - start_time
-            log_info = str(sql_query) + " [%.2fms]" % (cost_time*1000)
-            self.sql_logger.append(log_info)
-
-    def put_long_value(self, key, value, sync=False, cursor=None):
-        vars = dict(key=key, value=value)
-        update_sql = "UPDATE kv_store SET value = $value, version=version+1 WHERE `key` = $key;"
-        rows = self.db.query(update_sql, vars=vars)
-        self.log_sql(update_sql, vars=vars, key="[Put:Update]")
-        assert isinstance(rows, int)
-        if rows == 0:
-            insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key,$value,1);"
-            self.db.query(insert_sql, vars=vars)
-            self.log_sql(insert_sql, vars=vars, key="[Put:Insert]")
-            
-    def doPut(self, key, value):
-        # type: (bytes,bytes) -> None
-        if len(value) > self.max_value_length:
-            raise interfaces.DatabaseException(code=400, message="value too long")
-        
-        if len(value) > self.long_value_length:
-            return self.put_long_value(key, value)
-
-        start_time = time.time()
-        upsert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1) ON DUPLICATE KEY UPDATE value=$value, version=version+1";
-        # update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key"
-        vars = dict(key=key,value=value)
-
-        rowcount = self.db.query(upsert_sql, vars=vars)
-        assert isinstance(rowcount, int)
-        self.log_sql(upsert_sql, vars, start_time=start_time, key=key)
-        assert rowcount > 0
-
-    def Put(self, key, value, sync=False, cursor=None):
-        # type: (bytes,bytes,bool,object) -> None
-        """写入Key-Value键值对
-        @param {bytes} key
-        @param {bytes} value
-        """
-
-        start_time = time.time()
-
-        try:
-            self.doPut(key, value)
-        finally:
-            cost_time = time.time() - start_time
-            if self.log_put_profile:
-                logging.debug("Put (%s) cost %.2fms", key, cost_time*1000)
-    
-    def put_with_version(self, key=b'', value=b'', version=0):
-        # type: (bytes,bytes,int) -> int
-        start_time = time.time()
-        if len(value) > self.max_value_length:
-            raise interfaces.DatabaseException(code=400, message="value too long")
-        update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key AND version=$version"
-        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1)"
-        vars = dict(key=key,value=value,version=version)
-        rowcount = self.db.query(update_sql, vars=vars)
-        assert isinstance(rowcount, int), "expect int rowcount"
-        if rowcount == 0:
-            # 数据不存在,执行插入动作
-            # 如果这里冲突了，按照默认规则抛出异常
-            if version != 0:
-                return 0
-            # 只有version=0的情况下才能插入
-            self.db.query(insert_sql, vars=vars)
-            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
-            return 1
-        else:
-            self.log_sql(update_sql, vars, start_time=start_time, key=key)
-        return rowcount
-    
-    def compare_and_put(self, key=b'', value=b'', old_value=None):
-        """比较之后再更新,如果old_value=None,则执行insert"""
-        # type: (bytes,bytes,bytes|None) -> int
-        start_time = time.time()
-        if len(value) > self.max_value_length:
-            raise interfaces.DatabaseException(code=400, message="value too long")
-        update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key AND value=$old_value"
-        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1)"
-        vars = dict(key=key,value=value,old_value=old_value)
-        
-        if old_value == None:
-            self.db.query(insert_sql, vars=vars)
-            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
-            return 1
-        
-        rowcount = self.db.query(update_sql, vars=vars)
-        assert isinstance(rowcount, int), "expect int rowcount"
-        self.log_sql(update_sql, vars, start_time=start_time, key=key)
-        return rowcount
-    
-    def Insert(self, key=b'', value=b'', version=0):
-        start_time = time.time()
-        if len(value) > self.max_value_length:
-            raise interfaces.DatabaseException(code=400, message="value too long")
-        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 0)"
-        vars = dict(key=key,value=value,version=version)
-        try:
-            self.db.query(insert_sql, vars=vars)
-        finally:
-            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
-
-    def doDeleteRaw(self, key=b'', sync=False, cursor=None):
-        # type: (bytes, bool, object) -> None
-        """删除Key-Value键值对
-        @param {bytes} key
-        """
-        start_time = time.time()
-        sql = "DELETE FROM kv_store WHERE `key` = $key;"
-        vars = dict(key=key)
-
-        if self.debug:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            logging.debug("SQL:%s", sql_query)
-
-        self.db.query(sql, vars=vars)
-
-        if self.sql_logger:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            sql_info = str(sql_query)
-            cost_time = time.time() - start_time
-            log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-            self.sql_logger.append(log_info)
-
-    def doDelete(self, key, sync=False, cursor=None):
-        return self.doDeleteRaw(key, sync, cursor)
-
-    def Delete(self, key=b'', sync=False):
-        self.doDeleteRaw(key)
-
-    def BatchDelete(self, keys=[]):
-        """批量删除键值对
-        :param {list} keys: 键集合
-        """
-        start_time = time.time()
-        sql = "DELETE FROM kv_store WHERE `key` in $keys;"
-        vars = dict(keys=keys)
-
-        if self.debug:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            logging.debug("SQL:%s", sql_query)
-
-        self.db.query(sql, vars=vars)
-
-        if self.sql_logger:
-            sql_query = self.db.query(sql, vars=vars, _test=True)
-            sql_info = str(sql_query)
-            cost_time = time.time() - start_time
-            log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-            self.sql_logger.append(log_info)
-
-    def RangeIterRaw(self,
-                     key_from=None,
-                     key_to=None,
-                     *,
-                     reverse=False,
-                     include_value=True,
-                     fill_cache=False):
-        """返回区间迭代器
-        @param {bytes}  key_from       开始的key（包含）FirstKey
-        @param {bytes}  key_to         结束的key（包含）LastKey
-        @param {bool}   reverse        是否反向查询
-        @param {bool}   include_value  是否包含值
-        @param {bool}   fill_cache     是否填充缓存
-        """
-
-        # 优化成轮询的短查询
-        limit = self.scan_limit
-
-        sql_builder = []
-
-        if include_value:
-            sql_builder.append("SELECT `key`, value FROM kv_store")
-        else:
-            # 只包含key
-            sql_builder.append("SELECT `key` FROM kv_store")
-
-        sql_builder.append("WHERE `key` >= $key_from AND `key` <= $key_to")
-        if reverse:
-            sql_builder.append("ORDER BY `key` DESC")
-        else:
-            sql_builder.append("ORDER BY `key` ASC")
-
-        sql_builder.append("LIMIT %d;" % (limit + 1))
-        sql = " ".join(sql_builder)
-
-        has_next = True
-        while has_next:
-            if key_from == None:
-                key_from = b''
-
-            if key_to == None:
-                key_to = b'\xff'
-
-            vars = dict(key_from=key_from, key_to=key_to)
-            if self.debug:
-                sql_query = self.db.query(sql, vars=vars, _test=True)
-                logging.debug("SQL: %s", sql_query)
-
-            time_before_execute = time.time()
-            result_iter = self.db.query(sql, vars=vars)
-            result = list(result_iter)
-
-            if self.sql_logger:
-                sql_query = self.db.query(sql, vars=vars, _test=True)
-                cost_time = time.time() - time_before_execute
-                sql_info = str(sql_query)
-                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-                self.sql_logger.append(log_info)
-
-            for item in result[:limit]:
-                # logging.debug("include_value(%s), item:%s", include_value, item)
-                key = self.mysql_to_py(item.key)
-
-                if include_value:
-                    if item.value == None:
-                        continue
-                    yield key, self.mysql_to_py(item.value)
-                else:
-                    yield key
-
-            if len(result) <= limit:
-                break
-
-            last_key = self.mysql_to_py(result[-1].key)
-            if reverse:
-                key_to = last_key
-            else:
-                key_from = last_key
-
-    def RangeIter(self, *args, **kw):
-        yield from self.RangeIterRaw(*args, **kw)
-
-    def CreateSnapshot(self):
-        raise NotImplementedError("CreateSnapshot")
-
-    def Write(self, batch, sync=False):
-        assert isinstance(batch, interfaces.BatchInterface)
-
-        with self.db.transaction():
-            for key in batch._puts:
-                value = batch._puts[key]
-                self.doPut(key, value)
-            for key in batch._inserts:
-                value = batch._inserts[key]
-                self.Insert(key, value)
-            for key in batch._deletes:
-                self.doDelete(key)
-
-    def Count(self, key_from=b'', key_to=b'\xff'):
-        sql = "SELECT COUNT(*) AS amount FROM kv_store WHERE `key` >= $key_from AND `key` <= $key_to"
-        start_time = time.time()
-        vars = dict(key_from=key_from, key_to=key_to)
-        try:
-            result_iter = self.db.query(sql, vars=vars)
-            for row in result_iter:
-                return self.mysql_to_py(row.amount)
-            return 0
-        finally:
-            if self.debug:
-                logging.debug("SQL:%s, key_from=(%r), key_to=(%r)", sql, key_from, key_to)
-
-            if self.sql_logger:
-                cost_time = time.time() - start_time
-                sql_query = self.db.query(sql, vars=vars, _test=True)
-                sql_info = str(sql_query)
-                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
-                self.sql_logger.append(log_info)
-    
-    def Increase(self, key=b'', increment=1, start_id=1, max_retry=10):
-        """自增方法"""
-        assert len(key) > 0, "key can not be empty"
-        for retry in range(max_retry):
-            old_value, version = self.get_with_version(key)
-            if old_value == None:
-                value_int = start_id
-            else:
-                value_int = int(old_value)
-                value_int += increment
-
-            value_bytes = str(value_int).encode("utf-8")
-            rowcount = self.compare_and_put(key, value_bytes, old_value=old_value)
-            if rowcount > 0:
-                return value_int
-        raise Exception("too many retry")
+# -*- coding:utf-8 -*-
+"""
+MySQL驱动
+
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-05-28 12:29:19
+@LastEditors  : xupingmao
+@LastEditTime : 2023-12-24 21:51:21
+@FilePath     : /xnote/xutils/db/driver_mysql.py
+@Description  : mysql驱动
+"""
+
+import logging
+import threading
+import time
+from collections import deque
+from xutils import interfaces
+from xutils.interfaces import SqlLoggerInterface
+import web.db
+
+class Holder(threading.local):
+    db = None
+
+    def __del__(self):
+        if self.db != None:
+            self.db.close()
+
+class MySQLKV(interfaces.DBInterface):
+
+    holder = Holder()
+    lock = threading.RLock()
+    max_value_length = 1024 * 1024 * 5 # 5MB
+    long_value_length = 1024 * 10 # 10K
+
+    def __init__(self, *, host=None, port=3306, user=None,
+                 password=None, database=None, pool_size=5, 
+                 db_instance=None, sql_logger=SqlLoggerInterface()):
+        assert isinstance(db_instance, web.db.MySQLDB)
+        self.db = db_instance
+        
+        self.debug = True
+        self.log_get_profile = True
+        self.log_put_profile = True
+        self.sql_logger = sql_logger  # type: SqlLoggerInterface
+        self.scan_limit = 200  # 扫描的分页大小
+        self.pool = deque()
+        self.pool_size = 0
+        self.debug_pool = False
+        self.driver = ""
+        self.driver_type = "mysql"
+
+        try:
+            self.init()
+        except Exception as e:
+            logging.error("mysql driver init failed, host=%s, port=%s, database=%s", host, port, database)
+            raise e
+
+    def close_cursor(self, cursor):
+        cursor.close()
+
+    def mysql_to_py(self, obj):
+        if isinstance(obj, bytearray):
+            return bytes(obj)
+        return obj
+
+    def init(self):
+        # tinyblob 最大长度 255
+        # KEY索引长度并不对key的长度做限制，只是索引最多使用200字节
+        # 但是如果索引前缀是相同的，会报主键冲突的错误
+        # 比如索引长度为5, 存在12345A，插入12345B会报错，插入12346A可以成功
+        # 一个CHAR占用3个字节，索引最多用1000个字节
+        
+        self.db.query("""CREATE TABLE IF NOT EXISTS `kv_store` (
+            `key` blob not null comment '键值对key', 
+            value longblob comment '键值对value',
+            version int not null default 0 comment '版本',
+            PRIMARY KEY (`key`(200))
+        ) COMMENT '键值对存储';
+        """)
+
+    def get_with_version(self, key):
+        # type: (bytes) -> tuple[bytes|None, int]
+        """通过key读取Value
+        @param {bytes} key
+        @return {bytes|None} value
+        """
+
+        assert isinstance(key, bytes)
+        
+        start_time = time.time()
+        sql = "SELECT value, version FROM kv_store WHERE `key`=$key"
+        vars = dict(key=key)
+        
+        try:
+            result_iter = self.db.query(sql, vars=vars)
+            for item in result_iter:
+                return self.mysql_to_py(item.value), item.version
+            return None, 0
+        except Exception as e:
+            del self.db.ctx.db # 尝试重新连接
+            real_sql = self.db.query(sql, vars=vars, _test=True)
+            logging.error("SQL:%s", real_sql)
+            raise e
+        finally:
+            cost_time = time.time() - start_time
+            
+            if self.log_get_profile:
+                logging.debug("GET (%s) cost %.2fms", key, cost_time*1000)
+
+            if self.sql_logger != None:
+                sql_query = self.db.query(sql, vars=vars, _test=True)
+                sql_info = str(sql_query)
+                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+                self.sql_logger.append(log_info)
+
+    def doGet(self, key, cursor=None):
+        value, version = self.get_with_version(key)
+        return value
+    
+    def Get(self, key=b''):
+        value, version = self.get_with_version(key)
+        return value
+
+    def BatchGet(self, key_list):
+        # type: (list[bytes]) -> dict[bytes, bytes]
+        if len(key_list) == 0:
+            return {}
+
+        start_time = time.time()
+
+        sql = ""
+        vars = dict(key_list=key_list)
+        try:
+            result = dict()
+            sql = "SELECT `key`, value FROM kv_store WHERE `key` IN $key_list"
+            # mysql.connector不支持传入列表,需要自己处理下
+            # sql_args = ["%s" for i in key_list]
+            # sql = sql % ",".join(sql_args)
+            result_iter = self.db.query(sql, vars=vars)
+            for item in result_iter:
+                key = self.mysql_to_py(item.key)
+                value = self.mysql_to_py(item.value)
+                result[key] = value
+            return result
+        finally:
+            cost_time = time.time() - start_time
+            if self.log_get_profile:
+                logging.debug("BatchGet (%s) cost %.2fms",
+                                key_list, cost_time*1000)
+
+            if self.sql_logger != None:
+                sql_query = self.db.query(sql, vars=vars, _test=True)
+                sql_info = str(sql_query)
+                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+                self.sql_logger.append(log_info)
+    
+    def log_sql(self, sql, vars, start_time=0.0, key=None):
+        if self.debug:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            logging.debug("SQL:%s", sql_query)
+
+        if self.sql_logger:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            cost_time = time.time() - start_time
+            log_info = str(sql_query) + " [%.2fms]" % (cost_time*1000)
+            self.sql_logger.append(log_info)
+
+    def put_long_value(self, key, value, sync=False, cursor=None):
+        vars = dict(key=key, value=value)
+        update_sql = "UPDATE kv_store SET value = $value, version=version+1 WHERE `key` = $key;"
+        rows = self.db.query(update_sql, vars=vars)
+        self.log_sql(update_sql, vars=vars, key="[Put:Update]")
+        assert isinstance(rows, int)
+        if rows == 0:
+            insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key,$value,1);"
+            self.db.query(insert_sql, vars=vars)
+            self.log_sql(insert_sql, vars=vars, key="[Put:Insert]")
+            
+    def doPut(self, key, value):
+        # type: (bytes,bytes) -> None
+        if len(value) > self.max_value_length:
+            raise interfaces.DatabaseException(code=400, message="value too long")
+        
+        if len(value) > self.long_value_length:
+            return self.put_long_value(key, value)
+
+        start_time = time.time()
+        upsert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1) ON DUPLICATE KEY UPDATE value=$value, version=version+1";
+        # update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key"
+        vars = dict(key=key,value=value)
+
+        rowcount = self.db.query(upsert_sql, vars=vars)
+        assert isinstance(rowcount, int)
+        self.log_sql(upsert_sql, vars, start_time=start_time, key=key)
+        assert rowcount > 0
+
+    def Put(self, key, value, sync=False, cursor=None):
+        # type: (bytes,bytes,bool,object) -> None
+        """写入Key-Value键值对
+        @param {bytes} key
+        @param {bytes} value
+        """
+
+        start_time = time.time()
+
+        try:
+            self.doPut(key, value)
+        finally:
+            cost_time = time.time() - start_time
+            if self.log_put_profile:
+                logging.debug("Put (%s) cost %.2fms", key, cost_time*1000)
+    
+    def put_with_version(self, key=b'', value=b'', version=0):
+        # type: (bytes,bytes,int) -> int
+        start_time = time.time()
+        if len(value) > self.max_value_length:
+            raise interfaces.DatabaseException(code=400, message="value too long")
+        update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key AND version=$version"
+        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1)"
+        vars = dict(key=key,value=value,version=version)
+        rowcount = self.db.query(update_sql, vars=vars)
+        assert isinstance(rowcount, int), "expect int rowcount"
+        if rowcount == 0:
+            # 数据不存在,执行插入动作
+            # 如果这里冲突了，按照默认规则抛出异常
+            if version != 0:
+                return 0
+            # 只有version=0的情况下才能插入
+            self.db.query(insert_sql, vars=vars)
+            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
+            return 1
+        else:
+            self.log_sql(update_sql, vars, start_time=start_time, key=key)
+        return rowcount
+    
+    def compare_and_put(self, key=b'', value=b'', old_value=None):
+        """比较之后再更新,如果old_value=None,则执行insert"""
+        # type: (bytes,bytes,bytes|None) -> int
+        start_time = time.time()
+        if len(value) > self.max_value_length:
+            raise interfaces.DatabaseException(code=400, message="value too long")
+        update_sql = "UPDATE kv_store SET value=$value, version=version+1 WHERE `key` = $key AND value=$old_value"
+        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 1)"
+        vars = dict(key=key,value=value,old_value=old_value)
+        
+        if old_value == None:
+            self.db.query(insert_sql, vars=vars)
+            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
+            return 1
+        
+        rowcount = self.db.query(update_sql, vars=vars)
+        assert isinstance(rowcount, int), "expect int rowcount"
+        self.log_sql(update_sql, vars, start_time=start_time, key=key)
+        return rowcount
+    
+    def Insert(self, key=b'', value=b'', version=0):
+        start_time = time.time()
+        if len(value) > self.max_value_length:
+            raise interfaces.DatabaseException(code=400, message="value too long")
+        insert_sql = "INSERT INTO kv_store (`key`, value, version) VALUES ($key, $value, 0)"
+        vars = dict(key=key,value=value,version=version)
+        try:
+            self.db.query(insert_sql, vars=vars)
+        finally:
+            self.log_sql(insert_sql, vars, start_time=start_time, key=key)
+
+    def doDeleteRaw(self, key=b'', sync=False, cursor=None):
+        # type: (bytes, bool, object) -> None
+        """删除Key-Value键值对
+        @param {bytes} key
+        """
+        start_time = time.time()
+        sql = "DELETE FROM kv_store WHERE `key` = $key;"
+        vars = dict(key=key)
+
+        if self.debug:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            logging.debug("SQL:%s", sql_query)
+
+        self.db.query(sql, vars=vars)
+
+        if self.sql_logger:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            sql_info = str(sql_query)
+            cost_time = time.time() - start_time
+            log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+            self.sql_logger.append(log_info)
+
+    def doDelete(self, key, sync=False, cursor=None):
+        return self.doDeleteRaw(key, sync, cursor)
+
+    def Delete(self, key=b'', sync=False):
+        self.doDeleteRaw(key)
+
+    def BatchDelete(self, keys=[]):
+        """批量删除键值对
+        :param {list} keys: 键集合
+        """
+        start_time = time.time()
+        sql = "DELETE FROM kv_store WHERE `key` in $keys;"
+        vars = dict(keys=keys)
+
+        if self.debug:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            logging.debug("SQL:%s", sql_query)
+
+        self.db.query(sql, vars=vars)
+
+        if self.sql_logger:
+            sql_query = self.db.query(sql, vars=vars, _test=True)
+            sql_info = str(sql_query)
+            cost_time = time.time() - start_time
+            log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+            self.sql_logger.append(log_info)
+
+    def RangeIterRaw(self,
+                     key_from=None,
+                     key_to=None,
+                     *,
+                     reverse=False,
+                     include_value=True,
+                     fill_cache=False):
+        """返回区间迭代器
+        @param {bytes}  key_from       开始的key（包含）FirstKey
+        @param {bytes}  key_to         结束的key（包含）LastKey
+        @param {bool}   reverse        是否反向查询
+        @param {bool}   include_value  是否包含值
+        @param {bool}   fill_cache     是否填充缓存
+        """
+
+        # 优化成轮询的短查询
+        limit = self.scan_limit
+
+        sql_builder = []
+
+        if include_value:
+            sql_builder.append("SELECT `key`, value FROM kv_store")
+        else:
+            # 只包含key
+            sql_builder.append("SELECT `key` FROM kv_store")
+
+        sql_builder.append("WHERE `key` >= $key_from AND `key` <= $key_to")
+        if reverse:
+            sql_builder.append("ORDER BY `key` DESC")
+        else:
+            sql_builder.append("ORDER BY `key` ASC")
+
+        sql_builder.append("LIMIT %d;" % (limit + 1))
+        sql = " ".join(sql_builder)
+
+        has_next = True
+        while has_next:
+            if key_from == None:
+                key_from = b''
+
+            if key_to == None:
+                key_to = b'\xff'
+
+            vars = dict(key_from=key_from, key_to=key_to)
+            if self.debug:
+                sql_query = self.db.query(sql, vars=vars, _test=True)
+                logging.debug("SQL: %s", sql_query)
+
+            time_before_execute = time.time()
+            result_iter = self.db.query(sql, vars=vars)
+            result = list(result_iter)
+
+            if self.sql_logger:
+                sql_query = self.db.query(sql, vars=vars, _test=True)
+                cost_time = time.time() - time_before_execute
+                sql_info = str(sql_query)
+                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+                self.sql_logger.append(log_info)
+
+            for item in result[:limit]:
+                # logging.debug("include_value(%s), item:%s", include_value, item)
+                key = self.mysql_to_py(item.key)
+
+                if include_value:
+                    if item.value == None:
+                        continue
+                    yield key, self.mysql_to_py(item.value)
+                else:
+                    yield key
+
+            if len(result) <= limit:
+                break
+
+            last_key = self.mysql_to_py(result[-1].key)
+            if reverse:
+                key_to = last_key
+            else:
+                key_from = last_key
+
+    def RangeIter(self, *args, **kw):
+        yield from self.RangeIterRaw(*args, **kw)
+
+    def CreateSnapshot(self):
+        raise NotImplementedError("CreateSnapshot")
+
+    def Write(self, batch, sync=False):
+        assert isinstance(batch, interfaces.BatchInterface)
+
+        with self.db.transaction():
+            for key in batch._puts:
+                value = batch._puts[key]
+                self.doPut(key, value)
+            for key in batch._inserts:
+                value = batch._inserts[key]
+                self.Insert(key, value)
+            for key in batch._deletes:
+                self.doDelete(key)
+
+    def Count(self, key_from=b'', key_to=b'\xff'):
+        sql = "SELECT COUNT(*) AS amount FROM kv_store WHERE `key` >= $key_from AND `key` <= $key_to"
+        start_time = time.time()
+        vars = dict(key_from=key_from, key_to=key_to)
+        try:
+            result_iter = self.db.query(sql, vars=vars)
+            for row in result_iter:
+                return self.mysql_to_py(row.amount)
+            return 0
+        finally:
+            if self.debug:
+                logging.debug("SQL:%s, key_from=(%r), key_to=(%r)", sql, key_from, key_to)
+
+            if self.sql_logger:
+                cost_time = time.time() - start_time
+                sql_query = self.db.query(sql, vars=vars, _test=True)
+                sql_info = str(sql_query)
+                log_info = sql_info + " [%.2fms]" % (cost_time*1000)
+                self.sql_logger.append(log_info)
+    
+    def Increase(self, key=b'', increment=1, start_id=1, max_retry=10):
+        """自增方法"""
+        assert len(key) > 0, "key can not be empty"
+        for retry in range(max_retry):
+            old_value, version = self.get_with_version(key)
+            if old_value == None:
+                value_int = start_id
+            else:
+                value_int = int(old_value)
+                value_int += increment
+
+            value_bytes = str(value_int).encode("utf-8")
+            rowcount = self.compare_and_put(key, value_bytes, old_value=old_value)
+            if rowcount > 0:
+                return value_int
+        raise Exception("too many retry")
```

### Comparing `xnote-web-0.1.0/xutils/db/driver_mysql_enhance.py` & `xnote-web-0.1.1/xutils/db/driver_mysql_enhance.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/driver_sqlite.py` & `xnote-web-0.1.1/xutils/db/driver_sqlite.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/driver_ssdb.py` & `xnote-web-0.1.1/xutils/db/driver_ssdb.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/encode.py` & `xnote-web-0.1.1/xutils/db/encode.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/filters.py` & `xnote-web-0.1.1/xutils/db/filters.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/lock.py` & `xnote-web-0.1.1/xutils/db/lock.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/db/shard.py` & `xnote-web-0.1.1/xutils/db/shard.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/dbutil.py` & `xnote-web-0.1.1/xutils/dbutil.py`

 * *Ordering differences only*

 * *Files 21% similar despite different names*

```diff
@@ -1,72 +1,72 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/12/04 15:36:42
-# @modified 2021/12/11 11:10:20
-# @filename dbutil.py
-from xutils.db.dbutil_base import *
-from xutils.db.dbutil_table import *
-from xutils.db.dbutil_hash import *
-from xutils.db.dbutil_sortedset import *
-from xutils.db.binlog import BinLog
-from xutils.db.dbutil_set import KvSetTable
-from xutils.db.dbutil_table_v2 import KvTableV2
-
-def _get_table_no_lock(table_name):
-    table = LDB_TABLE_DICT.get(table_name)
-    if table is None:
-        table = LdbTable(table_name)
-    return table
-
-
-def get_table_old(table_name, type="rdb"):
-    """获取table对象
-    @param {str} table_name 表名
-    @return {LdbTable}
-    """
-    check_table_name(table_name)
-
-    if type == "hash":
-        return get_hash_table(table_name)
-
-    table = LDB_TABLE_DICT.get(table_name)
-    if table is None:
-        with get_write_lock():
-            table = _get_table_no_lock(table_name)
-            LDB_TABLE_DICT[table_name] = table
-    return table
-
-
-def get_table(table_name, user_name=None):
-    """获取table对象
-    @param {str} table_name 表名
-    @return {LdbTable}
-    """
-    check_table_name(table_name)
-    return LdbTable(table_name, user_name=user_name)
-
-
-def get_hash_table(table_name, user_name=None):
-    return KvHashTable(table_name, user_name=user_name)
-
-def get_table_v2(table_name=""):
-    return KvTableV2(table_name)
-
-@xutils.log_init_deco("leveldb")
-def init(db_dir,
-         block_cache_size=None,
-         write_buffer_size=None,
-         db_instance=None,
-         db_cache=None,
-         binlog=False,
-         binlog_max_size=None):
-
-    assert db_instance != None
-
-    set_db_cache(db_cache)
-    set_db_instance(db_instance)
-
-    BinLog.set_enabled(binlog)
-    BinLog.set_max_size(binlog_max_size)
-
-    xutils.log("leveldb: %s" % db_instance)
-
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/12/04 15:36:42
+# @modified 2021/12/11 11:10:20
+# @filename dbutil.py
+from xutils.db.dbutil_base import *
+from xutils.db.dbutil_table import *
+from xutils.db.dbutil_hash import *
+from xutils.db.dbutil_sortedset import *
+from xutils.db.binlog import BinLog
+from xutils.db.dbutil_set import KvSetTable
+from xutils.db.dbutil_table_v2 import KvTableV2
+
+def _get_table_no_lock(table_name):
+    table = LDB_TABLE_DICT.get(table_name)
+    if table is None:
+        table = LdbTable(table_name)
+    return table
+
+
+def get_table_old(table_name, type="rdb"):
+    """获取table对象
+    @param {str} table_name 表名
+    @return {LdbTable}
+    """
+    check_table_name(table_name)
+
+    if type == "hash":
+        return get_hash_table(table_name)
+
+    table = LDB_TABLE_DICT.get(table_name)
+    if table is None:
+        with get_write_lock():
+            table = _get_table_no_lock(table_name)
+            LDB_TABLE_DICT[table_name] = table
+    return table
+
+
+def get_table(table_name, user_name=None):
+    """获取table对象
+    @param {str} table_name 表名
+    @return {LdbTable}
+    """
+    check_table_name(table_name)
+    return LdbTable(table_name, user_name=user_name)
+
+
+def get_hash_table(table_name, user_name=None):
+    return KvHashTable(table_name, user_name=user_name)
+
+def get_table_v2(table_name=""):
+    return KvTableV2(table_name)
+
+@xutils.log_init_deco("leveldb")
+def init(db_dir,
+         block_cache_size=None,
+         write_buffer_size=None,
+         db_instance=None,
+         db_cache=None,
+         binlog=False,
+         binlog_max_size=None):
+
+    assert db_instance != None
+
+    set_db_cache(db_cache)
+    set_db_instance(db_instance)
+
+    BinLog.set_enabled(binlog)
+    BinLog.set_max_size(binlog_max_size)
+
+    xutils.log("leveldb: %s" % db_instance)
+
```

### Comparing `xnote-web-0.1.0/xutils/exeutil.py` & `xnote-web-0.1.1/xutils/exeutil.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,313 +1,312 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2021/02/19 16:09:13
-# @modified 2022/04/16 08:43:45
-
-
-"""脚本执行相关的代码"""
-from __future__ import print_function
-
-import gc
-import sys
-import os
-import re
-import threading
-from collections import deque
-
-import web
-from xutils import six
-from xutils.imports import PY2, getstatusoutput
-
-
-def get_current_thread():
-    return threading.current_thread()
-
-def xutils_print_exc():
-    import xutils
-    xutils.print_exc()
-
-class MyStdout(threading.local):
-
-    # 输出缓存区
-    BUF_SIZE = 200
-
-    """标准输出的装饰器，用来拦截标准输出内容
-       
-    *本类是线程安全的*
-    """
-    def __init__(self, stdout, do_print = True):
-        self.stdout   = stdout
-        self.outfile  = web.debug
-        self.do_print = do_print
-        self.buf      = deque()
-        try:
-            self.encoding = stdout.encoding
-        except:
-            xutils_print_exc()
-        # 全局对象
-
-    def write(self, value):
-        result = self.buf
-        if result != None:
-            result.append(value)
-            if len(result) > self.BUF_SIZE:
-                result.popleft()
-        if self.do_print:
-            print(value, file=self.outfile, end="")
-
-    def writelines(self, lines):
-        return self.stdout.writelines(lines)
-
-    def flush(self):
-        return self.stdout.flush()
-
-    def close(self):
-        return self.stdout.close()
-
-    def record(self):
-        self.buf = deque()
-
-    def pop_record(self):
-        return "".join(self.buf)
-
-    @staticmethod
-    def get_records(thread_obj):
-        raise Exception("deprecated!!!")
-
-def exec_python_code(
-        name, 
-        code, 
-        record_stdout = True, 
-        raise_err     = False, 
-        do_gc         = True,
-        fpath         = None, 
-        vars          = None):
-    """执行python代码
-    @param {string} name 脚本的名称
-    @param {string} code 脚本代码
-    @param {bool} record_stdout 是否记录标准输出
-    @param {bool} raise_err 是否抛出异常
-    @param {bool} do_gc 是否执行GC
-    @param {dict} vars 执行的参数
-    """
-    ret = None
-    try:
-        if vars is None:
-            vars = {}
-        vars["__name__"] = "xscript.%s" % name
-        if fpath != None:
-            vars["__file__"] = fpath
-
-        # before_count = len(gc.get_objects())
-        if record_stdout:
-            if not isinstance(sys.stdout, MyStdout):
-                sys.stdout = MyStdout(sys.stdout)
-            sys.stdout.record()
-        ret = six.exec_(code, vars)
-        # 执行一次GC防止内存膨胀
-        if do_gc:
-            gc.collect()
-        # after_count = len(gc.get_objects())
-        if isinstance(sys.stdout, MyStdout):
-            ret = sys.stdout.pop_record()
-        # if do_gc:
-        #     log("gc.objects_count %s -> %s" % (before_count, after_count))
-        return ret
-    except Exception as e:
-        xutils_print_exc()
-        if raise_err:
-            raise e
-        if isinstance(sys.stdout, MyStdout):
-            ret = sys.stdout.pop_record()
-        return ret
-
-def fix_py2_code(code):
-    if not PY2:
-        return code
-    # remove encoding declaration, otherwise will cause
-    # SyntaxError: encoding declaration in Unicode string
-    return re.sub(r'^#[^\r\n]+', '', code)
-
-def exec_script(name, new_window=True, record_stdout = True, vars = None):
-    """执行script目录下的脚本"""
-    import xconfig
-    import xutils
-
-    dirname = xconfig.SCRIPTS_DIR
-    fpath   = os.path.join(dirname, name)
-    fpath   = os.path.abspath(fpath)
-    path    = fpath
-    ret     = 0
-    if name.endswith(".py"):
-        # 方便获取xnote内部信息用于扩展，同时防止开启过多Python进程
-        code = xutils.readfile(path)
-        code = fix_py2_code(code)
-        ret = exec_python_code(name, code, record_stdout, fpath = fpath, vars = vars)  
-    elif name.endswith(".command"):
-        # Mac os Script
-        xutils.system("chmod +x " + path)
-        if new_window:
-            ret = xutils.system("open " + path)
-        else:
-            ret = xutils.system("source " + path)
-    elif path.endswith((".bat", ".vbs")):
-        if new_window:
-            cmd = u("start %s") % path
-        else:
-            cmd = u("start /b %s") % path
-        if six.PY2:
-            # Python2 import当前目录优先
-            encoding = sys.getfilesystemencoding()
-            cmd = cmd.encode(encoding)
-        os.system(cmd)
-    elif path.endswith(".sh"):
-        # os.system("chmod +x " + path)
-        # os.system(path)
-        code = xutils.readfile(path)
-        # TODO 防止进程阻塞
-        ret, out = getstatusoutput(code)
-        return out
-    return ret
-
-def _load_script_code_by_fpath(fpath):
-    import xutils
-    code  = xutils.readfile(fpath)
-    code  = fix_py2_code(code)
-    return code
-
-def _load_script_code(name, dirname = None):
-    """加载脚本代码"""
-    import xconfig
-    if dirname is None:
-        # 必须实时获取dirname
-        dirname = xconfig.SCRIPTS_DIR
-    fpath = os.path.join(dirname, name)
-    return _load_script_code_by_fpath(fpath)
-
-def load_script(name, vars = None, dirname = None, code = None):
-    """加载脚本
-    @param {string} name 插件的名词，和脚本目录(/data/scripts)的相对路径
-    @param {dict} vars 全局变量，相当于脚本的globals变量
-    @param {dirname} dirname 自定义脚本目录
-    @param {code} 指定code运行，不加载文件
-    """
-    code = _load_script_code(name, dirname)
-    return exec_python_code(name, code, 
-        record_stdout = False, raise_err = True, vars = vars)
-
-
-class ScriptMeta:
-    """脚本的meta信息处理
-    """
-
-    def __init__(self):
-        self.meta_dict = dict()
-        # list的meta信息，比如
-        # @category file
-        # @category code
-        # 解析为 category = [file, code]
-        self.meta_list_dict = dict()
-
-    def add_item(self, key, value):
-        # 如果有多个，取第一个
-        if key not in self.meta_dict:
-            self.meta_dict[key] = value
-
-    def add_list_item(self, key, value):
-        item_list = self.meta_list_dict.get(key)
-        if item_list is None:
-            item_list = []
-
-        item_list.append(value)
-
-        self.meta_list_dict[key] = item_list
-
-    def load_meta_by_fpath(self, fpath):
-        code = _load_script_code_by_fpath(fpath)
-        return self.load_meta_by_code(code)
-
-    def load_meta_by_code(self, code):
-        for line in code.split("\n"):
-            if not line.startswith("#"):
-                continue
-            line = line.lstrip("#\t ")
-            if not line.startswith("@"):
-                continue
-
-            line = line.lstrip("@")
-            # 去掉注释部分
-            meta_line  = line.split("#", 1)[0]
-            # 拆分元数据
-            meta_parts = meta_line.split(maxsplit = 1)
-            meta_key   = meta_parts[0]
-            # meta_value = meta_parts[1:]
-            if len(meta_parts) == 1:
-                meta_value = ''
-            else:
-                meta_value = meta_parts[1]
-
-            meta_value = meta_value.strip()
-            self.add_item(meta_key, meta_value)
-            self.add_list_item(meta_key, meta_value)
-
-        return self.meta_dict
-
-    def get_raw_value(self, key):
-        return self.meta_dict.get(key)
-
-    def get_str_value(self, key, default_value = ""):
-        value = self.meta_dict.get(key)
-        if value is None:
-            return default_value
-        else:
-            return str(value)
-
-    def get_list_value(self, key):
-        value = self.meta_list_dict.get(key)
-        if value != None:
-            return value
-
-        value = self.meta_dict.get(key)
-        if value is None:
-            return []
-        return [value]
-
-    def get_bool_value(self, key, default_value = False):
-        value = self.meta_dict.get(key)
-        if value is None:
-            return default_value
-        return "true" == value.lower()
-
-    def get_int_value(self, key, default_value = 0):
-        value = self.get_raw_value(key)
-        if value is None:
-            return default_value
-        try:
-            return int(value)
-        except:
-            return default_value
-
-    def get_float_value(self, key, default_value = 0.0):
-        value = self.get_raw_value(key)
-        if value is None:
-            return default_value
-        try:
-            return float(value)
-        except:
-            return default_value
-
-    def has_tag(self, key):
-        return key in self.meta_dict
-
-def load_script_meta(fpath):
-    meta_object = ScriptMeta()
-    meta_object.load_meta_by_fpath(fpath)
-    return meta_object
-
-def load_script_meta_by_code(code):
-    meta_object = ScriptMeta()
-    meta_object.load_meta_by_code(code)
-    return meta_object
-
-def exec_command(command, confirmed = False):
-    pass
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2021/02/19 16:09:13
+# @modified 2022/04/16 08:43:45
+
+
+"""脚本执行相关的代码"""
+from __future__ import print_function
+
+import gc
+import sys
+import os
+import re
+import threading
+import logging
+from collections import deque
+
+import web
+from xutils import six, u
+from xutils.imports import PY2, getstatusoutput
+
+
+def get_current_thread():
+    return threading.current_thread()
+
+def xutils_print_exc():
+    import xutils
+    xutils.print_exc()
+
+class MyStdout(threading.local):
+
+    # 输出缓存区
+    BUF_SIZE = 200
+
+    """标准输出的装饰器，用来拦截标准输出内容
+       
+    *本类是线程安全的*
+    """
+    def __init__(self, stdout, do_print = True):
+        self.stdout   = stdout
+        self.outfile  = web.debug
+        self.do_print = do_print
+        self.buf      = deque()
+        try:
+            self.encoding = stdout.encoding
+        except:
+            xutils_print_exc()
+        # 全局对象
+
+    def write(self, value):
+        result = self.buf
+        if result != None:
+            result.append(value)
+            if len(result) > self.BUF_SIZE:
+                result.popleft()
+        if self.do_print:
+            print(value, file=self.outfile, end="")
+
+    def writelines(self, lines):
+        return self.stdout.writelines(lines)
+
+    def flush(self):
+        return self.stdout.flush()
+
+    def close(self):
+        return self.stdout.close()
+
+    def record(self):
+        self.buf = deque()
+
+    def pop_record(self):
+        return "".join(self.buf)
+
+    @staticmethod
+    def get_records(thread_obj):
+        raise Exception("deprecated!!!")
+
+def exec_python_code(
+        name, 
+        code, 
+        record_stdout = True, 
+        raise_err     = False, 
+        do_gc         = True,
+        fpath         = None, 
+        vars          = None):
+    """执行python代码
+    @param {string} name 脚本的名称
+    @param {string} code 脚本代码
+    @param {bool} record_stdout 是否记录标准输出
+    @param {bool} raise_err 是否抛出异常
+    @param {bool} do_gc 是否执行GC
+    @param {dict} vars 执行的参数
+    """
+    ret = None
+    try:
+        if vars is None:
+            vars = {}
+        vars["__name__"] = "xscript.%s" % name
+        if fpath != None:
+            vars["__file__"] = fpath
+
+        # before_count = len(gc.get_objects())
+        if record_stdout:
+            if not isinstance(sys.stdout, MyStdout):
+                sys.stdout = MyStdout(sys.stdout)
+            sys.stdout.record()
+        ret = six.exec_(code, vars)
+        # 执行一次GC防止内存膨胀
+        if do_gc:
+            gc.collect()
+        # after_count = len(gc.get_objects())
+        if isinstance(sys.stdout, MyStdout):
+            ret = sys.stdout.pop_record()
+        # if do_gc:
+        #     log("gc.objects_count %s -> %s" % (before_count, after_count))
+        return ret
+    except Exception as e:
+        logging.error("exception script.name=%s", name)
+        xutils_print_exc()
+        if raise_err:
+            raise e
+        if isinstance(sys.stdout, MyStdout):
+            ret = sys.stdout.pop_record()
+        return ret
+
+def fix_py2_code(code):
+    if not PY2:
+        return code
+    # remove encoding declaration, otherwise will cause
+    # SyntaxError: encoding declaration in Unicode string
+    return re.sub(r'^#[^\r\n]+', '', code)
+
+def exec_script(name, new_window=True, record_stdout = True, vars = None):
+    """执行script目录下的脚本"""
+    from xnote.core import xconfig
+    import xutils
+
+    dirname = xconfig.SCRIPTS_DIR
+    fpath   = os.path.join(dirname, name)
+    fpath   = os.path.abspath(fpath)
+    path    = fpath
+    ret     = 0
+    if name.endswith(".py"):
+        # 方便获取xnote内部信息用于扩展，同时防止开启过多Python进程
+        code = xutils.readfile(path)
+        code = fix_py2_code(code)
+        ret = exec_python_code(name, code, record_stdout, fpath = fpath, vars = vars)  
+    elif name.endswith(".command"):
+        # Mac os Script
+        xutils.system("chmod +x " + path)
+        if new_window:
+            ret = xutils.system("open " + path)
+        else:
+            ret = xutils.system("source " + path)
+    elif path.endswith((".bat", ".vbs")):
+        if new_window:
+            cmd = u("start %s") % path
+        else:
+            cmd = u("start /b %s") % path
+        if six.PY2:
+            # Python2 import当前目录优先
+            encoding = sys.getfilesystemencoding()
+            cmd = cmd.encode(encoding)
+        os.system(cmd)
+    elif path.endswith(".sh"):
+        # os.system("chmod +x " + path)
+        # os.system(path)
+        code = xutils.readfile(path)
+        # TODO 防止进程阻塞
+        ret, out = getstatusoutput(code)
+        return out
+    return ret
+
+def _load_script_code_by_fpath(fpath):
+    import xutils
+    code  = xutils.readfile(fpath)
+    code  = fix_py2_code(code)
+    return code
+
+def _load_script_code(name, dirname = None):
+    """加载脚本代码"""
+    from xnote.core import xconfig
+    if dirname is None:
+        # 必须实时获取dirname
+        dirname = xconfig.SCRIPTS_DIR
+    fpath = os.path.join(dirname, name)
+    return _load_script_code_by_fpath(fpath)
+
+def load_script(name, vars = None, dirname = None, code = None):
+    """加载脚本
+    @param {string} name 插件的名词，和脚本目录(/data/scripts)的相对路径
+    @param {dict} vars 全局变量，相当于脚本的globals变量
+    @param {dirname} dirname 自定义脚本目录
+    @param {code} 指定code运行，不加载文件
+    """
+    code = _load_script_code(name, dirname)
+    return exec_python_code(name, code, 
+        record_stdout = False, raise_err = True, vars = vars)
+
+
+class ScriptMeta:
+    """脚本的meta信息处理
+    """
+
+    def __init__(self):
+        self.meta_dict = dict()
+        # list的meta信息，比如
+        # @category file
+        # @category code
+        # 解析为 category = [file, code]
+        self.meta_list_dict = dict()
+
+    def add_item(self, key, value):
+        # 如果有多个，取第一个
+        if key not in self.meta_dict:
+            self.meta_dict[key] = value
+
+    def add_list_item(self, key, value):
+        item_list = self.meta_list_dict.get(key)
+        if item_list is None:
+            item_list = []
+
+        item_list.append(value)
+
+        self.meta_list_dict[key] = item_list
+
+    def load_meta_by_fpath(self, fpath):
+        code = _load_script_code_by_fpath(fpath)
+        return self.load_meta_by_code(code)
+
+    def load_meta_by_code(self, code):
+        for line in code.split("\n"):
+            if not line.startswith("#"):
+                continue
+            line = line.lstrip("#\t ")
+            if not line.startswith("@"):
+                continue
+
+            line = line.lstrip("@")
+            # 去掉注释部分
+            meta_line  = line.split("#", 1)[0]
+            # 拆分元数据
+            meta_parts = meta_line.split(maxsplit = 1)
+            meta_key   = meta_parts[0]
+            # meta_value = meta_parts[1:]
+            if len(meta_parts) == 1:
+                meta_value = ''
+            else:
+                meta_value = meta_parts[1]
+
+            meta_value = meta_value.strip()
+            self.add_item(meta_key, meta_value)
+            self.add_list_item(meta_key, meta_value)
+
+        return self.meta_dict
+
+    def get_raw_value(self, key):
+        return self.meta_dict.get(key)
+
+    def get_str_value(self, key, default_value = ""):
+        value = self.meta_dict.get(key)
+        if value is None:
+            return default_value
+        else:
+            return str(value)
+
+    def get_list_value(self, key):
+        value = self.meta_list_dict.get(key)
+        if value != None:
+            return value
+
+        value = self.meta_dict.get(key)
+        if value is None:
+            return []
+        return [value]
+
+    def get_bool_value(self, key, default_value = False):
+        value = self.meta_dict.get(key)
+        if value is None:
+            return default_value
+        return "true" == value.lower()
+
+    def get_int_value(self, key, default_value = 0):
+        value = self.get_raw_value(key)
+        if value is None:
+            return default_value
+        try:
+            return int(value)
+        except:
+            return default_value
+
+    def get_float_value(self, key, default_value = 0.0):
+        value = self.get_raw_value(key)
+        if value is None:
+            return default_value
+        try:
+            return float(value)
+        except:
+            return default_value
+
+    def has_tag(self, key):
+        return key in self.meta_dict
+
+def load_script_meta(fpath):
+    meta_object = ScriptMeta()
+    meta_object.load_meta_by_fpath(fpath)
+    return meta_object
+
+def load_script_meta_by_code(code):
+    meta_object = ScriptMeta()
+    meta_object.load_meta_by_code(code)
+    return meta_object
```

### Comparing `xnote-web-0.1.0/xutils/fsutil.py` & `xnote-web-0.1.1/xutils/fsutil.py`

 * *Files 2% similar despite different names*

```diff
@@ -42,14 +42,15 @@
 
 
 class FileUtilConfig:
     """文件util配置"""
     encode_name = False
     data_dir = ""
     tmp_dir = "/tmp"
+    encode_name_ext = (".x0", ".xenc")
 
 def get_real_path(path):
     """获取真实的path信息，如果配置了urlencode，强制进行urlencode，否则先按原路径检查，如果文件不存在，再进行urlencode
     之所以要这样做，主要是为了兼容从不支持unicode文件名的服务器同步到本地的文件"""
     assert isinstance(path, str)
     if path == "":
         return path
@@ -142,23 +143,23 @@
         raise Exception("can not detect file encoding, path=[%s]" % fpath,
                         last_err)
     return None
 
 
 def get_file_ext(fname):
     """获取文件扩展名,不带dot符号"""
-    if '.' not in fname:
-        return ''
-    ext = fname.split('.')[-1]
+    realname = decode_name(fname)
+    name, ext = os.path.splitext(realname)
+    ext = ext.strip(".")
     if len(ext) > 5:
         # 太长的扩展名视作无效
         return ""
-    return ext
+    return ext.lower()
 
-def format_size(size):
+def format_size(size: int):
     """格式化大小
 
     >>> format_size(10240)
     '10.00K'
     >>> format_size(1429365116108)
     '1.3T'
     >>> format_size(1429365116108000)
@@ -177,15 +178,14 @@
     elif size < 1024**4:
         return '%.2fG' % (float(size) / 1024**3)
     elif size < 1024**5:
         return '%.2fT' % (float(size) / 1024**4)
     else:
         return "%.2fP" % (float(size) / 1024**5)
 
-
 def format_file_size(fpath):
     """获取文件大小,返回文本格式"""
     return get_file_size(fpath, format=True)
 
 
 def get_file_size_int(fpath):
     """读取文件大小,返回数字"""
@@ -246,32 +246,34 @@
 
 
 def splitpath(path):
     return split_path_to_objects(path)
 
 
 def decode_name(name: str):
+    """将文件名解码成可读的名称"""
     dirname = os.path.dirname(name)
     basename = os.path.basename(name)
     namepart, ext = os.path.splitext(basename)
-    if ext in (".xenc", ".x0"):
+    if ext in FileUtilConfig.encode_name_ext:
         try:
             pad_size = 4 - len(namepart)%4
             namepart += '=' * pad_size
             basename = base64.urlsafe_b64decode(
                 namepart.encode("utf-8")).decode("utf-8")
             return os.path.join(dirname, basename)
         except:
             pass
     return xutils.unquote(name)
 
 
 def encode_name(name: str):
+    """对文件名进行编码,以避免文件系统的编码问题"""
     namepart, ext = os.path.splitext(name)
-    if ext in (".xenc", ".x0"):
+    if ext in FileUtilConfig.encode_name_ext:
         return name
     result = base64.urlsafe_b64encode(name.encode("utf-8")).decode("utf-8")
     result = result.strip("=")
     return result + ".x0"
 
 
 def path_equals(source, target):
@@ -869,7 +871,33 @@
     for c in " @$:#\\|=&?":
         filename = filename.replace(c, "_")
     
     quote_name = xutils.quote_unicode(filename)
     if quote_name != filename:
         return encode_name(filename)
     return filename
+
+def do_check_file_type(filename, target_set):
+    """根据文件后缀判断是否是图片"""
+    realname = decode_name(filename)
+    name, ext = os.path.splitext(realname)
+    return ext.lower() in target_set
+
+def is_img_file(filename):
+    """根据文件后缀判断是否是图片"""
+    return do_check_file_type(filename, xutils.FS_IMG_EXT_LIST)
+
+def is_text_file(filename):
+    """根据文件后缀判断是否是文本文件"""
+    return do_check_file_type(filename, xutils.FS_TEXT_EXT_LIST)
+
+def is_audio_file(filename):
+    return do_check_file_type(filename, xutils.FS_AUDIO_EXT_LIST)
+
+def is_code_file(filename):
+    return do_check_file_type(filename, xutils.FS_CODE_EXT_LIST)
+
+def get_text_ext():
+    return xutils.FS_TEXT_EXT_LIST
+
+def is_editable(fpath):
+    return is_text_file(fpath) or is_code_file(fpath)
```

### Comparing `xnote-web-0.1.0/xutils/func_util.py` & `xnote-web-0.1.1/xutils/func_util.py`

 * *Files 26% similar despite different names*

```diff
@@ -63,11 +63,17 @@
         if key == "__wrapped__":
             return None
             
         func_name = self.domain + "." + key
         func = _FUNC_DICT[func_name]
         self._meth[key] = func
         return func
+    
+    def invoke(self, method="", *args, **kw):
+        m = getattr(self, method)
+        if m != None:
+            return m(*args, **kw)
+        raise AttributeError(f"method {method} not exists")
 
 # DAO是模块的别名
 class DAO(Module):
     pass
```

### Comparing `xnote-web-0.1.0/xutils/htmlutil.py` & `xnote-web-0.1.1/xutils/htmlutil.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/imports.py` & `xnote-web-0.1.1/xutils/imports.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/jsonutil.py` & `xnote-web-0.1.1/xutils/jsonutil.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,34 +1,47 @@
 # -*- coding:utf-8 -*-
 """
 @Author       : kylen66
 @email        : kylen66
 @Date         : 2023-06-27 23:19:07
 @LastEditors  : xupingmao
-@LastEditTime : 2024-05-02 00:02:36
+@LastEditTime : 2024-05-19 11:56:07
 @FilePath     : /xnote/xutils/jsonutil.py
 @Description  : 描述
 """
 
 import json
 import uuid
+import inspect
 from datetime import datetime
 from datetime import date
 
 class MyEncoder(json.JSONEncoder):
     def default(self, obj):
         if isinstance(obj, datetime):
             return obj.strftime('%Y-%m-%d %H:%M:%S')
-        elif isinstance(obj, date):
+        if isinstance(obj, date):
             return obj.strftime('%Y-%m-%d')
-        elif isinstance(obj, bytes):
+        if isinstance(obj, bytes):
             return str(obj, encoding='utf-8')
-        elif isinstance(obj,uuid.UUID):
+        if isinstance(obj,uuid.UUID):
             return obj.hex
-        else:
-            return json.JSONEncoder.default(self, obj)
+        if inspect.isfunction(obj):
+            return "<function>"
+        if inspect.isclass(obj):
+            return "<class>"
+        if inspect.ismodule(obj):
+            return "<module>"
+
+        return json.JSONEncoder.default(self, obj)
 
 
 def parse_json_to_dict(text=""):
+    """json转dict"""
     result = json.loads(text)
     assert isinstance(result, dict)
     return result
+
+def tojson(obj, ensure_ascii=False):
+    """对象转json"""
+    return json.dumps(obj, cls=MyEncoder, ensure_ascii=ensure_ascii, separators=(',', ':'))
+
```

### Comparing `xnote-web-0.1.0/xutils/lockutil.py` & `xnote-web-0.1.1/xutils/lockutil.py`

 * *Files 8% similar despite different names*

```diff
@@ -33,15 +33,15 @@
 		except:
 			xutils.print_exc()
 			# TODO 这里读取文件内容为空，并且会清除文件内容，但是cat命令可以正常读取
 			# pid = self.fp.read(1024)
 			# raise Exception("lock file failed, locked by pid:%s" % pid)
 			return False
 
-	def unlock(self):
+	def unlock(self):		
 		if self.got_lock:
 			fcntl.flock(self.fp, fcntl.LOCK_UN)
 			# 不需要重置为空
 			self.fp.close()
 			self.got_lock = False
 		return True
 
@@ -68,29 +68,32 @@
 			self.fp = open(fpath, "w+")
 			return
 
 		self.fp = open(fpath)
 
 	def do_get_lock(self):
 		# 关闭读，重新打开为写模式
+		assert self.fp != None
 		self.fp.close()
 		self.fp = open(self.fpath, "w+")
 		self.fp.write(str(os.getpid()))
 		self.fp.flush()
 		self.got_lock = True
 
 	def try_lock(self):
+		assert self.fp != None
 		data = self.fp.read(1024)
 		if data == str(os.getpid()) or data == "":
 			self.do_get_lock()
 			return True
 
 		return False
 
 	def unlock(self):
+		assert self.fp != None
 		if self.got_lock:
 			self.fp.write("")
 			self.got_lock = False
 
 		if self.fp != None:
 			self.fp.close()
 			self.fp = None
```

### Comparing `xnote-web-0.1.0/xutils/logutil.py` & `xnote-web-0.1.1/xutils/logutil.py`

 * *Files 2% similar despite different names*

```diff
@@ -145,15 +145,15 @@
     def error(self, message, cost=0):
         error(self.metric, message, cost)
 
 def get_logger(name):
     return SimpleLogger(name)
 
 def get_log_path(level = "INFO"):
-    import xconfig
+    from xnote.core import xconfig
     date_time = time.strftime("%Y-%m")
     dirname = os.path.join(xconfig.LOG_DIR, date_time)
     fsutil.makedirs(dirname)
     date_str = time.strftime("%Y-%m-%d")
     fname = "xnote.%s.%s.log" % (date_str, level)
     return os.path.join(dirname, fname)
 
@@ -161,15 +161,20 @@
     fmt = u(fmt)
     if len(argv) > 0:
         message = fmt.format(*argv)
     else:
         message = fmt
     
     if show_logger:
-        f_back    = inspect.currentframe().f_back
+        frame = inspect.currentframe()
+        assert frame != None
+
+        f_back = frame.f_back
+        assert f_back != None
+        
         f_code    = f_back.f_code
         f_modname = f_back.f_globals.get("__name__")
         f_name    = f_code.co_name
         f_lineno  = f_back.f_lineno
         message = "%s|%s.%s:%s %s" % (_format_time(), f_modname, f_name, f_lineno, message)
     else:
         message = "%s|%s" % (_format_time(), message)
@@ -183,26 +188,26 @@
     log_async(fpath, message)
 
 def log_simple(fmt, *args):
     return log(fmt, False, True, None, *args)
 
 
 def _write_log_sync(level, metric, message, cost):
-    import xauth
+    from xnote.core import xauth
     fpath = get_log_path(level)
     user_name = xauth.current_name()
     if user_name is None:
         user_name = "-"
     full_message = "%s|%s|%s|%s|%sms|%s" % (_format_time(), level, user_name, metric, cost, message)
     # print(full_message)
     # 同步写在SAE上面有巨大的性能损耗
     do_log_sync(fpath, full_message)
 
 def _write_log(level, metric, message, cost):
-    import xauth
+    from xnote.core import xauth
     fpath = get_log_path(level)
     user_name = xauth.current_name()
     if user_name is None:
         user_name = "-"
     full_message = "%s|%s|%s|%s|%sms|%s" % (_format_time(), level, user_name, metric, cost, message)
     # print(full_message)
     # 同步写在SAE上面有巨大的性能损耗
@@ -312,15 +317,15 @@
                 logging.info("[timeit] %s, cost time: %s ms", message, int((t2-t1)*1000))
             return ret
         return handle
     return deco
 
 def profile_deco():
     """Profile装饰器,打印信息到标准输出,不支持递归函数"""
-    import xconfig
+    from xnote.core import xconfig
     def deco(func):
         def handle(*args, **kw):
             if xconfig.OPEN_PROFILE:
                 vars = dict()
                 vars["_f"] = func
                 vars["_args"] = args
                 vars["_kw"] = kw
@@ -383,20 +388,24 @@
     def is_expired(self):
         if self.ttl < 0:
             return False
         return time.time() > (self.st+self.ttl)
 
     def log(self, message, *args):
         MemLogger.clear_expired()
+        frame = inspect.currentframe()
+        assert frame != None
 
-        f_back    = inspect.currentframe().f_back
-        f_code    = f_back.f_code
-        f_modname = f_back.f_globals.get("__name__")
+        caller = frame.f_back
+        assert caller != None
+
+        f_code    = caller.f_code
+        f_modname = caller.f_globals.get("__name__")
         func_name    = f_code.co_name
-        func_lineno  = f_back.f_lineno
+        func_lineno  = caller.f_lineno
 
         head = "%s|%s:%s" % (_format_time(), func_name, func_lineno)
         if len(args) > 0:
             body = message % args
         else:
             body = message
```

### Comparing `xnote-web-0.1.0/xutils/mem_util.py` & `xnote-web-0.1.1/xutils/mem_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,14 +17,16 @@
 import xutils
 from xutils.base import Storage
 
 _ignored_name_set = set()
 _ignored_group_set = set()
 
 def get_mem_info_by_psutil():
+    if psutil is None:
+        return Storage()
     p                 = psutil.Process(pid=os.getpid())
     mem_info          = p.memory_info()
     mem_used          = xutils.format_size(mem_info.rss)
     sys_mem           = psutil.virtual_memory()
     sys_mem_used      = xutils.format_size(sys_mem.used)
     sys_mem_total     = xutils.format_size(sys_mem.total)
     if xutils.is_mac():
```

### Comparing `xnote-web-0.1.0/xutils/netutil.py` & `xnote-web-0.1.1/xutils/netutil.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/six.py` & `xnote-web-0.1.1/xutils/six.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-# Copyright (c) 2010-2017 Benjamin Peterson
+# Copyright (c) 2010-2020 Benjamin Peterson
 #
 # Permission is hereby granted, free of charge, to any person obtaining a copy
 # of this software and associated documentation files (the "Software"), to deal
 # in the Software without restriction, including without limitation the rights
 # to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 # copies of the Software, and to permit persons to whom the Software is
 # furnished to do so, subject to the following conditions:
@@ -25,15 +25,15 @@
 import functools
 import itertools
 import operator
 import sys
 import types
 
 __author__ = "Benjamin Peterson <benjamin@python.org>"
-__version__ = "1.10.0"
+__version__ = "1.16.0"
 
 
 # Useful for very coarse version differentiation.
 PY2 = sys.version_info[0] == 2
 PY3 = sys.version_info[0] == 3
 PY34 = sys.version_info[0:2] >= (3, 4)
 
@@ -67,14 +67,19 @@
             # 32-bit
             MAXSIZE = int((1 << 31) - 1)
         else:
             # 64-bit
             MAXSIZE = int((1 << 63) - 1)
         del X
 
+if PY34:
+    from importlib.util import spec_from_loader
+else:
+    spec_from_loader = None
+
 
 def _add_doc(func, doc):
     """Add documentation to a function."""
     func.__doc__ = doc
 
 
 def _import_module(name):
@@ -182,14 +187,19 @@
         return self.known_modules[self.name + "." + fullname]
 
     def find_module(self, fullname, path=None):
         if fullname in self.known_modules:
             return self
         return None
 
+    def find_spec(self, fullname, path, target=None):
+        if fullname in self.known_modules:
+            return spec_from_loader(fullname, self)
+        return None
+
     def __get_module(self, fullname):
         try:
             return self.known_modules[fullname]
         except KeyError:
             raise ImportError("This loader does not know module " + fullname)
 
     def load_module(self, fullname):
@@ -219,14 +229,20 @@
         """Return None
 
         Required, if is_package is implemented"""
         self.__get_module(fullname)  # eventually raises ImportError
         return None
     get_source = get_code  # same as get_code
 
+    def create_module(self, spec):
+        return self.load_module(spec.name)
+
+    def exec_module(self, module):
+        pass
+
 _importer = _SixMetaPathImporter(__name__)
 
 
 class _MovedItems(_LazyModule):
 
     """Lazy loading of moved objects"""
     __path__ = []  # mark as package
@@ -237,32 +253,33 @@
     MovedAttribute("filter", "itertools", "builtins", "ifilter", "filter"),
     MovedAttribute("filterfalse", "itertools", "itertools", "ifilterfalse", "filterfalse"),
     MovedAttribute("input", "__builtin__", "builtins", "raw_input", "input"),
     MovedAttribute("intern", "__builtin__", "sys"),
     MovedAttribute("map", "itertools", "builtins", "imap", "map"),
     MovedAttribute("getcwd", "os", "os", "getcwdu", "getcwd"),
     MovedAttribute("getcwdb", "os", "os", "getcwd", "getcwdb"),
-    MovedAttribute("getstatusoutput", "commands", "subprocess"),
     MovedAttribute("getoutput", "commands", "subprocess"),
     MovedAttribute("range", "__builtin__", "builtins", "xrange", "range"),
     MovedAttribute("reload_module", "__builtin__", "importlib" if PY34 else "imp", "reload"),
     MovedAttribute("reduce", "__builtin__", "functools"),
     MovedAttribute("shlex_quote", "pipes", "shlex", "quote"),
     MovedAttribute("StringIO", "StringIO", "io"),
-    MovedAttribute("UserDict", "UserDict", "collections"),
+    MovedAttribute("UserDict", "UserDict", "collections", "IterableUserDict", "UserDict"),
     MovedAttribute("UserList", "UserList", "collections"),
     MovedAttribute("UserString", "UserString", "collections"),
     MovedAttribute("xrange", "__builtin__", "builtins", "xrange", "range"),
     MovedAttribute("zip", "itertools", "builtins", "izip", "zip"),
     MovedAttribute("zip_longest", "itertools", "itertools", "izip_longest", "zip_longest"),
     MovedModule("builtins", "__builtin__"),
     MovedModule("configparser", "ConfigParser"),
+    MovedModule("collections_abc", "collections", "collections.abc" if sys.version_info >= (3, 3) else "collections"),
     MovedModule("copyreg", "copy_reg"),
     MovedModule("dbm_gnu", "gdbm", "dbm.gnu"),
-    MovedModule("_dummy_thread", "dummy_thread", "_dummy_thread"),
+    MovedModule("dbm_ndbm", "dbm", "dbm.ndbm"),
+    MovedModule("_dummy_thread", "dummy_thread", "_dummy_thread" if sys.version_info < (3, 9) else "_thread"),
     MovedModule("http_cookiejar", "cookielib", "http.cookiejar"),
     MovedModule("http_cookies", "Cookie", "http.cookies"),
     MovedModule("html_entities", "htmlentitydefs", "html.entities"),
     MovedModule("html_parser", "HTMLParser", "html.parser"),
     MovedModule("http_client", "httplib", "http.client"),
     MovedModule("email_mime_base", "email.MIMEBase", "email.mime.base"),
     MovedModule("email_mime_image", "email.MIMEImage", "email.mime.image"),
@@ -417,14 +434,16 @@
     MovedAttribute("UnknownHandler", "urllib2", "urllib.request"),
     MovedAttribute("HTTPErrorProcessor", "urllib2", "urllib.request"),
     MovedAttribute("urlretrieve", "urllib", "urllib.request"),
     MovedAttribute("urlcleanup", "urllib", "urllib.request"),
     MovedAttribute("URLopener", "urllib", "urllib.request"),
     MovedAttribute("FancyURLopener", "urllib", "urllib.request"),
     MovedAttribute("proxy_bypass", "urllib", "urllib.request"),
+    MovedAttribute("parse_http_list", "urllib2", "urllib.request"),
+    MovedAttribute("parse_keqv_list", "urllib2", "urllib.request"),
 ]
 for attr in _urllib_request_moved_attributes:
     setattr(Module_six_moves_urllib_request, attr.name, attr)
 del attr
 
 Module_six_moves_urllib_request._moved_attributes = _urllib_request_moved_attributes
 
@@ -632,21 +651,24 @@
     del struct
     byte2int = operator.itemgetter(0)
     indexbytes = operator.getitem
     iterbytes = iter
     import io
     StringIO = io.StringIO
     BytesIO = io.BytesIO
+    del io
     _assertCountEqual = "assertCountEqual"
     if sys.version_info[1] <= 1:
         _assertRaisesRegex = "assertRaisesRegexp"
         _assertRegex = "assertRegexpMatches"
+        _assertNotRegex = "assertNotRegexpMatches"
     else:
         _assertRaisesRegex = "assertRaisesRegex"
         _assertRegex = "assertRegex"
+        _assertNotRegex = "assertNotRegex"
 else:
     def b(s):
         return s
     # Workaround for standalone backslash
 
     def u(s):
         return unicode(s.replace(r'\\', r'\\\\'), "unicode_escape")
@@ -660,14 +682,15 @@
         return ord(buf[i])
     iterbytes = functools.partial(itertools.imap, ord)
     import StringIO
     StringIO = BytesIO = StringIO.StringIO
     _assertCountEqual = "assertItemsEqual"
     _assertRaisesRegex = "assertRaisesRegexp"
     _assertRegex = "assertRegexpMatches"
+    _assertNotRegex = "assertNotRegexpMatches"
 _add_doc(b, """Byte literal""")
 _add_doc(u, """Text literal""")
 
 
 def assertCountEqual(self, *args, **kwargs):
     return getattr(self, _assertCountEqual)(*args, **kwargs)
 
@@ -676,14 +699,18 @@
     return getattr(self, _assertRaisesRegex)(*args, **kwargs)
 
 
 def assertRegex(self, *args, **kwargs):
     return getattr(self, _assertRegex)(*args, **kwargs)
 
 
+def assertNotRegex(self, *args, **kwargs):
+    return getattr(self, _assertNotRegex)(*args, **kwargs)
+
+
 if PY3:
     exec_ = getattr(moves.builtins, "exec")
 
     def reraise(tp, value, tb=None):
         try:
             if value is None:
                 value = tp()
@@ -711,24 +738,15 @@
     try:
         raise tp, value, tb
     finally:
         tb = None
 """)
 
 
-if sys.version_info[:2] == (3, 2):
-    exec_("""def raise_from(value, from_value):
-    try:
-        if from_value is None:
-            raise value
-        raise value from from_value
-    finally:
-        value = None
-""")
-elif sys.version_info[:2] > (3, 2):
+if sys.version_info[:2] > (3,):
     exec_("""def raise_from(value, from_value):
     try:
         raise value from from_value
     finally:
         value = None
 """)
 else:
@@ -800,34 +818,66 @@
         _print(*args, **kwargs)
         if flush and fp is not None:
             fp.flush()
 
 _add_doc(reraise, """Reraise an exception.""")
 
 if sys.version_info[0:2] < (3, 4):
+    # This does exactly the same what the :func:`py3:functools.update_wrapper`
+    # function does on Python versions after 3.2. It sets the ``__wrapped__``
+    # attribute on ``wrapper`` object and it doesn't raise an error if any of
+    # the attributes mentioned in ``assigned`` and ``updated`` are missing on
+    # ``wrapped`` object.
+    def _update_wrapper(wrapper, wrapped,
+                        assigned=functools.WRAPPER_ASSIGNMENTS,
+                        updated=functools.WRAPPER_UPDATES):
+        for attr in assigned:
+            try:
+                value = getattr(wrapped, attr)
+            except AttributeError:
+                continue
+            else:
+                setattr(wrapper, attr, value)
+        for attr in updated:
+            getattr(wrapper, attr).update(getattr(wrapped, attr, {}))
+        wrapper.__wrapped__ = wrapped
+        return wrapper
+    _update_wrapper.__doc__ = functools.update_wrapper.__doc__
+
     def wraps(wrapped, assigned=functools.WRAPPER_ASSIGNMENTS,
               updated=functools.WRAPPER_UPDATES):
-        def wrapper(f):
-            f = functools.wraps(wrapped, assigned, updated)(f)
-            f.__wrapped__ = wrapped
-            return f
-        return wrapper
+        return functools.partial(_update_wrapper, wrapped=wrapped,
+                                 assigned=assigned, updated=updated)
+    wraps.__doc__ = functools.wraps.__doc__
+
 else:
     wraps = functools.wraps
 
 
 def with_metaclass(meta, *bases):
     """Create a base class with a metaclass."""
     # This requires a bit of explanation: the basic idea is to make a dummy
     # metaclass for one level of class instantiation that replaces itself with
     # the actual metaclass.
-    class metaclass(meta):
+    class metaclass(type):
 
         def __new__(cls, name, this_bases, d):
-            return meta(name, bases, d)
+            if sys.version_info[:2] >= (3, 7):
+                # This version introduced PEP 560 that requires a bit
+                # of extra care (we mimic what is done by __build_class__).
+                resolved_bases = types.resolve_bases(bases)
+                if resolved_bases is not bases:
+                    d['__orig_bases__'] = bases
+            else:
+                resolved_bases = bases
+            return meta(name, resolved_bases, d)
+
+        @classmethod
+        def __prepare__(cls, name, this_bases):
+            return meta.__prepare__(name, bases)
     return type.__new__(metaclass, 'temporary_class', (), {})
 
 
 def add_metaclass(metaclass):
     """Class decorator for creating a class with a metaclass."""
     def wrapper(cls):
         orig_vars = cls.__dict__.copy()
@@ -835,21 +885,83 @@
         if slots is not None:
             if isinstance(slots, str):
                 slots = [slots]
             for slots_var in slots:
                 orig_vars.pop(slots_var)
         orig_vars.pop('__dict__', None)
         orig_vars.pop('__weakref__', None)
+        if hasattr(cls, '__qualname__'):
+            orig_vars['__qualname__'] = cls.__qualname__
         return metaclass(cls.__name__, cls.__bases__, orig_vars)
     return wrapper
 
 
+def ensure_binary(s, encoding='utf-8', errors='strict'):
+    """Coerce **s** to six.binary_type.
+
+    For Python 2:
+      - `unicode` -> encoded to `str`
+      - `str` -> `str`
+
+    For Python 3:
+      - `str` -> encoded to `bytes`
+      - `bytes` -> `bytes`
+    """
+    if isinstance(s, binary_type):
+        return s
+    if isinstance(s, text_type):
+        return s.encode(encoding, errors)
+    raise TypeError("not expecting type '%s'" % type(s))
+
+
+def ensure_str(s, encoding='utf-8', errors='strict'):
+    """Coerce *s* to `str`.
+
+    For Python 2:
+      - `unicode` -> encoded to `str`
+      - `str` -> `str`
+
+    For Python 3:
+      - `str` -> `str`
+      - `bytes` -> decoded to `str`
+    """
+    # Optimization: Fast return for the common case.
+    if type(s) is str:
+        return s
+    if PY2 and isinstance(s, text_type):
+        return s.encode(encoding, errors)
+    elif PY3 and isinstance(s, binary_type):
+        return s.decode(encoding, errors)
+    elif not isinstance(s, (text_type, binary_type)):
+        raise TypeError("not expecting type '%s'" % type(s))
+    return s
+
+
+def ensure_text(s, encoding='utf-8', errors='strict'):
+    """Coerce *s* to six.text_type.
+
+    For Python 2:
+      - `unicode` -> `unicode`
+      - `str` -> `unicode`
+
+    For Python 3:
+      - `str` -> `str`
+      - `bytes` -> decoded to `str`
+    """
+    if isinstance(s, binary_type):
+        return s.decode(encoding, errors)
+    elif isinstance(s, text_type):
+        return s
+    else:
+        raise TypeError("not expecting type '%s'" % type(s))
+
+
 def python_2_unicode_compatible(klass):
     """
-    A decorator that defines __unicode__ and __str__ methods under Python 2.
+    A class decorator that defines __unicode__ and __str__ methods under Python 2.
     Under Python 3 it does nothing.
 
     To support Python 2 and 3 with a single code base, define a __str__ method
     returning text and apply this decorator to the class.
     """
     if PY2:
         if '__str__' not in klass.__dict__:
```

### Comparing `xnote-web-0.1.0/xutils/sqldb/table_config.py` & `xnote-web-0.1.1/xutils/sqldb/table_config.py`

 * *Ordering differences only*

 * *Files 27% similar despite different names*

```diff
@@ -1,28 +1,28 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2024-04-05 11:56:40
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-05 12:04:59
-@FilePath     : /xnote/xutils/sqldb/table_config.py
-@Description  : SQL表配置
-"""
-
-class TableConfig:
-
-    log_profile = False
-    enable_binlog = False
-    enable_auto_ddl = True # 自动DDL
-    
-    _disable_profile_tables = set()
-    _disable_binlog_tables = set()
-    
-    @classmethod
-    def disable_profile(cls, table_name=""):
-        cls._disable_profile_tables.add(table_name)
-        
-    @classmethod
-    def disable_binlog(cls, table_name=""):
-        cls._disable_binlog_tables.add(table_name)
-    
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2024-04-05 11:56:40
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-05 12:04:59
+@FilePath     : /xnote/xutils/sqldb/table_config.py
+@Description  : SQL表配置
+"""
+
+class TableConfig:
+
+    log_profile = False
+    enable_binlog = False
+    enable_auto_ddl = True # 自动DDL
+    
+    _disable_profile_tables = set()
+    _disable_binlog_tables = set()
+    
+    @classmethod
+    def disable_profile(cls, table_name=""):
+        cls._disable_profile_tables.add(table_name)
+        
+    @classmethod
+    def disable_binlog(cls, table_name=""):
+        cls._disable_binlog_tables.add(table_name)
+
```

### Comparing `xnote-web-0.1.0/xutils/sqldb/table_manager.py` & `xnote-web-0.1.1/xutils/sqldb/table_manager.py`

 * *Ordering differences only*

 * *Files 13% similar despite different names*

```diff
@@ -1,393 +1,393 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-04-28 20:36:45
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-05 11:58:25
-@FilePath     : /xnote/xutils/sqldb/table_manager.py
-@Description  : SQL表结构管理
-"""
-
-import logging
-import xutils
-import web.db
-from .table_config import TableConfig
-
-empty_db = web.db.DB(None, {})
-
-class ColumnInfo:
-
-    def __init__(self):
-        self.name = ""
-        self.type = ""
-
-class BaseTableManager:
-    """检查数据库字段，如果不存在就自动创建"""
-
-    def __init__(self, tablename, db = empty_db, **kw):
-        self.tablename = tablename
-        self.kw = kw
-        self.debug = kw.pop("debug", False)
-        self.connect()
-        self.db = db
-        self.mysql_database = kw.get("mysql_database", "")
-        self.pk_name = kw.get("pk_name", "id")
-        self.pk_type = kw.get("pk_type", "int")
-        self.pk_len = kw.get("pk_len", 0)
-        self.pk_comment = kw.get("pk_comment", "主键")
-        # 目前只支持这两种主键
-        assert self.pk_type in ("int", "blob")
-
-    def __enter__(self):
-        return self
-
-    def __exit__(self, type, value, traceback):
-        self.close()
-
-    def create_table(self):
-        if self.db.dbname == "sqlite":
-            pass
-
-    def connect(self):
-        pass
-
-    def execute(self, sql):
-        pass
-
-    def escape(self, strval):
-        strval = strval.replace("'", "''")
-        return "'%s'" % strval
-    
-    def desc_columns(self):
-        demo = ColumnInfo()
-        demo.name = "demo"
-        demo.type = "text"
-        return [demo]
-
-    def add_column(self, colname, coltype,
-                   default_value=None, not_null=True, **kw):
-        """添加字段，如果已经存在则跳过，名称相同类型不同抛出异常"""
-        sql = f"ALTER TABLE `{self.tablename}` ADD COLUMN `{colname}` {coltype}"
-        columns = self.desc_columns()
-        for column in columns:
-            name = column.name
-            type = column.type
-            if name == colname:
-                # 已经存在
-                return
-        
-        if default_value != None:
-            if isinstance(default_value, str):
-                default_value = self.escape(default_value)
-            sql += " DEFAULT %s" % default_value
-        if not_null:
-            sql += " NOT NULL"
-        self.execute(sql)
-
-    def add_index(self, colname, is_unique=False, **kw):
-        raise Exception("not implemented")
-
-    def drop_index(self, col_name, is_unique=False):
-        sql = "DROP INDEX idx_%s_%s" % (self.tablename, col_name)
-        try:
-            self.execute(sql)
-        except Exception:
-            xutils.print_exc()
-
-    def drop_column(self, colname):
-        sql = "ALTER TABLE `%s` DROP COLUMN `%s`" % (self.tablename, colname)
-        self.execute(sql)
-
-    def close(self):
-        pass
-
-    
-    def quote_col(self, colname=""):
-        if "`" in colname:
-            return colname
-        return "`%s`" % colname
-
-class MySQLTableManager(BaseTableManager):
-    # TODO 待实现测试
-
-    def connect(self):
-        pass
-
-    def create_table(self):
-        table_name = self.tablename
-        pk_name = self.pk_name
-        pk_len = self.pk_len
-        pk_comment = self.pk_comment
-        if self.pk_type == "blob":
-            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
-                `{pk_name}` blob not null comment '{pk_comment}',
-                PRIMARY KEY (`{pk_name}`({pk_len}))
-            )"""
-        else:
-            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
-                `{pk_name}` bigint unsigned not null auto_increment,
-                PRIMARY KEY (`{pk_name}`)
-            ) CHARACTER SET utf8mb4;"""
-        self.db.query(sql)
-
-    
-    def desc_columns(self):
-        sql = "DESC `%s`" % self.tablename
-        columns = list(self.db.query(sql))
-        if self.debug:
-            print("desc %s, columns=%s" % (self.tablename, columns))
-        result = []
-        for col in columns:
-            item = ColumnInfo()
-            item.type = col["Type"]
-            item.name = col["Field"]
-            result.append(item)
-        return result
-    
-    def execute(self, sql):
-        return self.db.query(sql)
-    
-    def add_column(self, colname, coltype,
-                   default_value=None, not_null=True, **kw):
-        if coltype == "text":
-            # MySQL5.7不支持默认值
-            default_value = None
-        super().add_column(colname, coltype, default_value, not_null)
-    
-    def add_index(self, colname, is_unique=False, key_len=0, key_len_list=[], **kw):
-        """MySQL版创建索引"""
-        index_name = ""
-        colname_str = ""
-
-        index_prefix = "idx"
-        if is_unique:
-            index_prefix = "uk"
-
-        if isinstance(colname, list):
-            index_name = index_prefix
-            for name in colname:
-                index_name += "_" + name
-            temp_col_list = []
-            for index, name in enumerate(colname):
-                if index < len(key_len_list):
-                    key_len = key_len_list[index]
-                else:
-                    key_len = 0
-                if key_len > 0:
-                    tmp_col_name = self.quote_col(name) + "(%d)" % key_len
-                else:
-                    tmp_col_name = self.quote_col(name)
-                temp_col_list.append(tmp_col_name)
-            colname_str = ",".join(temp_col_list)
-        else:
-            index_name = index_prefix + "_" + colname
-            colname_str = self.quote_col(colname)
-            if key_len > 0:
-                colname_str += "(%d)" % key_len
-
-        if is_unique:
-            sql = "ALTER TABLE `%s` ADD UNIQUE `%s` (%s)" % (
-                    self.tablename, index_name, colname_str)
-        else:
-            sql = "ALTER TABLE `%s` ADD INDEX `%s` (%s)" % (
-                    self.tablename, index_name, colname_str)
-
-        if self.is_index_exists(index_name):
-            logging.info("index %s already exists", index_name)
-            return
-        
-        logging.info("%s", sql)
-        if not TableConfig.enable_auto_ddl:
-            raise Exception("db_auto_ddl is disabled")
-        self.execute(sql)
-        
-    
-    def is_index_exists(self, index_name=""):
-        assert len(self.mysql_database) > 0
-        sql = "SELECT COUNT(*) as amount FROM information_schema.statistics WHERE table_schema=$database AND table_name = $table_name AND index_name = $index_name"
-        first = self.db.query(sql, vars=dict(database=self.mysql_database, table_name=self.tablename, index_name=index_name)).first()
-        return first.amount > 0
-    
-
-class SqliteTableManager(BaseTableManager):
-
-    def connect(self):
-        pass
-
-    def create_table(self):
-        table_name = self.tablename
-        pk_name = self.pk_name
-
-        if self.pk_type == "blob":
-            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
-                {pk_name} blob primary key
-            );"""
-        else:
-            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}`(
-                {pk_name} integer primary key autoincrement
-            );"""
-        self.execute(sql)
-
-    def execute(self, sql):
-        try:
-            if self.debug:
-                logging.debug(sql)
-            return self.db.query(sql)
-        except Exception as e:
-            raise e
-
-    def close(self):
-        pass
-
-    def generate_migrate_sql(self, dropped_names):
-        """生成迁移字段的SQL（本质上是迁移）"""
-        columns = self.execute("pragma table_info('%s')" % self.tablename)
-        new_names = []
-        old_names = []
-        for column in columns:
-            name = column["name"]
-            type = column["type"]
-            old_names.append(name)
-            if name not in dropped_names:
-                new_names.append(name)
-        # step1 = "ALTER TABLE %s RENAME TO backup_table;" % (self.tablename)
-        step2 = "INSERT INTO %s (%s) \nSELECT %s FROM backup_table;" % (
-                self.tablename,
-                ",".join(new_names),
-                ",".join(old_names)
-        )
-        return step2
-    
-    def add_column(self, colname, coltype,
-                   default_value=None, not_null=True, **kw):
-        if coltype == "text" and default_value == None:
-            default_value = ""
-        super().add_column(colname, coltype, default_value, not_null)
-
-    def drop_column(self, colname):
-        # sqlite不支持 DROP COLUMN 得使用中间表
-        pass
-
-    def desc_columns(self):
-        columns = self.execute("pragma table_info('%s')" %
-                        self.tablename)
-        result = []
-        for col in columns:
-            item = ColumnInfo()
-            item.type = col["type"]
-            item.name = col["name"]
-            result.append(item)
-        return result
-
-    def add_index(self, colname, is_unique=False, **kw):
-        # sqlite的索引和table是一个级别的schema
-        index_prefix = "idx_"
-        if is_unique:
-            index_prefix = "uk_"
-
-        colname_str = colname
-        
-        if isinstance(colname, list):
-            idx_name = index_prefix + self.tablename + "_" + "_".join(colname)
-            colname_str = ",".join(colname)
-        else:
-            idx_name = index_prefix + self.tablename + "_" + colname
-                            
-        if is_unique:
-            sql = "CREATE UNIQUE INDEX IF NOT EXISTS %s ON `%s` (%s)" % (
-                idx_name, self.tablename, colname_str)
-        else:
-            sql = "CREATE INDEX IF NOT EXISTS %s ON `%s` (%s)" % (
-                idx_name, self.tablename, colname_str)
-            
-        self.execute(sql)
-
-class TableInfo:
-
-    def __init__(self, tablename = ""):
-        self.tablename = tablename
-        self.pk_name = "id"
-        self.db_type = "" # 数据库类型, 比如 mysql/sqlite
-        self.comment = "" # 表的描述
-        self.column_names = []
-        self.columns = []
-        self.indexes = []
-        self.dbpath = "" # sqlite文件路径
-        self.enable_binlog = True
-        self.log_profile = True
-        self.is_deleted = False
-    
-    def add_column(self, colname, *args, **kw):
-        self.column_names.append(colname)
-        self.columns.append([(colname, ) + args, kw])
-    
-    def add_index(self, *args, **kw):
-        self.indexes.append([args, kw])
-
-class TableManagerFacade:
-
-    table_dict = {}
-
-    @classmethod
-    def clear_table_dict(cls):
-        cls.table_dict = {}
-    
-    @classmethod
-    def get_table_info(cls, tablename=""):
-        # type: (str) -> TableInfo|None
-        return cls.table_dict.get(tablename)
-    
-    @classmethod
-    def get_table_info_dict(cls):
-        # type: () -> dict[str, TableInfo]
-        return cls.table_dict
-
-    def __init__(self, tablename, db = empty_db, is_backup = False, **kw):
-        self.table_info = TableInfo(tablename)
-        self.table_info.pk_name = kw.get("pk_name", "id")
-        self.table_info.db_type = kw.get("db_type", "")
-        if db.dbname == "mysql":
-            self.manager = MySQLTableManager(tablename, db = db, **kw)
-        else:
-            self.manager = SqliteTableManager(tablename, db = db, **kw)
-            self.table_info.dbpath = db.dbpath
-        
-        self.table_info.is_deleted = kw.get("is_deleted", False)
-        self.table_info.comment = kw.get("comment", "")
-
-        self.manager.create_table()
-
-        check_table_define = kw.get("check_table_define", True)
-        if not is_backup and check_table_define:
-            if tablename in self.table_dict:
-                raise Exception("table already defined: %s" % tablename)
-        
-        if not is_backup:
-            self.table_dict[tablename] = self.table_info
-    
-    def add_column(self, colname, coltype,
-                   default_value=None, not_null=True, comment=""):
-        coltype_lower = coltype.lower()
-
-        if "varchar" in coltype_lower:
-            assert default_value != None, f"varchar column {colname} default value cant be NULL"
-        if coltype_lower in ("int", "tinyint", "bigint"):
-            assert default_value != None, f"{coltype} column {colname} default value cant be NULL"
-        
-        self.table_info.add_column(colname, coltype, default_value, not_null)
-        self.manager.add_column(colname, coltype, default_value, not_null, comment=comment)
-    
-    def drop_column(self, colname, coltype,
-                   default_value=None, not_null=True):
-        pass
-
-    def add_index(self, colname, is_unique=False, **kw):
-        self.table_info.add_index(colname, is_unique)
-        self.manager.add_index(colname, is_unique, **kw)
-
-    def __enter__(self):
-        return self
-
-    def __exit__(self, type, value, traceback):
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-04-28 20:36:45
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-05 11:58:25
+@FilePath     : /xnote/xutils/sqldb/table_manager.py
+@Description  : SQL表结构管理
+"""
+
+import logging
+import xutils
+import web.db
+from .table_config import TableConfig
+
+empty_db = web.db.DB(None, {})
+
+class ColumnInfo:
+
+    def __init__(self):
+        self.name = ""
+        self.type = ""
+
+class BaseTableManager:
+    """检查数据库字段，如果不存在就自动创建"""
+
+    def __init__(self, tablename, db = empty_db, **kw):
+        self.tablename = tablename
+        self.kw = kw
+        self.debug = kw.pop("debug", False)
+        self.connect()
+        self.db = db
+        self.mysql_database = kw.get("mysql_database", "")
+        self.pk_name = kw.get("pk_name", "id")
+        self.pk_type = kw.get("pk_type", "int")
+        self.pk_len = kw.get("pk_len", 0)
+        self.pk_comment = kw.get("pk_comment", "主键")
+        # 目前只支持这两种主键
+        assert self.pk_type in ("int", "blob")
+
+    def __enter__(self):
+        return self
+
+    def __exit__(self, type, value, traceback):
+        self.close()
+
+    def create_table(self):
+        if self.db.dbname == "sqlite":
+            pass
+
+    def connect(self):
+        pass
+
+    def execute(self, sql):
+        pass
+
+    def escape(self, strval):
+        strval = strval.replace("'", "''")
+        return "'%s'" % strval
+    
+    def desc_columns(self):
+        demo = ColumnInfo()
+        demo.name = "demo"
+        demo.type = "text"
+        return [demo]
+
+    def add_column(self, colname, coltype,
+                   default_value=None, not_null=True, **kw):
+        """添加字段，如果已经存在则跳过，名称相同类型不同抛出异常"""
+        sql = f"ALTER TABLE `{self.tablename}` ADD COLUMN `{colname}` {coltype}"
+        columns = self.desc_columns()
+        for column in columns:
+            name = column.name
+            type = column.type
+            if name == colname:
+                # 已经存在
+                return
+        
+        if default_value != None:
+            if isinstance(default_value, str):
+                default_value = self.escape(default_value)
+            sql += " DEFAULT %s" % default_value
+        if not_null:
+            sql += " NOT NULL"
+        self.execute(sql)
+
+    def add_index(self, colname, is_unique=False, **kw):
+        raise Exception("not implemented")
+
+    def drop_index(self, col_name, is_unique=False):
+        sql = "DROP INDEX idx_%s_%s" % (self.tablename, col_name)
+        try:
+            self.execute(sql)
+        except Exception:
+            xutils.print_exc()
+
+    def drop_column(self, colname):
+        sql = "ALTER TABLE `%s` DROP COLUMN `%s`" % (self.tablename, colname)
+        self.execute(sql)
+
+    def close(self):
+        pass
+
+    
+    def quote_col(self, colname=""):
+        if "`" in colname:
+            return colname
+        return "`%s`" % colname
+
+class MySQLTableManager(BaseTableManager):
+    # TODO 待实现测试
+
+    def connect(self):
+        pass
+
+    def create_table(self):
+        table_name = self.tablename
+        pk_name = self.pk_name
+        pk_len = self.pk_len
+        pk_comment = self.pk_comment
+        if self.pk_type == "blob":
+            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
+                `{pk_name}` blob not null comment '{pk_comment}',
+                PRIMARY KEY (`{pk_name}`({pk_len}))
+            )"""
+        else:
+            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
+                `{pk_name}` bigint unsigned not null auto_increment,
+                PRIMARY KEY (`{pk_name}`)
+            ) CHARACTER SET utf8mb4;"""
+        self.db.query(sql)
+
+    
+    def desc_columns(self):
+        sql = "DESC `%s`" % self.tablename
+        columns = list(self.db.query(sql))
+        if self.debug:
+            print("desc %s, columns=%s" % (self.tablename, columns))
+        result = []
+        for col in columns:
+            item = ColumnInfo()
+            item.type = col["Type"]
+            item.name = col["Field"]
+            result.append(item)
+        return result
+    
+    def execute(self, sql):
+        return self.db.query(sql)
+    
+    def add_column(self, colname, coltype,
+                   default_value=None, not_null=True, **kw):
+        if coltype == "text":
+            # MySQL5.7不支持默认值
+            default_value = None
+        super().add_column(colname, coltype, default_value, not_null)
+    
+    def add_index(self, colname, is_unique=False, key_len=0, key_len_list=[], **kw):
+        """MySQL版创建索引"""
+        index_name = ""
+        colname_str = ""
+
+        index_prefix = "idx"
+        if is_unique:
+            index_prefix = "uk"
+
+        if isinstance(colname, list):
+            index_name = index_prefix
+            for name in colname:
+                index_name += "_" + name
+            temp_col_list = []
+            for index, name in enumerate(colname):
+                if index < len(key_len_list):
+                    key_len = key_len_list[index]
+                else:
+                    key_len = 0
+                if key_len > 0:
+                    tmp_col_name = self.quote_col(name) + "(%d)" % key_len
+                else:
+                    tmp_col_name = self.quote_col(name)
+                temp_col_list.append(tmp_col_name)
+            colname_str = ",".join(temp_col_list)
+        else:
+            index_name = index_prefix + "_" + colname
+            colname_str = self.quote_col(colname)
+            if key_len > 0:
+                colname_str += "(%d)" % key_len
+
+        if is_unique:
+            sql = "ALTER TABLE `%s` ADD UNIQUE `%s` (%s)" % (
+                    self.tablename, index_name, colname_str)
+        else:
+            sql = "ALTER TABLE `%s` ADD INDEX `%s` (%s)" % (
+                    self.tablename, index_name, colname_str)
+
+        if self.is_index_exists(index_name):
+            logging.info("index %s already exists", index_name)
+            return
+        
+        logging.info("%s", sql)
+        if not TableConfig.enable_auto_ddl:
+            raise Exception("db_auto_ddl is disabled")
+        self.execute(sql)
+        
+    
+    def is_index_exists(self, index_name=""):
+        assert len(self.mysql_database) > 0
+        sql = "SELECT COUNT(*) as amount FROM information_schema.statistics WHERE table_schema=$database AND table_name = $table_name AND index_name = $index_name"
+        first = self.db.query(sql, vars=dict(database=self.mysql_database, table_name=self.tablename, index_name=index_name)).first()
+        return first.amount > 0
+    
+
+class SqliteTableManager(BaseTableManager):
+
+    def connect(self):
+        pass
+
+    def create_table(self):
+        table_name = self.tablename
+        pk_name = self.pk_name
+
+        if self.pk_type == "blob":
+            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}` (
+                {pk_name} blob primary key
+            );"""
+        else:
+            sql = f"""CREATE TABLE IF NOT EXISTS `{table_name}`(
+                {pk_name} integer primary key autoincrement
+            );"""
+        self.execute(sql)
+
+    def execute(self, sql):
+        try:
+            if self.debug:
+                logging.debug(sql)
+            return self.db.query(sql)
+        except Exception as e:
+            raise e
+
+    def close(self):
+        pass
+
+    def generate_migrate_sql(self, dropped_names):
+        """生成迁移字段的SQL（本质上是迁移）"""
+        columns = self.execute("pragma table_info('%s')" % self.tablename)
+        new_names = []
+        old_names = []
+        for column in columns:
+            name = column["name"]
+            type = column["type"]
+            old_names.append(name)
+            if name not in dropped_names:
+                new_names.append(name)
+        # step1 = "ALTER TABLE %s RENAME TO backup_table;" % (self.tablename)
+        step2 = "INSERT INTO %s (%s) \nSELECT %s FROM backup_table;" % (
+                self.tablename,
+                ",".join(new_names),
+                ",".join(old_names)
+        )
+        return step2
+    
+    def add_column(self, colname, coltype,
+                   default_value=None, not_null=True, **kw):
+        if coltype == "text" and default_value == None:
+            default_value = ""
+        super().add_column(colname, coltype, default_value, not_null)
+
+    def drop_column(self, colname):
+        # sqlite不支持 DROP COLUMN 得使用中间表
+        pass
+
+    def desc_columns(self):
+        columns = self.execute("pragma table_info('%s')" %
+                        self.tablename)
+        result = []
+        for col in columns:
+            item = ColumnInfo()
+            item.type = col["type"]
+            item.name = col["name"]
+            result.append(item)
+        return result
+
+    def add_index(self, colname, is_unique=False, **kw):
+        # sqlite的索引和table是一个级别的schema
+        index_prefix = "idx_"
+        if is_unique:
+            index_prefix = "uk_"
+
+        colname_str = colname
+        
+        if isinstance(colname, list):
+            idx_name = index_prefix + self.tablename + "_" + "_".join(colname)
+            colname_str = ",".join(colname)
+        else:
+            idx_name = index_prefix + self.tablename + "_" + colname
+                            
+        if is_unique:
+            sql = "CREATE UNIQUE INDEX IF NOT EXISTS %s ON `%s` (%s)" % (
+                idx_name, self.tablename, colname_str)
+        else:
+            sql = "CREATE INDEX IF NOT EXISTS %s ON `%s` (%s)" % (
+                idx_name, self.tablename, colname_str)
+            
+        self.execute(sql)
+
+class TableInfo:
+
+    def __init__(self, tablename = ""):
+        self.tablename = tablename
+        self.pk_name = "id"
+        self.db_type = "" # 数据库类型, 比如 mysql/sqlite
+        self.comment = "" # 表的描述
+        self.column_names = []
+        self.columns = []
+        self.indexes = []
+        self.dbpath = "" # sqlite文件路径
+        self.enable_binlog = True
+        self.log_profile = True
+        self.is_deleted = False
+    
+    def add_column(self, colname, *args, **kw):
+        self.column_names.append(colname)
+        self.columns.append([(colname, ) + args, kw])
+    
+    def add_index(self, *args, **kw):
+        self.indexes.append([args, kw])
+
+class TableManagerFacade:
+
+    table_dict = {}
+
+    @classmethod
+    def clear_table_dict(cls):
+        cls.table_dict = {}
+    
+    @classmethod
+    def get_table_info(cls, tablename=""):
+        # type: (str) -> TableInfo|None
+        return cls.table_dict.get(tablename)
+    
+    @classmethod
+    def get_table_info_dict(cls):
+        # type: () -> dict[str, TableInfo]
+        return cls.table_dict
+
+    def __init__(self, tablename, db = empty_db, is_backup = False, **kw):
+        self.table_info = TableInfo(tablename)
+        self.table_info.pk_name = kw.get("pk_name", "id")
+        self.table_info.db_type = kw.get("db_type", "")
+        if db.dbname == "mysql":
+            self.manager = MySQLTableManager(tablename, db = db, **kw)
+        else:
+            self.manager = SqliteTableManager(tablename, db = db, **kw)
+            self.table_info.dbpath = db.dbpath
+        
+        self.table_info.is_deleted = kw.get("is_deleted", False)
+        self.table_info.comment = kw.get("comment", "")
+
+        self.manager.create_table()
+
+        check_table_define = kw.get("check_table_define", True)
+        if not is_backup and check_table_define:
+            if tablename in self.table_dict:
+                raise Exception("table already defined: %s" % tablename)
+        
+        if not is_backup:
+            self.table_dict[tablename] = self.table_info
+    
+    def add_column(self, colname, coltype,
+                   default_value=None, not_null=True, comment=""):
+        coltype_lower = coltype.lower()
+
+        if "varchar" in coltype_lower:
+            assert default_value != None, f"varchar column {colname} default value cant be NULL"
+        if coltype_lower in ("int", "tinyint", "bigint"):
+            assert default_value != None, f"{coltype} column {colname} default value cant be NULL"
+        
+        self.table_info.add_column(colname, coltype, default_value, not_null)
+        self.manager.add_column(colname, coltype, default_value, not_null, comment=comment)
+    
+    def drop_column(self, colname, coltype,
+                   default_value=None, not_null=True):
+        pass
+
+    def add_index(self, colname, is_unique=False, **kw):
+        self.table_info.add_index(colname, is_unique)
+        self.manager.add_index(colname, is_unique, **kw)
+
+    def __enter__(self):
+        return self
+
+    def __exit__(self, type, value, traceback):
         self.manager.close()
```

### Comparing `xnote-web-0.1.0/xutils/sqldb/table_proxy.py` & `xnote-web-0.1.1/xutils/sqldb/table_proxy.py`

 * *Ordering differences only*

 * *Files 14% similar despite different names*

```diff
@@ -1,293 +1,293 @@
-# -*- coding:utf-8 -*-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2023-04-28 21:09:40
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-05 12:47:10
-@FilePath     : /xnote/xutils/sqldb/table_proxy.py
-@Description  : SQL表查询代理
-"""
-import time
-import xutils
-import web.db
-from web.db import SQLQuery, sqlparam
-from . import table_manager
-from .table_config import TableConfig
-from xutils.interfaces import ProfileLog, ProfileLogger, SQLDBInterface
-from xutils.db.binlog import BinLog, BinLogOpType
-
-
-
-class TableProxy(SQLDBInterface):
-    """基于web.db的装饰器
-    SqliteDB是全局唯一的, 它的底层使用了连接池技术, 每个线程都有独立的sqlite连接
-    """
-    log_profile = False
-    enable_binlog = False
-    writable = True
-    profile_logger = ProfileLogger()
-
-    def __init__(self, db, tablename):
-        self.tablename = tablename
-        self.table_name = tablename
-        # SqliteDB 内部使用了threadlocal来实现，是线程安全的，使用全局单实例即可
-        assert isinstance(db, web.db.DB)
-        self.db = db
-        table_info = table_manager.TableManagerFacade.get_table_info(tablename)
-        assert table_info != None
-        self.table_info = table_info
-        self.enable_binlog = TableConfig.enable_binlog and table_info.enable_binlog
-
-    def fix_sql_keywords(self, values):
-        # 兼容关键字
-        if isinstance(values, dict):
-            new_result = {}
-            for key in values:
-                value = values[key]
-                if "`" not in key:
-                    new_result[f"`{key}`"] = value
-                else:
-                    new_result[key] = value
-            return new_result
-        return values
-    
-    def handle_result_set(self, result_set):
-        # TODO 转换类型用于序列化
-        result = []
-        for item in result_set:
-            # for attr in item:
-            #     value = item.get(attr)
-            result.append(item)
-        return result
-    
-    def check_write_state(self):
-        if not self.writable:
-            raise Exception("当前状态不能写入")
-
-    def insert(self, seqname=None, _test=False, **values):
-        self.check_write_state()
-        values = self.fix_sql_keywords(values)
-        start_time = time.time()
-        try:
-            new_id = self.db.insert(self.tablename, seqname, _test, **values)
-            self.add_insert_binlog(new_id, _test=_test)
-            return new_id
-        except Exception as e:
-            del self.db.ctx.db # 尝试重新连接
-            raise e
-        finally:
-            cost_time = time.time() - start_time
-            self.add_profile_log(cost_time, "insert")
-        
-    def select(self, vars=None, what='*', where=None, order=None, group=None,
-               limit=None, offset=None, _test=False):
-        where = self.fix_sql_keywords(where)
-        result_set = self.db.select(self.tablename, vars=vars, what=what, where=where, order=order, group=group,
-                              limit=limit, offset=offset, _test=_test)
-        records = list(result_set)
-        return records
-    
-    def select_first(self, *args, **kw):
-        records = self.select(*args, **kw)
-        if len(records) > 0:
-            return records[0]
-        return None
-
-    def query(self, *args, **kw):
-        return list(self.db.query(*args, **kw))
-    
-    def raw_query(self, *args, **kw):
-        return self.db.query(*args, **kw)
-
-    def count(self, where=None, sql=None, vars=None):
-        where = self.fix_sql_keywords(where)
-        if sql is None:
-            return self.select_first(what="COUNT(1) AS amount", where=where, vars=vars).amount
-        return self.db.query(sql, vars=vars).first().amount
-
-    def update(self, where, vars=None, _test=False, _skip_binlog=False, _skip_profile=False, **values):
-        self.check_write_state()
-        where = self.fix_sql_keywords(where)
-        values = self.fix_sql_keywords(values)
-        
-        start_time = time.time()
-        try:
-            result = self.db.update(self.tablename, where, vars=vars, _test=_test, **values)
-            if not _skip_binlog:
-                self.add_update_binlog(where=where, vars=vars, _test=_test)
-            return result
-        except Exception as e:
-            del self.db.ctx.db # 尝试重新连接
-            raise e
-        finally:
-            cost_time = time.time() - start_time
-            self.add_profile_log(cost_time, "update", _skip_profile=_skip_profile)
-
-    def delete(self,  where, using=None, vars=None, _test=False):
-        self.check_write_state()
-        if _test:
-            # delete为了记录binlog会转换成按照主键删除的sql, 所以这里单独处理下_test场景
-            return self.db.delete(self.tablename, where, using=using, vars=vars, _test=True)
-        
-        where = self.fix_sql_keywords(where)
-
-        start_time = time.time()
-        pk_name = self.table_info.pk_name
-        pk_list = []
-        
-        try:
-            for row in self.select(what=pk_name, where=where, vars=vars, _test=_test):
-                pk_value = row.get(pk_name)
-                pk_list.append(pk_value)
-            
-            if len(pk_list) > 0:
-                new_where = f"`{pk_name}` in $pk_list"
-                new_vars = dict(pk_list=pk_list)
-                result = self.db.delete(self.tablename, where=new_where, using=using, vars=new_vars, _test=_test)
-                self.add_delete_binlog(pk_list)
-                return result
-        except Exception as e:
-            del self.db.ctx.db # 尝试重新连接
-            raise e
-        finally:
-            cost_time = time.time() - start_time
-            self.add_profile_log(cost_time, "delete")
-    
-    def transaction(self):
-        return self.db.transaction()
-    
-    def iter(self):
-        for records in self.iter_batch():
-            for record in records:
-                yield record
-
-
-    def iter_batch(self, batch_size=20, where="", vars=None):
-        assert isinstance(where, str)
-        
-        last_id = 0
-        while True:
-            this_vars = dict(last_id = last_id)
-            if vars != None:
-                this_vars.update(vars)
-            records = self.select(where = "id > $last_id " + where, vars = this_vars, limit = batch_size, order="id")
-            if len(records) == 0:
-                break
-            yield records
-            last_id = records[-1].id
-    
-    def get_table_info(self):
-        return self.table_info
-
-    def filter_record(self, record):
-        # type: (dict) -> dict
-        result = {}
-        table_info = self.get_table_info()
-        for colname in table_info.column_names:
-            col_value = record.get(colname)
-            if col_value != None:
-                result[colname] = col_value
-        
-        pk_name = table_info.pk_name
-        result[pk_name] = record.get(pk_name)
-        return result
-
-    def add_row_binlog(self, row):
-        if not self.enable_binlog:
-            return
-        if row == None:
-            return
-        
-        if self.table_name in TableConfig._disable_binlog_tables:
-            return
-        
-        pk_name = self.table_info.pk_name
-        pk_value = row.get(pk_name)
-
-        BinLog.get_instance().add_log(BinLogOpType.sql_upsert, pk_value, table_name=self.tablename)
-
-    def add_insert_binlog(self, new_id, _test=False):
-        if _test:
-            return
-        if not self.enable_binlog:
-            return
-        
-        if self.table_name in TableConfig._disable_binlog_tables:
-            return
-        
-        pk_name = self.table_info.pk_name
-        where = {
-            pk_name: new_id
-        }
-        row = self.select_first(where=where)
-        self.add_row_binlog(row)
-
-    def add_update_binlog(self, where=None, vars=None, _test=False):
-        if _test:
-            return
-        if not self.enable_binlog:
-            return
-        if self.table_name in TableConfig._disable_binlog_tables:
-            return
-                
-        for row in self.select(where=where, vars=vars):
-            self.add_row_binlog(row)
-
-    def add_delete_binlog(self, pk_list=[]):
-        if not self.enable_binlog:
-            return
-
-        if self.table_name in TableConfig._disable_binlog_tables:
-            return
-        
-        for pk_value in pk_list:
-            BinLog.get_instance().add_log(BinLogOpType.sql_delete, pk_value, table_name=self.tablename)
-        
-
-    def get_column_names(self):
-        return self.table_info.column_names
-
-
-    def replace_values(self, seqname=None, _test=False, **values):
-        """XXX: 测试中
-        执行replace操作
-        """
-        assert len(values)>0
-        tablename = self.table_name
-        def q(x):
-            return "(" + x + ")"
-        
-        sorted_values = sorted(values.items(), key=lambda t: t[0])
-
-        _keys = SQLQuery.join(map(lambda t: t[0], sorted_values), ", ")
-        _values = SQLQuery.join(
-            [sqlparam(v) for v in map(lambda t: t[1], sorted_values)], ", "
-        )
-        sql_query = (
-            "REPLACE INTO %s " % tablename + q(_keys) + " VALUES " + q(_values)
-        )
-
-        return self.query(sql_query)
-
-    def _new_profile_log(self):
-        log = ProfileLog()
-        log.ctime = xutils.format_datetime()
-        log.table_name = self.tablename
-        log.type = "db_profile"
-        return log
-    
-    def add_profile_log(self, cost_time=0.0, op_type="", _skip_profile=False):
-        if _skip_profile:
-            return
-        if not self.log_profile:
-            return
-        if not self.table_info.log_profile:
-            return
-        if self.table_name in TableConfig._disable_profile_tables:
-            return
-        
-        profile_log = self._new_profile_log()
-        profile_log.cost_time = cost_time
-        profile_log.op_type = op_type
-        self.profile_logger.log(profile_log)
+# -*- coding:utf-8 -*-
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2023-04-28 21:09:40
+@LastEditors  : xupingmao
+@LastEditTime : 2024-04-05 12:47:10
+@FilePath     : /xnote/xutils/sqldb/table_proxy.py
+@Description  : SQL表查询代理
+"""
+import time
+import xutils
+import web.db
+from web.db import SQLQuery, sqlparam
+from . import table_manager
+from .table_config import TableConfig
+from xutils.interfaces import ProfileLog, ProfileLogger, SQLDBInterface
+from xutils.db.binlog import BinLog, BinLogOpType
+
+
+
+class TableProxy(SQLDBInterface):
+    """基于web.db的装饰器
+    SqliteDB是全局唯一的, 它的底层使用了连接池技术, 每个线程都有独立的sqlite连接
+    """
+    log_profile = False
+    enable_binlog = False
+    writable = True
+    profile_logger = ProfileLogger()
+
+    def __init__(self, db, tablename):
+        self.tablename = tablename
+        self.table_name = tablename
+        # SqliteDB 内部使用了threadlocal来实现，是线程安全的，使用全局单实例即可
+        assert isinstance(db, web.db.DB)
+        self.db = db
+        table_info = table_manager.TableManagerFacade.get_table_info(tablename)
+        assert table_info != None
+        self.table_info = table_info
+        self.enable_binlog = TableConfig.enable_binlog and table_info.enable_binlog
+
+    def fix_sql_keywords(self, values):
+        # 兼容关键字
+        if isinstance(values, dict):
+            new_result = {}
+            for key in values:
+                value = values[key]
+                if "`" not in key:
+                    new_result[f"`{key}`"] = value
+                else:
+                    new_result[key] = value
+            return new_result
+        return values
+    
+    def handle_result_set(self, result_set):
+        # TODO 转换类型用于序列化
+        result = []
+        for item in result_set:
+            # for attr in item:
+            #     value = item.get(attr)
+            result.append(item)
+        return result
+    
+    def check_write_state(self):
+        if not self.writable:
+            raise Exception("当前状态不能写入")
+
+    def insert(self, seqname=None, _test=False, **values):
+        self.check_write_state()
+        values = self.fix_sql_keywords(values)
+        start_time = time.time()
+        try:
+            new_id = self.db.insert(self.tablename, seqname, _test, **values)
+            self.add_insert_binlog(new_id, _test=_test)
+            return new_id
+        except Exception as e:
+            del self.db.ctx.db # 尝试重新连接
+            raise e
+        finally:
+            cost_time = time.time() - start_time
+            self.add_profile_log(cost_time, "insert")
+        
+    def select(self, vars=None, what='*', where=None, order=None, group=None,
+               limit=None, offset=None, _test=False):
+        where = self.fix_sql_keywords(where)
+        result_set = self.db.select(self.tablename, vars=vars, what=what, where=where, order=order, group=group,
+                              limit=limit, offset=offset, _test=_test)
+        records = list(result_set)
+        return records
+    
+    def select_first(self, *args, **kw):
+        records = self.select(*args, **kw)
+        if len(records) > 0:
+            return records[0]
+        return None
+
+    def query(self, *args, **kw):
+        return list(self.db.query(*args, **kw))
+    
+    def raw_query(self, *args, **kw):
+        return self.db.query(*args, **kw)
+
+    def count(self, where=None, sql=None, vars=None):
+        where = self.fix_sql_keywords(where)
+        if sql is None:
+            return self.select_first(what="COUNT(1) AS amount", where=where, vars=vars).amount
+        return self.db.query(sql, vars=vars).first().amount
+
+    def update(self, where, vars=None, _test=False, _skip_binlog=False, _skip_profile=False, **values):
+        self.check_write_state()
+        where = self.fix_sql_keywords(where)
+        values = self.fix_sql_keywords(values)
+        
+        start_time = time.time()
+        try:
+            result = self.db.update(self.tablename, where, vars=vars, _test=_test, **values)
+            if not _skip_binlog:
+                self.add_update_binlog(where=where, vars=vars, _test=_test)
+            return result
+        except Exception as e:
+            del self.db.ctx.db # 尝试重新连接
+            raise e
+        finally:
+            cost_time = time.time() - start_time
+            self.add_profile_log(cost_time, "update", _skip_profile=_skip_profile)
+
+    def delete(self,  where, using=None, vars=None, _test=False):
+        self.check_write_state()
+        if _test:
+            # delete为了记录binlog会转换成按照主键删除的sql, 所以这里单独处理下_test场景
+            return self.db.delete(self.tablename, where, using=using, vars=vars, _test=True)
+        
+        where = self.fix_sql_keywords(where)
+
+        start_time = time.time()
+        pk_name = self.table_info.pk_name
+        pk_list = []
+        
+        try:
+            for row in self.select(what=pk_name, where=where, vars=vars, _test=_test):
+                pk_value = row.get(pk_name)
+                pk_list.append(pk_value)
+            
+            if len(pk_list) > 0:
+                new_where = f"`{pk_name}` in $pk_list"
+                new_vars = dict(pk_list=pk_list)
+                result = self.db.delete(self.tablename, where=new_where, using=using, vars=new_vars, _test=_test)
+                self.add_delete_binlog(pk_list)
+                return result
+        except Exception as e:
+            del self.db.ctx.db # 尝试重新连接
+            raise e
+        finally:
+            cost_time = time.time() - start_time
+            self.add_profile_log(cost_time, "delete")
+    
+    def transaction(self):
+        return self.db.transaction()
+    
+    def iter(self):
+        for records in self.iter_batch():
+            for record in records:
+                yield record
+
+
+    def iter_batch(self, batch_size=20, where="", vars=None):
+        assert isinstance(where, str)
+        
+        last_id = 0
+        while True:
+            this_vars = dict(last_id = last_id)
+            if vars != None:
+                this_vars.update(vars)
+            records = self.select(where = "id > $last_id " + where, vars = this_vars, limit = batch_size, order="id")
+            if len(records) == 0:
+                break
+            yield records
+            last_id = records[-1].id
+    
+    def get_table_info(self):
+        return self.table_info
+
+    def filter_record(self, record):
+        # type: (dict) -> dict
+        result = {}
+        table_info = self.get_table_info()
+        for colname in table_info.column_names:
+            col_value = record.get(colname)
+            if col_value != None:
+                result[colname] = col_value
+        
+        pk_name = table_info.pk_name
+        result[pk_name] = record.get(pk_name)
+        return result
+
+    def add_row_binlog(self, row):
+        if not self.enable_binlog:
+            return
+        if row == None:
+            return
+        
+        if self.table_name in TableConfig._disable_binlog_tables:
+            return
+        
+        pk_name = self.table_info.pk_name
+        pk_value = row.get(pk_name)
+
+        BinLog.get_instance().add_log(BinLogOpType.sql_upsert, pk_value, table_name=self.tablename)
+
+    def add_insert_binlog(self, new_id, _test=False):
+        if _test:
+            return
+        if not self.enable_binlog:
+            return
+        
+        if self.table_name in TableConfig._disable_binlog_tables:
+            return
+        
+        pk_name = self.table_info.pk_name
+        where = {
+            pk_name: new_id
+        }
+        row = self.select_first(where=where)
+        self.add_row_binlog(row)
+
+    def add_update_binlog(self, where=None, vars=None, _test=False):
+        if _test:
+            return
+        if not self.enable_binlog:
+            return
+        if self.table_name in TableConfig._disable_binlog_tables:
+            return
+                
+        for row in self.select(where=where, vars=vars):
+            self.add_row_binlog(row)
+
+    def add_delete_binlog(self, pk_list=[]):
+        if not self.enable_binlog:
+            return
+
+        if self.table_name in TableConfig._disable_binlog_tables:
+            return
+        
+        for pk_value in pk_list:
+            BinLog.get_instance().add_log(BinLogOpType.sql_delete, pk_value, table_name=self.tablename)
+        
+
+    def get_column_names(self):
+        return self.table_info.column_names
+
+
+    def replace_values(self, seqname=None, _test=False, **values):
+        """XXX: 测试中
+        执行replace操作
+        """
+        assert len(values)>0
+        tablename = self.table_name
+        def q(x):
+            return "(" + x + ")"
+        
+        sorted_values = sorted(values.items(), key=lambda t: t[0])
+
+        _keys = SQLQuery.join(map(lambda t: t[0], sorted_values), ", ")
+        _values = SQLQuery.join(
+            [sqlparam(v) for v in map(lambda t: t[1], sorted_values)], ", "
+        )
+        sql_query = (
+            "REPLACE INTO %s " % tablename + q(_keys) + " VALUES " + q(_values)
+        )
+
+        return self.query(sql_query)
+
+    def _new_profile_log(self):
+        log = ProfileLog()
+        log.ctime = xutils.format_datetime()
+        log.table_name = self.tablename
+        log.type = "db_profile"
+        return log
+    
+    def add_profile_log(self, cost_time=0.0, op_type="", _skip_profile=False):
+        if _skip_profile:
+            return
+        if not self.log_profile:
+            return
+        if not self.table_info.log_profile:
+            return
+        if self.table_name in TableConfig._disable_profile_tables:
+            return
+        
+        profile_log = self._new_profile_log()
+        profile_log.cost_time = cost_time
+        profile_log.op_type = op_type
+        self.profile_logger.log(profile_log)
```

### Comparing `xnote-web-0.1.0/xutils/text_parser.py` & `xnote-web-0.1.1/xutils/text_parser.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 # -*- coding:utf-8 -*-
 """
 @Author       : xupingmao
 @email        : 578749341@qq.com
 @Date         : 2021-01-10 14:36:09
 @LastEditors  : xupingmao
-@LastEditTime : 2024-05-03 12:05:40
+@LastEditTime : 2024-05-03 12:48:22
 @FilePath     : /xnote/xutils/text_parser.py
 @Description  : 描述
 """
 
 """标记文本解析
 
 类
@@ -18,15 +18,17 @@
 函数
 - HTML转义            escape_html(text:str)
 
 """
 import os
 from urllib.parse import quote, unquote
 
-IMG_EXT_SET = set([".png", ".jpg", ".gif"])
+
+class TextParserConfig:
+    img_ext_set = set([".png", ".jpg", ".gif"])
 
 def invoke_deco(prefix = ""):
     """日志装饰器"""
     def deco(func):
         def handle(*args, **kw):
             try:
                 result = func(*args, **kw)
@@ -39,19 +41,18 @@
     return deco
 
 def is_img_file(filename):
     """根据文件后缀判断是否是图片"""
     from xutils import fsutil
     realname = fsutil.decode_name(filename)
     name, ext = os.path.splitext(realname)
-    return ext.lower() in IMG_EXT_SET
+    return ext.lower() in TextParserConfig.img_ext_set
 
 def set_img_file_ext(img_set):
-    global IMG_EXT_SET
-    IMG_EXT_SET = img_set
+    TextParserConfig.img_ext_set = img_set
 
 def escape_html(text):
     # 必须先处理&
     text = text.replace("&", "&amp;")
     text = text.replace("<", "&lt;")
     text = text.replace(">", "&gt;")
     text = text.replace('"', "&quot;")
```

### Comparing `xnote-web-0.1.0/xutils/text_parser_properties.py` & `xnote-web-0.1.1/xutils/text_parser_properties.py`

 * *Ordering differences only*

 * *Files 27% similar despite different names*

```diff
@@ -1,107 +1,107 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2021/05/05 11:05:29
-# @modified 2022/03/06 11:35:51
-# @filename text_parser_properties.py
-
-
-"""properties文件解析
-
-方法列表
-========
-parse_prop_text_to_pairs(text: str) -> list
-    * 解析properties文件成元组对
-
-parse_prop_text_to_dict(text: str) -> dict
-    * 解析properties文件成字典
-
-parse_prop_text(text:str, ret_type="dict") -> {dict|list}
-    * 解析properties文件
-"""
-
-class PropertyFile:
-    """property文件
-    TODO: 待实现
-    """
-
-    def load(self, file):
-        pass
-
-    def get_str(self, key="", default_value=""):
-        return default_value
-    
-    def get_int(self, key="", default_value=0):
-        return default_value
-    
-    def get_float(self, key="", default_value=0.0):
-        return default_value
-    
-    def get_list(self, key="", default_value=[]):
-        return default_value
-    
-    def get_dict(self, key="", default_value={}):
-        """
-        >>> p = PropertFile()
-        >>> p.load("a.name=test\na.age=20")
-        >>> p.get_dict("a")
-        {"name":"test","age":20}
-        """
-        return default_value
-
-def parse_prop_text_to_pairs(text: str) -> list:
-    """解析key/value格式的配置文本
-    @param {string} text 配置文本内容
-    @param {string} ret_type 返回的格式，包含list, dict
-    """
-    config = []
-
-    if text == None or text == "":
-        return config
-
-    for line in text.split("\n"):
-        line = line.strip()
-        if line == "":
-            continue
-
-        if line.startswith("#"):
-            continue
-
-        key = None
-        value = None
-        
-        # 参考Java的Properties文件处理
-        # 分隔符 `:` 和 `=`
-        # 转义符 \
-        # 转义内容 `\t` `\n` `\r` `\f` `\u1111` 
-        for i, c in enumerate(line):
-            if c == ":" or c == "=":
-                key = line[:i]
-                value = line[i+1:]
-                value = value.split("#", 1)[0]
-                break
-
-        if key is None or value is None:
-            continue
-
-        key = key.strip()
-        value = value.strip()
-
-        config.append(dict(key=key, value=value))
-
-    return config
-
-def parse_prop_text(text, ret_type = "dict"):
-    assert ret_type in ("dict", "list")
-    pairs = parse_prop_text_to_pairs(text)
-    if ret_type == "dict":
-        return parse_prop_text_to_dict(text)
-    return pairs
-
-def parse_prop_text_to_dict(text):
-    pairs = parse_prop_text_to_pairs(text)
-    result = dict()
-    for item in pairs:
-        key = item.get("key")
-        value = item.get("value")
-        result[key] = value
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2021/05/05 11:05:29
+# @modified 2022/03/06 11:35:51
+# @filename text_parser_properties.py
+
+
+"""properties文件解析
+
+方法列表
+========
+parse_prop_text_to_pairs(text: str) -> list
+    * 解析properties文件成元组对
+
+parse_prop_text_to_dict(text: str) -> dict
+    * 解析properties文件成字典
+
+parse_prop_text(text:str, ret_type="dict") -> {dict|list}
+    * 解析properties文件
+"""
+
+class PropertyFile:
+    """property文件
+    TODO: 待实现
+    """
+
+    def load(self, file):
+        pass
+
+    def get_str(self, key="", default_value=""):
+        return default_value
+    
+    def get_int(self, key="", default_value=0):
+        return default_value
+    
+    def get_float(self, key="", default_value=0.0):
+        return default_value
+    
+    def get_list(self, key="", default_value=[]):
+        return default_value
+    
+    def get_dict(self, key="", default_value={}):
+        """
+        >>> p = PropertFile()
+        >>> p.load("a.name=test\na.age=20")
+        >>> p.get_dict("a")
+        {"name":"test","age":20}
+        """
+        return default_value
+
+def parse_prop_text_to_pairs(text: str) -> list:
+    """解析key/value格式的配置文本
+    @param {string} text 配置文本内容
+    @param {string} ret_type 返回的格式，包含list, dict
+    """
+    config = []
+
+    if text == None or text == "":
+        return config
+
+    for line in text.split("\n"):
+        line = line.strip()
+        if line == "":
+            continue
+
+        if line.startswith("#"):
+            continue
+
+        key = None
+        value = None
+        
+        # 参考Java的Properties文件处理
+        # 分隔符 `:` 和 `=`
+        # 转义符 \
+        # 转义内容 `\t` `\n` `\r` `\f` `\u1111` 
+        for i, c in enumerate(line):
+            if c == ":" or c == "=":
+                key = line[:i]
+                value = line[i+1:]
+                value = value.split("#", 1)[0]
+                break
+
+        if key is None or value is None:
+            continue
+
+        key = key.strip()
+        value = value.strip()
+
+        config.append(dict(key=key, value=value))
+
+    return config
+
+def parse_prop_text(text, ret_type = "dict"):
+    assert ret_type in ("dict", "list")
+    pairs = parse_prop_text_to_pairs(text)
+    if ret_type == "dict":
+        return parse_prop_text_to_dict(text)
+    return pairs
+
+def parse_prop_text_to_dict(text):
+    pairs = parse_prop_text_to_pairs(text)
+    result = dict()
+    for item in pairs:
+        key = item.get("key")
+        value = item.get("value")
+        result[key] = value
     return result
```

### Comparing `xnote-web-0.1.0/xutils/textutil.py` & `xnote-web-0.1.1/xutils/textutil.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,832 +1,833 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao
-# @since 2017/?/?
-# @modified 2022/04/16 18:18:24
-
-"""
-@Author       : xupingmao
-@email        : 578749341@qq.com
-@Date         : 2022-04-17 17:04:15
-@LastEditors  : xupingmao
-@LastEditTime : 2024-04-04 11:39:23
-@FilePath     : /xnote/xutils/textutil.py
-@Description  : 文本处理工具
-"""
-
-import re
-import random
-import json
-import inspect
-import hashlib
-import base64
-from xutils.imports import is_str, ConfigParser
-from xutils.textutil_url import *
-
-try:
-    from urllib.parse import quote, unquote
-except ImportError:
-    from urllib import quote, unquote
-
-__doc__ = """文本处理函数库
-
-Text Process Library
-"""
-
-ALPHA_NUM = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
-BLANK_CHAR_SET = set(" \n\t\r")
-
-def contains_all(text, words):
-    """
-        >>> contains_all("abc is good", "abc")
-        True
-        >>> contains_all("you are right", "rig")
-        True
-        >>> contains_all("hello,world,yep", ["hello", "yep"])
-        True
-    """
-    if is_str(words):
-        return words in text
-    elif isinstance(words, list):
-        for word in words:
-            if word not in text:
-                return False
-        return True
-    else:
-        raise TypeError("unsupported type:%s" % type(words))
-
-text_contains = contains_all
-
-def contains_any(text, words):
-    if is_str(words):
-        return words in text
-    elif isinstance(words, (list, tuple)):
-        for word in words:
-            if word in text:
-                return True
-        return False
-    else:
-        raise TypeError("unsupported type, words require str, list, tuple")
-
-def count_alpha(text):
-    count = 0
-    for c in text:
-        if _isalpha(c):
-            count += 1
-    return count
-
-def count_digit(text):
-    count = 0
-    for c in text:
-        if _isdigit(c):
-            count += 1
-    return count
-
-def count_end_nl(content):
-    count = 0
-    i = len(content) - 1
-    for i in range(i, -1, -1):
-        c = content[i]
-        if c == '\n':
-            count += 1
-        elif c == '\r':
-            continue
-        else:
-            break
-    return count
-
-def _isalpha(c):
-    return (c >='a' and c <='z') or (c >= 'A' and c <= 'Z')
-
-def _isdigit(c):
-    return (c>='0' and c<='9')
-
-def _isalnum(c):
-    return _isalpha(c) or _isdigit(c)
-
-def _chk_list(text, func):
-    for c in text:
-        if not func(c):
-            return False
-    return True
-
-def isalpha(text):
-    """
-        >>> isalpha('a')
-        True
-        >>> isalpha('abc')
-        True
-        >>> isalpha('12abc')
-        False
-    """
-    return _chk_list(text, _isalpha)
-
-def isalnum(text):
-    """
-        >>> isalnum('123abc')
-        True
-        >>> isalnum('-abc-')
-        False
-    """
-    return _chk_list(text, _isalnum)
-
-def isdigit(text):
-    """
-        >>> isdigit('123')
-        True
-        >>> isdigit('abc111')
-        False
-    """
-    return _chk_list(text, _isdigit)
-
-def isblank(text):
-    for c in text:
-        if c not in BLANK_CHAR_SET:
-            return False
-    return True
-
-def issubsetof(text, collection):
-    pass
-
-def is_cjk(c):
-    """是否是CJK(中日韩统一表意文字)
-    说明来自维基百科 https://zh.wikipedia.org/wiki/CJK
-    @param {char} c 单个字符
-    """
-    code = ord(c)
-    if 0x4E00 <= code and code <= 0x9FFF:
-        # 1993年5月，正式制订最初的中日韩统一表意文字，位于U+4E00–U+9FFF这个区域，共20,902个字。
-        return True
-    if 0x3400 <= code and code <= 0x4DFF:
-        # 1999年，依据ISO/IEC 10646的第17个修正案（Amendment 17）订定扩展区A，于U+3400–U+4DFF加入6,582个字。
-        return True
-    if 0x20000 <= code and code <= 0x2A6FF:
-        # 2001年，依据ISO/IEC 10646-2，新增扩展区B，包含42,711个汉字。位于U+20000–U+2A6FF。
-        return True
-    if 0x9FA6 <= code and code <= 0x0FBB:
-        # 2005年，依据ISO/IEC 10646:2003的第1个修正案（Amendment 1），基本多文种平面增加U+9FA6-U+9FBB，共22个汉字。
-        return True
-    if 0x2A700 <= code and code <= 0x2B734:
-        # 2009年，统一码5.2扩展区C增加U+2A700–U+2B734
-        return True
-    if 0x9FC4 <= code and code <= 0x9FCB:
-        # 2009年，统一码5.2基本多文种平面增加U+9FC4–U+9FCB。
-        return True
-    return False
-
-def is_number(value):
-    try:
-        float(value)
-        return True
-    except:
-        return False
-
-def is_json(value):
-    try:
-        json.loads(value)
-        return True
-    except:
-        return False
-
-"""解析文本的方法
-- split, rsplit, splitlines
-- strip, lstrip, rstrip
-- partition, rpartition
-- ljust, rjust, center
-"""
-
-
-def remove(self, target):
-    """
-        >>> remove("this is a bat", "bat")
-        'this is a '
-    """
-    return self.replace(target, "")
-
-def remove_head(text, head):
-    """移除头部的字符
-        >>> remove_head("person.age", "person.")
-        "age"
-        >>> remove_head("person.age", "test")
-        "person.age"
-    """
-    if text is None or head is None:
-        return text
-
-    if not text.startswith(head):
-        return text
-
-    return text[len(head):]
-
-def remove_tail(text, tail):
-    """移除尾部的字符
-        >>> remove_tail("person.age", ".age")
-        "person"
-        >>> remove_tail("person.age", "name")
-        "person.age"
-    """
-    assert is_str(tail)
-    
-    if text is None:
-        return text
-
-    if not text.endswith(tail):
-        return text
-
-    return text[:-len(tail)]
-
-def between(self, start, end):
-    """Get the text between start end end
-        >>> between("start words end", "start", "end")
-        ' words '
-    """
-    p1 = self.find(start)
-    if p1 < 0:
-        return ""
-    p2 = self.find(end, p1)
-    if p2 < 0:
-        return ""
-    return self[p1+len(start):p2]
-
-def replace_between(self, start, end, target):
-    p1 = self.find(start)
-    if p1 < 0:
-        return None
-    p2 = self.find(end, p1)
-    if p2 < 0:
-        return None
-    return self[:p1 + len(start)] + target + self[p2:]
-
-def after(self, start):
-    """
-        >>> after("this is good", "this")
-        ' is good'
-    """
-    p1 = self.find(start)
-    if p1 >= 0:
-        return self[p1+len(start):]
-
-def split_chars(text):
-    chars = []
-    for c in text:
-        if c.isprintable() and c not in BLANK_CHAR_SET:
-            chars.append(c)
-    return chars
-
-def split_first(text, sep = ' '):
-    """
-        >>> split_first("find a.name b.name")
-        ('find', 'a.name b.name')
-        >>> split_first("find")
-        ('find', '')
-        >>> split_first('find-a.name b.name', '-')
-        ('find', 'a.name b.name')
-    """
-    index = text.find(sep)
-    if index >= 0:
-        return text[:index], text[index+1:]
-    return text, ""
-
-def find(text, key, show_line=False, ignore_case=True):
-    """ find key in text, return a list
-
-        >>> find('hello,world', 'hello')
-        ['hello,world']
-
-        >>> find('hell1,world\\nhello,kid', 'hello', True)
-        ['0002:hello,kid']
-        
-        >>> find("yes", "")
-        []
-    """
-    result = []
-    lineno = 1
-    if key == "":
-        return result
-    if not isinstance(key, list):
-        keys = [key]
-    else:
-        keys = key
-    if ignore_case:
-        for i in range(len(keys)):
-            keys[i] = keys[i].lower()
-    for line in text.split("\n"):
-        if ignore_case:
-            target = line.lower()
-        else:
-            target = line
-        if contains_all(target, keys):
-            if show_line:
-                result.append("%04d:%s" % (lineno, line))
-            else:
-                result.append(line)
-        lineno += 1
-    return result
-
-
-def replace(text, origin, dest, ignore_case = False, use_template = False):
-    """
-        >>> replace('abc is good', 'iS', 'is not', True)
-        'abc is not good'
-        >>> replace("this is a long story", "loNg", "-long-", True)
-        'this is a -long- story'
-        >>> replace("use Template", "template", '<k>?</k>', True, True)
-        'use <k>Template</k>'
-    """
-    if not ignore_case:
-        if use_template:
-            dest = dest.replace("?", origin)
-        return text.replace(origin, dest)
-    else:
-        start      = 0
-        origin     = origin.lower()
-        text_lower = text.lower()
-        new_text   = ""
-        pos        = 0
-        while pos >= 0:
-            pos = text_lower.find(origin, start)
-            if pos >= 0:
-                new_text += text[start:pos]
-                if use_template:
-                    dest = dest.replace("?", text[pos:pos+len(origin)])
-                new_text += dest
-                start = pos+len(origin)
-            else:
-                new_text += text[start:]
-        return new_text
-
-def like(text, pattern):
-    """这个其实就是通配符，参考 fnmatch 模块
-        >>> like("hello,world", "hello*")
-        True
-        >>> like ("yes", "y?s")
-        True
-        >>> like("what", "n*")
-        False
-    """
-
-    # TODO 处理`,`
-    re_pattern = pattern.replace("?", ".?")
-    re_pattern = re_pattern.replace("*", ".*?")
-    m = re.match(re_pattern, text)
-    if m:
-        return True
-    return False
-
-
-def byte2str(buf):
-    for encoding in ("utf-8", "gbk", "gb2312"):
-        try:
-            return buf.decode(encoding)
-        except:
-            pass
-
-def edit_distance0(a, b, la, lb, cache=None, replace_step=2):
-    # 典型的可以使用动态规划，为了可读性，依旧保持原来的递归求解结构
-    # 对于这种纯粹的函数，提供装饰器或者在虚拟机进行优化更方便理解
-    if cache[la][lb] >= 0:
-        return cache[la][lb]
-    if la == 0:
-        ret = lb
-    elif lb == 0:
-        ret = la
-    elif a[la-1] == b[lb-1]:
-        ret = edit_distance0(a, b, la-1, lb-1, cache, replace_step)
-    else:
-        # a删除一个字符a[la-1]
-        d1 = edit_distance0(a, b, la-1, lb, cache, replace_step) + 1
-        # a插入一个字符b[lb-1]
-        d2 = edit_distance0(a, b, la, lb-1, cache, replace_step) + 1
-        # 替换最后一个字符
-        d3 = edit_distance0(a, b, la-1, lb-1, cache, replace_step) + replace_step
-        ret = min(d1, d2, d3)
-    cache[la][lb]=ret
-    return ret
-
-def edit_distance(a,b,replace_step=2):
-    """最小编辑距离算法(Leven-shtein Distance)
-
-        >>> edit_distance('ab', 'a')
-        1
-        >>> edit_distance('abc', 'ac')
-        1
-    """
-    cache = [[-1 for i in range(len(b)+1)] for i in range(len(a)+1)]
-    return edit_distance0(a,b,len(a),len(b),cache,replace_step)
-
-def jaccard_similarity(str1, str2):
-    """Jaccard/Tanimoto系数"""
-    set1 = set(str1)
-    set2 = set(str2)
-    return float(len(set1.intersection(set2))) / len(set1.union(set2))
-
-def jaccard_distance(str1, str2):
-    return 1.0 - jaccard_similarity(str1, str2)
-
-def random_string(length, chars=ALPHA_NUM):
-    """生成随机字符串，默认是字母表+数字"""
-    randint = random.randint
-    max_int = len(chars)-1
-    value = ''
-    for i in range(length):
-        value += chars[randint(0, max_int)]
-    return value
-
-def random_number_str(length):
-    return random_string(length, "0123456789")
-
-def parse_config_text(text, ret_type = 'list'):
-    return parse_prop_text(text, ret_type)
-
-def parse_config_text_to_dict(text) -> dict:
-    result = parse_prop_text(text, "dict")
-    assert isinstance(result, dict)
-    return result
-
-def parse_prop_text(text, ret_type = "dict"):
-    from xutils.text_parser_properties import parse_prop_text as parse_prop_text_impl
-    return parse_prop_text_impl(text, ret_type)
-
-def parse_ini_text(text):
-    """解析INI文件内容"""
-    data = dict()
-    cf = ConfigParser()
-    cf.read_string(text)
-    names = cf.sections()
-    for name in names:
-        item = dict()
-        options = cf.options(name)
-        for option in options:
-            value = cf.get(name, option)
-            item[option] = value
-        data[name] = item
-    return data
-
-def parse_simple_command(text):
-    """
-        >>> parse_simple_command("find a.name b.name")
-        ('find', 'a.name b.name')
-        >>> parse_simple_command("find")
-        ('find', '')
-        >>> parse_simple_command('find    a.name b.name')
-        ('find', 'a.name b.name')
-        >>> parse_simple_command('find-name \t lalala')
-        ('find-name', 'lalala')
-    """
-    pattern = re.compile(r"^([^\s]+)\s+(.*)$")
-    match = pattern.match(text)
-    if match: return match.group(1, 2)
-    return text, ""
-
-def short_text(text, length):
-    """
-        >>> short_text('abc', 5)
-        'abc'
-        >>> short_text('abcdefg', 5)
-        'abcdefg'
-        >>> short_text('abcd', 5)
-        'abcd'
-        >>> short_text('中文12345678', 5)
-        '中文1234..'
-    """
-    if len(text) <= length:
-        return text
-    pos = 0
-    size = 0
-    need_cut = False
-    last_size = 1
-    for c in text:
-        pos += 1
-        if ord(c) <= 127:
-            # 半角
-            size += 0.5
-            last_size = 1
-        else:
-            size += 1
-            last_size = 2
-        if size == length:
-            # 刚好
-            if pos == len(text):
-                # 最后一个字符
-                return text
-            if last_size == 2:
-                # 上一个全角
-                pos -= 1
-            if last_size == 1:
-                # 上一个半角
-                pos -= 2
-            need_cut = True
-            break
-        if size - length == 0.5:
-            # 多一个半角，上一个字符一定是全角
-            pos -= 2
-            need_cut = True
-            break
-    if not need_cut:
-        return text
-    return text[:pos] + ".."
-
-shortfor       = short_text
-get_short_text = short_text
-
-def get_camel_case(name, upper = False):
-    """
-        >>> get_camel_case('name')
-        'name'
-        >>> get_camel_case('get_name')
-        'getName'
-        >>> get_camel_case('get_my_name', True)
-        'GetMyName'
-    """
-    target = ''
-    for c in name:
-        if upper:
-            target += c.upper()
-            upper = False
-        elif c == '_':
-            upper = True
-        else:
-            target += c
-    return target
-to_camel_case = get_camel_case
-
-def get_underscore(name):
-    """
-        >>> get_underscore('getName')
-        'get_name'
-        >>> get_underscore('GetName')
-        'get_name'
-    """
-    target = ''
-    for index, c in enumerate(name):
-        if c.isupper() and index != 0:
-            target += '_' + c.lower()
-        else:
-            target += c.lower()
-    return target
-to_underscore = get_underscore
-
-def generate_uuid():
-    """生成UUID"""
-    import uuid
-    return uuid.uuid4().hex
-
-def create_uuid():
-    """生成UUID"""
-    return generate_uuid()
-
-def _encode_json(obj):
-    """基本类型不会拦截"""
-    if inspect.isfunction(obj):
-        return "<function>"
-    elif inspect.isclass(obj):
-        return "<class>"
-    elif inspect.ismodule(obj):
-        return "<module>"
-    return str(obj)
-
-def tojson(obj, format=False, ensure_ascii=False):
-    if format:
-        return json.dumps(obj, sort_keys=True, default=_encode_json, indent=2, ensure_ascii=ensure_ascii)
-    else:
-        return json.dumps(obj, default=_encode_json, ensure_ascii=ensure_ascii)
-
-def tojson_ignore_error(obj, format=False):
-    try:
-        return tojson(obj, format)
-    except Exception as e:
-        return None
-
-def parse_json(json_str, ignore_error = False):
-    try:
-        return json.loads(json_str)
-    except Exception as e:
-        if ignore_error:
-            return None
-        else:
-            raise e
-
-def set_doctype(type):
-    print("#!%s\n" % type)
-
-def get_doctype(text):
-    if text.startswith("#!html"):
-        return "html"
-    return "text"
-
-
-def is_img_file(filename):
-    """根据文件后缀判断是否是图片"""
-    import os
-    import xconfig
-    name, ext = os.path.splitext(filename)
-    return ext.lower() in xconfig.FS_IMG_EXT_LIST
-
-def mark_text(content):
-    import xconfig
-    from xutils.text_parser import TextParser, set_img_file_ext
-    # 设置图片文集后缀
-    set_img_file_ext(xconfig.FS_IMG_EXT_LIST)
-
-    parser = TextParser()
-    tokens = parser.parse(content)
-    return "".join(tokens)
-
-
-def split_words(search_key):
-    """拆分字符
-        >>> split_words("abc is good")
-        ["abc", "is", "good"]
-        >>> split_words("中文测试")
-        ["中", "文", "测", "试"]
-        >>> split_words("中文123")
-        ["中", "文", "123"]
-        >>> split_words("中文123测试")
-        ["中", "文", "123", "测", "试"]
-    """
-    search_key_lower = search_key.lower()
-    words = []
-    p_start = 0
-    for p in range(len(search_key_lower) + 1):
-        if p == len(search_key_lower):
-            if p > p_start:
-                word = search_key_lower[p_start:p]
-                words.append(word)
-            break
-
-        c = search_key_lower[p]
-        if isblank(c):
-            # 空格断字
-            if p > p_start:
-                word = search_key_lower[p_start:p]
-                words.append(word)
-            p_start = p + 1
-        elif is_cjk(c):
-            # 中日韩字符集采用单字模式
-            if p > p_start:
-                words.append(search_key_lower[p_start:p])
-            words.append(c)
-            p_start = p + 1
-        else:
-            # 其他字符
-            continue
-    # print(words)
-    return words
-
- 
-def escape_html(text):
-    """html转义, 参考`lib/tornado/escape.py`"""
-    # 必须先处理&
-    text = text.replace("&", "&amp;")
-    text = text.replace("<", "&lt;")
-    text = text.replace(">", "&gt;")
-    text = text.replace('"', "&quot;")
-    text = text.replace(" ", "&nbsp;")
-    text = text.replace("'", "&#39;")
-    text = text.replace("\n", "<br/>")
-    return text
-
-
-def try_split_key_value(line, token=":"):
-    if line is None:
-        return None, None
-    line = line.strip()
-    if line.startswith("#"):
-        return None, None
-    cols = line.split(token, 1)
-    if len(cols) != 2:
-        return None, None
-    return cols[0].strip(), cols[1].strip()
-
-def split_key_value(line):
-    for token in (":", "=", " "):
-        key, value = try_split_key_value(line, token)
-        if key != None:
-            return key, value
-    return None, None
-
-
-#################################################################
-##   Html Utilities, Python 2 do not have this file
-#################################################################
-
-def html_escape(s, quote=True):
-    """
-    Replace special characters "&", "<" and ">" to HTML-safe sequences.
-    If the optional flag quote is true (the default), the quotation mark
-    characters, both double quote (") and single quote (') characters are also
-    translated.
-    """
-    s = s.replace("&", "&amp;") # Must be done first!
-    s = s.replace("<", "&lt;")
-    s = s.replace(">", "&gt;")
-    if quote:
-        s = s.replace('"', "&quot;")
-        s = s.replace('\'', "&#x27;")
-    return s
-
-def urlsafe_b64encode(text):
-    """URL安全的base64编码，注意Python自带的方法没有处理填充字符=
-    @param {str} text 待编码的字符
-    """
-    b64result = base64.urlsafe_b64encode(text.encode("utf-8")).decode("utf-8")
-    return b64result.rstrip("=")
-
-
-def urlsafe_b64decode(text):
-    """URL安全的base64解码，注意Python自带的方法没有处理填充字符=
-    @param {str} text 编码后的字符
-    """
-    padding = 4- len(text) % 4
-    text = text + '=' * padding
-    return base64.urlsafe_b64decode(text).decode("utf-8")
-
-b64encode = urlsafe_b64encode
-b64decode = urlsafe_b64decode
-
-
-def b32encode(text):
-    result = base64.b32encode(text.encode('utf-8'))
-    return result.decode('utf-8').rstrip("=")
-
-def b32decode(enc_text):
-    padding = 8 - len(enc_text) % 8
-    enc_text = enc_text + "=" * padding
-    return base64.b32decode(enc_text).decode("utf-8")
-
-def encode_uri_component(text):
-    # quoted = quote_unicode(text)
-    # quoted = quoted.replace("?", "%3F")
-    # quoted = quoted.replace("&", "%26")
-    # quoted = quoted.replace(" ", "%20")
-    # quoted = quoted.replace("=", "%3D")
-    # quoted = quoted.replace("+", "%2B")
-    # quoted = quoted.replace("#", "%23")
-    return quote(text)
-
-def md5_hex(string=""):
-    """生成MD5哈希校验码, 长度是32"""
-    return hashlib.md5(string.encode("utf-8")).hexdigest()
-
-def sha1_hex(string=""):
-    """生产SHA-1哈希校验码, 长度是40"""
-    return hashlib.sha1(string.encode("utf-8")).hexdigest()
-        
-class Properties(object): 
-    
-    """Properties 文件处理器"""
-    def __init__(self, fileName, ordered = True): 
-        self.ordered = ordered
-        self.fileName = fileName
-        self.properties = None
-        self.properties_list = None
-        self.load_properties()
-
-    def new_dict(self):
-        if self.ordered:
-            return OrderedDict()
-        else:
-            return {}
-
-    def _set_dict(self, strName, dict, value): 
-        strName = strName.strip()
-        value = value.strip()
-
-        if strName == "":
-            return
-
-        if(strName.find('.')>0): 
-            k = strName.split('.')[0] 
-            dict.setdefault(k, self.new_dict()) 
-            self._set_dict(strName[len(k)+1:], dict[k], value)
-            return
-        else: 
-            dict[strName] = value 
-            return 
-
-    def load_properties(self): 
-        self.properties = self.new_dict()
-        self.properties_list = self.new_dict()
-        with open(self.fileName, 'r', encoding="utf-8") as pro_file: 
-            for line in pro_file.readlines(): 
-                line = line.strip().replace('\n', '') 
-                if line.find("#")!=-1: 
-                    line=line[0:line.find('#')] 
-                if line.find('=') > 0: 
-                    strs = line.split('=') 
-                    strs[1]= line[len(strs[0])+1:] 
-                    self._set_dict(strs[0], self.properties,strs[1]) 
-                    self.properties_list[strs[0].strip()] = strs[1].strip()
-        return self.properties
-
-    def get_properties(self):
-        return self.properties
-
-    def get_property(self, key, default_value=None):
-        return self.properties_list.get(key, default_value)
-
-    def reload(self):
-        self.load_properties()
-
-if __name__ == '__main__':
-    import doctest
-    doctest.testmod(verbose=True)
+# -*- coding:utf-8 -*-
+# @author xupingmao
+# @since 2017/?/?
+# @modified 2022/04/16 18:18:24
+
+"""
+@Author       : xupingmao
+@email        : 578749341@qq.com
+@Date         : 2022-04-17 17:04:15
+@LastEditors  : xupingmao
+@LastEditTime : 2024-05-03 12:41:40
+@FilePath     : /xnote/xutils/textutil.py
+@Description  : 文本处理工具
+"""
+
+import re
+import random
+import json
+import inspect
+import hashlib
+import base64
+from xutils.imports import is_str, ConfigParser
+from xutils.textutil_url import *
+from collections import OrderedDict
+
+try:
+    from urllib.parse import quote, unquote
+except ImportError:
+    from urllib import quote, unquote
+
+__doc__ = """文本处理函数库
+
+Text Process Library
+"""
+
+ALPHA_NUM = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
+BLANK_CHAR_SET = set(" \n\t\r")
+
+def contains_all(text, words):
+    """
+        >>> contains_all("abc is good", "abc")
+        True
+        >>> contains_all("you are right", "rig")
+        True
+        >>> contains_all("hello,world,yep", ["hello", "yep"])
+        True
+    """
+    if is_str(words):
+        return words in text
+    elif isinstance(words, list):
+        for word in words:
+            if word not in text:
+                return False
+        return True
+    else:
+        raise TypeError("unsupported type:%s" % type(words))
+
+text_contains = contains_all
+
+def contains_any(text, words):
+    if is_str(words):
+        return words in text
+    elif isinstance(words, (list, tuple)):
+        for word in words:
+            if word in text:
+                return True
+        return False
+    else:
+        raise TypeError("unsupported type, words require str, list, tuple")
+
+def count_alpha(text):
+    count = 0
+    for c in text:
+        if _isalpha(c):
+            count += 1
+    return count
+
+def count_digit(text):
+    count = 0
+    for c in text:
+        if _isdigit(c):
+            count += 1
+    return count
+
+def count_end_nl(content):
+    count = 0
+    i = len(content) - 1
+    for i in range(i, -1, -1):
+        c = content[i]
+        if c == '\n':
+            count += 1
+        elif c == '\r':
+            continue
+        else:
+            break
+    return count
+
+def _isalpha(c):
+    return (c >='a' and c <='z') or (c >= 'A' and c <= 'Z')
+
+def _isdigit(c):
+    return (c>='0' and c<='9')
+
+def _isalnum(c):
+    return _isalpha(c) or _isdigit(c)
+
+def _chk_list(text, func):
+    for c in text:
+        if not func(c):
+            return False
+    return True
+
+def isalpha(text):
+    """
+        >>> isalpha('a')
+        True
+        >>> isalpha('abc')
+        True
+        >>> isalpha('12abc')
+        False
+    """
+    return _chk_list(text, _isalpha)
+
+def isalnum(text):
+    """
+        >>> isalnum('123abc')
+        True
+        >>> isalnum('-abc-')
+        False
+    """
+    return _chk_list(text, _isalnum)
+
+def isdigit(text):
+    """
+        >>> isdigit('123')
+        True
+        >>> isdigit('abc111')
+        False
+    """
+    return _chk_list(text, _isdigit)
+
+def isblank(text):
+    for c in text:
+        if c not in BLANK_CHAR_SET:
+            return False
+    return True
+
+def issubsetof(text, collection):
+    pass
+
+def is_cjk(c):
+    """是否是CJK(中日韩统一表意文字)
+    说明来自维基百科 https://zh.wikipedia.org/wiki/CJK
+    @param {char} c 单个字符
+    """
+    code = ord(c)
+    if 0x4E00 <= code and code <= 0x9FFF:
+        # 1993年5月，正式制订最初的中日韩统一表意文字，位于U+4E00–U+9FFF这个区域，共20,902个字。
+        return True
+    if 0x3400 <= code and code <= 0x4DFF:
+        # 1999年，依据ISO/IEC 10646的第17个修正案（Amendment 17）订定扩展区A，于U+3400–U+4DFF加入6,582个字。
+        return True
+    if 0x20000 <= code and code <= 0x2A6FF:
+        # 2001年，依据ISO/IEC 10646-2，新增扩展区B，包含42,711个汉字。位于U+20000–U+2A6FF。
+        return True
+    if 0x9FA6 <= code and code <= 0x0FBB:
+        # 2005年，依据ISO/IEC 10646:2003的第1个修正案（Amendment 1），基本多文种平面增加U+9FA6-U+9FBB，共22个汉字。
+        return True
+    if 0x2A700 <= code and code <= 0x2B734:
+        # 2009年，统一码5.2扩展区C增加U+2A700–U+2B734
+        return True
+    if 0x9FC4 <= code and code <= 0x9FCB:
+        # 2009年，统一码5.2基本多文种平面增加U+9FC4–U+9FCB。
+        return True
+    return False
+
+def is_number(value):
+    try:
+        float(value)
+        return True
+    except:
+        return False
+
+def is_json(value):
+    try:
+        json.loads(value)
+        return True
+    except:
+        return False
+
+"""解析文本的方法
+- split, rsplit, splitlines
+- strip, lstrip, rstrip
+- partition, rpartition
+- ljust, rjust, center
+"""
+
+
+def remove(self, target):
+    """
+        >>> remove("this is a bat", "bat")
+        'this is a '
+    """
+    return self.replace(target, "")
+
+def remove_head(text, head):
+    """移除头部的字符
+        >>> remove_head("person.age", "person.")
+        "age"
+        >>> remove_head("person.age", "test")
+        "person.age"
+    """
+    if text is None or head is None:
+        return text
+
+    if not text.startswith(head):
+        return text
+
+    return text[len(head):]
+
+def remove_tail(text, tail):
+    """移除尾部的字符
+        >>> remove_tail("person.age", ".age")
+        "person"
+        >>> remove_tail("person.age", "name")
+        "person.age"
+    """
+    assert is_str(tail)
+    
+    if text is None:
+        return text
+
+    if not text.endswith(tail):
+        return text
+
+    return text[:-len(tail)]
+
+def between(self, start, end):
+    """Get the text between start end end
+        >>> between("start words end", "start", "end")
+        ' words '
+    """
+    p1 = self.find(start)
+    if p1 < 0:
+        return ""
+    p2 = self.find(end, p1)
+    if p2 < 0:
+        return ""
+    return self[p1+len(start):p2]
+
+def replace_between(self, start, end, target):
+    p1 = self.find(start)
+    if p1 < 0:
+        return None
+    p2 = self.find(end, p1)
+    if p2 < 0:
+        return None
+    return self[:p1 + len(start)] + target + self[p2:]
+
+def after(self, start):
+    """
+        >>> after("this is good", "this")
+        ' is good'
+    """
+    p1 = self.find(start)
+    if p1 >= 0:
+        return self[p1+len(start):]
+
+def split_chars(text):
+    chars = []
+    for c in text:
+        if c.isprintable() and c not in BLANK_CHAR_SET:
+            chars.append(c)
+    return chars
+
+def split_first(text, sep = ' '):
+    """
+        >>> split_first("find a.name b.name")
+        ('find', 'a.name b.name')
+        >>> split_first("find")
+        ('find', '')
+        >>> split_first('find-a.name b.name', '-')
+        ('find', 'a.name b.name')
+    """
+    index = text.find(sep)
+    if index >= 0:
+        return text[:index], text[index+1:]
+    return text, ""
+
+def find(text, key, show_line=False, ignore_case=True):
+    """ find key in text, return a list
+
+        >>> find('hello,world', 'hello')
+        ['hello,world']
+
+        >>> find('hell1,world\\nhello,kid', 'hello', True)
+        ['0002:hello,kid']
+        
+        >>> find("yes", "")
+        []
+    """
+    result = []
+    lineno = 1
+    if key == "":
+        return result
+    if not isinstance(key, list):
+        keys = [key]
+    else:
+        keys = key
+    if ignore_case:
+        for i in range(len(keys)):
+            keys[i] = keys[i].lower()
+    for line in text.split("\n"):
+        if ignore_case:
+            target = line.lower()
+        else:
+            target = line
+        if contains_all(target, keys):
+            if show_line:
+                result.append("%04d:%s" % (lineno, line))
+            else:
+                result.append(line)
+        lineno += 1
+    return result
+
+
+def replace(text, origin, dest, ignore_case = False, use_template = False):
+    """
+        >>> replace('abc is good', 'iS', 'is not', True)
+        'abc is not good'
+        >>> replace("this is a long story", "loNg", "-long-", True)
+        'this is a -long- story'
+        >>> replace("use Template", "template", '<k>?</k>', True, True)
+        'use <k>Template</k>'
+    """
+    if not ignore_case:
+        if use_template:
+            dest = dest.replace("?", origin)
+        return text.replace(origin, dest)
+    else:
+        start      = 0
+        origin     = origin.lower()
+        text_lower = text.lower()
+        new_text   = ""
+        pos        = 0
+        while pos >= 0:
+            pos = text_lower.find(origin, start)
+            if pos >= 0:
+                new_text += text[start:pos]
+                if use_template:
+                    dest = dest.replace("?", text[pos:pos+len(origin)])
+                new_text += dest
+                start = pos+len(origin)
+            else:
+                new_text += text[start:]
+        return new_text
+
+def like(text, pattern):
+    """这个其实就是通配符，参考 fnmatch 模块
+        >>> like("hello,world", "hello*")
+        True
+        >>> like ("yes", "y?s")
+        True
+        >>> like("what", "n*")
+        False
+    """
+
+    # TODO 处理`,`
+    re_pattern = pattern.replace("?", ".?")
+    re_pattern = re_pattern.replace("*", ".*?")
+    m = re.match(re_pattern, text)
+    if m:
+        return True
+    return False
+
+
+def byte2str(buf):
+    for encoding in ("utf-8", "gbk", "gb2312"):
+        try:
+            return buf.decode(encoding)
+        except:
+            pass
+
+def edit_distance0(a, b, la, lb, cache=None, replace_step=2):
+    # 典型的可以使用动态规划，为了可读性，依旧保持原来的递归求解结构
+    # 对于这种纯粹的函数，提供装饰器或者在虚拟机进行优化更方便理解
+    assert isinstance(cache, list)
+    if cache[la][lb] >= 0:
+        return cache[la][lb]
+    if la == 0:
+        ret = lb
+    elif lb == 0:
+        ret = la
+    elif a[la-1] == b[lb-1]:
+        ret = edit_distance0(a, b, la-1, lb-1, cache, replace_step)
+    else:
+        # a删除一个字符a[la-1]
+        d1 = edit_distance0(a, b, la-1, lb, cache, replace_step) + 1
+        # a插入一个字符b[lb-1]
+        d2 = edit_distance0(a, b, la, lb-1, cache, replace_step) + 1
+        # 替换最后一个字符
+        d3 = edit_distance0(a, b, la-1, lb-1, cache, replace_step) + replace_step
+        ret = min(d1, d2, d3)
+    cache[la][lb]=ret
+    return ret
+
+def edit_distance(a,b,replace_step=2):
+    """最小编辑距离算法(Leven-shtein Distance)
+
+        >>> edit_distance('ab', 'a')
+        1
+        >>> edit_distance('abc', 'ac')
+        1
+    """
+    cache = [[-1 for i in range(len(b)+1)] for i in range(len(a)+1)]
+    return edit_distance0(a,b,len(a),len(b),cache,replace_step)
+
+def jaccard_similarity(str1, str2):
+    """Jaccard/Tanimoto系数"""
+    set1 = set(str1)
+    set2 = set(str2)
+    return float(len(set1.intersection(set2))) / len(set1.union(set2))
+
+def jaccard_distance(str1, str2):
+    return 1.0 - jaccard_similarity(str1, str2)
+
+def random_string(length, chars=ALPHA_NUM):
+    """生成随机字符串，默认是字母表+数字"""
+    randint = random.randint
+    max_int = len(chars)-1
+    value = ''
+    for i in range(length):
+        value += chars[randint(0, max_int)]
+    return value
+
+def random_number_str(length):
+    return random_string(length, "0123456789")
+
+def parse_config_text(text, ret_type = 'list'):
+    return parse_prop_text(text, ret_type)
+
+def parse_config_text_to_dict(text) -> dict:
+    result = parse_prop_text(text, "dict")
+    assert isinstance(result, dict)
+    return result
+
+def parse_prop_text(text, ret_type = "dict"):
+    from xutils.text_parser_properties import parse_prop_text as parse_prop_text_impl
+    return parse_prop_text_impl(text, ret_type)
+
+def parse_ini_text(text):
+    """解析INI文件内容"""
+    data = dict()
+    cf = ConfigParser()
+    cf.read_string(text)
+    names = cf.sections()
+    for name in names:
+        item = dict()
+        options = cf.options(name)
+        for option in options:
+            value = cf.get(name, option)
+            item[option] = value
+        data[name] = item
+    return data
+
+def parse_simple_command(text):
+    """
+        >>> parse_simple_command("find a.name b.name")
+        ('find', 'a.name b.name')
+        >>> parse_simple_command("find")
+        ('find', '')
+        >>> parse_simple_command('find    a.name b.name')
+        ('find', 'a.name b.name')
+        >>> parse_simple_command('find-name \t lalala')
+        ('find-name', 'lalala')
+    """
+    pattern = re.compile(r"^([^\s]+)\s+(.*)$")
+    match = pattern.match(text)
+    if match: return match.group(1, 2)
+    return text, ""
+
+def short_text(text, length):
+    """
+        >>> short_text('abc', 5)
+        'abc'
+        >>> short_text('abcdefg', 5)
+        'abcdefg'
+        >>> short_text('abcd', 5)
+        'abcd'
+        >>> short_text('中文12345678', 5)
+        '中文1234..'
+    """
+    if len(text) <= length:
+        return text
+    pos = 0
+    size = 0
+    need_cut = False
+    last_size = 1
+    for c in text:
+        pos += 1
+        if ord(c) <= 127:
+            # 半角
+            size += 0.5
+            last_size = 1
+        else:
+            size += 1
+            last_size = 2
+        if size == length:
+            # 刚好
+            if pos == len(text):
+                # 最后一个字符
+                return text
+            if last_size == 2:
+                # 上一个全角
+                pos -= 1
+            if last_size == 1:
+                # 上一个半角
+                pos -= 2
+            need_cut = True
+            break
+        if size - length == 0.5:
+            # 多一个半角，上一个字符一定是全角
+            pos -= 2
+            need_cut = True
+            break
+    if not need_cut:
+        return text
+    return text[:pos] + ".."
+
+shortfor       = short_text
+get_short_text = short_text
+
+def get_camel_case(name, upper = False):
+    """
+        >>> get_camel_case('name')
+        'name'
+        >>> get_camel_case('get_name')
+        'getName'
+        >>> get_camel_case('get_my_name', True)
+        'GetMyName'
+    """
+    target = ''
+    for c in name:
+        if upper:
+            target += c.upper()
+            upper = False
+        elif c == '_':
+            upper = True
+        else:
+            target += c
+    return target
+to_camel_case = get_camel_case
+
+def get_underscore(name):
+    """
+        >>> get_underscore('getName')
+        'get_name'
+        >>> get_underscore('GetName')
+        'get_name'
+    """
+    target = ''
+    for index, c in enumerate(name):
+        if c.isupper() and index != 0:
+            target += '_' + c.lower()
+        else:
+            target += c.lower()
+    return target
+to_underscore = get_underscore
+
+def generate_uuid():
+    """生成UUID"""
+    import uuid
+    return uuid.uuid4().hex
+
+def create_uuid():
+    """生成UUID"""
+    return generate_uuid()
+
+def _encode_json(obj):
+    """基本类型不会拦截"""
+    if inspect.isfunction(obj):
+        return "<function>"
+    elif inspect.isclass(obj):
+        return "<class>"
+    elif inspect.ismodule(obj):
+        return "<module>"
+    return str(obj)
+
+def tojson(obj, format=False, ensure_ascii=False):
+    if format:
+        return json.dumps(obj, sort_keys=True, default=_encode_json, indent=2, ensure_ascii=ensure_ascii)
+    else:
+        return json.dumps(obj, default=_encode_json, ensure_ascii=ensure_ascii)
+
+def tojson_ignore_error(obj, format=False):
+    try:
+        return tojson(obj, format)
+    except Exception as e:
+        return None
+
+def parse_json(json_str, ignore_error = False):
+    try:
+        return json.loads(json_str)
+    except Exception as e:
+        if ignore_error:
+            return None
+        else:
+            raise e
+
+def set_doctype(type):
+    print("#!%s\n" % type)
+
+def get_doctype(text):
+    if text.startswith("#!html"):
+        return "html"
+    return "text"
+
+
+def is_img_file(filename):
+    """根据文件后缀判断是否是图片"""
+    import os
+    from xnote.core import xconfig
+    name, ext = os.path.splitext(filename)
+    return ext.lower() in xconfig.FS_IMG_EXT_LIST
+
+def mark_text(content):
+    from xnote.core import xconfig
+    from xutils.text_parser import TextParser, set_img_file_ext
+    # 设置图片文集后缀
+    set_img_file_ext(xconfig.FS_IMG_EXT_LIST)
+
+    parser = TextParser()
+    tokens = parser.parse(content)
+    return "".join(tokens)
+
+
+def split_words(search_key):
+    """拆分字符
+        >>> split_words("abc is good")
+        ["abc", "is", "good"]
+        >>> split_words("中文测试")
+        ["中", "文", "测", "试"]
+        >>> split_words("中文123")
+        ["中", "文", "123"]
+        >>> split_words("中文123测试")
+        ["中", "文", "123", "测", "试"]
+    """
+    search_key_lower = search_key.lower()
+    words = []
+    p_start = 0
+    for p in range(len(search_key_lower) + 1):
+        if p == len(search_key_lower):
+            if p > p_start:
+                word = search_key_lower[p_start:p]
+                words.append(word)
+            break
+
+        c = search_key_lower[p]
+        if isblank(c):
+            # 空格断字
+            if p > p_start:
+                word = search_key_lower[p_start:p]
+                words.append(word)
+            p_start = p + 1
+        elif is_cjk(c):
+            # 中日韩字符集采用单字模式
+            if p > p_start:
+                words.append(search_key_lower[p_start:p])
+            words.append(c)
+            p_start = p + 1
+        else:
+            # 其他字符
+            continue
+    # print(words)
+    return words
+
+
+def try_split_key_value(line, token=":"):
+    if line is None:
+        return None, None
+    line = line.strip()
+    if line.startswith("#"):
+        return None, None
+    cols = line.split(token, 1)
+    if len(cols) != 2:
+        return None, None
+    return cols[0].strip(), cols[1].strip()
+
+def split_key_value(line):
+    for token in (":", "=", " "):
+        key, value = try_split_key_value(line, token)
+        if key != None:
+            return key, value
+    return None, None
+
+
+#################################################################
+##   Html Utilities, Python 2 do not have this file
+#################################################################
+
+def html_escape(s, quote=True):
+    """
+    Replace special characters "&", "<" and ">" to HTML-safe sequences.
+    If the optional flag quote is true (the default), the quotation mark
+    characters, both double quote (") and single quote (') characters are also
+    translated.
+    """
+    s = s.replace("&", "&amp;") # Must be done first!
+    s = s.replace("<", "&lt;")
+    s = s.replace(">", "&gt;")
+    if quote:
+        s = s.replace('"', "&quot;")
+        s = s.replace('\'', "&#x27;")
+    return s
+
+def escape_html(text):
+    """html转义, 参考`lib/tornado/escape.py`"""
+    # 必须先处理&
+    text = text.replace("&", "&amp;")
+    text = text.replace("<", "&lt;")
+    text = text.replace(">", "&gt;")
+    text = text.replace('"', "&quot;")
+    text = text.replace(" ", "&nbsp;")
+    text = text.replace("'", "&#39;")
+    text = text.replace("\n", "<br/>")
+    return text
+
+def urlsafe_b64encode(text):
+    """URL安全的base64编码，注意Python自带的方法没有处理填充字符=
+    @param {str} text 待编码的字符
+    """
+    b64result = base64.urlsafe_b64encode(text.encode("utf-8")).decode("utf-8")
+    return b64result.rstrip("=")
+
+
+def urlsafe_b64decode(text):
+    """URL安全的base64解码，注意Python自带的方法没有处理填充字符=
+    @param {str} text 编码后的字符
+    """
+    padding = 4- len(text) % 4
+    text = text + '=' * padding
+    return base64.urlsafe_b64decode(text).decode("utf-8")
+
+b64encode = urlsafe_b64encode
+b64decode = urlsafe_b64decode
+
+
+def b32encode(text):
+    result = base64.b32encode(text.encode('utf-8'))
+    return result.decode('utf-8').rstrip("=")
+
+def b32decode(enc_text):
+    padding = 8 - len(enc_text) % 8
+    enc_text = enc_text + "=" * padding
+    return base64.b32decode(enc_text).decode("utf-8")
+
+def encode_uri_component(text):
+    # quoted = quote_unicode(text)
+    # quoted = quoted.replace("?", "%3F")
+    # quoted = quoted.replace("&", "%26")
+    # quoted = quoted.replace(" ", "%20")
+    # quoted = quoted.replace("=", "%3D")
+    # quoted = quoted.replace("+", "%2B")
+    # quoted = quoted.replace("#", "%23")
+    return quote(text)
+
+def md5_hex(string=""):
+    """生成MD5哈希校验码, 长度是32"""
+    return hashlib.md5(string.encode("utf-8")).hexdigest()
+
+def sha1_hex(string=""):
+    """生产SHA-1哈希校验码, 长度是40"""
+    return hashlib.sha1(string.encode("utf-8")).hexdigest()
+        
+class Properties(object): 
+    
+    """Properties 文件处理器"""
+    def __init__(self, fileName, ordered = True): 
+        self.ordered = ordered
+        self.fileName = fileName
+        self.properties = None     # 层次化的属性
+        self.flat_properties = {}  # 摊平的属性键值对
+        self.load_properties()
+
+    def new_dict(self):
+        if self.ordered:
+            return OrderedDict()
+        else:
+            return {}
+
+    def _set_dict(self, strName, dict, value): 
+        strName = strName.strip()
+        value = value.strip()
+
+        if strName == "":
+            return
+
+        if(strName.find('.')>0): 
+            k = strName.split('.')[0] 
+            dict.setdefault(k, self.new_dict()) 
+            self._set_dict(strName[len(k)+1:], dict[k], value)
+            return
+        else: 
+            dict[strName] = value 
+            return 
+
+    def load_properties(self): 
+        self.properties = self.new_dict()
+        self.flat_properties = self.new_dict()
+        with open(self.fileName, 'r', encoding="utf-8") as pro_file: 
+            for line in pro_file.readlines(): 
+                line = line.strip().replace('\n', '') 
+                if line.find("#")!=-1: 
+                    line=line[0:line.find('#')] 
+                if line.find('=') > 0: 
+                    strs = line.split('=') 
+                    strs[1]= line[len(strs[0])+1:] 
+                    self._set_dict(strs[0], self.properties,strs[1]) 
+                    self.flat_properties[strs[0].strip()] = strs[1].strip()
+        return self.properties
+
+    def get_properties(self):
+        return self.properties
+
+    def get_property(self, key, default_value=None):
+        return self.flat_properties.get(key, default_value)
+
+    def reload(self):
+        self.load_properties()
+
+if __name__ == '__main__':
+    import doctest
+    doctest.testmod(verbose=True)
```

### Comparing `xnote-web-0.1.0/xutils/textutil_url.py` & `xnote-web-0.1.1/xutils/textutil_url.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/tokenizer.py` & `xnote-web-0.1.1/xutils/tokenizer.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/tornado/escape.py` & `xnote-web-0.1.1/xutils/tornado/escape.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/tornado/log.py` & `xnote-web-0.1.1/xutils/tornado/log.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/tornado/template.py` & `xnote-web-0.1.1/xutils/tornado/template.py`

 * *Files 0% similar despite different names*

```diff
@@ -566,15 +566,15 @@
     def generate(self, writer):
         included = writer.loader.load(self.name, self.template_name)
         with writer.include(included, self.line):
             included.file.body.generate(writer)
 
 
 class _ApplyBlock(_Node):
-    def __init__(self, method, line, body=None):
+    def __init__(self, method, line, body: _ChunkList):
         self.method = method
         self.line = line
         self.body = body
 
     def each_child(self):
         return (self.body,)
 
@@ -588,23 +588,23 @@
             self.body.generate(writer)
             writer.write_line("return _tt_utf8('').join(_tt_buffer)", self.line)
         writer.write_line("_tt_append(_tt_utf8(%s(%s())))" % (
             self.method, method_name), self.line)
 
 
 class _ControlBlock(_Node):
-    def __init__(self, statement, line, body=None):
+    def __init__(self, statement: str, line: int, body: _Node):
         self.statement = statement
         self.line = line
         self.body = body
 
     def each_child(self):
         return (self.body,)
 
-    def generate(self, writer):
+    def generate(self, writer: "_CodeWriter"):
         writer.write_line("%s:" % self.statement, self.line)
         with writer.indent():
             self.body.generate(writer)
             # Just in case the body was empty
             writer.write_line("pass", self.line)
 
 
@@ -759,27 +759,27 @@
                 return self
 
             def __exit__(_, *args):
                 self.current_template = self.include_stack.pop()[0]
 
         return IncludeTemplate()
 
-    def write_line(self, line, line_number, indent=None):
+    def write_line(self, line, line_number:int, indent=None):
         if indent is None:
             indent = self._indent
         line_comment = '  # %s:%d' % (self.current_template.name, line_number)
         if self.include_stack:
             ancestors = ["%s:%d" % (tmpl.name, lineno)
                          for (tmpl, lineno) in self.include_stack]
             line_comment += ' (via %s)' % ', '.join(reversed(ancestors))
         print("    " * indent + line + line_comment, file=self.file)
 
 
 class _TemplateReader(object):
-    def __init__(self, name, text, whitespace):
+    def __init__(self, name:str, text: str, whitespace: str):
         self.name = name
         self.text = text
         self.whitespace = whitespace
         self.line = 1
         self.pos = 0
 
     def find(self, needle, start=0, end=None):
@@ -836,15 +836,15 @@
 
 def _format_code(code):
     lines = code.splitlines()
     format = "%%%dd  %%s\n" % len(repr(len(lines) + 1))
     return "".join([format % (i + 1, line) for (i, line) in enumerate(lines)])
 
 
-def _parse(reader, template, in_block=None, in_loop=None):
+def _parse(reader: _TemplateReader, template, in_block=None, in_loop=None):
     body = _ChunkList([])
     while True:
         # Find next template directive
         curly = 0
         while True:
             curly = reader.find("{", curly)
             if curly == -1 or curly + 1 == reader.remaining():
```

### Comparing `xnote-web-0.1.0/xutils/tornado/util.py` & `xnote-web-0.1.1/xutils/tornado/util.py`

 * *Files identical despite different names*

### Comparing `xnote-web-0.1.0/xutils/webutil.py` & `xnote-web-0.1.1/xutils/webutil.py`

 * *Ordering differences only*

 * *Files 15% similar despite different names*

```diff
@@ -1,275 +1,275 @@
-# -*- coding:utf-8 -*-
-# @author xupingmao <578749341@qq.com>
-# @since 2021/01/17 10:51:22
-# @modified 2021/11/07 12:53:19
-
-from http.server import BaseHTTPRequestHandler
-import profile
-import time
-import web
-import math
-from xutils.six import BytesIO
-from web import utils
-
-#################################################################
-##   Web.py Utilities web.py工具类的封装
-#################################################################
-
-IS_TEST = False
-MOBILE_UA_NAMES = ("iphone", "android", "ipad", "webos")
-
-
-def print_web_ctx_env():
-    for key in web.ctx.env:
-        print(" - - %-20s = %s" % (key, web.ctx.env.get(key)))
-
-def get_web_ctx_env():
-    return web.ctx.env
-
-def _get_default_by_type(default_value, type):
-    if default_value != None:
-        return default_value
-    if type is bool:
-        return False
-    return None
-
-def _detect_type(default_value, type):
-    """根据默认值+类型检测类型"""
-    if type != None:
-        return type
-    
-    if isinstance(default_value, bool):
-        return bool
-    
-    if isinstance(default_value, int):
-        return int
-    
-    if isinstance(default_value, float):
-        return float
-    
-    return None
-
-def get_argument(key, default_value=None, type = None, strip=False):
-    """获取请求参数
-    @param {string} key 请求的参数名
-    @param {object} default_value 默认值
-    @param {type} type 参数类型
-    @param {bool} strip 是否过滤空白字符
-    """
-    if not hasattr(web.ctx, "env"):
-        if default_value != None:
-            return default_value
-        return None
-    ctx_key = "_xnote.input"
-    if isinstance(default_value, (dict, list)):
-        return web.input(**{key: default_value}).get(key)
-    _input = web.ctx.get(ctx_key)
-    if _input == None:
-        _input = web.input()
-        web.ctx[ctx_key] = _input
-    value = _input.get(key)
-
-    if value is None or value == "":
-        default_value = _get_default_by_type(default_value, type)
-        _input[key] = default_value
-        return default_value
-    
-    # 检测参数类型
-    type = _detect_type(default_value, type)
-
-    if type == bool:
-        # bool函数对非空字符串都默认返回true，需要处理一下
-        value = value.lower() in ("true", "yes", "y", "on")
-        _input[key] = value
-    elif type != None:
-        value = type(value)
-        _input[key] = value
-    
-    if strip and isinstance(value, str):
-        value = value.strip()
-    
-    return value
-
-def get_argument_str(key: str, default_value = "") -> str:
-    """获取字符串参数"""
-    value = get_argument(key, default_value, type = str, strip = True)
-    assert isinstance(value, str)
-    return value
-
-def get_argument_int(key: str, default_value = 0) -> int:
-    """获取int参数"""
-    value = get_argument(key, default_value=default_value, type = int, strip = True)
-    assert isinstance(value, int)
-    return value
-
-def get_argument_float(key: str, default_value = 0.0) -> float:
-    """获取float参数"""
-    value = get_argument(key, default_value=default_value, type = float, strip = True)
-    assert isinstance(value, float)
-    return value
-
-def get_argument_bool(key: str, default_value = False) -> bool:
-    """获取bool参数"""
-    value = get_argument(key, default_value=default_value, type = bool, strip = True)
-    assert isinstance(value, bool)
-    return value
-
-def get_argument_dict(key="", default_value={}):
-    """获取dict类型的参数"""
-    value = get_argument(key=key, default_value=default_value)
-    if not isinstance(value, dict):
-        raise Exception("expect dict but see %s" % type(value))
-    return value
-
-def get_argument_field_storage(key=""):
-    import cgi
-    value = get_argument(key=key, default_value={})
-    assert isinstance(value, cgi.FieldStorage)
-    return value
-
-
-def get_client_user_agent():
-    if IS_TEST:
-        return ""
-    return web.ctx.env.get("HTTP_USER_AGENT")
-
-def get_client_platform(user_agent = None):
-    if user_agent is None:
-        user_agent = get_client_user_agent()
-
-    if user_agent is None:
-        return False
-
-    user_agent_lower = user_agent.lower()
-    for name in MOBILE_UA_NAMES:
-        if user_agent_lower.find(name) >= 0:
-            return "mobile"
-    return "desktop"
-
-
-def is_mobile_client(user_agent = None):
-    """通过UA判断是否是移动客户端
-    @param {str|None} user_agent 浏览器标识（可选）
-    """
-    return get_client_platform(user_agent) == "mobile"
-
-
-def is_desktop_client(user_agent = None):
-    return get_client_platform(user_agent) == "desktop"
-
-def get_real_ip():
-    x_forwarded_for = web.ctx.env.get("HTTP_X_FORWARDED_FOR")
-    if x_forwarded_for != None:
-        return x_forwarded_for.split(",")[0]
-    return web.ctx.env.get("REMOTE_ADDR")
-
-def get_client_ip():
-    return get_real_ip()
-
-
-def get_request_url(host=False):
-    # TODO 待测试
-    return web.ctx.path + "?" + web.ctx.query
-
-def get_request_path():
-    return web.ctx.path
-
-class LogMiddleware:
-    """WSGI middleware for logging the status.
-
-    中间件的实现参考 web/httpservers.py
-    """
-
-    PROFILE_SET = set()
-
-    def __init__(self, app):
-        self.app = app
-        self.format = '%s - - [%s] "%s %s %s" - %s %s ms'
-
-        f = BytesIO()
-
-        class FakeSocket:
-
-            def makefile(self, *a):
-                return f
-
-        # take log_date_time_string method from BaseHTTPRequestHandler
-        self.log_date_time_string = BaseHTTPRequestHandler(
-            FakeSocket(), None, None).log_date_time_string
-
-    def invoke_app(self, environ, start_response):
-        start_time = time.time()
-
-        def xstart_response(status, response_headers, *args):
-            out = start_response(status, response_headers, *args)
-            self.log(status, environ, time.time() - start_time)
-            return out
-
-        return self.app(environ, xstart_response)
-
-    def __call__(self, environ, start_response):
-        path = environ.get('PATH_INFO', '_')
-        if path in LogMiddleware.PROFILE_SET:
-            vars = dict(f=self.invoke_app,
-                        environ=environ,
-                        start_response=start_response)
-            profile.runctx("r=f(environ, start_response)",
-                           globals(),
-                           vars,
-                           sort="time")
-            return vars["r"]
-        else:
-            return self.invoke_app(environ, start_response)
-
-    def log(self, status, environ, cost_time):
-        outfile = environ.get('wsgi.errors', web.debug)
-        req = environ.get('PATH_INFO', '_')
-        query_string = environ.get("QUERY_STRING", '')
-        if query_string != '':
-            req += '?' + query_string
-        protocol = environ.get('ACTUAL_SERVER_PROTOCOL', '-')
-        method = environ.get('REQUEST_METHOD', '-')
-        x_forwarded_for = environ.get("HTTP_X_FORWARDED_FOR")
-        if x_forwarded_for is not None:
-            host = x_forwarded_for.split(",")[0]
-        else:
-            host = "%s:%s" % (environ.get(
-                'REMOTE_ADDR', '-'), environ.get('REMOTE_PORT', '-'))
-
-        time = self.log_date_time_string()
-
-        msg = self.format % (host, time, protocol, method, req, status,
-                             int(1000 * cost_time))
-        print(utils.safestr(msg), file=outfile)
-
-def init_webutil_env(is_test = False):
-    global IS_TEST
-    IS_TEST = is_test
-
-
-class SuccessResult(web.Storage):
-
-    def __init__(self, data=None, message=""):
-        self.success = True
-        self.code = "success"
-        self.data = data
-
-
-class FailedResult(web.Storage):
-
-    def __init__(self, code="500", message=""):
-        self.success = False
-        self.code = code
-        self.message = message
-
-
-class Pagination:
-    
-    def __init__(self, page=1, total=0, page_size=20):
-        self.page = page
-        self.total = total
-        self.page_max = int(math.ceil(total/page_size))
-        if self.page_max == 0:
-            self.page_max = 1
-
+# -*- coding:utf-8 -*-
+# @author xupingmao <578749341@qq.com>
+# @since 2021/01/17 10:51:22
+# @modified 2021/11/07 12:53:19
+
+from http.server import BaseHTTPRequestHandler
+import profile
+import time
+import web
+import math
+from xutils.six import BytesIO
+from web import utils
+
+#################################################################
+##   Web.py Utilities web.py工具类的封装
+#################################################################
+
+IS_TEST = False
+MOBILE_UA_NAMES = ("iphone", "android", "ipad", "webos")
+
+
+def print_web_ctx_env():
+    for key in web.ctx.env:
+        print(" - - %-20s = %s" % (key, web.ctx.env.get(key)))
+
+def get_web_ctx_env():
+    return web.ctx.env
+
+def _get_default_by_type(default_value, type):
+    if default_value != None:
+        return default_value
+    if type is bool:
+        return False
+    return None
+
+def _detect_type(default_value, type):
+    """根据默认值+类型检测类型"""
+    if type != None:
+        return type
+    
+    if isinstance(default_value, bool):
+        return bool
+    
+    if isinstance(default_value, int):
+        return int
+    
+    if isinstance(default_value, float):
+        return float
+    
+    return None
+
+def get_argument(key, default_value=None, type = None, strip=False):
+    """获取请求参数
+    @param {string} key 请求的参数名
+    @param {object} default_value 默认值
+    @param {type} type 参数类型
+    @param {bool} strip 是否过滤空白字符
+    """
+    if not hasattr(web.ctx, "env"):
+        if default_value != None:
+            return default_value
+        return None
+    ctx_key = "_xnote.input"
+    if isinstance(default_value, (dict, list)):
+        return web.input(**{key: default_value}).get(key)
+    _input = web.ctx.get(ctx_key)
+    if _input == None:
+        _input = web.input()
+        web.ctx[ctx_key] = _input
+    value = _input.get(key)
+
+    if value is None or value == "":
+        default_value = _get_default_by_type(default_value, type)
+        _input[key] = default_value
+        return default_value
+    
+    # 检测参数类型
+    type = _detect_type(default_value, type)
+
+    if type == bool:
+        # bool函数对非空字符串都默认返回true，需要处理一下
+        value = value.lower() in ("true", "yes", "y", "on")
+        _input[key] = value
+    elif type != None:
+        value = type(value)
+        _input[key] = value
+    
+    if strip and isinstance(value, str):
+        value = value.strip()
+    
+    return value
+
+def get_argument_str(key: str, default_value = "") -> str:
+    """获取字符串参数"""
+    value = get_argument(key, default_value, type = str, strip = True)
+    assert isinstance(value, str)
+    return value
+
+def get_argument_int(key: str, default_value = 0) -> int:
+    """获取int参数"""
+    value = get_argument(key, default_value=default_value, type = int, strip = True)
+    assert isinstance(value, int)
+    return value
+
+def get_argument_float(key: str, default_value = 0.0) -> float:
+    """获取float参数"""
+    value = get_argument(key, default_value=default_value, type = float, strip = True)
+    assert isinstance(value, float)
+    return value
+
+def get_argument_bool(key: str, default_value = False) -> bool:
+    """获取bool参数"""
+    value = get_argument(key, default_value=default_value, type = bool, strip = True)
+    assert isinstance(value, bool)
+    return value
+
+def get_argument_dict(key="", default_value={}):
+    """获取dict类型的参数"""
+    value = get_argument(key=key, default_value=default_value)
+    if not isinstance(value, dict):
+        raise Exception("expect dict but see %s" % type(value))
+    return value
+
+def get_argument_field_storage(key=""):
+    import cgi
+    value = get_argument(key=key, default_value={})
+    assert isinstance(value, cgi.FieldStorage)
+    return value
+
+
+def get_client_user_agent():
+    if IS_TEST:
+        return ""
+    return web.ctx.env.get("HTTP_USER_AGENT")
+
+def get_client_platform(user_agent = None):
+    if user_agent is None:
+        user_agent = get_client_user_agent()
+
+    if user_agent is None:
+        return False
+
+    user_agent_lower = user_agent.lower()
+    for name in MOBILE_UA_NAMES:
+        if user_agent_lower.find(name) >= 0:
+            return "mobile"
+    return "desktop"
+
+
+def is_mobile_client(user_agent = None):
+    """通过UA判断是否是移动客户端
+    @param {str|None} user_agent 浏览器标识（可选）
+    """
+    return get_client_platform(user_agent) == "mobile"
+
+
+def is_desktop_client(user_agent = None):
+    return get_client_platform(user_agent) == "desktop"
+
+def get_real_ip():
+    x_forwarded_for = web.ctx.env.get("HTTP_X_FORWARDED_FOR")
+    if x_forwarded_for != None:
+        return x_forwarded_for.split(",")[0]
+    return web.ctx.env.get("REMOTE_ADDR")
+
+def get_client_ip():
+    return get_real_ip()
+
+
+def get_request_url(host=False):
+    # TODO 待测试
+    return web.ctx.path + "?" + web.ctx.query
+
+def get_request_path():
+    return web.ctx.path
+
+class LogMiddleware:
+    """WSGI middleware for logging the status.
+
+    中间件的实现参考 web/httpservers.py
+    """
+
+    PROFILE_SET = set()
+
+    def __init__(self, app):
+        self.app = app
+        self.format = '%s - - [%s] "%s %s %s" - %s %s ms'
+
+        f = BytesIO()
+
+        class FakeSocket:
+
+            def makefile(self, *a):
+                return f
+
+        # take log_date_time_string method from BaseHTTPRequestHandler
+        self.log_date_time_string = BaseHTTPRequestHandler(
+            FakeSocket(), None, None).log_date_time_string
+
+    def invoke_app(self, environ, start_response):
+        start_time = time.time()
+
+        def xstart_response(status, response_headers, *args):
+            out = start_response(status, response_headers, *args)
+            self.log(status, environ, time.time() - start_time)
+            return out
+
+        return self.app(environ, xstart_response)
+
+    def __call__(self, environ, start_response):
+        path = environ.get('PATH_INFO', '_')
+        if path in LogMiddleware.PROFILE_SET:
+            vars = dict(f=self.invoke_app,
+                        environ=environ,
+                        start_response=start_response)
+            profile.runctx("r=f(environ, start_response)",
+                           globals(),
+                           vars,
+                           sort="time")
+            return vars["r"]
+        else:
+            return self.invoke_app(environ, start_response)
+
+    def log(self, status, environ, cost_time):
+        outfile = environ.get('wsgi.errors', web.debug)
+        req = environ.get('PATH_INFO', '_')
+        query_string = environ.get("QUERY_STRING", '')
+        if query_string != '':
+            req += '?' + query_string
+        protocol = environ.get('ACTUAL_SERVER_PROTOCOL', '-')
+        method = environ.get('REQUEST_METHOD', '-')
+        x_forwarded_for = environ.get("HTTP_X_FORWARDED_FOR")
+        if x_forwarded_for is not None:
+            host = x_forwarded_for.split(",")[0]
+        else:
+            host = "%s:%s" % (environ.get(
+                'REMOTE_ADDR', '-'), environ.get('REMOTE_PORT', '-'))
+
+        time = self.log_date_time_string()
+
+        msg = self.format % (host, time, protocol, method, req, status,
+                             int(1000 * cost_time))
+        print(utils.safestr(msg), file=outfile)
+
+def init_webutil_env(is_test = False):
+    global IS_TEST
+    IS_TEST = is_test
+
+
+class SuccessResult(web.Storage):
+
+    def __init__(self, data=None, message=""):
+        self.success = True
+        self.code = "success"
+        self.data = data
+
+
+class FailedResult(web.Storage):
+
+    def __init__(self, code="500", message=""):
+        self.success = False
+        self.code = code
+        self.message = message
+
+
+class Pagination:
+    
+    def __init__(self, page=1, total=0, page_size=20):
+        self.page = page
+        self.total = total
+        self.page_max = int(math.ceil(total/page_size))
+        if self.page_max == 0:
+            self.page_max = 1
+
```

### Comparing `xnote-web-0.1.0/xutils/ziputil.py` & `xnote-web-0.1.1/xutils/ziputil.py`

 * *Files identical despite different names*

