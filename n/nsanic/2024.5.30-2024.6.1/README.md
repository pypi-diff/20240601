# Comparing `tmp/nsanic-2024.5.30-py3-none-any.whl.zip` & `tmp/nsanic-2024.6.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,8 +1,8 @@
-Zip file size: 59390 bytes, number of entries: 42
+Zip file size: 59504 bytes, number of entries: 42
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 nsanic/__init__.py
 -rw-rw-rw-  2.0 fat     3462 b- defN 24-May-16 07:52 nsanic/base_blue.py
 -rw-rw-rw-  2.0 fat     8536 b- defN 24-May-16 07:52 nsanic/base_conf.py
 -rw-rw-rw-  2.0 fat     3241 b- defN 24-May-16 07:52 nsanic/base_server.py
 -rw-rw-rw-  2.0 fat     9666 b- defN 24-May-16 07:52 nsanic/base_ws.py
 -rw-rw-rw-  2.0 fat     2908 b- defN 24-May-16 07:52 nsanic/exception.py
 -rw-rw-rw-  2.0 fat     7704 b- defN 24-May-27 03:10 nsanic/handler_http.py
@@ -11,34 +11,34 @@
 -rw-rw-rw-  2.0 fat    10352 b- defN 24-May-16 07:52 nsanic/mult_creator.py
 -rw-rw-rw-  2.0 fat     8531 b- defN 24-May-30 03:29 nsanic/verify.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 nsanic/libs/__init__.py
 -rw-rw-rw-  2.0 fat     7656 b- defN 24-May-16 07:52 nsanic/libs/base_timed.py
 -rw-rw-rw-  2.0 fat     1276 b- defN 24-May-16 07:52 nsanic/libs/component.py
 -rw-rw-rw-  2.0 fat     3151 b- defN 24-Apr-28 08:45 nsanic/libs/consts.py
 -rw-rw-rw-  2.0 fat     1578 b- defN 24-Mar-21 14:40 nsanic/libs/crypto.py
--rw-rw-rw-  2.0 fat     3171 b- defN 24-May-16 07:52 nsanic/libs/decorator.py
+-rw-rw-rw-  2.0 fat     3153 b- defN 24-May-31 11:07 nsanic/libs/decorator.py
 -rw-rw-rw-  2.0 fat     1125 b- defN 24-Mar-21 14:40 nsanic/libs/file_type.py
 -rw-rw-rw-  2.0 fat     2774 b- defN 24-May-24 10:02 nsanic/libs/manager.py
 -rw-rw-rw-  2.0 fat     2495 b- defN 24-Mar-21 14:40 nsanic/libs/mult_log.py
 -rw-rw-rw-  2.0 fat     5417 b- defN 24-May-24 03:41 nsanic/libs/random_maker.py
--rw-rw-rw-  2.0 fat     8937 b- defN 24-May-24 03:41 nsanic/libs/rds_client.py
+-rw-rw-rw-  2.0 fat     9292 b- defN 24-Jun-01 03:20 nsanic/libs/rds_client.py
 -rw-rw-rw-  2.0 fat     1116 b- defN 24-May-16 07:52 nsanic/libs/rds_locker.py
 -rw-rw-rw-  2.0 fat     6985 b- defN 24-Apr-28 09:19 nsanic/libs/tool.py
 -rw-rw-rw-  2.0 fat     5014 b- defN 24-May-16 07:52 nsanic/libs/tool_dt.py
 -rw-rw-rw-  2.0 fat     3070 b- defN 24-May-16 07:52 nsanic/libs/tool_jwt.py
 -rw-rw-rw-  2.0 fat     1956 b- defN 24-May-16 07:52 nsanic/libs/tool_ws.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-20 12:48 nsanic/orm/__init__.py
 -rw-rw-rw-  2.0 fat      730 b- defN 24-Mar-19 13:56 nsanic/orm/db_index.py
 -rw-rw-rw-  2.0 fat    18726 b- defN 24-May-16 07:52 nsanic/orm/db_model.py
 -rw-rw-rw-  2.0 fat    11698 b- defN 24-Apr-03 07:45 nsanic/orm/mssql_generator.py
 -rw-rw-rw-  2.0 fat    11743 b- defN 24-Apr-28 08:44 nsanic/orm/mysql_generator.py
 -rw-rw-rw-  2.0 fat    11720 b- defN 24-Apr-03 07:45 nsanic/orm/pgsql_generator.py
--rw-rw-rw-  2.0 fat     5037 b- defN 24-May-16 07:52 nsanic/orm/rc_model.py
+-rw-rw-rw-  2.0 fat     4993 b- defN 24-May-31 11:07 nsanic/orm/rc_model.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 test/__init__.py
 -rw-rw-rw-  2.0 fat      701 b- defN 24-May-16 07:52 test/test_unit.py
--rw-rw-rw-  2.0 fat     1090 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/LICENSE
--rw-rw-rw-  2.0 fat     4803 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/WHEEL
--rw-rw-rw-  2.0 fat       52 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/entry_points.txt
--rw-rw-rw-  2.0 fat       12 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/top_level.txt
--rw-rw-r--  2.0 fat     3332 b- defN 24-May-30 03:30 nsanic-2024.5.30.dist-info/RECORD
-42 files, 183160 bytes uncompressed, 54160 bytes compressed:  70.4%
+-rw-rw-rw-  2.0 fat     1090 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat     4802 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat       52 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/entry_points.txt
+-rw-rw-rw-  2.0 fat       12 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/top_level.txt
+-rw-rw-r--  2.0 fat     3326 b- defN 24-Jun-01 03:21 nsanic-2024.6.1.dist-info/RECORD
+42 files, 183446 bytes uncompressed, 54286 bytes compressed:  70.4%
```

## zipnote {}

```diff
@@ -102,26 +102,26 @@
 
 Filename: test/__init__.py
 Comment: 
 
 Filename: test/test_unit.py
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/LICENSE
+Filename: nsanic-2024.6.1.dist-info/LICENSE
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/METADATA
+Filename: nsanic-2024.6.1.dist-info/METADATA
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/WHEEL
+Filename: nsanic-2024.6.1.dist-info/WHEEL
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/entry_points.txt
+Filename: nsanic-2024.6.1.dist-info/entry_points.txt
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/top_level.txt
+Filename: nsanic-2024.6.1.dist-info/top_level.txt
 Comment: 
 
-Filename: nsanic-2024.5.30.dist-info/RECORD
+Filename: nsanic-2024.6.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nsanic/libs/decorator.py

```diff
@@ -37,49 +37,44 @@
     ins_map = {}
 
     def ins(*args, **kwargs):
         if cls not in ins_map:
             with Lock():
                 ins_map[cls] = cls(*args, **kwargs)
         return ins_map[cls]
-
     return ins
 
 
 def aio_catcher(log: MultLogger = None):
     """协程异常捕获器"""
 
     def expt(fun):
         @wraps(fun)
         async def wrap_fun(*args, **kwargs):
             try:
                 return await fun(*args, **kwargs)
             except Exception as err:
                 err_str = f"执行出错：{err}\n{ traceback.format_exc()}"
                 log.error(err_str) if log else print(err_str)
-
         return wrap_fun
-
     return expt
 
 
 def catcher(log: MultLogger = None):
     """常规异常捕获器"""
 
     def expt(fun):
         @wraps(fun)
         def wrap_fun(*args, **kwargs):
             try:
                 return fun(*args, **kwargs)
             except Exception as err:
                 err_str = f"执行出错：{err}\n{traceback.format_exc()}"
                 log.error(err_str) if log else print(err_str)
-
         return wrap_fun
-
     return expt
 
 
 def aio_runtime(log: MultLogger = None):
     """协程 时间检查"""
 
     def out_runtime(fun):
@@ -87,17 +82,15 @@
         async def wrap_fun(*args, **kwargs):
             s_time = time.time()
             req = await fun(*args, **kwargs)
             e_time = time.time()
             info_str = f'程序执行时间: {(e_time - s_time) * 1000}毫秒'
             log.info(info_str) if log else print(info_str)
             return req
-
         return wrap_fun
-
     return out_runtime
 
 
 def runtime(log: MultLogger = None):
     """常规时间检查"""
 
     def out_runtime(fun):
@@ -105,11 +98,9 @@
         def wrap_fun(*args, **kwargs):
             s_time = time.time()
             req = fun(*args, **kwargs)
             e_time = time.time()
             info_str = f'程序执行时间: {(e_time - s_time) * 1000}毫秒'
             log.info(info_str) if log else print(info_str)
             return req
-
         return wrap_fun
-
     return out_runtime
```

## nsanic/libs/rds_client.py

```diff
@@ -63,17 +63,26 @@
             raise RdsError()
         return Redis(connection_pool=self.__pool)
 
     @property
     def conn(self):
         return self.__conn
     
-    async def locked(self, key: str, fun=None, fun_param: (list, tuple) = None, time_out=5):
+    async def locked(self, key: str, fun=None, fun_param: (list, tuple) = None, time_out=5, pre_key='LOCKER__'):
+        """
+        :param key: 锁定标识
+        :param fun: 执行函数
+        :param fun_param: 函数参数
+        :param time_out: 自动释放时间
+        :param pre_key: 锁定标识预制前缀，用于区分锁定标识采用redis key本身
+        """
         if not fun_param:
             fun_param = ()
+        if pre_key:
+            key = f'{pre_key}{key}'
         async with self.__conn.lock(key, lock_class=RdsLocker, timeout=time_out):
             return callable(fun) and ((await fun(*fun_param)) if asyncio.iscoroutinefunction(fun) else fun(*fun_param))
 
     async def get_item(self, key: Union[str, bytes], is_json=False):
         """
         获取缓存
         :param key: 缓存名称
```

## nsanic/orm/rc_model.py

```diff
@@ -40,49 +40,50 @@
                 return db_info
             return
         if not cls.db_model:
             return
         tb_name = cls.db_model.sheet_name(split)
         if isinstance(pk_val, bytes):
             pk_val = pk_val.decode('utf-8')
+        key = f"{tb_name}:{pk_val}"
         if cls.expired_mode:
-            key = f"{tb_name}:{pk_val}"
             info = await cls.conf.rds.get_item(key)
         else:
             info = await cls.conf.rds.get_hash(tb_name, pk_val)
         if info:
             return json_parse(info, cls.log_err)
-        p_info = await cls.conf.rds.locked(f'{tb_name}_{pk_val}', from_db)
+        p_info = await cls.conf.rds.locked(key, from_db)
         return p_info
 
     @classmethod
     async def cache_by_unique(cls, unique: dict, suffix: str, split: Union[str, int, float, datetime, date] = None):
         async def from_db():
             info = await cls.db_model.get_by_dict(unique, limit=1, split=split)
             if info:
                 pk_val = info.get(cls.db_model.pk_name())
                 if cls.expired_mode:
-                    await cls.conf.rds.set_item(f'{key_name}:{unique_val}', pk_val, ex_time=cls.expired_sec)
+                    await cls.conf.rds.set_item(key, pk_val, ex_time=cls.expired_sec)
                 else:
                     await cls.conf.rds.set_hash(key_name, unique_val, pk_val)
                 await cls.fun_set_cache(info)
                 return info
             return
 
         if not cls.db_model:
             return
         key_name = f'{cls.db_model.sheet_name(split)}_{suffix}'
         unique_val = '_'.join([str(unique.get(k)) for k in sorted(unique)])
+        key = f'{key_name}:{unique_val}'
         if cls.expired_mode:
-            item_id = await cls.conf.rds.get_item(f'{key_name}:{unique_val}')
+            item_id = await cls.conf.rds.get_item(key)
         else:
             item_id = await cls.conf.rds.get_hash(key_name, unique_val)
         if item_id:
             return await cls.cache_by_pk(item_id, split=split)
-        return await cls.conf.rds.locked(key_name + unique_val, fun=from_db)
+        return await cls.conf.rds.locked(key, fun=from_db)
 
     # @classmethod
     # async def query_map(cls, is_super=False, field_name='name', groups: (list, tuple) = None, group_key='gid'):
     #     """"""
     #     async def from_db():
     #         data_list = await cls.db_model.get_by_dict()
     #         return [await cls.fun_set_cache(info) for n in data_list]
```

## Comparing `nsanic-2024.5.30.dist-info/LICENSE` & `nsanic-2024.6.1.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `nsanic-2024.5.30.dist-info/METADATA` & `nsanic-2024.6.1.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nsanic
-Version: 2024.5.30
+Version: 2024.6.1
 Summary: A web framework who is use sanic + tortoise-orm + redis to quick create http&websocket server.
 Author: DHDONG
 Author-email: zscych@qq.com
 License: MIT
 Keywords: WebServer,Sanic,WebSite Develop,Web Framework
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
```

## Comparing `nsanic-2024.5.30.dist-info/RECORD` & `nsanic-2024.6.1.dist-info/RECORD`

 * *Files 11% similar despite different names*

```diff
@@ -10,33 +10,33 @@
 nsanic/mult_creator.py,sha256=roZLTg_CaRmTVqVuep5AS-eCZU00-ytB6e3BGwqd7ik,10352
 nsanic/verify.py,sha256=rsrZQ8O0KjyheQ9MWfQMExm6XDp2aDjlhNalka4zLh4,8531
 nsanic/libs/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nsanic/libs/base_timed.py,sha256=Qrs0OpRhHROW3-g2gFwMiw0oi8SnGgaY9TrGXLJS_E4,7656
 nsanic/libs/component.py,sha256=gxLOAyL1F4zGqJEYeskzV3E3FgeEIZnN3gzD4EgNGZQ,1276
 nsanic/libs/consts.py,sha256=OHIOgaLY8R8jZRiwDeEDg_3NN7kj-gZ_7HnP6Ccoq4c,3151
 nsanic/libs/crypto.py,sha256=rCuzGGGYSZimdd8OhQCfIdZBUbBnX0FdPNO3sivy1L4,1578
-nsanic/libs/decorator.py,sha256=l5uNOJUM6AXPAfSNer7uy-2ivXJc-yUytbwBxQ-jCSs,3171
+nsanic/libs/decorator.py,sha256=AECJKqVQn0MRc6idawP1HEePn3BBFDU_iIkAJ-Sc1_Q,3153
 nsanic/libs/file_type.py,sha256=4OBdtXoNedXYpucs_99VdPfQw_Of6d8XFsRtTbGi8k0,1125
 nsanic/libs/manager.py,sha256=EwG-nkKEBQE_w5apEVn5uTyjH190HLnOr1TJWv9n1S0,2774
 nsanic/libs/mult_log.py,sha256=wN-Wu2Q8byarCyu34mBmeBJUPIvmYZy6BVauifRoZDQ,2495
 nsanic/libs/random_maker.py,sha256=PQwQRYPihT3I2BHt-Dold4RbjBnloryBl1t-8OiV0E8,5417
-nsanic/libs/rds_client.py,sha256=0EkZ71riJYIq-Y0X8-OBbW-GvuWJnr6tkMMeJDhrvxY,8937
+nsanic/libs/rds_client.py,sha256=82TVDajCcze18YoJ1bWOCaWiwAby0nHZKVcgU2mlrBA,9292
 nsanic/libs/rds_locker.py,sha256=HcHcXPzgp_giogbFPLGI0ZxILNBtI5vDCdkXZ3JTVcI,1116
 nsanic/libs/tool.py,sha256=7Bp0KkNMiuLnSATXccaBdW5Qz3FWaPykVNemfGu-Xb0,6985
 nsanic/libs/tool_dt.py,sha256=UmNFRKwN87H4i5Tpap2lAUTZx4oQ1mIK-1X-nWtU5Ok,5014
 nsanic/libs/tool_jwt.py,sha256=8QJQ1GtAntFHV0x-CdKxKO7BwoAGpGZX0WvUZOzD-ZA,3070
 nsanic/libs/tool_ws.py,sha256=oNze5tYDGHJvS81qEEpMcOdLUIVFihR06ltUyi8r4NA,1956
 nsanic/orm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nsanic/orm/db_index.py,sha256=LmqneAZnHPfWsWNS4wH6F8iyZ56xtXtczglRFOZtgHA,730
 nsanic/orm/db_model.py,sha256=Mo9UcXZM2u2i7PvT-crmqln7VCSyrll3wmvntGFcBnM,18726
 nsanic/orm/mssql_generator.py,sha256=c9q71hljWqBxoNriG0OefwD48w3gVTb62HnFKjreom4,11698
 nsanic/orm/mysql_generator.py,sha256=6AMVa9twa7GRCuTlEga5g2zHJvkCD9YocUwGGcvLQ4Q,11743
 nsanic/orm/pgsql_generator.py,sha256=BMNDAZ-2X9dPbUOBlhR5UJBfqXWpl23KRgTozleKCCQ,11720
-nsanic/orm/rc_model.py,sha256=Rk687YpLZp6XR42UzspTrOVlotlEAlp53RDRfYnlDG8,5037
+nsanic/orm/rc_model.py,sha256=KZbl_vDCcNuMQP7z-6lmzh2_iaGOn6-SwJRMO5D8Bfk,4993
 test/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 test/test_unit.py,sha256=ru4EliRtBozPFs9UjVTybZ0cMUFtOgjS8FSdNnQFtO4,701
-nsanic-2024.5.30.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
-nsanic-2024.5.30.dist-info/METADATA,sha256=54Vi-Z1LZpkIjIqly-pu1xignmnptUurwP26bwNGsWU,4803
-nsanic-2024.5.30.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-nsanic-2024.5.30.dist-info/entry_points.txt,sha256=NJGRx7PJixNk9kbISqsD8AGtQHq1NppCxvEsfEPx43Q,52
-nsanic-2024.5.30.dist-info/top_level.txt,sha256=Y7ottGiwpMZQKgvVy-Jy3SBJdxMFJSJ8ivpRD-c23xI,12
-nsanic-2024.5.30.dist-info/RECORD,,
+nsanic-2024.6.1.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
+nsanic-2024.6.1.dist-info/METADATA,sha256=guEXM5Jd2cDe1LoQWBvWzt0sdzIEiRFqk2RVa9kDtu0,4802
+nsanic-2024.6.1.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+nsanic-2024.6.1.dist-info/entry_points.txt,sha256=NJGRx7PJixNk9kbISqsD8AGtQHq1NppCxvEsfEPx43Q,52
+nsanic-2024.6.1.dist-info/top_level.txt,sha256=Y7ottGiwpMZQKgvVy-Jy3SBJdxMFJSJ8ivpRD-c23xI,12
+nsanic-2024.6.1.dist-info/RECORD,,
```

